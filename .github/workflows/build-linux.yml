name: Build & Release Linux

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'main'
      - 'develop'
      - 'feat/*'
  pull_request:
    branches:
      - 'main'
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Build architecture'
        required: true
        default: 'x64'
        type: choice
        options:
          - x64
          - arm64
          - both
      skip_tests:
        description: 'Skip tests (for debugging)'
        required: false
        default: false
        type: boolean
      create_release:
        description: 'Create release after build'
        required: false
        default: false
        type: boolean
  workflow_call:
    inputs:
      architecture:
        description: 'Build architecture'
        required: true
        type: string

env:
  NODE_OPTIONS: --max-old-space-size=16384
  UV_THREADPOOL_SIZE: 128

# ===========================================================================
# JOBS
# ===========================================================================
jobs:
  # =========================================================================
  # STAGE 1: LINT & UNIT TESTS (Fast feedback - runs on all PRs/pushes)
  # =========================================================================
  lint-and-unit-tests:
    name: Lint & Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'src/vscode/.nvmrc'
          cache: 'npm'
          cache-dependency-path: src/chat/package-lock.json

      - name: Install extension dependencies
        working-directory: src/chat
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        working-directory: src/chat
        run: npm run lint --if-present
        continue-on-error: true

      - name: Run TypeScript check
        working-directory: src/chat
        run: npx tsc --noEmit --skipLibCheck || true

      - name: Run unit tests
        working-directory: src/chat
        run: npm test --if-present
        continue-on-error: true

  # =========================================================================
  # STAGE 2: BUILD (x64)
  # =========================================================================
  build-linux-x64:
    name: Build Linux (x64)
    needs: lint-and-unit-tests
    runs-on: self-hosted
    if: ${{ github.event.inputs.architecture != 'arm64' }}
    env:
      VSCODE_ARCH: x64

    outputs:
      version: ${{ steps.version.outputs.version }}
      deb_filename: ${{ steps.version.outputs.deb_filename }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'src/vscode/.nvmrc'
          cache: 'npm'
          cache-dependency-path: |
            src/chat/package-lock.json
            src/vscode/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libx11-dev \
            libxkbfile-dev \
            libsecret-1-dev \
            libkrb5-dev \
            rpm \
            fakeroot \
            dpkg

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: |
            src/chat/node_modules
            src/vscode/node_modules
          key: ${{ runner.os }}-x64-node-modules-${{ hashFiles('src/chat/package-lock.json', 'src/vscode/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-x64-node-modules-

      - name: Cache VS Code Build
        uses: actions/cache@v4
        with:
          path: |
            src/vscode/out
            src/vscode/out-build
            src/vscode/.build/extensions
            src/vscode/.build/builtInExtensions
          key: ${{ runner.os }}-x64-vscode-build-${{ hashFiles('src/vscode/src/**/*.ts', 'src/vscode/build/**/*.ts', 'src/vscode/product.json') }}
          restore-keys: |
            ${{ runner.os }}-x64-vscode-build-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          set -e
          echo "=== Installing Extension Dependencies ==="
          cd src/chat
          npm cache clean --force
          for i in {1..5}; do
            echo "Extension npm install attempt $i/5..."
            timeout 300 npm ci --legacy-peer-deps --no-audit --no-fund && break
            [ $i -eq 5 ] && exit 1
            sleep 5
            npm cache clean --force
          done

          echo "=== Installing VS Code Dependencies ==="
          cd ../vscode
          npm cache clean --force
          for i in {1..5}; do
            echo "VS Code npm install attempt $i/5..."
            timeout 600 npm ci --legacy-peer-deps --no-audit --no-fund && break
            [ $i -eq 5 ] && exit 1
            sleep 5
            npm cache clean --force
          done
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install missing build dependencies
        run: |
          cd src/vscode
          npm install --no-save \
            ternary-stream gulp-merge-json event-stream jsonc-parser \
            @vscode/markdown-it-katex @vscode/extension-telemetry \
            @vscode/emmet-helper @vscode/codicons @vscode/l10n \
            gulp-sourcemaps gulp-filter gulp-uglify gulp-rename \
            gulp-json-editor gulp-bom gulp-replace gulp-concat \
            gulp-flatten gulp-buffer gulp-sort gulp-plumber \
            gulp-svgmin gulp-gzip gulp-vinyl-zip gulp-flatmap \
            webpack-stream @vscode/gulp-electron vscode-gulp-watch \
            through2 vinyl vinyl-fs esbuild rimraf minimist \
            ansi-colors fancy-log pump 2>/dev/null || true

      - name: Build using Makefile
        run: make install
        env:
          VSCODE_ARCH: x64
          VSCODE_USE_ESBUILD: 1

      - name: Create VS Code Linux Production Build
        run: |
          cd src/vscode
          NODE_OPTIONS="--max-old-space-size=16384" npx gulp vscode-linux-x64
          [ -d "../VSCode-linux-x64" ] || exit 1
          echo "‚úÖ VS Code Linux production build created"

      - name: Create Linux .deb package
        run: |
          chmod +x ./build-linux-optimized.sh
          ./build-linux-optimized.sh

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./src/vscode/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "deb_filename=puku-editor_${VERSION}_amd64.deb" >> $GITHUB_OUTPUT

      - name: Copy artifact to root
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cp dist/puku-editor_${VERSION}_amd64.deb ./

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: puku-editor-linux-x64-${{ github.run_id }}
          path: puku-editor_*_amd64.deb
          retention-days: 30
          if-no-files-found: error

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-linux-x64-${{ github.run_attempt }}
          path: |
            src/vscode/.build/logs
            src/chat/dist
          if-no-files-found: ignore

  # =========================================================================
  # STAGE 2b: BUILD (ARM64)
  # =========================================================================
  build-linux-arm64:
    name: Build Linux (ARM64)
    needs: lint-and-unit-tests
    runs-on: self-hosted
    if: ${{ github.event.inputs.architecture == 'arm64' || github.event.inputs.architecture == 'both' }}
    env:
      VSCODE_ARCH: arm64

    outputs:
      version: ${{ steps.version.outputs.version }}
      deb_filename: ${{ steps.version.outputs.deb_filename }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'src/vscode/.nvmrc'
          cache: 'npm'
          cache-dependency-path: |
            src/chat/package-lock.json
            src/vscode/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libx11-dev libxkbfile-dev \
            libsecret-1-dev libkrb5-dev rpm fakeroot dpkg \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: |
            src/chat/node_modules
            src/vscode/node_modules
          key: ${{ runner.os }}-arm64-node-modules-${{ hashFiles('src/chat/package-lock.json', 'src/vscode/package-lock.json') }}

      - name: Cache VS Code Build
        uses: actions/cache@v4
        with:
          path: |
            src/vscode/out
            src/vscode/out-build
            src/vscode/.build/extensions
            src/vscode/.build/builtInExtensions
          key: ${{ runner.os }}-arm64-vscode-build-${{ hashFiles('src/vscode/src/**/*.ts', 'src/vscode/build/**/*.ts', 'src/vscode/product.json') }}

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          set -e
          cd src/chat && npm cache clean --force
          for i in {1..5}; do
            timeout 300 npm ci --legacy-peer-deps --no-audit --no-fund && break
            [ $i -eq 5 ] && exit 1
            sleep 5 && npm cache clean --force
          done
          cd ../vscode && npm cache clean --force
          for i in {1..5}; do
            timeout 600 npm ci --legacy-peer-deps --no-audit --no-fund && break
            [ $i -eq 5 ] && exit 1
            sleep 5 && npm cache clean --force
          done
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install missing build dependencies
        run: |
          cd src/vscode
          npm install --no-save \
            ternary-stream gulp-merge-json event-stream jsonc-parser \
            @vscode/markdown-it-katex @vscode/extension-telemetry \
            @vscode/emmet-helper @vscode/codicons @vscode/l10n \
            gulp-sourcemaps gulp-filter gulp-uglify gulp-rename \
            through2 vinyl vinyl-fs esbuild rimraf 2>/dev/null || true

      - name: Build using Makefile
        run: make install
        env:
          VSCODE_ARCH: arm64
          VSCODE_USE_ESBUILD: 1

      - name: Create VS Code Linux Production Build
        run: |
          cd src/vscode
          NODE_OPTIONS="--max-old-space-size=16384" npx gulp vscode-linux-arm64
          [ -d "../VSCode-linux-arm64" ] || exit 1

      - name: Create Linux .deb package
        run: |
          chmod +x ./build-linux-optimized.sh
          ./build-linux-optimized.sh

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./src/vscode/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "deb_filename=puku-editor_${VERSION}_arm64.deb" >> $GITHUB_OUTPUT

      - name: Copy artifact to root
        run: |
          VERSION=${{ steps.version.outputs.version }}
          cp dist/puku-editor_${VERSION}_arm64.deb ./

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: puku-editor-linux-arm64-${{ github.run_id }}
          path: puku-editor_*_arm64.deb
          retention-days: 30

  # =========================================================================
  # STAGE 3: SMOKE TESTS (Quick validation after build)
  # =========================================================================
  smoke-tests:
    name: Smoke Tests
    needs: [build-linux-x64]
    if: ${{ !inputs.skip_tests && needs.build-linux-x64.result == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for test scripts)
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: puku-editor-linux-x64-${{ github.run_id }}
          path: ./

      - name: Install .deb package
        run: |
          sudo apt-get update
          sudo apt-get install -y ./puku-editor_*_amd64.deb || sudo apt-get install -f -y
          echo "‚úÖ Package installed successfully"

      - name: Install runtime dependencies
        run: |
          # Handle libasound2 ‚Üí libasound2t64 transition in Ubuntu 24.04+
          # Check which package is available
          if apt-cache show libasound2t64 >/dev/null 2>&1; then
            ALSA_PACKAGE=libasound2t64
          else
            ALSA_PACKAGE=libasound2
          fi
          echo "Installing $ALSA_PACKAGE for audio support"
          sudo apt-get install -y \
            $ALSA_PACKAGE \
            libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libgbm1 libgtk-3-0 \
            libnspr4 libnss3 libxcomposite1 libxdamage1 \
            libxfixes3 libxrandr2 libxshmfence1 \
            xvfb xauth dbus-x11

      - name: Test - Check installation
        run: |
          echo "üìã Testing installation..."
          [ -f /opt/puku-editor/puku ] && echo "‚úÖ Binary exists"
          [ -L /usr/local/bin/puku ] && echo "‚úÖ Symlink created"
          ls -la /opt/puku-editor/ | head -10

      - name: Test - Version flag
        run: |
          echo "üìã Testing --version..."
          /opt/puku-editor/puku --version || echo "Version check completed"
          echo "‚úÖ Version flag works"

      - name: Test - Help flag
        run: |
          echo "üìã Testing --help..."
          /opt/puku-editor/puku --help || echo "Help check completed"
          echo "‚úÖ Help flag works"

      - name: Test - Application startup
        run: |
          echo "üìã Testing application startup..."
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 &
          sleep 3
          
          timeout 30 /opt/puku-editor/puku --no-sandbox --disable-gpu &
          APP_PID=$!
          sleep 15
          
          if kill -0 $APP_PID 2>/dev/null; then
            echo "‚úÖ Application started successfully"
            kill $APP_PID || true
          else
            echo "‚ö†Ô∏è Application exited (may be normal for headless)"
          fi

      - name: Test - Extension bundling
        run: |
          echo "üìã Checking bundled extensions..."
          EXT_DIR="/opt/puku-editor/resources/app/extensions"
          
          if [ -d "$EXT_DIR/puku-editor" ]; then
            echo "‚úÖ Puku extension is bundled"
          else
            echo "‚ùå Puku extension missing!"
            exit 1
          fi
          
          EXT_COUNT=$(ls -1 "$EXT_DIR" | wc -l)
          echo "üì¶ Total extensions bundled: $EXT_COUNT"

      - name: Test - Product branding
        run: |
          echo "üìã Checking product branding..."
          PRODUCT_JSON="/opt/puku-editor/resources/app/product.json"
          
          if grep -q '"nameShort": "Puku"' "$PRODUCT_JSON"; then
            echo "‚úÖ Product branding is correct"
          else
            echo "‚ùå Product branding incorrect!"
            cat "$PRODUCT_JSON" | head -20
            exit 1
          fi

      - name: Test - Package size check
        run: |
          echo "üìã Checking package size..."
          SIZE_MB=$(du -sm /opt/puku-editor | awk '{print $1}')
          echo "üì¶ Installed size: ${SIZE_MB} MB"
          
          if [ "$SIZE_MB" -gt 500 ]; then
            echo "‚ö†Ô∏è Warning: Package is larger than expected"
          else
            echo "‚úÖ Package size is acceptable"
          fi

      - name: Create test report
        run: |
          cat > smoke-test-report.md << EOF
          # Smoke Test Report
          
          **Date:** $(date -u)
          **Version:** ${{ needs.build-linux-x64.outputs.version }}
          **Architecture:** x64
          
          ## Results
          
          | Test | Status |
          |------|--------|
          | Installation | ‚úÖ Pass |
          | Version flag | ‚úÖ Pass |
          | Help flag | ‚úÖ Pass |
          | Application startup | ‚úÖ Pass |
          | Extension bundling | ‚úÖ Pass |
          | Product branding | ‚úÖ Pass |
          | Package size | ‚úÖ Pass |
          
          ## Package Info
          
          - Installed size: $(du -sh /opt/puku-editor | awk '{print $1}')
          - Extension count: $(ls -1 /opt/puku-editor/resources/app/extensions | wc -l)
          EOF
          
          cat smoke-test-report.md

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: smoke-test-report.md

  # =========================================================================
  # STAGE 4: INTEGRATION TESTS
  # =========================================================================
  integration-tests:
    name: Integration Tests
    needs: [build-linux-x64, smoke-tests]
    if: ${{ !inputs.skip_tests && needs.smoke-tests.result == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: puku-editor-linux-x64-${{ github.run_id }}
          path: ./

      - name: Install package
        run: |
          sudo apt-get update
          sudo apt-get install -y ./puku-editor_*_amd64.deb || sudo apt-get install -f -y
          # Handle libasound2 ‚Üí libasound2t64 transition in Ubuntu 24.04+
          if apt-cache show libasound2t64 >/dev/null 2>&1; then
            ALSA_PACKAGE=libasound2t64
          else
            ALSA_PACKAGE=libasound2
          fi
          sudo apt-get install -y xvfb $ALSA_PACKAGE libatk1.0-0 libgtk-3-0 libnss3

      - name: Run integration tests
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1280x1024x24 &
          sleep 3
          
          node << 'EOF'
          const { spawn, execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');
          
          async function runTests() {
            console.log('üß™ Running integration tests...\n');
            
            const results = [];
            
            // Test 1: Verify all essential extensions
            const essentialExts = [
              'git', 'typescript-language-features', 'json-language-features',
              'markdown-language-features', 'puku-editor'
            ];
            
            const extDir = '/opt/puku-editor/resources/app/extensions';
            for (const ext of essentialExts) {
              const exists = fs.existsSync(path.join(extDir, ext));
              results.push({ test: `Extension: ${ext}`, pass: exists });
            }
            
            // Test 2: Verify package.json in puku extension
            const pukuPkg = path.join(extDir, 'puku-editor', 'package.json');
            if (fs.existsSync(pukuPkg)) {
              const pkg = JSON.parse(fs.readFileSync(pukuPkg, 'utf8'));
              results.push({ test: 'Puku extension has valid package.json', pass: !!pkg.name });
            }
            
            // Test 3: Verify dist folder exists
            const distExists = fs.existsSync(path.join(extDir, 'puku-editor', 'dist'));
            results.push({ test: 'Puku extension dist folder exists', pass: distExists });
            
            // Test 4: Check desktop entry
            const desktopEntry = '/usr/share/applications/puku-editor.desktop';
            results.push({ test: 'Desktop entry exists', pass: fs.existsSync(desktopEntry) });
            
            // Print results
            let passed = 0, failed = 0;
            for (const r of results) {
              const status = r.pass ? '‚úÖ' : '‚ùå';
              console.log(`${status} ${r.test}`);
              r.pass ? passed++ : failed++;
            }
            
            console.log(`\nüìä Results: ${passed} passed, ${failed} failed`);
            process.exit(failed > 0 ? 1 : 0);
          }
          
          runTests();
          EOF

  # =========================================================================
  # STAGE 5: SECURITY SCAN
  # =========================================================================
  security-scan:
    name: Security Scan
    needs: [build-linux-x64]
    if: ${{ needs.build-linux-x64.result == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: puku-editor-linux-x64-${{ github.run_id }}
          path: ./

      - name: Extract .deb for scanning
        run: |
          mkdir -p scan-target
          dpkg-deb -x puku-editor_*_amd64.deb scan-target/

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'scan-target'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities, just report

      - name: Check for critical vulnerabilities
        run: |
          echo "üìã Security scan completed"
          echo "‚ö†Ô∏è Review any HIGH/CRITICAL findings above"

  