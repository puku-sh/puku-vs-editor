{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/base/parts/ipc/test/node/ipc.net.test.ts","vs/base/parts/ipc/test/node/ipc.net.test.ts"],"names":[],"mappings":"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","file":"ipc.net.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport sinon from 'sinon';\nimport { EventEmitter } from 'events';\nimport { AddressInfo, connect, createServer, Server, Socket } from 'net';\nimport { tmpdir } from 'os';\nimport { Barrier, timeout } from '../../../../common/async.js';\nimport { VSBuffer } from '../../../../common/buffer.js';\nimport { Emitter, Event } from '../../../../common/event.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../../common/lifecycle.js';\nimport { ILoadEstimator, PersistentProtocol, Protocol, ProtocolConstants, SocketCloseEvent, SocketDiagnosticsEventType } from '../../common/ipc.net.js';\nimport { createRandomIPCHandle, createStaticIPCHandle, NodeSocket, WebSocketNodeSocket } from '../../node/ipc.net.js';\nimport { flakySuite } from '../../../../test/common/testUtils.js';\nimport { runWithFakedTimers } from '../../../../test/common/timeTravelScheduler.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../test/common/utils.js';\n\nclass MessageStream extends Disposable {\n\n\tprivate _currentComplete: ((data: VSBuffer) => void) | null;\n\tprivate _messages: VSBuffer[];\n\n\tconstructor(x: Protocol | PersistentProtocol) {\n\t\tsuper();\n\t\tthis._currentComplete = null;\n\t\tthis._messages = [];\n\t\tthis._register(x.onMessage(data => {\n\t\t\tthis._messages.push(data);\n\t\t\tthis._trigger();\n\t\t}));\n\t}\n\n\tprivate _trigger(): void {\n\t\tif (!this._currentComplete) {\n\t\t\treturn;\n\t\t}\n\t\tif (this._messages.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tconst complete = this._currentComplete;\n\t\tconst msg = this._messages.shift()!;\n\n\t\tthis._currentComplete = null;\n\t\tcomplete(msg);\n\t}\n\n\tpublic waitForOne(): Promise<VSBuffer> {\n\t\treturn new Promise<VSBuffer>((complete) => {\n\t\t\tthis._currentComplete = complete;\n\t\t\tthis._trigger();\n\t\t});\n\t}\n}\n\nclass EtherStream extends EventEmitter {\n\tconstructor(\n\t\tprivate readonly _ether: Ether,\n\t\tprivate readonly _name: 'a' | 'b'\n\t) {\n\t\tsuper();\n\t}\n\n\twrite(data: Buffer, cb?: Function): boolean {\n\t\tif (!Buffer.isBuffer(data)) {\n\t\t\tthrow new Error(`Invalid data`);\n\t\t}\n\t\tthis._ether.write(this._name, data);\n\t\treturn true;\n\t}\n\n\tdestroy(): void {\n\t}\n}\n\nclass Ether {\n\n\tprivate readonly _a: EtherStream;\n\tprivate readonly _b: EtherStream;\n\n\tprivate _ab: Buffer[];\n\tprivate _ba: Buffer[];\n\n\tpublic get a(): Socket {\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\treturn <any>this._a;\n\t}\n\n\tpublic get b(): Socket {\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\treturn <any>this._b;\n\t}\n\n\tconstructor(\n\t\tprivate readonly _wireLatency = 0\n\t) {\n\t\tthis._a = new EtherStream(this, 'a');\n\t\tthis._b = new EtherStream(this, 'b');\n\t\tthis._ab = [];\n\t\tthis._ba = [];\n\t}\n\n\tpublic write(from: 'a' | 'b', data: Buffer): void {\n\t\tsetTimeout(() => {\n\t\t\tif (from === 'a') {\n\t\t\t\tthis._ab.push(data);\n\t\t\t} else {\n\t\t\t\tthis._ba.push(data);\n\t\t\t}\n\n\t\t\tsetTimeout(() => this._deliver(), 0);\n\t\t}, this._wireLatency);\n\t}\n\n\tprivate _deliver(): void {\n\n\t\tif (this._ab.length > 0) {\n\t\t\tconst data = Buffer.concat(this._ab);\n\t\t\tthis._ab.length = 0;\n\t\t\tthis._b.emit('data', data);\n\t\t\tsetTimeout(() => this._deliver(), 0);\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._ba.length > 0) {\n\t\t\tconst data = Buffer.concat(this._ba);\n\t\t\tthis._ba.length = 0;\n\t\t\tthis._a.emit('data', data);\n\t\t\tsetTimeout(() => this._deliver(), 0);\n\t\t\treturn;\n\t\t}\n\n\t}\n}\n\nsuite('IPC, Socket Protocol', () => {\n\n\tconst ds = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet ether: Ether;\n\n\tsetup(() => {\n\t\tether = new Ether();\n\t});\n\n\ttest('read/write', async () => {\n\n\t\tconst a = new Protocol(new NodeSocket(ether.a));\n\t\tconst b = new Protocol(new NodeSocket(ether.b));\n\t\tconst bMessages = new MessageStream(b);\n\n\t\ta.send(VSBuffer.fromString('foobarfarboo'));\n\t\tconst msg1 = await bMessages.waitForOne();\n\t\tassert.strictEqual(msg1.toString(), 'foobarfarboo');\n\n\t\tconst buffer = VSBuffer.alloc(1);\n\t\tbuffer.writeUInt8(123, 0);\n\t\ta.send(buffer);\n\t\tconst msg2 = await bMessages.waitForOne();\n\t\tassert.strictEqual(msg2.readUInt8(0), 123);\n\n\t\tbMessages.dispose();\n\t\ta.dispose();\n\t\tb.dispose();\n\t});\n\n\n\ttest('read/write, object data', async () => {\n\n\t\tconst a = new Protocol(new NodeSocket(ether.a));\n\t\tconst b = new Protocol(new NodeSocket(ether.b));\n\t\tconst bMessages = new MessageStream(b);\n\n\t\tconst data = {\n\t\t\tpi: Math.PI,\n\t\t\tfoo: 'bar',\n\t\t\tmore: true,\n\t\t\tdata: 'Hello World'.split('')\n\t\t};\n\n\t\ta.send(VSBuffer.fromString(JSON.stringify(data)));\n\t\tconst msg = await bMessages.waitForOne();\n\t\tassert.deepStrictEqual(JSON.parse(msg.toString()), data);\n\n\t\tbMessages.dispose();\n\t\ta.dispose();\n\t\tb.dispose();\n\t});\n\n\n\n\ttest('issue #211462: destroy socket after end timeout', async () => {\n\t\tconst socket = new EventEmitter();\n\t\tObject.assign(socket, { destroy: () => socket.emit('close') });\n\t\tconst protocol = ds.add(new Protocol(new NodeSocket(socket as Socket)));\n\n\t\tconst disposed = sinon.stub();\n\t\tconst timers = sinon.useFakeTimers();\n\n\t\tds.add(toDisposable(() => timers.restore()));\n\t\tds.add(protocol.onDidDispose(disposed));\n\n\t\tsocket.emit('end');\n\t\tassert.ok(!disposed.called);\n\t\ttimers.tick(29_999);\n\t\tassert.ok(!disposed.called);\n\t\ttimers.tick(1);\n\t\tassert.ok(disposed.called);\n\t});\n});\n\nsuite('PersistentProtocol reconnection', () => {\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('acks get piggybacked with messages', async () => {\n\t\tconst ether = new Ether();\n\t\tconst a = new PersistentProtocol({ socket: new NodeSocket(ether.a) });\n\t\tconst aMessages = new MessageStream(a);\n\t\tconst b = new PersistentProtocol({ socket: new NodeSocket(ether.b) });\n\t\tconst bMessages = new MessageStream(b);\n\n\t\ta.send(VSBuffer.fromString('a1'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\ta.send(VSBuffer.fromString('a2'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 2);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\ta.send(VSBuffer.fromString('a3'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\tconst a1 = await bMessages.waitForOne();\n\t\tassert.strictEqual(a1.toString(), 'a1');\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\tconst a2 = await bMessages.waitForOne();\n\t\tassert.strictEqual(a2.toString(), 'a2');\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\tconst a3 = await bMessages.waitForOne();\n\t\tassert.strictEqual(a3.toString(), 'a3');\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\tb.send(VSBuffer.fromString('b1'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\tconst b1 = await aMessages.waitForOne();\n\t\tassert.strictEqual(b1.toString(), 'b1');\n\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\ta.send(VSBuffer.fromString('a4'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\tconst b2 = await bMessages.waitForOne();\n\t\tassert.strictEqual(b2.toString(), 'a4');\n\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\taMessages.dispose();\n\t\tbMessages.dispose();\n\t\ta.dispose();\n\t\tb.dispose();\n\t});\n\n\ttest('ack gets sent after a while', async () => {\n\t\tawait runWithFakedTimers({ useFakeTimers: true, maxTaskCount: 100 }, async () => {\n\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\thasHighLoad: () => false\n\t\t\t};\n\t\t\tconst ether = new Ether();\n\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator });\n\t\t\tconst aMessages = new MessageStream(a);\n\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator });\n\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t// send one message A -> B\n\t\t\ta.send(VSBuffer.fromString('a1'));\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\t\t\tconst a1 = await bMessages.waitForOne();\n\t\t\tassert.strictEqual(a1.toString(), 'a1');\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t// wait for ack to arrive B -> A\n\t\t\tawait timeout(2 * ProtocolConstants.AcknowledgeTime);\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\taMessages.dispose();\n\t\t\tbMessages.dispose();\n\t\t\ta.dispose();\n\t\t\tb.dispose();\n\t\t});\n\t});\n\n\ttest('messages that are never written to a socket should not cause an ack timeout', async () => {\n\t\tawait runWithFakedTimers(\n\t\t\t{\n\t\t\t\tuseFakeTimers: true,\n\t\t\t\tuseSetImmediate: true,\n\t\t\t\tmaxTaskCount: 1000\n\t\t\t},\n\t\t\tasync () => {\n\t\t\t\t// Date.now() in fake timers starts at 0, which is very inconvenient\n\t\t\t\t// since we want to test exactly that a certain field is not initialized with Date.now()\n\t\t\t\t// As a workaround we wait such that Date.now() starts producing more realistic values\n\t\t\t\tawait timeout(60 * 60 * 1000);\n\n\t\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\t\thasHighLoad: () => false\n\t\t\t\t};\n\t\t\t\tconst ether = new Ether();\n\t\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator, sendKeepAlive: false });\n\t\t\t\tconst aMessages = new MessageStream(a);\n\t\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator, sendKeepAlive: false });\n\t\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t\t// send message a1 before reconnection to get _recvAckCheck() scheduled\n\t\t\t\ta.send(VSBuffer.fromString('a1'));\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// read message a1 at B\n\t\t\t\tconst a1 = await bMessages.waitForOne();\n\t\t\t\tassert.strictEqual(a1.toString(), 'a1');\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// send message b1 to send the ack for a1\n\t\t\t\tb.send(VSBuffer.fromString('b1'));\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\t\t\t// read message b1 at A to receive the ack for a1\n\t\t\t\tconst b1 = await aMessages.waitForOne();\n\t\t\t\tassert.strictEqual(b1.toString(), 'b1');\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\t\t\t// begin reconnection\n\t\t\t\taSocket.dispose();\n\t\t\t\tconst aSocket2 = new NodeSocket(ether.a);\n\t\t\t\ta.beginAcceptReconnection(aSocket2, null);\n\n\t\t\t\tlet timeoutListenerCalled = false;\n\t\t\t\tconst socketTimeoutListener = a.onSocketTimeout(() => {\n\t\t\t\t\ttimeoutListenerCalled = true;\n\t\t\t\t});\n\n\t\t\t\t// send message 2 during reconnection\n\t\t\t\ta.send(VSBuffer.fromString('a2'));\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\t\t\t// wait for scheduled _recvAckCheck() to execute\n\t\t\t\tawait timeout(2 * ProtocolConstants.TimeoutTime);\n\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(timeoutListenerCalled, false);\n\n\t\t\t\ta.endAcceptReconnection();\n\t\t\t\tassert.strictEqual(timeoutListenerCalled, false);\n\n\t\t\t\tawait timeout(2 * ProtocolConstants.TimeoutTime);\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\t\t\t\tassert.strictEqual(timeoutListenerCalled, false);\n\n\t\t\t\tsocketTimeoutListener.dispose();\n\t\t\t\taMessages.dispose();\n\t\t\t\tbMessages.dispose();\n\t\t\t\ta.dispose();\n\t\t\t\tb.dispose();\n\t\t\t}\n\t\t);\n\t});\n\n\ttest('acks are always sent after a reconnection', async () => {\n\t\tawait runWithFakedTimers(\n\t\t\t{\n\t\t\t\tuseFakeTimers: true,\n\t\t\t\tuseSetImmediate: true,\n\t\t\t\tmaxTaskCount: 1000\n\t\t\t},\n\t\t\tasync () => {\n\n\t\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\t\thasHighLoad: () => false\n\t\t\t\t};\n\t\t\t\tconst wireLatency = 1000;\n\t\t\t\tconst ether = new Ether(wireLatency);\n\t\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator });\n\t\t\t\tconst aMessages = new MessageStream(a);\n\t\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator });\n\t\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t\t// send message a1 to have something unacknowledged\n\t\t\t\ta.send(VSBuffer.fromString('a1'));\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// read message a1 at B\n\t\t\t\tconst a1 = await bMessages.waitForOne();\n\t\t\t\tassert.strictEqual(a1.toString(), 'a1');\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// wait for B to send an ACK message,\n\t\t\t\t// but resume before A receives it\n\t\t\t\tawait timeout(ProtocolConstants.AcknowledgeTime + wireLatency / 2);\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// simulate complete reconnection\n\t\t\t\taSocket.dispose();\n\t\t\t\tbSocket.dispose();\n\t\t\t\tconst ether2 = new Ether(wireLatency);\n\t\t\t\tconst aSocket2 = new NodeSocket(ether2.a);\n\t\t\t\tconst bSocket2 = new NodeSocket(ether2.b);\n\t\t\t\tb.beginAcceptReconnection(bSocket2, null);\n\t\t\t\tb.endAcceptReconnection();\n\t\t\t\ta.beginAcceptReconnection(aSocket2, null);\n\t\t\t\ta.endAcceptReconnection();\n\n\t\t\t\t// wait for quite some time\n\t\t\t\tawait timeout(2 * ProtocolConstants.AcknowledgeTime + wireLatency);\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\taMessages.dispose();\n\t\t\t\tbMessages.dispose();\n\t\t\t\ta.dispose();\n\t\t\t\tb.dispose();\n\t\t\t}\n\t\t);\n\t});\n\n\ttest('onSocketTimeout is emitted at most once every 20s', async () => {\n\t\tawait runWithFakedTimers(\n\t\t\t{\n\t\t\t\tuseFakeTimers: true,\n\t\t\t\tuseSetImmediate: true,\n\t\t\t\tmaxTaskCount: 1000\n\t\t\t},\n\t\t\tasync () => {\n\n\t\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\t\thasHighLoad: () => false\n\t\t\t\t};\n\t\t\t\tconst ether = new Ether();\n\t\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator });\n\t\t\t\tconst aMessages = new MessageStream(a);\n\t\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator });\n\t\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t\t// never receive acks\n\t\t\t\tb.pauseSocketWriting();\n\n\t\t\t\t// send message a1 to have something unacknowledged\n\t\t\t\ta.send(VSBuffer.fromString('a1'));\n\n\t\t\t\t// wait for the first timeout to fire\n\t\t\t\tawait Event.toPromise(a.onSocketTimeout);\n\n\t\t\t\tlet timeoutFiredAgain = false;\n\t\t\t\tconst timeoutListener = a.onSocketTimeout(() => {\n\t\t\t\t\ttimeoutFiredAgain = true;\n\t\t\t\t});\n\n\t\t\t\t// send more messages\n\t\t\t\ta.send(VSBuffer.fromString('a2'));\n\t\t\t\ta.send(VSBuffer.fromString('a3'));\n\n\t\t\t\t// wait for 10s\n\t\t\t\tawait timeout(ProtocolConstants.TimeoutTime / 2);\n\n\t\t\t\tassert.strictEqual(timeoutFiredAgain, false);\n\n\t\t\t\ttimeoutListener.dispose();\n\t\t\t\taMessages.dispose();\n\t\t\t\tbMessages.dispose();\n\t\t\t\ta.dispose();\n\t\t\t\tb.dispose();\n\t\t\t}\n\t\t);\n\t});\n\n\ttest('writing can be paused', async () => {\n\t\tawait runWithFakedTimers({ useFakeTimers: true, maxTaskCount: 100 }, async () => {\n\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\thasHighLoad: () => false\n\t\t\t};\n\t\t\tconst ether = new Ether();\n\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator });\n\t\t\tconst aMessages = new MessageStream(a);\n\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator });\n\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t// send one message A -> B\n\t\t\ta.send(VSBuffer.fromString('a1'));\n\t\t\tconst a1 = await bMessages.waitForOne();\n\t\t\tassert.strictEqual(a1.toString(), 'a1');\n\n\t\t\t// ask A to pause writing\n\t\t\tb.sendPause();\n\n\t\t\t// send a message B -> A\n\t\t\tb.send(VSBuffer.fromString('b1'));\n\t\t\tconst b1 = await aMessages.waitForOne();\n\t\t\tassert.strictEqual(b1.toString(), 'b1');\n\n\t\t\t// send a message A -> B (this should be blocked at A)\n\t\t\ta.send(VSBuffer.fromString('a2'));\n\n\t\t\t// wait a long time and check that not even acks are written\n\t\t\tawait timeout(2 * ProtocolConstants.AcknowledgeTime);\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\t\t// ask A to resume writing\n\t\t\tb.sendResume();\n\n\t\t\t// check that B receives message\n\t\t\tconst a2 = await bMessages.waitForOne();\n\t\t\tassert.strictEqual(a2.toString(), 'a2');\n\n\t\t\t// wait a long time and check that acks are written\n\t\t\tawait timeout(2 * ProtocolConstants.AcknowledgeTime);\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\taMessages.dispose();\n\t\t\tbMessages.dispose();\n\t\t\ta.dispose();\n\t\t\tb.dispose();\n\t\t});\n\t});\n});\n\nflakySuite('IPC, create handle', () => {\n\n\ttest('createRandomIPCHandle', async () => {\n\t\treturn testIPCHandle(createRandomIPCHandle());\n\t});\n\n\ttest('createStaticIPCHandle', async () => {\n\t\treturn testIPCHandle(createStaticIPCHandle(tmpdir(), 'test', '1.64.0'));\n\t});\n\n\tfunction testIPCHandle(handle: string): Promise<void> {\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tconst pipeName = createRandomIPCHandle();\n\n\t\t\tconst server = createServer();\n\n\t\t\tserver.on('error', () => {\n\t\t\t\treturn new Promise(() => server.close(() => reject()));\n\t\t\t});\n\n\t\t\tserver.listen(pipeName, () => {\n\t\t\t\tserver.removeListener('error', reject);\n\n\t\t\t\treturn new Promise(() => {\n\t\t\t\t\tserver.close(() => resolve());\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n});\n\nsuite('WebSocketNodeSocket', () => {\n\n\tconst ds = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tfunction toUint8Array(data: number[]): Uint8Array {\n\t\tconst result = new Uint8Array(data.length);\n\t\tfor (let i = 0; i < data.length; i++) {\n\t\t\tresult[i] = data[i];\n\t\t}\n\t\treturn result;\n\t}\n\n\tfunction fromUint8Array(data: Uint8Array): number[] {\n\t\tconst result = [];\n\t\tfor (let i = 0; i < data.length; i++) {\n\t\t\tresult[i] = data[i];\n\t\t}\n\t\treturn result;\n\t}\n\n\tfunction fromCharCodeArray(data: number[]): string {\n\t\tlet result = '';\n\t\tfor (let i = 0; i < data.length; i++) {\n\t\t\tresult += String.fromCharCode(data[i]);\n\t\t}\n\t\treturn result;\n\t}\n\n\tclass FakeNodeSocket extends Disposable {\n\n\t\tprivate readonly _onData = new Emitter<VSBuffer>();\n\t\tpublic readonly onData = this._onData.event;\n\n\t\tprivate readonly _onClose = new Emitter<SocketCloseEvent>();\n\t\tpublic readonly onClose = this._onClose.event;\n\n\t\tpublic writtenData: VSBuffer[] = [];\n\n\t\tpublic traceSocketEvent(type: SocketDiagnosticsEventType, data?: VSBuffer | Uint8Array | ArrayBuffer | ArrayBufferView | any): void {\n\t\t}\n\n\t\tconstructor() {\n\t\t\tsuper();\n\t\t}\n\n\t\tpublic write(data: VSBuffer): void {\n\t\t\tthis.writtenData.push(data);\n\t\t}\n\n\t\tpublic fireData(data: number[]): void {\n\t\t\tthis._onData.fire(VSBuffer.wrap(toUint8Array(data)));\n\t\t}\n\t}\n\n\tasync function testReading(frames: number[][], permessageDeflate: boolean): Promise<string> {\n\t\tconst disposables = new DisposableStore();\n\t\tconst socket = new FakeNodeSocket();\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tconst webSocket = disposables.add(new WebSocketNodeSocket(<any>socket, permessageDeflate, null, false));\n\n\t\tconst barrier = new Barrier();\n\t\tlet remainingFrameCount = frames.length;\n\n\t\tlet receivedData: string = '';\n\t\tdisposables.add(webSocket.onData((buff) => {\n\t\t\treceivedData += fromCharCodeArray(fromUint8Array(buff.buffer));\n\t\t\tremainingFrameCount--;\n\t\t\tif (remainingFrameCount === 0) {\n\t\t\t\tbarrier.open();\n\t\t\t}\n\t\t}));\n\n\t\tfor (let i = 0; i < frames.length; i++) {\n\t\t\tsocket.fireData(frames[i]);\n\t\t}\n\n\t\tawait barrier.wait();\n\n\t\tdisposables.dispose();\n\n\t\treturn receivedData;\n\t}\n\n\ttest('A single-frame unmasked text message', async () => {\n\t\tconst frames = [\n\t\t\t[0x81, 0x05, 0x48, 0x65, 0x6c, 0x6c, 0x6f] // contains \"Hello\"\n\t\t];\n\t\tconst actual = await testReading(frames, false);\n\t\tassert.deepStrictEqual(actual, 'Hello');\n\t});\n\n\ttest('A single-frame masked text message', async () => {\n\t\tconst frames = [\n\t\t\t[0x81, 0x85, 0x37, 0xfa, 0x21, 0x3d, 0x7f, 0x9f, 0x4d, 0x51, 0x58] // contains \"Hello\"\n\t\t];\n\t\tconst actual = await testReading(frames, false);\n\t\tassert.deepStrictEqual(actual, 'Hello');\n\t});\n\n\ttest('A fragmented unmasked text message', async () => {\n\t\t// contains \"Hello\"\n\t\tconst frames = [\n\t\t\t[0x01, 0x03, 0x48, 0x65, 0x6c], // contains \"Hel\"\n\t\t\t[0x80, 0x02, 0x6c, 0x6f], // contains \"lo\"\n\t\t];\n\t\tconst actual = await testReading(frames, false);\n\t\tassert.deepStrictEqual(actual, 'Hello');\n\t});\n\n\tsuite('compression', () => {\n\t\ttest('A single-frame compressed text message', async () => {\n\t\t\t// contains \"Hello\"\n\t\t\tconst frames = [\n\t\t\t\t[0xc1, 0x07, 0xf2, 0x48, 0xcd, 0xc9, 0xc9, 0x07, 0x00], // contains \"Hello\"\n\t\t\t];\n\t\t\tconst actual = await testReading(frames, true);\n\t\t\tassert.deepStrictEqual(actual, 'Hello');\n\t\t});\n\n\t\ttest('A fragmented compressed text message', async () => {\n\t\t\t// contains \"Hello\"\n\t\t\tconst frames = [  // contains \"Hello\"\n\t\t\t\t[0x41, 0x03, 0xf2, 0x48, 0xcd],\n\t\t\t\t[0x80, 0x04, 0xc9, 0xc9, 0x07, 0x00]\n\t\t\t];\n\t\t\tconst actual = await testReading(frames, true);\n\t\t\tassert.deepStrictEqual(actual, 'Hello');\n\t\t});\n\n\t\ttest('A single-frame non-compressed text message', async () => {\n\t\t\tconst frames = [\n\t\t\t\t[0x81, 0x05, 0x48, 0x65, 0x6c, 0x6c, 0x6f] // contains \"Hello\"\n\t\t\t];\n\t\t\tconst actual = await testReading(frames, true);\n\t\t\tassert.deepStrictEqual(actual, 'Hello');\n\t\t});\n\n\t\ttest('A single-frame compressed text message followed by a single-frame non-compressed text message', async () => {\n\t\t\tconst frames = [\n\t\t\t\t[0xc1, 0x07, 0xf2, 0x48, 0xcd, 0xc9, 0xc9, 0x07, 0x00], // contains \"Hello\"\n\t\t\t\t[0x81, 0x05, 0x77, 0x6f, 0x72, 0x6c, 0x64] // contains \"world\"\n\t\t\t];\n\t\t\tconst actual = await testReading(frames, true);\n\t\t\tassert.deepStrictEqual(actual, 'Helloworld');\n\t\t});\n\t});\n\n\ttest('Large buffers are split and sent in chunks', async () => {\n\n\t\tlet receivingSideOnDataCallCount = 0;\n\t\tlet receivingSideTotalBytes = 0;\n\t\tconst receivingSideSocketClosedBarrier = new Barrier();\n\n\t\tconst server = await listenOnRandomPort((socket) => {\n\t\t\t// stop the server when the first connection is received\n\t\t\tserver.close();\n\n\t\t\tconst webSocketNodeSocket = new WebSocketNodeSocket(new NodeSocket(socket), true, null, false);\n\t\t\tds.add(webSocketNodeSocket.onData((data) => {\n\t\t\t\treceivingSideOnDataCallCount++;\n\t\t\t\treceivingSideTotalBytes += data.byteLength;\n\t\t\t}));\n\n\t\t\tds.add(webSocketNodeSocket.onClose(() => {\n\t\t\t\twebSocketNodeSocket.dispose();\n\t\t\t\treceivingSideSocketClosedBarrier.open();\n\t\t\t}));\n\t\t});\n\n\t\tconst socket = connect({\n\t\t\thost: '127.0.0.1',\n\t\t\tport: (<AddressInfo>server.address()).port\n\t\t});\n\n\t\tconst buff = generateRandomBuffer(1 * 1024 * 1024);\n\n\t\tconst webSocketNodeSocket = new WebSocketNodeSocket(new NodeSocket(socket), true, null, false);\n\t\twebSocketNodeSocket.write(buff);\n\t\tawait webSocketNodeSocket.drain();\n\t\twebSocketNodeSocket.dispose();\n\t\tawait receivingSideSocketClosedBarrier.wait();\n\n\t\tassert.strictEqual(receivingSideTotalBytes, buff.byteLength);\n\t\tassert.strictEqual(receivingSideOnDataCallCount, 4);\n\t});\n\n\ttest('issue #194284: ping/pong opcodes are supported', async () => {\n\n\t\tconst disposables = new DisposableStore();\n\t\tconst socket = new FakeNodeSocket();\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tconst webSocket = disposables.add(new WebSocketNodeSocket(<any>socket, false, null, false));\n\n\t\tlet receivedData: string = '';\n\t\tdisposables.add(webSocket.onData((buff) => {\n\t\t\treceivedData += fromCharCodeArray(fromUint8Array(buff.buffer));\n\t\t}));\n\n\t\t// A single-frame non-compressed text message that contains \"Hello\"\n\t\tsocket.fireData([0x81, 0x05, 0x48, 0x65, 0x6c, 0x6c, 0x6f]);\n\n\t\t// A ping message that contains \"data\"\n\t\tsocket.fireData([0x89, 0x04, 0x64, 0x61, 0x74, 0x61]);\n\n\t\t// Another single-frame non-compressed text message that contains \"Hello\"\n\t\tsocket.fireData([0x81, 0x05, 0x48, 0x65, 0x6c, 0x6c, 0x6f]);\n\n\t\tassert.strictEqual(receivedData, 'HelloHello');\n\t\tassert.deepStrictEqual(\n\t\t\tsocket.writtenData.map(x => fromUint8Array(x.buffer)),\n\t\t\t[\n\t\t\t\t// A pong message that contains \"data\"\n\t\t\t\t[0x8A, 0x04, 0x64, 0x61, 0x74, 0x61]\n\t\t\t]\n\t\t);\n\n\t\tdisposables.dispose();\n\n\t\treturn receivedData;\n\t});\n\n\tfunction generateRandomBuffer(size: number): VSBuffer {\n\t\tconst buff = VSBuffer.alloc(size);\n\t\tfor (let i = 0; i < size; i++) {\n\t\t\tbuff.writeUInt8(Math.floor(256 * Math.random()), i);\n\t\t}\n\t\treturn buff;\n\t}\n\n\tfunction listenOnRandomPort(handler: (socket: Socket) => void): Promise<Server> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst server = createServer(handler).listen(0);\n\t\t\tserver.on('listening', () => {\n\t\t\t\tresolve(server);\n\t\t\t});\n\t\t\tserver.on('error', (err) => {\n\t\t\t\treject(err);\n\t\t\t});\n\t\t});\n\t}\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport sinon from 'sinon';\nimport { EventEmitter } from 'events';\nimport { AddressInfo, connect, createServer, Server, Socket } from 'net';\nimport { tmpdir } from 'os';\nimport { Barrier, timeout } from '../../../../common/async.js';\nimport { VSBuffer } from '../../../../common/buffer.js';\nimport { Emitter, Event } from '../../../../common/event.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../../common/lifecycle.js';\nimport { ILoadEstimator, PersistentProtocol, Protocol, ProtocolConstants, SocketCloseEvent, SocketDiagnosticsEventType } from '../../common/ipc.net.js';\nimport { createRandomIPCHandle, createStaticIPCHandle, NodeSocket, WebSocketNodeSocket } from '../../node/ipc.net.js';\nimport { flakySuite } from '../../../../test/common/testUtils.js';\nimport { runWithFakedTimers } from '../../../../test/common/timeTravelScheduler.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../test/common/utils.js';\n\nclass MessageStream extends Disposable {\n\n\tprivate _currentComplete: ((data: VSBuffer) => void) | null;\n\tprivate _messages: VSBuffer[];\n\n\tconstructor(x: Protocol | PersistentProtocol) {\n\t\tsuper();\n\t\tthis._currentComplete = null;\n\t\tthis._messages = [];\n\t\tthis._register(x.onMessage(data => {\n\t\t\tthis._messages.push(data);\n\t\t\tthis._trigger();\n\t\t}));\n\t}\n\n\tprivate _trigger(): void {\n\t\tif (!this._currentComplete) {\n\t\t\treturn;\n\t\t}\n\t\tif (this._messages.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tconst complete = this._currentComplete;\n\t\tconst msg = this._messages.shift()!;\n\n\t\tthis._currentComplete = null;\n\t\tcomplete(msg);\n\t}\n\n\tpublic waitForOne(): Promise<VSBuffer> {\n\t\treturn new Promise<VSBuffer>((complete) => {\n\t\t\tthis._currentComplete = complete;\n\t\t\tthis._trigger();\n\t\t});\n\t}\n}\n\nclass EtherStream extends EventEmitter {\n\tconstructor(\n\t\tprivate readonly _ether: Ether,\n\t\tprivate readonly _name: 'a' | 'b'\n\t) {\n\t\tsuper();\n\t}\n\n\twrite(data: Buffer, cb?: Function): boolean {\n\t\tif (!Buffer.isBuffer(data)) {\n\t\t\tthrow new Error(`Invalid data`);\n\t\t}\n\t\tthis._ether.write(this._name, data);\n\t\treturn true;\n\t}\n\n\tdestroy(): void {\n\t}\n}\n\nclass Ether {\n\n\tprivate readonly _a: EtherStream;\n\tprivate readonly _b: EtherStream;\n\n\tprivate _ab: Buffer[];\n\tprivate _ba: Buffer[];\n\n\tpublic get a(): Socket {\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\treturn <any>this._a;\n\t}\n\n\tpublic get b(): Socket {\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\treturn <any>this._b;\n\t}\n\n\tconstructor(\n\t\tprivate readonly _wireLatency = 0\n\t) {\n\t\tthis._a = new EtherStream(this, 'a');\n\t\tthis._b = new EtherStream(this, 'b');\n\t\tthis._ab = [];\n\t\tthis._ba = [];\n\t}\n\n\tpublic write(from: 'a' | 'b', data: Buffer): void {\n\t\tsetTimeout(() => {\n\t\t\tif (from === 'a') {\n\t\t\t\tthis._ab.push(data);\n\t\t\t} else {\n\t\t\t\tthis._ba.push(data);\n\t\t\t}\n\n\t\t\tsetTimeout(() => this._deliver(), 0);\n\t\t}, this._wireLatency);\n\t}\n\n\tprivate _deliver(): void {\n\n\t\tif (this._ab.length > 0) {\n\t\t\tconst data = Buffer.concat(this._ab);\n\t\t\tthis._ab.length = 0;\n\t\t\tthis._b.emit('data', data);\n\t\t\tsetTimeout(() => this._deliver(), 0);\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._ba.length > 0) {\n\t\t\tconst data = Buffer.concat(this._ba);\n\t\t\tthis._ba.length = 0;\n\t\t\tthis._a.emit('data', data);\n\t\t\tsetTimeout(() => this._deliver(), 0);\n\t\t\treturn;\n\t\t}\n\n\t}\n}\n\nsuite('IPC, Socket Protocol', () => {\n\n\tconst ds = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet ether: Ether;\n\n\tsetup(() => {\n\t\tether = new Ether();\n\t});\n\n\ttest('read/write', async () => {\n\n\t\tconst a = new Protocol(new NodeSocket(ether.a));\n\t\tconst b = new Protocol(new NodeSocket(ether.b));\n\t\tconst bMessages = new MessageStream(b);\n\n\t\ta.send(VSBuffer.fromString('foobarfarboo'));\n\t\tconst msg1 = await bMessages.waitForOne();\n\t\tassert.strictEqual(msg1.toString(), 'foobarfarboo');\n\n\t\tconst buffer = VSBuffer.alloc(1);\n\t\tbuffer.writeUInt8(123, 0);\n\t\ta.send(buffer);\n\t\tconst msg2 = await bMessages.waitForOne();\n\t\tassert.strictEqual(msg2.readUInt8(0), 123);\n\n\t\tbMessages.dispose();\n\t\ta.dispose();\n\t\tb.dispose();\n\t});\n\n\n\ttest('read/write, object data', async () => {\n\n\t\tconst a = new Protocol(new NodeSocket(ether.a));\n\t\tconst b = new Protocol(new NodeSocket(ether.b));\n\t\tconst bMessages = new MessageStream(b);\n\n\t\tconst data = {\n\t\t\tpi: Math.PI,\n\t\t\tfoo: 'bar',\n\t\t\tmore: true,\n\t\t\tdata: 'Hello World'.split('')\n\t\t};\n\n\t\ta.send(VSBuffer.fromString(JSON.stringify(data)));\n\t\tconst msg = await bMessages.waitForOne();\n\t\tassert.deepStrictEqual(JSON.parse(msg.toString()), data);\n\n\t\tbMessages.dispose();\n\t\ta.dispose();\n\t\tb.dispose();\n\t});\n\n\n\n\ttest('issue #211462: destroy socket after end timeout', async () => {\n\t\tconst socket = new EventEmitter();\n\t\tObject.assign(socket, { destroy: () => socket.emit('close') });\n\t\tconst protocol = ds.add(new Protocol(new NodeSocket(socket as Socket)));\n\n\t\tconst disposed = sinon.stub();\n\t\tconst timers = sinon.useFakeTimers();\n\n\t\tds.add(toDisposable(() => timers.restore()));\n\t\tds.add(protocol.onDidDispose(disposed));\n\n\t\tsocket.emit('end');\n\t\tassert.ok(!disposed.called);\n\t\ttimers.tick(29_999);\n\t\tassert.ok(!disposed.called);\n\t\ttimers.tick(1);\n\t\tassert.ok(disposed.called);\n\t});\n});\n\nsuite('PersistentProtocol reconnection', () => {\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('acks get piggybacked with messages', async () => {\n\t\tconst ether = new Ether();\n\t\tconst a = new PersistentProtocol({ socket: new NodeSocket(ether.a) });\n\t\tconst aMessages = new MessageStream(a);\n\t\tconst b = new PersistentProtocol({ socket: new NodeSocket(ether.b) });\n\t\tconst bMessages = new MessageStream(b);\n\n\t\ta.send(VSBuffer.fromString('a1'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\ta.send(VSBuffer.fromString('a2'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 2);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\ta.send(VSBuffer.fromString('a3'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\tconst a1 = await bMessages.waitForOne();\n\t\tassert.strictEqual(a1.toString(), 'a1');\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\tconst a2 = await bMessages.waitForOne();\n\t\tassert.strictEqual(a2.toString(), 'a2');\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\tconst a3 = await bMessages.waitForOne();\n\t\tassert.strictEqual(a3.toString(), 'a3');\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\tb.send(VSBuffer.fromString('b1'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 3);\n\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\tconst b1 = await aMessages.waitForOne();\n\t\tassert.strictEqual(b1.toString(), 'b1');\n\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\ta.send(VSBuffer.fromString('a4'));\n\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\tconst b2 = await bMessages.waitForOne();\n\t\tassert.strictEqual(b2.toString(), 'a4');\n\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\taMessages.dispose();\n\t\tbMessages.dispose();\n\t\ta.dispose();\n\t\tb.dispose();\n\t});\n\n\ttest('ack gets sent after a while', async () => {\n\t\tawait runWithFakedTimers({ useFakeTimers: true, maxTaskCount: 100 }, async () => {\n\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\thasHighLoad: () => false\n\t\t\t};\n\t\t\tconst ether = new Ether();\n\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator });\n\t\t\tconst aMessages = new MessageStream(a);\n\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator });\n\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t// send one message A -> B\n\t\t\ta.send(VSBuffer.fromString('a1'));\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\t\t\tconst a1 = await bMessages.waitForOne();\n\t\t\tassert.strictEqual(a1.toString(), 'a1');\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t// wait for ack to arrive B -> A\n\t\t\tawait timeout(2 * ProtocolConstants.AcknowledgeTime);\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\taMessages.dispose();\n\t\t\tbMessages.dispose();\n\t\t\ta.dispose();\n\t\t\tb.dispose();\n\t\t});\n\t});\n\n\ttest('messages that are never written to a socket should not cause an ack timeout', async () => {\n\t\tawait runWithFakedTimers(\n\t\t\t{\n\t\t\t\tuseFakeTimers: true,\n\t\t\t\tuseSetImmediate: true,\n\t\t\t\tmaxTaskCount: 1000\n\t\t\t},\n\t\t\tasync () => {\n\t\t\t\t// Date.now() in fake timers starts at 0, which is very inconvenient\n\t\t\t\t// since we want to test exactly that a certain field is not initialized with Date.now()\n\t\t\t\t// As a workaround we wait such that Date.now() starts producing more realistic values\n\t\t\t\tawait timeout(60 * 60 * 1000);\n\n\t\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\t\thasHighLoad: () => false\n\t\t\t\t};\n\t\t\t\tconst ether = new Ether();\n\t\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator, sendKeepAlive: false });\n\t\t\t\tconst aMessages = new MessageStream(a);\n\t\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator, sendKeepAlive: false });\n\t\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t\t// send message a1 before reconnection to get _recvAckCheck() scheduled\n\t\t\t\ta.send(VSBuffer.fromString('a1'));\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// read message a1 at B\n\t\t\t\tconst a1 = await bMessages.waitForOne();\n\t\t\t\tassert.strictEqual(a1.toString(), 'a1');\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// send message b1 to send the ack for a1\n\t\t\t\tb.send(VSBuffer.fromString('b1'));\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\t\t\t// read message b1 at A to receive the ack for a1\n\t\t\t\tconst b1 = await aMessages.waitForOne();\n\t\t\t\tassert.strictEqual(b1.toString(), 'b1');\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\t\t\t// begin reconnection\n\t\t\t\taSocket.dispose();\n\t\t\t\tconst aSocket2 = new NodeSocket(ether.a);\n\t\t\t\ta.beginAcceptReconnection(aSocket2, null);\n\n\t\t\t\tlet timeoutListenerCalled = false;\n\t\t\t\tconst socketTimeoutListener = a.onSocketTimeout(() => {\n\t\t\t\t\ttimeoutListenerCalled = true;\n\t\t\t\t});\n\n\t\t\t\t// send message 2 during reconnection\n\t\t\t\ta.send(VSBuffer.fromString('a2'));\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\t\t\t// wait for scheduled _recvAckCheck() to execute\n\t\t\t\tawait timeout(2 * ProtocolConstants.TimeoutTime);\n\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(timeoutListenerCalled, false);\n\n\t\t\t\ta.endAcceptReconnection();\n\t\t\t\tassert.strictEqual(timeoutListenerCalled, false);\n\n\t\t\t\tawait timeout(2 * ProtocolConstants.TimeoutTime);\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\t\t\t\tassert.strictEqual(timeoutListenerCalled, false);\n\n\t\t\t\tsocketTimeoutListener.dispose();\n\t\t\t\taMessages.dispose();\n\t\t\t\tbMessages.dispose();\n\t\t\t\ta.dispose();\n\t\t\t\tb.dispose();\n\t\t\t}\n\t\t);\n\t});\n\n\ttest('acks are always sent after a reconnection', async () => {\n\t\tawait runWithFakedTimers(\n\t\t\t{\n\t\t\t\tuseFakeTimers: true,\n\t\t\t\tuseSetImmediate: true,\n\t\t\t\tmaxTaskCount: 1000\n\t\t\t},\n\t\t\tasync () => {\n\n\t\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\t\thasHighLoad: () => false\n\t\t\t\t};\n\t\t\t\tconst wireLatency = 1000;\n\t\t\t\tconst ether = new Ether(wireLatency);\n\t\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator });\n\t\t\t\tconst aMessages = new MessageStream(a);\n\t\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator });\n\t\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t\t// send message a1 to have something unacknowledged\n\t\t\t\ta.send(VSBuffer.fromString('a1'));\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// read message a1 at B\n\t\t\t\tconst a1 = await bMessages.waitForOne();\n\t\t\t\tassert.strictEqual(a1.toString(), 'a1');\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// wait for B to send an ACK message,\n\t\t\t\t// but resume before A receives it\n\t\t\t\tawait timeout(ProtocolConstants.AcknowledgeTime + wireLatency / 2);\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\t// simulate complete reconnection\n\t\t\t\taSocket.dispose();\n\t\t\t\tbSocket.dispose();\n\t\t\t\tconst ether2 = new Ether(wireLatency);\n\t\t\t\tconst aSocket2 = new NodeSocket(ether2.a);\n\t\t\t\tconst bSocket2 = new NodeSocket(ether2.b);\n\t\t\t\tb.beginAcceptReconnection(bSocket2, null);\n\t\t\t\tb.endAcceptReconnection();\n\t\t\t\ta.beginAcceptReconnection(aSocket2, null);\n\t\t\t\ta.endAcceptReconnection();\n\n\t\t\t\t// wait for quite some time\n\t\t\t\tawait timeout(2 * ProtocolConstants.AcknowledgeTime + wireLatency);\n\t\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\t\taMessages.dispose();\n\t\t\t\tbMessages.dispose();\n\t\t\t\ta.dispose();\n\t\t\t\tb.dispose();\n\t\t\t}\n\t\t);\n\t});\n\n\ttest('onSocketTimeout is emitted at most once every 20s', async () => {\n\t\tawait runWithFakedTimers(\n\t\t\t{\n\t\t\t\tuseFakeTimers: true,\n\t\t\t\tuseSetImmediate: true,\n\t\t\t\tmaxTaskCount: 1000\n\t\t\t},\n\t\t\tasync () => {\n\n\t\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\t\thasHighLoad: () => false\n\t\t\t\t};\n\t\t\t\tconst ether = new Ether();\n\t\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator });\n\t\t\t\tconst aMessages = new MessageStream(a);\n\t\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator });\n\t\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t\t// never receive acks\n\t\t\t\tb.pauseSocketWriting();\n\n\t\t\t\t// send message a1 to have something unacknowledged\n\t\t\t\ta.send(VSBuffer.fromString('a1'));\n\n\t\t\t\t// wait for the first timeout to fire\n\t\t\t\tawait Event.toPromise(a.onSocketTimeout);\n\n\t\t\t\tlet timeoutFiredAgain = false;\n\t\t\t\tconst timeoutListener = a.onSocketTimeout(() => {\n\t\t\t\t\ttimeoutFiredAgain = true;\n\t\t\t\t});\n\n\t\t\t\t// send more messages\n\t\t\t\ta.send(VSBuffer.fromString('a2'));\n\t\t\t\ta.send(VSBuffer.fromString('a3'));\n\n\t\t\t\t// wait for 10s\n\t\t\t\tawait timeout(ProtocolConstants.TimeoutTime / 2);\n\n\t\t\t\tassert.strictEqual(timeoutFiredAgain, false);\n\n\t\t\t\ttimeoutListener.dispose();\n\t\t\t\taMessages.dispose();\n\t\t\t\tbMessages.dispose();\n\t\t\t\ta.dispose();\n\t\t\t\tb.dispose();\n\t\t\t}\n\t\t);\n\t});\n\n\ttest('writing can be paused', async () => {\n\t\tawait runWithFakedTimers({ useFakeTimers: true, maxTaskCount: 100 }, async () => {\n\t\t\tconst loadEstimator: ILoadEstimator = {\n\t\t\t\thasHighLoad: () => false\n\t\t\t};\n\t\t\tconst ether = new Ether();\n\t\t\tconst aSocket = new NodeSocket(ether.a);\n\t\t\tconst a = new PersistentProtocol({ socket: aSocket, loadEstimator });\n\t\t\tconst aMessages = new MessageStream(a);\n\t\t\tconst bSocket = new NodeSocket(ether.b);\n\t\t\tconst b = new PersistentProtocol({ socket: bSocket, loadEstimator });\n\t\t\tconst bMessages = new MessageStream(b);\n\n\t\t\t// send one message A -> B\n\t\t\ta.send(VSBuffer.fromString('a1'));\n\t\t\tconst a1 = await bMessages.waitForOne();\n\t\t\tassert.strictEqual(a1.toString(), 'a1');\n\n\t\t\t// ask A to pause writing\n\t\t\tb.sendPause();\n\n\t\t\t// send a message B -> A\n\t\t\tb.send(VSBuffer.fromString('b1'));\n\t\t\tconst b1 = await aMessages.waitForOne();\n\t\t\tassert.strictEqual(b1.toString(), 'b1');\n\n\t\t\t// send a message A -> B (this should be blocked at A)\n\t\t\ta.send(VSBuffer.fromString('a2'));\n\n\t\t\t// wait a long time and check that not even acks are written\n\t\t\tawait timeout(2 * ProtocolConstants.AcknowledgeTime);\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 1);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 1);\n\n\t\t\t// ask A to resume writing\n\t\t\tb.sendResume();\n\n\t\t\t// check that B receives message\n\t\t\tconst a2 = await bMessages.waitForOne();\n\t\t\tassert.strictEqual(a2.toString(), 'a2');\n\n\t\t\t// wait a long time and check that acks are written\n\t\t\tawait timeout(2 * ProtocolConstants.AcknowledgeTime);\n\t\t\tassert.strictEqual(a.unacknowledgedCount, 0);\n\t\t\tassert.strictEqual(b.unacknowledgedCount, 0);\n\n\t\t\taMessages.dispose();\n\t\t\tbMessages.dispose();\n\t\t\ta.dispose();\n\t\t\tb.dispose();\n\t\t});\n\t});\n});\n\nflakySuite('IPC, create handle', () => {\n\n\ttest('createRandomIPCHandle', async () => {\n\t\treturn testIPCHandle(createRandomIPCHandle());\n\t});\n\n\ttest('createStaticIPCHandle', async () => {\n\t\treturn testIPCHandle(createStaticIPCHandle(tmpdir(), 'test', '1.64.0'));\n\t});\n\n\tfunction testIPCHandle(handle: string): Promise<void> {\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tconst pipeName = createRandomIPCHandle();\n\n\t\t\tconst server = createServer();\n\n\t\t\tserver.on('error', () => {\n\t\t\t\treturn new Promise(() => server.close(() => reject()));\n\t\t\t});\n\n\t\t\tserver.listen(pipeName, () => {\n\t\t\t\tserver.removeListener('error', reject);\n\n\t\t\t\treturn new Promise(() => {\n\t\t\t\t\tserver.close(() => resolve());\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n});\n\nsuite('WebSocketNodeSocket', () => {\n\n\tconst ds = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tfunction toUint8Array(data: number[]): Uint8Array {\n\t\tconst result = new Uint8Array(data.length);\n\t\tfor (let i = 0; i < data.length; i++) {\n\t\t\tresult[i] = data[i];\n\t\t}\n\t\treturn result;\n\t}\n\n\tfunction fromUint8Array(data: Uint8Array): number[] {\n\t\tconst result = [];\n\t\tfor (let i = 0; i < data.length; i++) {\n\t\t\tresult[i] = data[i];\n\t\t}\n\t\treturn result;\n\t}\n\n\tfunction fromCharCodeArray(data: number[]): string {\n\t\tlet result = '';\n\t\tfor (let i = 0; i < data.length; i++) {\n\t\t\tresult += String.fromCharCode(data[i]);\n\t\t}\n\t\treturn result;\n\t}\n\n\tclass FakeNodeSocket extends Disposable {\n\n\t\tprivate readonly _onData = new Emitter<VSBuffer>();\n\t\tpublic readonly onData = this._onData.event;\n\n\t\tprivate readonly _onClose = new Emitter<SocketCloseEvent>();\n\t\tpublic readonly onClose = this._onClose.event;\n\n\t\tpublic writtenData: VSBuffer[] = [];\n\n\t\tpublic traceSocketEvent(type: SocketDiagnosticsEventType, data?: VSBuffer | Uint8Array | ArrayBuffer | ArrayBufferView | any): void {\n\t\t}\n\n\t\tconstructor() {\n\t\t\tsuper();\n\t\t}\n\n\t\tpublic write(data: VSBuffer): void {\n\t\t\tthis.writtenData.push(data);\n\t\t}\n\n\t\tpublic fireData(data: number[]): void {\n\t\t\tthis._onData.fire(VSBuffer.wrap(toUint8Array(data)));\n\t\t}\n\t}\n\n\tasync function testReading(frames: number[][], permessageDeflate: boolean): Promise<string> {\n\t\tconst disposables = new DisposableStore();\n\t\tconst socket = new FakeNodeSocket();\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tconst webSocket = disposables.add(new WebSocketNodeSocket(<any>socket, permessageDeflate, null, false));\n\n\t\tconst barrier = new Barrier();\n\t\tlet remainingFrameCount = frames.length;\n\n\t\tlet receivedData: string = '';\n\t\tdisposables.add(webSocket.onData((buff) => {\n\t\t\treceivedData += fromCharCodeArray(fromUint8Array(buff.buffer));\n\t\t\tremainingFrameCount--;\n\t\t\tif (remainingFrameCount === 0) {\n\t\t\t\tbarrier.open();\n\t\t\t}\n\t\t}));\n\n\t\tfor (let i = 0; i < frames.length; i++) {\n\t\t\tsocket.fireData(frames[i]);\n\t\t}\n\n\t\tawait barrier.wait();\n\n\t\tdisposables.dispose();\n\n\t\treturn receivedData;\n\t}\n\n\ttest('A single-frame unmasked text message', async () => {\n\t\tconst frames = [\n\t\t\t[0x81, 0x05, 0x48, 0x65, 0x6c, 0x6c, 0x6f] // contains \"Hello\"\n\t\t];\n\t\tconst actual = await testReading(frames, false);\n\t\tassert.deepStrictEqual(actual, 'Hello');\n\t});\n\n\ttest('A single-frame masked text message', async () => {\n\t\tconst frames = [\n\t\t\t[0x81, 0x85, 0x37, 0xfa, 0x21, 0x3d, 0x7f, 0x9f, 0x4d, 0x51, 0x58] // contains \"Hello\"\n\t\t];\n\t\tconst actual = await testReading(frames, false);\n\t\tassert.deepStrictEqual(actual, 'Hello');\n\t});\n\n\ttest('A fragmented unmasked text message', async () => {\n\t\t// contains \"Hello\"\n\t\tconst frames = [\n\t\t\t[0x01, 0x03, 0x48, 0x65, 0x6c], // contains \"Hel\"\n\t\t\t[0x80, 0x02, 0x6c, 0x6f], // contains \"lo\"\n\t\t];\n\t\tconst actual = await testReading(frames, false);\n\t\tassert.deepStrictEqual(actual, 'Hello');\n\t});\n\n\tsuite('compression', () => {\n\t\ttest('A single-frame compressed text message', async () => {\n\t\t\t// contains \"Hello\"\n\t\t\tconst frames = [\n\t\t\t\t[0xc1, 0x07, 0xf2, 0x48, 0xcd, 0xc9, 0xc9, 0x07, 0x00], // contains \"Hello\"\n\t\t\t];\n\t\t\tconst actual = await testReading(frames, true);\n\t\t\tassert.deepStrictEqual(actual, 'Hello');\n\t\t});\n\n\t\ttest('A fragmented compressed text message', async () => {\n\t\t\t// contains \"Hello\"\n\t\t\tconst frames = [  // contains \"Hello\"\n\t\t\t\t[0x41, 0x03, 0xf2, 0x48, 0xcd],\n\t\t\t\t[0x80, 0x04, 0xc9, 0xc9, 0x07, 0x00]\n\t\t\t];\n\t\t\tconst actual = await testReading(frames, true);\n\t\t\tassert.deepStrictEqual(actual, 'Hello');\n\t\t});\n\n\t\ttest('A single-frame non-compressed text message', async () => {\n\t\t\tconst frames = [\n\t\t\t\t[0x81, 0x05, 0x48, 0x65, 0x6c, 0x6c, 0x6f] // contains \"Hello\"\n\t\t\t];\n\t\t\tconst actual = await testReading(frames, true);\n\t\t\tassert.deepStrictEqual(actual, 'Hello');\n\t\t});\n\n\t\ttest('A single-frame compressed text message followed by a single-frame non-compressed text message', async () => {\n\t\t\tconst frames = [\n\t\t\t\t[0xc1, 0x07, 0xf2, 0x48, 0xcd, 0xc9, 0xc9, 0x07, 0x00], // contains \"Hello\"\n\t\t\t\t[0x81, 0x05, 0x77, 0x6f, 0x72, 0x6c, 0x64] // contains \"world\"\n\t\t\t];\n\t\t\tconst actual = await testReading(frames, true);\n\t\t\tassert.deepStrictEqual(actual, 'Helloworld');\n\t\t});\n\t});\n\n\ttest('Large buffers are split and sent in chunks', async () => {\n\n\t\tlet receivingSideOnDataCallCount = 0;\n\t\tlet receivingSideTotalBytes = 0;\n\t\tconst receivingSideSocketClosedBarrier = new Barrier();\n\n\t\tconst server = await listenOnRandomPort((socket) => {\n\t\t\t// stop the server when the first connection is received\n\t\t\tserver.close();\n\n\t\t\tconst webSocketNodeSocket = new WebSocketNodeSocket(new NodeSocket(socket), true, null, false);\n\t\t\tds.add(webSocketNodeSocket.onData((data) => {\n\t\t\t\treceivingSideOnDataCallCount++;\n\t\t\t\treceivingSideTotalBytes += data.byteLength;\n\t\t\t}));\n\n\t\t\tds.add(webSocketNodeSocket.onClose(() => {\n\t\t\t\twebSocketNodeSocket.dispose();\n\t\t\t\treceivingSideSocketClosedBarrier.open();\n\t\t\t}));\n\t\t});\n\n\t\tconst socket = connect({\n\t\t\thost: '127.0.0.1',\n\t\t\tport: (<AddressInfo>server.address()).port\n\t\t});\n\n\t\tconst buff = generateRandomBuffer(1 * 1024 * 1024);\n\n\t\tconst webSocketNodeSocket = new WebSocketNodeSocket(new NodeSocket(socket), true, null, false);\n\t\twebSocketNodeSocket.write(buff);\n\t\tawait webSocketNodeSocket.drain();\n\t\twebSocketNodeSocket.dispose();\n\t\tawait receivingSideSocketClosedBarrier.wait();\n\n\t\tassert.strictEqual(receivingSideTotalBytes, buff.byteLength);\n\t\tassert.strictEqual(receivingSideOnDataCallCount, 4);\n\t});\n\n\ttest('issue #194284: ping/pong opcodes are supported', async () => {\n\n\t\tconst disposables = new DisposableStore();\n\t\tconst socket = new FakeNodeSocket();\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tconst webSocket = disposables.add(new WebSocketNodeSocket(<any>socket, false, null, false));\n\n\t\tlet receivedData: string = '';\n\t\tdisposables.add(webSocket.onData((buff) => {\n\t\t\treceivedData += fromCharCodeArray(fromUint8Array(buff.buffer));\n\t\t}));\n\n\t\t// A single-frame non-compressed text message that contains \"Hello\"\n\t\tsocket.fireData([0x81, 0x05, 0x48, 0x65, 0x6c, 0x6c, 0x6f]);\n\n\t\t// A ping message that contains \"data\"\n\t\tsocket.fireData([0x89, 0x04, 0x64, 0x61, 0x74, 0x61]);\n\n\t\t// Another single-frame non-compressed text message that contains \"Hello\"\n\t\tsocket.fireData([0x81, 0x05, 0x48, 0x65, 0x6c, 0x6c, 0x6f]);\n\n\t\tassert.strictEqual(receivedData, 'HelloHello');\n\t\tassert.deepStrictEqual(\n\t\t\tsocket.writtenData.map(x => fromUint8Array(x.buffer)),\n\t\t\t[\n\t\t\t\t// A pong message that contains \"data\"\n\t\t\t\t[0x8A, 0x04, 0x64, 0x61, 0x74, 0x61]\n\t\t\t]\n\t\t);\n\n\t\tdisposables.dispose();\n\n\t\treturn receivedData;\n\t});\n\n\tfunction generateRandomBuffer(size: number): VSBuffer {\n\t\tconst buff = VSBuffer.alloc(size);\n\t\tfor (let i = 0; i < size; i++) {\n\t\t\tbuff.writeUInt8(Math.floor(256 * Math.random()), i);\n\t\t}\n\t\treturn buff;\n\t}\n\n\tfunction listenOnRandomPort(handler: (socket: Socket) => void): Promise<Server> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst server = createServer(handler).listen(0);\n\t\t\tserver.on('listening', () => {\n\t\t\t\tresolve(server);\n\t\t\t});\n\t\t\tserver.on('error', (err) => {\n\t\t\t\treject(err);\n\t\t\t});\n\t\t});\n\t}\n});\n"]}