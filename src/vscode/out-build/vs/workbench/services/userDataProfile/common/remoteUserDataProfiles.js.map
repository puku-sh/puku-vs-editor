{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/userDataProfile/common/remoteUserDataProfiles.ts","vs/workbench/services/userDataProfile/common/remoteUserDataProfiles.ts"],"names":[],"mappings":"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","file":"remoteUserDataProfiles.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { DidChangeProfilesEvent, IUserDataProfile, IUserDataProfilesService } from '../../../../platform/userDataProfile/common/userDataProfile.js';\nimport { IRemoteAgentService } from '../../remote/common/remoteAgentService.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { IStringDictionary } from '../../../../base/common/collections.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IUserDataProfileService } from './userDataProfile.js';\nimport { distinct } from '../../../../base/common/arrays.js';\nimport { IWorkbenchEnvironmentService } from '../../environment/common/environmentService.js';\nimport { UserDataProfilesService } from '../../../../platform/userDataProfile/common/userDataProfileIpc.js';\nimport { ErrorNoTelemetry } from '../../../../base/common/errors.js';\n\nconst associatedRemoteProfilesKey = 'associatedRemoteProfiles';\n\nexport const IRemoteUserDataProfilesService = createDecorator<IRemoteUserDataProfilesService>('IRemoteUserDataProfilesService');\nexport interface IRemoteUserDataProfilesService {\n\treadonly _serviceBrand: undefined;\n\tgetRemoteProfiles(): Promise<readonly IUserDataProfile[]>;\n\tgetRemoteProfile(localProfile: IUserDataProfile): Promise<IUserDataProfile>;\n}\n\nclass RemoteUserDataProfilesService extends Disposable implements IRemoteUserDataProfilesService {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate readonly initPromise: Promise<void>;\n\n\tprivate remoteUserDataProfilesService: IUserDataProfilesService | undefined;\n\n\tconstructor(\n\t\t@IWorkbenchEnvironmentService private readonly environmentService: IWorkbenchEnvironmentService,\n\t\t@IRemoteAgentService private readonly remoteAgentService: IRemoteAgentService,\n\t\t@IUserDataProfilesService private readonly userDataProfilesService: IUserDataProfilesService,\n\t\t@IUserDataProfileService private readonly userDataProfileService: IUserDataProfileService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@ILogService private readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t\tthis.initPromise = this.init();\n\t}\n\n\tprivate async init(): Promise<void> {\n\t\tconst connection = this.remoteAgentService.getConnection();\n\t\tif (!connection) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst environment = await this.remoteAgentService.getEnvironment();\n\t\tif (!environment) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.remoteUserDataProfilesService = new UserDataProfilesService(environment.profiles.all, environment.profiles.home, connection.getChannel('userDataProfiles'));\n\t\tthis._register(this.userDataProfilesService.onDidChangeProfiles(e => this.onDidChangeLocalProfiles(e)));\n\n\t\t// Associate current local profile with remote profile\n\t\tconst remoteProfile = await this.getAssociatedRemoteProfile(this.userDataProfileService.currentProfile, this.remoteUserDataProfilesService);\n\t\tif (!remoteProfile.isDefault) {\n\t\t\tthis.setAssociatedRemoteProfiles([...this.getAssociatedRemoteProfiles(), remoteProfile.id]);\n\t\t}\n\n\t\tthis.cleanUp();\n\t}\n\n\tprivate async onDidChangeLocalProfiles(e: DidChangeProfilesEvent): Promise<void> {\n\t\tfor (const profile of e.removed) {\n\t\t\tconst remoteProfile = this.remoteUserDataProfilesService?.profiles.find(p => p.id === profile.id);\n\t\t\tif (remoteProfile) {\n\t\t\t\tawait this.remoteUserDataProfilesService?.removeProfile(remoteProfile);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync getRemoteProfiles(): Promise<readonly IUserDataProfile[]> {\n\t\tawait this.initPromise;\n\n\t\tif (!this.remoteUserDataProfilesService) {\n\t\t\tthrow new ErrorNoTelemetry('Remote profiles service not available in the current window');\n\t\t}\n\n\t\treturn this.remoteUserDataProfilesService.profiles;\n\t}\n\n\tasync getRemoteProfile(localProfile: IUserDataProfile): Promise<IUserDataProfile> {\n\t\tawait this.initPromise;\n\n\t\tif (!this.remoteUserDataProfilesService) {\n\t\t\tthrow new ErrorNoTelemetry('Remote profiles service not available in the current window');\n\t\t}\n\n\t\treturn this.getAssociatedRemoteProfile(localProfile, this.remoteUserDataProfilesService);\n\t}\n\n\tprivate async getAssociatedRemoteProfile(localProfile: IUserDataProfile, remoteUserDataProfilesService: IUserDataProfilesService): Promise<IUserDataProfile> {\n\t\t// If the local profile is the default profile, return the remote default profile\n\t\tif (localProfile.isDefault) {\n\t\t\treturn remoteUserDataProfilesService.defaultProfile;\n\t\t}\n\n\t\tlet profile = remoteUserDataProfilesService.profiles.find(p => p.id === localProfile.id);\n\t\tif (!profile) {\n\t\t\tprofile = await remoteUserDataProfilesService.createProfile(localProfile.id, localProfile.name, {\n\t\t\t\ttransient: localProfile.isTransient,\n\t\t\t\tuseDefaultFlags: localProfile.useDefaultFlags,\n\t\t\t});\n\t\t\tthis.setAssociatedRemoteProfiles([...this.getAssociatedRemoteProfiles(), this.userDataProfileService.currentProfile.id]);\n\t\t}\n\t\treturn profile;\n\t}\n\n\tprivate getAssociatedRemoteProfiles(): string[] {\n\t\tif (this.environmentService.remoteAuthority) {\n\t\t\tconst remotes = this.parseAssociatedRemoteProfiles();\n\t\t\treturn remotes[this.environmentService.remoteAuthority] ?? [];\n\t\t}\n\t\treturn [];\n\t}\n\n\tprivate setAssociatedRemoteProfiles(profiles: string[]): void {\n\t\tif (this.environmentService.remoteAuthority) {\n\t\t\tconst remotes = this.parseAssociatedRemoteProfiles();\n\t\t\tprofiles = distinct(profiles);\n\t\t\tif (profiles.length) {\n\t\t\t\tremotes[this.environmentService.remoteAuthority] = profiles;\n\t\t\t} else {\n\t\t\t\tdelete remotes[this.environmentService.remoteAuthority];\n\t\t\t}\n\t\t\tif (Object.keys(remotes).length) {\n\t\t\t\tthis.storageService.store(associatedRemoteProfilesKey, JSON.stringify(remotes), StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\t\t} else {\n\t\t\t\tthis.storageService.remove(associatedRemoteProfilesKey, StorageScope.APPLICATION);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate parseAssociatedRemoteProfiles(): IStringDictionary<string[]> {\n\t\tif (this.environmentService.remoteAuthority) {\n\t\t\tconst value = this.storageService.get(associatedRemoteProfilesKey, StorageScope.APPLICATION);\n\t\t\ttry {\n\t\t\t\treturn value ? JSON.parse(value) : {};\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t}\n\t\t}\n\t\treturn {};\n\t}\n\n\tprivate async cleanUp(): Promise<void> {\n\t\tconst associatedRemoteProfiles: string[] = [];\n\t\tfor (const profileId of this.getAssociatedRemoteProfiles()) {\n\t\t\tconst remoteProfile = this.remoteUserDataProfilesService?.profiles.find(p => p.id === profileId);\n\t\t\tif (!remoteProfile) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst localProfile = this.userDataProfilesService.profiles.find(p => p.id === profileId);\n\t\t\tif (localProfile) {\n\t\t\t\tif (localProfile.name !== remoteProfile.name) {\n\t\t\t\t\tawait this.remoteUserDataProfilesService?.updateProfile(remoteProfile, { name: localProfile.name });\n\t\t\t\t}\n\t\t\t\tassociatedRemoteProfiles.push(profileId);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (remoteProfile) {\n\t\t\t\t// Cleanup remote profiles those are not available locally\n\t\t\t\tawait this.remoteUserDataProfilesService?.removeProfile(remoteProfile);\n\t\t\t}\n\t\t}\n\t\tthis.setAssociatedRemoteProfiles(associatedRemoteProfiles);\n\t}\n\n}\n\nregisterSingleton(IRemoteUserDataProfilesService, RemoteUserDataProfilesService, InstantiationType.Delayed);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { DidChangeProfilesEvent, IUserDataProfile, IUserDataProfilesService } from '../../../../platform/userDataProfile/common/userDataProfile.js';\nimport { IRemoteAgentService } from '../../remote/common/remoteAgentService.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { IStringDictionary } from '../../../../base/common/collections.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IUserDataProfileService } from './userDataProfile.js';\nimport { distinct } from '../../../../base/common/arrays.js';\nimport { IWorkbenchEnvironmentService } from '../../environment/common/environmentService.js';\nimport { UserDataProfilesService } from '../../../../platform/userDataProfile/common/userDataProfileIpc.js';\nimport { ErrorNoTelemetry } from '../../../../base/common/errors.js';\n\nconst associatedRemoteProfilesKey = 'associatedRemoteProfiles';\n\nexport const IRemoteUserDataProfilesService = createDecorator<IRemoteUserDataProfilesService>('IRemoteUserDataProfilesService');\nexport interface IRemoteUserDataProfilesService {\n\treadonly _serviceBrand: undefined;\n\tgetRemoteProfiles(): Promise<readonly IUserDataProfile[]>;\n\tgetRemoteProfile(localProfile: IUserDataProfile): Promise<IUserDataProfile>;\n}\n\nclass RemoteUserDataProfilesService extends Disposable implements IRemoteUserDataProfilesService {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate readonly initPromise: Promise<void>;\n\n\tprivate remoteUserDataProfilesService: IUserDataProfilesService | undefined;\n\n\tconstructor(\n\t\t@IWorkbenchEnvironmentService private readonly environmentService: IWorkbenchEnvironmentService,\n\t\t@IRemoteAgentService private readonly remoteAgentService: IRemoteAgentService,\n\t\t@IUserDataProfilesService private readonly userDataProfilesService: IUserDataProfilesService,\n\t\t@IUserDataProfileService private readonly userDataProfileService: IUserDataProfileService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@ILogService private readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t\tthis.initPromise = this.init();\n\t}\n\n\tprivate async init(): Promise<void> {\n\t\tconst connection = this.remoteAgentService.getConnection();\n\t\tif (!connection) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst environment = await this.remoteAgentService.getEnvironment();\n\t\tif (!environment) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.remoteUserDataProfilesService = new UserDataProfilesService(environment.profiles.all, environment.profiles.home, connection.getChannel('userDataProfiles'));\n\t\tthis._register(this.userDataProfilesService.onDidChangeProfiles(e => this.onDidChangeLocalProfiles(e)));\n\n\t\t// Associate current local profile with remote profile\n\t\tconst remoteProfile = await this.getAssociatedRemoteProfile(this.userDataProfileService.currentProfile, this.remoteUserDataProfilesService);\n\t\tif (!remoteProfile.isDefault) {\n\t\t\tthis.setAssociatedRemoteProfiles([...this.getAssociatedRemoteProfiles(), remoteProfile.id]);\n\t\t}\n\n\t\tthis.cleanUp();\n\t}\n\n\tprivate async onDidChangeLocalProfiles(e: DidChangeProfilesEvent): Promise<void> {\n\t\tfor (const profile of e.removed) {\n\t\t\tconst remoteProfile = this.remoteUserDataProfilesService?.profiles.find(p => p.id === profile.id);\n\t\t\tif (remoteProfile) {\n\t\t\t\tawait this.remoteUserDataProfilesService?.removeProfile(remoteProfile);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync getRemoteProfiles(): Promise<readonly IUserDataProfile[]> {\n\t\tawait this.initPromise;\n\n\t\tif (!this.remoteUserDataProfilesService) {\n\t\t\tthrow new ErrorNoTelemetry('Remote profiles service not available in the current window');\n\t\t}\n\n\t\treturn this.remoteUserDataProfilesService.profiles;\n\t}\n\n\tasync getRemoteProfile(localProfile: IUserDataProfile): Promise<IUserDataProfile> {\n\t\tawait this.initPromise;\n\n\t\tif (!this.remoteUserDataProfilesService) {\n\t\t\tthrow new ErrorNoTelemetry('Remote profiles service not available in the current window');\n\t\t}\n\n\t\treturn this.getAssociatedRemoteProfile(localProfile, this.remoteUserDataProfilesService);\n\t}\n\n\tprivate async getAssociatedRemoteProfile(localProfile: IUserDataProfile, remoteUserDataProfilesService: IUserDataProfilesService): Promise<IUserDataProfile> {\n\t\t// If the local profile is the default profile, return the remote default profile\n\t\tif (localProfile.isDefault) {\n\t\t\treturn remoteUserDataProfilesService.defaultProfile;\n\t\t}\n\n\t\tlet profile = remoteUserDataProfilesService.profiles.find(p => p.id === localProfile.id);\n\t\tif (!profile) {\n\t\t\tprofile = await remoteUserDataProfilesService.createProfile(localProfile.id, localProfile.name, {\n\t\t\t\ttransient: localProfile.isTransient,\n\t\t\t\tuseDefaultFlags: localProfile.useDefaultFlags,\n\t\t\t});\n\t\t\tthis.setAssociatedRemoteProfiles([...this.getAssociatedRemoteProfiles(), this.userDataProfileService.currentProfile.id]);\n\t\t}\n\t\treturn profile;\n\t}\n\n\tprivate getAssociatedRemoteProfiles(): string[] {\n\t\tif (this.environmentService.remoteAuthority) {\n\t\t\tconst remotes = this.parseAssociatedRemoteProfiles();\n\t\t\treturn remotes[this.environmentService.remoteAuthority] ?? [];\n\t\t}\n\t\treturn [];\n\t}\n\n\tprivate setAssociatedRemoteProfiles(profiles: string[]): void {\n\t\tif (this.environmentService.remoteAuthority) {\n\t\t\tconst remotes = this.parseAssociatedRemoteProfiles();\n\t\t\tprofiles = distinct(profiles);\n\t\t\tif (profiles.length) {\n\t\t\t\tremotes[this.environmentService.remoteAuthority] = profiles;\n\t\t\t} else {\n\t\t\t\tdelete remotes[this.environmentService.remoteAuthority];\n\t\t\t}\n\t\t\tif (Object.keys(remotes).length) {\n\t\t\t\tthis.storageService.store(associatedRemoteProfilesKey, JSON.stringify(remotes), StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\t\t} else {\n\t\t\t\tthis.storageService.remove(associatedRemoteProfilesKey, StorageScope.APPLICATION);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate parseAssociatedRemoteProfiles(): IStringDictionary<string[]> {\n\t\tif (this.environmentService.remoteAuthority) {\n\t\t\tconst value = this.storageService.get(associatedRemoteProfilesKey, StorageScope.APPLICATION);\n\t\t\ttry {\n\t\t\t\treturn value ? JSON.parse(value) : {};\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t}\n\t\t}\n\t\treturn {};\n\t}\n\n\tprivate async cleanUp(): Promise<void> {\n\t\tconst associatedRemoteProfiles: string[] = [];\n\t\tfor (const profileId of this.getAssociatedRemoteProfiles()) {\n\t\t\tconst remoteProfile = this.remoteUserDataProfilesService?.profiles.find(p => p.id === profileId);\n\t\t\tif (!remoteProfile) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst localProfile = this.userDataProfilesService.profiles.find(p => p.id === profileId);\n\t\t\tif (localProfile) {\n\t\t\t\tif (localProfile.name !== remoteProfile.name) {\n\t\t\t\t\tawait this.remoteUserDataProfilesService?.updateProfile(remoteProfile, { name: localProfile.name });\n\t\t\t\t}\n\t\t\t\tassociatedRemoteProfiles.push(profileId);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (remoteProfile) {\n\t\t\t\t// Cleanup remote profiles those are not available locally\n\t\t\t\tawait this.remoteUserDataProfilesService?.removeProfile(remoteProfile);\n\t\t\t}\n\t\t}\n\t\tthis.setAssociatedRemoteProfiles(associatedRemoteProfiles);\n\t}\n\n}\n\nregisterSingleton(IRemoteUserDataProfilesService, RemoteUserDataProfilesService, InstantiationType.Delayed);\n"]}