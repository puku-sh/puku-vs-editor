{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/userDataProfile/browser/userDataProfileInit.ts","vs/workbench/services/userDataProfile/browser/userDataProfileInit.ts"],"names":[],"mappings":"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","file":"userDataProfileInit.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IStorageService, StorageScope } from '../../../../platform/storage/common/storage.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { Barrier, Promises } from '../../../../base/common/async.js';\nimport { IUriIdentityService } from '../../../../platform/uriIdentity/common/uriIdentity.js';\nimport { IUserDataInitializer } from '../../userData/browser/userDataInit.js';\nimport { IProfileResourceInitializer, IUserDataProfileService, IUserDataProfileTemplate } from '../common/userDataProfile.js';\nimport { SettingsResourceInitializer } from './settingsResource.js';\nimport { GlobalStateResourceInitializer } from './globalStateResource.js';\nimport { KeybindingsResourceInitializer } from './keybindingsResource.js';\nimport { TasksResourceInitializer } from './tasksResource.js';\nimport { SnippetsResourceInitializer } from './snippetsResource.js';\nimport { McpResourceInitializer } from './mcpProfileResource.js';\nimport { ExtensionsResourceInitializer } from './extensionsResource.js';\nimport { IBrowserWorkbenchEnvironmentService } from '../../environment/browser/environmentService.js';\nimport { isString } from '../../../../base/common/types.js';\nimport { IRequestService, asJson } from '../../../../platform/request/common/request.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { ProfileResourceType } from '../../../../platform/userDataProfile/common/userDataProfile.js';\n\nexport class UserDataProfileInitializer implements IUserDataInitializer {\n\n\t_serviceBrand: undefined;\n\n\tprivate readonly initialized: ProfileResourceType[] = [];\n\tprivate readonly initializationFinished = new Barrier();\n\n\tconstructor(\n\t\t@IBrowserWorkbenchEnvironmentService private readonly environmentService: IBrowserWorkbenchEnvironmentService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IUserDataProfileService private readonly userDataProfileService: IUserDataProfileService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IUriIdentityService private readonly uriIdentityService: IUriIdentityService,\n\t\t@IRequestService private readonly requestService: IRequestService,\n\t) {\n\t}\n\n\tasync whenInitializationFinished(): Promise<void> {\n\t\tawait this.initializationFinished.wait();\n\t}\n\n\tasync requiresInitialization(): Promise<boolean> {\n\t\tif (!this.environmentService.options?.profile?.contents) {\n\t\t\treturn false;\n\t\t}\n\t\tif (!this.storageService.isNew(StorageScope.PROFILE)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tasync initializeRequiredResources(): Promise<void> {\n\t\tthis.logService.trace(`UserDataProfileInitializer#initializeRequiredResources`);\n\t\tconst promises = [];\n\t\tconst profileTemplate = await this.getProfileTemplate();\n\t\tif (profileTemplate?.settings) {\n\t\t\tpromises.push(this.initialize(new SettingsResourceInitializer(this.userDataProfileService, this.fileService, this.logService), profileTemplate.settings, ProfileResourceType.Settings));\n\t\t}\n\t\tif (profileTemplate?.globalState) {\n\t\t\tpromises.push(this.initialize(new GlobalStateResourceInitializer(this.storageService), profileTemplate.globalState, ProfileResourceType.GlobalState));\n\t\t}\n\t\tawait Promise.all(promises);\n\t}\n\n\tasync initializeOtherResources(instantiationService: IInstantiationService): Promise<void> {\n\t\ttry {\n\t\t\tthis.logService.trace(`UserDataProfileInitializer#initializeOtherResources`);\n\t\t\tconst promises = [];\n\t\t\tconst profileTemplate = await this.getProfileTemplate();\n\t\t\tif (profileTemplate?.keybindings) {\n\t\t\t\tpromises.push(this.initialize(new KeybindingsResourceInitializer(this.userDataProfileService, this.fileService, this.logService), profileTemplate.keybindings, ProfileResourceType.Keybindings));\n\t\t\t}\n\t\t\tif (profileTemplate?.tasks) {\n\t\t\t\tpromises.push(this.initialize(new TasksResourceInitializer(this.userDataProfileService, this.fileService, this.logService), profileTemplate.tasks, ProfileResourceType.Tasks));\n\t\t\t}\n\t\t\tif (profileTemplate?.mcp) {\n\t\t\t\tpromises.push(this.initialize(new McpResourceInitializer(this.userDataProfileService, this.fileService, this.logService), profileTemplate.mcp, ProfileResourceType.Mcp));\n\t\t\t}\n\t\t\tif (profileTemplate?.snippets) {\n\t\t\t\tpromises.push(this.initialize(new SnippetsResourceInitializer(this.userDataProfileService, this.fileService, this.uriIdentityService), profileTemplate.snippets, ProfileResourceType.Snippets));\n\t\t\t}\n\t\t\tpromises.push(this.initializeInstalledExtensions(instantiationService));\n\t\t\tawait Promises.settled(promises);\n\t\t} finally {\n\t\t\tthis.initializationFinished.open();\n\t\t}\n\t}\n\n\tprivate initializeInstalledExtensionsPromise: Promise<void> | undefined;\n\tasync initializeInstalledExtensions(instantiationService: IInstantiationService): Promise<void> {\n\t\tif (!this.initializeInstalledExtensionsPromise) {\n\t\t\tconst profileTemplate = await this.getProfileTemplate();\n\t\t\tif (profileTemplate?.extensions) {\n\t\t\t\tthis.initializeInstalledExtensionsPromise = this.initialize(instantiationService.createInstance(ExtensionsResourceInitializer), profileTemplate.extensions, ProfileResourceType.Extensions);\n\t\t\t} else {\n\t\t\t\tthis.initializeInstalledExtensionsPromise = Promise.resolve();\n\t\t\t}\n\n\t\t}\n\t\treturn this.initializeInstalledExtensionsPromise;\n\t}\n\n\tprivate profileTemplatePromise: Promise<IUserDataProfileTemplate | null> | undefined;\n\tprivate getProfileTemplate(): Promise<IUserDataProfileTemplate | null> {\n\t\tif (!this.profileTemplatePromise) {\n\t\t\tthis.profileTemplatePromise = this.doGetProfileTemplate();\n\t\t}\n\t\treturn this.profileTemplatePromise;\n\t}\n\n\tprivate async doGetProfileTemplate(): Promise<IUserDataProfileTemplate | null> {\n\t\tif (!this.environmentService.options?.profile?.contents) {\n\t\t\treturn null;\n\t\t}\n\t\tif (isString(this.environmentService.options.profile.contents)) {\n\t\t\ttry {\n\t\t\t\treturn JSON.parse(this.environmentService.options.profile.contents);\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\t\ttry {\n\t\t\tconst url = URI.revive(this.environmentService.options.profile.contents).toString(true);\n\t\t\tconst context = await this.requestService.request({ type: 'GET', url }, CancellationToken.None);\n\t\t\tif (context.res.statusCode === 200) {\n\t\t\t\treturn await asJson(context);\n\t\t\t} else {\n\t\t\t\tthis.logService.warn(`UserDataProfileInitializer: Failed to get profile from URL: ${url}. Status code: ${context.res.statusCode}.`);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error(error);\n\t\t}\n\t\treturn null;\n\t}\n\n\tprivate async initialize(initializer: IProfileResourceInitializer, content: string, profileResource: ProfileResourceType): Promise<void> {\n\t\ttry {\n\t\t\tif (this.initialized.includes(profileResource)) {\n\t\t\t\tthis.logService.info(`UserDataProfileInitializer: ${profileResource} initialized already.`);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.initialized.push(profileResource);\n\t\t\tthis.logService.trace(`UserDataProfileInitializer: Initializing ${profileResource}`);\n\t\t\tawait initializer.initialize(content);\n\t\t\tthis.logService.info(`UserDataProfileInitializer: Initialized ${profileResource}`);\n\t\t} catch (error) {\n\t\t\tthis.logService.info(`UserDataProfileInitializer: Error while initializing ${profileResource}`);\n\t\t\tthis.logService.error(error);\n\t\t}\n\t}\n\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IStorageService, StorageScope } from '../../../../platform/storage/common/storage.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { Barrier, Promises } from '../../../../base/common/async.js';\nimport { IUriIdentityService } from '../../../../platform/uriIdentity/common/uriIdentity.js';\nimport { IUserDataInitializer } from '../../userData/browser/userDataInit.js';\nimport { IProfileResourceInitializer, IUserDataProfileService, IUserDataProfileTemplate } from '../common/userDataProfile.js';\nimport { SettingsResourceInitializer } from './settingsResource.js';\nimport { GlobalStateResourceInitializer } from './globalStateResource.js';\nimport { KeybindingsResourceInitializer } from './keybindingsResource.js';\nimport { TasksResourceInitializer } from './tasksResource.js';\nimport { SnippetsResourceInitializer } from './snippetsResource.js';\nimport { McpResourceInitializer } from './mcpProfileResource.js';\nimport { ExtensionsResourceInitializer } from './extensionsResource.js';\nimport { IBrowserWorkbenchEnvironmentService } from '../../environment/browser/environmentService.js';\nimport { isString } from '../../../../base/common/types.js';\nimport { IRequestService, asJson } from '../../../../platform/request/common/request.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { ProfileResourceType } from '../../../../platform/userDataProfile/common/userDataProfile.js';\n\nexport class UserDataProfileInitializer implements IUserDataInitializer {\n\n\t_serviceBrand: undefined;\n\n\tprivate readonly initialized: ProfileResourceType[] = [];\n\tprivate readonly initializationFinished = new Barrier();\n\n\tconstructor(\n\t\t@IBrowserWorkbenchEnvironmentService private readonly environmentService: IBrowserWorkbenchEnvironmentService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IUserDataProfileService private readonly userDataProfileService: IUserDataProfileService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IUriIdentityService private readonly uriIdentityService: IUriIdentityService,\n\t\t@IRequestService private readonly requestService: IRequestService,\n\t) {\n\t}\n\n\tasync whenInitializationFinished(): Promise<void> {\n\t\tawait this.initializationFinished.wait();\n\t}\n\n\tasync requiresInitialization(): Promise<boolean> {\n\t\tif (!this.environmentService.options?.profile?.contents) {\n\t\t\treturn false;\n\t\t}\n\t\tif (!this.storageService.isNew(StorageScope.PROFILE)) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tasync initializeRequiredResources(): Promise<void> {\n\t\tthis.logService.trace(`UserDataProfileInitializer#initializeRequiredResources`);\n\t\tconst promises = [];\n\t\tconst profileTemplate = await this.getProfileTemplate();\n\t\tif (profileTemplate?.settings) {\n\t\t\tpromises.push(this.initialize(new SettingsResourceInitializer(this.userDataProfileService, this.fileService, this.logService), profileTemplate.settings, ProfileResourceType.Settings));\n\t\t}\n\t\tif (profileTemplate?.globalState) {\n\t\t\tpromises.push(this.initialize(new GlobalStateResourceInitializer(this.storageService), profileTemplate.globalState, ProfileResourceType.GlobalState));\n\t\t}\n\t\tawait Promise.all(promises);\n\t}\n\n\tasync initializeOtherResources(instantiationService: IInstantiationService): Promise<void> {\n\t\ttry {\n\t\t\tthis.logService.trace(`UserDataProfileInitializer#initializeOtherResources`);\n\t\t\tconst promises = [];\n\t\t\tconst profileTemplate = await this.getProfileTemplate();\n\t\t\tif (profileTemplate?.keybindings) {\n\t\t\t\tpromises.push(this.initialize(new KeybindingsResourceInitializer(this.userDataProfileService, this.fileService, this.logService), profileTemplate.keybindings, ProfileResourceType.Keybindings));\n\t\t\t}\n\t\t\tif (profileTemplate?.tasks) {\n\t\t\t\tpromises.push(this.initialize(new TasksResourceInitializer(this.userDataProfileService, this.fileService, this.logService), profileTemplate.tasks, ProfileResourceType.Tasks));\n\t\t\t}\n\t\t\tif (profileTemplate?.mcp) {\n\t\t\t\tpromises.push(this.initialize(new McpResourceInitializer(this.userDataProfileService, this.fileService, this.logService), profileTemplate.mcp, ProfileResourceType.Mcp));\n\t\t\t}\n\t\t\tif (profileTemplate?.snippets) {\n\t\t\t\tpromises.push(this.initialize(new SnippetsResourceInitializer(this.userDataProfileService, this.fileService, this.uriIdentityService), profileTemplate.snippets, ProfileResourceType.Snippets));\n\t\t\t}\n\t\t\tpromises.push(this.initializeInstalledExtensions(instantiationService));\n\t\t\tawait Promises.settled(promises);\n\t\t} finally {\n\t\t\tthis.initializationFinished.open();\n\t\t}\n\t}\n\n\tprivate initializeInstalledExtensionsPromise: Promise<void> | undefined;\n\tasync initializeInstalledExtensions(instantiationService: IInstantiationService): Promise<void> {\n\t\tif (!this.initializeInstalledExtensionsPromise) {\n\t\t\tconst profileTemplate = await this.getProfileTemplate();\n\t\t\tif (profileTemplate?.extensions) {\n\t\t\t\tthis.initializeInstalledExtensionsPromise = this.initialize(instantiationService.createInstance(ExtensionsResourceInitializer), profileTemplate.extensions, ProfileResourceType.Extensions);\n\t\t\t} else {\n\t\t\t\tthis.initializeInstalledExtensionsPromise = Promise.resolve();\n\t\t\t}\n\n\t\t}\n\t\treturn this.initializeInstalledExtensionsPromise;\n\t}\n\n\tprivate profileTemplatePromise: Promise<IUserDataProfileTemplate | null> | undefined;\n\tprivate getProfileTemplate(): Promise<IUserDataProfileTemplate | null> {\n\t\tif (!this.profileTemplatePromise) {\n\t\t\tthis.profileTemplatePromise = this.doGetProfileTemplate();\n\t\t}\n\t\treturn this.profileTemplatePromise;\n\t}\n\n\tprivate async doGetProfileTemplate(): Promise<IUserDataProfileTemplate | null> {\n\t\tif (!this.environmentService.options?.profile?.contents) {\n\t\t\treturn null;\n\t\t}\n\t\tif (isString(this.environmentService.options.profile.contents)) {\n\t\t\ttry {\n\t\t\t\treturn JSON.parse(this.environmentService.options.profile.contents);\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\t\ttry {\n\t\t\tconst url = URI.revive(this.environmentService.options.profile.contents).toString(true);\n\t\t\tconst context = await this.requestService.request({ type: 'GET', url }, CancellationToken.None);\n\t\t\tif (context.res.statusCode === 200) {\n\t\t\t\treturn await asJson(context);\n\t\t\t} else {\n\t\t\t\tthis.logService.warn(`UserDataProfileInitializer: Failed to get profile from URL: ${url}. Status code: ${context.res.statusCode}.`);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error(error);\n\t\t}\n\t\treturn null;\n\t}\n\n\tprivate async initialize(initializer: IProfileResourceInitializer, content: string, profileResource: ProfileResourceType): Promise<void> {\n\t\ttry {\n\t\t\tif (this.initialized.includes(profileResource)) {\n\t\t\t\tthis.logService.info(`UserDataProfileInitializer: ${profileResource} initialized already.`);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.initialized.push(profileResource);\n\t\t\tthis.logService.trace(`UserDataProfileInitializer: Initializing ${profileResource}`);\n\t\t\tawait initializer.initialize(content);\n\t\t\tthis.logService.info(`UserDataProfileInitializer: Initialized ${profileResource}`);\n\t\t} catch (error) {\n\t\t\tthis.logService.info(`UserDataProfileInitializer: Error while initializing ${profileResource}`);\n\t\t\tthis.logService.error(error);\n\t\t}\n\t}\n\n}\n"]}