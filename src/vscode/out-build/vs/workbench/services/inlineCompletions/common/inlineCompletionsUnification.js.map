{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/inlineCompletions/common/inlineCompletionsUnification.ts","vs/workbench/services/inlineCompletions/common/inlineCompletionsUnification.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;AAEhG,OAAO,EAAE,MAAM,EAAE,MAAM,mCAAmC,CAAC;AAC3D,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,MAAM,kCAAkC,CAAC;AAClE,OAAO,EAAE,UAAU,EAAE,MAAM,sCAAsC,CAAC;AAClE,OAAO,EAAE,qBAAqB,EAAE,MAAM,4DAA4D,CAAC;AACnG,OAAO,EAAE,kBAAkB,EAAE,aAAa,EAAE,MAAM,sDAAsD,CAAC;AACzG,OAAO,EAAE,2BAA2B,EAAE,MAAM,wEAAwE,CAAC;AAErH,OAAO,EAAqB,iBAAiB,EAAE,MAAM,yDAAyD,CAAC;AAC/G,OAAO,EAAE,eAAe,EAAE,MAAM,4DAA4D,CAAC;AAC7F,OAAO,EAAE,eAAe,EAAE,MAAM,uDAAuD,CAAC;AACxF,OAAO,EAAE,2BAA2B,EAAE,MAAM,8CAA8C,CAAC;AAC3F,OAAO,EAAmB,oCAAoC,EAAE,MAAM,yDAAyD,CAAC;AAChI,OAAO,EAAE,iBAAiB,EAAE,MAAM,uCAAuC,CAAC;AAE1E,MAAM,CAAC,MAAM,oCAAoC,GAAG,eAAe,CAAuC,qCAAqC,CAAC,CAAC;AAgBjJ,MAAM,uBAAuB,GAAG,UAAU,CAAC;AAC3C,MAAM,4BAA4B,GAAG,UAAU,CAAC;AAChD,MAAM,mBAAmB,GAAG,kCAAkC,CAAC;AAC/D,MAAM,oBAAoB,GAAG,mCAAmC,CAAC;AAEjE,MAAM,CAAC,MAAM,8BAA8B,GAAG,IAAI,aAAa,CAAU,gCAAgC,EAAE,KAAK,CAAC,CAAC;AAElH,MAAM,2BAA2B,GAAG,mCAAmC,CAAC;AAEjE,IAAM,gCAAgC,GAAtC,MAAM,gCAAiC,SAAQ,UAAU;IAI/D,IAAW,KAAK,KAAyC,OAAO,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;IAa9E,YAC8B,kBAAgE,EACzE,kBAAuD,EACpD,qBAA6D,EAC9C,2BAAkF,EAC3F,2BAAyE,EACnF,iBAAqD,EACvD,cAA+B;QAEhD,KAAK,EAAE,CAAC;QARsC,uBAAkB,GAAlB,kBAAkB,CAA6B;QACxD,uBAAkB,GAAlB,kBAAkB,CAAoB;QACnC,0BAAqB,GAArB,qBAAqB,CAAuB;QAC7B,gCAA2B,GAA3B,2BAA2B,CAAsC;QAC1E,gCAA2B,GAA3B,2BAA2B,CAA6B;QAClE,sBAAiB,GAAjB,iBAAiB,CAAmB;QApBjE,WAAM,GAAG,IAAI,iCAAiC,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC;QAK/D,sBAAiB,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,OAAO,EAAQ,CAAC,CAAC;QACzD,qBAAgB,GAAG,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC;QAE/C,0CAAqC,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,OAAO,EAAQ,CAAC,CAAC;QAC5E,4CAAuC,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,OAAO,EAAQ,CAAC,CAAC;QAe9F,IAAI,CAAC,uBAAuB,GAAG,cAAc,CAAC,gBAAgB,EAAE,WAAW,CAAC,WAAW,EAAE,CAAC;QAC1F,IAAI,CAAC,gBAAgB,GAAG,cAAc,CAAC,gBAAgB,EAAE,eAAe,CAAC,WAAW,EAAE,CAAC;QACvF,MAAM,kBAAkB,GAAG,CAAC,IAAI,CAAC,uBAAuB,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAC,MAAM,CAAC,CAAC,EAAE,EAAgB,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;QAEpH,IAAI,CAAC,8BAA8B,GAAG,8BAA8B,CAAC,MAAM,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;QAErG,IAAI,CAAC,kBAAkB,CAAC,4BAA4B,CAAC;YACpD,OAAO,EAAE,CAAC,UAAU,EAAE,EAAE,CAAC,UAAU,CAAC,UAAU,CAAC,4BAA4B,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,oBAAoB,KAAK,IAAI,CAAC,qBAAqB,CAAC,QAAQ,CAAU,2BAA2B,CAAC;YAC9L,WAAW,EAAE,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,qCAAqC,CAAC,KAAK,EAAE,IAAI,CAAC,uCAAuC,CAAC,KAAK,CAAC;SAC5H,CAAC,CAAC;QAEH,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,2BAA2B,CAAC,mBAAmB,CAAC,CAAC,UAAU,EAAE,EAAE;YAClF,IAAI,UAAU,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,kBAAkB,CAAC,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC,WAAW,EAAE,CAAC,CAAC,EAAE,CAAC;gBAC1F,IAAI,CAAC,OAAO,EAAE,CAAC;YAChB,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;QACJ,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,qBAAqB,CAAC,wBAAwB,CAAC,CAAC,CAAC,EAAE;YACtE,IAAI,CAAC,CAAC,oBAAoB,CAAC,2BAA2B,CAAC,EAAE,CAAC;gBACzD,IAAI,CAAC,OAAO,EAAE,CAAC;gBACf,IAAI,CAAC,uCAAuC,CAAC,IAAI,EAAE,CAAC;YACrD,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;QACJ,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,iBAAiB,CAAC,qBAAqB,CAAC,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE;YACzE,IAAI,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,kBAAkB,CAAC,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,KAAK,CAAC,WAAW,EAAE,CAAC,CAAC,EAAE,CAAC;gBACxF,IAAI,CAAC,OAAO,EAAE,CAAC;YAChB,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;QACJ,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,kBAAkB,CAAC,uBAAuB,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;QACtF,IAAI,CAAC,OAAO,EAAE,CAAC;IAChB,CAAC;IAEO,KAAK,CAAC,OAAO;QACpB,MAAM,CAAC,iBAAiB,EAAE,kBAAkB,EAAE,2BAA2B,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;YAC9F,IAAI,CAAC,kBAAkB,CAAC,YAAY,CAAU,mBAAmB,CAAC;YAClE,IAAI,CAAC,kBAAkB,CAAC,YAAY,CAAU,oBAAoB,CAAC;YACnE,IAAI,CAAC,6BAA6B,EAAE;SACpC,CAAC,CAAC;QAEH,MAAM,sCAAsC,GAAG,IAAI,CAAC,qBAAqB,CAAC,QAAQ,CAAU,2BAA2B,CAAC,KAAK,2BAA2B,CAAC;QAEzJ,2EAA2E;QAC3E,MAAM,kBAAkB,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,qBAAqB,EAAE,CAAC;QACjF,MAAM,QAAQ,GAAG,IAAI,iCAAiC,CACrD,iBAAiB,KAAK,IAAI,EAC1B,kBAAkB,KAAK,IAAI,EAC3B,2BAA2B,EAC3B,kBAAkB,EAAE,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,UAAU,CAAC,uBAAuB,CAAC,IAAI,CAAC,sCAAsC,IAAI,GAAG,CAAC,UAAU,CAAC,4BAA4B,CAAC,CAAC,CAAC,IAAI,EAAE,CAC5K,CAAC;QACF,IAAI,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC;YAClC,OAAO;QACR,CAAC;QAED,MAAM,aAAa,GAAG,IAAI,CAAC,MAAM,CAAC;QAClC,IAAI,CAAC,MAAM,GAAG,QAAQ,CAAC;QACvB,IAAI,CAAC,8BAA8B,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,eAAe,IAAI,IAAI,CAAC,MAAM,CAAC,gBAAgB,IAAI,IAAI,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC;QACzI,IAAI,CAAC,iBAAiB,CAAC,IAAI,EAAE,CAAC;QAE9B,IAAI,aAAa,CAAC,oBAAoB,KAAK,IAAI,CAAC,MAAM,CAAC,oBAAoB,EAAE,CAAC;YAC7E,IAAI,CAAC,qCAAqC,CAAC,IAAI,EAAE,CAAC;QACnD,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,6BAA6B;QAC1C,IAAI,CAAC,IAAI,CAAC,qBAAqB,CAAC,QAAQ,CAAU,2BAA2B,CAAC,EAAE,CAAC;YAChF,OAAO,KAAK,CAAC;QACd,CAAC;QAED,IAAI,CAAC,IAAI,CAAC,uBAAuB,IAAI,CAAC,IAAI,CAAC,gBAAgB,EAAE,CAAC;YAC7D,OAAO,KAAK,CAAC;QACd,CAAC;QAED,MAAM,CAAC,oBAAoB,EAAE,aAAa,EAAE,mBAAmB,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;YACpF,IAAI,CAAC,iBAAiB,CAAC,YAAY,CAAC,IAAI,CAAC,uBAAuB,CAAC;YACjE,IAAI,CAAC,iBAAiB,CAAC,YAAY,CAAC,IAAI,CAAC,gBAAgB,CAAC;YAC1D,IAAI,CAAC,2BAA2B,CAAC,YAAY,4BAAoB;SACjE,CAAC,CAAC;QAEH,IAAI,CAAC,aAAa,IAAI,oBAAoB,EAAE,CAAC;YAC5C,OAAO,KAAK,CAAC;QACd,CAAC;QAED,mDAAmD;QACnD,MAAM,4BAA4B,GAAG,mBAAmB,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC,WAAW,EAAE,KAAK,IAAI,CAAC,uBAAuB,CAAC,CAAC;QACzI,IAAI,4BAA4B,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAC/C,OAAO,KAAK,CAAC;QACd,CAAC;QAED,MAAM,yCAAyC,GAAG,4BAA4B,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,2BAA2B,CAAC,kBAAkB,CAAC,GAAG,CAAC,kDAA0C,CAAC,CAAC;QAE/L,OAAO,CAAC,CAAC,aAAa,IAAI,yCAAyC,CAAC;IACrE,CAAC;CACD,CAAA;AAtHY,gCAAgC;IAkB1C,WAAA,2BAA2B,CAAA;IAC3B,WAAA,kBAAkB,CAAA;IAClB,WAAA,qBAAqB,CAAA;IACrB,WAAA,oCAAoC,CAAA;IACpC,WAAA,2BAA2B,CAAA;IAC3B,WAAA,iBAAiB,CAAA;IACjB,WAAA,eAAe,CAAA;GAxBL,gCAAgC,CAsH5C;;AAED,MAAM,iCAAiC;IACtC,YACiB,eAAwB,EACxB,gBAAyB,EACzB,oBAA6B,EAC7B,cAAwB;QAHxB,oBAAe,GAAf,eAAe,CAAS;QACxB,qBAAgB,GAAhB,gBAAgB,CAAS;QACzB,yBAAoB,GAApB,oBAAoB,CAAS;QAC7B,mBAAc,GAAd,cAAc,CAAU;IAEzC,CAAC;IAED,MAAM,CAAC,KAAyC;QAC/C,OAAO,IAAI,CAAC,eAAe,KAAK,KAAK,CAAC,eAAe;eACjD,IAAI,CAAC,gBAAgB,KAAK,KAAK,CAAC,gBAAgB;eAChD,IAAI,CAAC,oBAAoB,KAAK,KAAK,CAAC,oBAAoB;eACxD,MAAM,CAAC,IAAI,CAAC,cAAc,EAAE,KAAK,CAAC,cAAc,CAAC,CAAC;IACvD,CAAC;CACD;AAED,iBAAiB,CAAC,oCAAoC,EAAE,gCAAgC,oCAA4B,CAAC","file":"inlineCompletionsUnification.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { equals } from '../../../../base/common/arrays.js';\nimport { Event, Emitter } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IContextKeyService, RawContextKey } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IExtensionManagementService } from '../../../../platform/extensionManagement/common/extensionManagement.js';\nimport { ExtensionType } from '../../../../platform/extensions/common/extensions.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { IWorkbenchAssignmentService } from '../../assignment/common/assignmentService.js';\nimport { EnablementState, IWorkbenchExtensionEnablementService } from '../../extensionManagement/common/extensionManagement.js';\nimport { IExtensionService } from '../../extensions/common/extensions.js';\n\nexport const IInlineCompletionsUnificationService = createDecorator<IInlineCompletionsUnificationService>('inlineCompletionsUnificationService');\n\nexport interface IInlineCompletionsUnificationState {\n\tcodeUnification: boolean;\n\tmodelUnification: boolean;\n\textensionUnification: boolean;\n\texpAssignments: string[];\n}\n\nexport interface IInlineCompletionsUnificationService {\n\treadonly _serviceBrand: undefined;\n\n\treadonly state: IInlineCompletionsUnificationState;\n\treadonly onDidStateChange: Event<void>;\n}\n\nconst CODE_UNIFICATION_PREFIX = 'cmp-cht-';\nconst EXTENSION_UNIFICATION_PREFIX = 'cmp-ext-';\nconst CODE_UNIFICATION_FF = 'inlineCompletionsUnificationCode';\nconst MODEL_UNIFICATION_FF = 'inlineCompletionsUnificationModel';\n\nexport const isRunningUnificationExperiment = new RawContextKey<boolean>('isRunningUnificationExperiment', false);\n\nconst ExtensionUnificationSetting = 'chat.extensionUnification.enabled';\n\nexport class InlineCompletionsUnificationImpl extends Disposable implements IInlineCompletionsUnificationService {\n\treadonly _serviceBrand: undefined;\n\n\tprivate _state = new InlineCompletionsUnificationState(false, false, false, []);\n\tpublic get state(): IInlineCompletionsUnificationState { return this._state; }\n\n\tprivate isRunningUnificationExperiment;\n\n\tprivate readonly _onDidStateChange = this._register(new Emitter<void>());\n\tpublic readonly onDidStateChange = this._onDidStateChange.event;\n\n\tprivate readonly _onDidChangeExtensionUnificationState = this._register(new Emitter<void>());\n\tprivate readonly _onDidChangeExtensionUnificationSetting = this._register(new Emitter<void>());\n\n\tprivate readonly _completionsExtensionId: string | undefined;\n\tprivate readonly _chatExtensionId: string | undefined;\n\n\tconstructor(\n\t\t@IWorkbenchAssignmentService private readonly _assignmentService: IWorkbenchAssignmentService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IWorkbenchExtensionEnablementService private readonly _extensionEnablementService: IWorkbenchExtensionEnablementService,\n\t\t@IExtensionManagementService private readonly _extensionManagementService: IExtensionManagementService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@IProductService productService: IProductService\n\t) {\n\t\tsuper();\n\t\tthis._completionsExtensionId = productService.defaultChatAgent?.extensionId.toLowerCase();\n\t\tthis._chatExtensionId = productService.defaultChatAgent?.chatExtensionId.toLowerCase();\n\t\tconst relevantExtensions = [this._completionsExtensionId, this._chatExtensionId].filter((id): id is string => !!id);\n\n\t\tthis.isRunningUnificationExperiment = isRunningUnificationExperiment.bindTo(this._contextKeyService);\n\n\t\tthis._assignmentService.addTelemetryAssignmentFilter({\n\t\t\texclude: (assignment) => assignment.startsWith(EXTENSION_UNIFICATION_PREFIX) && this._state.extensionUnification !== this._configurationService.getValue<boolean>(ExtensionUnificationSetting),\n\t\t\tonDidChange: Event.any(this._onDidChangeExtensionUnificationState.event, this._onDidChangeExtensionUnificationSetting.event)\n\t\t});\n\n\t\tthis._register(this._extensionEnablementService.onEnablementChanged((extensions) => {\n\t\t\tif (extensions.some(ext => relevantExtensions.includes(ext.identifier.id.toLowerCase()))) {\n\t\t\t\tthis._update();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._configurationService.onDidChangeConfiguration(e => {\n\t\t\tif (e.affectsConfiguration(ExtensionUnificationSetting)) {\n\t\t\t\tthis._update();\n\t\t\t\tthis._onDidChangeExtensionUnificationSetting.fire();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._extensionService.onDidChangeExtensions(({ added }) => {\n\t\t\tif (added.some(ext => relevantExtensions.includes(ext.identifier.value.toLowerCase()))) {\n\t\t\t\tthis._update();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._assignmentService.onDidRefetchAssignments(() => this._update()));\n\t\tthis._update();\n\t}\n\n\tprivate async _update(): Promise<void> {\n\t\tconst [codeUnificationFF, modelUnificationFF, extensionUnificationEnabled] = await Promise.all([\n\t\t\tthis._assignmentService.getTreatment<boolean>(CODE_UNIFICATION_FF),\n\t\t\tthis._assignmentService.getTreatment<boolean>(MODEL_UNIFICATION_FF),\n\t\t\tthis._isExtensionUnificationActive()\n\t\t]);\n\n\t\tconst extensionStatesMatchUnificationSetting = this._configurationService.getValue<boolean>(ExtensionUnificationSetting) === extensionUnificationEnabled;\n\n\t\t// Intentionally read the current experiments after fetching the treatments\n\t\tconst currentExperiments = await this._assignmentService.getCurrentExperiments();\n\t\tconst newState = new InlineCompletionsUnificationState(\n\t\t\tcodeUnificationFF === true,\n\t\t\tmodelUnificationFF === true,\n\t\t\textensionUnificationEnabled,\n\t\t\tcurrentExperiments?.filter(exp => exp.startsWith(CODE_UNIFICATION_PREFIX) || (extensionStatesMatchUnificationSetting && exp.startsWith(EXTENSION_UNIFICATION_PREFIX))) ?? []\n\t\t);\n\t\tif (this._state.equals(newState)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst previousState = this._state;\n\t\tthis._state = newState;\n\t\tthis.isRunningUnificationExperiment.set(this._state.codeUnification || this._state.modelUnification || this._state.extensionUnification);\n\t\tthis._onDidStateChange.fire();\n\n\t\tif (previousState.extensionUnification !== this._state.extensionUnification) {\n\t\t\tthis._onDidChangeExtensionUnificationState.fire();\n\t\t}\n\t}\n\n\tprivate async _isExtensionUnificationActive(): Promise<boolean> {\n\t\tif (!this._configurationService.getValue<boolean>(ExtensionUnificationSetting)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this._completionsExtensionId || !this._chatExtensionId) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst [completionsExtension, chatExtension, installedExtensions] = await Promise.all([\n\t\t\tthis._extensionService.getExtension(this._completionsExtensionId),\n\t\t\tthis._extensionService.getExtension(this._chatExtensionId),\n\t\t\tthis._extensionManagementService.getInstalled(ExtensionType.User)\n\t\t]);\n\n\t\tif (!chatExtension || completionsExtension) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Extension might be installed on remote and local\n\t\tconst completionExtensionInstalled = installedExtensions.filter(ext => ext.identifier.id.toLowerCase() === this._completionsExtensionId);\n\t\tif (completionExtensionInstalled.length === 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst completionsExtensionDisabledByUnification = completionExtensionInstalled.some(ext => this._extensionEnablementService.getEnablementState(ext) === EnablementState.DisabledByUnification);\n\n\t\treturn !!chatExtension && completionsExtensionDisabledByUnification;\n\t}\n}\n\nclass InlineCompletionsUnificationState implements IInlineCompletionsUnificationState {\n\tconstructor(\n\t\tpublic readonly codeUnification: boolean,\n\t\tpublic readonly modelUnification: boolean,\n\t\tpublic readonly extensionUnification: boolean,\n\t\tpublic readonly expAssignments: string[]\n\t) {\n\t}\n\n\tequals(other: IInlineCompletionsUnificationState): boolean {\n\t\treturn this.codeUnification === other.codeUnification\n\t\t\t&& this.modelUnification === other.modelUnification\n\t\t\t&& this.extensionUnification === other.extensionUnification\n\t\t\t&& equals(this.expAssignments, other.expAssignments);\n\t}\n}\n\nregisterSingleton(IInlineCompletionsUnificationService, InlineCompletionsUnificationImpl, InstantiationType.Delayed);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { equals } from '../../../../base/common/arrays.js';\nimport { Event, Emitter } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IContextKeyService, RawContextKey } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IExtensionManagementService } from '../../../../platform/extensionManagement/common/extensionManagement.js';\nimport { ExtensionType } from '../../../../platform/extensions/common/extensions.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { IWorkbenchAssignmentService } from '../../assignment/common/assignmentService.js';\nimport { EnablementState, IWorkbenchExtensionEnablementService } from '../../extensionManagement/common/extensionManagement.js';\nimport { IExtensionService } from '../../extensions/common/extensions.js';\n\nexport const IInlineCompletionsUnificationService = createDecorator<IInlineCompletionsUnificationService>('inlineCompletionsUnificationService');\n\nexport interface IInlineCompletionsUnificationState {\n\tcodeUnification: boolean;\n\tmodelUnification: boolean;\n\textensionUnification: boolean;\n\texpAssignments: string[];\n}\n\nexport interface IInlineCompletionsUnificationService {\n\treadonly _serviceBrand: undefined;\n\n\treadonly state: IInlineCompletionsUnificationState;\n\treadonly onDidStateChange: Event<void>;\n}\n\nconst CODE_UNIFICATION_PREFIX = 'cmp-cht-';\nconst EXTENSION_UNIFICATION_PREFIX = 'cmp-ext-';\nconst CODE_UNIFICATION_FF = 'inlineCompletionsUnificationCode';\nconst MODEL_UNIFICATION_FF = 'inlineCompletionsUnificationModel';\n\nexport const isRunningUnificationExperiment = new RawContextKey<boolean>('isRunningUnificationExperiment', false);\n\nconst ExtensionUnificationSetting = 'chat.extensionUnification.enabled';\n\nexport class InlineCompletionsUnificationImpl extends Disposable implements IInlineCompletionsUnificationService {\n\treadonly _serviceBrand: undefined;\n\n\tprivate _state = new InlineCompletionsUnificationState(false, false, false, []);\n\tpublic get state(): IInlineCompletionsUnificationState { return this._state; }\n\n\tprivate isRunningUnificationExperiment;\n\n\tprivate readonly _onDidStateChange = this._register(new Emitter<void>());\n\tpublic readonly onDidStateChange = this._onDidStateChange.event;\n\n\tprivate readonly _onDidChangeExtensionUnificationState = this._register(new Emitter<void>());\n\tprivate readonly _onDidChangeExtensionUnificationSetting = this._register(new Emitter<void>());\n\n\tprivate readonly _completionsExtensionId: string | undefined;\n\tprivate readonly _chatExtensionId: string | undefined;\n\n\tconstructor(\n\t\t@IWorkbenchAssignmentService private readonly _assignmentService: IWorkbenchAssignmentService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IWorkbenchExtensionEnablementService private readonly _extensionEnablementService: IWorkbenchExtensionEnablementService,\n\t\t@IExtensionManagementService private readonly _extensionManagementService: IExtensionManagementService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@IProductService productService: IProductService\n\t) {\n\t\tsuper();\n\t\tthis._completionsExtensionId = productService.defaultChatAgent?.extensionId.toLowerCase();\n\t\tthis._chatExtensionId = productService.defaultChatAgent?.chatExtensionId.toLowerCase();\n\t\tconst relevantExtensions = [this._completionsExtensionId, this._chatExtensionId].filter((id): id is string => !!id);\n\n\t\tthis.isRunningUnificationExperiment = isRunningUnificationExperiment.bindTo(this._contextKeyService);\n\n\t\tthis._assignmentService.addTelemetryAssignmentFilter({\n\t\t\texclude: (assignment) => assignment.startsWith(EXTENSION_UNIFICATION_PREFIX) && this._state.extensionUnification !== this._configurationService.getValue<boolean>(ExtensionUnificationSetting),\n\t\t\tonDidChange: Event.any(this._onDidChangeExtensionUnificationState.event, this._onDidChangeExtensionUnificationSetting.event)\n\t\t});\n\n\t\tthis._register(this._extensionEnablementService.onEnablementChanged((extensions) => {\n\t\t\tif (extensions.some(ext => relevantExtensions.includes(ext.identifier.id.toLowerCase()))) {\n\t\t\t\tthis._update();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._configurationService.onDidChangeConfiguration(e => {\n\t\t\tif (e.affectsConfiguration(ExtensionUnificationSetting)) {\n\t\t\t\tthis._update();\n\t\t\t\tthis._onDidChangeExtensionUnificationSetting.fire();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._extensionService.onDidChangeExtensions(({ added }) => {\n\t\t\tif (added.some(ext => relevantExtensions.includes(ext.identifier.value.toLowerCase()))) {\n\t\t\t\tthis._update();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._assignmentService.onDidRefetchAssignments(() => this._update()));\n\t\tthis._update();\n\t}\n\n\tprivate async _update(): Promise<void> {\n\t\tconst [codeUnificationFF, modelUnificationFF, extensionUnificationEnabled] = await Promise.all([\n\t\t\tthis._assignmentService.getTreatment<boolean>(CODE_UNIFICATION_FF),\n\t\t\tthis._assignmentService.getTreatment<boolean>(MODEL_UNIFICATION_FF),\n\t\t\tthis._isExtensionUnificationActive()\n\t\t]);\n\n\t\tconst extensionStatesMatchUnificationSetting = this._configurationService.getValue<boolean>(ExtensionUnificationSetting) === extensionUnificationEnabled;\n\n\t\t// Intentionally read the current experiments after fetching the treatments\n\t\tconst currentExperiments = await this._assignmentService.getCurrentExperiments();\n\t\tconst newState = new InlineCompletionsUnificationState(\n\t\t\tcodeUnificationFF === true,\n\t\t\tmodelUnificationFF === true,\n\t\t\textensionUnificationEnabled,\n\t\t\tcurrentExperiments?.filter(exp => exp.startsWith(CODE_UNIFICATION_PREFIX) || (extensionStatesMatchUnificationSetting && exp.startsWith(EXTENSION_UNIFICATION_PREFIX))) ?? []\n\t\t);\n\t\tif (this._state.equals(newState)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst previousState = this._state;\n\t\tthis._state = newState;\n\t\tthis.isRunningUnificationExperiment.set(this._state.codeUnification || this._state.modelUnification || this._state.extensionUnification);\n\t\tthis._onDidStateChange.fire();\n\n\t\tif (previousState.extensionUnification !== this._state.extensionUnification) {\n\t\t\tthis._onDidChangeExtensionUnificationState.fire();\n\t\t}\n\t}\n\n\tprivate async _isExtensionUnificationActive(): Promise<boolean> {\n\t\tif (!this._configurationService.getValue<boolean>(ExtensionUnificationSetting)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this._completionsExtensionId || !this._chatExtensionId) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst [completionsExtension, chatExtension, installedExtensions] = await Promise.all([\n\t\t\tthis._extensionService.getExtension(this._completionsExtensionId),\n\t\t\tthis._extensionService.getExtension(this._chatExtensionId),\n\t\t\tthis._extensionManagementService.getInstalled(ExtensionType.User)\n\t\t]);\n\n\t\tif (!chatExtension || completionsExtension) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Extension might be installed on remote and local\n\t\tconst completionExtensionInstalled = installedExtensions.filter(ext => ext.identifier.id.toLowerCase() === this._completionsExtensionId);\n\t\tif (completionExtensionInstalled.length === 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst completionsExtensionDisabledByUnification = completionExtensionInstalled.some(ext => this._extensionEnablementService.getEnablementState(ext) === EnablementState.DisabledByUnification);\n\n\t\treturn !!chatExtension && completionsExtensionDisabledByUnification;\n\t}\n}\n\nclass InlineCompletionsUnificationState implements IInlineCompletionsUnificationState {\n\tconstructor(\n\t\tpublic readonly codeUnification: boolean,\n\t\tpublic readonly modelUnification: boolean,\n\t\tpublic readonly extensionUnification: boolean,\n\t\tpublic readonly expAssignments: string[]\n\t) {\n\t}\n\n\tequals(other: IInlineCompletionsUnificationState): boolean {\n\t\treturn this.codeUnification === other.codeUnification\n\t\t\t&& this.modelUnification === other.modelUnification\n\t\t\t&& this.extensionUnification === other.extensionUnification\n\t\t\t&& equals(this.expAssignments, other.expAssignments);\n\t}\n}\n\nregisterSingleton(IInlineCompletionsUnificationService, InlineCompletionsUnificationImpl, InstantiationType.Delayed);\n"]}