{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/languageDetection/browser/languageDetectionWebWorker.ts","vs/workbench/services/languageDetection/browser/languageDetectionWebWorker.ts"],"names":[],"mappings":"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","file":"languageDetectionWebWorker.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { ModelOperations, ModelResult } from '@vscode/vscode-languagedetection';\nimport { importAMDNodeModule } from '../../../../amdX.js';\nimport { StopWatch } from '../../../../base/common/stopwatch.js';\nimport { IWebWorkerServerRequestHandler, IWebWorkerServer } from '../../../../base/common/worker/webWorker.js';\nimport { LanguageDetectionWorkerHost, ILanguageDetectionWorker } from './languageDetectionWorker.protocol.js';\nimport { WorkerTextModelSyncServer } from '../../../../editor/common/services/textModelSync/textModelSync.impl.js';\n\ntype RegexpModel = { detect: (inp: string, langBiases: Record<string, number>, supportedLangs?: string[]) => string | undefined };\n\nexport function create(workerServer: IWebWorkerServer): IWebWorkerServerRequestHandler {\n\treturn new LanguageDetectionWorker(workerServer);\n}\n\n/**\n * @internal\n */\nexport class LanguageDetectionWorker implements ILanguageDetectionWorker {\n\t_requestHandlerBrand: void = undefined;\n\n\tprivate static readonly expectedRelativeConfidence = 0.2;\n\tprivate static readonly positiveConfidenceCorrectionBucket1 = 0.05;\n\tprivate static readonly positiveConfidenceCorrectionBucket2 = 0.025;\n\tprivate static readonly negativeConfidenceCorrection = 0.5;\n\n\tprivate readonly _workerTextModelSyncServer = new WorkerTextModelSyncServer();\n\n\tprivate readonly _host: LanguageDetectionWorkerHost;\n\tprivate _regexpModel: RegexpModel | undefined;\n\tprivate _regexpLoadFailed: boolean = false;\n\n\tprivate _modelOperations: ModelOperations | undefined;\n\tprivate _loadFailed: boolean = false;\n\n\tprivate modelIdToCoreId = new Map<string, string | undefined>();\n\n\tconstructor(workerServer: IWebWorkerServer) {\n\t\tthis._host = LanguageDetectionWorkerHost.getChannel(workerServer);\n\t\tthis._workerTextModelSyncServer.bindToServer(workerServer);\n\t}\n\n\tpublic async $detectLanguage(uri: string, langBiases: Record<string, number> | undefined, preferHistory: boolean, supportedLangs?: string[]): Promise<string | undefined> {\n\t\tconst languages: string[] = [];\n\t\tconst confidences: number[] = [];\n\t\tconst stopWatch = new StopWatch();\n\t\tconst documentTextSample = this.getTextForDetection(uri);\n\t\tif (!documentTextSample) { return; }\n\n\t\tconst neuralResolver = async () => {\n\t\t\tfor await (const language of this.detectLanguagesImpl(documentTextSample)) {\n\t\t\t\tif (!this.modelIdToCoreId.has(language.languageId)) {\n\t\t\t\t\tthis.modelIdToCoreId.set(language.languageId, await this._host.$getLanguageId(language.languageId));\n\t\t\t\t}\n\t\t\t\tconst coreId = this.modelIdToCoreId.get(language.languageId);\n\t\t\t\tif (coreId && (!supportedLangs?.length || supportedLangs.includes(coreId))) {\n\t\t\t\t\tlanguages.push(coreId);\n\t\t\t\t\tconfidences.push(language.confidence);\n\t\t\t\t}\n\t\t\t}\n\t\t\tstopWatch.stop();\n\n\t\t\tif (languages.length) {\n\t\t\t\tthis._host.$sendTelemetryEvent(languages, confidences, stopWatch.elapsed());\n\t\t\t\treturn languages[0];\n\t\t\t}\n\t\t\treturn undefined;\n\t\t};\n\n\t\tconst historicalResolver = async () => this.runRegexpModel(documentTextSample, langBiases ?? {}, supportedLangs);\n\n\t\tif (preferHistory) {\n\t\t\tconst history = await historicalResolver();\n\t\t\tif (history) { return history; }\n\t\t\tconst neural = await neuralResolver();\n\t\t\tif (neural) { return neural; }\n\t\t} else {\n\t\t\tconst neural = await neuralResolver();\n\t\t\tif (neural) { return neural; }\n\t\t\tconst history = await historicalResolver();\n\t\t\tif (history) { return history; }\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate getTextForDetection(uri: string): string | undefined {\n\t\tconst editorModel = this._workerTextModelSyncServer.getModel(uri);\n\t\tif (!editorModel) { return; }\n\n\t\tconst end = editorModel.positionAt(10000);\n\t\tconst content = editorModel.getValueInRange({\n\t\t\tstartColumn: 1,\n\t\t\tstartLineNumber: 1,\n\t\t\tendColumn: end.column,\n\t\t\tendLineNumber: end.lineNumber\n\t\t});\n\t\treturn content;\n\t}\n\n\tprivate async getRegexpModel(): Promise<RegexpModel | undefined> {\n\t\tif (this._regexpLoadFailed) {\n\t\t\treturn;\n\t\t}\n\t\tif (this._regexpModel) {\n\t\t\treturn this._regexpModel;\n\t\t}\n\t\tconst uri: string = await this._host.$getRegexpModelUri();\n\t\ttry {\n\t\t\tthis._regexpModel = await importAMDNodeModule(uri, '') as RegexpModel;\n\t\t\treturn this._regexpModel;\n\t\t} catch (e) {\n\t\t\tthis._regexpLoadFailed = true;\n\t\t\t// console.warn('error loading language detection model', e);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tprivate async runRegexpModel(content: string, langBiases: Record<string, number>, supportedLangs?: string[]): Promise<string | undefined> {\n\t\tconst regexpModel = await this.getRegexpModel();\n\t\tif (!regexpModel) { return; }\n\n\t\tif (supportedLangs?.length) {\n\t\t\t// When using supportedLangs, normally computed biases are too extreme. Just use a \"bitmask\" of sorts.\n\t\t\tfor (const lang of Object.keys(langBiases)) {\n\t\t\t\tif (supportedLangs.includes(lang)) {\n\t\t\t\t\tlangBiases[lang] = 1;\n\t\t\t\t} else {\n\t\t\t\t\tlangBiases[lang] = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst detected = regexpModel.detect(content, langBiases, supportedLangs);\n\t\treturn detected;\n\t}\n\n\tprivate async getModelOperations(): Promise<ModelOperations> {\n\t\tif (this._modelOperations) {\n\t\t\treturn this._modelOperations;\n\t\t}\n\n\t\tconst uri: string = await this._host.$getIndexJsUri();\n\t\tconst { ModelOperations } = await importAMDNodeModule(uri, '') as typeof import('@vscode/vscode-languagedetection');\n\t\tthis._modelOperations = new ModelOperations({\n\t\t\tmodelJsonLoaderFunc: async () => {\n\t\t\t\tconst response = await fetch(await this._host.$getModelJsonUri());\n\t\t\t\ttry {\n\t\t\t\t\tconst modelJSON = await response.json();\n\t\t\t\t\treturn modelJSON;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst message = `Failed to parse model JSON.`;\n\t\t\t\t\tthrow new Error(message);\n\t\t\t\t}\n\t\t\t},\n\t\t\tweightsLoaderFunc: async () => {\n\t\t\t\tconst response = await fetch(await this._host.$getWeightsUri());\n\t\t\t\tconst buffer = await response.arrayBuffer();\n\t\t\t\treturn buffer;\n\t\t\t}\n\t\t});\n\n\t\treturn this._modelOperations;\n\t}\n\n\t// This adjusts the language confidence scores to be more accurate based on:\n\t// * VS Code's language usage\n\t// * Languages with 'problematic' syntaxes that have caused incorrect language detection\n\tprivate adjustLanguageConfidence(modelResult: ModelResult): ModelResult {\n\t\tswitch (modelResult.languageId) {\n\t\t\t// For the following languages, we increase the confidence because\n\t\t\t// these are commonly used languages in VS Code and supported\n\t\t\t// by the model.\n\t\t\tcase 'js':\n\t\t\tcase 'html':\n\t\t\tcase 'json':\n\t\t\tcase 'ts':\n\t\t\tcase 'css':\n\t\t\tcase 'py':\n\t\t\tcase 'xml':\n\t\t\tcase 'php':\n\t\t\t\tmodelResult.confidence += LanguageDetectionWorker.positiveConfidenceCorrectionBucket1;\n\t\t\t\tbreak;\n\t\t\t// case 'yaml': // YAML has been know to cause incorrect language detection because the language is pretty simple. We don't want to increase the confidence for this.\n\t\t\tcase 'cpp':\n\t\t\tcase 'sh':\n\t\t\tcase 'java':\n\t\t\tcase 'cs':\n\t\t\tcase 'c':\n\t\t\t\tmodelResult.confidence += LanguageDetectionWorker.positiveConfidenceCorrectionBucket2;\n\t\t\t\tbreak;\n\n\t\t\t// For the following languages, we need to be extra confident that the language is correct because\n\t\t\t// we've had issues like #131912 that caused incorrect guesses. To enforce this, we subtract the\n\t\t\t// negativeConfidenceCorrection from the confidence.\n\n\t\t\t// languages that are provided by default in VS Code\n\t\t\tcase 'bat':\n\t\t\tcase 'ini':\n\t\t\tcase 'makefile':\n\t\t\tcase 'sql':\n\t\t\t// languages that aren't provided by default in VS Code\n\t\t\tcase 'csv':\n\t\t\tcase 'toml':\n\t\t\t\t// Other considerations for negativeConfidenceCorrection that\n\t\t\t\t// aren't built in but suported by the model include:\n\t\t\t\t// * Assembly, TeX - These languages didn't have clear language modes in the community\n\t\t\t\t// * Markdown, Dockerfile - These languages are simple but they embed other languages\n\t\t\t\tmodelResult.confidence -= LanguageDetectionWorker.negativeConfidenceCorrection;\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tbreak;\n\n\t\t}\n\t\treturn modelResult;\n\t}\n\n\tprivate async * detectLanguagesImpl(content: string): AsyncGenerator<ModelResult, void, unknown> {\n\t\tif (this._loadFailed) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet modelOperations: ModelOperations | undefined;\n\t\ttry {\n\t\t\tmodelOperations = await this.getModelOperations();\n\t\t} catch (e) {\n\t\t\tconsole.log(e);\n\t\t\tthis._loadFailed = true;\n\t\t\treturn;\n\t\t}\n\n\t\tlet modelResults: ModelResult[] | undefined;\n\n\t\ttry {\n\t\t\tmodelResults = await modelOperations.runModel(content);\n\t\t} catch (e) {\n\t\t\tconsole.warn(e);\n\t\t}\n\n\t\tif (!modelResults\n\t\t\t|| modelResults.length === 0\n\t\t\t|| modelResults[0].confidence < LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst firstModelResult = this.adjustLanguageConfidence(modelResults[0]);\n\t\tif (firstModelResult.confidence < LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst possibleLanguages: ModelResult[] = [firstModelResult];\n\n\t\tfor (let current of modelResults) {\n\t\t\tif (current === firstModelResult) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tcurrent = this.adjustLanguageConfidence(current);\n\t\t\tconst currentHighest = possibleLanguages[possibleLanguages.length - 1];\n\n\t\t\tif (currentHighest.confidence - current.confidence >= LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\t\twhile (possibleLanguages.length) {\n\t\t\t\t\tyield possibleLanguages.shift()!;\n\t\t\t\t}\n\t\t\t\tif (current.confidence > LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\t\t\tpossibleLanguages.push(current);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tif (current.confidence > LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\t\t\tpossibleLanguages.push(current);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { ModelOperations, ModelResult } from '@vscode/vscode-languagedetection';\nimport { importAMDNodeModule } from '../../../../amdX.js';\nimport { StopWatch } from '../../../../base/common/stopwatch.js';\nimport { IWebWorkerServerRequestHandler, IWebWorkerServer } from '../../../../base/common/worker/webWorker.js';\nimport { LanguageDetectionWorkerHost, ILanguageDetectionWorker } from './languageDetectionWorker.protocol.js';\nimport { WorkerTextModelSyncServer } from '../../../../editor/common/services/textModelSync/textModelSync.impl.js';\n\ntype RegexpModel = { detect: (inp: string, langBiases: Record<string, number>, supportedLangs?: string[]) => string | undefined };\n\nexport function create(workerServer: IWebWorkerServer): IWebWorkerServerRequestHandler {\n\treturn new LanguageDetectionWorker(workerServer);\n}\n\n/**\n * @internal\n */\nexport class LanguageDetectionWorker implements ILanguageDetectionWorker {\n\t_requestHandlerBrand: void = undefined;\n\n\tprivate static readonly expectedRelativeConfidence = 0.2;\n\tprivate static readonly positiveConfidenceCorrectionBucket1 = 0.05;\n\tprivate static readonly positiveConfidenceCorrectionBucket2 = 0.025;\n\tprivate static readonly negativeConfidenceCorrection = 0.5;\n\n\tprivate readonly _workerTextModelSyncServer = new WorkerTextModelSyncServer();\n\n\tprivate readonly _host: LanguageDetectionWorkerHost;\n\tprivate _regexpModel: RegexpModel | undefined;\n\tprivate _regexpLoadFailed: boolean = false;\n\n\tprivate _modelOperations: ModelOperations | undefined;\n\tprivate _loadFailed: boolean = false;\n\n\tprivate modelIdToCoreId = new Map<string, string | undefined>();\n\n\tconstructor(workerServer: IWebWorkerServer) {\n\t\tthis._host = LanguageDetectionWorkerHost.getChannel(workerServer);\n\t\tthis._workerTextModelSyncServer.bindToServer(workerServer);\n\t}\n\n\tpublic async $detectLanguage(uri: string, langBiases: Record<string, number> | undefined, preferHistory: boolean, supportedLangs?: string[]): Promise<string | undefined> {\n\t\tconst languages: string[] = [];\n\t\tconst confidences: number[] = [];\n\t\tconst stopWatch = new StopWatch();\n\t\tconst documentTextSample = this.getTextForDetection(uri);\n\t\tif (!documentTextSample) { return; }\n\n\t\tconst neuralResolver = async () => {\n\t\t\tfor await (const language of this.detectLanguagesImpl(documentTextSample)) {\n\t\t\t\tif (!this.modelIdToCoreId.has(language.languageId)) {\n\t\t\t\t\tthis.modelIdToCoreId.set(language.languageId, await this._host.$getLanguageId(language.languageId));\n\t\t\t\t}\n\t\t\t\tconst coreId = this.modelIdToCoreId.get(language.languageId);\n\t\t\t\tif (coreId && (!supportedLangs?.length || supportedLangs.includes(coreId))) {\n\t\t\t\t\tlanguages.push(coreId);\n\t\t\t\t\tconfidences.push(language.confidence);\n\t\t\t\t}\n\t\t\t}\n\t\t\tstopWatch.stop();\n\n\t\t\tif (languages.length) {\n\t\t\t\tthis._host.$sendTelemetryEvent(languages, confidences, stopWatch.elapsed());\n\t\t\t\treturn languages[0];\n\t\t\t}\n\t\t\treturn undefined;\n\t\t};\n\n\t\tconst historicalResolver = async () => this.runRegexpModel(documentTextSample, langBiases ?? {}, supportedLangs);\n\n\t\tif (preferHistory) {\n\t\t\tconst history = await historicalResolver();\n\t\t\tif (history) { return history; }\n\t\t\tconst neural = await neuralResolver();\n\t\t\tif (neural) { return neural; }\n\t\t} else {\n\t\t\tconst neural = await neuralResolver();\n\t\t\tif (neural) { return neural; }\n\t\t\tconst history = await historicalResolver();\n\t\t\tif (history) { return history; }\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate getTextForDetection(uri: string): string | undefined {\n\t\tconst editorModel = this._workerTextModelSyncServer.getModel(uri);\n\t\tif (!editorModel) { return; }\n\n\t\tconst end = editorModel.positionAt(10000);\n\t\tconst content = editorModel.getValueInRange({\n\t\t\tstartColumn: 1,\n\t\t\tstartLineNumber: 1,\n\t\t\tendColumn: end.column,\n\t\t\tendLineNumber: end.lineNumber\n\t\t});\n\t\treturn content;\n\t}\n\n\tprivate async getRegexpModel(): Promise<RegexpModel | undefined> {\n\t\tif (this._regexpLoadFailed) {\n\t\t\treturn;\n\t\t}\n\t\tif (this._regexpModel) {\n\t\t\treturn this._regexpModel;\n\t\t}\n\t\tconst uri: string = await this._host.$getRegexpModelUri();\n\t\ttry {\n\t\t\tthis._regexpModel = await importAMDNodeModule(uri, '') as RegexpModel;\n\t\t\treturn this._regexpModel;\n\t\t} catch (e) {\n\t\t\tthis._regexpLoadFailed = true;\n\t\t\t// console.warn('error loading language detection model', e);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tprivate async runRegexpModel(content: string, langBiases: Record<string, number>, supportedLangs?: string[]): Promise<string | undefined> {\n\t\tconst regexpModel = await this.getRegexpModel();\n\t\tif (!regexpModel) { return; }\n\n\t\tif (supportedLangs?.length) {\n\t\t\t// When using supportedLangs, normally computed biases are too extreme. Just use a \"bitmask\" of sorts.\n\t\t\tfor (const lang of Object.keys(langBiases)) {\n\t\t\t\tif (supportedLangs.includes(lang)) {\n\t\t\t\t\tlangBiases[lang] = 1;\n\t\t\t\t} else {\n\t\t\t\t\tlangBiases[lang] = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst detected = regexpModel.detect(content, langBiases, supportedLangs);\n\t\treturn detected;\n\t}\n\n\tprivate async getModelOperations(): Promise<ModelOperations> {\n\t\tif (this._modelOperations) {\n\t\t\treturn this._modelOperations;\n\t\t}\n\n\t\tconst uri: string = await this._host.$getIndexJsUri();\n\t\tconst { ModelOperations } = await importAMDNodeModule(uri, '') as typeof import('@vscode/vscode-languagedetection');\n\t\tthis._modelOperations = new ModelOperations({\n\t\t\tmodelJsonLoaderFunc: async () => {\n\t\t\t\tconst response = await fetch(await this._host.$getModelJsonUri());\n\t\t\t\ttry {\n\t\t\t\t\tconst modelJSON = await response.json();\n\t\t\t\t\treturn modelJSON;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst message = `Failed to parse model JSON.`;\n\t\t\t\t\tthrow new Error(message);\n\t\t\t\t}\n\t\t\t},\n\t\t\tweightsLoaderFunc: async () => {\n\t\t\t\tconst response = await fetch(await this._host.$getWeightsUri());\n\t\t\t\tconst buffer = await response.arrayBuffer();\n\t\t\t\treturn buffer;\n\t\t\t}\n\t\t});\n\n\t\treturn this._modelOperations;\n\t}\n\n\t// This adjusts the language confidence scores to be more accurate based on:\n\t// * VS Code's language usage\n\t// * Languages with 'problematic' syntaxes that have caused incorrect language detection\n\tprivate adjustLanguageConfidence(modelResult: ModelResult): ModelResult {\n\t\tswitch (modelResult.languageId) {\n\t\t\t// For the following languages, we increase the confidence because\n\t\t\t// these are commonly used languages in VS Code and supported\n\t\t\t// by the model.\n\t\t\tcase 'js':\n\t\t\tcase 'html':\n\t\t\tcase 'json':\n\t\t\tcase 'ts':\n\t\t\tcase 'css':\n\t\t\tcase 'py':\n\t\t\tcase 'xml':\n\t\t\tcase 'php':\n\t\t\t\tmodelResult.confidence += LanguageDetectionWorker.positiveConfidenceCorrectionBucket1;\n\t\t\t\tbreak;\n\t\t\t// case 'yaml': // YAML has been know to cause incorrect language detection because the language is pretty simple. We don't want to increase the confidence for this.\n\t\t\tcase 'cpp':\n\t\t\tcase 'sh':\n\t\t\tcase 'java':\n\t\t\tcase 'cs':\n\t\t\tcase 'c':\n\t\t\t\tmodelResult.confidence += LanguageDetectionWorker.positiveConfidenceCorrectionBucket2;\n\t\t\t\tbreak;\n\n\t\t\t// For the following languages, we need to be extra confident that the language is correct because\n\t\t\t// we've had issues like #131912 that caused incorrect guesses. To enforce this, we subtract the\n\t\t\t// negativeConfidenceCorrection from the confidence.\n\n\t\t\t// languages that are provided by default in VS Code\n\t\t\tcase 'bat':\n\t\t\tcase 'ini':\n\t\t\tcase 'makefile':\n\t\t\tcase 'sql':\n\t\t\t// languages that aren't provided by default in VS Code\n\t\t\tcase 'csv':\n\t\t\tcase 'toml':\n\t\t\t\t// Other considerations for negativeConfidenceCorrection that\n\t\t\t\t// aren't built in but suported by the model include:\n\t\t\t\t// * Assembly, TeX - These languages didn't have clear language modes in the community\n\t\t\t\t// * Markdown, Dockerfile - These languages are simple but they embed other languages\n\t\t\t\tmodelResult.confidence -= LanguageDetectionWorker.negativeConfidenceCorrection;\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tbreak;\n\n\t\t}\n\t\treturn modelResult;\n\t}\n\n\tprivate async * detectLanguagesImpl(content: string): AsyncGenerator<ModelResult, void, unknown> {\n\t\tif (this._loadFailed) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet modelOperations: ModelOperations | undefined;\n\t\ttry {\n\t\t\tmodelOperations = await this.getModelOperations();\n\t\t} catch (e) {\n\t\t\tconsole.log(e);\n\t\t\tthis._loadFailed = true;\n\t\t\treturn;\n\t\t}\n\n\t\tlet modelResults: ModelResult[] | undefined;\n\n\t\ttry {\n\t\t\tmodelResults = await modelOperations.runModel(content);\n\t\t} catch (e) {\n\t\t\tconsole.warn(e);\n\t\t}\n\n\t\tif (!modelResults\n\t\t\t|| modelResults.length === 0\n\t\t\t|| modelResults[0].confidence < LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst firstModelResult = this.adjustLanguageConfidence(modelResults[0]);\n\t\tif (firstModelResult.confidence < LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst possibleLanguages: ModelResult[] = [firstModelResult];\n\n\t\tfor (let current of modelResults) {\n\t\t\tif (current === firstModelResult) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tcurrent = this.adjustLanguageConfidence(current);\n\t\t\tconst currentHighest = possibleLanguages[possibleLanguages.length - 1];\n\n\t\t\tif (currentHighest.confidence - current.confidence >= LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\t\twhile (possibleLanguages.length) {\n\t\t\t\t\tyield possibleLanguages.shift()!;\n\t\t\t\t}\n\t\t\t\tif (current.confidence > LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\t\t\tpossibleLanguages.push(current);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tif (current.confidence > LanguageDetectionWorker.expectedRelativeConfidence) {\n\t\t\t\t\tpossibleLanguages.push(current);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n}\n"]}