{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/languageDetection/browser/languageDetectionWorkerServiceImpl.ts","vs/workbench/services/languageDetection/browser/languageDetectionWorkerServiceImpl.ts"],"names":[],"mappings":"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","file":"languageDetectionWorkerServiceImpl.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ILanguageDetectionService, ILanguageDetectionStats, LanguageDetectionStatsClassification, LanguageDetectionStatsId } from '../common/languageDetectionWorkerService.js';\nimport { AppResourcePath, FileAccess, nodeModulesAsarPath, nodeModulesPath, Schemas } from '../../../../base/common/network.js';\nimport { IWorkbenchEnvironmentService } from '../../environment/common/environmentService.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { ILanguageService } from '../../../../editor/common/languages/language.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { isWeb } from '../../../../base/common/platform.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { IModelService } from '../../../../editor/common/services/model.js';\nimport { IWebWorkerClient } from '../../../../base/common/worker/webWorker.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IDiagnosticsService } from '../../../../platform/diagnostics/common/diagnostics.js';\nimport { IWorkspaceContextService } from '../../../../platform/workspace/common/workspace.js';\nimport { IEditorService } from '../../editor/common/editorService.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { LRUCache } from '../../../../base/common/map.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { canASAR } from '../../../../amdX.js';\nimport { WebWorkerDescriptor } from '../../../../platform/webWorker/browser/webWorkerDescriptor.js';\nimport { IWebWorkerService } from '../../../../platform/webWorker/browser/webWorkerService.js';\nimport { WorkerTextModelSyncClient } from '../../../../editor/common/services/textModelSync/textModelSync.impl.js';\nimport { ILanguageDetectionWorker, LanguageDetectionWorkerHost } from './languageDetectionWorker.protocol.js';\n\nconst TOP_LANG_COUNTS = 12;\n\nconst regexpModuleLocation: AppResourcePath = `${nodeModulesPath}/vscode-regexp-languagedetection`;\nconst regexpModuleLocationAsar: AppResourcePath = `${nodeModulesAsarPath}/vscode-regexp-languagedetection`;\nconst moduleLocation: AppResourcePath = `${nodeModulesPath}/@vscode/vscode-languagedetection`;\nconst moduleLocationAsar: AppResourcePath = `${nodeModulesAsarPath}/@vscode/vscode-languagedetection`;\n\nexport class LanguageDetectionService extends Disposable implements ILanguageDetectionService {\n\tstatic readonly enablementSettingKey = 'workbench.editor.languageDetection';\n\tstatic readonly historyBasedEnablementConfig = 'workbench.editor.historyBasedLanguageDetection';\n\tstatic readonly preferHistoryConfig = 'workbench.editor.preferHistoryBasedLanguageDetection';\n\tstatic readonly workspaceOpenedLanguagesStorageKey = 'workbench.editor.languageDetectionOpenedLanguages.workspace';\n\tstatic readonly globalOpenedLanguagesStorageKey = 'workbench.editor.languageDetectionOpenedLanguages.global';\n\n\t_serviceBrand: undefined;\n\n\tprivate _languageDetectionWorkerClient: LanguageDetectionWorkerClient;\n\n\tprivate hasResolvedWorkspaceLanguageIds = false;\n\tprivate workspaceLanguageIds = new Set<string>();\n\tprivate sessionOpenedLanguageIds = new Set<string>();\n\tprivate historicalGlobalOpenedLanguageIds = new LRUCache<string, true>(TOP_LANG_COUNTS);\n\tprivate historicalWorkspaceOpenedLanguageIds = new LRUCache<string, true>(TOP_LANG_COUNTS);\n\tprivate dirtyBiases: boolean = true;\n\tprivate langBiases: Record<string, number> = {};\n\n\tconstructor(\n\t\t@IWorkbenchEnvironmentService private readonly _environmentService: IWorkbenchEnvironmentService,\n\t\t@ILanguageService languageService: ILanguageService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IDiagnosticsService private readonly _diagnosticsService: IDiagnosticsService,\n\t\t@IWorkspaceContextService private readonly _workspaceContextService: IWorkspaceContextService,\n\t\t@IModelService modelService: IModelService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@ITelemetryService telemetryService: ITelemetryService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IWebWorkerService webWorkerService: IWebWorkerService,\n\t) {\n\t\tsuper();\n\n\t\tconst useAsar = canASAR && this._environmentService.isBuilt && !isWeb;\n\t\tthis._languageDetectionWorkerClient = this._register(new LanguageDetectionWorkerClient(\n\t\t\tmodelService,\n\t\t\tlanguageService,\n\t\t\ttelemetryService,\n\t\t\twebWorkerService,\n\t\t\t// TODO See if it's possible to bundle vscode-languagedetection\n\t\t\tuseAsar\n\t\t\t\t? FileAccess.asBrowserUri(`${moduleLocationAsar}/dist/lib/index.js`).toString(true)\n\t\t\t\t: FileAccess.asBrowserUri(`${moduleLocation}/dist/lib/index.js`).toString(true),\n\t\t\tuseAsar\n\t\t\t\t? FileAccess.asBrowserUri(`${moduleLocationAsar}/model/model.json`).toString(true)\n\t\t\t\t: FileAccess.asBrowserUri(`${moduleLocation}/model/model.json`).toString(true),\n\t\t\tuseAsar\n\t\t\t\t? FileAccess.asBrowserUri(`${moduleLocationAsar}/model/group1-shard1of1.bin`).toString(true)\n\t\t\t\t: FileAccess.asBrowserUri(`${moduleLocation}/model/group1-shard1of1.bin`).toString(true),\n\t\t\tuseAsar\n\t\t\t\t? FileAccess.asBrowserUri(`${regexpModuleLocationAsar}/dist/index.js`).toString(true)\n\t\t\t\t: FileAccess.asBrowserUri(`${regexpModuleLocation}/dist/index.js`).toString(true),\n\t\t));\n\n\t\tthis.initEditorOpenedListeners(storageService);\n\t}\n\n\tprivate async resolveWorkspaceLanguageIds() {\n\t\tif (this.hasResolvedWorkspaceLanguageIds) { return; }\n\t\tthis.hasResolvedWorkspaceLanguageIds = true;\n\t\tconst fileExtensions = await this._diagnosticsService.getWorkspaceFileExtensions(this._workspaceContextService.getWorkspace());\n\n\t\tlet count = 0;\n\t\tfor (const ext of fileExtensions.extensions) {\n\t\t\tconst langId = this._languageDetectionWorkerClient.getLanguageId(ext);\n\t\t\tif (langId && count < TOP_LANG_COUNTS) {\n\t\t\t\tthis.workspaceLanguageIds.add(langId);\n\t\t\t\tcount++;\n\t\t\t\tif (count > TOP_LANG_COUNTS) { break; }\n\t\t\t}\n\t\t}\n\t\tthis.dirtyBiases = true;\n\t}\n\n\tpublic isEnabledForLanguage(languageId: string): boolean {\n\t\treturn !!languageId && this._configurationService.getValue<boolean>(LanguageDetectionService.enablementSettingKey, { overrideIdentifier: languageId });\n\t}\n\n\n\tprivate getLanguageBiases(): Record<string, number> {\n\t\tif (!this.dirtyBiases) { return this.langBiases; }\n\n\t\tconst biases: Record<string, number> = {};\n\n\t\t// Give different weight to the biases depending on relevance of source\n\t\tthis.sessionOpenedLanguageIds.forEach(lang =>\n\t\t\tbiases[lang] = (biases[lang] ?? 0) + 7);\n\n\t\tthis.workspaceLanguageIds.forEach(lang =>\n\t\t\tbiases[lang] = (biases[lang] ?? 0) + 5);\n\n\t\t[...this.historicalWorkspaceOpenedLanguageIds.keys()].forEach(lang =>\n\t\t\tbiases[lang] = (biases[lang] ?? 0) + 3);\n\n\t\t[...this.historicalGlobalOpenedLanguageIds.keys()].forEach(lang =>\n\t\t\tbiases[lang] = (biases[lang] ?? 0) + 1);\n\n\t\tthis._logService.trace('Session Languages:', JSON.stringify([...this.sessionOpenedLanguageIds]));\n\t\tthis._logService.trace('Workspace Languages:', JSON.stringify([...this.workspaceLanguageIds]));\n\t\tthis._logService.trace('Historical Workspace Opened Languages:', JSON.stringify([...this.historicalWorkspaceOpenedLanguageIds.keys()]));\n\t\tthis._logService.trace('Historical Globally Opened Languages:', JSON.stringify([...this.historicalGlobalOpenedLanguageIds.keys()]));\n\t\tthis._logService.trace('Computed Language Detection Biases:', JSON.stringify(biases));\n\t\tthis.dirtyBiases = false;\n\t\tthis.langBiases = biases;\n\t\treturn biases;\n\t}\n\n\tasync detectLanguage(resource: URI, supportedLangs?: string[]): Promise<string | undefined> {\n\t\tconst useHistory = this._configurationService.getValue<string[]>(LanguageDetectionService.historyBasedEnablementConfig);\n\t\tconst preferHistory = this._configurationService.getValue<boolean>(LanguageDetectionService.preferHistoryConfig);\n\t\tif (useHistory) {\n\t\t\tawait this.resolveWorkspaceLanguageIds();\n\t\t}\n\t\tconst biases = useHistory ? this.getLanguageBiases() : undefined;\n\t\treturn this._languageDetectionWorkerClient.detectLanguage(resource, biases, preferHistory, supportedLangs);\n\t}\n\n\t// TODO: explore using the history service or something similar to provide this list of opened editors\n\t// so this service can support delayed instantiation. This may be tricky since it seems the IHistoryService\n\t// only gives history for a workspace... where this takes advantage of history at a global level as well.\n\tprivate initEditorOpenedListeners(storageService: IStorageService) {\n\t\ttry {\n\t\t\tconst globalLangHistoryData = JSON.parse(storageService.get(LanguageDetectionService.globalOpenedLanguagesStorageKey, StorageScope.PROFILE, '[]'));\n\t\t\tthis.historicalGlobalOpenedLanguageIds.fromJSON(globalLangHistoryData);\n\t\t} catch (e) { console.error(e); }\n\n\t\ttry {\n\t\t\tconst workspaceLangHistoryData = JSON.parse(storageService.get(LanguageDetectionService.workspaceOpenedLanguagesStorageKey, StorageScope.WORKSPACE, '[]'));\n\t\t\tthis.historicalWorkspaceOpenedLanguageIds.fromJSON(workspaceLangHistoryData);\n\t\t} catch (e) { console.error(e); }\n\n\t\tthis._register(this._editorService.onDidActiveEditorChange(() => {\n\t\t\tconst activeLanguage = this._editorService.activeTextEditorLanguageId;\n\t\t\tif (activeLanguage && this._editorService.activeEditor?.resource?.scheme !== Schemas.untitled) {\n\t\t\t\tthis.sessionOpenedLanguageIds.add(activeLanguage);\n\t\t\t\tthis.historicalGlobalOpenedLanguageIds.set(activeLanguage, true);\n\t\t\t\tthis.historicalWorkspaceOpenedLanguageIds.set(activeLanguage, true);\n\t\t\t\tstorageService.store(LanguageDetectionService.globalOpenedLanguagesStorageKey, JSON.stringify(this.historicalGlobalOpenedLanguageIds.toJSON()), StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\t\t\tstorageService.store(LanguageDetectionService.workspaceOpenedLanguagesStorageKey, JSON.stringify(this.historicalWorkspaceOpenedLanguageIds.toJSON()), StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\t\t\tthis.dirtyBiases = true;\n\t\t\t}\n\t\t}));\n\t}\n}\n\nexport class LanguageDetectionWorkerClient extends Disposable {\n\tprivate worker: {\n\t\tworkerClient: IWebWorkerClient<ILanguageDetectionWorker>;\n\t\tworkerTextModelSyncClient: WorkerTextModelSyncClient;\n\t} | undefined;\n\n\tconstructor(\n\t\tprivate readonly _modelService: IModelService,\n\t\tprivate readonly _languageService: ILanguageService,\n\t\tprivate readonly _telemetryService: ITelemetryService,\n\t\tprivate readonly _webWorkerService: IWebWorkerService,\n\t\tprivate readonly _indexJsUri: string,\n\t\tprivate readonly _modelJsonUri: string,\n\t\tprivate readonly _weightsUri: string,\n\t\tprivate readonly _regexpModelUri: string,\n\t) {\n\t\tsuper();\n\t}\n\n\tprivate _getOrCreateLanguageDetectionWorker(): {\n\t\tworkerClient: IWebWorkerClient<ILanguageDetectionWorker>;\n\t\tworkerTextModelSyncClient: WorkerTextModelSyncClient;\n\t} {\n\t\tif (!this.worker) {\n\t\t\tconst workerClient = this._register(this._webWorkerService.createWorkerClient<ILanguageDetectionWorker>(\n\t\t\t\tnew WebWorkerDescriptor({\n\t\t\t\t\tesmModuleLocation: FileAccess.asBrowserUri('vs/workbench/services/languageDetection/browser/languageDetectionWebWorkerMain.js'),\n\t\t\t\t\tlabel: 'LanguageDetectionWorker'\n\t\t\t\t})\n\t\t\t));\n\t\t\tLanguageDetectionWorkerHost.setChannel(workerClient, {\n\t\t\t\t$getIndexJsUri: async () => this.getIndexJsUri(),\n\t\t\t\t$getLanguageId: async (languageIdOrExt) => this.getLanguageId(languageIdOrExt),\n\t\t\t\t$sendTelemetryEvent: async (languages, confidences, timeSpent) => this.sendTelemetryEvent(languages, confidences, timeSpent),\n\t\t\t\t$getRegexpModelUri: async () => this.getRegexpModelUri(),\n\t\t\t\t$getModelJsonUri: async () => this.getModelJsonUri(),\n\t\t\t\t$getWeightsUri: async () => this.getWeightsUri(),\n\t\t\t});\n\t\t\tconst workerTextModelSyncClient = this._register(WorkerTextModelSyncClient.create(workerClient, this._modelService));\n\t\t\tthis.worker = { workerClient, workerTextModelSyncClient };\n\t\t}\n\t\treturn this.worker;\n\t}\n\n\tprivate _guessLanguageIdByUri(uri: URI): string | undefined {\n\t\tconst guess = this._languageService.guessLanguageIdByFilepathOrFirstLine(uri);\n\t\tif (guess && guess !== 'unknown') {\n\t\t\treturn guess;\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tasync getIndexJsUri() {\n\t\treturn this._indexJsUri;\n\t}\n\n\tgetLanguageId(languageIdOrExt: string | undefined) {\n\t\tif (!languageIdOrExt) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (this._languageService.isRegisteredLanguageId(languageIdOrExt)) {\n\t\t\treturn languageIdOrExt;\n\t\t}\n\t\tconst guessed = this._guessLanguageIdByUri(URI.file(`file.${languageIdOrExt}`));\n\t\tif (!guessed || guessed === 'unknown') {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn guessed;\n\t}\n\n\tasync getModelJsonUri() {\n\t\treturn this._modelJsonUri;\n\t}\n\n\tasync getWeightsUri() {\n\t\treturn this._weightsUri;\n\t}\n\n\tasync getRegexpModelUri() {\n\t\treturn this._regexpModelUri;\n\t}\n\n\tasync sendTelemetryEvent(languages: string[], confidences: number[], timeSpent: number): Promise<void> {\n\t\tthis._telemetryService.publicLog2<ILanguageDetectionStats, LanguageDetectionStatsClassification>(LanguageDetectionStatsId, {\n\t\t\tlanguages: languages.join(','),\n\t\t\tconfidences: confidences.join(','),\n\t\t\ttimeSpent\n\t\t});\n\t}\n\n\tpublic async detectLanguage(resource: URI, langBiases: Record<string, number> | undefined, preferHistory: boolean, supportedLangs?: string[]): Promise<string | undefined> {\n\t\tconst startTime = Date.now();\n\t\tconst quickGuess = this._guessLanguageIdByUri(resource);\n\t\tif (quickGuess) {\n\t\t\treturn quickGuess;\n\t\t}\n\n\t\tconst { workerClient, workerTextModelSyncClient } = this._getOrCreateLanguageDetectionWorker();\n\t\tworkerTextModelSyncClient.ensureSyncedResources([resource]);\n\t\tconst modelId = await workerClient.proxy.$detectLanguage(resource.toString(), langBiases, preferHistory, supportedLangs);\n\t\tconst languageId = this.getLanguageId(modelId);\n\n\t\tconst LanguageDetectionStatsId = 'automaticlanguagedetection.perf';\n\n\t\tinterface ILanguageDetectionPerf {\n\t\t\ttimeSpent: number;\n\t\t\tdetection: string;\n\t\t}\n\n\t\ttype LanguageDetectionPerfClassification = {\n\t\t\towner: 'TylerLeonhardt';\n\t\t\tcomment: 'Helps understand how effective language detection and how long it takes to run';\n\t\t\ttimeSpent: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The time it took to run language detection' };\n\t\t\tdetection: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The language that was detected' };\n\t\t};\n\n\t\tthis._telemetryService.publicLog2<ILanguageDetectionPerf, LanguageDetectionPerfClassification>(LanguageDetectionStatsId, {\n\t\t\ttimeSpent: Date.now() - startTime,\n\t\t\tdetection: languageId || 'unknown',\n\t\t});\n\n\t\treturn languageId;\n\t}\n}\n\n// For now we use Eager until we handle keeping track of history better.\nregisterSingleton(ILanguageDetectionService, LanguageDetectionService, InstantiationType.Eager);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ILanguageDetectionService, ILanguageDetectionStats, LanguageDetectionStatsClassification, LanguageDetectionStatsId } from '../common/languageDetectionWorkerService.js';\nimport { AppResourcePath, FileAccess, nodeModulesAsarPath, nodeModulesPath, Schemas } from '../../../../base/common/network.js';\nimport { IWorkbenchEnvironmentService } from '../../environment/common/environmentService.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { ILanguageService } from '../../../../editor/common/languages/language.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { isWeb } from '../../../../base/common/platform.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { IModelService } from '../../../../editor/common/services/model.js';\nimport { IWebWorkerClient } from '../../../../base/common/worker/webWorker.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IDiagnosticsService } from '../../../../platform/diagnostics/common/diagnostics.js';\nimport { IWorkspaceContextService } from '../../../../platform/workspace/common/workspace.js';\nimport { IEditorService } from '../../editor/common/editorService.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { LRUCache } from '../../../../base/common/map.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { canASAR } from '../../../../amdX.js';\nimport { WebWorkerDescriptor } from '../../../../platform/webWorker/browser/webWorkerDescriptor.js';\nimport { IWebWorkerService } from '../../../../platform/webWorker/browser/webWorkerService.js';\nimport { WorkerTextModelSyncClient } from '../../../../editor/common/services/textModelSync/textModelSync.impl.js';\nimport { ILanguageDetectionWorker, LanguageDetectionWorkerHost } from './languageDetectionWorker.protocol.js';\n\nconst TOP_LANG_COUNTS = 12;\n\nconst regexpModuleLocation: AppResourcePath = `${nodeModulesPath}/vscode-regexp-languagedetection`;\nconst regexpModuleLocationAsar: AppResourcePath = `${nodeModulesAsarPath}/vscode-regexp-languagedetection`;\nconst moduleLocation: AppResourcePath = `${nodeModulesPath}/@vscode/vscode-languagedetection`;\nconst moduleLocationAsar: AppResourcePath = `${nodeModulesAsarPath}/@vscode/vscode-languagedetection`;\n\nexport class LanguageDetectionService extends Disposable implements ILanguageDetectionService {\n\tstatic readonly enablementSettingKey = 'workbench.editor.languageDetection';\n\tstatic readonly historyBasedEnablementConfig = 'workbench.editor.historyBasedLanguageDetection';\n\tstatic readonly preferHistoryConfig = 'workbench.editor.preferHistoryBasedLanguageDetection';\n\tstatic readonly workspaceOpenedLanguagesStorageKey = 'workbench.editor.languageDetectionOpenedLanguages.workspace';\n\tstatic readonly globalOpenedLanguagesStorageKey = 'workbench.editor.languageDetectionOpenedLanguages.global';\n\n\t_serviceBrand: undefined;\n\n\tprivate _languageDetectionWorkerClient: LanguageDetectionWorkerClient;\n\n\tprivate hasResolvedWorkspaceLanguageIds = false;\n\tprivate workspaceLanguageIds = new Set<string>();\n\tprivate sessionOpenedLanguageIds = new Set<string>();\n\tprivate historicalGlobalOpenedLanguageIds = new LRUCache<string, true>(TOP_LANG_COUNTS);\n\tprivate historicalWorkspaceOpenedLanguageIds = new LRUCache<string, true>(TOP_LANG_COUNTS);\n\tprivate dirtyBiases: boolean = true;\n\tprivate langBiases: Record<string, number> = {};\n\n\tconstructor(\n\t\t@IWorkbenchEnvironmentService private readonly _environmentService: IWorkbenchEnvironmentService,\n\t\t@ILanguageService languageService: ILanguageService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IDiagnosticsService private readonly _diagnosticsService: IDiagnosticsService,\n\t\t@IWorkspaceContextService private readonly _workspaceContextService: IWorkspaceContextService,\n\t\t@IModelService modelService: IModelService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@ITelemetryService telemetryService: ITelemetryService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IWebWorkerService webWorkerService: IWebWorkerService,\n\t) {\n\t\tsuper();\n\n\t\tconst useAsar = canASAR && this._environmentService.isBuilt && !isWeb;\n\t\tthis._languageDetectionWorkerClient = this._register(new LanguageDetectionWorkerClient(\n\t\t\tmodelService,\n\t\t\tlanguageService,\n\t\t\ttelemetryService,\n\t\t\twebWorkerService,\n\t\t\t// TODO See if it's possible to bundle vscode-languagedetection\n\t\t\tuseAsar\n\t\t\t\t? FileAccess.asBrowserUri(`${moduleLocationAsar}/dist/lib/index.js`).toString(true)\n\t\t\t\t: FileAccess.asBrowserUri(`${moduleLocation}/dist/lib/index.js`).toString(true),\n\t\t\tuseAsar\n\t\t\t\t? FileAccess.asBrowserUri(`${moduleLocationAsar}/model/model.json`).toString(true)\n\t\t\t\t: FileAccess.asBrowserUri(`${moduleLocation}/model/model.json`).toString(true),\n\t\t\tuseAsar\n\t\t\t\t? FileAccess.asBrowserUri(`${moduleLocationAsar}/model/group1-shard1of1.bin`).toString(true)\n\t\t\t\t: FileAccess.asBrowserUri(`${moduleLocation}/model/group1-shard1of1.bin`).toString(true),\n\t\t\tuseAsar\n\t\t\t\t? FileAccess.asBrowserUri(`${regexpModuleLocationAsar}/dist/index.js`).toString(true)\n\t\t\t\t: FileAccess.asBrowserUri(`${regexpModuleLocation}/dist/index.js`).toString(true),\n\t\t));\n\n\t\tthis.initEditorOpenedListeners(storageService);\n\t}\n\n\tprivate async resolveWorkspaceLanguageIds() {\n\t\tif (this.hasResolvedWorkspaceLanguageIds) { return; }\n\t\tthis.hasResolvedWorkspaceLanguageIds = true;\n\t\tconst fileExtensions = await this._diagnosticsService.getWorkspaceFileExtensions(this._workspaceContextService.getWorkspace());\n\n\t\tlet count = 0;\n\t\tfor (const ext of fileExtensions.extensions) {\n\t\t\tconst langId = this._languageDetectionWorkerClient.getLanguageId(ext);\n\t\t\tif (langId && count < TOP_LANG_COUNTS) {\n\t\t\t\tthis.workspaceLanguageIds.add(langId);\n\t\t\t\tcount++;\n\t\t\t\tif (count > TOP_LANG_COUNTS) { break; }\n\t\t\t}\n\t\t}\n\t\tthis.dirtyBiases = true;\n\t}\n\n\tpublic isEnabledForLanguage(languageId: string): boolean {\n\t\treturn !!languageId && this._configurationService.getValue<boolean>(LanguageDetectionService.enablementSettingKey, { overrideIdentifier: languageId });\n\t}\n\n\n\tprivate getLanguageBiases(): Record<string, number> {\n\t\tif (!this.dirtyBiases) { return this.langBiases; }\n\n\t\tconst biases: Record<string, number> = {};\n\n\t\t// Give different weight to the biases depending on relevance of source\n\t\tthis.sessionOpenedLanguageIds.forEach(lang =>\n\t\t\tbiases[lang] = (biases[lang] ?? 0) + 7);\n\n\t\tthis.workspaceLanguageIds.forEach(lang =>\n\t\t\tbiases[lang] = (biases[lang] ?? 0) + 5);\n\n\t\t[...this.historicalWorkspaceOpenedLanguageIds.keys()].forEach(lang =>\n\t\t\tbiases[lang] = (biases[lang] ?? 0) + 3);\n\n\t\t[...this.historicalGlobalOpenedLanguageIds.keys()].forEach(lang =>\n\t\t\tbiases[lang] = (biases[lang] ?? 0) + 1);\n\n\t\tthis._logService.trace('Session Languages:', JSON.stringify([...this.sessionOpenedLanguageIds]));\n\t\tthis._logService.trace('Workspace Languages:', JSON.stringify([...this.workspaceLanguageIds]));\n\t\tthis._logService.trace('Historical Workspace Opened Languages:', JSON.stringify([...this.historicalWorkspaceOpenedLanguageIds.keys()]));\n\t\tthis._logService.trace('Historical Globally Opened Languages:', JSON.stringify([...this.historicalGlobalOpenedLanguageIds.keys()]));\n\t\tthis._logService.trace('Computed Language Detection Biases:', JSON.stringify(biases));\n\t\tthis.dirtyBiases = false;\n\t\tthis.langBiases = biases;\n\t\treturn biases;\n\t}\n\n\tasync detectLanguage(resource: URI, supportedLangs?: string[]): Promise<string | undefined> {\n\t\tconst useHistory = this._configurationService.getValue<string[]>(LanguageDetectionService.historyBasedEnablementConfig);\n\t\tconst preferHistory = this._configurationService.getValue<boolean>(LanguageDetectionService.preferHistoryConfig);\n\t\tif (useHistory) {\n\t\t\tawait this.resolveWorkspaceLanguageIds();\n\t\t}\n\t\tconst biases = useHistory ? this.getLanguageBiases() : undefined;\n\t\treturn this._languageDetectionWorkerClient.detectLanguage(resource, biases, preferHistory, supportedLangs);\n\t}\n\n\t// TODO: explore using the history service or something similar to provide this list of opened editors\n\t// so this service can support delayed instantiation. This may be tricky since it seems the IHistoryService\n\t// only gives history for a workspace... where this takes advantage of history at a global level as well.\n\tprivate initEditorOpenedListeners(storageService: IStorageService) {\n\t\ttry {\n\t\t\tconst globalLangHistoryData = JSON.parse(storageService.get(LanguageDetectionService.globalOpenedLanguagesStorageKey, StorageScope.PROFILE, '[]'));\n\t\t\tthis.historicalGlobalOpenedLanguageIds.fromJSON(globalLangHistoryData);\n\t\t} catch (e) { console.error(e); }\n\n\t\ttry {\n\t\t\tconst workspaceLangHistoryData = JSON.parse(storageService.get(LanguageDetectionService.workspaceOpenedLanguagesStorageKey, StorageScope.WORKSPACE, '[]'));\n\t\t\tthis.historicalWorkspaceOpenedLanguageIds.fromJSON(workspaceLangHistoryData);\n\t\t} catch (e) { console.error(e); }\n\n\t\tthis._register(this._editorService.onDidActiveEditorChange(() => {\n\t\t\tconst activeLanguage = this._editorService.activeTextEditorLanguageId;\n\t\t\tif (activeLanguage && this._editorService.activeEditor?.resource?.scheme !== Schemas.untitled) {\n\t\t\t\tthis.sessionOpenedLanguageIds.add(activeLanguage);\n\t\t\t\tthis.historicalGlobalOpenedLanguageIds.set(activeLanguage, true);\n\t\t\t\tthis.historicalWorkspaceOpenedLanguageIds.set(activeLanguage, true);\n\t\t\t\tstorageService.store(LanguageDetectionService.globalOpenedLanguagesStorageKey, JSON.stringify(this.historicalGlobalOpenedLanguageIds.toJSON()), StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\t\t\tstorageService.store(LanguageDetectionService.workspaceOpenedLanguagesStorageKey, JSON.stringify(this.historicalWorkspaceOpenedLanguageIds.toJSON()), StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\t\t\tthis.dirtyBiases = true;\n\t\t\t}\n\t\t}));\n\t}\n}\n\nexport class LanguageDetectionWorkerClient extends Disposable {\n\tprivate worker: {\n\t\tworkerClient: IWebWorkerClient<ILanguageDetectionWorker>;\n\t\tworkerTextModelSyncClient: WorkerTextModelSyncClient;\n\t} | undefined;\n\n\tconstructor(\n\t\tprivate readonly _modelService: IModelService,\n\t\tprivate readonly _languageService: ILanguageService,\n\t\tprivate readonly _telemetryService: ITelemetryService,\n\t\tprivate readonly _webWorkerService: IWebWorkerService,\n\t\tprivate readonly _indexJsUri: string,\n\t\tprivate readonly _modelJsonUri: string,\n\t\tprivate readonly _weightsUri: string,\n\t\tprivate readonly _regexpModelUri: string,\n\t) {\n\t\tsuper();\n\t}\n\n\tprivate _getOrCreateLanguageDetectionWorker(): {\n\t\tworkerClient: IWebWorkerClient<ILanguageDetectionWorker>;\n\t\tworkerTextModelSyncClient: WorkerTextModelSyncClient;\n\t} {\n\t\tif (!this.worker) {\n\t\t\tconst workerClient = this._register(this._webWorkerService.createWorkerClient<ILanguageDetectionWorker>(\n\t\t\t\tnew WebWorkerDescriptor({\n\t\t\t\t\tesmModuleLocation: FileAccess.asBrowserUri('vs/workbench/services/languageDetection/browser/languageDetectionWebWorkerMain.js'),\n\t\t\t\t\tlabel: 'LanguageDetectionWorker'\n\t\t\t\t})\n\t\t\t));\n\t\t\tLanguageDetectionWorkerHost.setChannel(workerClient, {\n\t\t\t\t$getIndexJsUri: async () => this.getIndexJsUri(),\n\t\t\t\t$getLanguageId: async (languageIdOrExt) => this.getLanguageId(languageIdOrExt),\n\t\t\t\t$sendTelemetryEvent: async (languages, confidences, timeSpent) => this.sendTelemetryEvent(languages, confidences, timeSpent),\n\t\t\t\t$getRegexpModelUri: async () => this.getRegexpModelUri(),\n\t\t\t\t$getModelJsonUri: async () => this.getModelJsonUri(),\n\t\t\t\t$getWeightsUri: async () => this.getWeightsUri(),\n\t\t\t});\n\t\t\tconst workerTextModelSyncClient = this._register(WorkerTextModelSyncClient.create(workerClient, this._modelService));\n\t\t\tthis.worker = { workerClient, workerTextModelSyncClient };\n\t\t}\n\t\treturn this.worker;\n\t}\n\n\tprivate _guessLanguageIdByUri(uri: URI): string | undefined {\n\t\tconst guess = this._languageService.guessLanguageIdByFilepathOrFirstLine(uri);\n\t\tif (guess && guess !== 'unknown') {\n\t\t\treturn guess;\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tasync getIndexJsUri() {\n\t\treturn this._indexJsUri;\n\t}\n\n\tgetLanguageId(languageIdOrExt: string | undefined) {\n\t\tif (!languageIdOrExt) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (this._languageService.isRegisteredLanguageId(languageIdOrExt)) {\n\t\t\treturn languageIdOrExt;\n\t\t}\n\t\tconst guessed = this._guessLanguageIdByUri(URI.file(`file.${languageIdOrExt}`));\n\t\tif (!guessed || guessed === 'unknown') {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn guessed;\n\t}\n\n\tasync getModelJsonUri() {\n\t\treturn this._modelJsonUri;\n\t}\n\n\tasync getWeightsUri() {\n\t\treturn this._weightsUri;\n\t}\n\n\tasync getRegexpModelUri() {\n\t\treturn this._regexpModelUri;\n\t}\n\n\tasync sendTelemetryEvent(languages: string[], confidences: number[], timeSpent: number): Promise<void> {\n\t\tthis._telemetryService.publicLog2<ILanguageDetectionStats, LanguageDetectionStatsClassification>(LanguageDetectionStatsId, {\n\t\t\tlanguages: languages.join(','),\n\t\t\tconfidences: confidences.join(','),\n\t\t\ttimeSpent\n\t\t});\n\t}\n\n\tpublic async detectLanguage(resource: URI, langBiases: Record<string, number> | undefined, preferHistory: boolean, supportedLangs?: string[]): Promise<string | undefined> {\n\t\tconst startTime = Date.now();\n\t\tconst quickGuess = this._guessLanguageIdByUri(resource);\n\t\tif (quickGuess) {\n\t\t\treturn quickGuess;\n\t\t}\n\n\t\tconst { workerClient, workerTextModelSyncClient } = this._getOrCreateLanguageDetectionWorker();\n\t\tworkerTextModelSyncClient.ensureSyncedResources([resource]);\n\t\tconst modelId = await workerClient.proxy.$detectLanguage(resource.toString(), langBiases, preferHistory, supportedLangs);\n\t\tconst languageId = this.getLanguageId(modelId);\n\n\t\tconst LanguageDetectionStatsId = 'automaticlanguagedetection.perf';\n\n\t\tinterface ILanguageDetectionPerf {\n\t\t\ttimeSpent: number;\n\t\t\tdetection: string;\n\t\t}\n\n\t\ttype LanguageDetectionPerfClassification = {\n\t\t\towner: 'TylerLeonhardt';\n\t\t\tcomment: 'Helps understand how effective language detection and how long it takes to run';\n\t\t\ttimeSpent: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The time it took to run language detection' };\n\t\t\tdetection: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The language that was detected' };\n\t\t};\n\n\t\tthis._telemetryService.publicLog2<ILanguageDetectionPerf, LanguageDetectionPerfClassification>(LanguageDetectionStatsId, {\n\t\t\ttimeSpent: Date.now() - startTime,\n\t\t\tdetection: languageId || 'unknown',\n\t\t});\n\n\t\treturn languageId;\n\t}\n}\n\n// For now we use Eager until we handle keeping track of history better.\nregisterSingleton(ILanguageDetectionService, LanguageDetectionService, InstantiationType.Eager);\n"]}