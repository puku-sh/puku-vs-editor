{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/chat/common/pukuAuthService.ts","vs/workbench/services/chat/common/pukuAuthService.ts"],"names":[],"mappings":"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","file":"pukuAuthService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Puku Editor - AI-powered code editor\n *  Puku Authentication Service for VS Code layer\n *  Google OAuth flow with Puku API (api.puku.sh)\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IOpenerService } from '../../../../platform/opener/common/opener.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { AuthenticationSession, AuthenticationSessionAccount } from '../../authentication/common/authentication.js';\nimport { IURLService, IURLHandler } from '../../../../platform/url/common/url.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { asText, IRequestService } from '../../../../platform/request/common/request.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\n\n// Puku API base URL\nconst PUKU_API_BASE = 'https://api.puku.sh';\n\n// Storage keys\nconst PUKU_SESSION_TOKEN_KEY = 'puku.sessionToken';\nconst PUKU_USER_KEY = 'puku.user';\n\nexport interface IPukuUser {\n\treadonly id: string;\n\treadonly name: string;\n\treadonly email: string;\n\treadonly picture?: string;\n}\n\nexport interface IPukuSession {\n\treadonly user: IPukuUser;\n\treadonly sessionToken: string;\n\treadonly createdAt: number;\n}\n\nexport const IPukuAuthService = createDecorator<IPukuAuthService>('pukuAuthService');\n\nexport interface IPukuAuthService {\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * Event fired when Puku session changes\n\t */\n\treadonly onDidChangeSession: Event<IPukuSession | undefined>;\n\n\t/**\n\t * Current Puku session\n\t */\n\treadonly session: IPukuSession | undefined;\n\n\t/**\n\t * Check if authenticated with Puku\n\t */\n\tisAuthenticated(): boolean;\n\n\t/**\n\t * Sign in with Google via Puku API\n\t * Opens browser to Puku's Google OAuth flow\n\t * Returns AuthenticationSession compatible with VS Code's auth service\n\t */\n\tsignInWithGoogle(): Promise<AuthenticationSession>;\n\n\t/**\n\t * Sign out from Puku\n\t */\n\tsignOut(): Promise<void>;\n\n\t/**\n\t * Initialize - restore session from storage\n\t */\n\tinitialize(): Promise<void>;\n\n\t/**\n\t * Get current session token for API calls\n\t */\n\tgetSessionToken(): string | undefined;\n}\n\nexport class PukuAuthService extends Disposable implements IPukuAuthService, IURLHandler {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _onDidChangeSession = this._register(new Emitter<IPukuSession | undefined>());\n\treadonly onDidChangeSession: Event<IPukuSession | undefined> = this._onDidChangeSession.event;\n\n\tprivate _session: IPukuSession | undefined;\n\tprivate _pendingSignIn: { resolve: (session: AuthenticationSession) => void; reject: (err: Error) => void } | undefined;\n\tprivate _signInTimeout: ReturnType<typeof setTimeout> | undefined;\n\n\tconstructor(\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IOpenerService private readonly openerService: IOpenerService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@IURLService private readonly urlService: IURLService,\n\t\t@IRequestService private readonly requestService: IRequestService,\n\t) {\n\t\tsuper();\n\t\tthis.logService.info('[PukuAuthService] Initializing');\n\n\t\t// Register URL handler for OAuth callback\n\t\tthis._register(this.urlService.registerHandler(this));\n\t}\n\n\tget session(): IPukuSession | undefined {\n\t\treturn this._session;\n\t}\n\n\tisAuthenticated(): boolean {\n\t\treturn !!this._session;\n\t}\n\n\tgetSessionToken(): string | undefined {\n\t\treturn this._session?.sessionToken;\n\t}\n\n\t/**\n\t * Handle URI callback from OAuth flow\n\t * URI format: puku://Puku.puku-editor/auth/callback?token=xxx\n\t */\n\tasync handleURL(uri: URI): Promise<boolean> {\n\t\tthis.logService.info('[PukuAuthService] Received URI callback:', uri.toString());\n\n\t\t// Check if this is our auth callback (case-insensitive authority check)\n\t\tif (uri.authority.toLowerCase() !== 'puku.puku-editor' || uri.path !== '/auth/callback') {\n\t\t\treturn false;\n\t\t}\n\n\t\t// The query string may be double-encoded (e.g., token%3Dxxx instead of token=xxx)\n\t\t// First try with URLSearchParams directly\n\t\tlet params = new URLSearchParams(uri.query);\n\t\tlet token = params.get('token');\n\t\tthis.logService.info('[PukuAuthService] First try - token:', token ? 'found' : 'null');\n\n\t\t// If not found, try decoding the query string first\n\t\tif (!token) {\n\t\t\ttry {\n\t\t\t\tconst decodedQuery = decodeURIComponent(uri.query);\n\t\t\t\tthis.logService.info('[PukuAuthService] Decoded query:', decodedQuery);\n\t\t\t\tparams = new URLSearchParams(decodedQuery);\n\t\t\t\ttoken = params.get('token');\n\t\t\t\tthis.logService.info('[PukuAuthService] Second try - token:', token ? 'found' : 'null');\n\t\t\t} catch {\n\t\t\t\t// decodeURIComponent can throw on invalid input\n\t\t\t\tthis.logService.error('[PukuAuthService] Failed to decode query string');\n\t\t\t}\n\t\t}\n\n\t\tif (!token) {\n\t\t\tthis.logService.error('[PukuAuthService] No token in callback URI');\n\t\t\tif (this._pendingSignIn) {\n\t\t\t\tthis._pendingSignIn.reject(new Error('No token received from OAuth flow'));\n\t\t\t\tthis._pendingSignIn = undefined;\n\t\t\t}\n\t\t\treturn true;\n\t\t}\n\n\t\ttry {\n\t\t\t// Validate session and get user info\n\t\t\tconst userInfo = await this.validateSessionAndGetUser(token);\n\n\t\t\t// Store session\n\t\t\tthis._session = {\n\t\t\t\tuser: userInfo,\n\t\t\t\tsessionToken: token,\n\t\t\t\tcreatedAt: Date.now(),\n\t\t\t};\n\n\t\t\t// Persist to storage\n\t\t\tthis.storageService.store(PUKU_SESSION_TOKEN_KEY, token, StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\t\tthis.storageService.store(PUKU_USER_KEY, JSON.stringify(userInfo), StorageScope.APPLICATION, StorageTarget.MACHINE);\n\n\t\t\tthis.logService.info('[PukuAuthService] Authenticated as', userInfo.email);\n\t\t\tthis._onDidChangeSession.fire(this._session);\n\n\t\t\t// Resolve pending sign-in\n\t\t\tif (this._pendingSignIn) {\n\t\t\t\tconst authSession: AuthenticationSession = {\n\t\t\t\t\tid: `puku-${userInfo.id}`,\n\t\t\t\t\taccessToken: token,\n\t\t\t\t\taccount: {\n\t\t\t\t\t\tid: userInfo.id,\n\t\t\t\t\t\tlabel: userInfo.email,\n\t\t\t\t\t},\n\t\t\t\t\tscopes: ['openid', 'email', 'profile'],\n\t\t\t\t};\n\t\t\t\tthis._pendingSignIn.resolve(authSession);\n\t\t\t\tthis._pendingSignIn = undefined;\n\t\t\t}\n\n\t\t\t// Clear timeout\n\t\t\tif (this._signInTimeout) {\n\t\t\t\tclearTimeout(this._signInTimeout);\n\t\t\t\tthis._signInTimeout = undefined;\n\t\t\t}\n\n\t\t} catch (error) {\n\t\t\tthis.logService.error('[PukuAuthService] Error after OAuth callback:', error);\n\t\t\tif (this._pendingSignIn) {\n\t\t\t\tthis._pendingSignIn.reject(error as Error);\n\t\t\t\tthis._pendingSignIn = undefined;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Validate session token and get user info from Puku API\n\t */\n\tprivate async validateSessionAndGetUser(sessionToken: string): Promise<IPukuUser> {\n\t\tconst response = await this.requestService.request({\n\t\t\ttype: 'GET',\n\t\t\turl: `${PUKU_API_BASE}/auth/session`,\n\t\t\theaders: {\n\t\t\t\t'Authorization': `Bearer ${sessionToken}`,\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t},\n\t\t}, CancellationToken.None);\n\n\t\tif (!response.res.statusCode || response.res.statusCode !== 200) {\n\t\t\tthrow new Error(`Failed to validate session: ${response.res.statusCode}`);\n\t\t}\n\n\t\tconst responseText = await asText(response);\n\t\tif (!responseText) {\n\t\t\tthrow new Error('Empty response from session validation');\n\t\t}\n\n\t\treturn JSON.parse(responseText) as IPukuUser;\n\t}\n\n\t/**\n\t * Sign in with Google via Puku API\n\t */\n\tasync signInWithGoogle(): Promise<AuthenticationSession> {\n\t\tthis.logService.info('[PukuAuthService] Starting Google OAuth sign-in');\n\n\t\t// Create promise that will be resolved when we get the callback\n\t\tconst signInPromise = new Promise<AuthenticationSession>((resolve, reject) => {\n\t\t\tthis._pendingSignIn = { resolve, reject };\n\t\t});\n\n\t\t// Set a timeout for the OAuth flow (5 minutes)\n\t\tthis._signInTimeout = setTimeout(() => {\n\t\t\tif (this._pendingSignIn) {\n\t\t\t\tthis._pendingSignIn.reject(new Error('Sign-in timed out'));\n\t\t\t\tthis._pendingSignIn = undefined;\n\t\t\t}\n\t\t}, 5 * 60 * 1000);\n\n\t\ttry {\n\t\t\t// Open browser to Puku's Google OAuth\n\t\t\tconst authUrl = `${PUKU_API_BASE}/auth/google`;\n\t\t\tawait this.openerService.open(URI.parse(authUrl), { openExternal: true });\n\n\t\t\t// Wait for the callback\n\t\t\tconst session = await signInPromise;\n\t\t\treturn session;\n\n\t\t} catch (error) {\n\t\t\tthis.logService.error('[PukuAuthService] Sign-in error:', error);\n\t\t\tthrow error;\n\n\t\t} finally {\n\t\t\tif (this._signInTimeout) {\n\t\t\t\tclearTimeout(this._signInTimeout);\n\t\t\t\tthis._signInTimeout = undefined;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Sign out from Puku\n\t */\n\tasync signOut(): Promise<void> {\n\t\tthis.logService.info('[PukuAuthService] Signing out');\n\n\t\t// Logout on server\n\t\tif (this._session?.sessionToken) {\n\t\t\ttry {\n\t\t\t\tawait this.requestService.request({\n\t\t\t\t\ttype: 'POST',\n\t\t\t\t\turl: `${PUKU_API_BASE}/auth/logout`,\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t'Authorization': `Bearer ${this._session.sessionToken}`,\n\t\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t\t},\n\t\t\t\t}, CancellationToken.None);\n\t\t\t} catch {\n\t\t\t\t// Ignore logout errors\n\t\t\t}\n\t\t}\n\n\t\t// Clear local state\n\t\tthis._session = undefined;\n\t\tthis.storageService.remove(PUKU_SESSION_TOKEN_KEY, StorageScope.APPLICATION);\n\t\tthis.storageService.remove(PUKU_USER_KEY, StorageScope.APPLICATION);\n\t\tthis._onDidChangeSession.fire(undefined);\n\t}\n\n\t/**\n\t * Initialize - restore session from storage\n\t */\n\tasync initialize(): Promise<void> {\n\t\tthis.logService.info('[PukuAuthService] Initializing');\n\n\t\ttry {\n\t\t\t// Try to restore session from storage\n\t\t\tconst storedToken = this.storageService.get(PUKU_SESSION_TOKEN_KEY, StorageScope.APPLICATION);\n\t\t\tconst storedUserJson = this.storageService.get(PUKU_USER_KEY, StorageScope.APPLICATION);\n\n\t\t\tif (storedToken && storedUserJson) {\n\t\t\t\tthis.logService.info('[PukuAuthService] Found stored session, validating...');\n\n\t\t\t\ttry {\n\t\t\t\t\t// Validate token is still valid\n\t\t\t\t\tconst userInfo = await this.validateSessionAndGetUser(storedToken);\n\n\t\t\t\t\tthis._session = {\n\t\t\t\t\t\tuser: userInfo,\n\t\t\t\t\t\tsessionToken: storedToken,\n\t\t\t\t\t\tcreatedAt: Date.now(),\n\t\t\t\t\t};\n\n\t\t\t\t\t// Update stored user info\n\t\t\t\t\tthis.storageService.store(PUKU_USER_KEY, JSON.stringify(userInfo), StorageScope.APPLICATION, StorageTarget.MACHINE);\n\n\t\t\t\t\tthis.logService.info('[PukuAuthService] Session restored for', userInfo.email);\n\t\t\t\t\tthis._onDidChangeSession.fire(this._session);\n\n\t\t\t\t} catch (error) {\n\t\t\t\t\t// Session is invalid, clear it\n\t\t\t\t\tthis.logService.info('[PukuAuthService] Stored session is invalid, clearing');\n\t\t\t\t\tthis.storageService.remove(PUKU_SESSION_TOKEN_KEY, StorageScope.APPLICATION);\n\t\t\t\t\tthis.storageService.remove(PUKU_USER_KEY, StorageScope.APPLICATION);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error('[PukuAuthService] Error during initialization:', error);\n\t\t}\n\t}\n\n\toverride dispose(): void {\n\t\tif (this._signInTimeout) {\n\t\t\tclearTimeout(this._signInTimeout);\n\t\t}\n\t\tsuper.dispose();\n\t}\n}\n\n/**\n * Convert Puku session to VS Code AuthenticationSession\n */\nexport function pukuSessionToAuthSession(pukuSession: IPukuSession): AuthenticationSession {\n\treturn {\n\t\tid: `puku-${pukuSession.user.id}`,\n\t\taccessToken: pukuSession.sessionToken,\n\t\taccount: {\n\t\t\tid: pukuSession.user.id,\n\t\t\tlabel: pukuSession.user.email,\n\t\t} as AuthenticationSessionAccount,\n\t\tscopes: ['openid', 'email', 'profile'],\n\t};\n}\n\nregisterSingleton(IPukuAuthService, PukuAuthService, InstantiationType.Eager);\n","/*---------------------------------------------------------------------------------------------\n *  Puku Editor - AI-powered code editor\n *  Puku Authentication Service for VS Code layer\n *  Google OAuth flow with Puku API (api.puku.sh)\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IOpenerService } from '../../../../platform/opener/common/opener.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { AuthenticationSession, AuthenticationSessionAccount } from '../../authentication/common/authentication.js';\nimport { IURLService, IURLHandler } from '../../../../platform/url/common/url.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { asText, IRequestService } from '../../../../platform/request/common/request.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\n\n// Puku API base URL\nconst PUKU_API_BASE = 'https://api.puku.sh';\n\n// Storage keys\nconst PUKU_SESSION_TOKEN_KEY = 'puku.sessionToken';\nconst PUKU_USER_KEY = 'puku.user';\n\nexport interface IPukuUser {\n\treadonly id: string;\n\treadonly name: string;\n\treadonly email: string;\n\treadonly picture?: string;\n}\n\nexport interface IPukuSession {\n\treadonly user: IPukuUser;\n\treadonly sessionToken: string;\n\treadonly createdAt: number;\n}\n\nexport const IPukuAuthService = createDecorator<IPukuAuthService>('pukuAuthService');\n\nexport interface IPukuAuthService {\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * Event fired when Puku session changes\n\t */\n\treadonly onDidChangeSession: Event<IPukuSession | undefined>;\n\n\t/**\n\t * Current Puku session\n\t */\n\treadonly session: IPukuSession | undefined;\n\n\t/**\n\t * Check if authenticated with Puku\n\t */\n\tisAuthenticated(): boolean;\n\n\t/**\n\t * Sign in with Google via Puku API\n\t * Opens browser to Puku's Google OAuth flow\n\t * Returns AuthenticationSession compatible with VS Code's auth service\n\t */\n\tsignInWithGoogle(): Promise<AuthenticationSession>;\n\n\t/**\n\t * Sign out from Puku\n\t */\n\tsignOut(): Promise<void>;\n\n\t/**\n\t * Initialize - restore session from storage\n\t */\n\tinitialize(): Promise<void>;\n\n\t/**\n\t * Get current session token for API calls\n\t */\n\tgetSessionToken(): string | undefined;\n}\n\nexport class PukuAuthService extends Disposable implements IPukuAuthService, IURLHandler {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _onDidChangeSession = this._register(new Emitter<IPukuSession | undefined>());\n\treadonly onDidChangeSession: Event<IPukuSession | undefined> = this._onDidChangeSession.event;\n\n\tprivate _session: IPukuSession | undefined;\n\tprivate _pendingSignIn: { resolve: (session: AuthenticationSession) => void; reject: (err: Error) => void } | undefined;\n\tprivate _signInTimeout: ReturnType<typeof setTimeout> | undefined;\n\n\tconstructor(\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IOpenerService private readonly openerService: IOpenerService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@IURLService private readonly urlService: IURLService,\n\t\t@IRequestService private readonly requestService: IRequestService,\n\t) {\n\t\tsuper();\n\t\tthis.logService.info('[PukuAuthService] Initializing');\n\n\t\t// Register URL handler for OAuth callback\n\t\tthis._register(this.urlService.registerHandler(this));\n\t}\n\n\tget session(): IPukuSession | undefined {\n\t\treturn this._session;\n\t}\n\n\tisAuthenticated(): boolean {\n\t\treturn !!this._session;\n\t}\n\n\tgetSessionToken(): string | undefined {\n\t\treturn this._session?.sessionToken;\n\t}\n\n\t/**\n\t * Handle URI callback from OAuth flow\n\t * URI format: puku://Puku.puku-editor/auth/callback?token=xxx\n\t */\n\tasync handleURL(uri: URI): Promise<boolean> {\n\t\tthis.logService.info('[PukuAuthService] Received URI callback:', uri.toString());\n\n\t\t// Check if this is our auth callback (case-insensitive authority check)\n\t\tif (uri.authority.toLowerCase() !== 'puku.puku-editor' || uri.path !== '/auth/callback') {\n\t\t\treturn false;\n\t\t}\n\n\t\t// The query string may be double-encoded (e.g., token%3Dxxx instead of token=xxx)\n\t\t// First try with URLSearchParams directly\n\t\tlet params = new URLSearchParams(uri.query);\n\t\tlet token = params.get('token');\n\t\tthis.logService.info('[PukuAuthService] First try - token:', token ? 'found' : 'null');\n\n\t\t// If not found, try decoding the query string first\n\t\tif (!token) {\n\t\t\ttry {\n\t\t\t\tconst decodedQuery = decodeURIComponent(uri.query);\n\t\t\t\tthis.logService.info('[PukuAuthService] Decoded query:', decodedQuery);\n\t\t\t\tparams = new URLSearchParams(decodedQuery);\n\t\t\t\ttoken = params.get('token');\n\t\t\t\tthis.logService.info('[PukuAuthService] Second try - token:', token ? 'found' : 'null');\n\t\t\t} catch {\n\t\t\t\t// decodeURIComponent can throw on invalid input\n\t\t\t\tthis.logService.error('[PukuAuthService] Failed to decode query string');\n\t\t\t}\n\t\t}\n\n\t\tif (!token) {\n\t\t\tthis.logService.error('[PukuAuthService] No token in callback URI');\n\t\t\tif (this._pendingSignIn) {\n\t\t\t\tthis._pendingSignIn.reject(new Error('No token received from OAuth flow'));\n\t\t\t\tthis._pendingSignIn = undefined;\n\t\t\t}\n\t\t\treturn true;\n\t\t}\n\n\t\ttry {\n\t\t\t// Validate session and get user info\n\t\t\tconst userInfo = await this.validateSessionAndGetUser(token);\n\n\t\t\t// Store session\n\t\t\tthis._session = {\n\t\t\t\tuser: userInfo,\n\t\t\t\tsessionToken: token,\n\t\t\t\tcreatedAt: Date.now(),\n\t\t\t};\n\n\t\t\t// Persist to storage\n\t\t\tthis.storageService.store(PUKU_SESSION_TOKEN_KEY, token, StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\t\tthis.storageService.store(PUKU_USER_KEY, JSON.stringify(userInfo), StorageScope.APPLICATION, StorageTarget.MACHINE);\n\n\t\t\tthis.logService.info('[PukuAuthService] Authenticated as', userInfo.email);\n\t\t\tthis._onDidChangeSession.fire(this._session);\n\n\t\t\t// Resolve pending sign-in\n\t\t\tif (this._pendingSignIn) {\n\t\t\t\tconst authSession: AuthenticationSession = {\n\t\t\t\t\tid: `puku-${userInfo.id}`,\n\t\t\t\t\taccessToken: token,\n\t\t\t\t\taccount: {\n\t\t\t\t\t\tid: userInfo.id,\n\t\t\t\t\t\tlabel: userInfo.email,\n\t\t\t\t\t},\n\t\t\t\t\tscopes: ['openid', 'email', 'profile'],\n\t\t\t\t};\n\t\t\t\tthis._pendingSignIn.resolve(authSession);\n\t\t\t\tthis._pendingSignIn = undefined;\n\t\t\t}\n\n\t\t\t// Clear timeout\n\t\t\tif (this._signInTimeout) {\n\t\t\t\tclearTimeout(this._signInTimeout);\n\t\t\t\tthis._signInTimeout = undefined;\n\t\t\t}\n\n\t\t} catch (error) {\n\t\t\tthis.logService.error('[PukuAuthService] Error after OAuth callback:', error);\n\t\t\tif (this._pendingSignIn) {\n\t\t\t\tthis._pendingSignIn.reject(error as Error);\n\t\t\t\tthis._pendingSignIn = undefined;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * Validate session token and get user info from Puku API\n\t */\n\tprivate async validateSessionAndGetUser(sessionToken: string): Promise<IPukuUser> {\n\t\tconst response = await this.requestService.request({\n\t\t\ttype: 'GET',\n\t\t\turl: `${PUKU_API_BASE}/auth/session`,\n\t\t\theaders: {\n\t\t\t\t'Authorization': `Bearer ${sessionToken}`,\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t},\n\t\t}, CancellationToken.None);\n\n\t\tif (!response.res.statusCode || response.res.statusCode !== 200) {\n\t\t\tthrow new Error(`Failed to validate session: ${response.res.statusCode}`);\n\t\t}\n\n\t\tconst responseText = await asText(response);\n\t\tif (!responseText) {\n\t\t\tthrow new Error('Empty response from session validation');\n\t\t}\n\n\t\treturn JSON.parse(responseText) as IPukuUser;\n\t}\n\n\t/**\n\t * Sign in with Google via Puku API\n\t */\n\tasync signInWithGoogle(): Promise<AuthenticationSession> {\n\t\tthis.logService.info('[PukuAuthService] Starting Google OAuth sign-in');\n\n\t\t// Create promise that will be resolved when we get the callback\n\t\tconst signInPromise = new Promise<AuthenticationSession>((resolve, reject) => {\n\t\t\tthis._pendingSignIn = { resolve, reject };\n\t\t});\n\n\t\t// Set a timeout for the OAuth flow (5 minutes)\n\t\tthis._signInTimeout = setTimeout(() => {\n\t\t\tif (this._pendingSignIn) {\n\t\t\t\tthis._pendingSignIn.reject(new Error('Sign-in timed out'));\n\t\t\t\tthis._pendingSignIn = undefined;\n\t\t\t}\n\t\t}, 5 * 60 * 1000);\n\n\t\ttry {\n\t\t\t// Open browser to Puku's Google OAuth\n\t\t\tconst authUrl = `${PUKU_API_BASE}/auth/google`;\n\t\t\tawait this.openerService.open(URI.parse(authUrl), { openExternal: true });\n\n\t\t\t// Wait for the callback\n\t\t\tconst session = await signInPromise;\n\t\t\treturn session;\n\n\t\t} catch (error) {\n\t\t\tthis.logService.error('[PukuAuthService] Sign-in error:', error);\n\t\t\tthrow error;\n\n\t\t} finally {\n\t\t\tif (this._signInTimeout) {\n\t\t\t\tclearTimeout(this._signInTimeout);\n\t\t\t\tthis._signInTimeout = undefined;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Sign out from Puku\n\t */\n\tasync signOut(): Promise<void> {\n\t\tthis.logService.info('[PukuAuthService] Signing out');\n\n\t\t// Logout on server\n\t\tif (this._session?.sessionToken) {\n\t\t\ttry {\n\t\t\t\tawait this.requestService.request({\n\t\t\t\t\ttype: 'POST',\n\t\t\t\t\turl: `${PUKU_API_BASE}/auth/logout`,\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t'Authorization': `Bearer ${this._session.sessionToken}`,\n\t\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t\t},\n\t\t\t\t}, CancellationToken.None);\n\t\t\t} catch {\n\t\t\t\t// Ignore logout errors\n\t\t\t}\n\t\t}\n\n\t\t// Clear local state\n\t\tthis._session = undefined;\n\t\tthis.storageService.remove(PUKU_SESSION_TOKEN_KEY, StorageScope.APPLICATION);\n\t\tthis.storageService.remove(PUKU_USER_KEY, StorageScope.APPLICATION);\n\t\tthis._onDidChangeSession.fire(undefined);\n\t}\n\n\t/**\n\t * Initialize - restore session from storage\n\t */\n\tasync initialize(): Promise<void> {\n\t\tthis.logService.info('[PukuAuthService] Initializing');\n\n\t\ttry {\n\t\t\t// Try to restore session from storage\n\t\t\tconst storedToken = this.storageService.get(PUKU_SESSION_TOKEN_KEY, StorageScope.APPLICATION);\n\t\t\tconst storedUserJson = this.storageService.get(PUKU_USER_KEY, StorageScope.APPLICATION);\n\n\t\t\tif (storedToken && storedUserJson) {\n\t\t\t\tthis.logService.info('[PukuAuthService] Found stored session, validating...');\n\n\t\t\t\ttry {\n\t\t\t\t\t// Validate token is still valid\n\t\t\t\t\tconst userInfo = await this.validateSessionAndGetUser(storedToken);\n\n\t\t\t\t\tthis._session = {\n\t\t\t\t\t\tuser: userInfo,\n\t\t\t\t\t\tsessionToken: storedToken,\n\t\t\t\t\t\tcreatedAt: Date.now(),\n\t\t\t\t\t};\n\n\t\t\t\t\t// Update stored user info\n\t\t\t\t\tthis.storageService.store(PUKU_USER_KEY, JSON.stringify(userInfo), StorageScope.APPLICATION, StorageTarget.MACHINE);\n\n\t\t\t\t\tthis.logService.info('[PukuAuthService] Session restored for', userInfo.email);\n\t\t\t\t\tthis._onDidChangeSession.fire(this._session);\n\n\t\t\t\t} catch (error) {\n\t\t\t\t\t// Session is invalid, clear it\n\t\t\t\t\tthis.logService.info('[PukuAuthService] Stored session is invalid, clearing');\n\t\t\t\t\tthis.storageService.remove(PUKU_SESSION_TOKEN_KEY, StorageScope.APPLICATION);\n\t\t\t\t\tthis.storageService.remove(PUKU_USER_KEY, StorageScope.APPLICATION);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error('[PukuAuthService] Error during initialization:', error);\n\t\t}\n\t}\n\n\toverride dispose(): void {\n\t\tif (this._signInTimeout) {\n\t\t\tclearTimeout(this._signInTimeout);\n\t\t}\n\t\tsuper.dispose();\n\t}\n}\n\n/**\n * Convert Puku session to VS Code AuthenticationSession\n */\nexport function pukuSessionToAuthSession(pukuSession: IPukuSession): AuthenticationSession {\n\treturn {\n\t\tid: `puku-${pukuSession.user.id}`,\n\t\taccessToken: pukuSession.sessionToken,\n\t\taccount: {\n\t\t\tid: pukuSession.user.id,\n\t\t\tlabel: pukuSession.user.email,\n\t\t} as AuthenticationSessionAccount,\n\t\tscopes: ['openid', 'email', 'profile'],\n\t};\n}\n\nregisterSingleton(IPukuAuthService, PukuAuthService, InstantiationType.Eager);\n"]}