{"version":3,"sources":["vs/workbench/services/chat/common/chatEntitlementService.ts"],"names":[],"mappings":"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","file":"chatEntitlementService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport product from '../../../../platform/product/common/product.js';\nimport { Barrier } from '../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Lazy } from '../../../../base/common/lazy.js';\nimport { Disposable, MutableDisposable } from '../../../../base/common/lifecycle.js';\nimport { IRequestContext } from '../../../../base/parts/request/common/request.js';\nimport { localize } from '../../../../nls.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IContextKey, IContextKeyService, RawContextKey } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { createDecorator, IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ICommandService } from '../../../../platform/commands/common/commands.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { asText, IRequestService } from '../../../../platform/request/common/request.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { ITelemetryService, TelemetryLevel } from '../../../../platform/telemetry/common/telemetry.js';\nimport { AuthenticationSession, AuthenticationSessionAccount, IAuthenticationExtensionsService, IAuthenticationService } from '../../authentication/common/authentication.js';\nimport { IOpenerService } from '../../../../platform/opener/common/opener.js';\nimport { IPukuAuthService } from './pukuAuthService.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport Severity from '../../../../base/common/severity.js';\nimport { IWorkbenchEnvironmentService } from '../../environment/common/environmentService.js';\nimport { isWeb } from '../../../../base/common/platform.js';\nimport { ILifecycleService, LifecyclePhase } from '../../lifecycle/common/lifecycle.js';\nimport { Mutable } from '../../../../base/common/types.js';\nimport { distinct } from '../../../../base/common/arrays.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { IObservable, observableFromEvent } from '../../../../base/common/observable.js';\n\nexport namespace ChatEntitlementContextKeys {\n\n\texport const Setup = {\n\t\thidden: new RawContextKey<boolean>('chatSetupHidden', false, true), \t\t// True when chat setup is explicitly hidden.\n\t\tinstalled: new RawContextKey<boolean>('chatSetupInstalled', false, true),  \t// True when the chat extension is installed and enabled.\n\t\tdisabled: new RawContextKey<boolean>('chatSetupDisabled', false, true),  \t// True when the chat extension is disabled due to any other reason than workspace trust.\n\t\tuntrusted: new RawContextKey<boolean>('chatSetupUntrusted', false, true),  \t// True when the chat extension is disabled due to workspace trust.\n\t\tlater: new RawContextKey<boolean>('chatSetupLater', false, true),  \t\t\t// True when the user wants to finish setup later.\n\t\tregistered: new RawContextKey<boolean>('chatSetupRegistered', false, true)  // True when the user has registered as Free or Pro user.\n\t};\n\n\texport const Entitlement = {\n\t\tsignedOut: new RawContextKey<boolean>('chatEntitlementSignedOut', false, true), \t\t\t\t// True when user is signed out.\n\t\tcanSignUp: new RawContextKey<boolean>('chatPlanCanSignUp', false, true), \t\t\t\t\t\t// True when user can sign up to be a chat free user.\n\n\t\tplanFree: new RawContextKey<boolean>('chatPlanFree', false, true),\t\t\t\t\t\t\t\t// True when user is a chat free user.\n\t\tplanPro: new RawContextKey<boolean>('chatPlanPro', false, true),\t\t\t\t\t\t\t\t// True when user is a chat pro user.\n\t\tplanProPlus: new RawContextKey<boolean>('chatPlanProPlus', false, true), \t\t\t\t\t\t// True when user is a chat pro plus user.\n\t\tplanBusiness: new RawContextKey<boolean>('chatPlanBusiness', false, true), \t\t\t\t\t\t// True when user is a chat business user.\n\t\tplanEnterprise: new RawContextKey<boolean>('chatPlanEnterprise', false, true), \t\t\t\t\t// True when user is a chat enterprise user.\n\n\t\torganisations: new RawContextKey<string[]>('chatEntitlementOrganisations', undefined, true), \t// The organizations the user belongs to.\n\t\tinternal: new RawContextKey<boolean>('chatEntitlementInternal', false, true), \t\t\t\t\t// True when user belongs to internal organisation.\n\t\tsku: new RawContextKey<string>('chatEntitlementSku', undefined, true), \t\t\t\t\t\t\t// The SKU of the user.\n\t};\n\n\texport const chatQuotaExceeded = new RawContextKey<boolean>('chatQuotaExceeded', false, true);\n\texport const completionsQuotaExceeded = new RawContextKey<boolean>('completionsQuotaExceeded', false, true);\n\n\texport const chatAnonymous = new RawContextKey<boolean>('chatAnonymous', false, true);\n}\n\nexport const IChatEntitlementService = createDecorator<IChatEntitlementService>('chatEntitlementService');\n\nexport enum ChatEntitlement {\n\t/** Signed out */\n\tUnknown = 1,\n\t/** Signed in but not yet resolved */\n\tUnresolved = 2,\n\t/** Signed in and entitled to Free */\n\tAvailable = 3,\n\t/** Signed in but not entitled to Free */\n\tUnavailable = 4,\n\t/** Signed-up to Free */\n\tFree = 5,\n\t/** Signed-up to Pro */\n\tPro = 6,\n\t/** Signed-up to Pro Plus */\n\tProPlus = 7,\n\t/** Signed-up to Business */\n\tBusiness = 8,\n\t/** Signed-up to Enterprise */\n\tEnterprise = 9,\n}\n\nexport interface IChatSentiment {\n\n\t/**\n\t * User has Chat installed.\n\t */\n\tinstalled?: boolean;\n\n\t/**\n\t * User signals no intent in using Chat.\n\t *\n\t * Note: in contrast to `disabled`, this should not only disable\n\t * Chat but also hide all of its UI.\n\t */\n\thidden?: boolean;\n\n\t/**\n\t * User signals intent to disable Chat.\n\t *\n\t * Note: in contrast to `hidden`, this should not hide\n\t * Chat but but disable its functionality.\n\t */\n\tdisabled?: boolean;\n\n\t/**\n\t * Chat is disabled due to missing workspace trust.\n\t *\n\t * Note: even though this disables Chat, we want to treat it\n\t * different from the `disabled` state that is by explicit\n\t * user choice.\n\t */\n\tuntrusted?: boolean;\n\n\t/**\n\t * User signals intent to use Chat later.\n\t */\n\tlater?: boolean;\n\n\t/**\n\t * User has registered as Free or Pro user.\n\t */\n\tregistered?: boolean;\n}\n\nexport interface IChatEntitlementService {\n\n\t_serviceBrand: undefined;\n\n\treadonly onDidChangeEntitlement: Event<void>;\n\n\treadonly entitlement: ChatEntitlement;\n\treadonly entitlementObs: IObservable<ChatEntitlement>;\n\n\treadonly organisations: string[] | undefined;\n\treadonly isInternal: boolean;\n\treadonly sku: string | undefined;\n\n\treadonly onDidChangeQuotaExceeded: Event<void>;\n\treadonly onDidChangeQuotaRemaining: Event<void>;\n\n\treadonly quotas: IQuotas;\n\n\treadonly onDidChangeSentiment: Event<void>;\n\n\treadonly sentiment: IChatSentiment;\n\treadonly sentimentObs: IObservable<IChatSentiment>;\n\n\t// TODO@bpasero eventually this will become enabled by default\n\t// and in that case we only need to check on entitlements change\n\t// between `unknown` and any other entitlement.\n\treadonly onDidChangeAnonymous: Event<void>;\n\treadonly anonymous: boolean;\n\treadonly anonymousObs: IObservable<boolean>;\n\n\tupdate(token: CancellationToken): Promise<void>;\n}\n\n//#region Helper Functions\n\n/**\n * Checks the chat entitlements to see if the user falls into the paid category\n * @param chatEntitlement The chat entitlement to check\n * @returns Whether or not they are a paid user\n */\nexport function isProUser(chatEntitlement: ChatEntitlement): boolean {\n\treturn chatEntitlement === ChatEntitlement.Pro ||\n\t\tchatEntitlement === ChatEntitlement.ProPlus ||\n\t\tchatEntitlement === ChatEntitlement.Business ||\n\t\tchatEntitlement === ChatEntitlement.Enterprise;\n}\n\n//#region Service Implementation\n\nconst defaultChat = {\n\textensionId: product.defaultChatAgent?.extensionId ?? '',\n\tchatExtensionId: product.defaultChatAgent?.chatExtensionId ?? '',\n\tupgradePlanUrl: product.defaultChatAgent?.upgradePlanUrl ?? '',\n\tprovider: product.defaultChatAgent?.provider ?? { default: { id: '' }, enterprise: { id: '' } },\n\tproviderUriSetting: product.defaultChatAgent?.providerUriSetting ?? '',\n\tproviderScopes: product.defaultChatAgent?.providerScopes ?? [[]],\n\tentitlementUrl: product.defaultChatAgent?.entitlementUrl ?? '',\n\tentitlementSignupLimitedUrl: product.defaultChatAgent?.entitlementSignupLimitedUrl ?? '',\n\tcompletionsAdvancedSetting: product.defaultChatAgent?.completionsAdvancedSetting ?? '',\n\tchatQuotaExceededContext: product.defaultChatAgent?.chatQuotaExceededContext ?? '',\n\tcompletionsQuotaExceededContext: product.defaultChatAgent?.completionsQuotaExceededContext ?? ''\n};\n\ninterface IChatQuotasAccessor {\n\tclearQuotas(): void;\n\tacceptQuotas(quotas: IQuotas): void;\n}\n\nconst CHAT_ALLOW_ANONYMOUS_CONFIGURATION_KEY = 'chat.allowAnonymousAccess';\n\nfunction isAnonymous(configurationService: IConfigurationService, entitlement: ChatEntitlement, sentiment: IChatSentiment): boolean {\n\tif (configurationService.getValue(CHAT_ALLOW_ANONYMOUS_CONFIGURATION_KEY) !== true) {\n\t\treturn false; // only enabled behind an experimental setting\n\t}\n\n\tif (entitlement !== ChatEntitlement.Unknown) {\n\t\treturn false; // only consider signed out users\n\t}\n\n\tif (sentiment.hidden || sentiment.disabled) {\n\t\treturn false; // only consider enabled scenarios\n\t}\n\n\treturn true;\n}\n\nfunction logChatEntitlements(state: IChatEntitlementContextState, configurationService: IConfigurationService, telemetryService: ITelemetryService): void {\n\ttelemetryService.publicLog2<ChatEntitlementEvent, ChatEntitlementClassification>('chatEntitlements', {\n\t\tchatHidden: Boolean(state.hidden),\n\t\tchatDisabled: Boolean(state.disabled),\n\t\tchatEntitlement: state.entitlement,\n\t\tchatRegistered: Boolean(state.registered),\n\t\tchatAnonymous: isAnonymous(configurationService, state.entitlement, state)\n\t});\n}\n\nexport class ChatEntitlementService extends Disposable implements IChatEntitlementService {\n\n\tdeclare _serviceBrand: undefined;\n\n\treadonly context: Lazy<ChatEntitlementContext> | undefined;\n\treadonly requests: Lazy<ChatEntitlementRequests> | undefined;\n\n\tconstructor(\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@IProductService productService: IProductService,\n\t\t@IWorkbenchEnvironmentService environmentService: IWorkbenchEnvironmentService,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@ILifecycleService private readonly lifecycleService: ILifecycleService,\n\t\t@IPukuAuthService private readonly pukuAuthService: IPukuAuthService,\n\t\t@ILogService private readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\n\t\tthis.chatQuotaExceededContextKey = ChatEntitlementContextKeys.chatQuotaExceeded.bindTo(this.contextKeyService);\n\t\tthis.completionsQuotaExceededContextKey = ChatEntitlementContextKeys.completionsQuotaExceeded.bindTo(this.contextKeyService);\n\n\t\tthis.anonymousContextKey = ChatEntitlementContextKeys.chatAnonymous.bindTo(this.contextKeyService);\n\t\tthis.anonymousContextKey.set(this.anonymous);\n\n\t\tthis.onDidChangeEntitlement = Event.map(\n\t\t\tEvent.filter(\n\t\t\t\tthis.contextKeyService.onDidChangeContext, e => e.affectsSome(new Set([\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.planPro.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.planBusiness.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.planEnterprise.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.planProPlus.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.planFree.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.canSignUp.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.signedOut.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.organisations.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.internal.key,\n\t\t\t\t\tChatEntitlementContextKeys.Entitlement.sku.key\n\t\t\t\t])), this._store\n\t\t\t), () => { }, this._store\n\t\t);\n\t\tthis.entitlementObs = observableFromEvent(this.onDidChangeEntitlement, () => this.entitlement);\n\n\t\tthis.onDidChangeSentiment = Event.map(\n\t\t\tEvent.filter(\n\t\t\t\tthis.contextKeyService.onDidChangeContext, e => e.affectsSome(new Set([\n\t\t\t\t\tChatEntitlementContextKeys.Setup.hidden.key,\n\t\t\t\t\tChatEntitlementContextKeys.Setup.disabled.key,\n\t\t\t\t\tChatEntitlementContextKeys.Setup.untrusted.key,\n\t\t\t\t\tChatEntitlementContextKeys.Setup.installed.key,\n\t\t\t\t\tChatEntitlementContextKeys.Setup.later.key,\n\t\t\t\t\tChatEntitlementContextKeys.Setup.registered.key\n\t\t\t\t])), this._store\n\t\t\t), () => { }, this._store\n\t\t);\n\t\tthis.sentimentObs = observableFromEvent(this.onDidChangeSentiment, () => this.sentiment);\n\n\t\tif ((\n\t\t\t// TODO@bpasero remove this condition and 'serverlessWebEnabled' once Chat web support lands\n\t\t\tisWeb &&\n\t\t\t!environmentService.remoteAuthority &&\n\t\t\t!configurationService.getValue('chat.experimental.serverlessWebEnabled')\n\t\t)) {\n\t\t\tChatEntitlementContextKeys.Setup.hidden.bindTo(this.contextKeyService).set(true); // hide copilot UI\n\t\t\treturn;\n\t\t}\n\n\t\tif (!productService.defaultChatAgent) {\n\t\t\treturn; // we need a default chat agent configured going forward from here\n\t\t}\n\n\t\tconst context = this.context = new Lazy(() => this._register(instantiationService.createInstance(ChatEntitlementContext)));\n\t\tthis.requests = new Lazy(() => this._register(instantiationService.createInstance(ChatEntitlementRequests, context.value, {\n\t\t\tclearQuotas: () => this.clearQuotas(),\n\t\t\tacceptQuotas: quotas => this.acceptQuotas(quotas)\n\t\t})));\n\n\t\tthis.registerListeners();\n\t}\n\n\t//#region --- Entitlements\n\n\treadonly onDidChangeEntitlement: Event<void>;\n\treadonly entitlementObs: IObservable<ChatEntitlement>;\n\n\tget entitlement(): ChatEntitlement {\n\t\tif (this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Entitlement.planPro.key) === true) {\n\t\t\treturn ChatEntitlement.Pro;\n\t\t} else if (this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Entitlement.planBusiness.key) === true) {\n\t\t\treturn ChatEntitlement.Business;\n\t\t} else if (this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Entitlement.planEnterprise.key) === true) {\n\t\t\treturn ChatEntitlement.Enterprise;\n\t\t} else if (this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Entitlement.planProPlus.key) === true) {\n\t\t\treturn ChatEntitlement.ProPlus;\n\t\t} else if (this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Entitlement.planFree.key) === true) {\n\t\t\treturn ChatEntitlement.Free;\n\t\t} else if (this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Entitlement.canSignUp.key) === true) {\n\t\t\treturn ChatEntitlement.Available;\n\t\t} else if (this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Entitlement.signedOut.key) === true) {\n\t\t\treturn ChatEntitlement.Unknown;\n\t\t}\n\n\t\treturn ChatEntitlement.Unresolved;\n\t}\n\n\tget isInternal(): boolean {\n\t\treturn this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Entitlement.internal.key) === true;\n\t}\n\n\tget organisations(): string[] | undefined {\n\t\treturn this.contextKeyService.getContextKeyValue<string[]>(ChatEntitlementContextKeys.Entitlement.organisations.key);\n\t}\n\n\tget sku(): string | undefined {\n\t\treturn this.contextKeyService.getContextKeyValue<string>(ChatEntitlementContextKeys.Entitlement.sku.key);\n\t}\n\n\t//#endregion\n\n\t//#region --- Quotas\n\n\tprivate readonly _onDidChangeQuotaExceeded = this._register(new Emitter<void>());\n\treadonly onDidChangeQuotaExceeded = this._onDidChangeQuotaExceeded.event;\n\n\tprivate readonly _onDidChangeQuotaRemaining = this._register(new Emitter<void>());\n\treadonly onDidChangeQuotaRemaining = this._onDidChangeQuotaRemaining.event;\n\n\tprivate _quotas: IQuotas = {};\n\tget quotas() { return this._quotas; }\n\n\tprivate readonly chatQuotaExceededContextKey: IContextKey<boolean>;\n\tprivate readonly completionsQuotaExceededContextKey: IContextKey<boolean>;\n\n\tprivate ExtensionQuotaContextKeys = {\n\t\tchatQuotaExceeded: defaultChat.chatQuotaExceededContext,\n\t\tcompletionsQuotaExceeded: defaultChat.completionsQuotaExceededContext,\n\t};\n\n\tprivate registerListeners(): void {\n\t\tconst quotaExceededSet = new Set([this.ExtensionQuotaContextKeys.chatQuotaExceeded, this.ExtensionQuotaContextKeys.completionsQuotaExceeded]);\n\n\t\tconst cts = this._register(new MutableDisposable<CancellationTokenSource>());\n\t\tthis._register(this.contextKeyService.onDidChangeContext(e => {\n\t\t\tif (e.affectsSome(quotaExceededSet)) {\n\t\t\t\tif (cts.value) {\n\t\t\t\t\tcts.value.cancel();\n\t\t\t\t}\n\t\t\t\tcts.value = new CancellationTokenSource();\n\t\t\t\tthis.update(cts.value.token);\n\t\t\t}\n\t\t}));\n\n\t\tlet anonymousUsage = this.anonymous;\n\n\t\tconst updateAnonymousUsage = () => {\n\t\t\tconst newAnonymousUsage = this.anonymous;\n\t\t\tif (newAnonymousUsage !== anonymousUsage) {\n\t\t\t\tanonymousUsage = newAnonymousUsage;\n\t\t\t\tthis.anonymousContextKey.set(newAnonymousUsage);\n\n\t\t\t\tif (this.context?.hasValue) {\n\t\t\t\t\tlogChatEntitlements(this.context.value.state, this.configurationService, this.telemetryService);\n\t\t\t\t}\n\n\t\t\t\tthis._onDidChangeAnonymous.fire();\n\t\t\t}\n\t\t};\n\n\t\tthis._register(this.configurationService.onDidChangeConfiguration(e => {\n\t\t\tif (e.affectsConfiguration(CHAT_ALLOW_ANONYMOUS_CONFIGURATION_KEY)) {\n\t\t\t\tupdateAnonymousUsage();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this.onDidChangeEntitlement(() => updateAnonymousUsage()));\n\t\tthis._register(this.onDidChangeSentiment(() => updateAnonymousUsage()));\n\n\t\t// TODO@bpasero workaround for https://github.com/microsoft/vscode-internalbacklog/issues/6275\n\t\tthis.lifecycleService.when(LifecyclePhase.Eventually).then(() => {\n\t\t\tif (this.context?.hasValue) {\n\t\t\t\tlogChatEntitlements(this.context.value.state, this.configurationService, this.telemetryService);\n\t\t\t}\n\t\t});\n\n\t\t// Listen for Puku auth changes and update entitlements\n\t\tthis._register(this.pukuAuthService.onDidChangeSession(session => {\n\t\t\tthis.logService.info('[chat entitlement] Puku session changed:', session?.user?.email ?? 'signed out');\n\t\t\tif (session) {\n\t\t\t\t// User signed in with Puku - grant Free entitlement\n\t\t\t\tthis.context?.value.update({ entitlement: ChatEntitlement.Free, organisations: undefined, sku: 'puku-free' });\n\t\t\t\t// Fetch and update quotas from Puku API\n\t\t\t\tthis.requests?.value.fetchPukuQuotas().catch((err: Error) => {\n\t\t\t\t\tthis.logService.error('[chat entitlement] Error fetching Puku quotas:', err);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t// User signed out\n\t\t\t\tthis.context?.value.update({ entitlement: ChatEntitlement.Unknown, organisations: undefined, sku: undefined });\n\t\t\t}\n\t\t}));\n\n\t\t// Check initial Puku auth state\n\t\tif (this.pukuAuthService.isAuthenticated()) {\n\t\t\tthis.logService.info('[chat entitlement] Puku already authenticated:', this.pukuAuthService.session?.user?.email);\n\t\t\tthis.context?.value.update({ entitlement: ChatEntitlement.Free, organisations: undefined, sku: 'puku-free' });\n\t\t\t// Fetch and update quotas from Puku API\n\t\t\tthis.requests?.value.fetchPukuQuotas().catch((err: Error) => {\n\t\t\t\tthis.logService.error('[chat entitlement] Error fetching Puku quotas:', err);\n\t\t\t});\n\t\t}\n\t}\n\n\tacceptQuotas(quotas: IQuotas): void {\n\t\tconst oldQuota = this._quotas;\n\t\tthis._quotas = quotas;\n\t\tthis.updateContextKeys();\n\n\t\tconst { changed: chatChanged } = this.compareQuotas(oldQuota.chat, quotas.chat);\n\t\tconst { changed: completionsChanged } = this.compareQuotas(oldQuota.completions, quotas.completions);\n\t\tconst { changed: premiumChatChanged } = this.compareQuotas(oldQuota.premiumChat, quotas.premiumChat);\n\n\t\tif (chatChanged.exceeded || completionsChanged.exceeded || premiumChatChanged.exceeded) {\n\t\t\tthis._onDidChangeQuotaExceeded.fire();\n\t\t}\n\n\t\tif (chatChanged.remaining || completionsChanged.remaining || premiumChatChanged.remaining) {\n\t\t\tthis._onDidChangeQuotaRemaining.fire();\n\t\t}\n\t}\n\n\tprivate compareQuotas(oldQuota: IQuotaSnapshot | undefined, newQuota: IQuotaSnapshot | undefined): { changed: { exceeded: boolean; remaining: boolean } } {\n\t\treturn {\n\t\t\tchanged: {\n\t\t\t\texceeded: (oldQuota?.percentRemaining === 0) !== (newQuota?.percentRemaining === 0),\n\t\t\t\tremaining: oldQuota?.percentRemaining !== newQuota?.percentRemaining\n\t\t\t}\n\t\t};\n\t}\n\n\tclearQuotas(): void {\n\t\tthis.acceptQuotas({});\n\t}\n\n\tprivate updateContextKeys(): void {\n\t\tthis.chatQuotaExceededContextKey.set(this._quotas.chat?.percentRemaining === 0);\n\t\tthis.completionsQuotaExceededContextKey.set(this._quotas.completions?.percentRemaining === 0);\n\t}\n\n\t//#endregion\n\n\t//#region --- Sentiment\n\n\treadonly onDidChangeSentiment: Event<void>;\n\treadonly sentimentObs: IObservable<IChatSentiment>;\n\n\tget sentiment(): IChatSentiment {\n\t\treturn {\n\t\t\tinstalled: this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Setup.installed.key) === true,\n\t\t\thidden: this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Setup.hidden.key) === true,\n\t\t\tdisabled: this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Setup.disabled.key) === true,\n\t\t\tuntrusted: this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Setup.untrusted.key) === true,\n\t\t\tlater: this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Setup.later.key) === true,\n\t\t\tregistered: this.contextKeyService.getContextKeyValue<boolean>(ChatEntitlementContextKeys.Setup.registered.key) === true\n\t\t};\n\t}\n\n\t//#endregion\n\n\t//region --- Anonymous\n\n\tprivate readonly anonymousContextKey: IContextKey<boolean>;\n\n\tprivate readonly _onDidChangeAnonymous = this._register(new Emitter<void>());\n\treadonly onDidChangeAnonymous = this._onDidChangeAnonymous.event;\n\n\treadonly anonymousObs = observableFromEvent(this.onDidChangeAnonymous, () => this.anonymous);\n\n\tget anonymous(): boolean {\n\t\treturn isAnonymous(this.configurationService, this.entitlement, this.sentiment);\n\t}\n\n\t//#endregion\n\n\tasync update(token: CancellationToken): Promise<void> {\n\t\tawait this.requests?.value.forceResolveEntitlement(undefined, token);\n\t}\n}\n\n//#endregion\n\n//#region Chat Entitlement Request Service\n\ntype EntitlementClassification = {\n\ttid: { classification: 'EndUserPseudonymizedInformation'; purpose: 'BusinessInsight'; comment: 'The anonymized analytics id returned by the service'; endpoint: 'GoogleAnalyticsId' };\n\tentitlement: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Flag indicating the chat entitlement state' };\n\tsku: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The SKU of the chat entitlement' };\n\tquotaChat: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of chat requests available to the user' };\n\tquotaPremiumChat: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of premium chat requests available to the user' };\n\tquotaCompletions: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of inline suggestions available to the user' };\n\tquotaResetDate: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The date the quota will reset' };\n\towner: 'bpasero';\n\tcomment: 'Reporting chat entitlements';\n};\n\ntype EntitlementEvent = {\n\tentitlement: ChatEntitlement;\n\ttid: string;\n\tsku: string | undefined;\n\tquotaChat: number | undefined;\n\tquotaPremiumChat: number | undefined;\n\tquotaCompletions: number | undefined;\n\tquotaResetDate: string | undefined;\n};\n\ninterface IQuotaSnapshotResponse {\n\treadonly entitlement: number;\n\treadonly overage_count: number;\n\treadonly overage_permitted: boolean;\n\treadonly percent_remaining: number;\n\treadonly remaining: number;\n\treadonly unlimited: boolean;\n}\n\ninterface ILegacyQuotaSnapshotResponse {\n\treadonly limited_user_quotas?: {\n\t\treadonly chat: number;\n\t\treadonly completions: number;\n\t};\n\treadonly monthly_quotas?: {\n\t\treadonly chat: number;\n\t\treadonly completions: number;\n\t};\n}\n\ninterface IEntitlementsResponse extends ILegacyQuotaSnapshotResponse {\n\treadonly access_type_sku: string;\n\treadonly assigned_date: string;\n\treadonly can_signup_for_limited: boolean;\n\treadonly chat_enabled: boolean;\n\treadonly copilot_plan: string;\n\treadonly organization_login_list: string[];\n\treadonly analytics_tracking_id: string;\n\treadonly limited_user_reset_date?: string; \t// for Copilot Free\n\treadonly quota_reset_date?: string; \t\t// for all other Copilot SKUs\n\treadonly quota_reset_date_utc?: string; \t// for all other Copilot SKUs (includes time)\n\treadonly quota_snapshots?: {\n\t\tchat?: IQuotaSnapshotResponse;\n\t\tcompletions?: IQuotaSnapshotResponse;\n\t\tpremium_interactions?: IQuotaSnapshotResponse;\n\t};\n}\n\ninterface IEntitlements {\n\treadonly entitlement: ChatEntitlement;\n\treadonly organisations?: string[];\n\treadonly sku?: string;\n\treadonly quotas?: IQuotas;\n}\n\nexport interface IQuotaSnapshot {\n\treadonly total: number;\n\n\treadonly remaining: number;\n\treadonly percentRemaining: number;\n\n\treadonly overageEnabled: boolean;\n\treadonly overageCount: number;\n\n\treadonly unlimited: boolean;\n}\n\ninterface IQuotas {\n\treadonly resetDate?: string;\n\treadonly resetDateHasTime?: boolean;\n\n\treadonly chat?: IQuotaSnapshot;\n\treadonly completions?: IQuotaSnapshot;\n\treadonly premiumChat?: IQuotaSnapshot;\n}\n\nexport class ChatEntitlementRequests extends Disposable {\n\n\tstatic providerId(configurationService: IConfigurationService): string {\n\t\tif (configurationService.getValue<string | undefined>(`${defaultChat.completionsAdvancedSetting}.authProvider`) === defaultChat.provider.enterprise.id) {\n\t\t\treturn defaultChat.provider.enterprise.id;\n\t\t}\n\n\t\treturn defaultChat.provider.default.id;\n\t}\n\n\tprivate state: IEntitlements;\n\n\tprivate pendingResolveCts = new CancellationTokenSource();\n\tprivate didResolveEntitlements = false;\n\n\tconstructor(\n\t\tprivate readonly context: ChatEntitlementContext,\n\t\tprivate readonly chatQuotasAccessor: IChatQuotasAccessor,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IAuthenticationService private readonly authenticationService: IAuthenticationService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IRequestService private readonly requestService: IRequestService,\n\t\t@IDialogService private readonly dialogService: IDialogService,\n\t\t@IOpenerService private readonly openerService: IOpenerService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IAuthenticationExtensionsService private readonly authenticationExtensionsService: IAuthenticationExtensionsService,\n\t\t@ILifecycleService private readonly lifecycleService: ILifecycleService,\n\t\t@IPukuAuthService private readonly pukuAuthService: IPukuAuthService,\n\t\t@ICommandService private readonly commandService: ICommandService,\n\t) {\n\t\tsuper();\n\n\t\tthis.state = { entitlement: this.context.state.entitlement };\n\n\t\tthis.registerListeners();\n\n\t\tthis.resolve();\n\t}\n\n\tprivate registerListeners(): void {\n\t\tthis._register(this.authenticationService.onDidChangeDeclaredProviders(() => this.resolve()));\n\n\t\tthis._register(this.authenticationService.onDidChangeSessions(e => {\n\t\t\tif (e.providerId === ChatEntitlementRequests.providerId(this.configurationService)) {\n\t\t\t\tthis.resolve();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this.authenticationService.onDidRegisterAuthenticationProvider(e => {\n\t\t\tif (e.id === ChatEntitlementRequests.providerId(this.configurationService)) {\n\t\t\t\tthis.resolve();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this.authenticationService.onDidUnregisterAuthenticationProvider(e => {\n\t\t\tif (e.id === ChatEntitlementRequests.providerId(this.configurationService)) {\n\t\t\t\tthis.resolve();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this.context.onDidChange(() => {\n\t\t\tif (!this.context.state.installed || this.context.state.disabled || this.context.state.entitlement === ChatEntitlement.Unknown) {\n\t\t\t\t// When the extension is not installed, disabled or the user is not entitled\n\t\t\t\t// make sure to clear quotas so that any indicators are also gone\n\t\t\t\tthis.state = { entitlement: this.state.entitlement, quotas: undefined };\n\t\t\t\tthis.chatQuotasAccessor.clearQuotas();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate async resolve(): Promise<void> {\n\t\tthis.pendingResolveCts.dispose(true);\n\t\tconst cts = this.pendingResolveCts = new CancellationTokenSource();\n\n\t\t// Check if authenticated with Puku first - if so, skip GitHub session lookup\n\t\tif (this.pukuAuthService.isAuthenticated()) {\n\t\t\tthis.logService.info('[chat entitlement] Using Puku authentication, skipping GitHub session lookup');\n\t\t\t// Keep current entitlement state (should be Free from Puku sign-in)\n\t\t\treturn;\n\t\t}\n\n\t\tconst session = await this.findMatchingProviderSession(cts.token);\n\t\tif (cts.token.isCancellationRequested) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Immediately signal whether we have a session or not\n\t\tlet state: IEntitlements | undefined = undefined;\n\t\tif (session) {\n\t\t\t// Do not overwrite any state we have already\n\t\t\tif (this.state.entitlement === ChatEntitlement.Unknown) {\n\t\t\t\tstate = { entitlement: ChatEntitlement.Unresolved };\n\t\t\t}\n\t\t} else {\n\t\t\tthis.didResolveEntitlements = false; // reset so that we resolve entitlements fresh when signed in again\n\t\t\tstate = { entitlement: ChatEntitlement.Unknown };\n\t\t}\n\t\tif (state) {\n\t\t\tthis.update(state);\n\t\t}\n\n\t\tif (session && !this.didResolveEntitlements) {\n\t\t\t// Afterwards resolve entitlement with a network request\n\t\t\t// but only unless it was not already resolved before.\n\t\t\tawait this.resolveEntitlement(session, cts.token);\n\t\t}\n\t}\n\n\tprivate async findMatchingProviderSession(token: CancellationToken): Promise<AuthenticationSession[] | undefined> {\n\t\t// Never trigger GitHub auth if Puku is authenticated\n\t\tif (this.pukuAuthService.isAuthenticated()) {\n\t\t\tthis.logService.info('[chat entitlement] findMatchingProviderSession: Puku authenticated, returning empty');\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst sessions = await this.doGetSessions(ChatEntitlementRequests.providerId(this.configurationService));\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst matchingSessions = new Set<AuthenticationSession>();\n\t\tfor (const session of sessions) {\n\t\t\tfor (const scopes of defaultChat.providerScopes) {\n\t\t\t\tif (this.includesScopes(session.scopes, scopes)) {\n\t\t\t\t\tmatchingSessions.add(session);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// We intentionally want to return an array of matching sessions and\n\t\t// not just the first, because it is possible that a matching session\n\t\t// has an expired token. As such, we want to try them all until we\n\t\t// succeeded with the request.\n\t\treturn matchingSessions.size > 0 ? Array.from(matchingSessions) : undefined;\n\t}\n\n\tprivate async doGetSessions(providerId: string): Promise<readonly AuthenticationSession[]> {\n\t\tconst preferredAccountName = this.authenticationExtensionsService.getAccountPreference(defaultChat.chatExtensionId, providerId) ?? this.authenticationExtensionsService.getAccountPreference(defaultChat.extensionId, providerId);\n\t\tlet preferredAccount: AuthenticationSessionAccount | undefined;\n\t\tfor (const account of await this.authenticationService.getAccounts(providerId)) {\n\t\t\tif (account.label === preferredAccountName) {\n\t\t\t\tpreferredAccount = account;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\treturn await this.authenticationService.getSessions(providerId, undefined, { account: preferredAccount });\n\t\t} catch (error) {\n\t\t\t// ignore - errors can throw if a provider is not registered\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tprivate includesScopes(scopes: ReadonlyArray<string>, expectedScopes: string[]): boolean {\n\t\treturn expectedScopes.every(scope => scopes.includes(scope));\n\t}\n\n\tprivate async resolveEntitlement(sessions: AuthenticationSession[], token: CancellationToken): Promise<IEntitlements | undefined> {\n\t\tconst entitlements = await this.doResolveEntitlement(sessions, token);\n\t\tif (typeof entitlements?.entitlement === 'number' && !token.isCancellationRequested) {\n\t\t\tthis.didResolveEntitlements = true;\n\t\t\tthis.update(entitlements);\n\t\t}\n\n\t\treturn entitlements;\n\t}\n\n\tprivate async doResolveEntitlement(sessions: AuthenticationSession[], token: CancellationToken): Promise<IEntitlements | undefined> {\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst response = await this.request(this.getEntitlementUrl(), 'GET', undefined, sessions, token);\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!response) {\n\t\t\tthis.logService.trace('[chat entitlement]: no response');\n\t\t\treturn { entitlement: ChatEntitlement.Unresolved };\n\t\t}\n\n\t\tif (response.res.statusCode && response.res.statusCode !== 200) {\n\t\t\tthis.logService.trace(`[chat entitlement]: unexpected status code ${response.res.statusCode}`);\n\t\t\treturn (\n\t\t\t\tresponse.res.statusCode === 401 || \t// oauth token being unavailable (expired/revoked)\n\t\t\t\tresponse.res.statusCode === 404\t\t// missing scopes/permissions, service pretends the endpoint doesn't exist\n\t\t\t) ? { entitlement: ChatEntitlement.Unknown /* treat as signed out */ } : { entitlement: ChatEntitlement.Unresolved };\n\t\t}\n\n\t\tlet responseText: string | null = null;\n\t\ttry {\n\t\t\tresponseText = await asText(response);\n\t\t} catch (error) {\n\t\t\t// ignore - handled below\n\t\t}\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!responseText) {\n\t\t\tthis.logService.trace('[chat entitlement]: response has no content');\n\t\t\treturn { entitlement: ChatEntitlement.Unresolved };\n\t\t}\n\n\t\tlet entitlementsResponse: IEntitlementsResponse;\n\t\ttry {\n\t\t\tentitlementsResponse = JSON.parse(responseText);\n\t\t\tthis.logService.trace(`[chat entitlement]: parsed result is ${JSON.stringify(entitlementsResponse)}`);\n\t\t} catch (err) {\n\t\t\tthis.logService.trace(`[chat entitlement]: error parsing response (${err})`);\n\t\t\treturn { entitlement: ChatEntitlement.Unresolved };\n\t\t}\n\n\t\tlet entitlement: ChatEntitlement;\n\t\tif (entitlementsResponse.access_type_sku === 'free_limited_copilot') {\n\t\t\tentitlement = ChatEntitlement.Free;\n\t\t} else if (entitlementsResponse.can_signup_for_limited) {\n\t\t\tentitlement = ChatEntitlement.Available;\n\t\t} else if (entitlementsResponse.copilot_plan === 'individual') {\n\t\t\tentitlement = ChatEntitlement.Pro;\n\t\t} else if (entitlementsResponse.copilot_plan === 'individual_pro') {\n\t\t\tentitlement = ChatEntitlement.ProPlus;\n\t\t} else if (entitlementsResponse.copilot_plan === 'business') {\n\t\t\tentitlement = ChatEntitlement.Business;\n\t\t} else if (entitlementsResponse.copilot_plan === 'enterprise') {\n\t\t\tentitlement = ChatEntitlement.Enterprise;\n\t\t} else if (entitlementsResponse.chat_enabled) {\n\t\t\t// This should never happen as we exhaustively list the plans above. But if a new plan is added in the future older clients won't break\n\t\t\tentitlement = ChatEntitlement.Pro;\n\t\t} else {\n\t\t\tentitlement = ChatEntitlement.Unavailable;\n\t\t}\n\n\t\tconst entitlements: IEntitlements = {\n\t\t\tentitlement,\n\t\t\torganisations: entitlementsResponse.organization_login_list,\n\t\t\tquotas: this.toQuotas(entitlementsResponse),\n\t\t\tsku: entitlementsResponse.access_type_sku\n\t\t};\n\n\t\tthis.logService.trace(`[chat entitlement]: resolved to ${entitlements.entitlement}, quotas: ${JSON.stringify(entitlements.quotas)}`);\n\t\tthis.telemetryService.publicLog2<EntitlementEvent, EntitlementClassification>('chatInstallEntitlement', {\n\t\t\tentitlement: entitlements.entitlement,\n\t\t\ttid: entitlementsResponse.analytics_tracking_id,\n\t\t\tsku: entitlements.sku,\n\t\t\tquotaChat: entitlements.quotas?.chat?.remaining,\n\t\t\tquotaPremiumChat: entitlements.quotas?.premiumChat?.remaining,\n\t\t\tquotaCompletions: entitlements.quotas?.completions?.remaining,\n\t\t\tquotaResetDate: entitlements.quotas?.resetDate\n\t\t});\n\n\t\treturn entitlements;\n\t}\n\n\tprivate getEntitlementUrl(): string {\n\t\tif (ChatEntitlementRequests.providerId(this.configurationService) === defaultChat.provider.enterprise.id) {\n\t\t\ttry {\n\t\t\t\tconst enterpriseUrl = new URL(this.configurationService.getValue(defaultChat.providerUriSetting));\n\t\t\t\treturn `${enterpriseUrl.protocol}//api.${enterpriseUrl.hostname}${enterpriseUrl.port ? ':' + enterpriseUrl.port : ''}/copilot_internal/user`;\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t}\n\t\t}\n\n\t\treturn defaultChat.entitlementUrl;\n\t}\n\n\tprivate toQuotas(response: IEntitlementsResponse): IQuotas {\n\t\tconst quotas: Mutable<IQuotas> = {\n\t\t\tresetDate: response.quota_reset_date_utc ?? response.quota_reset_date ?? response.limited_user_reset_date,\n\t\t\tresetDateHasTime: typeof response.quota_reset_date_utc === 'string',\n\t\t};\n\n\t\t// Legacy Free SKU Quota\n\t\tif (response.monthly_quotas?.chat && typeof response.limited_user_quotas?.chat === 'number') {\n\t\t\tquotas.chat = {\n\t\t\t\ttotal: response.monthly_quotas.chat,\n\t\t\t\tremaining: response.limited_user_quotas.chat,\n\t\t\t\tpercentRemaining: Math.min(100, Math.max(0, (response.limited_user_quotas.chat / response.monthly_quotas.chat) * 100)),\n\t\t\t\toverageEnabled: false,\n\t\t\t\toverageCount: 0,\n\t\t\t\tunlimited: false\n\t\t\t};\n\t\t}\n\n\t\tif (response.monthly_quotas?.completions && typeof response.limited_user_quotas?.completions === 'number') {\n\t\t\tquotas.completions = {\n\t\t\t\ttotal: response.monthly_quotas.completions,\n\t\t\t\tremaining: response.limited_user_quotas.completions,\n\t\t\t\tpercentRemaining: Math.min(100, Math.max(0, (response.limited_user_quotas.completions / response.monthly_quotas.completions) * 100)),\n\t\t\t\toverageEnabled: false,\n\t\t\t\toverageCount: 0,\n\t\t\t\tunlimited: false\n\t\t\t};\n\t\t}\n\n\t\t// New Quota Snapshot\n\t\tif (response.quota_snapshots) {\n\t\t\tfor (const quotaType of ['chat', 'completions', 'premium_interactions'] as const) {\n\t\t\t\tconst rawQuotaSnapshot = response.quota_snapshots[quotaType];\n\t\t\t\tif (!rawQuotaSnapshot) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst quotaSnapshot: IQuotaSnapshot = {\n\t\t\t\t\ttotal: rawQuotaSnapshot.entitlement,\n\t\t\t\t\tremaining: rawQuotaSnapshot.remaining,\n\t\t\t\t\tpercentRemaining: Math.min(100, Math.max(0, rawQuotaSnapshot.percent_remaining)),\n\t\t\t\t\toverageEnabled: rawQuotaSnapshot.overage_permitted,\n\t\t\t\t\toverageCount: rawQuotaSnapshot.overage_count,\n\t\t\t\t\tunlimited: rawQuotaSnapshot.unlimited\n\t\t\t\t};\n\n\t\t\t\tswitch (quotaType) {\n\t\t\t\t\tcase 'chat':\n\t\t\t\t\t\tquotas.chat = quotaSnapshot;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'completions':\n\t\t\t\t\t\tquotas.completions = quotaSnapshot;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'premium_interactions':\n\t\t\t\t\t\tquotas.premiumChat = quotaSnapshot;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn quotas;\n\t}\n\n\t/**\n\t * Fetch usage quotas from Puku API\n\t */\n\tasync fetchPukuQuotas(): Promise<void> {\n\t\tconst sessionToken = this.pukuAuthService.getSessionToken();\n\t\tif (!sessionToken) {\n\t\t\tthis.logService.warn('[chat entitlement] No Puku session token available');\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tthis.logService.info('[chat entitlement] Fetching quotas from Puku API');\n\t\t\tconst response = await this.requestService.request({\n\t\t\t\ttype: 'GET',\n\t\t\t\turl: 'https://api.puku.sh/puku/v1/usage',\n\t\t\t\theaders: {\n\t\t\t\t\t'Authorization': `Bearer ${sessionToken}`,\n\t\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t},\n\t\t\t}, CancellationToken.None);\n\n\t\t\tif (!response.res.statusCode || response.res.statusCode !== 200) {\n\t\t\t\tthis.logService.warn(`[chat entitlement] Puku usage endpoint returned ${response.res.statusCode}`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst responseText = await asText(response);\n\t\t\tif (!responseText) {\n\t\t\t\tthis.logService.warn('[chat entitlement] Empty response from Puku usage endpoint');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst usageData = JSON.parse(responseText);\n\t\t\tthis.logService.info('[chat entitlement] Puku usage data:', JSON.stringify(usageData));\n\n\t\t\t// Update quotas if available\n\t\t\tif (usageData.quotas) {\n\t\t\t\tthis.chatQuotasAccessor.acceptQuotas(usageData.quotas);\n\t\t\t\tthis.logService.info('[chat entitlement] Updated quotas from Puku API');\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error('[chat entitlement] Error fetching Puku quotas:', error);\n\t\t}\n\t}\n\n\tprivate async request(url: string, type: 'GET', body: undefined, sessions: AuthenticationSession[], token: CancellationToken): Promise<IRequestContext | undefined>;\n\tprivate async request(url: string, type: 'POST', body: object, sessions: AuthenticationSession[], token: CancellationToken): Promise<IRequestContext | undefined>;\n\tprivate async request(url: string, type: 'GET' | 'POST', body: object | undefined, sessions: AuthenticationSession[], token: CancellationToken): Promise<IRequestContext | undefined> {\n\t\tlet lastRequest: IRequestContext | undefined;\n\n\t\tfor (const session of sessions) {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn lastRequest;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst response = await this.requestService.request({\n\t\t\t\t\ttype,\n\t\t\t\t\turl,\n\t\t\t\t\tdata: type === 'POST' ? JSON.stringify(body) : undefined,\n\t\t\t\t\tdisableCache: true,\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t'Authorization': `Bearer ${session.accessToken}`\n\t\t\t\t\t}\n\t\t\t\t}, token);\n\n\t\t\t\tconst status = response.res.statusCode;\n\t\t\t\tif (status && status !== 200) {\n\t\t\t\t\tlastRequest = response;\n\t\t\t\t\tcontinue; // try next session\n\t\t\t\t}\n\n\t\t\t\treturn response;\n\t\t\t} catch (error) {\n\t\t\t\tif (!token.isCancellationRequested) {\n\t\t\t\t\tthis.logService.error(`[chat entitlement] request: error ${error}`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn lastRequest;\n\t}\n\n\tprivate update(state: IEntitlements): void {\n\t\tthis.state = state;\n\n\t\tthis.context.update({ entitlement: this.state.entitlement, organisations: this.state.organisations, sku: this.state.sku });\n\n\t\tif (state.quotas) {\n\t\t\tthis.chatQuotasAccessor.acceptQuotas(state.quotas);\n\t\t}\n\t}\n\n\tasync forceResolveEntitlement(sessions: AuthenticationSession[] | undefined, token = CancellationToken.None): Promise<IEntitlements | undefined> {\n\t\t// Skip GitHub authentication if Puku is authenticated\n\t\tif (this.pukuAuthService.isAuthenticated()) {\n\t\t\tthis.logService.info('[chat entitlement] forceResolveEntitlement: Using Puku authentication, skipping GitHub');\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!sessions) {\n\t\t\tsessions = await this.findMatchingProviderSession(token);\n\t\t}\n\n\t\tif (!sessions || sessions.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn this.resolveEntitlement(sessions, token);\n\t}\n\n\tasync signUpFree(sessions: AuthenticationSession[]): Promise<true /* signed up */ | false /* already signed up */ | { errorCode: number } /* error */> {\n\t\tconst body = {\n\t\t\trestricted_telemetry: this.telemetryService.telemetryLevel === TelemetryLevel.NONE ? 'disabled' : 'enabled',\n\t\t\tpublic_code_suggestions: 'enabled'\n\t\t};\n\n\t\tconst response = await this.request(defaultChat.entitlementSignupLimitedUrl, 'POST', body, sessions, CancellationToken.None);\n\t\tif (!response) {\n\t\t\tconst retry = await this.onUnknownSignUpError(localize('signUpNoResponseError', \"No response received.\"), '[chat entitlement] sign-up: no response');\n\t\t\treturn retry ? this.signUpFree(sessions) : { errorCode: 1 };\n\t\t}\n\n\t\tif (response.res.statusCode && response.res.statusCode !== 200) {\n\t\t\tif (response.res.statusCode === 422) {\n\t\t\t\ttry {\n\t\t\t\t\tconst responseText = await asText(response);\n\t\t\t\t\tif (responseText) {\n\t\t\t\t\t\tconst responseError: { message: string } = JSON.parse(responseText);\n\t\t\t\t\t\tif (typeof responseError.message === 'string' && responseError.message) {\n\t\t\t\t\t\t\tthis.onUnprocessableSignUpError(`[chat entitlement] sign-up: unprocessable entity (${responseError.message})`, responseError.message);\n\t\t\t\t\t\t\treturn { errorCode: response.res.statusCode };\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\t// ignore - handled below\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst retry = await this.onUnknownSignUpError(localize('signUpUnexpectedStatusError', \"Unexpected status code {0}.\", response.res.statusCode), `[chat entitlement] sign-up: unexpected status code ${response.res.statusCode}`);\n\t\t\treturn retry ? this.signUpFree(sessions) : { errorCode: response.res.statusCode };\n\t\t}\n\n\t\tlet responseText: string | null = null;\n\t\ttry {\n\t\t\tresponseText = await asText(response);\n\t\t} catch (error) {\n\t\t\t// ignore - handled below\n\t\t}\n\n\t\tif (!responseText) {\n\t\t\tconst retry = await this.onUnknownSignUpError(localize('signUpNoResponseContentsError', \"Response has no contents.\"), '[chat entitlement] sign-up: response has no content');\n\t\t\treturn retry ? this.signUpFree(sessions) : { errorCode: 2 };\n\t\t}\n\n\t\tlet parsedResult: { subscribed: boolean } | undefined = undefined;\n\t\ttry {\n\t\t\tparsedResult = JSON.parse(responseText);\n\t\t\tthis.logService.trace(`[chat entitlement] sign-up: response is ${responseText}`);\n\t\t} catch (err) {\n\t\t\tconst retry = await this.onUnknownSignUpError(localize('signUpInvalidResponseError', \"Invalid response contents.\"), `[chat entitlement] sign-up: error parsing response (${err})`);\n\t\t\treturn retry ? this.signUpFree(sessions) : { errorCode: 3 };\n\t\t}\n\n\t\t// We have made it this far, so the user either did sign-up or was signed-up already.\n\t\t// That is, because the endpoint throws in all other case according to Patrick.\n\t\tthis.update({ entitlement: ChatEntitlement.Free });\n\n\t\treturn Boolean(parsedResult?.subscribed);\n\t}\n\n\tprivate async onUnknownSignUpError(detail: string, logMessage: string): Promise<boolean> {\n\t\tthis.logService.error(logMessage);\n\n\t\tif (!this.lifecycleService.willShutdown) {\n\t\t\tconst { confirmed } = await this.dialogService.confirm({\n\t\t\t\ttype: Severity.Error,\n\t\t\t\tmessage: localize('unknownSignUpError', \"An error occurred while signing up for the GitHub Copilot Free plan. Would you like to try again?\"),\n\t\t\t\tdetail,\n\t\t\t\tprimaryButton: localize('retry', \"Retry\")\n\t\t\t});\n\n\t\t\treturn confirmed;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tprivate onUnprocessableSignUpError(logMessage: string, logDetails: string): void {\n\t\tthis.logService.error(logMessage);\n\n\t\tif (!this.lifecycleService.willShutdown) {\n\t\t\tthis.dialogService.prompt({\n\t\t\t\ttype: Severity.Error,\n\t\t\t\tmessage: localize('unprocessableSignUpError', \"An error occurred while signing up for the GitHub Copilot Free plan.\"),\n\t\t\t\tdetail: logDetails,\n\t\t\t\tbuttons: [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: localize('ok', \"OK\"),\n\t\t\t\t\t\trun: () => { /* noop */ }\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: localize('learnMore', \"Learn More\"),\n\t\t\t\t\t\trun: () => this.openerService.open(URI.parse(defaultChat.upgradePlanUrl))\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\t\t}\n\t}\n\n\tasync signIn(options?: { useSocialProvider?: string; additionalScopes?: readonly string[] }) {\n\t\t// Use Puku auth for Google sign-in\n\t\tif (options?.useSocialProvider === 'google') {\n\t\t\tthis.logService.info('[chat entitlement] Using Puku auth for Google sign-in');\n\t\t\tconst session = await this.pukuAuthService.signInWithGoogle();\n\n\t\t\t// For Puku auth, we set entitlement to Free by default\n\t\t\t// The actual entitlement will be resolved from Puku's token endpoint\n\t\t\tconst entitlements = { entitlement: ChatEntitlement.Free, organisations: undefined, sku: undefined };\n\t\t\tthis.update(entitlements);\n\n\t\t\t// Notify extension layer that auth state changed (optional - extension may not be loaded yet)\n\t\t\ttry {\n\t\t\t\tawait this.commandService.executeCommand('_puku.refreshAuth');\n\t\t\t\tthis.logService.info('[chat entitlement] Notified extension layer of auth change');\n\t\t\t} catch (error) {\n\t\t\t\t// Extension not loaded yet - this is fine, auth state will sync when it loads\n\t\t\t\tthis.logService.trace('[chat entitlement] Extension notification skipped (extension may not be loaded yet)');\n\t\t\t}\n\n\t\t\treturn { session, entitlements };\n\t\t}\n\n\t\t// Original flow for GitHub auth (or other providers)\n\t\tconst providerId = ChatEntitlementRequests.providerId(this.configurationService);\n\n\t\tlet defaultProviderScopes: string[];\n\t\tif (this.configurationService.getValue<unknown>('chat.signInWithAlternateScopes') === true) {\n\t\t\tdefaultProviderScopes = defaultChat.providerScopes.at(-1) ?? [];\n\t\t} else {\n\t\t\tdefaultProviderScopes = defaultChat.providerScopes.at(0) ?? [];\n\t\t}\n\n\t\tconst scopes = options?.additionalScopes ? distinct([...defaultProviderScopes, ...options.additionalScopes]) : defaultProviderScopes;\n\t\tconst session = await this.authenticationService.createSession(\n\t\t\tproviderId,\n\t\t\tscopes,\n\t\t\t{\n\t\t\t\textraAuthorizeParameters: { get_started_with: 'copilot-vscode' },\n\t\t\t\tprovider: options?.useSocialProvider\n\t\t\t});\n\n\t\tthis.authenticationExtensionsService.updateAccountPreference(defaultChat.extensionId, providerId, session.account);\n\t\tthis.authenticationExtensionsService.updateAccountPreference(defaultChat.chatExtensionId, providerId, session.account);\n\n\t\tconst entitlements = await this.forceResolveEntitlement([session]);\n\n\t\treturn { session, entitlements };\n\t}\n\n\toverride dispose(): void {\n\t\tthis.pendingResolveCts.dispose(true);\n\n\t\tsuper.dispose();\n\t}\n}\n\n//#endregion\n\n//#region Context\n\nexport interface IChatEntitlementContextState extends IChatSentiment {\n\n\t/**\n\t * Users last known or resolved entitlement.\n\t */\n\tentitlement: ChatEntitlement;\n\n\t/**\n\t * User's last known or resolved raw SKU type.\n\t */\n\tsku: string | undefined;\n\n\t/**\n\t * User's last known or resolved organisations.\n\t */\n\torganisations: string[] | undefined;\n\n\t/**\n\t * User is or was a registered Chat user.\n\t */\n\tregistered?: boolean;\n}\n\ntype ChatEntitlementClassification = {\n\towner: 'bpasero';\n\tcomment: 'Provides insight into chat entitlements.';\n\tchatHidden: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether chat is hidden or not.' };\n\tchatEntitlement: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The current chat entitlement of the user.' };\n\tchatAnonymous: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the user is anonymously using chat.' };\n\tchatRegistered: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the user is registered for chat.' };\n\tchatDisabled: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether chat is disabled or not.' };\n};\ntype ChatEntitlementEvent = {\n\tchatHidden: boolean;\n\tchatEntitlement: ChatEntitlement;\n\tchatAnonymous: boolean;\n\tchatRegistered: boolean;\n\tchatDisabled: boolean;\n};\n\nexport class ChatEntitlementContext extends Disposable {\n\n\tprivate static readonly CHAT_ENTITLEMENT_CONTEXT_STORAGE_KEY = 'chat.setupContext';\n\n\tprivate static readonly CHAT_DISABLED_CONFIGURATION_KEY = 'chat.disableAIFeatures';\n\n\tprivate readonly canSignUpContextKey: IContextKey<boolean>;\n\tprivate readonly signedOutContextKey: IContextKey<boolean>;\n\n\tprivate readonly freeContextKey: IContextKey<boolean>;\n\tprivate readonly proContextKey: IContextKey<boolean>;\n\tprivate readonly proPlusContextKey: IContextKey<boolean>;\n\tprivate readonly businessContextKey: IContextKey<boolean>;\n\tprivate readonly enterpriseContextKey: IContextKey<boolean>;\n\n\tprivate readonly organisationsContextKey: IContextKey<string[] | undefined>;\n\tprivate readonly isInternalContextKey: IContextKey<boolean>;\n\tprivate readonly skuContextKey: IContextKey<string | undefined>;\n\n\tprivate readonly hiddenContext: IContextKey<boolean>;\n\tprivate readonly laterContext: IContextKey<boolean>;\n\tprivate readonly installedContext: IContextKey<boolean>;\n\tprivate readonly disabledContext: IContextKey<boolean>;\n\tprivate readonly untrustedContext: IContextKey<boolean>;\n\tprivate readonly registeredContext: IContextKey<boolean>;\n\n\tprivate _state: IChatEntitlementContextState;\n\tprivate suspendedState: IChatEntitlementContextState | undefined = undefined;\n\tget state(): IChatEntitlementContextState { return this.withConfiguration(this.suspendedState ?? this._state); }\n\n\tprivate readonly _onDidChange = this._register(new Emitter<void>());\n\treadonly onDidChange = this._onDidChange.event;\n\n\tprivate updateBarrier: Barrier | undefined = undefined;\n\n\tconstructor(\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService\n\t) {\n\t\tsuper();\n\n\t\tthis.canSignUpContextKey = ChatEntitlementContextKeys.Entitlement.canSignUp.bindTo(contextKeyService);\n\t\tthis.signedOutContextKey = ChatEntitlementContextKeys.Entitlement.signedOut.bindTo(contextKeyService);\n\n\t\tthis.freeContextKey = ChatEntitlementContextKeys.Entitlement.planFree.bindTo(contextKeyService);\n\t\tthis.proContextKey = ChatEntitlementContextKeys.Entitlement.planPro.bindTo(contextKeyService);\n\t\tthis.proPlusContextKey = ChatEntitlementContextKeys.Entitlement.planProPlus.bindTo(contextKeyService);\n\t\tthis.businessContextKey = ChatEntitlementContextKeys.Entitlement.planBusiness.bindTo(contextKeyService);\n\t\tthis.enterpriseContextKey = ChatEntitlementContextKeys.Entitlement.planEnterprise.bindTo(contextKeyService);\n\n\t\tthis.organisationsContextKey = ChatEntitlementContextKeys.Entitlement.organisations.bindTo(contextKeyService);\n\t\tthis.isInternalContextKey = ChatEntitlementContextKeys.Entitlement.internal.bindTo(contextKeyService);\n\t\tthis.skuContextKey = ChatEntitlementContextKeys.Entitlement.sku.bindTo(contextKeyService);\n\n\t\tthis.hiddenContext = ChatEntitlementContextKeys.Setup.hidden.bindTo(contextKeyService);\n\t\tthis.laterContext = ChatEntitlementContextKeys.Setup.later.bindTo(contextKeyService);\n\t\tthis.installedContext = ChatEntitlementContextKeys.Setup.installed.bindTo(contextKeyService);\n\t\tthis.disabledContext = ChatEntitlementContextKeys.Setup.disabled.bindTo(contextKeyService);\n\t\tthis.untrustedContext = ChatEntitlementContextKeys.Setup.untrusted.bindTo(contextKeyService);\n\t\tthis.registeredContext = ChatEntitlementContextKeys.Setup.registered.bindTo(contextKeyService);\n\n\t\tthis._state = this.storageService.getObject<IChatEntitlementContextState>(ChatEntitlementContext.CHAT_ENTITLEMENT_CONTEXT_STORAGE_KEY, StorageScope.PROFILE) ?? { entitlement: ChatEntitlement.Unknown, organisations: undefined, sku: undefined };\n\n\t\tthis.updateContextSync();\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\t\tthis._register(this.configurationService.onDidChangeConfiguration(e => {\n\t\t\tif (e.affectsConfiguration(ChatEntitlementContext.CHAT_DISABLED_CONFIGURATION_KEY)) {\n\t\t\t\tthis.updateContext();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate withConfiguration(state: IChatEntitlementContextState): IChatEntitlementContextState {\n\t\tif (this.configurationService.getValue(ChatEntitlementContext.CHAT_DISABLED_CONFIGURATION_KEY) === true) {\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\thidden: true // Setting always wins: if AI is disabled, set `hidden: true`\n\t\t\t};\n\t\t}\n\n\t\treturn state;\n\t}\n\n\tupdate(context: { installed: boolean; disabled: boolean; untrusted: boolean }): Promise<void>;\n\tupdate(context: { hidden: false }): Promise<void>; // legacy UI state from before we had a setting to hide, keep around to still support users who used this\n\tupdate(context: { later: boolean }): Promise<void>;\n\tupdate(context: { entitlement: ChatEntitlement; organisations: string[] | undefined; sku: string | undefined }): Promise<void>;\n\tasync update(context: { installed?: boolean; disabled?: boolean; untrusted?: boolean; hidden?: false; later?: boolean; entitlement?: ChatEntitlement; organisations?: string[]; sku?: string }): Promise<void> {\n\t\tthis.logService.trace(`[chat entitlement context] update(): ${JSON.stringify(context)}`);\n\n\t\tconst oldState = JSON.stringify(this._state);\n\n\t\tif (typeof context.installed === 'boolean' && typeof context.disabled === 'boolean' && typeof context.untrusted === 'boolean') {\n\t\t\tthis._state.installed = context.installed;\n\t\t\tthis._state.disabled = context.disabled;\n\t\t\tthis._state.untrusted = context.untrusted;\n\n\t\t\tif (context.installed && !context.disabled) {\n\t\t\t\tcontext.hidden = false; // treat this as a sign to make Chat visible again in case it is hidden\n\t\t\t}\n\t\t}\n\n\t\tif (typeof context.hidden === 'boolean') {\n\t\t\tthis._state.hidden = context.hidden;\n\t\t}\n\n\t\tif (typeof context.later === 'boolean') {\n\t\t\tthis._state.later = context.later;\n\t\t}\n\n\t\tif (typeof context.entitlement === 'number') {\n\t\t\tthis._state.entitlement = context.entitlement;\n\t\t\tthis._state.organisations = context.organisations;\n\t\t\tthis._state.sku = context.sku;\n\n\t\t\tif (this._state.entitlement === ChatEntitlement.Free || isProUser(this._state.entitlement)) {\n\t\t\t\tthis._state.registered = true;\n\t\t\t} else if (this._state.entitlement === ChatEntitlement.Available) {\n\t\t\t\tthis._state.registered = false; // only reset when signed-in user can sign-up for free\n\t\t\t}\n\t\t}\n\n\t\tif (oldState === JSON.stringify(this._state)) {\n\t\t\treturn; // state did not change\n\t\t}\n\n\t\tthis.storageService.store(ChatEntitlementContext.CHAT_ENTITLEMENT_CONTEXT_STORAGE_KEY, {\n\t\t\t...this._state,\n\t\t\tlater: undefined // do not persist this across restarts for now\n\t\t}, StorageScope.PROFILE, StorageTarget.MACHINE);\n\n\t\treturn this.updateContext();\n\t}\n\n\tprivate async updateContext(): Promise<void> {\n\t\tawait this.updateBarrier?.wait();\n\n\t\tthis.updateContextSync();\n\t}\n\n\tprivate updateContextSync(): void {\n\t\tconst state = this.withConfiguration(this._state);\n\n\t\tthis.signedOutContextKey.set(state.entitlement === ChatEntitlement.Unknown);\n\t\tthis.canSignUpContextKey.set(state.entitlement === ChatEntitlement.Available);\n\n\t\tthis.freeContextKey.set(state.entitlement === ChatEntitlement.Free);\n\t\tthis.proContextKey.set(state.entitlement === ChatEntitlement.Pro);\n\t\tthis.proPlusContextKey.set(state.entitlement === ChatEntitlement.ProPlus);\n\t\tthis.businessContextKey.set(state.entitlement === ChatEntitlement.Business);\n\t\tthis.enterpriseContextKey.set(state.entitlement === ChatEntitlement.Enterprise);\n\n\t\tthis.organisationsContextKey.set(state.organisations);\n\t\tthis.isInternalContextKey.set(Boolean(state.organisations?.some(org => org === 'github' || org === 'microsoft' || org === 'ms-copilot' || org === 'MicrosoftCopilot')));\n\t\tthis.skuContextKey.set(state.sku);\n\n\t\tthis.hiddenContext.set(!!state.hidden);\n\t\tthis.laterContext.set(!!state.later);\n\t\tthis.installedContext.set(!!state.installed);\n\t\tthis.disabledContext.set(!!state.disabled);\n\t\tthis.untrustedContext.set(!!state.untrusted);\n\t\tthis.registeredContext.set(!!state.registered);\n\n\t\tthis.logService.trace(`[chat entitlement context] updateContext(): ${JSON.stringify(state)}`);\n\t\tlogChatEntitlements(state, this.configurationService, this.telemetryService);\n\n\t\tthis._onDidChange.fire();\n\t}\n\n\tsuspend(): void {\n\t\tthis.suspendedState = { ...this._state };\n\t\tthis.updateBarrier = new Barrier();\n\t}\n\n\tresume(): void {\n\t\tthis.suspendedState = undefined;\n\t\tthis.updateBarrier?.open();\n\t\tthis.updateBarrier = undefined;\n\t}\n}\n\n//#endregion\n\nregisterSingleton(IChatEntitlementService, ChatEntitlementService, InstantiationType.Eager /* To ensure context keys are set asap */);\n"]}