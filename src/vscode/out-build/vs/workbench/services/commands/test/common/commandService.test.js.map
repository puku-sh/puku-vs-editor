{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/commands/test/common/commandService.test.ts","vs/workbench/services/commands/test/common/commandService.test.ts"],"names":[],"mappings":"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","file":"commandService.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport assert from 'assert';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { CommandsRegistry } from '../../../../../platform/commands/common/commands.js';\nimport { InstantiationService } from '../../../../../platform/instantiation/common/instantiationService.js';\nimport { NullLogService } from '../../../../../platform/log/common/log.js';\nimport { NullExtensionService } from '../../../extensions/common/extensions.js';\nimport { CommandService } from '../../common/commandService.js';\n\nsuite('CommandService', function () {\n\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tsetup(function () {\n\t\tstore.add(CommandsRegistry.registerCommand('foo', function () { }));\n\t});\n\n\ttest('activateOnCommand', () => {\n\n\t\tlet lastEvent: string;\n\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\t\t\toverride activateByEvent(activationEvent: string): Promise<void> {\n\t\t\t\tlastEvent = activationEvent;\n\t\t\t\treturn super.activateByEvent(activationEvent);\n\t\t\t}\n\t\t}, new NullLogService()));\n\n\t\treturn service.executeCommand('foo').then(() => {\n\t\t\tassert.ok(lastEvent, 'onCommand:foo');\n\t\t\treturn service.executeCommand('unknownCommandId');\n\t\t}).then(() => {\n\t\t\tassert.ok(false);\n\t\t}, () => {\n\t\t\tassert.ok(lastEvent, 'onCommand:unknownCommandId');\n\t\t});\n\t});\n\n\ttest('fwd activation error', async function () {\n\n\t\tconst extensionService = new class extends NullExtensionService {\n\t\t\toverride activateByEvent(activationEvent: string): Promise<void> {\n\t\t\t\treturn Promise.reject(new Error('bad_activate'));\n\t\t\t}\n\t\t};\n\n\t\tconst service = store.add(new CommandService(new InstantiationService(), extensionService, new NullLogService()));\n\n\t\tawait extensionService.whenInstalledExtensionsRegistered();\n\n\t\treturn service.executeCommand('foo').then(() => assert.ok(false), err => {\n\t\t\tassert.strictEqual(err.message, 'bad_activate');\n\t\t});\n\t});\n\n\ttest('!onReady, but executeCommand', function () {\n\n\t\tlet callCounter = 0;\n\t\tconst reg = CommandsRegistry.registerCommand('bar', () => callCounter += 1);\n\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\t\t\toverride whenInstalledExtensionsRegistered() {\n\t\t\t\treturn new Promise<boolean>(_resolve => { /*ignore*/ });\n\t\t\t}\n\t\t}, new NullLogService()));\n\n\t\tservice.executeCommand('bar');\n\t\tassert.strictEqual(callCounter, 1);\n\t\treg.dispose();\n\t});\n\n\ttest('issue #34913: !onReady, unknown command', function () {\n\n\t\tlet callCounter = 0;\n\t\tlet resolveFunc: Function;\n\t\tconst whenInstalledExtensionsRegistered = new Promise<boolean>(_resolve => { resolveFunc = _resolve; });\n\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\t\t\toverride whenInstalledExtensionsRegistered() {\n\t\t\t\treturn whenInstalledExtensionsRegistered;\n\t\t\t}\n\t\t}, new NullLogService()));\n\n\t\tconst r = service.executeCommand('bar');\n\t\tassert.strictEqual(callCounter, 0);\n\n\t\tconst reg = CommandsRegistry.registerCommand('bar', () => callCounter += 1);\n\t\tresolveFunc!(true);\n\n\t\treturn r.then(() => {\n\t\t\treg.dispose();\n\t\t\tassert.strictEqual(callCounter, 1);\n\t\t});\n\t});\n\n\ttest('Stop waiting for * extensions to activate when trigger is satisfied #62457', function () {\n\n\t\tlet callCounter = 0;\n\t\tconst disposable = new DisposableStore();\n\t\tconst events: string[] = [];\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\n\t\t\toverride activateByEvent(event: string): Promise<void> {\n\t\t\t\tevents.push(event);\n\t\t\t\tif (event === '*') {\n\t\t\t\t\treturn new Promise(() => { }); //forever promise...\n\t\t\t\t}\n\t\t\t\tif (event.indexOf('onCommand:') === 0) {\n\t\t\t\t\treturn new Promise(resolve => {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tconst reg = CommandsRegistry.registerCommand(event.substr('onCommand:'.length), () => {\n\t\t\t\t\t\t\t\tcallCounter += 1;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tdisposable.add(reg);\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t}, 0);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn Promise.resolve();\n\t\t\t}\n\n\t\t}, new NullLogService()));\n\n\t\treturn service.executeCommand('farboo').then(() => {\n\t\t\tassert.strictEqual(callCounter, 1);\n\t\t\tassert.deepStrictEqual(events.sort(), ['*', 'onCommand:farboo'].sort());\n\t\t}).finally(() => {\n\t\t\tdisposable.dispose();\n\t\t});\n\t});\n\n\ttest('issue #71471: wait for onCommand activation even if a command is registered', () => {\n\t\tconst expectedOrder: string[] = ['registering command', 'resolving activation event', 'executing command'];\n\t\tconst actualOrder: string[] = [];\n\t\tconst disposables = new DisposableStore();\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\n\t\t\toverride activateByEvent(event: string): Promise<void> {\n\t\t\t\tif (event === '*') {\n\t\t\t\t\treturn new Promise(() => { }); //forever promise...\n\t\t\t\t}\n\t\t\t\tif (event.indexOf('onCommand:') === 0) {\n\t\t\t\t\treturn new Promise(resolve => {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t// Register the command after some time\n\t\t\t\t\t\t\tactualOrder.push('registering command');\n\t\t\t\t\t\t\tconst reg = CommandsRegistry.registerCommand(event.substr('onCommand:'.length), () => {\n\t\t\t\t\t\t\t\tactualOrder.push('executing command');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tdisposables.add(reg);\n\n\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t// Resolve the activation event after some more time\n\t\t\t\t\t\t\t\tactualOrder.push('resolving activation event');\n\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t}, 10);\n\t\t\t\t\t\t}, 10);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn Promise.resolve();\n\t\t\t}\n\n\t\t}, new NullLogService()));\n\n\t\treturn service.executeCommand('farboo2').then(() => {\n\t\t\tassert.deepStrictEqual(actualOrder, expectedOrder);\n\t\t}).finally(() => {\n\t\t\tdisposables.dispose();\n\t\t});\n\t});\n\n\ttest('issue #142155: execute commands synchronously if possible', async () => {\n\t\tconst actualOrder: string[] = [];\n\n\t\tconst disposables = new DisposableStore();\n\t\tdisposables.add(CommandsRegistry.registerCommand(`bizBaz`, () => {\n\t\t\tactualOrder.push('executing command');\n\t\t}));\n\t\tconst extensionService = new class extends NullExtensionService {\n\t\t\toverride activationEventIsDone(_activationEvent: string): boolean {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\t\tconst service = store.add(new CommandService(new InstantiationService(), extensionService, new NullLogService()));\n\n\t\tawait extensionService.whenInstalledExtensionsRegistered();\n\n\t\ttry {\n\t\t\tactualOrder.push(`before call`);\n\t\t\tconst promise = service.executeCommand('bizBaz');\n\t\t\tactualOrder.push(`after call`);\n\t\t\tawait promise;\n\t\t\tactualOrder.push(`resolved`);\n\t\t\tassert.deepStrictEqual(actualOrder, [\n\t\t\t\t'before call',\n\t\t\t\t'executing command',\n\t\t\t\t'after call',\n\t\t\t\t'resolved'\n\t\t\t]);\n\t\t} finally {\n\t\t\tdisposables.dispose();\n\t\t}\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport assert from 'assert';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { CommandsRegistry } from '../../../../../platform/commands/common/commands.js';\nimport { InstantiationService } from '../../../../../platform/instantiation/common/instantiationService.js';\nimport { NullLogService } from '../../../../../platform/log/common/log.js';\nimport { NullExtensionService } from '../../../extensions/common/extensions.js';\nimport { CommandService } from '../../common/commandService.js';\n\nsuite('CommandService', function () {\n\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tsetup(function () {\n\t\tstore.add(CommandsRegistry.registerCommand('foo', function () { }));\n\t});\n\n\ttest('activateOnCommand', () => {\n\n\t\tlet lastEvent: string;\n\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\t\t\toverride activateByEvent(activationEvent: string): Promise<void> {\n\t\t\t\tlastEvent = activationEvent;\n\t\t\t\treturn super.activateByEvent(activationEvent);\n\t\t\t}\n\t\t}, new NullLogService()));\n\n\t\treturn service.executeCommand('foo').then(() => {\n\t\t\tassert.ok(lastEvent, 'onCommand:foo');\n\t\t\treturn service.executeCommand('unknownCommandId');\n\t\t}).then(() => {\n\t\t\tassert.ok(false);\n\t\t}, () => {\n\t\t\tassert.ok(lastEvent, 'onCommand:unknownCommandId');\n\t\t});\n\t});\n\n\ttest('fwd activation error', async function () {\n\n\t\tconst extensionService = new class extends NullExtensionService {\n\t\t\toverride activateByEvent(activationEvent: string): Promise<void> {\n\t\t\t\treturn Promise.reject(new Error('bad_activate'));\n\t\t\t}\n\t\t};\n\n\t\tconst service = store.add(new CommandService(new InstantiationService(), extensionService, new NullLogService()));\n\n\t\tawait extensionService.whenInstalledExtensionsRegistered();\n\n\t\treturn service.executeCommand('foo').then(() => assert.ok(false), err => {\n\t\t\tassert.strictEqual(err.message, 'bad_activate');\n\t\t});\n\t});\n\n\ttest('!onReady, but executeCommand', function () {\n\n\t\tlet callCounter = 0;\n\t\tconst reg = CommandsRegistry.registerCommand('bar', () => callCounter += 1);\n\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\t\t\toverride whenInstalledExtensionsRegistered() {\n\t\t\t\treturn new Promise<boolean>(_resolve => { /*ignore*/ });\n\t\t\t}\n\t\t}, new NullLogService()));\n\n\t\tservice.executeCommand('bar');\n\t\tassert.strictEqual(callCounter, 1);\n\t\treg.dispose();\n\t});\n\n\ttest('issue #34913: !onReady, unknown command', function () {\n\n\t\tlet callCounter = 0;\n\t\tlet resolveFunc: Function;\n\t\tconst whenInstalledExtensionsRegistered = new Promise<boolean>(_resolve => { resolveFunc = _resolve; });\n\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\t\t\toverride whenInstalledExtensionsRegistered() {\n\t\t\t\treturn whenInstalledExtensionsRegistered;\n\t\t\t}\n\t\t}, new NullLogService()));\n\n\t\tconst r = service.executeCommand('bar');\n\t\tassert.strictEqual(callCounter, 0);\n\n\t\tconst reg = CommandsRegistry.registerCommand('bar', () => callCounter += 1);\n\t\tresolveFunc!(true);\n\n\t\treturn r.then(() => {\n\t\t\treg.dispose();\n\t\t\tassert.strictEqual(callCounter, 1);\n\t\t});\n\t});\n\n\ttest('Stop waiting for * extensions to activate when trigger is satisfied #62457', function () {\n\n\t\tlet callCounter = 0;\n\t\tconst disposable = new DisposableStore();\n\t\tconst events: string[] = [];\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\n\t\t\toverride activateByEvent(event: string): Promise<void> {\n\t\t\t\tevents.push(event);\n\t\t\t\tif (event === '*') {\n\t\t\t\t\treturn new Promise(() => { }); //forever promise...\n\t\t\t\t}\n\t\t\t\tif (event.indexOf('onCommand:') === 0) {\n\t\t\t\t\treturn new Promise(resolve => {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tconst reg = CommandsRegistry.registerCommand(event.substr('onCommand:'.length), () => {\n\t\t\t\t\t\t\t\tcallCounter += 1;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tdisposable.add(reg);\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t}, 0);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn Promise.resolve();\n\t\t\t}\n\n\t\t}, new NullLogService()));\n\n\t\treturn service.executeCommand('farboo').then(() => {\n\t\t\tassert.strictEqual(callCounter, 1);\n\t\t\tassert.deepStrictEqual(events.sort(), ['*', 'onCommand:farboo'].sort());\n\t\t}).finally(() => {\n\t\t\tdisposable.dispose();\n\t\t});\n\t});\n\n\ttest('issue #71471: wait for onCommand activation even if a command is registered', () => {\n\t\tconst expectedOrder: string[] = ['registering command', 'resolving activation event', 'executing command'];\n\t\tconst actualOrder: string[] = [];\n\t\tconst disposables = new DisposableStore();\n\t\tconst service = store.add(new CommandService(new InstantiationService(), new class extends NullExtensionService {\n\n\t\t\toverride activateByEvent(event: string): Promise<void> {\n\t\t\t\tif (event === '*') {\n\t\t\t\t\treturn new Promise(() => { }); //forever promise...\n\t\t\t\t}\n\t\t\t\tif (event.indexOf('onCommand:') === 0) {\n\t\t\t\t\treturn new Promise(resolve => {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t// Register the command after some time\n\t\t\t\t\t\t\tactualOrder.push('registering command');\n\t\t\t\t\t\t\tconst reg = CommandsRegistry.registerCommand(event.substr('onCommand:'.length), () => {\n\t\t\t\t\t\t\t\tactualOrder.push('executing command');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tdisposables.add(reg);\n\n\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t// Resolve the activation event after some more time\n\t\t\t\t\t\t\t\tactualOrder.push('resolving activation event');\n\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t}, 10);\n\t\t\t\t\t\t}, 10);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn Promise.resolve();\n\t\t\t}\n\n\t\t}, new NullLogService()));\n\n\t\treturn service.executeCommand('farboo2').then(() => {\n\t\t\tassert.deepStrictEqual(actualOrder, expectedOrder);\n\t\t}).finally(() => {\n\t\t\tdisposables.dispose();\n\t\t});\n\t});\n\n\ttest('issue #142155: execute commands synchronously if possible', async () => {\n\t\tconst actualOrder: string[] = [];\n\n\t\tconst disposables = new DisposableStore();\n\t\tdisposables.add(CommandsRegistry.registerCommand(`bizBaz`, () => {\n\t\t\tactualOrder.push('executing command');\n\t\t}));\n\t\tconst extensionService = new class extends NullExtensionService {\n\t\t\toverride activationEventIsDone(_activationEvent: string): boolean {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\t\tconst service = store.add(new CommandService(new InstantiationService(), extensionService, new NullLogService()));\n\n\t\tawait extensionService.whenInstalledExtensionsRegistered();\n\n\t\ttry {\n\t\t\tactualOrder.push(`before call`);\n\t\t\tconst promise = service.executeCommand('bizBaz');\n\t\t\tactualOrder.push(`after call`);\n\t\t\tawait promise;\n\t\t\tactualOrder.push(`resolved`);\n\t\t\tassert.deepStrictEqual(actualOrder, [\n\t\t\t\t'before call',\n\t\t\t\t'executing command',\n\t\t\t\t'after call',\n\t\t\t\t'resolved'\n\t\t\t]);\n\t\t} finally {\n\t\t\tdisposables.dispose();\n\t\t}\n\t});\n});\n"]}