{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/extensions/browser/webWorkerExtensionHost.ts","vs/workbench/services/extensions/browser/webWorkerExtensionHost.ts"],"names":[],"mappings":"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","file":"webWorkerExtensionHost.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from '../../../../base/browser/dom.js';\nimport { parentOriginHash } from '../../../../base/browser/iframe.js';\nimport { mainWindow } from '../../../../base/browser/window.js';\nimport { Barrier } from '../../../../base/common/async.js';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { canceled, onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { AppResourcePath, COI, FileAccess } from '../../../../base/common/network.js';\nimport * as platform from '../../../../base/common/platform.js';\nimport { joinPath } from '../../../../base/common/resources.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { IMessagePassingProtocol } from '../../../../base/parts/ipc/common/ipc.js';\nimport { getNLSLanguage, getNLSMessages } from '../../../../nls.js';\nimport { ILabelService } from '../../../../platform/label/common/label.js';\nimport { ILayoutService } from '../../../../platform/layout/browser/layoutService.js';\nimport { ILogService, ILoggerService } from '../../../../platform/log/common/log.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { isLoggingOnly } from '../../../../platform/telemetry/common/telemetryUtils.js';\nimport { IUserDataProfilesService } from '../../../../platform/userDataProfile/common/userDataProfile.js';\nimport { WebWorkerDescriptor } from '../../../../platform/webWorker/browser/webWorkerDescriptor.js';\nimport { IWebWorkerService } from '../../../../platform/webWorker/browser/webWorkerService.js';\nimport { IWorkspaceContextService, WorkbenchState } from '../../../../platform/workspace/common/workspace.js';\nimport { IBrowserWorkbenchEnvironmentService } from '../../environment/browser/environmentService.js';\nimport { ExtensionHostExitCode, IExtensionHostInitData, MessageType, UIKind, createMessageOfType, isMessageOfType } from '../common/extensionHostProtocol.js';\nimport { LocalWebWorkerRunningLocation } from '../common/extensionRunningLocation.js';\nimport { ExtensionHostExtensions, ExtensionHostStartup, IExtensionHost } from '../common/extensions.js';\n\nexport interface IWebWorkerExtensionHostInitData {\n\treadonly extensions: ExtensionHostExtensions;\n}\n\nexport interface IWebWorkerExtensionHostDataProvider {\n\tgetInitData(): Promise<IWebWorkerExtensionHostInitData>;\n}\n\nexport class WebWorkerExtensionHost extends Disposable implements IExtensionHost {\n\n\tpublic readonly pid = null;\n\tpublic readonly remoteAuthority = null;\n\tpublic extensions: ExtensionHostExtensions | null = null;\n\n\tprivate readonly _onDidExit = this._register(new Emitter<[number, string | null]>());\n\tpublic readonly onExit: Event<[number, string | null]> = this._onDidExit.event;\n\n\tprivate _isTerminating: boolean;\n\tprivate _protocolPromise: Promise<IMessagePassingProtocol> | null;\n\tprivate _protocol: IMessagePassingProtocol | null;\n\n\tprivate readonly _extensionHostLogsLocation: URI;\n\n\tconstructor(\n\t\tpublic readonly runningLocation: LocalWebWorkerRunningLocation,\n\t\tpublic readonly startup: ExtensionHostStartup,\n\t\tprivate readonly _initDataProvider: IWebWorkerExtensionHostDataProvider,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@IWorkspaceContextService private readonly _contextService: IWorkspaceContextService,\n\t\t@ILabelService private readonly _labelService: ILabelService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@ILoggerService private readonly _loggerService: ILoggerService,\n\t\t@IBrowserWorkbenchEnvironmentService private readonly _environmentService: IBrowserWorkbenchEnvironmentService,\n\t\t@IUserDataProfilesService private readonly _userDataProfilesService: IUserDataProfilesService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@ILayoutService private readonly _layoutService: ILayoutService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IWebWorkerService private readonly _webWorkerService: IWebWorkerService,\n\t) {\n\t\tsuper();\n\t\tthis._isTerminating = false;\n\t\tthis._protocolPromise = null;\n\t\tthis._protocol = null;\n\t\tthis._extensionHostLogsLocation = joinPath(this._environmentService.extHostLogsPath, 'webWorker');\n\t}\n\n\tprivate async _getWebWorkerExtensionHostIframeSrc(): Promise<string> {\n\t\tconst suffixSearchParams = new URLSearchParams();\n\t\tif (this._environmentService.debugExtensionHost && this._environmentService.debugRenderer) {\n\t\t\tsuffixSearchParams.set('debugged', '1');\n\t\t}\n\t\tCOI.addSearchParam(suffixSearchParams, true, true);\n\n\t\tconst suffix = `?${suffixSearchParams.toString()}`;\n\n\t\tconst iframeModulePath: AppResourcePath = `vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html`;\n\t\tif (platform.isWeb) {\n\t\t\tconst webEndpointUrlTemplate = this._productService.webEndpointUrlTemplate;\n\t\t\tconst commit = this._productService.commit;\n\t\t\tconst quality = this._productService.quality;\n\t\t\tif (webEndpointUrlTemplate && commit && quality) {\n\t\t\t\t// Try to keep the web worker extension host iframe origin stable by storing it in workspace storage\n\t\t\t\tconst key = 'webWorkerExtensionHostIframeStableOriginUUID';\n\t\t\t\tlet stableOriginUUID = this._storageService.get(key, StorageScope.WORKSPACE);\n\t\t\t\tif (typeof stableOriginUUID === 'undefined') {\n\t\t\t\t\tstableOriginUUID = generateUuid();\n\t\t\t\t\tthis._storageService.store(key, stableOriginUUID, StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\t\t\t}\n\t\t\t\tconst hash = await parentOriginHash(mainWindow.origin, stableOriginUUID);\n\t\t\t\tconst baseUrl = (\n\t\t\t\t\twebEndpointUrlTemplate\n\t\t\t\t\t\t.replace('{{uuid}}', `v--${hash}`) // using `v--` as a marker to require `parentOrigin`/`salt` verification\n\t\t\t\t\t\t.replace('{{commit}}', commit)\n\t\t\t\t\t\t.replace('{{quality}}', quality)\n\t\t\t\t);\n\n\t\t\t\tconst res = new URL(`${baseUrl}/out/${iframeModulePath}${suffix}`);\n\t\t\t\tres.searchParams.set('parentOrigin', mainWindow.origin);\n\t\t\t\tres.searchParams.set('salt', stableOriginUUID);\n\t\t\t\treturn res.toString();\n\t\t\t}\n\n\t\t\tconsole.warn(`The web worker extension host is started in a same-origin iframe!`);\n\t\t}\n\n\t\tconst relativeExtensionHostIframeSrc = FileAccess.asBrowserUri(iframeModulePath);\n\t\treturn `${relativeExtensionHostIframeSrc.toString(true)}${suffix}`;\n\t}\n\n\tpublic async start(): Promise<IMessagePassingProtocol> {\n\t\tif (!this._protocolPromise) {\n\t\t\tthis._protocolPromise = this._startInsideIframe();\n\t\t\tthis._protocolPromise.then(protocol => this._protocol = protocol);\n\t\t}\n\t\treturn this._protocolPromise;\n\t}\n\n\tprivate async _startInsideIframe(): Promise<IMessagePassingProtocol> {\n\t\tconst webWorkerExtensionHostIframeSrc = await this._getWebWorkerExtensionHostIframeSrc();\n\t\tconst emitter = this._register(new Emitter<VSBuffer>());\n\n\t\tconst iframe = document.createElement('iframe');\n\t\tiframe.setAttribute('class', 'web-worker-ext-host-iframe');\n\t\tiframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');\n\t\tiframe.setAttribute('allow', 'usb; serial; hid; cross-origin-isolated;');\n\t\tiframe.setAttribute('aria-hidden', 'true');\n\t\tiframe.style.display = 'none';\n\n\t\tconst vscodeWebWorkerExtHostId = generateUuid();\n\t\tiframe.setAttribute('src', `${webWorkerExtensionHostIframeSrc}&vscodeWebWorkerExtHostId=${vscodeWebWorkerExtHostId}`);\n\n\t\tconst barrier = new Barrier();\n\t\tlet port!: MessagePort;\n\t\tlet barrierError: Error | null = null;\n\t\tlet barrierHasError = false;\n\t\tlet startTimeout: Timeout | undefined = undefined;\n\n\t\tconst rejectBarrier = (exitCode: number, error: Error) => {\n\t\t\tbarrierError = error;\n\t\t\tbarrierHasError = true;\n\t\t\tonUnexpectedError(barrierError);\n\t\t\tclearTimeout(startTimeout);\n\t\t\tthis._onDidExit.fire([ExtensionHostExitCode.UnexpectedError, barrierError.message]);\n\t\t\tbarrier.open();\n\t\t};\n\n\t\tconst resolveBarrier = (messagePort: MessagePort) => {\n\t\t\tport = messagePort;\n\t\t\tclearTimeout(startTimeout);\n\t\t\tbarrier.open();\n\t\t};\n\n\t\tstartTimeout = setTimeout(() => {\n\t\t\tconsole.warn(`The Web Worker Extension Host did not start in 60s, that might be a problem.`);\n\t\t}, 60000);\n\n\t\tthis._register(dom.addDisposableListener(mainWindow, 'message', (event) => {\n\t\t\tif (event.source !== iframe.contentWindow) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (event.data.vscodeWebWorkerExtHostId !== vscodeWebWorkerExtHostId) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (event.data.error) {\n\t\t\t\tconst { name, message, stack } = event.data.error;\n\t\t\t\tconst err = new Error();\n\t\t\t\terr.message = message;\n\t\t\t\terr.name = name;\n\t\t\t\terr.stack = stack;\n\t\t\t\treturn rejectBarrier(ExtensionHostExitCode.UnexpectedError, err);\n\t\t\t}\n\t\t\tif (event.data.type === 'vscode.bootstrap.nls') {\n\t\t\t\tiframe.contentWindow!.postMessage({\n\t\t\t\t\ttype: event.data.type,\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tworkerUrl: this._webWorkerService.getWorkerUrl(extensionHostWorkerMainDescriptor),\n\t\t\t\t\t\tfileRoot: globalThis._VSCODE_FILE_ROOT,\n\t\t\t\t\t\tnls: {\n\t\t\t\t\t\t\tmessages: getNLSMessages(),\n\t\t\t\t\t\t\tlanguage: getNLSLanguage()\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, '*');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst { data } = event.data;\n\t\t\tif (barrier.isOpen() || !(data instanceof MessagePort)) {\n\t\t\t\tconsole.warn('UNEXPECTED message', event);\n\t\t\t\tconst err = new Error('UNEXPECTED message');\n\t\t\t\treturn rejectBarrier(ExtensionHostExitCode.UnexpectedError, err);\n\t\t\t}\n\t\t\tresolveBarrier(data);\n\t\t}));\n\n\t\tthis._layoutService.mainContainer.appendChild(iframe);\n\t\tthis._register(toDisposable(() => iframe.remove()));\n\n\t\t// await MessagePort and use it to directly communicate\n\t\t// with the worker extension host\n\t\tawait barrier.wait();\n\n\t\tif (barrierHasError) {\n\t\t\tthrow barrierError;\n\t\t}\n\n\t\t// Send over message ports for extension API\n\t\tconst messagePorts = this._environmentService.options?.messagePorts ?? new Map();\n\t\tiframe.contentWindow!.postMessage({ type: 'vscode.init', data: messagePorts }, '*', [...messagePorts.values()]);\n\n\t\tport.onmessage = (event) => {\n\t\t\tconst { data } = event;\n\t\t\tif (!(data instanceof ArrayBuffer)) {\n\t\t\t\tconsole.warn('UNKNOWN data received', data);\n\t\t\t\tthis._onDidExit.fire([77, 'UNKNOWN data received']);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\temitter.fire(VSBuffer.wrap(new Uint8Array(data, 0, data.byteLength)));\n\t\t};\n\n\t\tconst protocol: IMessagePassingProtocol = {\n\t\t\tonMessage: emitter.event,\n\t\t\tsend: vsbuf => {\n\t\t\t\tconst data = vsbuf.buffer.buffer.slice(vsbuf.buffer.byteOffset, vsbuf.buffer.byteOffset + vsbuf.buffer.byteLength);\n\t\t\t\tport.postMessage(data, [data]);\n\t\t\t}\n\t\t};\n\n\t\treturn this._performHandshake(protocol);\n\t}\n\n\tprivate async _performHandshake(protocol: IMessagePassingProtocol): Promise<IMessagePassingProtocol> {\n\t\t// extension host handshake happens below\n\t\t// (1) <== wait for: Ready\n\t\t// (2) ==> send: init data\n\t\t// (3) <== wait for: Initialized\n\n\t\tawait Event.toPromise(Event.filter(protocol.onMessage, msg => isMessageOfType(msg, MessageType.Ready)));\n\t\tif (this._isTerminating) {\n\t\t\tthrow canceled();\n\t\t}\n\t\tprotocol.send(VSBuffer.fromString(JSON.stringify(await this._createExtHostInitData())));\n\t\tif (this._isTerminating) {\n\t\t\tthrow canceled();\n\t\t}\n\t\tawait Event.toPromise(Event.filter(protocol.onMessage, msg => isMessageOfType(msg, MessageType.Initialized)));\n\t\tif (this._isTerminating) {\n\t\t\tthrow canceled();\n\t\t}\n\n\t\treturn protocol;\n\t}\n\n\tpublic override dispose(): void {\n\t\tif (this._isTerminating) {\n\t\t\treturn;\n\t\t}\n\t\tthis._isTerminating = true;\n\t\tthis._protocol?.send(createMessageOfType(MessageType.Terminate));\n\t\tsuper.dispose();\n\t}\n\n\tgetInspectPort(): undefined {\n\t\treturn undefined;\n\t}\n\n\tenableInspectPort(): Promise<boolean> {\n\t\treturn Promise.resolve(false);\n\t}\n\n\tprivate async _createExtHostInitData(): Promise<IExtensionHostInitData> {\n\t\tconst initData = await this._initDataProvider.getInitData();\n\t\tthis.extensions = initData.extensions;\n\t\tconst workspace = this._contextService.getWorkspace();\n\t\tconst nlsBaseUrl = this._productService.extensionsGallery?.nlsBaseUrl;\n\t\tlet nlsUrlWithDetails: URI | undefined = undefined;\n\t\t// Only use the nlsBaseUrl if we are using a language other than the default, English.\n\t\tif (nlsBaseUrl && this._productService.commit && !platform.Language.isDefaultVariant()) {\n\t\t\tnlsUrlWithDetails = URI.joinPath(URI.parse(nlsBaseUrl), this._productService.commit, this._productService.version, platform.Language.value());\n\t\t}\n\t\treturn {\n\t\t\tcommit: this._productService.commit,\n\t\t\tversion: this._productService.version,\n\t\t\tquality: this._productService.quality,\n\t\t\tdate: this._productService.date,\n\t\t\tparentPid: 0,\n\t\t\tenvironment: {\n\t\t\t\tisExtensionDevelopmentDebug: this._environmentService.debugRenderer,\n\t\t\t\tappName: this._productService.nameLong,\n\t\t\t\tappHost: this._productService.embedderIdentifier ?? (platform.isWeb ? 'web' : 'desktop'),\n\t\t\t\tappUriScheme: this._productService.urlProtocol,\n\t\t\t\tappLanguage: platform.language,\n\t\t\t\tisExtensionTelemetryLoggingOnly: isLoggingOnly(this._productService, this._environmentService),\n\t\t\t\textensionDevelopmentLocationURI: this._environmentService.extensionDevelopmentLocationURI,\n\t\t\t\textensionTestsLocationURI: this._environmentService.extensionTestsLocationURI,\n\t\t\t\tglobalStorageHome: this._userDataProfilesService.defaultProfile.globalStorageHome,\n\t\t\t\tworkspaceStorageHome: this._environmentService.workspaceStorageHome,\n\t\t\t\textensionLogLevel: this._environmentService.extensionLogLevel\n\t\t\t},\n\t\t\tworkspace: this._contextService.getWorkbenchState() === WorkbenchState.EMPTY ? undefined : {\n\t\t\t\tconfiguration: workspace.configuration || undefined,\n\t\t\t\tid: workspace.id,\n\t\t\t\tname: this._labelService.getWorkspaceLabel(workspace),\n\t\t\t\ttransient: workspace.transient\n\t\t\t},\n\t\t\tconsoleForward: {\n\t\t\t\tincludeStack: false,\n\t\t\t\tlogNative: this._environmentService.debugRenderer\n\t\t\t},\n\t\t\textensions: this.extensions.toSnapshot(),\n\t\t\tnlsBaseUrl: nlsUrlWithDetails,\n\t\t\ttelemetryInfo: {\n\t\t\t\tsessionId: this._telemetryService.sessionId,\n\t\t\t\tmachineId: this._telemetryService.machineId,\n\t\t\t\tsqmId: this._telemetryService.sqmId,\n\t\t\t\tdevDeviceId: this._telemetryService.devDeviceId ?? this._telemetryService.machineId,\n\t\t\t\tfirstSessionDate: this._telemetryService.firstSessionDate,\n\t\t\t\tmsftInternal: this._telemetryService.msftInternal\n\t\t\t},\n\t\t\tlogLevel: this._logService.getLevel(),\n\t\t\tloggers: [...this._loggerService.getRegisteredLoggers()],\n\t\t\tlogsLocation: this._extensionHostLogsLocation,\n\t\t\tautoStart: (this.startup === ExtensionHostStartup.EagerAutoStart || this.startup === ExtensionHostStartup.LazyAutoStart),\n\t\t\tremote: {\n\t\t\t\tauthority: this._environmentService.remoteAuthority,\n\t\t\t\tconnectionData: null,\n\t\t\t\tisRemote: false\n\t\t\t},\n\t\t\tuiKind: platform.isWeb ? UIKind.Web : UIKind.Desktop\n\t\t};\n\t}\n}\n\nconst extensionHostWorkerMainDescriptor = new WebWorkerDescriptor({\n\tlabel: 'extensionHostWorkerMain',\n\tesmModuleLocation: () => FileAccess.asBrowserUri('vs/workbench/api/worker/extensionHostWorkerMain.js'),\n\tesmModuleLocationBundler: () => new URL('../../../api/worker/extensionHostWorkerMain.ts?worker', import.meta.url),\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from '../../../../base/browser/dom.js';\nimport { parentOriginHash } from '../../../../base/browser/iframe.js';\nimport { mainWindow } from '../../../../base/browser/window.js';\nimport { Barrier } from '../../../../base/common/async.js';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { canceled, onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { AppResourcePath, COI, FileAccess } from '../../../../base/common/network.js';\nimport * as platform from '../../../../base/common/platform.js';\nimport { joinPath } from '../../../../base/common/resources.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { IMessagePassingProtocol } from '../../../../base/parts/ipc/common/ipc.js';\nimport { getNLSLanguage, getNLSMessages } from '../../../../nls.js';\nimport { ILabelService } from '../../../../platform/label/common/label.js';\nimport { ILayoutService } from '../../../../platform/layout/browser/layoutService.js';\nimport { ILogService, ILoggerService } from '../../../../platform/log/common/log.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { isLoggingOnly } from '../../../../platform/telemetry/common/telemetryUtils.js';\nimport { IUserDataProfilesService } from '../../../../platform/userDataProfile/common/userDataProfile.js';\nimport { WebWorkerDescriptor } from '../../../../platform/webWorker/browser/webWorkerDescriptor.js';\nimport { IWebWorkerService } from '../../../../platform/webWorker/browser/webWorkerService.js';\nimport { IWorkspaceContextService, WorkbenchState } from '../../../../platform/workspace/common/workspace.js';\nimport { IBrowserWorkbenchEnvironmentService } from '../../environment/browser/environmentService.js';\nimport { ExtensionHostExitCode, IExtensionHostInitData, MessageType, UIKind, createMessageOfType, isMessageOfType } from '../common/extensionHostProtocol.js';\nimport { LocalWebWorkerRunningLocation } from '../common/extensionRunningLocation.js';\nimport { ExtensionHostExtensions, ExtensionHostStartup, IExtensionHost } from '../common/extensions.js';\n\nexport interface IWebWorkerExtensionHostInitData {\n\treadonly extensions: ExtensionHostExtensions;\n}\n\nexport interface IWebWorkerExtensionHostDataProvider {\n\tgetInitData(): Promise<IWebWorkerExtensionHostInitData>;\n}\n\nexport class WebWorkerExtensionHost extends Disposable implements IExtensionHost {\n\n\tpublic readonly pid = null;\n\tpublic readonly remoteAuthority = null;\n\tpublic extensions: ExtensionHostExtensions | null = null;\n\n\tprivate readonly _onDidExit = this._register(new Emitter<[number, string | null]>());\n\tpublic readonly onExit: Event<[number, string | null]> = this._onDidExit.event;\n\n\tprivate _isTerminating: boolean;\n\tprivate _protocolPromise: Promise<IMessagePassingProtocol> | null;\n\tprivate _protocol: IMessagePassingProtocol | null;\n\n\tprivate readonly _extensionHostLogsLocation: URI;\n\n\tconstructor(\n\t\tpublic readonly runningLocation: LocalWebWorkerRunningLocation,\n\t\tpublic readonly startup: ExtensionHostStartup,\n\t\tprivate readonly _initDataProvider: IWebWorkerExtensionHostDataProvider,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@IWorkspaceContextService private readonly _contextService: IWorkspaceContextService,\n\t\t@ILabelService private readonly _labelService: ILabelService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@ILoggerService private readonly _loggerService: ILoggerService,\n\t\t@IBrowserWorkbenchEnvironmentService private readonly _environmentService: IBrowserWorkbenchEnvironmentService,\n\t\t@IUserDataProfilesService private readonly _userDataProfilesService: IUserDataProfilesService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@ILayoutService private readonly _layoutService: ILayoutService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IWebWorkerService private readonly _webWorkerService: IWebWorkerService,\n\t) {\n\t\tsuper();\n\t\tthis._isTerminating = false;\n\t\tthis._protocolPromise = null;\n\t\tthis._protocol = null;\n\t\tthis._extensionHostLogsLocation = joinPath(this._environmentService.extHostLogsPath, 'webWorker');\n\t}\n\n\tprivate async _getWebWorkerExtensionHostIframeSrc(): Promise<string> {\n\t\tconst suffixSearchParams = new URLSearchParams();\n\t\tif (this._environmentService.debugExtensionHost && this._environmentService.debugRenderer) {\n\t\t\tsuffixSearchParams.set('debugged', '1');\n\t\t}\n\t\tCOI.addSearchParam(suffixSearchParams, true, true);\n\n\t\tconst suffix = `?${suffixSearchParams.toString()}`;\n\n\t\tconst iframeModulePath: AppResourcePath = `vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html`;\n\t\tif (platform.isWeb) {\n\t\t\tconst webEndpointUrlTemplate = this._productService.webEndpointUrlTemplate;\n\t\t\tconst commit = this._productService.commit;\n\t\t\tconst quality = this._productService.quality;\n\t\t\tif (webEndpointUrlTemplate && commit && quality) {\n\t\t\t\t// Try to keep the web worker extension host iframe origin stable by storing it in workspace storage\n\t\t\t\tconst key = 'webWorkerExtensionHostIframeStableOriginUUID';\n\t\t\t\tlet stableOriginUUID = this._storageService.get(key, StorageScope.WORKSPACE);\n\t\t\t\tif (typeof stableOriginUUID === 'undefined') {\n\t\t\t\t\tstableOriginUUID = generateUuid();\n\t\t\t\t\tthis._storageService.store(key, stableOriginUUID, StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\t\t\t}\n\t\t\t\tconst hash = await parentOriginHash(mainWindow.origin, stableOriginUUID);\n\t\t\t\tconst baseUrl = (\n\t\t\t\t\twebEndpointUrlTemplate\n\t\t\t\t\t\t.replace('{{uuid}}', `v--${hash}`) // using `v--` as a marker to require `parentOrigin`/`salt` verification\n\t\t\t\t\t\t.replace('{{commit}}', commit)\n\t\t\t\t\t\t.replace('{{quality}}', quality)\n\t\t\t\t);\n\n\t\t\t\tconst res = new URL(`${baseUrl}/out/${iframeModulePath}${suffix}`);\n\t\t\t\tres.searchParams.set('parentOrigin', mainWindow.origin);\n\t\t\t\tres.searchParams.set('salt', stableOriginUUID);\n\t\t\t\treturn res.toString();\n\t\t\t}\n\n\t\t\tconsole.warn(`The web worker extension host is started in a same-origin iframe!`);\n\t\t}\n\n\t\tconst relativeExtensionHostIframeSrc = FileAccess.asBrowserUri(iframeModulePath);\n\t\treturn `${relativeExtensionHostIframeSrc.toString(true)}${suffix}`;\n\t}\n\n\tpublic async start(): Promise<IMessagePassingProtocol> {\n\t\tif (!this._protocolPromise) {\n\t\t\tthis._protocolPromise = this._startInsideIframe();\n\t\t\tthis._protocolPromise.then(protocol => this._protocol = protocol);\n\t\t}\n\t\treturn this._protocolPromise;\n\t}\n\n\tprivate async _startInsideIframe(): Promise<IMessagePassingProtocol> {\n\t\tconst webWorkerExtensionHostIframeSrc = await this._getWebWorkerExtensionHostIframeSrc();\n\t\tconst emitter = this._register(new Emitter<VSBuffer>());\n\n\t\tconst iframe = document.createElement('iframe');\n\t\tiframe.setAttribute('class', 'web-worker-ext-host-iframe');\n\t\tiframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');\n\t\tiframe.setAttribute('allow', 'usb; serial; hid; cross-origin-isolated;');\n\t\tiframe.setAttribute('aria-hidden', 'true');\n\t\tiframe.style.display = 'none';\n\n\t\tconst vscodeWebWorkerExtHostId = generateUuid();\n\t\tiframe.setAttribute('src', `${webWorkerExtensionHostIframeSrc}&vscodeWebWorkerExtHostId=${vscodeWebWorkerExtHostId}`);\n\n\t\tconst barrier = new Barrier();\n\t\tlet port!: MessagePort;\n\t\tlet barrierError: Error | null = null;\n\t\tlet barrierHasError = false;\n\t\tlet startTimeout: Timeout | undefined = undefined;\n\n\t\tconst rejectBarrier = (exitCode: number, error: Error) => {\n\t\t\tbarrierError = error;\n\t\t\tbarrierHasError = true;\n\t\t\tonUnexpectedError(barrierError);\n\t\t\tclearTimeout(startTimeout);\n\t\t\tthis._onDidExit.fire([ExtensionHostExitCode.UnexpectedError, barrierError.message]);\n\t\t\tbarrier.open();\n\t\t};\n\n\t\tconst resolveBarrier = (messagePort: MessagePort) => {\n\t\t\tport = messagePort;\n\t\t\tclearTimeout(startTimeout);\n\t\t\tbarrier.open();\n\t\t};\n\n\t\tstartTimeout = setTimeout(() => {\n\t\t\tconsole.warn(`The Web Worker Extension Host did not start in 60s, that might be a problem.`);\n\t\t}, 60000);\n\n\t\tthis._register(dom.addDisposableListener(mainWindow, 'message', (event) => {\n\t\t\tif (event.source !== iframe.contentWindow) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (event.data.vscodeWebWorkerExtHostId !== vscodeWebWorkerExtHostId) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (event.data.error) {\n\t\t\t\tconst { name, message, stack } = event.data.error;\n\t\t\t\tconst err = new Error();\n\t\t\t\terr.message = message;\n\t\t\t\terr.name = name;\n\t\t\t\terr.stack = stack;\n\t\t\t\treturn rejectBarrier(ExtensionHostExitCode.UnexpectedError, err);\n\t\t\t}\n\t\t\tif (event.data.type === 'vscode.bootstrap.nls') {\n\t\t\t\tiframe.contentWindow!.postMessage({\n\t\t\t\t\ttype: event.data.type,\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tworkerUrl: this._webWorkerService.getWorkerUrl(extensionHostWorkerMainDescriptor),\n\t\t\t\t\t\tfileRoot: globalThis._VSCODE_FILE_ROOT,\n\t\t\t\t\t\tnls: {\n\t\t\t\t\t\t\tmessages: getNLSMessages(),\n\t\t\t\t\t\t\tlanguage: getNLSLanguage()\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}, '*');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst { data } = event.data;\n\t\t\tif (barrier.isOpen() || !(data instanceof MessagePort)) {\n\t\t\t\tconsole.warn('UNEXPECTED message', event);\n\t\t\t\tconst err = new Error('UNEXPECTED message');\n\t\t\t\treturn rejectBarrier(ExtensionHostExitCode.UnexpectedError, err);\n\t\t\t}\n\t\t\tresolveBarrier(data);\n\t\t}));\n\n\t\tthis._layoutService.mainContainer.appendChild(iframe);\n\t\tthis._register(toDisposable(() => iframe.remove()));\n\n\t\t// await MessagePort and use it to directly communicate\n\t\t// with the worker extension host\n\t\tawait barrier.wait();\n\n\t\tif (barrierHasError) {\n\t\t\tthrow barrierError;\n\t\t}\n\n\t\t// Send over message ports for extension API\n\t\tconst messagePorts = this._environmentService.options?.messagePorts ?? new Map();\n\t\tiframe.contentWindow!.postMessage({ type: 'vscode.init', data: messagePorts }, '*', [...messagePorts.values()]);\n\n\t\tport.onmessage = (event) => {\n\t\t\tconst { data } = event;\n\t\t\tif (!(data instanceof ArrayBuffer)) {\n\t\t\t\tconsole.warn('UNKNOWN data received', data);\n\t\t\t\tthis._onDidExit.fire([77, 'UNKNOWN data received']);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\temitter.fire(VSBuffer.wrap(new Uint8Array(data, 0, data.byteLength)));\n\t\t};\n\n\t\tconst protocol: IMessagePassingProtocol = {\n\t\t\tonMessage: emitter.event,\n\t\t\tsend: vsbuf => {\n\t\t\t\tconst data = vsbuf.buffer.buffer.slice(vsbuf.buffer.byteOffset, vsbuf.buffer.byteOffset + vsbuf.buffer.byteLength);\n\t\t\t\tport.postMessage(data, [data]);\n\t\t\t}\n\t\t};\n\n\t\treturn this._performHandshake(protocol);\n\t}\n\n\tprivate async _performHandshake(protocol: IMessagePassingProtocol): Promise<IMessagePassingProtocol> {\n\t\t// extension host handshake happens below\n\t\t// (1) <== wait for: Ready\n\t\t// (2) ==> send: init data\n\t\t// (3) <== wait for: Initialized\n\n\t\tawait Event.toPromise(Event.filter(protocol.onMessage, msg => isMessageOfType(msg, MessageType.Ready)));\n\t\tif (this._isTerminating) {\n\t\t\tthrow canceled();\n\t\t}\n\t\tprotocol.send(VSBuffer.fromString(JSON.stringify(await this._createExtHostInitData())));\n\t\tif (this._isTerminating) {\n\t\t\tthrow canceled();\n\t\t}\n\t\tawait Event.toPromise(Event.filter(protocol.onMessage, msg => isMessageOfType(msg, MessageType.Initialized)));\n\t\tif (this._isTerminating) {\n\t\t\tthrow canceled();\n\t\t}\n\n\t\treturn protocol;\n\t}\n\n\tpublic override dispose(): void {\n\t\tif (this._isTerminating) {\n\t\t\treturn;\n\t\t}\n\t\tthis._isTerminating = true;\n\t\tthis._protocol?.send(createMessageOfType(MessageType.Terminate));\n\t\tsuper.dispose();\n\t}\n\n\tgetInspectPort(): undefined {\n\t\treturn undefined;\n\t}\n\n\tenableInspectPort(): Promise<boolean> {\n\t\treturn Promise.resolve(false);\n\t}\n\n\tprivate async _createExtHostInitData(): Promise<IExtensionHostInitData> {\n\t\tconst initData = await this._initDataProvider.getInitData();\n\t\tthis.extensions = initData.extensions;\n\t\tconst workspace = this._contextService.getWorkspace();\n\t\tconst nlsBaseUrl = this._productService.extensionsGallery?.nlsBaseUrl;\n\t\tlet nlsUrlWithDetails: URI | undefined = undefined;\n\t\t// Only use the nlsBaseUrl if we are using a language other than the default, English.\n\t\tif (nlsBaseUrl && this._productService.commit && !platform.Language.isDefaultVariant()) {\n\t\t\tnlsUrlWithDetails = URI.joinPath(URI.parse(nlsBaseUrl), this._productService.commit, this._productService.version, platform.Language.value());\n\t\t}\n\t\treturn {\n\t\t\tcommit: this._productService.commit,\n\t\t\tversion: this._productService.version,\n\t\t\tquality: this._productService.quality,\n\t\t\tdate: this._productService.date,\n\t\t\tparentPid: 0,\n\t\t\tenvironment: {\n\t\t\t\tisExtensionDevelopmentDebug: this._environmentService.debugRenderer,\n\t\t\t\tappName: this._productService.nameLong,\n\t\t\t\tappHost: this._productService.embedderIdentifier ?? (platform.isWeb ? 'web' : 'desktop'),\n\t\t\t\tappUriScheme: this._productService.urlProtocol,\n\t\t\t\tappLanguage: platform.language,\n\t\t\t\tisExtensionTelemetryLoggingOnly: isLoggingOnly(this._productService, this._environmentService),\n\t\t\t\textensionDevelopmentLocationURI: this._environmentService.extensionDevelopmentLocationURI,\n\t\t\t\textensionTestsLocationURI: this._environmentService.extensionTestsLocationURI,\n\t\t\t\tglobalStorageHome: this._userDataProfilesService.defaultProfile.globalStorageHome,\n\t\t\t\tworkspaceStorageHome: this._environmentService.workspaceStorageHome,\n\t\t\t\textensionLogLevel: this._environmentService.extensionLogLevel\n\t\t\t},\n\t\t\tworkspace: this._contextService.getWorkbenchState() === WorkbenchState.EMPTY ? undefined : {\n\t\t\t\tconfiguration: workspace.configuration || undefined,\n\t\t\t\tid: workspace.id,\n\t\t\t\tname: this._labelService.getWorkspaceLabel(workspace),\n\t\t\t\ttransient: workspace.transient\n\t\t\t},\n\t\t\tconsoleForward: {\n\t\t\t\tincludeStack: false,\n\t\t\t\tlogNative: this._environmentService.debugRenderer\n\t\t\t},\n\t\t\textensions: this.extensions.toSnapshot(),\n\t\t\tnlsBaseUrl: nlsUrlWithDetails,\n\t\t\ttelemetryInfo: {\n\t\t\t\tsessionId: this._telemetryService.sessionId,\n\t\t\t\tmachineId: this._telemetryService.machineId,\n\t\t\t\tsqmId: this._telemetryService.sqmId,\n\t\t\t\tdevDeviceId: this._telemetryService.devDeviceId ?? this._telemetryService.machineId,\n\t\t\t\tfirstSessionDate: this._telemetryService.firstSessionDate,\n\t\t\t\tmsftInternal: this._telemetryService.msftInternal\n\t\t\t},\n\t\t\tlogLevel: this._logService.getLevel(),\n\t\t\tloggers: [...this._loggerService.getRegisteredLoggers()],\n\t\t\tlogsLocation: this._extensionHostLogsLocation,\n\t\t\tautoStart: (this.startup === ExtensionHostStartup.EagerAutoStart || this.startup === ExtensionHostStartup.LazyAutoStart),\n\t\t\tremote: {\n\t\t\t\tauthority: this._environmentService.remoteAuthority,\n\t\t\t\tconnectionData: null,\n\t\t\t\tisRemote: false\n\t\t\t},\n\t\t\tuiKind: platform.isWeb ? UIKind.Web : UIKind.Desktop\n\t\t};\n\t}\n}\n\nconst extensionHostWorkerMainDescriptor = new WebWorkerDescriptor({\n\tlabel: 'extensionHostWorkerMain',\n\tesmModuleLocation: () => FileAccess.asBrowserUri('vs/workbench/api/worker/extensionHostWorkerMain.js'),\n\tesmModuleLocationBundler: () => new URL('../../../api/worker/extensionHostWorkerMain.ts?worker', import.meta.url),\n});\n"]}