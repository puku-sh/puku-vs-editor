{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/extensions/test/common/rpcProtocol.test.ts","vs/workbench/services/extensions/test/common/rpcProtocol.test.ts"],"names":[],"mappings":"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","file":"rpcProtocol.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { VSBuffer } from '../../../../../base/common/buffer.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { IMessagePassingProtocol } from '../../../../../base/parts/ipc/common/ipc.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { ProxyIdentifier, SerializableObjectWithBuffers } from '../../common/proxyIdentifier.js';\nimport { RPCProtocol } from '../../common/rpcProtocol.js';\n\nsuite('RPCProtocol', () => {\n\n\tlet disposables: DisposableStore;\n\n\tclass MessagePassingProtocol implements IMessagePassingProtocol {\n\t\tprivate _pair?: MessagePassingProtocol;\n\n\t\tprivate readonly _onMessage = new Emitter<VSBuffer>();\n\t\tpublic readonly onMessage: Event<VSBuffer> = this._onMessage.event;\n\n\t\tpublic setPair(other: MessagePassingProtocol) {\n\t\t\tthis._pair = other;\n\t\t}\n\n\t\tpublic send(buffer: VSBuffer): void {\n\t\t\tPromise.resolve().then(() => {\n\t\t\t\tthis._pair!._onMessage.fire(buffer);\n\t\t\t});\n\t\t}\n\t}\n\n\tlet delegate: (a1: any, a2: any) => any;\n\tlet bProxy: BClass;\n\tclass BClass {\n\t\t$m(a1: any, a2: any): Promise<any> {\n\t\t\treturn Promise.resolve(delegate.call(null, a1, a2));\n\t\t}\n\t}\n\n\tsetup(() => {\n\t\tdisposables = new DisposableStore();\n\n\t\tconst a_protocol = new MessagePassingProtocol();\n\t\tconst b_protocol = new MessagePassingProtocol();\n\t\ta_protocol.setPair(b_protocol);\n\t\tb_protocol.setPair(a_protocol);\n\n\t\tconst A = disposables.add(new RPCProtocol(a_protocol));\n\t\tconst B = disposables.add(new RPCProtocol(b_protocol));\n\n\t\tconst bIdentifier = new ProxyIdentifier<BClass>('bb');\n\t\tconst bInstance = new BClass();\n\t\tB.set(bIdentifier, bInstance);\n\t\tbProxy = A.getProxy(bIdentifier);\n\t});\n\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('simple call', function (done) {\n\t\tdelegate = (a1: number, a2: number) => a1 + a2;\n\t\tbProxy.$m(4, 1).then((res: number) => {\n\t\t\tassert.strictEqual(res, 5);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('simple call without result', function (done) {\n\t\tdelegate = (a1: number, a2: number) => { };\n\t\tbProxy.$m(4, 1).then((res: number) => {\n\t\t\tassert.strictEqual(res, undefined);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('passing buffer as argument', function (done) {\n\t\tdelegate = (a1: VSBuffer, a2: number) => {\n\t\t\tassert.ok(a1 instanceof VSBuffer);\n\t\t\treturn a1.buffer[a2];\n\t\t};\n\t\tconst b = VSBuffer.alloc(4);\n\t\tb.buffer[0] = 1;\n\t\tb.buffer[1] = 2;\n\t\tb.buffer[2] = 3;\n\t\tb.buffer[3] = 4;\n\t\tbProxy.$m(b, 2).then((res: number) => {\n\t\t\tassert.strictEqual(res, 3);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('returning a buffer', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\tconst b = VSBuffer.alloc(4);\n\t\t\tb.buffer[0] = 1;\n\t\t\tb.buffer[1] = 2;\n\t\t\tb.buffer[2] = 3;\n\t\t\tb.buffer[3] = 4;\n\t\t\treturn b;\n\t\t};\n\t\tbProxy.$m(4, 1).then((res: VSBuffer) => {\n\t\t\tassert.ok(res instanceof VSBuffer);\n\t\t\tassert.strictEqual(res.buffer[0], 1);\n\t\t\tassert.strictEqual(res.buffer[1], 2);\n\t\t\tassert.strictEqual(res.buffer[2], 3);\n\t\t\tassert.strictEqual(res.buffer[3], 4);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('cancelling a call via CancellationToken before', function (done) {\n\t\tdelegate = (a1: number, a2: number) => a1 + a2;\n\t\tconst p = bProxy.$m(4, CancellationToken.Cancelled);\n\t\tp.then((res: number) => {\n\t\t\tassert.fail('should not receive result');\n\t\t}, (err) => {\n\t\t\tassert.ok(true);\n\t\t\tdone(null);\n\t\t});\n\t});\n\n\ttest('passing CancellationToken.None', function (done) {\n\t\tdelegate = (a1: number, token: CancellationToken) => {\n\t\t\tassert.ok(!!token);\n\t\t\treturn a1 + 1;\n\t\t};\n\t\tbProxy.$m(4, CancellationToken.None).then((res: number) => {\n\t\t\tassert.strictEqual(res, 5);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('cancelling a call via CancellationToken quickly', function (done) {\n\t\t// this is an implementation which, when cancellation is triggered, will return 7\n\t\tdelegate = (a1: number, token: CancellationToken) => {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst disposable = token.onCancellationRequested((e) => {\n\t\t\t\t\tdisposable.dispose();\n\t\t\t\t\tresolve(7);\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\t\tconst tokenSource = new CancellationTokenSource();\n\t\tconst p = bProxy.$m(4, tokenSource.token);\n\t\tp.then((res: number) => {\n\t\t\tassert.strictEqual(res, 7);\n\t\t}, (err) => {\n\t\t\tassert.fail('should not receive error');\n\t\t}).finally(done);\n\t\ttokenSource.cancel();\n\t});\n\n\ttest('throwing an error', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\tthrow new Error(`nope`);\n\t\t};\n\t\tbProxy.$m(4, 1).then((res) => {\n\t\t\tassert.fail('unexpected');\n\t\t}, (err) => {\n\t\t\tassert.strictEqual(err.message, 'nope');\n\t\t}).finally(done);\n\t});\n\n\ttest('error promise', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\treturn Promise.reject(undefined);\n\t\t};\n\t\tbProxy.$m(4, 1).then((res) => {\n\t\t\tassert.fail('unexpected');\n\t\t}, (err) => {\n\t\t\tassert.strictEqual(err, undefined);\n\t\t}).finally(done);\n\t});\n\n\ttest('issue #60450: Converting circular structure to JSON', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst circular = <any>{};\n\t\t\tcircular.self = circular;\n\t\t\treturn circular;\n\t\t};\n\t\tbProxy.$m(4, 1).then((res) => {\n\t\t\tassert.strictEqual(res, null);\n\t\t}, (err) => {\n\t\t\tassert.fail('unexpected');\n\t\t}).finally(done);\n\t});\n\n\ttest('issue #72798: null errors are hard to digest', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\t// eslint-disable-next-line no-throw-literal\n\t\t\tthrow { 'what': 'what' };\n\t\t};\n\t\tbProxy.$m(4, 1).then((res) => {\n\t\t\tassert.fail('unexpected');\n\t\t}, (err) => {\n\t\t\tassert.strictEqual(err.what, 'what');\n\t\t}).finally(done);\n\t});\n\n\ttest('undefined arguments arrive as null', function () {\n\t\tdelegate = (a1: any, a2: any) => {\n\t\t\tassert.strictEqual(typeof a1, 'undefined');\n\t\t\tassert.strictEqual(a2, null);\n\t\t\treturn 7;\n\t\t};\n\t\treturn bProxy.$m(undefined, null).then((res) => {\n\t\t\tassert.strictEqual(res, 7);\n\t\t});\n\t});\n\n\ttest('issue #81424: SerializeRequest should throw if an argument can not be serialized', () => {\n\t\tconst badObject = {};\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t(<any>badObject).loop = badObject;\n\n\t\tassert.throws(() => {\n\t\t\tbProxy.$m(badObject, '2');\n\t\t});\n\t});\n\n\ttest('SerializableObjectWithBuffers is correctly transfered', function (done) {\n\t\tdelegate = (a1: SerializableObjectWithBuffers<{ string: string; buff: VSBuffer }>, a2: number) => {\n\t\t\treturn new SerializableObjectWithBuffers({ string: a1.value.string + ' world', buff: a1.value.buff });\n\t\t};\n\n\t\tconst b = VSBuffer.alloc(4);\n\t\tb.buffer[0] = 1;\n\t\tb.buffer[1] = 2;\n\t\tb.buffer[2] = 3;\n\t\tb.buffer[3] = 4;\n\n\t\tbProxy.$m(new SerializableObjectWithBuffers({ string: 'hello', buff: b }), undefined).then((res: SerializableObjectWithBuffers<any>) => {\n\t\t\tassert.ok(res instanceof SerializableObjectWithBuffers);\n\t\t\tassert.strictEqual(res.value.string, 'hello world');\n\n\t\t\tassert.ok(res.value.buff instanceof VSBuffer);\n\n\t\t\tconst bufferValues = Array.from(res.value.buff.buffer);\n\n\t\t\tassert.strictEqual(bufferValues[0], 1);\n\t\t\tassert.strictEqual(bufferValues[1], 2);\n\t\t\tassert.strictEqual(bufferValues[2], 3);\n\t\t\tassert.strictEqual(bufferValues[3], 4);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { VSBuffer } from '../../../../../base/common/buffer.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { IMessagePassingProtocol } from '../../../../../base/parts/ipc/common/ipc.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { ProxyIdentifier, SerializableObjectWithBuffers } from '../../common/proxyIdentifier.js';\nimport { RPCProtocol } from '../../common/rpcProtocol.js';\n\nsuite('RPCProtocol', () => {\n\n\tlet disposables: DisposableStore;\n\n\tclass MessagePassingProtocol implements IMessagePassingProtocol {\n\t\tprivate _pair?: MessagePassingProtocol;\n\n\t\tprivate readonly _onMessage = new Emitter<VSBuffer>();\n\t\tpublic readonly onMessage: Event<VSBuffer> = this._onMessage.event;\n\n\t\tpublic setPair(other: MessagePassingProtocol) {\n\t\t\tthis._pair = other;\n\t\t}\n\n\t\tpublic send(buffer: VSBuffer): void {\n\t\t\tPromise.resolve().then(() => {\n\t\t\t\tthis._pair!._onMessage.fire(buffer);\n\t\t\t});\n\t\t}\n\t}\n\n\tlet delegate: (a1: any, a2: any) => any;\n\tlet bProxy: BClass;\n\tclass BClass {\n\t\t$m(a1: any, a2: any): Promise<any> {\n\t\t\treturn Promise.resolve(delegate.call(null, a1, a2));\n\t\t}\n\t}\n\n\tsetup(() => {\n\t\tdisposables = new DisposableStore();\n\n\t\tconst a_protocol = new MessagePassingProtocol();\n\t\tconst b_protocol = new MessagePassingProtocol();\n\t\ta_protocol.setPair(b_protocol);\n\t\tb_protocol.setPair(a_protocol);\n\n\t\tconst A = disposables.add(new RPCProtocol(a_protocol));\n\t\tconst B = disposables.add(new RPCProtocol(b_protocol));\n\n\t\tconst bIdentifier = new ProxyIdentifier<BClass>('bb');\n\t\tconst bInstance = new BClass();\n\t\tB.set(bIdentifier, bInstance);\n\t\tbProxy = A.getProxy(bIdentifier);\n\t});\n\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('simple call', function (done) {\n\t\tdelegate = (a1: number, a2: number) => a1 + a2;\n\t\tbProxy.$m(4, 1).then((res: number) => {\n\t\t\tassert.strictEqual(res, 5);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('simple call without result', function (done) {\n\t\tdelegate = (a1: number, a2: number) => { };\n\t\tbProxy.$m(4, 1).then((res: number) => {\n\t\t\tassert.strictEqual(res, undefined);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('passing buffer as argument', function (done) {\n\t\tdelegate = (a1: VSBuffer, a2: number) => {\n\t\t\tassert.ok(a1 instanceof VSBuffer);\n\t\t\treturn a1.buffer[a2];\n\t\t};\n\t\tconst b = VSBuffer.alloc(4);\n\t\tb.buffer[0] = 1;\n\t\tb.buffer[1] = 2;\n\t\tb.buffer[2] = 3;\n\t\tb.buffer[3] = 4;\n\t\tbProxy.$m(b, 2).then((res: number) => {\n\t\t\tassert.strictEqual(res, 3);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('returning a buffer', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\tconst b = VSBuffer.alloc(4);\n\t\t\tb.buffer[0] = 1;\n\t\t\tb.buffer[1] = 2;\n\t\t\tb.buffer[2] = 3;\n\t\t\tb.buffer[3] = 4;\n\t\t\treturn b;\n\t\t};\n\t\tbProxy.$m(4, 1).then((res: VSBuffer) => {\n\t\t\tassert.ok(res instanceof VSBuffer);\n\t\t\tassert.strictEqual(res.buffer[0], 1);\n\t\t\tassert.strictEqual(res.buffer[1], 2);\n\t\t\tassert.strictEqual(res.buffer[2], 3);\n\t\t\tassert.strictEqual(res.buffer[3], 4);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('cancelling a call via CancellationToken before', function (done) {\n\t\tdelegate = (a1: number, a2: number) => a1 + a2;\n\t\tconst p = bProxy.$m(4, CancellationToken.Cancelled);\n\t\tp.then((res: number) => {\n\t\t\tassert.fail('should not receive result');\n\t\t}, (err) => {\n\t\t\tassert.ok(true);\n\t\t\tdone(null);\n\t\t});\n\t});\n\n\ttest('passing CancellationToken.None', function (done) {\n\t\tdelegate = (a1: number, token: CancellationToken) => {\n\t\t\tassert.ok(!!token);\n\t\t\treturn a1 + 1;\n\t\t};\n\t\tbProxy.$m(4, CancellationToken.None).then((res: number) => {\n\t\t\tassert.strictEqual(res, 5);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n\n\ttest('cancelling a call via CancellationToken quickly', function (done) {\n\t\t// this is an implementation which, when cancellation is triggered, will return 7\n\t\tdelegate = (a1: number, token: CancellationToken) => {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst disposable = token.onCancellationRequested((e) => {\n\t\t\t\t\tdisposable.dispose();\n\t\t\t\t\tresolve(7);\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\t\tconst tokenSource = new CancellationTokenSource();\n\t\tconst p = bProxy.$m(4, tokenSource.token);\n\t\tp.then((res: number) => {\n\t\t\tassert.strictEqual(res, 7);\n\t\t}, (err) => {\n\t\t\tassert.fail('should not receive error');\n\t\t}).finally(done);\n\t\ttokenSource.cancel();\n\t});\n\n\ttest('throwing an error', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\tthrow new Error(`nope`);\n\t\t};\n\t\tbProxy.$m(4, 1).then((res) => {\n\t\t\tassert.fail('unexpected');\n\t\t}, (err) => {\n\t\t\tassert.strictEqual(err.message, 'nope');\n\t\t}).finally(done);\n\t});\n\n\ttest('error promise', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\treturn Promise.reject(undefined);\n\t\t};\n\t\tbProxy.$m(4, 1).then((res) => {\n\t\t\tassert.fail('unexpected');\n\t\t}, (err) => {\n\t\t\tassert.strictEqual(err, undefined);\n\t\t}).finally(done);\n\t});\n\n\ttest('issue #60450: Converting circular structure to JSON', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst circular = <any>{};\n\t\t\tcircular.self = circular;\n\t\t\treturn circular;\n\t\t};\n\t\tbProxy.$m(4, 1).then((res) => {\n\t\t\tassert.strictEqual(res, null);\n\t\t}, (err) => {\n\t\t\tassert.fail('unexpected');\n\t\t}).finally(done);\n\t});\n\n\ttest('issue #72798: null errors are hard to digest', function (done) {\n\t\tdelegate = (a1: number, a2: number) => {\n\t\t\t// eslint-disable-next-line no-throw-literal\n\t\t\tthrow { 'what': 'what' };\n\t\t};\n\t\tbProxy.$m(4, 1).then((res) => {\n\t\t\tassert.fail('unexpected');\n\t\t}, (err) => {\n\t\t\tassert.strictEqual(err.what, 'what');\n\t\t}).finally(done);\n\t});\n\n\ttest('undefined arguments arrive as null', function () {\n\t\tdelegate = (a1: any, a2: any) => {\n\t\t\tassert.strictEqual(typeof a1, 'undefined');\n\t\t\tassert.strictEqual(a2, null);\n\t\t\treturn 7;\n\t\t};\n\t\treturn bProxy.$m(undefined, null).then((res) => {\n\t\t\tassert.strictEqual(res, 7);\n\t\t});\n\t});\n\n\ttest('issue #81424: SerializeRequest should throw if an argument can not be serialized', () => {\n\t\tconst badObject = {};\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t(<any>badObject).loop = badObject;\n\n\t\tassert.throws(() => {\n\t\t\tbProxy.$m(badObject, '2');\n\t\t});\n\t});\n\n\ttest('SerializableObjectWithBuffers is correctly transfered', function (done) {\n\t\tdelegate = (a1: SerializableObjectWithBuffers<{ string: string; buff: VSBuffer }>, a2: number) => {\n\t\t\treturn new SerializableObjectWithBuffers({ string: a1.value.string + ' world', buff: a1.value.buff });\n\t\t};\n\n\t\tconst b = VSBuffer.alloc(4);\n\t\tb.buffer[0] = 1;\n\t\tb.buffer[1] = 2;\n\t\tb.buffer[2] = 3;\n\t\tb.buffer[3] = 4;\n\n\t\tbProxy.$m(new SerializableObjectWithBuffers({ string: 'hello', buff: b }), undefined).then((res: SerializableObjectWithBuffers<any>) => {\n\t\t\tassert.ok(res instanceof SerializableObjectWithBuffers);\n\t\t\tassert.strictEqual(res.value.string, 'hello world');\n\n\t\t\tassert.ok(res.value.buff instanceof VSBuffer);\n\n\t\t\tconst bufferValues = Array.from(res.value.buff.buffer);\n\n\t\t\tassert.strictEqual(bufferValues[0], 1);\n\t\t\tassert.strictEqual(bufferValues[1], 2);\n\t\t\tassert.strictEqual(bufferValues[2], 3);\n\t\t\tassert.strictEqual(bufferValues[3], 4);\n\t\t\tdone(null);\n\t\t}, done);\n\t});\n});\n"]}