{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/extensions/common/rpcProtocol.ts","vs/workbench/services/extensions/common/rpcProtocol.ts"],"names":[],"mappings":"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","file":"rpcProtocol.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { CharCode } from '../../../../base/common/charCode.js';\nimport * as errors from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../../base/common/lifecycle.js';\nimport { MarshalledObject } from '../../../../base/common/marshalling.js';\nimport { MarshalledId } from '../../../../base/common/marshallingIds.js';\nimport { IURITransformer, transformIncomingURIs } from '../../../../base/common/uriIpc.js';\nimport { IMessagePassingProtocol } from '../../../../base/parts/ipc/common/ipc.js';\nimport { CanceledLazyPromise, LazyPromise } from './lazyPromise.js';\nimport { getStringIdentifierForProxy, IRPCProtocol, Proxied, ProxyIdentifier, SerializableObjectWithBuffers } from './proxyIdentifier.js';\n\nexport interface JSONStringifyReplacer {\n\t(key: string, value: any): any;\n}\n\nfunction safeStringify(obj: any, replacer: JSONStringifyReplacer | null): string {\n\ttry {\n\t\treturn JSON.stringify(obj, <(key: string, value: any) => any>replacer);\n\t} catch (err) {\n\t\treturn 'null';\n\t}\n}\n\nconst refSymbolName = '$$ref$$';\nconst undefinedRef = { [refSymbolName]: -1 } as const;\n\nclass StringifiedJsonWithBufferRefs {\n\tconstructor(\n\t\tpublic readonly jsonString: string,\n\t\tpublic readonly referencedBuffers: readonly VSBuffer[],\n\t) { }\n}\n\nexport function stringifyJsonWithBufferRefs<T>(obj: T, replacer: JSONStringifyReplacer | null = null, useSafeStringify = false): StringifiedJsonWithBufferRefs {\n\tconst foundBuffers: VSBuffer[] = [];\n\tconst serialized = (useSafeStringify ? safeStringify : JSON.stringify)(obj, (key, value) => {\n\t\tif (typeof value === 'undefined') {\n\t\t\treturn undefinedRef; // JSON.stringify normally converts 'undefined' to 'null'\n\t\t} else if (typeof value === 'object') {\n\t\t\tif (value instanceof VSBuffer) {\n\t\t\t\tconst bufferIndex = foundBuffers.push(value) - 1;\n\t\t\t\treturn { [refSymbolName]: bufferIndex };\n\t\t\t}\n\t\t\tif (replacer) {\n\t\t\t\treturn replacer(key, value);\n\t\t\t}\n\t\t}\n\t\treturn value;\n\t});\n\treturn {\n\t\tjsonString: serialized,\n\t\treferencedBuffers: foundBuffers\n\t};\n}\n\nexport function parseJsonAndRestoreBufferRefs(jsonString: string, buffers: readonly VSBuffer[], uriTransformer: IURITransformer | null): any {\n\treturn JSON.parse(jsonString, (_key, value) => {\n\t\tif (value) {\n\t\t\tconst ref = value[refSymbolName];\n\t\t\tif (typeof ref === 'number') {\n\t\t\t\treturn buffers[ref];\n\t\t\t}\n\n\t\t\tif (uriTransformer && (<MarshalledObject>value).$mid === MarshalledId.Uri) {\n\t\t\t\treturn uriTransformer.transformIncoming(value);\n\t\t\t}\n\t\t}\n\t\treturn value;\n\t});\n}\n\n\nfunction stringify(obj: any, replacer: JSONStringifyReplacer | null): string {\n\treturn JSON.stringify(obj, <(key: string, value: any) => any>replacer);\n}\n\nfunction createURIReplacer(transformer: IURITransformer | null): JSONStringifyReplacer | null {\n\tif (!transformer) {\n\t\treturn null;\n\t}\n\treturn (key: string, value: any): any => {\n\t\tif (value && value.$mid === MarshalledId.Uri) {\n\t\t\treturn transformer.transformOutgoing(value);\n\t\t}\n\t\treturn value;\n\t};\n}\n\nexport const enum RequestInitiator {\n\tLocalSide = 0,\n\tOtherSide = 1\n}\n\nexport const enum ResponsiveState {\n\tResponsive = 0,\n\tUnresponsive = 1\n}\n\nexport interface IRPCProtocolLogger {\n\tlogIncoming(msgLength: number, req: number, initiator: RequestInitiator, str: string, data?: any): void;\n\tlogOutgoing(msgLength: number, req: number, initiator: RequestInitiator, str: string, data?: any): void;\n}\n\nconst noop = () => { };\n\nconst _RPCProtocolSymbol = Symbol.for('rpcProtocol');\nconst _RPCProxySymbol = Symbol.for('rpcProxy');\n\nexport class RPCProtocol extends Disposable implements IRPCProtocol {\n\n\t[_RPCProtocolSymbol] = true;\n\n\tprivate static readonly UNRESPONSIVE_TIME = 3 * 1000; // 3s\n\n\tprivate readonly _onDidChangeResponsiveState: Emitter<ResponsiveState> = this._register(new Emitter<ResponsiveState>());\n\tpublic readonly onDidChangeResponsiveState: Event<ResponsiveState> = this._onDidChangeResponsiveState.event;\n\n\tprivate readonly _protocol: IMessagePassingProtocol;\n\tprivate readonly _logger: IRPCProtocolLogger | null;\n\tprivate readonly _uriTransformer: IURITransformer | null;\n\tprivate readonly _uriReplacer: JSONStringifyReplacer | null;\n\tprivate _isDisposed: boolean;\n\tprivate readonly _locals: any[];\n\tprivate readonly _proxies: any[];\n\tprivate _lastMessageId: number;\n\tprivate readonly _cancelInvokedHandlers: { [req: string]: () => void };\n\tprivate readonly _pendingRPCReplies: { [msgId: string]: PendingRPCReply };\n\tprivate _responsiveState: ResponsiveState;\n\tprivate _unacknowledgedCount: number;\n\tprivate _unresponsiveTime: number;\n\tprivate _asyncCheckUresponsive: RunOnceScheduler;\n\n\tconstructor(protocol: IMessagePassingProtocol, logger: IRPCProtocolLogger | null = null, transformer: IURITransformer | null = null) {\n\t\tsuper();\n\t\tthis._protocol = protocol;\n\t\tthis._logger = logger;\n\t\tthis._uriTransformer = transformer;\n\t\tthis._uriReplacer = createURIReplacer(this._uriTransformer);\n\t\tthis._isDisposed = false;\n\t\tthis._locals = [];\n\t\tthis._proxies = [];\n\t\tfor (let i = 0, len = ProxyIdentifier.count; i < len; i++) {\n\t\t\tthis._locals[i] = null;\n\t\t\tthis._proxies[i] = null;\n\t\t}\n\t\tthis._lastMessageId = 0;\n\t\tthis._cancelInvokedHandlers = Object.create(null);\n\t\tthis._pendingRPCReplies = {};\n\t\tthis._responsiveState = ResponsiveState.Responsive;\n\t\tthis._unacknowledgedCount = 0;\n\t\tthis._unresponsiveTime = 0;\n\t\tthis._asyncCheckUresponsive = this._register(new RunOnceScheduler(() => this._checkUnresponsive(), 1000));\n\t\tthis._register(this._protocol.onMessage((msg) => this._receiveOneMessage(msg)));\n\t}\n\n\tpublic override dispose(): void {\n\t\tthis._isDisposed = true;\n\n\t\t// Release all outstanding promises with a canceled error\n\t\tObject.keys(this._pendingRPCReplies).forEach((msgId) => {\n\t\t\tconst pending = this._pendingRPCReplies[msgId];\n\t\t\tdelete this._pendingRPCReplies[msgId];\n\t\t\tpending.resolveErr(errors.canceled());\n\t\t});\n\n\t\tsuper.dispose();\n\t}\n\n\tpublic drain(): Promise<void> {\n\t\tif (typeof this._protocol.drain === 'function') {\n\t\t\treturn this._protocol.drain();\n\t\t}\n\t\treturn Promise.resolve();\n\t}\n\n\tprivate _onWillSendRequest(req: number): void {\n\t\tif (this._unacknowledgedCount === 0) {\n\t\t\t// Since this is the first request we are sending in a while,\n\t\t\t// mark this moment as the start for the countdown to unresponsive time\n\t\t\tthis._unresponsiveTime = Date.now() + RPCProtocol.UNRESPONSIVE_TIME;\n\t\t}\n\t\tthis._unacknowledgedCount++;\n\t\tif (!this._asyncCheckUresponsive.isScheduled()) {\n\t\t\tthis._asyncCheckUresponsive.schedule();\n\t\t}\n\t}\n\n\tprivate _onDidReceiveAcknowledge(req: number): void {\n\t\t// The next possible unresponsive time is now + delta.\n\t\tthis._unresponsiveTime = Date.now() + RPCProtocol.UNRESPONSIVE_TIME;\n\t\tthis._unacknowledgedCount--;\n\t\tif (this._unacknowledgedCount === 0) {\n\t\t\t// No more need to check for unresponsive\n\t\t\tthis._asyncCheckUresponsive.cancel();\n\t\t}\n\t\t// The ext host is responsive!\n\t\tthis._setResponsiveState(ResponsiveState.Responsive);\n\t}\n\n\tprivate _checkUnresponsive(): void {\n\t\tif (this._unacknowledgedCount === 0) {\n\t\t\t// Not waiting for anything => cannot say if it is responsive or not\n\t\t\treturn;\n\t\t}\n\n\t\tif (Date.now() > this._unresponsiveTime) {\n\t\t\t// Unresponsive!!\n\t\t\tthis._setResponsiveState(ResponsiveState.Unresponsive);\n\t\t} else {\n\t\t\t// Not (yet) unresponsive, be sure to check again soon\n\t\t\tthis._asyncCheckUresponsive.schedule();\n\t\t}\n\t}\n\n\tprivate _setResponsiveState(newResponsiveState: ResponsiveState): void {\n\t\tif (this._responsiveState === newResponsiveState) {\n\t\t\t// no change\n\t\t\treturn;\n\t\t}\n\t\tthis._responsiveState = newResponsiveState;\n\t\tthis._onDidChangeResponsiveState.fire(this._responsiveState);\n\t}\n\n\tpublic get responsiveState(): ResponsiveState {\n\t\treturn this._responsiveState;\n\t}\n\n\tpublic transformIncomingURIs<T>(obj: T): T {\n\t\tif (!this._uriTransformer) {\n\t\t\treturn obj;\n\t\t}\n\t\treturn transformIncomingURIs(obj, this._uriTransformer);\n\t}\n\n\tpublic getProxy<T>(identifier: ProxyIdentifier<T>): Proxied<T> {\n\t\tconst { nid: rpcId, sid } = identifier;\n\t\tif (!this._proxies[rpcId]) {\n\t\t\tthis._proxies[rpcId] = this._createProxy(rpcId, sid);\n\t\t}\n\t\treturn this._proxies[rpcId];\n\t}\n\n\tprivate _createProxy<T>(rpcId: number, debugName: string): T {\n\t\tconst handler = {\n\t\t\tget: (target: any, name: PropertyKey) => {\n\t\t\t\tif (typeof name === 'string' && !target[name] && name.charCodeAt(0) === CharCode.DollarSign) {\n\t\t\t\t\ttarget[name] = (...myArgs: any[]) => {\n\t\t\t\t\t\treturn this._remoteCall(rpcId, name, myArgs);\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tif (name === _RPCProxySymbol) {\n\t\t\t\t\treturn debugName;\n\t\t\t\t}\n\t\t\t\treturn target[name];\n\t\t\t}\n\t\t};\n\t\treturn new Proxy(Object.create(null), handler);\n\t}\n\n\tpublic set<T, R extends T>(identifier: ProxyIdentifier<T>, value: R): R {\n\t\tthis._locals[identifier.nid] = value;\n\t\treturn value;\n\t}\n\n\tpublic assertRegistered(identifiers: ProxyIdentifier<any>[]): void {\n\t\tfor (let i = 0, len = identifiers.length; i < len; i++) {\n\t\t\tconst identifier = identifiers[i];\n\t\t\tif (!this._locals[identifier.nid]) {\n\t\t\t\tthrow new Error(`Missing proxy instance ${identifier.sid}`);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _receiveOneMessage(rawmsg: VSBuffer): void {\n\t\tif (this._isDisposed) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst msgLength = rawmsg.byteLength;\n\t\tconst buff = MessageBuffer.read(rawmsg, 0);\n\t\tconst messageType = <MessageType>buff.readUInt8();\n\t\tconst req = buff.readUInt32();\n\n\t\tswitch (messageType) {\n\t\t\tcase MessageType.RequestJSONArgs:\n\t\t\tcase MessageType.RequestJSONArgsWithCancellation: {\n\t\t\t\tlet { rpcId, method, args } = MessageIO.deserializeRequestJSONArgs(buff);\n\t\t\t\tif (this._uriTransformer) {\n\t\t\t\t\targs = transformIncomingURIs(args, this._uriTransformer);\n\t\t\t\t}\n\t\t\t\tthis._receiveRequest(msgLength, req, rpcId, method, args, (messageType === MessageType.RequestJSONArgsWithCancellation));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.RequestMixedArgs:\n\t\t\tcase MessageType.RequestMixedArgsWithCancellation: {\n\t\t\t\tlet { rpcId, method, args } = MessageIO.deserializeRequestMixedArgs(buff);\n\t\t\t\tif (this._uriTransformer) {\n\t\t\t\t\targs = transformIncomingURIs(args, this._uriTransformer);\n\t\t\t\t}\n\t\t\t\tthis._receiveRequest(msgLength, req, rpcId, method, args, (messageType === MessageType.RequestMixedArgsWithCancellation));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.Acknowledged: {\n\t\t\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.LocalSide, `ack`);\n\t\t\t\tthis._onDidReceiveAcknowledge(req);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.Cancel: {\n\t\t\t\tthis._receiveCancel(msgLength, req);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyOKEmpty: {\n\t\t\t\tthis._receiveReply(msgLength, req, undefined);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyOKJSON: {\n\t\t\t\tlet value = MessageIO.deserializeReplyOKJSON(buff);\n\t\t\t\tif (this._uriTransformer) {\n\t\t\t\t\tvalue = transformIncomingURIs(value, this._uriTransformer);\n\t\t\t\t}\n\t\t\t\tthis._receiveReply(msgLength, req, value);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyOKJSONWithBuffers: {\n\t\t\t\tconst value = MessageIO.deserializeReplyOKJSONWithBuffers(buff, this._uriTransformer);\n\t\t\t\tthis._receiveReply(msgLength, req, value);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyOKVSBuffer: {\n\t\t\t\tconst value = MessageIO.deserializeReplyOKVSBuffer(buff);\n\t\t\t\tthis._receiveReply(msgLength, req, value);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyErrError: {\n\t\t\t\tlet err = MessageIO.deserializeReplyErrError(buff);\n\t\t\t\tif (this._uriTransformer) {\n\t\t\t\t\terr = transformIncomingURIs(err, this._uriTransformer);\n\t\t\t\t}\n\t\t\t\tthis._receiveReplyErr(msgLength, req, err);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyErrEmpty: {\n\t\t\t\tthis._receiveReplyErr(msgLength, req, undefined);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.error(`received unexpected message`);\n\t\t\t\tconsole.error(rawmsg);\n\t\t}\n\t}\n\n\tprivate _receiveRequest(msgLength: number, req: number, rpcId: number, method: string, args: any[], usesCancellationToken: boolean): void {\n\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.OtherSide, `receiveRequest ${getStringIdentifierForProxy(rpcId)}.${method}(`, args);\n\t\tconst callId = String(req);\n\n\t\tlet promise: Promise<any>;\n\t\tlet cancel: () => void;\n\t\tif (usesCancellationToken) {\n\t\t\tconst cancellationTokenSource = new CancellationTokenSource();\n\t\t\targs.push(cancellationTokenSource.token);\n\t\t\tpromise = this._invokeHandler(rpcId, method, args);\n\t\t\tcancel = () => cancellationTokenSource.cancel();\n\t\t} else {\n\t\t\t// cannot be cancelled\n\t\t\tpromise = this._invokeHandler(rpcId, method, args);\n\t\t\tcancel = noop;\n\t\t}\n\n\t\tthis._cancelInvokedHandlers[callId] = cancel;\n\n\t\t// Acknowledge the request\n\t\tconst msg = MessageIO.serializeAcknowledged(req);\n\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.OtherSide, `ack`);\n\t\tthis._protocol.send(msg);\n\n\t\tpromise.then((r) => {\n\t\t\tdelete this._cancelInvokedHandlers[callId];\n\t\t\tconst msg = MessageIO.serializeReplyOK(req, r, this._uriReplacer);\n\t\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.OtherSide, `reply:`, r);\n\t\t\tthis._protocol.send(msg);\n\t\t}, (err) => {\n\t\t\tdelete this._cancelInvokedHandlers[callId];\n\t\t\tconst msg = MessageIO.serializeReplyErr(req, err);\n\t\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.OtherSide, `replyErr:`, err);\n\t\t\tthis._protocol.send(msg);\n\t\t});\n\t}\n\n\tprivate _receiveCancel(msgLength: number, req: number): void {\n\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.OtherSide, `receiveCancel`);\n\t\tconst callId = String(req);\n\t\tthis._cancelInvokedHandlers[callId]?.();\n\t}\n\n\tprivate _receiveReply(msgLength: number, req: number, value: any): void {\n\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.LocalSide, `receiveReply:`, value);\n\t\tconst callId = String(req);\n\t\tif (!this._pendingRPCReplies.hasOwnProperty(callId)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst pendingReply = this._pendingRPCReplies[callId];\n\t\tdelete this._pendingRPCReplies[callId];\n\n\t\tpendingReply.resolveOk(value);\n\t}\n\n\tprivate _receiveReplyErr(msgLength: number, req: number, value: any): void {\n\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.LocalSide, `receiveReplyErr:`, value);\n\n\t\tconst callId = String(req);\n\t\tif (!this._pendingRPCReplies.hasOwnProperty(callId)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst pendingReply = this._pendingRPCReplies[callId];\n\t\tdelete this._pendingRPCReplies[callId];\n\n\t\tlet err: any = undefined;\n\t\tif (value) {\n\t\t\tif (value.$isError) {\n\t\t\t\terr = new Error();\n\t\t\t\terr.name = value.name;\n\t\t\t\terr.message = value.message;\n\t\t\t\terr.stack = value.stack;\n\t\t\t} else {\n\t\t\t\terr = value;\n\t\t\t}\n\t\t}\n\t\tpendingReply.resolveErr(err);\n\t}\n\n\tprivate _invokeHandler(rpcId: number, methodName: string, args: any[]): Promise<any> {\n\t\ttry {\n\t\t\treturn Promise.resolve(this._doInvokeHandler(rpcId, methodName, args));\n\t\t} catch (err) {\n\t\t\treturn Promise.reject(err);\n\t\t}\n\t}\n\n\tprivate _doInvokeHandler(rpcId: number, methodName: string, args: any[]): any {\n\t\tconst actor = this._locals[rpcId];\n\t\tif (!actor) {\n\t\t\tthrow new Error('Unknown actor ' + getStringIdentifierForProxy(rpcId));\n\t\t}\n\t\tconst method = actor[methodName];\n\t\tif (typeof method !== 'function') {\n\t\t\tthrow new Error('Unknown method ' + methodName + ' on actor ' + getStringIdentifierForProxy(rpcId));\n\t\t}\n\t\treturn method.apply(actor, args);\n\t}\n\n\tprivate _remoteCall(rpcId: number, methodName: string, args: any[]): Promise<any> {\n\t\tif (this._isDisposed) {\n\t\t\treturn new CanceledLazyPromise();\n\t\t}\n\t\tlet cancellationToken: CancellationToken | null = null;\n\t\tif (args.length > 0 && CancellationToken.isCancellationToken(args[args.length - 1])) {\n\t\t\tcancellationToken = args.pop();\n\t\t}\n\n\t\tif (cancellationToken && cancellationToken.isCancellationRequested) {\n\t\t\t// No need to do anything...\n\t\t\treturn Promise.reject<any>(errors.canceled());\n\t\t}\n\n\t\tconst serializedRequestArguments = MessageIO.serializeRequestArguments(args, this._uriReplacer);\n\n\t\tconst req = ++this._lastMessageId;\n\t\tconst callId = String(req);\n\t\tconst result = new LazyPromise();\n\n\t\tconst disposable = new DisposableStore();\n\t\tif (cancellationToken) {\n\t\t\tdisposable.add(cancellationToken.onCancellationRequested(() => {\n\t\t\t\tconst msg = MessageIO.serializeCancel(req);\n\t\t\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.LocalSide, `cancel`);\n\t\t\t\tthis._protocol.send(msg);\n\t\t\t}));\n\t\t}\n\n\t\tthis._pendingRPCReplies[callId] = new PendingRPCReply(result, disposable);\n\t\tthis._onWillSendRequest(req);\n\t\tconst msg = MessageIO.serializeRequest(req, rpcId, methodName, serializedRequestArguments, !!cancellationToken);\n\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.LocalSide, `request: ${getStringIdentifierForProxy(rpcId)}.${methodName}(`, args);\n\t\tthis._protocol.send(msg);\n\t\treturn result;\n\t}\n}\n\nclass PendingRPCReply {\n\tconstructor(\n\t\tprivate readonly _promise: LazyPromise,\n\t\tprivate readonly _disposable: IDisposable\n\t) { }\n\n\tpublic resolveOk(value: any): void {\n\t\tthis._promise.resolveOk(value);\n\t\tthis._disposable.dispose();\n\t}\n\n\tpublic resolveErr(err: any): void {\n\t\tthis._promise.resolveErr(err);\n\t\tthis._disposable.dispose();\n\t}\n}\n\nclass MessageBuffer {\n\n\tpublic static alloc(type: MessageType, req: number, messageSize: number): MessageBuffer {\n\t\tconst result = new MessageBuffer(VSBuffer.alloc(messageSize + 1 /* type */ + 4 /* req */), 0);\n\t\tresult.writeUInt8(type);\n\t\tresult.writeUInt32(req);\n\t\treturn result;\n\t}\n\n\tpublic static read(buff: VSBuffer, offset: number): MessageBuffer {\n\t\treturn new MessageBuffer(buff, offset);\n\t}\n\n\tprivate _buff: VSBuffer;\n\tprivate _offset: number;\n\n\tpublic get buffer(): VSBuffer {\n\t\treturn this._buff;\n\t}\n\n\tprivate constructor(buff: VSBuffer, offset: number) {\n\t\tthis._buff = buff;\n\t\tthis._offset = offset;\n\t}\n\n\tpublic static sizeUInt8(): number {\n\t\treturn 1;\n\t}\n\n\tpublic static readonly sizeUInt32 = 4;\n\n\tpublic writeUInt8(n: number): void {\n\t\tthis._buff.writeUInt8(n, this._offset); this._offset += 1;\n\t}\n\n\tpublic readUInt8(): number {\n\t\tconst n = this._buff.readUInt8(this._offset); this._offset += 1;\n\t\treturn n;\n\t}\n\n\tpublic writeUInt32(n: number): void {\n\t\tthis._buff.writeUInt32BE(n, this._offset); this._offset += 4;\n\t}\n\n\tpublic readUInt32(): number {\n\t\tconst n = this._buff.readUInt32BE(this._offset); this._offset += 4;\n\t\treturn n;\n\t}\n\n\tpublic static sizeShortString(str: VSBuffer): number {\n\t\treturn 1 /* string length */ + str.byteLength /* actual string */;\n\t}\n\n\tpublic writeShortString(str: VSBuffer): void {\n\t\tthis._buff.writeUInt8(str.byteLength, this._offset); this._offset += 1;\n\t\tthis._buff.set(str, this._offset); this._offset += str.byteLength;\n\t}\n\n\tpublic readShortString(): string {\n\t\tconst strByteLength = this._buff.readUInt8(this._offset); this._offset += 1;\n\t\tconst strBuff = this._buff.slice(this._offset, this._offset + strByteLength);\n\t\tconst str = strBuff.toString(); this._offset += strByteLength;\n\t\treturn str;\n\t}\n\n\tpublic static sizeLongString(str: VSBuffer): number {\n\t\treturn 4 /* string length */ + str.byteLength /* actual string */;\n\t}\n\n\tpublic writeLongString(str: VSBuffer): void {\n\t\tthis._buff.writeUInt32BE(str.byteLength, this._offset); this._offset += 4;\n\t\tthis._buff.set(str, this._offset); this._offset += str.byteLength;\n\t}\n\n\tpublic readLongString(): string {\n\t\tconst strByteLength = this._buff.readUInt32BE(this._offset); this._offset += 4;\n\t\tconst strBuff = this._buff.slice(this._offset, this._offset + strByteLength);\n\t\tconst str = strBuff.toString(); this._offset += strByteLength;\n\t\treturn str;\n\t}\n\n\tpublic writeBuffer(buff: VSBuffer): void {\n\t\tthis._buff.writeUInt32BE(buff.byteLength, this._offset); this._offset += 4;\n\t\tthis._buff.set(buff, this._offset); this._offset += buff.byteLength;\n\t}\n\n\tpublic static sizeVSBuffer(buff: VSBuffer): number {\n\t\treturn 4 /* buffer length */ + buff.byteLength /* actual buffer */;\n\t}\n\n\tpublic writeVSBuffer(buff: VSBuffer): void {\n\t\tthis._buff.writeUInt32BE(buff.byteLength, this._offset); this._offset += 4;\n\t\tthis._buff.set(buff, this._offset); this._offset += buff.byteLength;\n\t}\n\n\tpublic readVSBuffer(): VSBuffer {\n\t\tconst buffLength = this._buff.readUInt32BE(this._offset); this._offset += 4;\n\t\tconst buff = this._buff.slice(this._offset, this._offset + buffLength); this._offset += buffLength;\n\t\treturn buff;\n\t}\n\n\tpublic static sizeMixedArray(arr: readonly MixedArg[]): number {\n\t\tlet size = 0;\n\t\tsize += 1; // arr length\n\t\tfor (let i = 0, len = arr.length; i < len; i++) {\n\t\t\tconst el = arr[i];\n\t\t\tsize += 1; // arg type\n\t\t\tswitch (el.type) {\n\t\t\t\tcase ArgType.String:\n\t\t\t\t\tsize += this.sizeLongString(el.value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.VSBuffer:\n\t\t\t\t\tsize += this.sizeVSBuffer(el.value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.SerializedObjectWithBuffers:\n\t\t\t\t\tsize += this.sizeUInt32; // buffer count\n\t\t\t\t\tsize += this.sizeLongString(el.value);\n\t\t\t\t\tfor (let i = 0; i < el.buffers.length; ++i) {\n\t\t\t\t\t\tsize += this.sizeVSBuffer(el.buffers[i]);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.Undefined:\n\t\t\t\t\t// empty...\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn size;\n\t}\n\n\tpublic writeMixedArray(arr: readonly MixedArg[]): void {\n\t\tthis._buff.writeUInt8(arr.length, this._offset); this._offset += 1;\n\t\tfor (let i = 0, len = arr.length; i < len; i++) {\n\t\t\tconst el = arr[i];\n\t\t\tswitch (el.type) {\n\t\t\t\tcase ArgType.String:\n\t\t\t\t\tthis.writeUInt8(ArgType.String);\n\t\t\t\t\tthis.writeLongString(el.value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.VSBuffer:\n\t\t\t\t\tthis.writeUInt8(ArgType.VSBuffer);\n\t\t\t\t\tthis.writeVSBuffer(el.value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.SerializedObjectWithBuffers:\n\t\t\t\t\tthis.writeUInt8(ArgType.SerializedObjectWithBuffers);\n\t\t\t\t\tthis.writeUInt32(el.buffers.length);\n\t\t\t\t\tthis.writeLongString(el.value);\n\t\t\t\t\tfor (let i = 0; i < el.buffers.length; ++i) {\n\t\t\t\t\t\tthis.writeBuffer(el.buffers[i]);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.Undefined:\n\t\t\t\t\tthis.writeUInt8(ArgType.Undefined);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic readMixedArray(): Array<string | VSBuffer | SerializableObjectWithBuffers<any> | undefined> {\n\t\tconst arrLen = this._buff.readUInt8(this._offset); this._offset += 1;\n\t\tconst arr: Array<string | VSBuffer | SerializableObjectWithBuffers<any> | undefined> = new Array(arrLen);\n\t\tfor (let i = 0; i < arrLen; i++) {\n\t\t\tconst argType = <ArgType>this.readUInt8();\n\t\t\tswitch (argType) {\n\t\t\t\tcase ArgType.String:\n\t\t\t\t\tarr[i] = this.readLongString();\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.VSBuffer:\n\t\t\t\t\tarr[i] = this.readVSBuffer();\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.SerializedObjectWithBuffers: {\n\t\t\t\t\tconst bufferCount = this.readUInt32();\n\t\t\t\t\tconst jsonString = this.readLongString();\n\t\t\t\t\tconst buffers: VSBuffer[] = [];\n\t\t\t\t\tfor (let i = 0; i < bufferCount; ++i) {\n\t\t\t\t\t\tbuffers.push(this.readVSBuffer());\n\t\t\t\t\t}\n\t\t\t\t\tarr[i] = new SerializableObjectWithBuffers(parseJsonAndRestoreBufferRefs(jsonString, buffers, null));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase ArgType.Undefined:\n\t\t\t\t\tarr[i] = undefined;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn arr;\n\t}\n}\n\nconst enum SerializedRequestArgumentType {\n\tSimple,\n\tMixed,\n}\n\ntype SerializedRequestArguments =\n\t| { readonly type: SerializedRequestArgumentType.Simple; args: string }\n\t| { readonly type: SerializedRequestArgumentType.Mixed; args: MixedArg[] };\n\n\nclass MessageIO {\n\n\tprivate static _useMixedArgSerialization(arr: any[]): boolean {\n\t\tfor (let i = 0, len = arr.length; i < len; i++) {\n\t\t\tif (arr[i] instanceof VSBuffer) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (arr[i] instanceof SerializableObjectWithBuffers) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (typeof arr[i] === 'undefined') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic static serializeRequestArguments(args: any[], replacer: JSONStringifyReplacer | null): SerializedRequestArguments {\n\t\tif (this._useMixedArgSerialization(args)) {\n\t\t\tconst massagedArgs: MixedArg[] = [];\n\t\t\tfor (let i = 0, len = args.length; i < len; i++) {\n\t\t\t\tconst arg = args[i];\n\t\t\t\tif (arg instanceof VSBuffer) {\n\t\t\t\t\tmassagedArgs[i] = { type: ArgType.VSBuffer, value: arg };\n\t\t\t\t} else if (typeof arg === 'undefined') {\n\t\t\t\t\tmassagedArgs[i] = { type: ArgType.Undefined };\n\t\t\t\t} else if (arg instanceof SerializableObjectWithBuffers) {\n\t\t\t\t\tconst { jsonString, referencedBuffers } = stringifyJsonWithBufferRefs(arg.value, replacer);\n\t\t\t\t\tmassagedArgs[i] = { type: ArgType.SerializedObjectWithBuffers, value: VSBuffer.fromString(jsonString), buffers: referencedBuffers };\n\t\t\t\t} else {\n\t\t\t\t\tmassagedArgs[i] = { type: ArgType.String, value: VSBuffer.fromString(stringify(arg, replacer)) };\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn {\n\t\t\t\ttype: SerializedRequestArgumentType.Mixed,\n\t\t\t\targs: massagedArgs,\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\ttype: SerializedRequestArgumentType.Simple,\n\t\t\targs: stringify(args, replacer)\n\t\t};\n\t}\n\n\tpublic static serializeRequest(req: number, rpcId: number, method: string, serializedArgs: SerializedRequestArguments, usesCancellationToken: boolean): VSBuffer {\n\t\tswitch (serializedArgs.type) {\n\t\t\tcase SerializedRequestArgumentType.Simple:\n\t\t\t\treturn this._requestJSONArgs(req, rpcId, method, serializedArgs.args, usesCancellationToken);\n\t\t\tcase SerializedRequestArgumentType.Mixed:\n\t\t\t\treturn this._requestMixedArgs(req, rpcId, method, serializedArgs.args, usesCancellationToken);\n\t\t}\n\t}\n\n\tprivate static _requestJSONArgs(req: number, rpcId: number, method: string, args: string, usesCancellationToken: boolean): VSBuffer {\n\t\tconst methodBuff = VSBuffer.fromString(method);\n\t\tconst argsBuff = VSBuffer.fromString(args);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeUInt8();\n\t\tlen += MessageBuffer.sizeShortString(methodBuff);\n\t\tlen += MessageBuffer.sizeLongString(argsBuff);\n\n\t\tconst result = MessageBuffer.alloc(usesCancellationToken ? MessageType.RequestJSONArgsWithCancellation : MessageType.RequestJSONArgs, req, len);\n\t\tresult.writeUInt8(rpcId);\n\t\tresult.writeShortString(methodBuff);\n\t\tresult.writeLongString(argsBuff);\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeRequestJSONArgs(buff: MessageBuffer): { rpcId: number; method: string; args: any[] } {\n\t\tconst rpcId = buff.readUInt8();\n\t\tconst method = buff.readShortString();\n\t\tconst args = buff.readLongString();\n\t\treturn {\n\t\t\trpcId: rpcId,\n\t\t\tmethod: method,\n\t\t\targs: JSON.parse(args)\n\t\t};\n\t}\n\n\tprivate static _requestMixedArgs(req: number, rpcId: number, method: string, args: readonly MixedArg[], usesCancellationToken: boolean): VSBuffer {\n\t\tconst methodBuff = VSBuffer.fromString(method);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeUInt8();\n\t\tlen += MessageBuffer.sizeShortString(methodBuff);\n\t\tlen += MessageBuffer.sizeMixedArray(args);\n\n\t\tconst result = MessageBuffer.alloc(usesCancellationToken ? MessageType.RequestMixedArgsWithCancellation : MessageType.RequestMixedArgs, req, len);\n\t\tresult.writeUInt8(rpcId);\n\t\tresult.writeShortString(methodBuff);\n\t\tresult.writeMixedArray(args);\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeRequestMixedArgs(buff: MessageBuffer): { rpcId: number; method: string; args: any[] } {\n\t\tconst rpcId = buff.readUInt8();\n\t\tconst method = buff.readShortString();\n\t\tconst rawargs = buff.readMixedArray();\n\t\tconst args: any[] = new Array(rawargs.length);\n\t\tfor (let i = 0, len = rawargs.length; i < len; i++) {\n\t\t\tconst rawarg = rawargs[i];\n\t\t\tif (typeof rawarg === 'string') {\n\t\t\t\targs[i] = JSON.parse(rawarg);\n\t\t\t} else {\n\t\t\t\targs[i] = rawarg;\n\t\t\t}\n\t\t}\n\t\treturn {\n\t\t\trpcId: rpcId,\n\t\t\tmethod: method,\n\t\t\targs: args\n\t\t};\n\t}\n\n\tpublic static serializeAcknowledged(req: number): VSBuffer {\n\t\treturn MessageBuffer.alloc(MessageType.Acknowledged, req, 0).buffer;\n\t}\n\n\tpublic static serializeCancel(req: number): VSBuffer {\n\t\treturn MessageBuffer.alloc(MessageType.Cancel, req, 0).buffer;\n\t}\n\n\tpublic static serializeReplyOK(req: number, res: any, replacer: JSONStringifyReplacer | null): VSBuffer {\n\t\tif (typeof res === 'undefined') {\n\t\t\treturn this._serializeReplyOKEmpty(req);\n\t\t} else if (res instanceof VSBuffer) {\n\t\t\treturn this._serializeReplyOKVSBuffer(req, res);\n\t\t} else if (res instanceof SerializableObjectWithBuffers) {\n\t\t\tconst { jsonString, referencedBuffers } = stringifyJsonWithBufferRefs(res.value, replacer, true);\n\t\t\treturn this._serializeReplyOKJSONWithBuffers(req, jsonString, referencedBuffers);\n\t\t} else {\n\t\t\treturn this._serializeReplyOKJSON(req, safeStringify(res, replacer));\n\t\t}\n\t}\n\n\tprivate static _serializeReplyOKEmpty(req: number): VSBuffer {\n\t\treturn MessageBuffer.alloc(MessageType.ReplyOKEmpty, req, 0).buffer;\n\t}\n\n\tprivate static _serializeReplyOKVSBuffer(req: number, res: VSBuffer): VSBuffer {\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeVSBuffer(res);\n\n\t\tconst result = MessageBuffer.alloc(MessageType.ReplyOKVSBuffer, req, len);\n\t\tresult.writeVSBuffer(res);\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeReplyOKVSBuffer(buff: MessageBuffer): VSBuffer {\n\t\treturn buff.readVSBuffer();\n\t}\n\n\tprivate static _serializeReplyOKJSON(req: number, res: string): VSBuffer {\n\t\tconst resBuff = VSBuffer.fromString(res);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeLongString(resBuff);\n\n\t\tconst result = MessageBuffer.alloc(MessageType.ReplyOKJSON, req, len);\n\t\tresult.writeLongString(resBuff);\n\t\treturn result.buffer;\n\t}\n\n\tprivate static _serializeReplyOKJSONWithBuffers(req: number, res: string, buffers: readonly VSBuffer[]): VSBuffer {\n\t\tconst resBuff = VSBuffer.fromString(res);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeUInt32; // buffer count\n\t\tlen += MessageBuffer.sizeLongString(resBuff);\n\t\tfor (const buffer of buffers) {\n\t\t\tlen += MessageBuffer.sizeVSBuffer(buffer);\n\t\t}\n\n\t\tconst result = MessageBuffer.alloc(MessageType.ReplyOKJSONWithBuffers, req, len);\n\t\tresult.writeUInt32(buffers.length);\n\t\tresult.writeLongString(resBuff);\n\t\tfor (const buffer of buffers) {\n\t\t\tresult.writeBuffer(buffer);\n\t\t}\n\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeReplyOKJSON(buff: MessageBuffer): any {\n\t\tconst res = buff.readLongString();\n\t\treturn JSON.parse(res);\n\t}\n\n\tpublic static deserializeReplyOKJSONWithBuffers(buff: MessageBuffer, uriTransformer: IURITransformer | null): SerializableObjectWithBuffers<any> {\n\t\tconst bufferCount = buff.readUInt32();\n\t\tconst res = buff.readLongString();\n\n\t\tconst buffers: VSBuffer[] = [];\n\t\tfor (let i = 0; i < bufferCount; ++i) {\n\t\t\tbuffers.push(buff.readVSBuffer());\n\t\t}\n\n\t\treturn new SerializableObjectWithBuffers(parseJsonAndRestoreBufferRefs(res, buffers, uriTransformer));\n\t}\n\n\tpublic static serializeReplyErr(req: number, err: any): VSBuffer {\n\t\tconst errStr: string | undefined = (err ? safeStringify(errors.transformErrorForSerialization(err), null) : undefined);\n\t\tif (typeof errStr !== 'string') {\n\t\t\treturn this._serializeReplyErrEmpty(req);\n\t\t}\n\t\tconst errBuff = VSBuffer.fromString(errStr);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeLongString(errBuff);\n\n\t\tconst result = MessageBuffer.alloc(MessageType.ReplyErrError, req, len);\n\t\tresult.writeLongString(errBuff);\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeReplyErrError(buff: MessageBuffer): Error {\n\t\tconst err = buff.readLongString();\n\t\treturn JSON.parse(err);\n\t}\n\n\tprivate static _serializeReplyErrEmpty(req: number): VSBuffer {\n\t\treturn MessageBuffer.alloc(MessageType.ReplyErrEmpty, req, 0).buffer;\n\t}\n}\n\nconst enum MessageType {\n\tRequestJSONArgs = 1,\n\tRequestJSONArgsWithCancellation = 2,\n\tRequestMixedArgs = 3,\n\tRequestMixedArgsWithCancellation = 4,\n\tAcknowledged = 5,\n\tCancel = 6,\n\tReplyOKEmpty = 7,\n\tReplyOKVSBuffer = 8,\n\tReplyOKJSON = 9,\n\tReplyOKJSONWithBuffers = 10,\n\tReplyErrError = 11,\n\tReplyErrEmpty = 12,\n}\n\nconst enum ArgType {\n\tString = 1,\n\tVSBuffer = 2,\n\tSerializedObjectWithBuffers = 3,\n\tUndefined = 4,\n}\n\n\ntype MixedArg =\n\t| { readonly type: ArgType.String; readonly value: VSBuffer }\n\t| { readonly type: ArgType.VSBuffer; readonly value: VSBuffer }\n\t| { readonly type: ArgType.SerializedObjectWithBuffers; readonly value: VSBuffer; readonly buffers: readonly VSBuffer[] }\n\t| { readonly type: ArgType.Undefined }\n\t;\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { CharCode } from '../../../../base/common/charCode.js';\nimport * as errors from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../../base/common/lifecycle.js';\nimport { MarshalledObject } from '../../../../base/common/marshalling.js';\nimport { MarshalledId } from '../../../../base/common/marshallingIds.js';\nimport { IURITransformer, transformIncomingURIs } from '../../../../base/common/uriIpc.js';\nimport { IMessagePassingProtocol } from '../../../../base/parts/ipc/common/ipc.js';\nimport { CanceledLazyPromise, LazyPromise } from './lazyPromise.js';\nimport { getStringIdentifierForProxy, IRPCProtocol, Proxied, ProxyIdentifier, SerializableObjectWithBuffers } from './proxyIdentifier.js';\n\nexport interface JSONStringifyReplacer {\n\t(key: string, value: any): any;\n}\n\nfunction safeStringify(obj: any, replacer: JSONStringifyReplacer | null): string {\n\ttry {\n\t\treturn JSON.stringify(obj, <(key: string, value: any) => any>replacer);\n\t} catch (err) {\n\t\treturn 'null';\n\t}\n}\n\nconst refSymbolName = '$$ref$$';\nconst undefinedRef = { [refSymbolName]: -1 } as const;\n\nclass StringifiedJsonWithBufferRefs {\n\tconstructor(\n\t\tpublic readonly jsonString: string,\n\t\tpublic readonly referencedBuffers: readonly VSBuffer[],\n\t) { }\n}\n\nexport function stringifyJsonWithBufferRefs<T>(obj: T, replacer: JSONStringifyReplacer | null = null, useSafeStringify = false): StringifiedJsonWithBufferRefs {\n\tconst foundBuffers: VSBuffer[] = [];\n\tconst serialized = (useSafeStringify ? safeStringify : JSON.stringify)(obj, (key, value) => {\n\t\tif (typeof value === 'undefined') {\n\t\t\treturn undefinedRef; // JSON.stringify normally converts 'undefined' to 'null'\n\t\t} else if (typeof value === 'object') {\n\t\t\tif (value instanceof VSBuffer) {\n\t\t\t\tconst bufferIndex = foundBuffers.push(value) - 1;\n\t\t\t\treturn { [refSymbolName]: bufferIndex };\n\t\t\t}\n\t\t\tif (replacer) {\n\t\t\t\treturn replacer(key, value);\n\t\t\t}\n\t\t}\n\t\treturn value;\n\t});\n\treturn {\n\t\tjsonString: serialized,\n\t\treferencedBuffers: foundBuffers\n\t};\n}\n\nexport function parseJsonAndRestoreBufferRefs(jsonString: string, buffers: readonly VSBuffer[], uriTransformer: IURITransformer | null): any {\n\treturn JSON.parse(jsonString, (_key, value) => {\n\t\tif (value) {\n\t\t\tconst ref = value[refSymbolName];\n\t\t\tif (typeof ref === 'number') {\n\t\t\t\treturn buffers[ref];\n\t\t\t}\n\n\t\t\tif (uriTransformer && (<MarshalledObject>value).$mid === MarshalledId.Uri) {\n\t\t\t\treturn uriTransformer.transformIncoming(value);\n\t\t\t}\n\t\t}\n\t\treturn value;\n\t});\n}\n\n\nfunction stringify(obj: any, replacer: JSONStringifyReplacer | null): string {\n\treturn JSON.stringify(obj, <(key: string, value: any) => any>replacer);\n}\n\nfunction createURIReplacer(transformer: IURITransformer | null): JSONStringifyReplacer | null {\n\tif (!transformer) {\n\t\treturn null;\n\t}\n\treturn (key: string, value: any): any => {\n\t\tif (value && value.$mid === MarshalledId.Uri) {\n\t\t\treturn transformer.transformOutgoing(value);\n\t\t}\n\t\treturn value;\n\t};\n}\n\nexport const enum RequestInitiator {\n\tLocalSide = 0,\n\tOtherSide = 1\n}\n\nexport const enum ResponsiveState {\n\tResponsive = 0,\n\tUnresponsive = 1\n}\n\nexport interface IRPCProtocolLogger {\n\tlogIncoming(msgLength: number, req: number, initiator: RequestInitiator, str: string, data?: any): void;\n\tlogOutgoing(msgLength: number, req: number, initiator: RequestInitiator, str: string, data?: any): void;\n}\n\nconst noop = () => { };\n\nconst _RPCProtocolSymbol = Symbol.for('rpcProtocol');\nconst _RPCProxySymbol = Symbol.for('rpcProxy');\n\nexport class RPCProtocol extends Disposable implements IRPCProtocol {\n\n\t[_RPCProtocolSymbol] = true;\n\n\tprivate static readonly UNRESPONSIVE_TIME = 3 * 1000; // 3s\n\n\tprivate readonly _onDidChangeResponsiveState: Emitter<ResponsiveState> = this._register(new Emitter<ResponsiveState>());\n\tpublic readonly onDidChangeResponsiveState: Event<ResponsiveState> = this._onDidChangeResponsiveState.event;\n\n\tprivate readonly _protocol: IMessagePassingProtocol;\n\tprivate readonly _logger: IRPCProtocolLogger | null;\n\tprivate readonly _uriTransformer: IURITransformer | null;\n\tprivate readonly _uriReplacer: JSONStringifyReplacer | null;\n\tprivate _isDisposed: boolean;\n\tprivate readonly _locals: any[];\n\tprivate readonly _proxies: any[];\n\tprivate _lastMessageId: number;\n\tprivate readonly _cancelInvokedHandlers: { [req: string]: () => void };\n\tprivate readonly _pendingRPCReplies: { [msgId: string]: PendingRPCReply };\n\tprivate _responsiveState: ResponsiveState;\n\tprivate _unacknowledgedCount: number;\n\tprivate _unresponsiveTime: number;\n\tprivate _asyncCheckUresponsive: RunOnceScheduler;\n\n\tconstructor(protocol: IMessagePassingProtocol, logger: IRPCProtocolLogger | null = null, transformer: IURITransformer | null = null) {\n\t\tsuper();\n\t\tthis._protocol = protocol;\n\t\tthis._logger = logger;\n\t\tthis._uriTransformer = transformer;\n\t\tthis._uriReplacer = createURIReplacer(this._uriTransformer);\n\t\tthis._isDisposed = false;\n\t\tthis._locals = [];\n\t\tthis._proxies = [];\n\t\tfor (let i = 0, len = ProxyIdentifier.count; i < len; i++) {\n\t\t\tthis._locals[i] = null;\n\t\t\tthis._proxies[i] = null;\n\t\t}\n\t\tthis._lastMessageId = 0;\n\t\tthis._cancelInvokedHandlers = Object.create(null);\n\t\tthis._pendingRPCReplies = {};\n\t\tthis._responsiveState = ResponsiveState.Responsive;\n\t\tthis._unacknowledgedCount = 0;\n\t\tthis._unresponsiveTime = 0;\n\t\tthis._asyncCheckUresponsive = this._register(new RunOnceScheduler(() => this._checkUnresponsive(), 1000));\n\t\tthis._register(this._protocol.onMessage((msg) => this._receiveOneMessage(msg)));\n\t}\n\n\tpublic override dispose(): void {\n\t\tthis._isDisposed = true;\n\n\t\t// Release all outstanding promises with a canceled error\n\t\tObject.keys(this._pendingRPCReplies).forEach((msgId) => {\n\t\t\tconst pending = this._pendingRPCReplies[msgId];\n\t\t\tdelete this._pendingRPCReplies[msgId];\n\t\t\tpending.resolveErr(errors.canceled());\n\t\t});\n\n\t\tsuper.dispose();\n\t}\n\n\tpublic drain(): Promise<void> {\n\t\tif (typeof this._protocol.drain === 'function') {\n\t\t\treturn this._protocol.drain();\n\t\t}\n\t\treturn Promise.resolve();\n\t}\n\n\tprivate _onWillSendRequest(req: number): void {\n\t\tif (this._unacknowledgedCount === 0) {\n\t\t\t// Since this is the first request we are sending in a while,\n\t\t\t// mark this moment as the start for the countdown to unresponsive time\n\t\t\tthis._unresponsiveTime = Date.now() + RPCProtocol.UNRESPONSIVE_TIME;\n\t\t}\n\t\tthis._unacknowledgedCount++;\n\t\tif (!this._asyncCheckUresponsive.isScheduled()) {\n\t\t\tthis._asyncCheckUresponsive.schedule();\n\t\t}\n\t}\n\n\tprivate _onDidReceiveAcknowledge(req: number): void {\n\t\t// The next possible unresponsive time is now + delta.\n\t\tthis._unresponsiveTime = Date.now() + RPCProtocol.UNRESPONSIVE_TIME;\n\t\tthis._unacknowledgedCount--;\n\t\tif (this._unacknowledgedCount === 0) {\n\t\t\t// No more need to check for unresponsive\n\t\t\tthis._asyncCheckUresponsive.cancel();\n\t\t}\n\t\t// The ext host is responsive!\n\t\tthis._setResponsiveState(ResponsiveState.Responsive);\n\t}\n\n\tprivate _checkUnresponsive(): void {\n\t\tif (this._unacknowledgedCount === 0) {\n\t\t\t// Not waiting for anything => cannot say if it is responsive or not\n\t\t\treturn;\n\t\t}\n\n\t\tif (Date.now() > this._unresponsiveTime) {\n\t\t\t// Unresponsive!!\n\t\t\tthis._setResponsiveState(ResponsiveState.Unresponsive);\n\t\t} else {\n\t\t\t// Not (yet) unresponsive, be sure to check again soon\n\t\t\tthis._asyncCheckUresponsive.schedule();\n\t\t}\n\t}\n\n\tprivate _setResponsiveState(newResponsiveState: ResponsiveState): void {\n\t\tif (this._responsiveState === newResponsiveState) {\n\t\t\t// no change\n\t\t\treturn;\n\t\t}\n\t\tthis._responsiveState = newResponsiveState;\n\t\tthis._onDidChangeResponsiveState.fire(this._responsiveState);\n\t}\n\n\tpublic get responsiveState(): ResponsiveState {\n\t\treturn this._responsiveState;\n\t}\n\n\tpublic transformIncomingURIs<T>(obj: T): T {\n\t\tif (!this._uriTransformer) {\n\t\t\treturn obj;\n\t\t}\n\t\treturn transformIncomingURIs(obj, this._uriTransformer);\n\t}\n\n\tpublic getProxy<T>(identifier: ProxyIdentifier<T>): Proxied<T> {\n\t\tconst { nid: rpcId, sid } = identifier;\n\t\tif (!this._proxies[rpcId]) {\n\t\t\tthis._proxies[rpcId] = this._createProxy(rpcId, sid);\n\t\t}\n\t\treturn this._proxies[rpcId];\n\t}\n\n\tprivate _createProxy<T>(rpcId: number, debugName: string): T {\n\t\tconst handler = {\n\t\t\tget: (target: any, name: PropertyKey) => {\n\t\t\t\tif (typeof name === 'string' && !target[name] && name.charCodeAt(0) === CharCode.DollarSign) {\n\t\t\t\t\ttarget[name] = (...myArgs: any[]) => {\n\t\t\t\t\t\treturn this._remoteCall(rpcId, name, myArgs);\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tif (name === _RPCProxySymbol) {\n\t\t\t\t\treturn debugName;\n\t\t\t\t}\n\t\t\t\treturn target[name];\n\t\t\t}\n\t\t};\n\t\treturn new Proxy(Object.create(null), handler);\n\t}\n\n\tpublic set<T, R extends T>(identifier: ProxyIdentifier<T>, value: R): R {\n\t\tthis._locals[identifier.nid] = value;\n\t\treturn value;\n\t}\n\n\tpublic assertRegistered(identifiers: ProxyIdentifier<any>[]): void {\n\t\tfor (let i = 0, len = identifiers.length; i < len; i++) {\n\t\t\tconst identifier = identifiers[i];\n\t\t\tif (!this._locals[identifier.nid]) {\n\t\t\t\tthrow new Error(`Missing proxy instance ${identifier.sid}`);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _receiveOneMessage(rawmsg: VSBuffer): void {\n\t\tif (this._isDisposed) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst msgLength = rawmsg.byteLength;\n\t\tconst buff = MessageBuffer.read(rawmsg, 0);\n\t\tconst messageType = <MessageType>buff.readUInt8();\n\t\tconst req = buff.readUInt32();\n\n\t\tswitch (messageType) {\n\t\t\tcase MessageType.RequestJSONArgs:\n\t\t\tcase MessageType.RequestJSONArgsWithCancellation: {\n\t\t\t\tlet { rpcId, method, args } = MessageIO.deserializeRequestJSONArgs(buff);\n\t\t\t\tif (this._uriTransformer) {\n\t\t\t\t\targs = transformIncomingURIs(args, this._uriTransformer);\n\t\t\t\t}\n\t\t\t\tthis._receiveRequest(msgLength, req, rpcId, method, args, (messageType === MessageType.RequestJSONArgsWithCancellation));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.RequestMixedArgs:\n\t\t\tcase MessageType.RequestMixedArgsWithCancellation: {\n\t\t\t\tlet { rpcId, method, args } = MessageIO.deserializeRequestMixedArgs(buff);\n\t\t\t\tif (this._uriTransformer) {\n\t\t\t\t\targs = transformIncomingURIs(args, this._uriTransformer);\n\t\t\t\t}\n\t\t\t\tthis._receiveRequest(msgLength, req, rpcId, method, args, (messageType === MessageType.RequestMixedArgsWithCancellation));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.Acknowledged: {\n\t\t\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.LocalSide, `ack`);\n\t\t\t\tthis._onDidReceiveAcknowledge(req);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.Cancel: {\n\t\t\t\tthis._receiveCancel(msgLength, req);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyOKEmpty: {\n\t\t\t\tthis._receiveReply(msgLength, req, undefined);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyOKJSON: {\n\t\t\t\tlet value = MessageIO.deserializeReplyOKJSON(buff);\n\t\t\t\tif (this._uriTransformer) {\n\t\t\t\t\tvalue = transformIncomingURIs(value, this._uriTransformer);\n\t\t\t\t}\n\t\t\t\tthis._receiveReply(msgLength, req, value);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyOKJSONWithBuffers: {\n\t\t\t\tconst value = MessageIO.deserializeReplyOKJSONWithBuffers(buff, this._uriTransformer);\n\t\t\t\tthis._receiveReply(msgLength, req, value);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyOKVSBuffer: {\n\t\t\t\tconst value = MessageIO.deserializeReplyOKVSBuffer(buff);\n\t\t\t\tthis._receiveReply(msgLength, req, value);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyErrError: {\n\t\t\t\tlet err = MessageIO.deserializeReplyErrError(buff);\n\t\t\t\tif (this._uriTransformer) {\n\t\t\t\t\terr = transformIncomingURIs(err, this._uriTransformer);\n\t\t\t\t}\n\t\t\t\tthis._receiveReplyErr(msgLength, req, err);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase MessageType.ReplyErrEmpty: {\n\t\t\t\tthis._receiveReplyErr(msgLength, req, undefined);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tconsole.error(`received unexpected message`);\n\t\t\t\tconsole.error(rawmsg);\n\t\t}\n\t}\n\n\tprivate _receiveRequest(msgLength: number, req: number, rpcId: number, method: string, args: any[], usesCancellationToken: boolean): void {\n\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.OtherSide, `receiveRequest ${getStringIdentifierForProxy(rpcId)}.${method}(`, args);\n\t\tconst callId = String(req);\n\n\t\tlet promise: Promise<any>;\n\t\tlet cancel: () => void;\n\t\tif (usesCancellationToken) {\n\t\t\tconst cancellationTokenSource = new CancellationTokenSource();\n\t\t\targs.push(cancellationTokenSource.token);\n\t\t\tpromise = this._invokeHandler(rpcId, method, args);\n\t\t\tcancel = () => cancellationTokenSource.cancel();\n\t\t} else {\n\t\t\t// cannot be cancelled\n\t\t\tpromise = this._invokeHandler(rpcId, method, args);\n\t\t\tcancel = noop;\n\t\t}\n\n\t\tthis._cancelInvokedHandlers[callId] = cancel;\n\n\t\t// Acknowledge the request\n\t\tconst msg = MessageIO.serializeAcknowledged(req);\n\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.OtherSide, `ack`);\n\t\tthis._protocol.send(msg);\n\n\t\tpromise.then((r) => {\n\t\t\tdelete this._cancelInvokedHandlers[callId];\n\t\t\tconst msg = MessageIO.serializeReplyOK(req, r, this._uriReplacer);\n\t\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.OtherSide, `reply:`, r);\n\t\t\tthis._protocol.send(msg);\n\t\t}, (err) => {\n\t\t\tdelete this._cancelInvokedHandlers[callId];\n\t\t\tconst msg = MessageIO.serializeReplyErr(req, err);\n\t\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.OtherSide, `replyErr:`, err);\n\t\t\tthis._protocol.send(msg);\n\t\t});\n\t}\n\n\tprivate _receiveCancel(msgLength: number, req: number): void {\n\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.OtherSide, `receiveCancel`);\n\t\tconst callId = String(req);\n\t\tthis._cancelInvokedHandlers[callId]?.();\n\t}\n\n\tprivate _receiveReply(msgLength: number, req: number, value: any): void {\n\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.LocalSide, `receiveReply:`, value);\n\t\tconst callId = String(req);\n\t\tif (!this._pendingRPCReplies.hasOwnProperty(callId)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst pendingReply = this._pendingRPCReplies[callId];\n\t\tdelete this._pendingRPCReplies[callId];\n\n\t\tpendingReply.resolveOk(value);\n\t}\n\n\tprivate _receiveReplyErr(msgLength: number, req: number, value: any): void {\n\t\tthis._logger?.logIncoming(msgLength, req, RequestInitiator.LocalSide, `receiveReplyErr:`, value);\n\n\t\tconst callId = String(req);\n\t\tif (!this._pendingRPCReplies.hasOwnProperty(callId)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst pendingReply = this._pendingRPCReplies[callId];\n\t\tdelete this._pendingRPCReplies[callId];\n\n\t\tlet err: any = undefined;\n\t\tif (value) {\n\t\t\tif (value.$isError) {\n\t\t\t\terr = new Error();\n\t\t\t\terr.name = value.name;\n\t\t\t\terr.message = value.message;\n\t\t\t\terr.stack = value.stack;\n\t\t\t} else {\n\t\t\t\terr = value;\n\t\t\t}\n\t\t}\n\t\tpendingReply.resolveErr(err);\n\t}\n\n\tprivate _invokeHandler(rpcId: number, methodName: string, args: any[]): Promise<any> {\n\t\ttry {\n\t\t\treturn Promise.resolve(this._doInvokeHandler(rpcId, methodName, args));\n\t\t} catch (err) {\n\t\t\treturn Promise.reject(err);\n\t\t}\n\t}\n\n\tprivate _doInvokeHandler(rpcId: number, methodName: string, args: any[]): any {\n\t\tconst actor = this._locals[rpcId];\n\t\tif (!actor) {\n\t\t\tthrow new Error('Unknown actor ' + getStringIdentifierForProxy(rpcId));\n\t\t}\n\t\tconst method = actor[methodName];\n\t\tif (typeof method !== 'function') {\n\t\t\tthrow new Error('Unknown method ' + methodName + ' on actor ' + getStringIdentifierForProxy(rpcId));\n\t\t}\n\t\treturn method.apply(actor, args);\n\t}\n\n\tprivate _remoteCall(rpcId: number, methodName: string, args: any[]): Promise<any> {\n\t\tif (this._isDisposed) {\n\t\t\treturn new CanceledLazyPromise();\n\t\t}\n\t\tlet cancellationToken: CancellationToken | null = null;\n\t\tif (args.length > 0 && CancellationToken.isCancellationToken(args[args.length - 1])) {\n\t\t\tcancellationToken = args.pop();\n\t\t}\n\n\t\tif (cancellationToken && cancellationToken.isCancellationRequested) {\n\t\t\t// No need to do anything...\n\t\t\treturn Promise.reject<any>(errors.canceled());\n\t\t}\n\n\t\tconst serializedRequestArguments = MessageIO.serializeRequestArguments(args, this._uriReplacer);\n\n\t\tconst req = ++this._lastMessageId;\n\t\tconst callId = String(req);\n\t\tconst result = new LazyPromise();\n\n\t\tconst disposable = new DisposableStore();\n\t\tif (cancellationToken) {\n\t\t\tdisposable.add(cancellationToken.onCancellationRequested(() => {\n\t\t\t\tconst msg = MessageIO.serializeCancel(req);\n\t\t\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.LocalSide, `cancel`);\n\t\t\t\tthis._protocol.send(msg);\n\t\t\t}));\n\t\t}\n\n\t\tthis._pendingRPCReplies[callId] = new PendingRPCReply(result, disposable);\n\t\tthis._onWillSendRequest(req);\n\t\tconst msg = MessageIO.serializeRequest(req, rpcId, methodName, serializedRequestArguments, !!cancellationToken);\n\t\tthis._logger?.logOutgoing(msg.byteLength, req, RequestInitiator.LocalSide, `request: ${getStringIdentifierForProxy(rpcId)}.${methodName}(`, args);\n\t\tthis._protocol.send(msg);\n\t\treturn result;\n\t}\n}\n\nclass PendingRPCReply {\n\tconstructor(\n\t\tprivate readonly _promise: LazyPromise,\n\t\tprivate readonly _disposable: IDisposable\n\t) { }\n\n\tpublic resolveOk(value: any): void {\n\t\tthis._promise.resolveOk(value);\n\t\tthis._disposable.dispose();\n\t}\n\n\tpublic resolveErr(err: any): void {\n\t\tthis._promise.resolveErr(err);\n\t\tthis._disposable.dispose();\n\t}\n}\n\nclass MessageBuffer {\n\n\tpublic static alloc(type: MessageType, req: number, messageSize: number): MessageBuffer {\n\t\tconst result = new MessageBuffer(VSBuffer.alloc(messageSize + 1 /* type */ + 4 /* req */), 0);\n\t\tresult.writeUInt8(type);\n\t\tresult.writeUInt32(req);\n\t\treturn result;\n\t}\n\n\tpublic static read(buff: VSBuffer, offset: number): MessageBuffer {\n\t\treturn new MessageBuffer(buff, offset);\n\t}\n\n\tprivate _buff: VSBuffer;\n\tprivate _offset: number;\n\n\tpublic get buffer(): VSBuffer {\n\t\treturn this._buff;\n\t}\n\n\tprivate constructor(buff: VSBuffer, offset: number) {\n\t\tthis._buff = buff;\n\t\tthis._offset = offset;\n\t}\n\n\tpublic static sizeUInt8(): number {\n\t\treturn 1;\n\t}\n\n\tpublic static readonly sizeUInt32 = 4;\n\n\tpublic writeUInt8(n: number): void {\n\t\tthis._buff.writeUInt8(n, this._offset); this._offset += 1;\n\t}\n\n\tpublic readUInt8(): number {\n\t\tconst n = this._buff.readUInt8(this._offset); this._offset += 1;\n\t\treturn n;\n\t}\n\n\tpublic writeUInt32(n: number): void {\n\t\tthis._buff.writeUInt32BE(n, this._offset); this._offset += 4;\n\t}\n\n\tpublic readUInt32(): number {\n\t\tconst n = this._buff.readUInt32BE(this._offset); this._offset += 4;\n\t\treturn n;\n\t}\n\n\tpublic static sizeShortString(str: VSBuffer): number {\n\t\treturn 1 /* string length */ + str.byteLength /* actual string */;\n\t}\n\n\tpublic writeShortString(str: VSBuffer): void {\n\t\tthis._buff.writeUInt8(str.byteLength, this._offset); this._offset += 1;\n\t\tthis._buff.set(str, this._offset); this._offset += str.byteLength;\n\t}\n\n\tpublic readShortString(): string {\n\t\tconst strByteLength = this._buff.readUInt8(this._offset); this._offset += 1;\n\t\tconst strBuff = this._buff.slice(this._offset, this._offset + strByteLength);\n\t\tconst str = strBuff.toString(); this._offset += strByteLength;\n\t\treturn str;\n\t}\n\n\tpublic static sizeLongString(str: VSBuffer): number {\n\t\treturn 4 /* string length */ + str.byteLength /* actual string */;\n\t}\n\n\tpublic writeLongString(str: VSBuffer): void {\n\t\tthis._buff.writeUInt32BE(str.byteLength, this._offset); this._offset += 4;\n\t\tthis._buff.set(str, this._offset); this._offset += str.byteLength;\n\t}\n\n\tpublic readLongString(): string {\n\t\tconst strByteLength = this._buff.readUInt32BE(this._offset); this._offset += 4;\n\t\tconst strBuff = this._buff.slice(this._offset, this._offset + strByteLength);\n\t\tconst str = strBuff.toString(); this._offset += strByteLength;\n\t\treturn str;\n\t}\n\n\tpublic writeBuffer(buff: VSBuffer): void {\n\t\tthis._buff.writeUInt32BE(buff.byteLength, this._offset); this._offset += 4;\n\t\tthis._buff.set(buff, this._offset); this._offset += buff.byteLength;\n\t}\n\n\tpublic static sizeVSBuffer(buff: VSBuffer): number {\n\t\treturn 4 /* buffer length */ + buff.byteLength /* actual buffer */;\n\t}\n\n\tpublic writeVSBuffer(buff: VSBuffer): void {\n\t\tthis._buff.writeUInt32BE(buff.byteLength, this._offset); this._offset += 4;\n\t\tthis._buff.set(buff, this._offset); this._offset += buff.byteLength;\n\t}\n\n\tpublic readVSBuffer(): VSBuffer {\n\t\tconst buffLength = this._buff.readUInt32BE(this._offset); this._offset += 4;\n\t\tconst buff = this._buff.slice(this._offset, this._offset + buffLength); this._offset += buffLength;\n\t\treturn buff;\n\t}\n\n\tpublic static sizeMixedArray(arr: readonly MixedArg[]): number {\n\t\tlet size = 0;\n\t\tsize += 1; // arr length\n\t\tfor (let i = 0, len = arr.length; i < len; i++) {\n\t\t\tconst el = arr[i];\n\t\t\tsize += 1; // arg type\n\t\t\tswitch (el.type) {\n\t\t\t\tcase ArgType.String:\n\t\t\t\t\tsize += this.sizeLongString(el.value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.VSBuffer:\n\t\t\t\t\tsize += this.sizeVSBuffer(el.value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.SerializedObjectWithBuffers:\n\t\t\t\t\tsize += this.sizeUInt32; // buffer count\n\t\t\t\t\tsize += this.sizeLongString(el.value);\n\t\t\t\t\tfor (let i = 0; i < el.buffers.length; ++i) {\n\t\t\t\t\t\tsize += this.sizeVSBuffer(el.buffers[i]);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.Undefined:\n\t\t\t\t\t// empty...\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn size;\n\t}\n\n\tpublic writeMixedArray(arr: readonly MixedArg[]): void {\n\t\tthis._buff.writeUInt8(arr.length, this._offset); this._offset += 1;\n\t\tfor (let i = 0, len = arr.length; i < len; i++) {\n\t\t\tconst el = arr[i];\n\t\t\tswitch (el.type) {\n\t\t\t\tcase ArgType.String:\n\t\t\t\t\tthis.writeUInt8(ArgType.String);\n\t\t\t\t\tthis.writeLongString(el.value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.VSBuffer:\n\t\t\t\t\tthis.writeUInt8(ArgType.VSBuffer);\n\t\t\t\t\tthis.writeVSBuffer(el.value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.SerializedObjectWithBuffers:\n\t\t\t\t\tthis.writeUInt8(ArgType.SerializedObjectWithBuffers);\n\t\t\t\t\tthis.writeUInt32(el.buffers.length);\n\t\t\t\t\tthis.writeLongString(el.value);\n\t\t\t\t\tfor (let i = 0; i < el.buffers.length; ++i) {\n\t\t\t\t\t\tthis.writeBuffer(el.buffers[i]);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.Undefined:\n\t\t\t\t\tthis.writeUInt8(ArgType.Undefined);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic readMixedArray(): Array<string | VSBuffer | SerializableObjectWithBuffers<any> | undefined> {\n\t\tconst arrLen = this._buff.readUInt8(this._offset); this._offset += 1;\n\t\tconst arr: Array<string | VSBuffer | SerializableObjectWithBuffers<any> | undefined> = new Array(arrLen);\n\t\tfor (let i = 0; i < arrLen; i++) {\n\t\t\tconst argType = <ArgType>this.readUInt8();\n\t\t\tswitch (argType) {\n\t\t\t\tcase ArgType.String:\n\t\t\t\t\tarr[i] = this.readLongString();\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.VSBuffer:\n\t\t\t\t\tarr[i] = this.readVSBuffer();\n\t\t\t\t\tbreak;\n\t\t\t\tcase ArgType.SerializedObjectWithBuffers: {\n\t\t\t\t\tconst bufferCount = this.readUInt32();\n\t\t\t\t\tconst jsonString = this.readLongString();\n\t\t\t\t\tconst buffers: VSBuffer[] = [];\n\t\t\t\t\tfor (let i = 0; i < bufferCount; ++i) {\n\t\t\t\t\t\tbuffers.push(this.readVSBuffer());\n\t\t\t\t\t}\n\t\t\t\t\tarr[i] = new SerializableObjectWithBuffers(parseJsonAndRestoreBufferRefs(jsonString, buffers, null));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase ArgType.Undefined:\n\t\t\t\t\tarr[i] = undefined;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn arr;\n\t}\n}\n\nconst enum SerializedRequestArgumentType {\n\tSimple,\n\tMixed,\n}\n\ntype SerializedRequestArguments =\n\t| { readonly type: SerializedRequestArgumentType.Simple; args: string }\n\t| { readonly type: SerializedRequestArgumentType.Mixed; args: MixedArg[] };\n\n\nclass MessageIO {\n\n\tprivate static _useMixedArgSerialization(arr: any[]): boolean {\n\t\tfor (let i = 0, len = arr.length; i < len; i++) {\n\t\t\tif (arr[i] instanceof VSBuffer) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (arr[i] instanceof SerializableObjectWithBuffers) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tif (typeof arr[i] === 'undefined') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic static serializeRequestArguments(args: any[], replacer: JSONStringifyReplacer | null): SerializedRequestArguments {\n\t\tif (this._useMixedArgSerialization(args)) {\n\t\t\tconst massagedArgs: MixedArg[] = [];\n\t\t\tfor (let i = 0, len = args.length; i < len; i++) {\n\t\t\t\tconst arg = args[i];\n\t\t\t\tif (arg instanceof VSBuffer) {\n\t\t\t\t\tmassagedArgs[i] = { type: ArgType.VSBuffer, value: arg };\n\t\t\t\t} else if (typeof arg === 'undefined') {\n\t\t\t\t\tmassagedArgs[i] = { type: ArgType.Undefined };\n\t\t\t\t} else if (arg instanceof SerializableObjectWithBuffers) {\n\t\t\t\t\tconst { jsonString, referencedBuffers } = stringifyJsonWithBufferRefs(arg.value, replacer);\n\t\t\t\t\tmassagedArgs[i] = { type: ArgType.SerializedObjectWithBuffers, value: VSBuffer.fromString(jsonString), buffers: referencedBuffers };\n\t\t\t\t} else {\n\t\t\t\t\tmassagedArgs[i] = { type: ArgType.String, value: VSBuffer.fromString(stringify(arg, replacer)) };\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn {\n\t\t\t\ttype: SerializedRequestArgumentType.Mixed,\n\t\t\t\targs: massagedArgs,\n\t\t\t};\n\t\t}\n\t\treturn {\n\t\t\ttype: SerializedRequestArgumentType.Simple,\n\t\t\targs: stringify(args, replacer)\n\t\t};\n\t}\n\n\tpublic static serializeRequest(req: number, rpcId: number, method: string, serializedArgs: SerializedRequestArguments, usesCancellationToken: boolean): VSBuffer {\n\t\tswitch (serializedArgs.type) {\n\t\t\tcase SerializedRequestArgumentType.Simple:\n\t\t\t\treturn this._requestJSONArgs(req, rpcId, method, serializedArgs.args, usesCancellationToken);\n\t\t\tcase SerializedRequestArgumentType.Mixed:\n\t\t\t\treturn this._requestMixedArgs(req, rpcId, method, serializedArgs.args, usesCancellationToken);\n\t\t}\n\t}\n\n\tprivate static _requestJSONArgs(req: number, rpcId: number, method: string, args: string, usesCancellationToken: boolean): VSBuffer {\n\t\tconst methodBuff = VSBuffer.fromString(method);\n\t\tconst argsBuff = VSBuffer.fromString(args);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeUInt8();\n\t\tlen += MessageBuffer.sizeShortString(methodBuff);\n\t\tlen += MessageBuffer.sizeLongString(argsBuff);\n\n\t\tconst result = MessageBuffer.alloc(usesCancellationToken ? MessageType.RequestJSONArgsWithCancellation : MessageType.RequestJSONArgs, req, len);\n\t\tresult.writeUInt8(rpcId);\n\t\tresult.writeShortString(methodBuff);\n\t\tresult.writeLongString(argsBuff);\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeRequestJSONArgs(buff: MessageBuffer): { rpcId: number; method: string; args: any[] } {\n\t\tconst rpcId = buff.readUInt8();\n\t\tconst method = buff.readShortString();\n\t\tconst args = buff.readLongString();\n\t\treturn {\n\t\t\trpcId: rpcId,\n\t\t\tmethod: method,\n\t\t\targs: JSON.parse(args)\n\t\t};\n\t}\n\n\tprivate static _requestMixedArgs(req: number, rpcId: number, method: string, args: readonly MixedArg[], usesCancellationToken: boolean): VSBuffer {\n\t\tconst methodBuff = VSBuffer.fromString(method);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeUInt8();\n\t\tlen += MessageBuffer.sizeShortString(methodBuff);\n\t\tlen += MessageBuffer.sizeMixedArray(args);\n\n\t\tconst result = MessageBuffer.alloc(usesCancellationToken ? MessageType.RequestMixedArgsWithCancellation : MessageType.RequestMixedArgs, req, len);\n\t\tresult.writeUInt8(rpcId);\n\t\tresult.writeShortString(methodBuff);\n\t\tresult.writeMixedArray(args);\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeRequestMixedArgs(buff: MessageBuffer): { rpcId: number; method: string; args: any[] } {\n\t\tconst rpcId = buff.readUInt8();\n\t\tconst method = buff.readShortString();\n\t\tconst rawargs = buff.readMixedArray();\n\t\tconst args: any[] = new Array(rawargs.length);\n\t\tfor (let i = 0, len = rawargs.length; i < len; i++) {\n\t\t\tconst rawarg = rawargs[i];\n\t\t\tif (typeof rawarg === 'string') {\n\t\t\t\targs[i] = JSON.parse(rawarg);\n\t\t\t} else {\n\t\t\t\targs[i] = rawarg;\n\t\t\t}\n\t\t}\n\t\treturn {\n\t\t\trpcId: rpcId,\n\t\t\tmethod: method,\n\t\t\targs: args\n\t\t};\n\t}\n\n\tpublic static serializeAcknowledged(req: number): VSBuffer {\n\t\treturn MessageBuffer.alloc(MessageType.Acknowledged, req, 0).buffer;\n\t}\n\n\tpublic static serializeCancel(req: number): VSBuffer {\n\t\treturn MessageBuffer.alloc(MessageType.Cancel, req, 0).buffer;\n\t}\n\n\tpublic static serializeReplyOK(req: number, res: any, replacer: JSONStringifyReplacer | null): VSBuffer {\n\t\tif (typeof res === 'undefined') {\n\t\t\treturn this._serializeReplyOKEmpty(req);\n\t\t} else if (res instanceof VSBuffer) {\n\t\t\treturn this._serializeReplyOKVSBuffer(req, res);\n\t\t} else if (res instanceof SerializableObjectWithBuffers) {\n\t\t\tconst { jsonString, referencedBuffers } = stringifyJsonWithBufferRefs(res.value, replacer, true);\n\t\t\treturn this._serializeReplyOKJSONWithBuffers(req, jsonString, referencedBuffers);\n\t\t} else {\n\t\t\treturn this._serializeReplyOKJSON(req, safeStringify(res, replacer));\n\t\t}\n\t}\n\n\tprivate static _serializeReplyOKEmpty(req: number): VSBuffer {\n\t\treturn MessageBuffer.alloc(MessageType.ReplyOKEmpty, req, 0).buffer;\n\t}\n\n\tprivate static _serializeReplyOKVSBuffer(req: number, res: VSBuffer): VSBuffer {\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeVSBuffer(res);\n\n\t\tconst result = MessageBuffer.alloc(MessageType.ReplyOKVSBuffer, req, len);\n\t\tresult.writeVSBuffer(res);\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeReplyOKVSBuffer(buff: MessageBuffer): VSBuffer {\n\t\treturn buff.readVSBuffer();\n\t}\n\n\tprivate static _serializeReplyOKJSON(req: number, res: string): VSBuffer {\n\t\tconst resBuff = VSBuffer.fromString(res);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeLongString(resBuff);\n\n\t\tconst result = MessageBuffer.alloc(MessageType.ReplyOKJSON, req, len);\n\t\tresult.writeLongString(resBuff);\n\t\treturn result.buffer;\n\t}\n\n\tprivate static _serializeReplyOKJSONWithBuffers(req: number, res: string, buffers: readonly VSBuffer[]): VSBuffer {\n\t\tconst resBuff = VSBuffer.fromString(res);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeUInt32; // buffer count\n\t\tlen += MessageBuffer.sizeLongString(resBuff);\n\t\tfor (const buffer of buffers) {\n\t\t\tlen += MessageBuffer.sizeVSBuffer(buffer);\n\t\t}\n\n\t\tconst result = MessageBuffer.alloc(MessageType.ReplyOKJSONWithBuffers, req, len);\n\t\tresult.writeUInt32(buffers.length);\n\t\tresult.writeLongString(resBuff);\n\t\tfor (const buffer of buffers) {\n\t\t\tresult.writeBuffer(buffer);\n\t\t}\n\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeReplyOKJSON(buff: MessageBuffer): any {\n\t\tconst res = buff.readLongString();\n\t\treturn JSON.parse(res);\n\t}\n\n\tpublic static deserializeReplyOKJSONWithBuffers(buff: MessageBuffer, uriTransformer: IURITransformer | null): SerializableObjectWithBuffers<any> {\n\t\tconst bufferCount = buff.readUInt32();\n\t\tconst res = buff.readLongString();\n\n\t\tconst buffers: VSBuffer[] = [];\n\t\tfor (let i = 0; i < bufferCount; ++i) {\n\t\t\tbuffers.push(buff.readVSBuffer());\n\t\t}\n\n\t\treturn new SerializableObjectWithBuffers(parseJsonAndRestoreBufferRefs(res, buffers, uriTransformer));\n\t}\n\n\tpublic static serializeReplyErr(req: number, err: any): VSBuffer {\n\t\tconst errStr: string | undefined = (err ? safeStringify(errors.transformErrorForSerialization(err), null) : undefined);\n\t\tif (typeof errStr !== 'string') {\n\t\t\treturn this._serializeReplyErrEmpty(req);\n\t\t}\n\t\tconst errBuff = VSBuffer.fromString(errStr);\n\n\t\tlet len = 0;\n\t\tlen += MessageBuffer.sizeLongString(errBuff);\n\n\t\tconst result = MessageBuffer.alloc(MessageType.ReplyErrError, req, len);\n\t\tresult.writeLongString(errBuff);\n\t\treturn result.buffer;\n\t}\n\n\tpublic static deserializeReplyErrError(buff: MessageBuffer): Error {\n\t\tconst err = buff.readLongString();\n\t\treturn JSON.parse(err);\n\t}\n\n\tprivate static _serializeReplyErrEmpty(req: number): VSBuffer {\n\t\treturn MessageBuffer.alloc(MessageType.ReplyErrEmpty, req, 0).buffer;\n\t}\n}\n\nconst enum MessageType {\n\tRequestJSONArgs = 1,\n\tRequestJSONArgsWithCancellation = 2,\n\tRequestMixedArgs = 3,\n\tRequestMixedArgsWithCancellation = 4,\n\tAcknowledged = 5,\n\tCancel = 6,\n\tReplyOKEmpty = 7,\n\tReplyOKVSBuffer = 8,\n\tReplyOKJSON = 9,\n\tReplyOKJSONWithBuffers = 10,\n\tReplyErrError = 11,\n\tReplyErrEmpty = 12,\n}\n\nconst enum ArgType {\n\tString = 1,\n\tVSBuffer = 2,\n\tSerializedObjectWithBuffers = 3,\n\tUndefined = 4,\n}\n\n\ntype MixedArg =\n\t| { readonly type: ArgType.String; readonly value: VSBuffer }\n\t| { readonly type: ArgType.VSBuffer; readonly value: VSBuffer }\n\t| { readonly type: ArgType.SerializedObjectWithBuffers; readonly value: VSBuffer; readonly buffers: readonly VSBuffer[] }\n\t| { readonly type: ArgType.Undefined }\n\t;\n"]}