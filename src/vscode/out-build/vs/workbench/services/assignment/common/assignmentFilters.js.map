{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/assignment/common/assignmentFilters.ts","vs/workbench/services/assignment/common/assignmentFilters.ts"],"names":[],"mappings":"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","file":"assignmentFilters.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { IExperimentationFilterProvider } from 'tas-client';\nimport { IExtensionService } from '../../extensions/common/extensions.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ExtensionIdentifier } from '../../../../platform/extensions/common/extensions.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { Emitter } from '../../../../base/common/event.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { IChatEntitlementService } from '../../chat/common/chatEntitlementService.js';\n\nexport enum ExtensionsFilter {\n\n\t/**\n\t * Version of the github.copilot extension.\n\t */\n\tCopilotExtensionVersion = 'X-Copilot-RelatedPluginVersion-githubcopilot',\n\n\t/**\n\t * Version of the github.copilot-chat extension.\n\t */\n\tCopilotChatExtensionVersion = 'X-Copilot-RelatedPluginVersion-githubcopilotchat',\n\n\t/**\n\t * Version of the completions version.\n\t */\n\tCompletionsVersionInCopilotChat = 'X-VSCode-CompletionsInChatExtensionVersion',\n\n\t/**\n\t * SKU of the copilot entitlement.\n\t */\n\tCopilotSku = 'X-GitHub-Copilot-SKU',\n\n\t/**\n\t * The internal org of the user.\n\t */\n\tMicrosoftInternalOrg = 'X-Microsoft-Internal-Org',\n}\n\nenum StorageVersionKeys {\n\tCopilotExtensionVersion = 'extensionsAssignmentFilterProvider.copilotExtensionVersion',\n\tCopilotChatExtensionVersion = 'extensionsAssignmentFilterProvider.copilotChatExtensionVersion',\n\tCompletionsVersion = 'extensionsAssignmentFilterProvider.copilotCompletionsVersion',\n\tCopilotSku = 'extensionsAssignmentFilterProvider.copilotSku',\n\tCopilotInternalOrg = 'extensionsAssignmentFilterProvider.copilotInternalOrg',\n}\n\nexport class CopilotAssignmentFilterProvider extends Disposable implements IExperimentationFilterProvider {\n\tprivate copilotChatExtensionVersion: string | undefined;\n\tprivate copilotExtensionVersion: string | undefined;\n\t// TODO@benibenj remove this when completions have been ported to chat\n\tprivate copilotCompletionsVersion: string | undefined;\n\n\tprivate copilotInternalOrg: string | undefined;\n\tprivate copilotSku: string | undefined;\n\n\tprivate readonly _onDidChangeFilters = this._register(new Emitter<void>());\n\treadonly onDidChangeFilters = this._onDidChangeFilters.event;\n\n\tconstructor(\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IChatEntitlementService private readonly _chatEntitlementService: IChatEntitlementService,\n\t) {\n\t\tsuper();\n\n\t\tthis.copilotExtensionVersion = this._storageService.get(StorageVersionKeys.CopilotExtensionVersion, StorageScope.PROFILE);\n\t\tthis.copilotChatExtensionVersion = this._storageService.get(StorageVersionKeys.CopilotChatExtensionVersion, StorageScope.PROFILE);\n\t\tthis.copilotCompletionsVersion = this._storageService.get(StorageVersionKeys.CompletionsVersion, StorageScope.PROFILE);\n\t\tthis.copilotSku = this._storageService.get(StorageVersionKeys.CopilotSku, StorageScope.PROFILE);\n\t\tthis.copilotInternalOrg = this._storageService.get(StorageVersionKeys.CopilotInternalOrg, StorageScope.PROFILE);\n\n\t\tthis._register(this._extensionService.onDidChangeExtensionsStatus(extensionIdentifiers => {\n\t\t\tif (extensionIdentifiers.some(identifier => ExtensionIdentifier.equals(identifier, 'github.copilot') || ExtensionIdentifier.equals(identifier, 'github.copilot-chat'))) {\n\t\t\t\tthis.updateExtensionVersions();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._chatEntitlementService.onDidChangeEntitlement(() => {\n\t\t\tthis.updateCopilotEntitlementInfo();\n\t\t}));\n\n\t\tthis.updateExtensionVersions();\n\t\tthis.updateCopilotEntitlementInfo();\n\t}\n\n\tprivate async updateExtensionVersions() {\n\t\tlet copilotExtensionVersion;\n\t\tlet copilotChatExtensionVersion;\n\t\tlet copilotCompletionsVersion;\n\n\t\ttry {\n\t\t\tconst [copilotExtension, copilotChatExtension] = await Promise.all([\n\t\t\t\tthis._extensionService.getExtension('github.copilot'),\n\t\t\t\tthis._extensionService.getExtension('github.copilot-chat'),\n\t\t\t]);\n\n\t\t\tcopilotExtensionVersion = copilotExtension?.version;\n\t\t\tcopilotChatExtensionVersion = copilotChatExtension?.version;\n\t\t\tcopilotCompletionsVersion = (copilotChatExtension as typeof copilotChatExtension & { completionsCoreVersion?: string })?.completionsCoreVersion;\n\t\t} catch (error) {\n\t\t\tthis._logService.error('Failed to update extension version assignments', error);\n\t\t}\n\n\t\tif (this.copilotCompletionsVersion === copilotCompletionsVersion &&\n\t\t\tthis.copilotExtensionVersion === copilotExtensionVersion &&\n\t\t\tthis.copilotChatExtensionVersion === copilotChatExtensionVersion) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.copilotExtensionVersion = copilotExtensionVersion;\n\t\tthis.copilotChatExtensionVersion = copilotChatExtensionVersion;\n\t\tthis.copilotCompletionsVersion = copilotCompletionsVersion;\n\n\t\tthis._storageService.store(StorageVersionKeys.CopilotExtensionVersion, this.copilotExtensionVersion, StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\tthis._storageService.store(StorageVersionKeys.CopilotChatExtensionVersion, this.copilotChatExtensionVersion, StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\tthis._storageService.store(StorageVersionKeys.CompletionsVersion, this.copilotCompletionsVersion, StorageScope.PROFILE, StorageTarget.MACHINE);\n\n\t\t// Notify that the filters have changed.\n\t\tthis._onDidChangeFilters.fire();\n\t}\n\n\tprivate updateCopilotEntitlementInfo() {\n\t\tconst newSku = this._chatEntitlementService.sku;\n\t\tconst newIsGitHubInternal = this._chatEntitlementService.organisations?.includes('github');\n\t\tconst newIsMicrosoftInternal = this._chatEntitlementService.organisations?.includes('microsoft') || this._chatEntitlementService.organisations?.includes('ms-copilot') || this._chatEntitlementService.organisations?.includes('MicrosoftCopilot');\n\t\tconst newInternalOrg = newIsGitHubInternal ? 'github' : newIsMicrosoftInternal ? 'microsoft' : undefined;\n\n\t\tif (this.copilotSku === newSku && this.copilotInternalOrg === newInternalOrg) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.copilotSku = newSku;\n\t\tthis.copilotInternalOrg = newInternalOrg;\n\n\t\tthis._storageService.store(StorageVersionKeys.CopilotSku, this.copilotSku, StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\tthis._storageService.store(StorageVersionKeys.CopilotInternalOrg, this.copilotInternalOrg, StorageScope.PROFILE, StorageTarget.MACHINE);\n\n\t\t// Notify that the filters have changed.\n\t\tthis._onDidChangeFilters.fire();\n\t}\n\n\t/**\n\t * Returns a version string that can be parsed by the TAS client.\n\t * The tas client cannot handle suffixes lke \"-insider\"\n\t * Ref: https://github.com/microsoft/tas-client/blob/30340d5e1da37c2789049fcf45928b954680606f/vscode-tas-client/src/vscode-tas-client/VSCodeFilterProvider.ts#L35\n\t *\n\t * @param version Version string to be trimmed.\n\t*/\n\tprivate static trimVersionSuffix(version: string): string {\n\t\tconst regex = /\\-[a-zA-Z0-9]+$/;\n\t\tconst result = version.split(regex);\n\n\t\treturn result[0];\n\t}\n\n\tgetFilterValue(filter: string): string | null {\n\t\tswitch (filter) {\n\t\t\tcase ExtensionsFilter.CopilotExtensionVersion:\n\t\t\t\treturn this.copilotExtensionVersion ? CopilotAssignmentFilterProvider.trimVersionSuffix(this.copilotExtensionVersion) : null;\n\t\t\tcase ExtensionsFilter.CompletionsVersionInCopilotChat:\n\t\t\t\treturn this.copilotCompletionsVersion ? CopilotAssignmentFilterProvider.trimVersionSuffix(this.copilotCompletionsVersion) : null;\n\t\t\tcase ExtensionsFilter.CopilotChatExtensionVersion:\n\t\t\t\treturn this.copilotChatExtensionVersion ? CopilotAssignmentFilterProvider.trimVersionSuffix(this.copilotChatExtensionVersion) : null;\n\t\t\tcase ExtensionsFilter.CopilotSku:\n\t\t\t\treturn this.copilotSku ?? null;\n\t\t\tcase ExtensionsFilter.MicrosoftInternalOrg:\n\t\t\t\treturn this.copilotInternalOrg ?? null;\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetFilters(): Map<string, string | null> {\n\t\tconst filters = new Map<string, string | null>();\n\t\tconst filterValues = Object.values(ExtensionsFilter);\n\t\tfor (const value of filterValues) {\n\t\t\tfilters.set(value, this.getFilterValue(value));\n\t\t}\n\n\t\treturn filters;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { IExperimentationFilterProvider } from 'tas-client';\nimport { IExtensionService } from '../../extensions/common/extensions.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ExtensionIdentifier } from '../../../../platform/extensions/common/extensions.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { Emitter } from '../../../../base/common/event.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { IChatEntitlementService } from '../../chat/common/chatEntitlementService.js';\n\nexport enum ExtensionsFilter {\n\n\t/**\n\t * Version of the github.copilot extension.\n\t */\n\tCopilotExtensionVersion = 'X-Copilot-RelatedPluginVersion-githubcopilot',\n\n\t/**\n\t * Version of the github.copilot-chat extension.\n\t */\n\tCopilotChatExtensionVersion = 'X-Copilot-RelatedPluginVersion-githubcopilotchat',\n\n\t/**\n\t * Version of the completions version.\n\t */\n\tCompletionsVersionInCopilotChat = 'X-VSCode-CompletionsInChatExtensionVersion',\n\n\t/**\n\t * SKU of the copilot entitlement.\n\t */\n\tCopilotSku = 'X-GitHub-Copilot-SKU',\n\n\t/**\n\t * The internal org of the user.\n\t */\n\tMicrosoftInternalOrg = 'X-Microsoft-Internal-Org',\n}\n\nenum StorageVersionKeys {\n\tCopilotExtensionVersion = 'extensionsAssignmentFilterProvider.copilotExtensionVersion',\n\tCopilotChatExtensionVersion = 'extensionsAssignmentFilterProvider.copilotChatExtensionVersion',\n\tCompletionsVersion = 'extensionsAssignmentFilterProvider.copilotCompletionsVersion',\n\tCopilotSku = 'extensionsAssignmentFilterProvider.copilotSku',\n\tCopilotInternalOrg = 'extensionsAssignmentFilterProvider.copilotInternalOrg',\n}\n\nexport class CopilotAssignmentFilterProvider extends Disposable implements IExperimentationFilterProvider {\n\tprivate copilotChatExtensionVersion: string | undefined;\n\tprivate copilotExtensionVersion: string | undefined;\n\t// TODO@benibenj remove this when completions have been ported to chat\n\tprivate copilotCompletionsVersion: string | undefined;\n\n\tprivate copilotInternalOrg: string | undefined;\n\tprivate copilotSku: string | undefined;\n\n\tprivate readonly _onDidChangeFilters = this._register(new Emitter<void>());\n\treadonly onDidChangeFilters = this._onDidChangeFilters.event;\n\n\tconstructor(\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IChatEntitlementService private readonly _chatEntitlementService: IChatEntitlementService,\n\t) {\n\t\tsuper();\n\n\t\tthis.copilotExtensionVersion = this._storageService.get(StorageVersionKeys.CopilotExtensionVersion, StorageScope.PROFILE);\n\t\tthis.copilotChatExtensionVersion = this._storageService.get(StorageVersionKeys.CopilotChatExtensionVersion, StorageScope.PROFILE);\n\t\tthis.copilotCompletionsVersion = this._storageService.get(StorageVersionKeys.CompletionsVersion, StorageScope.PROFILE);\n\t\tthis.copilotSku = this._storageService.get(StorageVersionKeys.CopilotSku, StorageScope.PROFILE);\n\t\tthis.copilotInternalOrg = this._storageService.get(StorageVersionKeys.CopilotInternalOrg, StorageScope.PROFILE);\n\n\t\tthis._register(this._extensionService.onDidChangeExtensionsStatus(extensionIdentifiers => {\n\t\t\tif (extensionIdentifiers.some(identifier => ExtensionIdentifier.equals(identifier, 'github.copilot') || ExtensionIdentifier.equals(identifier, 'github.copilot-chat'))) {\n\t\t\t\tthis.updateExtensionVersions();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._chatEntitlementService.onDidChangeEntitlement(() => {\n\t\t\tthis.updateCopilotEntitlementInfo();\n\t\t}));\n\n\t\tthis.updateExtensionVersions();\n\t\tthis.updateCopilotEntitlementInfo();\n\t}\n\n\tprivate async updateExtensionVersions() {\n\t\tlet copilotExtensionVersion;\n\t\tlet copilotChatExtensionVersion;\n\t\tlet copilotCompletionsVersion;\n\n\t\ttry {\n\t\t\tconst [copilotExtension, copilotChatExtension] = await Promise.all([\n\t\t\t\tthis._extensionService.getExtension('github.copilot'),\n\t\t\t\tthis._extensionService.getExtension('github.copilot-chat'),\n\t\t\t]);\n\n\t\t\tcopilotExtensionVersion = copilotExtension?.version;\n\t\t\tcopilotChatExtensionVersion = copilotChatExtension?.version;\n\t\t\tcopilotCompletionsVersion = (copilotChatExtension as typeof copilotChatExtension & { completionsCoreVersion?: string })?.completionsCoreVersion;\n\t\t} catch (error) {\n\t\t\tthis._logService.error('Failed to update extension version assignments', error);\n\t\t}\n\n\t\tif (this.copilotCompletionsVersion === copilotCompletionsVersion &&\n\t\t\tthis.copilotExtensionVersion === copilotExtensionVersion &&\n\t\t\tthis.copilotChatExtensionVersion === copilotChatExtensionVersion) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.copilotExtensionVersion = copilotExtensionVersion;\n\t\tthis.copilotChatExtensionVersion = copilotChatExtensionVersion;\n\t\tthis.copilotCompletionsVersion = copilotCompletionsVersion;\n\n\t\tthis._storageService.store(StorageVersionKeys.CopilotExtensionVersion, this.copilotExtensionVersion, StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\tthis._storageService.store(StorageVersionKeys.CopilotChatExtensionVersion, this.copilotChatExtensionVersion, StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\tthis._storageService.store(StorageVersionKeys.CompletionsVersion, this.copilotCompletionsVersion, StorageScope.PROFILE, StorageTarget.MACHINE);\n\n\t\t// Notify that the filters have changed.\n\t\tthis._onDidChangeFilters.fire();\n\t}\n\n\tprivate updateCopilotEntitlementInfo() {\n\t\tconst newSku = this._chatEntitlementService.sku;\n\t\tconst newIsGitHubInternal = this._chatEntitlementService.organisations?.includes('github');\n\t\tconst newIsMicrosoftInternal = this._chatEntitlementService.organisations?.includes('microsoft') || this._chatEntitlementService.organisations?.includes('ms-copilot') || this._chatEntitlementService.organisations?.includes('MicrosoftCopilot');\n\t\tconst newInternalOrg = newIsGitHubInternal ? 'github' : newIsMicrosoftInternal ? 'microsoft' : undefined;\n\n\t\tif (this.copilotSku === newSku && this.copilotInternalOrg === newInternalOrg) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.copilotSku = newSku;\n\t\tthis.copilotInternalOrg = newInternalOrg;\n\n\t\tthis._storageService.store(StorageVersionKeys.CopilotSku, this.copilotSku, StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\tthis._storageService.store(StorageVersionKeys.CopilotInternalOrg, this.copilotInternalOrg, StorageScope.PROFILE, StorageTarget.MACHINE);\n\n\t\t// Notify that the filters have changed.\n\t\tthis._onDidChangeFilters.fire();\n\t}\n\n\t/**\n\t * Returns a version string that can be parsed by the TAS client.\n\t * The tas client cannot handle suffixes lke \"-insider\"\n\t * Ref: https://github.com/microsoft/tas-client/blob/30340d5e1da37c2789049fcf45928b954680606f/vscode-tas-client/src/vscode-tas-client/VSCodeFilterProvider.ts#L35\n\t *\n\t * @param version Version string to be trimmed.\n\t*/\n\tprivate static trimVersionSuffix(version: string): string {\n\t\tconst regex = /\\-[a-zA-Z0-9]+$/;\n\t\tconst result = version.split(regex);\n\n\t\treturn result[0];\n\t}\n\n\tgetFilterValue(filter: string): string | null {\n\t\tswitch (filter) {\n\t\t\tcase ExtensionsFilter.CopilotExtensionVersion:\n\t\t\t\treturn this.copilotExtensionVersion ? CopilotAssignmentFilterProvider.trimVersionSuffix(this.copilotExtensionVersion) : null;\n\t\t\tcase ExtensionsFilter.CompletionsVersionInCopilotChat:\n\t\t\t\treturn this.copilotCompletionsVersion ? CopilotAssignmentFilterProvider.trimVersionSuffix(this.copilotCompletionsVersion) : null;\n\t\t\tcase ExtensionsFilter.CopilotChatExtensionVersion:\n\t\t\t\treturn this.copilotChatExtensionVersion ? CopilotAssignmentFilterProvider.trimVersionSuffix(this.copilotChatExtensionVersion) : null;\n\t\t\tcase ExtensionsFilter.CopilotSku:\n\t\t\t\treturn this.copilotSku ?? null;\n\t\t\tcase ExtensionsFilter.MicrosoftInternalOrg:\n\t\t\t\treturn this.copilotInternalOrg ?? null;\n\t\t\tdefault:\n\t\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetFilters(): Map<string, string | null> {\n\t\tconst filters = new Map<string, string | null>();\n\t\tconst filterValues = Object.values(ExtensionsFilter);\n\t\tfor (const value of filterValues) {\n\t\t\tfilters.set(value, this.getFilterValue(value));\n\t\t}\n\n\t\treturn filters;\n\t}\n}\n"]}