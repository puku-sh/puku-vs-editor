{"version":3,"sources":["vs/workbench/services/assignment/common/assignmentService.ts"],"names":[],"mappings":"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","file":"assignmentService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { localize } from '../../../../nls.js';\nimport { createDecorator, IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport type { IKeyValueStorage, IExperimentationTelemetry, ExperimentationService as TASClient } from 'tas-client';\nimport { Memento } from '../../../common/memento.js';\nimport { ITelemetryService, TelemetryLevel } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { ITelemetryData } from '../../../../base/common/actions.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { ASSIGNMENT_REFETCH_INTERVAL, ASSIGNMENT_STORAGE_KEY, AssignmentFilterProvider, IAssignmentService, TargetPopulation } from '../../../../platform/assignment/common/assignment.js';\nimport { Registry } from '../../../../platform/registry/common/platform.js';\nimport { workbenchConfigurationNodeBase } from '../../../common/configuration.js';\nimport { IConfigurationRegistry, Extensions as ConfigurationExtensions, ConfigurationScope } from '../../../../platform/configuration/common/configurationRegistry.js';\nimport { IWorkbenchEnvironmentService } from '../../environment/common/environmentService.js';\nimport { getTelemetryLevel } from '../../../../platform/telemetry/common/telemetryUtils.js';\nimport { importAMDNodeModule } from '../../../../amdX.js';\nimport { timeout } from '../../../../base/common/async.js';\nimport { CopilotAssignmentFilterProvider } from './assignmentFilters.js';\nimport { Disposable, DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\n\nexport interface IAssignmentFilter {\n\texclude(assignment: string): boolean;\n\tonDidChange: Event<void>;\n}\n\nexport const IWorkbenchAssignmentService = createDecorator<IWorkbenchAssignmentService>('assignmentService');\n\nexport interface IWorkbenchAssignmentService extends IAssignmentService {\n\tgetCurrentExperiments(): Promise<string[] | undefined>;\n\taddTelemetryAssignmentFilter(filter: IAssignmentFilter): void;\n}\n\nclass MementoKeyValueStorage implements IKeyValueStorage {\n\n\tprivate readonly mementoObj: Record<string, unknown>;\n\n\tconstructor(private readonly memento: Memento<Record<string, unknown>>) {\n\t\tthis.mementoObj = memento.getMemento(StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t}\n\n\tasync getValue<T>(key: string, defaultValue?: T | undefined): Promise<T | undefined> {\n\t\tconst value = await this.mementoObj[key] as T | undefined;\n\n\t\treturn value || defaultValue;\n\t}\n\n\tsetValue<T>(key: string, value: T): void {\n\t\tthis.mementoObj[key] = value;\n\t\tthis.memento.saveMemento();\n\t}\n}\n\nclass WorkbenchAssignmentServiceTelemetry extends Disposable implements IExperimentationTelemetry {\n\n\tprivate readonly _onDidUpdateAssignmentContext = this._register(new Emitter<void>());\n\treadonly onDidUpdateAssignmentContext = this._onDidUpdateAssignmentContext.event;\n\n\tprivate _previousAssignmentContext: string | undefined;\n\tprivate _lastAssignmentContext: string | undefined;\n\tget assignmentContext(): string[] | undefined {\n\t\treturn this._lastAssignmentContext?.split(';');\n\t}\n\n\tprivate _assignmentFilters: IAssignmentFilter[] = [];\n\tprivate _assignmentFilterDisposables = this._register(new DisposableStore());\n\n\tconstructor(\n\t\tprivate readonly telemetryService: ITelemetryService,\n\t\tprivate readonly productService: IProductService\n\t) {\n\t\tsuper();\n\t}\n\n\tprivate _filterAssignmentContext(assignmentContext: string): string {\n\t\tconst assignments = assignmentContext.split(';');\n\n\t\tconst filteredAssignments = assignments.filter(assignment => {\n\t\t\tfor (const filter of this._assignmentFilters) {\n\t\t\t\tif (filter.exclude(assignment)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn true;\n\t\t});\n\n\t\treturn filteredAssignments.join(';');\n\t}\n\n\tprivate _setAssignmentContext(value: string): void {\n\t\tconst filteredValue = this._filterAssignmentContext(value);\n\t\tthis._lastAssignmentContext = filteredValue;\n\t\tthis._onDidUpdateAssignmentContext.fire();\n\n\t\tif (this.productService.tasConfig?.assignmentContextTelemetryPropertyName) {\n\t\t\tthis.telemetryService.setExperimentProperty(this.productService.tasConfig.assignmentContextTelemetryPropertyName, filteredValue);\n\t\t}\n\t}\n\n\taddAssignmentFilter(filter: IAssignmentFilter): void {\n\t\tthis._assignmentFilters.push(filter);\n\t\tthis._assignmentFilterDisposables.add(filter.onDidChange(() => {\n\t\t\tif (this._previousAssignmentContext) {\n\t\t\t\tthis._setAssignmentContext(this._previousAssignmentContext);\n\t\t\t}\n\t\t}));\n\t\tif (this._previousAssignmentContext) {\n\t\t\tthis._setAssignmentContext(this._previousAssignmentContext);\n\t\t}\n\t}\n\n\t// __GDPR__COMMON__ \"abexp.assignmentcontext\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\" }\n\tsetSharedProperty(name: string, value: string): void {\n\t\tif (name === this.productService.tasConfig?.assignmentContextTelemetryPropertyName) {\n\t\t\tthis._previousAssignmentContext = value;\n\t\t\treturn this._setAssignmentContext(value);\n\t\t}\n\n\t\tthis.telemetryService.setExperimentProperty(name, value);\n\t}\n\n\tpostEvent(eventName: string, props: Map<string, string>): void {\n\t\tconst data: ITelemetryData = {};\n\t\tfor (const [key, value] of props.entries()) {\n\t\t\tdata[key] = value;\n\t\t}\n\n\t\t/* __GDPR__\n\t\t\t\"query-expfeature\" : {\n\t\t\t\t\"owner\": \"sbatten\",\n\t\t\t\t\"comment\": \"Logs queries to the experiment service by feature for metric calculations\",\n\t\t\t\t\"ABExp.queriedFeature\": { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\", \"comment\": \"The experimental feature being queried\" }\n\t\t\t}\n\t\t*/\n\t\tthis.telemetryService.publicLog(eventName, data);\n\t}\n}\n\nexport class WorkbenchAssignmentService extends Disposable implements IAssignmentService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly tasClient: Promise<TASClient> | undefined;\n\tprivate readonly tasSetupDisposables = new DisposableStore();\n\n\tprivate networkInitialized = false;\n\tprivate readonly overrideInitDelay: Promise<void>;\n\n\tprivate readonly telemetry: WorkbenchAssignmentServiceTelemetry;\n\tprivate readonly keyValueStorage: IKeyValueStorage;\n\n\tprivate readonly experimentsEnabled: boolean;\n\n\tprivate readonly _onDidRefetchAssignments = this._register(new Emitter<void>());\n\tpublic readonly onDidRefetchAssignments = this._onDidRefetchAssignments.event;\n\n\tconstructor(\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IProductService private readonly productService: IProductService,\n\t\t@IWorkbenchEnvironmentService environmentService: IWorkbenchEnvironmentService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tthis.experimentsEnabled = getTelemetryLevel(configurationService) === TelemetryLevel.USAGE &&\n\t\t\t!environmentService.disableExperiments &&\n\t\t\t!environmentService.extensionTestsLocationURI &&\n\t\t\t!environmentService.enableSmokeTestDriver &&\n\t\t\tconfigurationService.getValue('workbench.enableExperiments') === true;\n\n\t\tif (productService.tasConfig && this.experimentsEnabled) {\n\t\t\tthis.tasClient = this.setupTASClient();\n\t\t}\n\n\t\tthis.telemetry = this._register(new WorkbenchAssignmentServiceTelemetry(telemetryService, productService));\n\t\tthis._register(this.telemetry.onDidUpdateAssignmentContext(() => this._onDidRefetchAssignments.fire()));\n\n\t\tthis.keyValueStorage = new MementoKeyValueStorage(new Memento<Record<string, unknown>>('experiment.service.memento', storageService));\n\n\t\t// For development purposes, configure the delay until tas local tas treatment ovverrides are available\n\t\tconst overrideDelaySetting = configurationService.getValue('experiments.overrideDelay');\n\t\tconst overrideDelay = typeof overrideDelaySetting === 'number' ? overrideDelaySetting : 0;\n\t\tthis.overrideInitDelay = timeout(overrideDelay);\n\t}\n\n\tasync getTreatment<T extends string | number | boolean>(name: string): Promise<T | undefined> {\n\t\tconst result = await this.doGetTreatment<T>(name);\n\n\t\ttype TASClientReadTreatmentData = {\n\t\t\ttreatmentName: string;\n\t\t\ttreatmentValue: string;\n\t\t};\n\n\t\ttype TASClientReadTreatmentClassification = {\n\t\t\towner: 'sbatten';\n\t\t\tcomment: 'Logged when a treatment value is read from the experiment service';\n\t\t\ttreatmentValue: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The value of the read treatment' };\n\t\t\ttreatmentName: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The name of the treatment that was read' };\n\t\t};\n\n\t\tthis.telemetryService.publicLog2<TASClientReadTreatmentData, TASClientReadTreatmentClassification>('tasClientReadTreatmentComplete', {\n\t\t\ttreatmentName: name,\n\t\t\ttreatmentValue: JSON.stringify(result)\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tprivate async doGetTreatment<T extends string | number | boolean>(name: string): Promise<T | undefined> {\n\t\tawait this.overrideInitDelay; // For development purposes, allow overriding tas assignments to test variants locally.\n\n\t\tconst override = this.configurationService.getValue<T>(`experiments.override.${name}`);\n\t\tif (override !== undefined) {\n\t\t\treturn override;\n\t\t}\n\n\t\tif (!this.tasClient) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!this.experimentsEnabled) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tlet result: T | undefined;\n\t\tconst client = await this.tasClient;\n\n\t\t// The TAS client is initialized but we need to check if the initial fetch has completed yet\n\t\t// If it is complete, return a cached value for the treatment\n\t\t// If not, use the async call with `checkCache: true`. This will allow the module to return a cached value if it is present.\n\t\t// Otherwise it will await the initial fetch to return the most up to date value.\n\t\tif (this.networkInitialized) {\n\t\t\tresult = client.getTreatmentVariable<T>('vscode', name);\n\t\t} else {\n\t\t\tresult = await client.getTreatmentVariableAsync<T>('vscode', name, true);\n\t\t}\n\n\t\tresult = client.getTreatmentVariable<T>('vscode', name);\n\t\treturn result;\n\t}\n\n\tprivate async setupTASClient(): Promise<TASClient> {\n\t\tthis.tasSetupDisposables.clear();\n\n\t\tconst targetPopulation = this.productService.quality === 'stable' ?\n\t\t\tTargetPopulation.Public : (this.productService.quality === 'exploration' ?\n\t\t\t\tTargetPopulation.Exploration : TargetPopulation.Insiders);\n\n\t\tconst filterProvider = new AssignmentFilterProvider(\n\t\t\tthis.productService.version,\n\t\t\tthis.productService.nameLong,\n\t\t\tthis.telemetryService.machineId,\n\t\t\tthis.telemetryService.devDeviceId,\n\t\t\ttargetPopulation,\n\t\t\tthis.productService.date ?? ''\n\t\t);\n\n\t\tconst extensionsFilterProvider = this.instantiationService.createInstance(CopilotAssignmentFilterProvider);\n\t\tthis.tasSetupDisposables.add(extensionsFilterProvider);\n\t\tthis.tasSetupDisposables.add(extensionsFilterProvider.onDidChangeFilters(() => this.refetchAssignments()));\n\n\t\tconst tasConfig = this.productService.tasConfig!;\n\t\tconst tasClient = new (await importAMDNodeModule<typeof import('tas-client')>('tas-client', 'dist/tas-client.min.js')).ExperimentationService({\n\t\t\tfilterProviders: [filterProvider, extensionsFilterProvider],\n\t\t\ttelemetry: this.telemetry,\n\t\t\tstorageKey: ASSIGNMENT_STORAGE_KEY,\n\t\t\tkeyValueStorage: this.keyValueStorage,\n\t\t\tassignmentContextTelemetryPropertyName: tasConfig.assignmentContextTelemetryPropertyName,\n\t\t\ttelemetryEventName: tasConfig.telemetryEventName,\n\t\t\tendpoint: tasConfig.endpoint,\n\t\t\trefetchInterval: ASSIGNMENT_REFETCH_INTERVAL,\n\t\t});\n\n\t\tawait tasClient.initializePromise;\n\t\ttasClient.initialFetch.then(() => {\n\t\t\tthis.networkInitialized = true;\n\t\t});\n\n\t\treturn tasClient;\n\t}\n\n\tprivate async refetchAssignments(): Promise<void> {\n\t\tif (!this.tasClient) {\n\t\t\treturn; // Setup has not started, assignments will use latest filters\n\t\t}\n\n\t\t// Await the client to be setup and the initial fetch to complete\n\t\tconst tasClient = await this.tasClient;\n\t\tawait tasClient.initialFetch;\n\n\t\t// Refresh the assignments\n\t\tawait tasClient.getTreatmentVariableAsync('vscode', 'refresh', false);\n\t}\n\n\tasync getCurrentExperiments(): Promise<string[] | undefined> {\n\t\tif (!this.tasClient) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!this.experimentsEnabled) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tawait this.tasClient;\n\n\t\treturn this.telemetry.assignmentContext;\n\t}\n\n\taddTelemetryAssignmentFilter(filter: IAssignmentFilter): void {\n\t\tthis.telemetry.addAssignmentFilter(filter);\n\t}\n}\n\nregisterSingleton(IWorkbenchAssignmentService, WorkbenchAssignmentService, InstantiationType.Delayed);\n\nconst registry = Registry.as<IConfigurationRegistry>(ConfigurationExtensions.Configuration);\nregistry.registerConfiguration({\n\t...workbenchConfigurationNodeBase,\n\t'properties': {\n\t\t'workbench.enableExperiments': {\n\t\t\t'type': 'boolean',\n\t\t\t'description': localize('workbench.enableExperiments', \"Fetches experiments to run from a Microsoft online service.\"),\n\t\t\t'default': true,\n\t\t\t'scope': ConfigurationScope.APPLICATION,\n\t\t\t'restricted': true,\n\t\t\t'tags': ['usesOnlineServices']\n\t\t}\n\t}\n});\n"]}