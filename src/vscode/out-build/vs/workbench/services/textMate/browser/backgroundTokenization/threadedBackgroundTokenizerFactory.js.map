{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/textMate/browser/backgroundTokenization/threadedBackgroundTokenizerFactory.ts","vs/workbench/services/textMate/browser/backgroundTokenization/threadedBackgroundTokenizerFactory.ts"],"names":[],"mappings":"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","file":"threadedBackgroundTokenizerFactory.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { canASAR } from '../../../../../amdX.js';\nimport { DisposableStore, IDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { AppResourcePath, FileAccess, nodeModulesAsarPath, nodeModulesPath } from '../../../../../base/common/network.js';\nimport { IObservable } from '../../../../../base/common/observable.js';\nimport { isWeb } from '../../../../../base/common/platform.js';\nimport { URI, UriComponents } from '../../../../../base/common/uri.js';\nimport { IBackgroundTokenizationStore, IBackgroundTokenizer } from '../../../../../editor/common/languages.js';\nimport { ILanguageService } from '../../../../../editor/common/languages/language.js';\nimport { ITextModel } from '../../../../../editor/common/model.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { IEnvironmentService } from '../../../../../platform/environment/common/environment.js';\nimport { IExtensionResourceLoaderService } from '../../../../../platform/extensionResourceLoader/common/extensionResourceLoader.js';\nimport { INotificationService } from '../../../../../platform/notification/common/notification.js';\nimport { ITelemetryService } from '../../../../../platform/telemetry/common/telemetry.js';\nimport { ICreateData, StateDeltas, TextMateTokenizationWorker } from './worker/textMateTokenizationWorker.worker.js';\nimport { TextMateWorkerHost } from './worker/textMateWorkerHost.js';\nimport { TextMateWorkerTokenizerController } from './textMateWorkerTokenizerController.js';\nimport { IValidGrammarDefinition } from '../../common/TMScopeRegistry.js';\nimport type { IRawTheme } from 'vscode-textmate';\nimport { WebWorkerDescriptor } from '../../../../../platform/webWorker/browser/webWorkerDescriptor.js';\nimport { IWebWorkerService } from '../../../../../platform/webWorker/browser/webWorkerService.js';\nimport { IWebWorkerClient, Proxied } from '../../../../../base/common/worker/webWorker.js';\n\nexport class ThreadedBackgroundTokenizerFactory implements IDisposable {\n\tprivate static _reportedMismatchingTokens = false;\n\n\tprivate _workerProxyPromise: Promise<Proxied<TextMateTokenizationWorker> | null> | null = null;\n\tprivate _worker: IWebWorkerClient<TextMateTokenizationWorker> | null = null;\n\tprivate _workerProxy: Proxied<TextMateTokenizationWorker> | null = null;\n\tprivate readonly _workerTokenizerControllers = new Map</* backgroundTokenizerId */number, TextMateWorkerTokenizerController>();\n\n\tprivate _currentTheme: IRawTheme | null = null;\n\tprivate _currentTokenColorMap: string[] | null = null;\n\tprivate _grammarDefinitions: IValidGrammarDefinition[] = [];\n\n\tconstructor(\n\t\tprivate readonly _reportTokenizationTime: (timeMs: number, languageId: string, sourceExtensionId: string | undefined, lineLength: number, isRandomSample: boolean) => void,\n\t\tprivate readonly _shouldTokenizeAsync: () => boolean,\n\t\t@IExtensionResourceLoaderService private readonly _extensionResourceLoaderService: IExtensionResourceLoaderService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@ILanguageService private readonly _languageService: ILanguageService,\n\t\t@IEnvironmentService private readonly _environmentService: IEnvironmentService,\n\t\t@INotificationService private readonly _notificationService: INotificationService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@IWebWorkerService private readonly _webWorkerService: IWebWorkerService,\n\t) {\n\t}\n\n\tpublic dispose(): void {\n\t\tthis._disposeWorker();\n\t}\n\n\t// Will be recreated after worker is disposed (because tokenizer is re-registered when languages change)\n\tpublic createBackgroundTokenizer(textModel: ITextModel, tokenStore: IBackgroundTokenizationStore, maxTokenizationLineLength: IObservable<number>): IBackgroundTokenizer | undefined {\n\t\t// fallback to default sync background tokenizer\n\t\tif (!this._shouldTokenizeAsync() || textModel.isTooLargeForSyncing()) { return undefined; }\n\n\t\tconst store = new DisposableStore();\n\t\tconst controllerContainer = this._getWorkerProxy().then((workerProxy) => {\n\t\t\tif (store.isDisposed || !workerProxy) { return undefined; }\n\n\t\t\tconst controllerContainer = { controller: undefined as undefined | TextMateWorkerTokenizerController, worker: this._worker };\n\t\t\tstore.add(keepAliveWhenAttached(textModel, () => {\n\t\t\t\tconst controller = new TextMateWorkerTokenizerController(textModel, workerProxy, this._languageService.languageIdCodec, tokenStore, this._configurationService, maxTokenizationLineLength);\n\t\t\t\tcontrollerContainer.controller = controller;\n\t\t\t\tthis._workerTokenizerControllers.set(controller.controllerId, controller);\n\t\t\t\treturn toDisposable(() => {\n\t\t\t\t\tcontrollerContainer.controller = undefined;\n\t\t\t\t\tthis._workerTokenizerControllers.delete(controller.controllerId);\n\t\t\t\t\tcontroller.dispose();\n\t\t\t\t});\n\t\t\t}));\n\t\t\treturn controllerContainer;\n\t\t});\n\n\t\treturn {\n\t\t\tdispose() {\n\t\t\t\tstore.dispose();\n\t\t\t},\n\t\t\trequestTokens: async (startLineNumber, endLineNumberExclusive) => {\n\t\t\t\tconst container = await controllerContainer;\n\n\t\t\t\t// If there is no controller, the model has been detached in the meantime.\n\t\t\t\t// Only request the proxy object if the worker is the same!\n\t\t\t\tif (container?.controller && container.worker === this._worker) {\n\t\t\t\t\tcontainer.controller.requestTokens(startLineNumber, endLineNumberExclusive);\n\t\t\t\t}\n\t\t\t},\n\t\t\treportMismatchingTokens: (lineNumber) => {\n\t\t\t\tif (ThreadedBackgroundTokenizerFactory._reportedMismatchingTokens) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tThreadedBackgroundTokenizerFactory._reportedMismatchingTokens = true;\n\n\t\t\t\tthis._notificationService.error({\n\t\t\t\t\tmessage: 'Async Tokenization Token Mismatch in line ' + lineNumber,\n\t\t\t\t\tname: 'Async Tokenization Token Mismatch',\n\t\t\t\t});\n\n\t\t\t\tthis._telemetryService.publicLog2<{}, { owner: 'hediet'; comment: 'Used to see if async tokenization is bug-free' }>('asyncTokenizationMismatchingTokens', {});\n\t\t\t},\n\t\t};\n\t}\n\n\tpublic setGrammarDefinitions(grammarDefinitions: IValidGrammarDefinition[]): void {\n\t\tthis._grammarDefinitions = grammarDefinitions;\n\t\tthis._disposeWorker();\n\t}\n\n\tpublic acceptTheme(theme: IRawTheme, colorMap: string[]): void {\n\t\tthis._currentTheme = theme;\n\t\tthis._currentTokenColorMap = colorMap;\n\t\tif (this._currentTheme && this._currentTokenColorMap && this._workerProxy) {\n\t\t\tthis._workerProxy.$acceptTheme(this._currentTheme, this._currentTokenColorMap);\n\t\t}\n\t}\n\n\tprivate _getWorkerProxy(): Promise<Proxied<TextMateTokenizationWorker> | null> {\n\t\tif (!this._workerProxyPromise) {\n\t\t\tthis._workerProxyPromise = this._createWorkerProxy();\n\t\t}\n\t\treturn this._workerProxyPromise;\n\t}\n\n\tprivate async _createWorkerProxy(): Promise<Proxied<TextMateTokenizationWorker> | null> {\n\t\tconst onigurumaModuleLocation: AppResourcePath = `${nodeModulesPath}/vscode-oniguruma`;\n\t\tconst onigurumaModuleLocationAsar: AppResourcePath = `${nodeModulesAsarPath}/vscode-oniguruma`;\n\n\t\tconst useAsar = canASAR && this._environmentService.isBuilt && !isWeb;\n\t\tconst onigurumaLocation: AppResourcePath = useAsar ? onigurumaModuleLocationAsar : onigurumaModuleLocation;\n\t\tconst onigurumaWASM: AppResourcePath = `${onigurumaLocation}/release/onig.wasm`;\n\n\t\tconst createData: ICreateData = {\n\t\t\tgrammarDefinitions: this._grammarDefinitions,\n\t\t\tonigurumaWASMUri: FileAccess.asBrowserUri(onigurumaWASM).toString(true),\n\t\t};\n\t\tconst worker = this._worker = this._webWorkerService.createWorkerClient<TextMateTokenizationWorker>(\n\t\t\tnew WebWorkerDescriptor({\n\t\t\t\tesmModuleLocation: FileAccess.asBrowserUri('vs/workbench/services/textMate/browser/backgroundTokenization/worker/textMateTokenizationWorker.workerMain.js'),\n\t\t\t\tlabel: 'TextMateWorker'\n\t\t\t})\n\t\t);\n\t\tTextMateWorkerHost.setChannel(worker, {\n\t\t\t$readFile: async (_resource: UriComponents): Promise<string> => {\n\t\t\t\tconst resource = URI.revive(_resource);\n\t\t\t\treturn this._extensionResourceLoaderService.readExtensionResource(resource);\n\t\t\t},\n\t\t\t$setTokensAndStates: async (controllerId: number, versionId: number, tokens: Uint8Array, lineEndStateDeltas: StateDeltas[]): Promise<void> => {\n\t\t\t\tconst controller = this._workerTokenizerControllers.get(controllerId);\n\t\t\t\t// When a model detaches, it is removed synchronously from the map.\n\t\t\t\t// However, the worker might still be sending tokens for that model,\n\t\t\t\t// so we ignore the event when there is no controller.\n\t\t\t\tif (controller) {\n\t\t\t\t\tcontroller.setTokensAndStates(controllerId, versionId, tokens, lineEndStateDeltas);\n\t\t\t\t}\n\t\t\t},\n\t\t\t$reportTokenizationTime: (timeMs: number, languageId: string, sourceExtensionId: string | undefined, lineLength: number, isRandomSample: boolean): void => {\n\t\t\t\tthis._reportTokenizationTime(timeMs, languageId, sourceExtensionId, lineLength, isRandomSample);\n\t\t\t}\n\t\t});\n\t\tawait worker.proxy.$init(createData);\n\n\t\tif (this._worker !== worker) {\n\t\t\t// disposed in the meantime\n\t\t\treturn null;\n\t\t}\n\t\tthis._workerProxy = worker.proxy;\n\t\tif (this._currentTheme && this._currentTokenColorMap) {\n\t\t\tthis._workerProxy.$acceptTheme(this._currentTheme, this._currentTokenColorMap);\n\t\t}\n\t\treturn worker.proxy;\n\t}\n\n\tprivate _disposeWorker(): void {\n\t\tfor (const controller of this._workerTokenizerControllers.values()) {\n\t\t\tcontroller.dispose();\n\t\t}\n\t\tthis._workerTokenizerControllers.clear();\n\n\t\tif (this._worker) {\n\t\t\tthis._worker.dispose();\n\t\t\tthis._worker = null;\n\t\t}\n\t\tthis._workerProxy = null;\n\t\tthis._workerProxyPromise = null;\n\t}\n}\n\nfunction keepAliveWhenAttached(textModel: ITextModel, factory: () => IDisposable): IDisposable {\n\tconst disposableStore = new DisposableStore();\n\tconst subStore = disposableStore.add(new DisposableStore());\n\n\tfunction checkAttached() {\n\t\tif (textModel.isAttachedToEditor()) {\n\t\t\tsubStore.add(factory());\n\t\t} else {\n\t\t\tsubStore.clear();\n\t\t}\n\t}\n\n\tcheckAttached();\n\tdisposableStore.add(textModel.onDidChangeAttached(() => {\n\t\tcheckAttached();\n\t}));\n\treturn disposableStore;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { canASAR } from '../../../../../amdX.js';\nimport { DisposableStore, IDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { AppResourcePath, FileAccess, nodeModulesAsarPath, nodeModulesPath } from '../../../../../base/common/network.js';\nimport { IObservable } from '../../../../../base/common/observable.js';\nimport { isWeb } from '../../../../../base/common/platform.js';\nimport { URI, UriComponents } from '../../../../../base/common/uri.js';\nimport { IBackgroundTokenizationStore, IBackgroundTokenizer } from '../../../../../editor/common/languages.js';\nimport { ILanguageService } from '../../../../../editor/common/languages/language.js';\nimport { ITextModel } from '../../../../../editor/common/model.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { IEnvironmentService } from '../../../../../platform/environment/common/environment.js';\nimport { IExtensionResourceLoaderService } from '../../../../../platform/extensionResourceLoader/common/extensionResourceLoader.js';\nimport { INotificationService } from '../../../../../platform/notification/common/notification.js';\nimport { ITelemetryService } from '../../../../../platform/telemetry/common/telemetry.js';\nimport { ICreateData, StateDeltas, TextMateTokenizationWorker } from './worker/textMateTokenizationWorker.worker.js';\nimport { TextMateWorkerHost } from './worker/textMateWorkerHost.js';\nimport { TextMateWorkerTokenizerController } from './textMateWorkerTokenizerController.js';\nimport { IValidGrammarDefinition } from '../../common/TMScopeRegistry.js';\nimport type { IRawTheme } from 'vscode-textmate';\nimport { WebWorkerDescriptor } from '../../../../../platform/webWorker/browser/webWorkerDescriptor.js';\nimport { IWebWorkerService } from '../../../../../platform/webWorker/browser/webWorkerService.js';\nimport { IWebWorkerClient, Proxied } from '../../../../../base/common/worker/webWorker.js';\n\nexport class ThreadedBackgroundTokenizerFactory implements IDisposable {\n\tprivate static _reportedMismatchingTokens = false;\n\n\tprivate _workerProxyPromise: Promise<Proxied<TextMateTokenizationWorker> | null> | null = null;\n\tprivate _worker: IWebWorkerClient<TextMateTokenizationWorker> | null = null;\n\tprivate _workerProxy: Proxied<TextMateTokenizationWorker> | null = null;\n\tprivate readonly _workerTokenizerControllers = new Map</* backgroundTokenizerId */number, TextMateWorkerTokenizerController>();\n\n\tprivate _currentTheme: IRawTheme | null = null;\n\tprivate _currentTokenColorMap: string[] | null = null;\n\tprivate _grammarDefinitions: IValidGrammarDefinition[] = [];\n\n\tconstructor(\n\t\tprivate readonly _reportTokenizationTime: (timeMs: number, languageId: string, sourceExtensionId: string | undefined, lineLength: number, isRandomSample: boolean) => void,\n\t\tprivate readonly _shouldTokenizeAsync: () => boolean,\n\t\t@IExtensionResourceLoaderService private readonly _extensionResourceLoaderService: IExtensionResourceLoaderService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@ILanguageService private readonly _languageService: ILanguageService,\n\t\t@IEnvironmentService private readonly _environmentService: IEnvironmentService,\n\t\t@INotificationService private readonly _notificationService: INotificationService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@IWebWorkerService private readonly _webWorkerService: IWebWorkerService,\n\t) {\n\t}\n\n\tpublic dispose(): void {\n\t\tthis._disposeWorker();\n\t}\n\n\t// Will be recreated after worker is disposed (because tokenizer is re-registered when languages change)\n\tpublic createBackgroundTokenizer(textModel: ITextModel, tokenStore: IBackgroundTokenizationStore, maxTokenizationLineLength: IObservable<number>): IBackgroundTokenizer | undefined {\n\t\t// fallback to default sync background tokenizer\n\t\tif (!this._shouldTokenizeAsync() || textModel.isTooLargeForSyncing()) { return undefined; }\n\n\t\tconst store = new DisposableStore();\n\t\tconst controllerContainer = this._getWorkerProxy().then((workerProxy) => {\n\t\t\tif (store.isDisposed || !workerProxy) { return undefined; }\n\n\t\t\tconst controllerContainer = { controller: undefined as undefined | TextMateWorkerTokenizerController, worker: this._worker };\n\t\t\tstore.add(keepAliveWhenAttached(textModel, () => {\n\t\t\t\tconst controller = new TextMateWorkerTokenizerController(textModel, workerProxy, this._languageService.languageIdCodec, tokenStore, this._configurationService, maxTokenizationLineLength);\n\t\t\t\tcontrollerContainer.controller = controller;\n\t\t\t\tthis._workerTokenizerControllers.set(controller.controllerId, controller);\n\t\t\t\treturn toDisposable(() => {\n\t\t\t\t\tcontrollerContainer.controller = undefined;\n\t\t\t\t\tthis._workerTokenizerControllers.delete(controller.controllerId);\n\t\t\t\t\tcontroller.dispose();\n\t\t\t\t});\n\t\t\t}));\n\t\t\treturn controllerContainer;\n\t\t});\n\n\t\treturn {\n\t\t\tdispose() {\n\t\t\t\tstore.dispose();\n\t\t\t},\n\t\t\trequestTokens: async (startLineNumber, endLineNumberExclusive) => {\n\t\t\t\tconst container = await controllerContainer;\n\n\t\t\t\t// If there is no controller, the model has been detached in the meantime.\n\t\t\t\t// Only request the proxy object if the worker is the same!\n\t\t\t\tif (container?.controller && container.worker === this._worker) {\n\t\t\t\t\tcontainer.controller.requestTokens(startLineNumber, endLineNumberExclusive);\n\t\t\t\t}\n\t\t\t},\n\t\t\treportMismatchingTokens: (lineNumber) => {\n\t\t\t\tif (ThreadedBackgroundTokenizerFactory._reportedMismatchingTokens) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tThreadedBackgroundTokenizerFactory._reportedMismatchingTokens = true;\n\n\t\t\t\tthis._notificationService.error({\n\t\t\t\t\tmessage: 'Async Tokenization Token Mismatch in line ' + lineNumber,\n\t\t\t\t\tname: 'Async Tokenization Token Mismatch',\n\t\t\t\t});\n\n\t\t\t\tthis._telemetryService.publicLog2<{}, { owner: 'hediet'; comment: 'Used to see if async tokenization is bug-free' }>('asyncTokenizationMismatchingTokens', {});\n\t\t\t},\n\t\t};\n\t}\n\n\tpublic setGrammarDefinitions(grammarDefinitions: IValidGrammarDefinition[]): void {\n\t\tthis._grammarDefinitions = grammarDefinitions;\n\t\tthis._disposeWorker();\n\t}\n\n\tpublic acceptTheme(theme: IRawTheme, colorMap: string[]): void {\n\t\tthis._currentTheme = theme;\n\t\tthis._currentTokenColorMap = colorMap;\n\t\tif (this._currentTheme && this._currentTokenColorMap && this._workerProxy) {\n\t\t\tthis._workerProxy.$acceptTheme(this._currentTheme, this._currentTokenColorMap);\n\t\t}\n\t}\n\n\tprivate _getWorkerProxy(): Promise<Proxied<TextMateTokenizationWorker> | null> {\n\t\tif (!this._workerProxyPromise) {\n\t\t\tthis._workerProxyPromise = this._createWorkerProxy();\n\t\t}\n\t\treturn this._workerProxyPromise;\n\t}\n\n\tprivate async _createWorkerProxy(): Promise<Proxied<TextMateTokenizationWorker> | null> {\n\t\tconst onigurumaModuleLocation: AppResourcePath = `${nodeModulesPath}/vscode-oniguruma`;\n\t\tconst onigurumaModuleLocationAsar: AppResourcePath = `${nodeModulesAsarPath}/vscode-oniguruma`;\n\n\t\tconst useAsar = canASAR && this._environmentService.isBuilt && !isWeb;\n\t\tconst onigurumaLocation: AppResourcePath = useAsar ? onigurumaModuleLocationAsar : onigurumaModuleLocation;\n\t\tconst onigurumaWASM: AppResourcePath = `${onigurumaLocation}/release/onig.wasm`;\n\n\t\tconst createData: ICreateData = {\n\t\t\tgrammarDefinitions: this._grammarDefinitions,\n\t\t\tonigurumaWASMUri: FileAccess.asBrowserUri(onigurumaWASM).toString(true),\n\t\t};\n\t\tconst worker = this._worker = this._webWorkerService.createWorkerClient<TextMateTokenizationWorker>(\n\t\t\tnew WebWorkerDescriptor({\n\t\t\t\tesmModuleLocation: FileAccess.asBrowserUri('vs/workbench/services/textMate/browser/backgroundTokenization/worker/textMateTokenizationWorker.workerMain.js'),\n\t\t\t\tlabel: 'TextMateWorker'\n\t\t\t})\n\t\t);\n\t\tTextMateWorkerHost.setChannel(worker, {\n\t\t\t$readFile: async (_resource: UriComponents): Promise<string> => {\n\t\t\t\tconst resource = URI.revive(_resource);\n\t\t\t\treturn this._extensionResourceLoaderService.readExtensionResource(resource);\n\t\t\t},\n\t\t\t$setTokensAndStates: async (controllerId: number, versionId: number, tokens: Uint8Array, lineEndStateDeltas: StateDeltas[]): Promise<void> => {\n\t\t\t\tconst controller = this._workerTokenizerControllers.get(controllerId);\n\t\t\t\t// When a model detaches, it is removed synchronously from the map.\n\t\t\t\t// However, the worker might still be sending tokens for that model,\n\t\t\t\t// so we ignore the event when there is no controller.\n\t\t\t\tif (controller) {\n\t\t\t\t\tcontroller.setTokensAndStates(controllerId, versionId, tokens, lineEndStateDeltas);\n\t\t\t\t}\n\t\t\t},\n\t\t\t$reportTokenizationTime: (timeMs: number, languageId: string, sourceExtensionId: string | undefined, lineLength: number, isRandomSample: boolean): void => {\n\t\t\t\tthis._reportTokenizationTime(timeMs, languageId, sourceExtensionId, lineLength, isRandomSample);\n\t\t\t}\n\t\t});\n\t\tawait worker.proxy.$init(createData);\n\n\t\tif (this._worker !== worker) {\n\t\t\t// disposed in the meantime\n\t\t\treturn null;\n\t\t}\n\t\tthis._workerProxy = worker.proxy;\n\t\tif (this._currentTheme && this._currentTokenColorMap) {\n\t\t\tthis._workerProxy.$acceptTheme(this._currentTheme, this._currentTokenColorMap);\n\t\t}\n\t\treturn worker.proxy;\n\t}\n\n\tprivate _disposeWorker(): void {\n\t\tfor (const controller of this._workerTokenizerControllers.values()) {\n\t\t\tcontroller.dispose();\n\t\t}\n\t\tthis._workerTokenizerControllers.clear();\n\n\t\tif (this._worker) {\n\t\t\tthis._worker.dispose();\n\t\t\tthis._worker = null;\n\t\t}\n\t\tthis._workerProxy = null;\n\t\tthis._workerProxyPromise = null;\n\t}\n}\n\nfunction keepAliveWhenAttached(textModel: ITextModel, factory: () => IDisposable): IDisposable {\n\tconst disposableStore = new DisposableStore();\n\tconst subStore = disposableStore.add(new DisposableStore());\n\n\tfunction checkAttached() {\n\t\tif (textModel.isAttachedToEditor()) {\n\t\t\tsubStore.add(factory());\n\t\t} else {\n\t\t\tsubStore.clear();\n\t\t}\n\t}\n\n\tcheckAttached();\n\tdisposableStore.add(textModel.onDidChangeAttached(() => {\n\t\tcheckAttached();\n\t}));\n\treturn disposableStore;\n}\n"]}