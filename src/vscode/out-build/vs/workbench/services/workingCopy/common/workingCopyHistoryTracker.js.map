{"version":3,"sources":["vs/workbench/services/workingCopy/common/workingCopyHistoryTracker.ts"],"names":[],"mappings":"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","file":"workingCopyHistoryTracker.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { localize } from '../../../../nls.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { GlobalIdleValue, Limiter } from '../../../../base/common/async.js';\nimport { CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../../base/common/map.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IUndoRedoService } from '../../../../platform/undoRedo/common/undoRedo.js';\nimport { IUriIdentityService } from '../../../../platform/uriIdentity/common/uriIdentity.js';\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { SaveSource, SaveSourceRegistry } from '../../../common/editor.js';\nimport { IPathService } from '../../path/common/pathService.js';\nimport { isStoredFileWorkingCopySaveEvent, IStoredFileWorkingCopyModel } from './storedFileWorkingCopy.js';\nimport { IStoredFileWorkingCopySaveEvent } from './storedFileWorkingCopyManager.js';\nimport { IWorkingCopy } from './workingCopy.js';\nimport { IWorkingCopyHistoryService, MAX_PARALLEL_HISTORY_IO_OPS } from './workingCopyHistory.js';\nimport { IWorkingCopySaveEvent, IWorkingCopyService } from './workingCopyService.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { ResourceGlobMatcher } from '../../../common/resources.js';\nimport { IWorkspaceContextService } from '../../../../platform/workspace/common/workspace.js';\nimport { FileOperation, FileOperationEvent, IFileOperationEventWithMetadata, IFileService, IFileStatWithMetadata } from '../../../../platform/files/common/files.js';\n\nexport class WorkingCopyHistoryTracker extends Disposable implements IWorkbenchContribution {\n\n\tprivate static readonly SETTINGS = {\n\t\tENABLED: 'workbench.localHistory.enabled',\n\t\tSIZE_LIMIT: 'workbench.localHistory.maxFileSize',\n\t\tEXCLUDES: 'workbench.localHistory.exclude'\n\t};\n\n\tprivate static readonly UNDO_REDO_SAVE_SOURCE = SaveSourceRegistry.registerSource('undoRedo.source', localize('undoRedo.source', \"Undo / Redo\"));\n\n\tprivate readonly limiter = this._register(new Limiter(MAX_PARALLEL_HISTORY_IO_OPS));\n\n\tprivate readonly resourceExcludeMatcher = this._register(new GlobalIdleValue(() => {\n\t\tconst matcher = this._register(new ResourceGlobMatcher(\n\t\t\troot => this.configurationService.getValue(WorkingCopyHistoryTracker.SETTINGS.EXCLUDES, { resource: root }),\n\t\t\tevent => event.affectsConfiguration(WorkingCopyHistoryTracker.SETTINGS.EXCLUDES),\n\t\t\tthis.contextService,\n\t\t\tthis.configurationService\n\t\t));\n\n\t\treturn matcher;\n\t}));\n\n\tprivate readonly pendingAddHistoryEntryOperations = new ResourceMap<CancellationTokenSource>(resource => this.uriIdentityService.extUri.getComparisonKey(resource));\n\n\tprivate readonly workingCopyContentVersion = new ResourceMap<number>(resource => this.uriIdentityService.extUri.getComparisonKey(resource));\n\tprivate readonly historyEntryContentVersion = new ResourceMap<number>(resource => this.uriIdentityService.extUri.getComparisonKey(resource));\n\n\tconstructor(\n\t\t@IWorkingCopyService private readonly workingCopyService: IWorkingCopyService,\n\t\t@IWorkingCopyHistoryService private readonly workingCopyHistoryService: IWorkingCopyHistoryService,\n\t\t@IUriIdentityService private readonly uriIdentityService: IUriIdentityService,\n\t\t@IPathService private readonly pathService: IPathService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IUndoRedoService private readonly undoRedoService: IUndoRedoService,\n\t\t@IWorkspaceContextService private readonly contextService: IWorkspaceContextService,\n\t\t@IFileService private readonly fileService: IFileService\n\t) {\n\t\tsuper();\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners() {\n\n\t\t// File Events\n\t\tthis._register(this.fileService.onDidRunOperation(e => this.onDidRunFileOperation(e)));\n\n\t\t// Working Copy Events\n\t\tthis._register(this.workingCopyService.onDidChangeContent(workingCopy => this.onDidChangeContent(workingCopy)));\n\t\tthis._register(this.workingCopyService.onDidSave(e => this.onDidSave(e)));\n\t}\n\n\tprivate async onDidRunFileOperation(e: FileOperationEvent): Promise<void> {\n\t\tif (!this.shouldTrackHistoryFromFileOperationEvent(e)) {\n\t\t\treturn; // return early for working copies we are not interested in\n\t\t}\n\n\t\tconst source = e.resource;\n\t\tconst target = e.target.resource;\n\n\t\t// Move working copy history entries for this file move event\n\t\tconst resources = await this.workingCopyHistoryService.moveEntries(source, target);\n\n\t\t// Make sure to track the content version of each entry that\n\t\t// was moved in our map. This ensures that a subsequent save\n\t\t// without a content change does not add a redundant entry\n\t\t// (https://github.com/microsoft/vscode/issues/145881)\n\t\tfor (const resource of resources) {\n\t\t\tconst contentVersion = this.getContentVersion(resource);\n\t\t\tthis.historyEntryContentVersion.set(resource, contentVersion);\n\t\t}\n\t}\n\n\tprivate onDidChangeContent(workingCopy: IWorkingCopy): void {\n\n\t\t// Increment content version ID for resource\n\t\tconst contentVersionId = this.getContentVersion(workingCopy.resource);\n\t\tthis.workingCopyContentVersion.set(workingCopy.resource, contentVersionId + 1);\n\t}\n\n\tprivate getContentVersion(resource: URI): number {\n\t\treturn this.workingCopyContentVersion.get(resource) || 0;\n\t}\n\n\tprivate onDidSave(e: IWorkingCopySaveEvent): void {\n\t\tif (!this.shouldTrackHistoryFromSaveEvent(e)) {\n\t\t\treturn; // return early for working copies we are not interested in\n\t\t}\n\n\t\tconst contentVersion = this.getContentVersion(e.workingCopy.resource);\n\t\tif (this.historyEntryContentVersion.get(e.workingCopy.resource) === contentVersion) {\n\t\t\treturn; // return early when content version already has associated history entry\n\t\t}\n\n\t\t// Cancel any previous operation for this resource\n\t\tthis.pendingAddHistoryEntryOperations.get(e.workingCopy.resource)?.dispose(true);\n\n\t\t// Create new cancellation token support and remember\n\t\tconst cts = new CancellationTokenSource();\n\t\tthis.pendingAddHistoryEntryOperations.set(e.workingCopy.resource, cts);\n\n\t\t// Queue new operation to add to history\n\t\tthis.limiter.queue(async () => {\n\t\t\tif (cts.token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst contentVersion = this.getContentVersion(e.workingCopy.resource);\n\n\t\t\t// Figure out source of save operation if not provided already\n\t\t\tlet source = e.source;\n\t\t\tif (!e.source) {\n\t\t\t\tsource = this.resolveSourceFromUndoRedo(e);\n\t\t\t}\n\n\t\t\t// Add entry\n\t\t\tawait this.workingCopyHistoryService.addEntry({ resource: e.workingCopy.resource, source, timestamp: e.stat.mtime }, cts.token);\n\n\t\t\t// Remember content version as being added to history\n\t\t\tthis.historyEntryContentVersion.set(e.workingCopy.resource, contentVersion);\n\n\t\t\tif (cts.token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Finally remove from pending operations\n\t\t\tthis.pendingAddHistoryEntryOperations.delete(e.workingCopy.resource);\n\t\t});\n\t}\n\n\tprivate resolveSourceFromUndoRedo(e: IWorkingCopySaveEvent): SaveSource | undefined {\n\t\tconst lastStackElement = this.undoRedoService.getLastElement(e.workingCopy.resource);\n\t\tif (lastStackElement) {\n\t\t\tif (lastStackElement.code === 'undoredo.textBufferEdit') {\n\t\t\t\treturn undefined; // ignore any unspecific stack element that resulted just from typing\n\t\t\t}\n\n\t\t\treturn lastStackElement.label;\n\t\t}\n\n\t\tconst allStackElements = this.undoRedoService.getElements(e.workingCopy.resource);\n\t\tif (allStackElements.future.length > 0 || allStackElements.past.length > 0) {\n\t\t\treturn WorkingCopyHistoryTracker.UNDO_REDO_SAVE_SOURCE;\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate shouldTrackHistoryFromSaveEvent(e: IWorkingCopySaveEvent): e is IStoredFileWorkingCopySaveEvent<IStoredFileWorkingCopyModel> {\n\t\tif (!isStoredFileWorkingCopySaveEvent(e)) {\n\t\t\treturn false; // only support working copies that are backed by stored files\n\t\t}\n\n\t\treturn this.shouldTrackHistory(e.workingCopy.resource, e.stat);\n\t}\n\n\tprivate shouldTrackHistoryFromFileOperationEvent(e: FileOperationEvent): e is IFileOperationEventWithMetadata {\n\t\tif (!e.isOperation(FileOperation.MOVE)) {\n\t\t\treturn false; // only interested in move operations\n\t\t}\n\n\t\treturn this.shouldTrackHistory(e.target.resource, e.target);\n\t}\n\n\tprivate shouldTrackHistory(resource: URI, stat: IFileStatWithMetadata): boolean {\n\t\tif (\n\t\t\tresource.scheme !== this.pathService.defaultUriScheme && \t// track history for all workspace resources\n\t\t\tresource.scheme !== Schemas.vscodeUserData &&\t\t\t\t// track history for all settings\n\t\t\tresource.scheme !== Schemas.inMemory\t \t\t\t\t\t// track history for tests that use in-memory\n\t\t) {\n\t\t\treturn false; // do not support unknown resources\n\t\t}\n\n\t\tconst configuredMaxFileSizeInBytes = 1024 * this.configurationService.getValue<number>(WorkingCopyHistoryTracker.SETTINGS.SIZE_LIMIT, { resource });\n\t\tif (stat.size > configuredMaxFileSizeInBytes) {\n\t\t\treturn false; // only track files that are not too large\n\t\t}\n\n\t\tif (this.configurationService.getValue(WorkingCopyHistoryTracker.SETTINGS.ENABLED, { resource }) === false) {\n\t\t\treturn false; // do not track when history is disabled\n\t\t}\n\n\t\t// Finally check for exclude setting\n\t\treturn !this.resourceExcludeMatcher.value.matches(resource);\n\t}\n}\n"]}