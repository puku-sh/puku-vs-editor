{"version":3,"sources":["vs/workbench/services/lifecycle/browser/lifecycleService.ts"],"names":[],"mappings":"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","file":"lifecycleService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ShutdownReason, ILifecycleService, StartupKind } from '../common/lifecycle.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { AbstractLifecycleService } from '../common/lifecycleService.js';\nimport { localize } from '../../../../nls.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { IDisposable } from '../../../../base/common/lifecycle.js';\nimport { addDisposableListener, EventType } from '../../../../base/browser/dom.js';\nimport { IStorageService, WillSaveStateReason } from '../../../../platform/storage/common/storage.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { mainWindow } from '../../../../base/browser/window.js';\n\nexport class BrowserLifecycleService extends AbstractLifecycleService {\n\n\tprivate beforeUnloadListener: IDisposable | undefined = undefined;\n\tprivate unloadListener: IDisposable | undefined = undefined;\n\n\tprivate ignoreBeforeUnload = false;\n\n\tprivate didUnload = false;\n\n\tconstructor(\n\t\t@ILogService logService: ILogService,\n\t\t@IStorageService storageService: IStorageService\n\t) {\n\t\tsuper(logService, storageService);\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\n\t\t// Listen to `beforeUnload` to support to veto\n\t\tthis.beforeUnloadListener = addDisposableListener(mainWindow, EventType.BEFORE_UNLOAD, (e: BeforeUnloadEvent) => this.onBeforeUnload(e));\n\n\t\t// Listen to `pagehide` to support orderly shutdown\n\t\t// We explicitly do not listen to `unload` event\n\t\t// which would disable certain browser caching.\n\t\t// We currently do not handle the `persisted` property\n\t\t// (https://github.com/microsoft/vscode/issues/136216)\n\t\tthis.unloadListener = addDisposableListener(mainWindow, EventType.PAGE_HIDE, () => this.onUnload());\n\t}\n\n\tprivate onBeforeUnload(event: BeforeUnloadEvent): void {\n\n\t\t// Before unload ignored (once)\n\t\tif (this.ignoreBeforeUnload) {\n\t\t\tthis.logService.info('[lifecycle] onBeforeUnload triggered but ignored once');\n\n\t\t\tthis.ignoreBeforeUnload = false;\n\t\t}\n\n\t\t// Before unload with veto support\n\t\telse {\n\t\t\tthis.logService.info('[lifecycle] onBeforeUnload triggered and handled with veto support');\n\n\t\t\tthis.doShutdown(() => this.vetoBeforeUnload(event));\n\t\t}\n\t}\n\n\tprivate vetoBeforeUnload(event: BeforeUnloadEvent): void {\n\t\tevent.preventDefault();\n\t\tevent.returnValue = localize('lifecycleVeto', \"Changes that you made may not be saved. Please check press 'Cancel' and try again.\");\n\t}\n\n\twithExpectedShutdown(reason: ShutdownReason): Promise<void>;\n\twithExpectedShutdown(reason: { disableShutdownHandling: true }, callback: Function): void;\n\twithExpectedShutdown(reason: ShutdownReason | { disableShutdownHandling: true }, callback?: Function): Promise<void> | void {\n\n\t\t// Standard shutdown\n\t\tif (typeof reason === 'number') {\n\t\t\tthis.shutdownReason = reason;\n\n\t\t\t// Ensure UI state is persisted\n\t\t\treturn this.storageService.flush(WillSaveStateReason.SHUTDOWN);\n\t\t}\n\n\t\t// Before unload handling ignored for duration of callback\n\t\telse {\n\t\t\tthis.ignoreBeforeUnload = true;\n\t\t\ttry {\n\t\t\t\tcallback?.();\n\t\t\t} finally {\n\t\t\t\tthis.ignoreBeforeUnload = false;\n\t\t\t}\n\t\t}\n\t}\n\n\tasync shutdown(): Promise<void> {\n\t\tthis.logService.info('[lifecycle] shutdown triggered');\n\n\t\t// An explicit shutdown renders our unload\n\t\t// event handlers disabled, so dispose them.\n\t\tthis.beforeUnloadListener?.dispose();\n\t\tthis.unloadListener?.dispose();\n\n\t\t// Ensure UI state is persisted\n\t\tawait this.storageService.flush(WillSaveStateReason.SHUTDOWN);\n\n\t\t// Handle shutdown without veto support\n\t\tthis.doShutdown();\n\t}\n\n\tprivate doShutdown(vetoShutdown?: () => void): void {\n\t\tconst logService = this.logService;\n\n\t\t// Optimistically trigger a UI state flush\n\t\t// without waiting for it. The browser does\n\t\t// not guarantee that this is being executed\n\t\t// but if a dialog opens, we have a chance\n\t\t// to succeed.\n\t\tthis.storageService.flush(WillSaveStateReason.SHUTDOWN);\n\n\t\tlet veto = false;\n\n\t\tfunction handleVeto(vetoResult: boolean | Promise<boolean>, id: string) {\n\t\t\tif (typeof vetoShutdown !== 'function') {\n\t\t\t\treturn; // veto handling disabled\n\t\t\t}\n\n\t\t\tif (vetoResult instanceof Promise) {\n\t\t\t\tlogService.error(`[lifecycle] Long running operations before shutdown are unsupported in the web (id: ${id})`);\n\n\t\t\t\tveto = true; // implicitly vetos since we cannot handle promises in web\n\t\t\t}\n\n\t\t\tif (vetoResult === true) {\n\t\t\t\tlogService.info(`[lifecycle]: Unload was prevented (id: ${id})`);\n\n\t\t\t\tveto = true;\n\t\t\t}\n\t\t}\n\n\t\t// Before Shutdown\n\t\tthis._onBeforeShutdown.fire({\n\t\t\treason: ShutdownReason.QUIT,\n\t\t\tveto(value, id) {\n\t\t\t\thandleVeto(value, id);\n\t\t\t},\n\t\t\tfinalVeto(valueFn, id) {\n\t\t\t\thandleVeto(valueFn(), id); // in browser, trigger instantly because we do not support async anyway\n\t\t\t}\n\t\t});\n\n\t\t// Veto: handle if provided\n\t\tif (veto && typeof vetoShutdown === 'function') {\n\t\t\treturn vetoShutdown();\n\t\t}\n\n\t\t// No veto, continue to shutdown\n\t\treturn this.onUnload();\n\t}\n\n\tprivate onUnload(): void {\n\t\tif (this.didUnload) {\n\t\t\treturn; // only once\n\t\t}\n\n\t\tthis.didUnload = true;\n\t\tthis._willShutdown = true;\n\n\t\t// Register a late `pageshow` listener specifically on unload\n\t\tthis._register(addDisposableListener(mainWindow, EventType.PAGE_SHOW, (e: PageTransitionEvent) => this.onLoadAfterUnload(e)));\n\n\t\t// First indicate will-shutdown\n\t\tconst logService = this.logService;\n\t\tthis._onWillShutdown.fire({\n\t\t\treason: ShutdownReason.QUIT,\n\t\t\tjoiners: () => [], \t\t\t\t// Unsupported in web\n\t\t\ttoken: CancellationToken.None, \t// Unsupported in web\n\t\t\tjoin(promise, joiner) {\n\t\t\t\tif (typeof promise === 'function') {\n\t\t\t\t\tpromise();\n\t\t\t\t}\n\t\t\t\tlogService.error(`[lifecycle] Long running operations during shutdown are unsupported in the web (id: ${joiner.id})`);\n\t\t\t},\n\t\t\tforce: () => { /* No-Op in web */ },\n\t\t});\n\n\t\t// Finally end with did-shutdown\n\t\tthis._onDidShutdown.fire();\n\t}\n\n\tprivate onLoadAfterUnload(event: PageTransitionEvent): void {\n\n\t\t// We only really care about page-show events\n\t\t// where the browser indicates to us that the\n\t\t// page was restored from cache and not freshly\n\t\t// loaded.\n\t\tconst wasRestoredFromCache = event.persisted;\n\t\tif (!wasRestoredFromCache) {\n\t\t\treturn;\n\t\t}\n\n\t\t// At this point, we know that the page was restored from\n\t\t// cache even though it was unloaded before,\n\t\t// so in order to get back to a functional workbench, we\n\t\t// currently can only reload the window\n\t\t// Docs: https://web.dev/bfcache/#optimize-your-pages-for-bfcache\n\t\t// Refs: https://github.com/microsoft/vscode/issues/136035\n\t\tthis.withExpectedShutdown({ disableShutdownHandling: true }, () => mainWindow.location.reload());\n\t}\n\n\tprotected override doResolveStartupKind(): StartupKind | undefined {\n\t\tlet startupKind = super.doResolveStartupKind();\n\t\tif (typeof startupKind !== 'number') {\n\t\t\tconst timing = performance.getEntriesByType('navigation').at(0) as PerformanceNavigationTiming | undefined;\n\t\t\tif (timing?.type === 'reload') {\n\t\t\t\t// MDN: https://developer.mozilla.org/en-US/docs/Web/API/PerformanceNavigationTiming/type#value\n\t\t\t\tstartupKind = StartupKind.ReloadedWindow;\n\t\t\t}\n\t\t}\n\n\t\treturn startupKind;\n\t}\n}\n\nregisterSingleton(ILifecycleService, BrowserLifecycleService, InstantiationType.Eager);\n"]}