{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/services/treeSitter/browser/treeSitterLibraryService.ts","vs/workbench/services/treeSitter/browser/treeSitterLibraryService.ts"],"names":[],"mappings":"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","file":"treeSitterLibraryService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n\nimport type { Parser, Language, Query } from '@vscode/tree-sitter-wasm';\nimport { IReader, ObservablePromise } from '../../../../base/common/observable.js';\nimport { ITreeSitterLibraryService } from '../../../../editor/common/services/treeSitter/treeSitterLibraryService.js';\nimport { canASAR, importAMDNodeModule } from '../../../../amdX.js';\nimport { Lazy } from '../../../../base/common/lazy.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { FileOperationResult, IFileContent, IFileService, toFileOperationResult } from '../../../../platform/files/common/files.js';\nimport { observableConfigValue } from '../../../../platform/observable/common/platformObservableUtils.js';\nimport { CachedFunction } from '../../../../base/common/cache.js';\nimport { IEnvironmentService } from '../../../../platform/environment/common/environment.js';\nimport { AppResourcePath, FileAccess, nodeModulesAsarUnpackedPath, nodeModulesPath } from '../../../../base/common/network.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\n\nexport const EDITOR_EXPERIMENTAL_PREFER_TREESITTER = 'editor.experimental.preferTreeSitter';\nexport const TREESITTER_ALLOWED_SUPPORT = ['css', 'typescript', 'ini', 'regex'];\n\nconst MODULE_LOCATION_SUBPATH = `@vscode/tree-sitter-wasm/wasm`;\nconst FILENAME_TREESITTER_WASM = `tree-sitter.wasm`;\n\nexport function getModuleLocation(environmentService: IEnvironmentService): AppResourcePath {\n\treturn `${(canASAR && environmentService.isBuilt) ? nodeModulesAsarUnpackedPath : nodeModulesPath}/${MODULE_LOCATION_SUBPATH}`;\n}\n\nexport class TreeSitterLibraryService extends Disposable implements ITreeSitterLibraryService {\n\t_serviceBrand: undefined;\n\tisTest: boolean = false;\n\n\tprivate readonly _treeSitterImport = new Lazy(async () => {\n\t\tconst TreeSitter = await importAMDNodeModule<typeof import('@vscode/tree-sitter-wasm')>('@vscode/tree-sitter-wasm', 'wasm/tree-sitter.js');\n\t\tconst environmentService = this._environmentService;\n\t\tconst isTest = this.isTest;\n\t\tawait TreeSitter.Parser.init({\n\t\t\tlocateFile(_file: string, _folder: string) {\n\t\t\t\tconst location: AppResourcePath = `${getModuleLocation(environmentService)}/${FILENAME_TREESITTER_WASM}`;\n\t\t\t\tif (isTest) {\n\t\t\t\t\treturn FileAccess.asFileUri(location).toString(true);\n\t\t\t\t} else {\n\t\t\t\t\treturn FileAccess.asBrowserUri(location).toString(true);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn TreeSitter;\n\t});\n\n\tprivate readonly _supportsLanguage = new CachedFunction((languageId: string) => {\n\t\treturn observableConfigValue(`${EDITOR_EXPERIMENTAL_PREFER_TREESITTER}.${languageId}`, false, this._configurationService);\n\t});\n\n\tprivate readonly _languagesCache = new CachedFunction((languageId: string) => {\n\t\treturn ObservablePromise.fromFn(async () => {\n\t\t\tconst languageLocation = getModuleLocation(this._environmentService);\n\t\t\tconst grammarName = `tree-sitter-${languageId}`;\n\n\t\t\tconst wasmPath: AppResourcePath = `${languageLocation}/${grammarName}.wasm`;\n\t\t\tconst [treeSitter, languageFile] = await Promise.all([\n\t\t\t\tthis._treeSitterImport.value,\n\t\t\t\tthis._fileService.readFile(FileAccess.asFileUri(wasmPath))\n\t\t\t]);\n\n\t\t\tconst Language = treeSitter.Language;\n\t\t\tconst language = await Language.load(languageFile.value.buffer);\n\t\t\treturn language;\n\t\t});\n\t});\n\n\tprivate readonly _injectionQueries = new CachedFunction({ getCacheKey: JSON.stringify }, (arg: { languageId: string; kind: 'injections' | 'highlights' }) => {\n\t\tconst loadQuerySource = async () => {\n\t\t\tconst injectionsQueriesLocation: AppResourcePath = `vs/editor/common/languages/${arg.kind}/${arg.languageId}.scm`;\n\t\t\tconst uri = FileAccess.asFileUri(injectionsQueriesLocation);\n\t\t\tif (!this._fileService.hasProvider(uri)) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tconst query = await tryReadFile(this._fileService, uri);\n\t\t\tif (query === undefined) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\treturn query.value.toString();\n\t\t};\n\n\t\treturn ObservablePromise.fromFn(async () => {\n\t\t\tconst [\n\t\t\t\tquerySource,\n\t\t\t\tlanguage,\n\t\t\t\ttreeSitter\n\t\t\t] = await Promise.all([\n\t\t\t\tloadQuerySource(),\n\t\t\t\tthis._languagesCache.get(arg.languageId).promise,\n\t\t\t\tthis._treeSitterImport.value,\n\t\t\t]);\n\n\t\t\tif (querySource === undefined) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst Query = treeSitter.Query;\n\t\t\treturn new Query(language, querySource);\n\t\t}).resolvedValue;\n\t});\n\n\tconstructor(\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@IEnvironmentService private readonly _environmentService: IEnvironmentService,\n\t) {\n\t\tsuper();\n\t}\n\n\tsupportsLanguage(languageId: string, reader: IReader | undefined): boolean {\n\t\treturn this._supportsLanguage.get(languageId).read(reader);\n\t}\n\n\tasync getParserClass(): Promise<typeof Parser> {\n\t\tconst treeSitter = await this._treeSitterImport.value;\n\t\treturn treeSitter.Parser;\n\t}\n\n\tgetLanguage(languageId: string, ignoreSupportsCheck: boolean, reader: IReader | undefined): Language | undefined {\n\t\tif (!ignoreSupportsCheck && !this.supportsLanguage(languageId, reader)) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst lang = this._languagesCache.get(languageId).resolvedValue.read(reader);\n\t\treturn lang;\n\t}\n\n\tasync getLanguagePromise(languageId: string): Promise<Language | undefined> {\n\t\treturn this._languagesCache.get(languageId).promise;\n\t}\n\n\tgetInjectionQueries(languageId: string, reader: IReader | undefined): Query | null | undefined {\n\t\tif (!this.supportsLanguage(languageId, reader)) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst query = this._injectionQueries.get({ languageId, kind: 'injections' }).read(reader);\n\t\treturn query;\n\t}\n\n\tgetHighlightingQueries(languageId: string, reader: IReader | undefined): Query | null | undefined {\n\t\tif (!this.supportsLanguage(languageId, reader)) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst query = this._injectionQueries.get({ languageId, kind: 'highlights' }).read(reader);\n\t\treturn query;\n\t}\n\n\tasync createQuery(language: Language, querySource: string): Promise<Query> {\n\t\tconst treeSitter = await this._treeSitterImport.value;\n\t\treturn new treeSitter.Query(language, querySource);\n\t}\n}\n\nasync function tryReadFile(fileService: IFileService, uri: URI): Promise<IFileContent | undefined> {\n\ttry {\n\t\tconst result = await fileService.readFile(uri);\n\t\treturn result;\n\t} catch (e) {\n\t\tif (toFileOperationResult(e) === FileOperationResult.FILE_NOT_FOUND) {\n\t\t\treturn undefined;\n\t\t}\n\t\tthrow e;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n\nimport type { Parser, Language, Query } from '@vscode/tree-sitter-wasm';\nimport { IReader, ObservablePromise } from '../../../../base/common/observable.js';\nimport { ITreeSitterLibraryService } from '../../../../editor/common/services/treeSitter/treeSitterLibraryService.js';\nimport { canASAR, importAMDNodeModule } from '../../../../amdX.js';\nimport { Lazy } from '../../../../base/common/lazy.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { FileOperationResult, IFileContent, IFileService, toFileOperationResult } from '../../../../platform/files/common/files.js';\nimport { observableConfigValue } from '../../../../platform/observable/common/platformObservableUtils.js';\nimport { CachedFunction } from '../../../../base/common/cache.js';\nimport { IEnvironmentService } from '../../../../platform/environment/common/environment.js';\nimport { AppResourcePath, FileAccess, nodeModulesAsarUnpackedPath, nodeModulesPath } from '../../../../base/common/network.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\n\nexport const EDITOR_EXPERIMENTAL_PREFER_TREESITTER = 'editor.experimental.preferTreeSitter';\nexport const TREESITTER_ALLOWED_SUPPORT = ['css', 'typescript', 'ini', 'regex'];\n\nconst MODULE_LOCATION_SUBPATH = `@vscode/tree-sitter-wasm/wasm`;\nconst FILENAME_TREESITTER_WASM = `tree-sitter.wasm`;\n\nexport function getModuleLocation(environmentService: IEnvironmentService): AppResourcePath {\n\treturn `${(canASAR && environmentService.isBuilt) ? nodeModulesAsarUnpackedPath : nodeModulesPath}/${MODULE_LOCATION_SUBPATH}`;\n}\n\nexport class TreeSitterLibraryService extends Disposable implements ITreeSitterLibraryService {\n\t_serviceBrand: undefined;\n\tisTest: boolean = false;\n\n\tprivate readonly _treeSitterImport = new Lazy(async () => {\n\t\tconst TreeSitter = await importAMDNodeModule<typeof import('@vscode/tree-sitter-wasm')>('@vscode/tree-sitter-wasm', 'wasm/tree-sitter.js');\n\t\tconst environmentService = this._environmentService;\n\t\tconst isTest = this.isTest;\n\t\tawait TreeSitter.Parser.init({\n\t\t\tlocateFile(_file: string, _folder: string) {\n\t\t\t\tconst location: AppResourcePath = `${getModuleLocation(environmentService)}/${FILENAME_TREESITTER_WASM}`;\n\t\t\t\tif (isTest) {\n\t\t\t\t\treturn FileAccess.asFileUri(location).toString(true);\n\t\t\t\t} else {\n\t\t\t\t\treturn FileAccess.asBrowserUri(location).toString(true);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn TreeSitter;\n\t});\n\n\tprivate readonly _supportsLanguage = new CachedFunction((languageId: string) => {\n\t\treturn observableConfigValue(`${EDITOR_EXPERIMENTAL_PREFER_TREESITTER}.${languageId}`, false, this._configurationService);\n\t});\n\n\tprivate readonly _languagesCache = new CachedFunction((languageId: string) => {\n\t\treturn ObservablePromise.fromFn(async () => {\n\t\t\tconst languageLocation = getModuleLocation(this._environmentService);\n\t\t\tconst grammarName = `tree-sitter-${languageId}`;\n\n\t\t\tconst wasmPath: AppResourcePath = `${languageLocation}/${grammarName}.wasm`;\n\t\t\tconst [treeSitter, languageFile] = await Promise.all([\n\t\t\t\tthis._treeSitterImport.value,\n\t\t\t\tthis._fileService.readFile(FileAccess.asFileUri(wasmPath))\n\t\t\t]);\n\n\t\t\tconst Language = treeSitter.Language;\n\t\t\tconst language = await Language.load(languageFile.value.buffer);\n\t\t\treturn language;\n\t\t});\n\t});\n\n\tprivate readonly _injectionQueries = new CachedFunction({ getCacheKey: JSON.stringify }, (arg: { languageId: string; kind: 'injections' | 'highlights' }) => {\n\t\tconst loadQuerySource = async () => {\n\t\t\tconst injectionsQueriesLocation: AppResourcePath = `vs/editor/common/languages/${arg.kind}/${arg.languageId}.scm`;\n\t\t\tconst uri = FileAccess.asFileUri(injectionsQueriesLocation);\n\t\t\tif (!this._fileService.hasProvider(uri)) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tconst query = await tryReadFile(this._fileService, uri);\n\t\t\tif (query === undefined) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\treturn query.value.toString();\n\t\t};\n\n\t\treturn ObservablePromise.fromFn(async () => {\n\t\t\tconst [\n\t\t\t\tquerySource,\n\t\t\t\tlanguage,\n\t\t\t\ttreeSitter\n\t\t\t] = await Promise.all([\n\t\t\t\tloadQuerySource(),\n\t\t\t\tthis._languagesCache.get(arg.languageId).promise,\n\t\t\t\tthis._treeSitterImport.value,\n\t\t\t]);\n\n\t\t\tif (querySource === undefined) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tconst Query = treeSitter.Query;\n\t\t\treturn new Query(language, querySource);\n\t\t}).resolvedValue;\n\t});\n\n\tconstructor(\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@IEnvironmentService private readonly _environmentService: IEnvironmentService,\n\t) {\n\t\tsuper();\n\t}\n\n\tsupportsLanguage(languageId: string, reader: IReader | undefined): boolean {\n\t\treturn this._supportsLanguage.get(languageId).read(reader);\n\t}\n\n\tasync getParserClass(): Promise<typeof Parser> {\n\t\tconst treeSitter = await this._treeSitterImport.value;\n\t\treturn treeSitter.Parser;\n\t}\n\n\tgetLanguage(languageId: string, ignoreSupportsCheck: boolean, reader: IReader | undefined): Language | undefined {\n\t\tif (!ignoreSupportsCheck && !this.supportsLanguage(languageId, reader)) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst lang = this._languagesCache.get(languageId).resolvedValue.read(reader);\n\t\treturn lang;\n\t}\n\n\tasync getLanguagePromise(languageId: string): Promise<Language | undefined> {\n\t\treturn this._languagesCache.get(languageId).promise;\n\t}\n\n\tgetInjectionQueries(languageId: string, reader: IReader | undefined): Query | null | undefined {\n\t\tif (!this.supportsLanguage(languageId, reader)) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst query = this._injectionQueries.get({ languageId, kind: 'injections' }).read(reader);\n\t\treturn query;\n\t}\n\n\tgetHighlightingQueries(languageId: string, reader: IReader | undefined): Query | null | undefined {\n\t\tif (!this.supportsLanguage(languageId, reader)) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst query = this._injectionQueries.get({ languageId, kind: 'highlights' }).read(reader);\n\t\treturn query;\n\t}\n\n\tasync createQuery(language: Language, querySource: string): Promise<Query> {\n\t\tconst treeSitter = await this._treeSitterImport.value;\n\t\treturn new treeSitter.Query(language, querySource);\n\t}\n}\n\nasync function tryReadFile(fileService: IFileService, uri: URI): Promise<IFileContent | undefined> {\n\ttry {\n\t\tconst result = await fileService.readFile(uri);\n\t\treturn result;\n\t} catch (e) {\n\t\tif (toFileOperationResult(e) === FileOperationResult.FILE_NOT_FOUND) {\n\t\t\treturn undefined;\n\t\t}\n\t\tthrow e;\n\t}\n}\n"]}