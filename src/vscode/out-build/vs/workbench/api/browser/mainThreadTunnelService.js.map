{"version":3,"sources":["vs/workbench/api/browser/mainThreadTunnelService.ts"],"names":[],"mappings":"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","file":"mainThreadTunnelService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from '../../../nls.js';\nimport { MainThreadTunnelServiceShape, MainContext, ExtHostContext, ExtHostTunnelServiceShape, CandidatePortSource, PortAttributesSelector, TunnelDto } from '../common/extHost.protocol.js';\nimport { TunnelDtoConverter } from '../common/extHostTunnelService.js';\nimport { extHostNamedCustomer, IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { IRemoteExplorerService, PORT_AUTO_FORWARD_SETTING, PORT_AUTO_SOURCE_SETTING, PORT_AUTO_SOURCE_SETTING_HYBRID, PORT_AUTO_SOURCE_SETTING_OUTPUT, PortsEnablement } from '../../services/remote/common/remoteExplorerService.js';\nimport { ITunnelProvider, ITunnelService, TunnelCreationOptions, TunnelProviderFeatures, TunnelOptions, RemoteTunnel, ProvidedPortAttributes, PortAttributesProvider, TunnelProtocol } from '../../../platform/tunnel/common/tunnel.js';\nimport { Disposable } from '../../../base/common/lifecycle.js';\nimport type { TunnelDescription } from '../../../platform/remote/common/remoteAuthorityResolver.js';\nimport { INotificationService, Severity } from '../../../platform/notification/common/notification.js';\nimport { IConfigurationService } from '../../../platform/configuration/common/configuration.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { IRemoteAgentService } from '../../services/remote/common/remoteAgentService.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { Registry } from '../../../platform/registry/common/platform.js';\nimport { IConfigurationRegistry, Extensions as ConfigurationExtensions } from '../../../platform/configuration/common/configurationRegistry.js';\nimport { IContextKeyService } from '../../../platform/contextkey/common/contextkey.js';\nimport { CandidatePort, TunnelCloseReason, TunnelSource, forwardedPortsFeaturesEnabled, makeAddress } from '../../services/remote/common/tunnelModel.js';\n\n@extHostNamedCustomer(MainContext.MainThreadTunnelService)\nexport class MainThreadTunnelService extends Disposable implements MainThreadTunnelServiceShape, PortAttributesProvider {\n\tprivate readonly _proxy: ExtHostTunnelServiceShape;\n\tprivate elevateionRetry: boolean = false;\n\tprivate portsAttributesProviders: Map<number, PortAttributesSelector> = new Map();\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@IRemoteExplorerService private readonly remoteExplorerService: IRemoteExplorerService,\n\t\t@ITunnelService private readonly tunnelService: ITunnelService,\n\t\t@INotificationService private readonly notificationService: INotificationService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IRemoteAgentService private readonly remoteAgentService: IRemoteAgentService,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService\n\t) {\n\t\tsuper();\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostTunnelService);\n\t\tthis._register(tunnelService.onTunnelOpened(() => this._proxy.$onDidTunnelsChange()));\n\t\tthis._register(tunnelService.onTunnelClosed(() => this._proxy.$onDidTunnelsChange()));\n\t}\n\n\tprivate processFindingEnabled(): boolean {\n\t\treturn (!!this.configurationService.getValue(PORT_AUTO_FORWARD_SETTING) || this.tunnelService.hasTunnelProvider)\n\t\t\t&& (this.configurationService.getValue(PORT_AUTO_SOURCE_SETTING) !== PORT_AUTO_SOURCE_SETTING_OUTPUT);\n\t}\n\n\tasync $setRemoteTunnelService(processId: number): Promise<void> {\n\t\tthis.remoteExplorerService.namedProcesses.set(processId, 'Code Extension Host');\n\t\tif (this.remoteExplorerService.portsFeaturesEnabled === PortsEnablement.AdditionalFeatures) {\n\t\t\tthis._proxy.$registerCandidateFinder(this.processFindingEnabled());\n\t\t} else {\n\t\t\tthis._register(this.remoteExplorerService.onEnabledPortsFeatures(() => this._proxy.$registerCandidateFinder(this.processFindingEnabled())));\n\t\t}\n\t\tthis._register(this.configurationService.onDidChangeConfiguration(async (e) => {\n\t\t\tif ((this.remoteExplorerService.portsFeaturesEnabled === PortsEnablement.AdditionalFeatures) && (e.affectsConfiguration(PORT_AUTO_FORWARD_SETTING) || e.affectsConfiguration(PORT_AUTO_SOURCE_SETTING))) {\n\t\t\t\treturn this._proxy.$registerCandidateFinder(this.processFindingEnabled());\n\t\t\t}\n\t\t}));\n\t\tthis._register(this.tunnelService.onAddedTunnelProvider(async () => {\n\t\t\tif (this.remoteExplorerService.portsFeaturesEnabled === PortsEnablement.AdditionalFeatures) {\n\t\t\t\treturn this._proxy.$registerCandidateFinder(this.processFindingEnabled());\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate _alreadyRegistered: boolean = false;\n\tasync $registerPortsAttributesProvider(selector: PortAttributesSelector, providerHandle: number): Promise<void> {\n\t\tthis.portsAttributesProviders.set(providerHandle, selector);\n\t\tif (!this._alreadyRegistered) {\n\t\t\tthis.remoteExplorerService.tunnelModel.addAttributesProvider(this);\n\t\t\tthis._alreadyRegistered = true;\n\t\t}\n\t}\n\n\tasync $unregisterPortsAttributesProvider(providerHandle: number): Promise<void> {\n\t\tthis.portsAttributesProviders.delete(providerHandle);\n\t}\n\n\tasync providePortAttributes(ports: number[], pid: number | undefined, commandLine: string | undefined, token: CancellationToken): Promise<ProvidedPortAttributes[]> {\n\t\tif (this.portsAttributesProviders.size === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\t// Check all the selectors to make sure it's worth going to the extension host.\n\t\tconst appropriateHandles = Array.from(this.portsAttributesProviders.entries()).filter(entry => {\n\t\t\tconst selector = entry[1];\n\t\t\tconst portRange = (typeof selector.portRange === 'number') ? [selector.portRange, selector.portRange + 1] : selector.portRange;\n\t\t\tconst portInRange = portRange ? ports.some(port => portRange[0] <= port && port < portRange[1]) : true;\n\t\t\tconst commandMatches = !selector.commandPattern || (commandLine && (commandLine.match(selector.commandPattern)));\n\t\t\treturn portInRange && commandMatches;\n\t\t}).map(entry => entry[0]);\n\n\t\tif (appropriateHandles.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\treturn this._proxy.$providePortAttributes(appropriateHandles, ports, pid, commandLine, token);\n\t}\n\n\tasync $openTunnel(tunnelOptions: TunnelOptions, source: string): Promise<TunnelDto | undefined> {\n\t\tconst tunnel = await this.remoteExplorerService.forward({\n\t\t\tremote: tunnelOptions.remoteAddress,\n\t\t\tlocal: tunnelOptions.localAddressPort,\n\t\t\tname: tunnelOptions.label,\n\t\t\tsource: {\n\t\t\t\tsource: TunnelSource.Extension,\n\t\t\t\tdescription: source\n\t\t\t},\n\t\t\televateIfNeeded: false\n\t\t});\n\t\tif (!tunnel || (typeof tunnel === 'string')) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (!this.elevateionRetry\n\t\t\t&& (tunnelOptions.localAddressPort !== undefined)\n\t\t\t&& (tunnel.tunnelLocalPort !== undefined)\n\t\t\t&& this.tunnelService.isPortPrivileged(tunnelOptions.localAddressPort)\n\t\t\t&& (tunnel.tunnelLocalPort !== tunnelOptions.localAddressPort)\n\t\t\t&& this.tunnelService.canElevate) {\n\n\t\t\tthis.elevationPrompt(tunnelOptions, tunnel, source);\n\t\t}\n\t\treturn TunnelDtoConverter.fromServiceTunnel(tunnel);\n\t}\n\n\tprivate async elevationPrompt(tunnelOptions: TunnelOptions, tunnel: RemoteTunnel, source: string) {\n\t\treturn this.notificationService.prompt(Severity.Info,\n\t\t\tnls.localize('remote.tunnel.openTunnel', \"The extension {0} has forwarded port {1}. You'll need to run as superuser to use port {2} locally.\", source, tunnelOptions.remoteAddress.port, tunnelOptions.localAddressPort),\n\t\t\t[{\n\t\t\t\tlabel: nls.localize('remote.tunnelsView.elevationButton', \"Use Port {0} as Sudo...\", tunnel.tunnelRemotePort),\n\t\t\t\trun: async () => {\n\t\t\t\t\tthis.elevateionRetry = true;\n\t\t\t\t\tawait this.remoteExplorerService.close({ host: tunnel.tunnelRemoteHost, port: tunnel.tunnelRemotePort }, TunnelCloseReason.Other);\n\t\t\t\t\tawait this.remoteExplorerService.forward({\n\t\t\t\t\t\tremote: tunnelOptions.remoteAddress,\n\t\t\t\t\t\tlocal: tunnelOptions.localAddressPort,\n\t\t\t\t\t\tname: tunnelOptions.label,\n\t\t\t\t\t\tsource: {\n\t\t\t\t\t\t\tsource: TunnelSource.Extension,\n\t\t\t\t\t\t\tdescription: source\n\t\t\t\t\t\t},\n\t\t\t\t\t\televateIfNeeded: true\n\t\t\t\t\t});\n\t\t\t\t\tthis.elevateionRetry = false;\n\t\t\t\t}\n\t\t\t}]);\n\t}\n\n\tasync $closeTunnel(remote: { host: string; port: number }): Promise<void> {\n\t\treturn this.remoteExplorerService.close(remote, TunnelCloseReason.Other);\n\t}\n\n\tasync $getTunnels(): Promise<TunnelDescription[]> {\n\t\treturn (await this.tunnelService.tunnels).map(tunnel => {\n\t\t\treturn {\n\t\t\t\tremoteAddress: { port: tunnel.tunnelRemotePort, host: tunnel.tunnelRemoteHost },\n\t\t\t\tlocalAddress: tunnel.localAddress,\n\t\t\t\tprivacy: tunnel.privacy,\n\t\t\t\tprotocol: tunnel.protocol\n\t\t\t};\n\t\t});\n\t}\n\n\tasync $onFoundNewCandidates(candidates: CandidatePort[]): Promise<void> {\n\t\tthis.remoteExplorerService.onFoundNewCandidates(candidates);\n\t}\n\n\tasync $setTunnelProvider(features: TunnelProviderFeatures | undefined, isResolver: boolean): Promise<void> {\n\t\tconst tunnelProvider: ITunnelProvider = {\n\t\t\tforwardPort: (tunnelOptions: TunnelOptions, tunnelCreationOptions: TunnelCreationOptions) => {\n\t\t\t\tconst forward = this._proxy.$forwardPort(tunnelOptions, tunnelCreationOptions);\n\t\t\t\treturn forward.then(tunnelOrError => {\n\t\t\t\t\tif (!tunnelOrError) {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t} else if (typeof tunnelOrError === 'string') {\n\t\t\t\t\t\treturn tunnelOrError;\n\t\t\t\t\t}\n\t\t\t\t\tconst tunnel = tunnelOrError;\n\t\t\t\t\tthis.logService.trace(`ForwardedPorts: (MainThreadTunnelService) New tunnel established by tunnel provider: ${tunnel?.remoteAddress.host}:${tunnel?.remoteAddress.port}`);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttunnelRemotePort: tunnel.remoteAddress.port,\n\t\t\t\t\t\ttunnelRemoteHost: tunnel.remoteAddress.host,\n\t\t\t\t\t\tlocalAddress: typeof tunnel.localAddress === 'string' ? tunnel.localAddress : makeAddress(tunnel.localAddress.host, tunnel.localAddress.port),\n\t\t\t\t\t\ttunnelLocalPort: typeof tunnel.localAddress !== 'string' ? tunnel.localAddress.port : undefined,\n\t\t\t\t\t\tpublic: tunnel.public,\n\t\t\t\t\t\tprivacy: tunnel.privacy,\n\t\t\t\t\t\tprotocol: tunnel.protocol ?? TunnelProtocol.Http,\n\t\t\t\t\t\tdispose: async (silent?: boolean) => {\n\t\t\t\t\t\t\tthis.logService.trace(`ForwardedPorts: (MainThreadTunnelService) Closing tunnel from tunnel provider: ${tunnel?.remoteAddress.host}:${tunnel?.remoteAddress.port}`);\n\t\t\t\t\t\t\treturn this._proxy.$closeTunnel({ host: tunnel.remoteAddress.host, port: tunnel.remoteAddress.port }, silent);\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t\tif (features) {\n\t\t\tthis.tunnelService.setTunnelFeatures(features);\n\t\t}\n\t\tthis.tunnelService.setTunnelProvider(tunnelProvider);\n\t\t// At this point we clearly want the ports view/features since we have a tunnel factory\n\t\tif (isResolver) {\n\t\t\tthis.contextKeyService.createKey(forwardedPortsFeaturesEnabled.key, true);\n\t\t}\n\t}\n\n\tasync $hasTunnelProvider(): Promise<boolean> {\n\t\treturn this.tunnelService.hasTunnelProvider;\n\t}\n\n\tasync $setCandidateFilter(): Promise<void> {\n\t\tthis.remoteExplorerService.setCandidateFilter((candidates: CandidatePort[]): Promise<CandidatePort[]> => {\n\t\t\treturn this._proxy.$applyCandidateFilter(candidates);\n\t\t});\n\t}\n\n\tasync $setCandidatePortSource(source: CandidatePortSource): Promise<void> {\n\t\t// Must wait for the remote environment before trying to set settings there.\n\t\tthis.remoteAgentService.getEnvironment().then(() => {\n\t\t\tswitch (source) {\n\t\t\t\tcase CandidatePortSource.None: {\n\t\t\t\t\tRegistry.as<IConfigurationRegistry>(ConfigurationExtensions.Configuration)\n\t\t\t\t\t\t.registerDefaultConfigurations([{ overrides: { 'remote.autoForwardPorts': false } }]);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase CandidatePortSource.Output: {\n\t\t\t\t\tRegistry.as<IConfigurationRegistry>(ConfigurationExtensions.Configuration)\n\t\t\t\t\t\t.registerDefaultConfigurations([{ overrides: { 'remote.autoForwardPortsSource': PORT_AUTO_SOURCE_SETTING_OUTPUT } }]);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase CandidatePortSource.Hybrid: {\n\t\t\t\t\tRegistry.as<IConfigurationRegistry>(ConfigurationExtensions.Configuration)\n\t\t\t\t\t\t.registerDefaultConfigurations([{ overrides: { 'remote.autoForwardPortsSource': PORT_AUTO_SOURCE_SETTING_HYBRID } }]);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault: // Do nothing, the defaults for these settings should be used.\n\t\t\t}\n\t\t}).catch(() => {\n\t\t\t// The remote failed to get setup. Errors from that area will already be surfaced to the user.\n\t\t});\n\t}\n}\n"]}