{"version":3,"sources":["vs/workbench/api/browser/mainThreadCustomEditors.ts"],"names":[],"mappings":"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","file":"mainThreadCustomEditors.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { multibyteAwareBtoa } from '../../../base/common/strings.js';\nimport { CancelablePromise, createCancelablePromise } from '../../../base/common/async.js';\nimport { VSBuffer } from '../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { isCancellationError, onUnexpectedError } from '../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, DisposableMap, DisposableStore, IReference } from '../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { basename } from '../../../base/common/path.js';\nimport { isEqual, isEqualOrParent, toLocalResource } from '../../../base/common/resources.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { localize } from '../../../nls.js';\nimport { IFileDialogService } from '../../../platform/dialogs/common/dialogs.js';\nimport { FileOperation, IFileService } from '../../../platform/files/common/files.js';\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\nimport { ILabelService } from '../../../platform/label/common/label.js';\nimport { IStorageService } from '../../../platform/storage/common/storage.js';\nimport { IUndoRedoService, UndoRedoElementType } from '../../../platform/undoRedo/common/undoRedo.js';\nimport { MainThreadWebviewPanels } from './mainThreadWebviewPanels.js';\nimport { MainThreadWebviews, reviveWebviewExtension } from './mainThreadWebviews.js';\nimport * as extHostProtocol from '../common/extHost.protocol.js';\nimport { IRevertOptions, ISaveOptions } from '../../common/editor.js';\nimport { CustomEditorInput } from '../../contrib/customEditor/browser/customEditorInput.js';\nimport { CustomDocumentBackupData } from '../../contrib/customEditor/browser/customEditorInputFactory.js';\nimport { ICustomEditorModel, ICustomEditorService } from '../../contrib/customEditor/common/customEditor.js';\nimport { CustomTextEditorModel } from '../../contrib/customEditor/common/customTextEditorModel.js';\nimport { ExtensionKeyedWebviewOriginStore, WebviewExtensionDescription } from '../../contrib/webview/browser/webview.js';\nimport { WebviewInput } from '../../contrib/webviewPanel/browser/webviewEditorInput.js';\nimport { IWebviewWorkbenchService } from '../../contrib/webviewPanel/browser/webviewWorkbenchService.js';\nimport { editorGroupToColumn } from '../../services/editor/common/editorGroupColumn.js';\nimport { IEditorGroupsService } from '../../services/editor/common/editorGroupsService.js';\nimport { IEditorService } from '../../services/editor/common/editorService.js';\nimport { IWorkbenchEnvironmentService } from '../../services/environment/common/environmentService.js';\nimport { IExtensionService } from '../../services/extensions/common/extensions.js';\nimport { IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { IPathService } from '../../services/path/common/pathService.js';\nimport { ResourceWorkingCopy } from '../../services/workingCopy/common/resourceWorkingCopy.js';\nimport { IWorkingCopy, IWorkingCopyBackup, IWorkingCopySaveEvent, NO_TYPE_ID, WorkingCopyCapabilities } from '../../services/workingCopy/common/workingCopy.js';\nimport { IWorkingCopyFileService, WorkingCopyFileEvent } from '../../services/workingCopy/common/workingCopyFileService.js';\nimport { IWorkingCopyService } from '../../services/workingCopy/common/workingCopyService.js';\nimport { IUriIdentityService } from '../../../platform/uriIdentity/common/uriIdentity.js';\n\nconst enum CustomEditorModelType {\n\tCustom,\n\tText,\n}\n\nexport class MainThreadCustomEditors extends Disposable implements extHostProtocol.MainThreadCustomEditorsShape {\n\n\tprivate readonly _proxyCustomEditors: extHostProtocol.ExtHostCustomEditorsShape;\n\n\tprivate readonly _editorProviders = this._register(new DisposableMap<string>());\n\n\tprivate readonly _editorRenameBackups = new Map<string, CustomDocumentBackupData>();\n\n\tprivate readonly _webviewOriginStore: ExtensionKeyedWebviewOriginStore;\n\n\tconstructor(\n\t\tcontext: IExtHostContext,\n\t\tprivate readonly mainThreadWebview: MainThreadWebviews,\n\t\tprivate readonly mainThreadWebviewPanels: MainThreadWebviewPanels,\n\t\t@IExtensionService extensionService: IExtensionService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IWorkingCopyService workingCopyService: IWorkingCopyService,\n\t\t@IWorkingCopyFileService workingCopyFileService: IWorkingCopyFileService,\n\t\t@ICustomEditorService private readonly _customEditorService: ICustomEditorService,\n\t\t@IEditorGroupsService private readonly _editorGroupService: IEditorGroupsService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IWebviewWorkbenchService private readonly _webviewWorkbenchService: IWebviewWorkbenchService,\n\t\t@IUriIdentityService private readonly _uriIdentityService: IUriIdentityService,\n\t) {\n\t\tsuper();\n\n\t\tthis._webviewOriginStore = new ExtensionKeyedWebviewOriginStore('mainThreadCustomEditors.origins', storageService);\n\n\t\tthis._proxyCustomEditors = context.getProxy(extHostProtocol.ExtHostContext.ExtHostCustomEditors);\n\n\t\tthis._register(workingCopyFileService.registerWorkingCopyProvider((editorResource) => {\n\t\t\tconst matchedWorkingCopies: IWorkingCopy[] = [];\n\n\t\t\tfor (const workingCopy of workingCopyService.workingCopies) {\n\t\t\t\tif (workingCopy instanceof MainThreadCustomEditorModel) {\n\t\t\t\t\tif (isEqualOrParent(editorResource, workingCopy.editorResource)) {\n\t\t\t\t\t\tmatchedWorkingCopies.push(workingCopy);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn matchedWorkingCopies;\n\t\t}));\n\n\t\t// This reviver's only job is to activate custom editor extensions.\n\t\tthis._register(_webviewWorkbenchService.registerResolver({\n\t\t\tcanResolve: (webview: WebviewInput) => {\n\t\t\t\tif (webview instanceof CustomEditorInput) {\n\t\t\t\t\textensionService.activateByEvent(`onCustomEditor:${webview.viewType}`);\n\t\t\t\t}\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tresolveWebview: () => { throw new Error('not implemented'); }\n\t\t}));\n\n\t\t// Working copy operations\n\t\tthis._register(workingCopyFileService.onWillRunWorkingCopyFileOperation(async e => this.onWillRunWorkingCopyFileOperation(e)));\n\t}\n\n\tpublic $registerTextEditorProvider(extensionData: extHostProtocol.WebviewExtensionDescription, viewType: string, options: extHostProtocol.IWebviewPanelOptions, capabilities: extHostProtocol.CustomTextEditorCapabilities, serializeBuffersForPostMessage: boolean): void {\n\t\tthis.registerEditorProvider(CustomEditorModelType.Text, reviveWebviewExtension(extensionData), viewType, options, capabilities, true, serializeBuffersForPostMessage);\n\t}\n\n\tpublic $registerCustomEditorProvider(extensionData: extHostProtocol.WebviewExtensionDescription, viewType: string, options: extHostProtocol.IWebviewPanelOptions, supportsMultipleEditorsPerDocument: boolean, serializeBuffersForPostMessage: boolean): void {\n\t\tthis.registerEditorProvider(CustomEditorModelType.Custom, reviveWebviewExtension(extensionData), viewType, options, {}, supportsMultipleEditorsPerDocument, serializeBuffersForPostMessage);\n\t}\n\n\tprivate registerEditorProvider(\n\t\tmodelType: CustomEditorModelType,\n\t\textension: WebviewExtensionDescription,\n\t\tviewType: string,\n\t\toptions: extHostProtocol.IWebviewPanelOptions,\n\t\tcapabilities: extHostProtocol.CustomTextEditorCapabilities,\n\t\tsupportsMultipleEditorsPerDocument: boolean,\n\t\tserializeBuffersForPostMessage: boolean,\n\t): void {\n\t\tif (this._editorProviders.has(viewType)) {\n\t\t\tthrow new Error(`Provider for ${viewType} already registered`);\n\t\t}\n\n\t\tconst disposables = new DisposableStore();\n\n\t\tdisposables.add(this._customEditorService.registerCustomEditorCapabilities(viewType, {\n\t\t\tsupportsMultipleEditorsPerDocument\n\t\t}));\n\n\t\tdisposables.add(this._webviewWorkbenchService.registerResolver({\n\t\t\tcanResolve: (webviewInput) => {\n\t\t\t\treturn webviewInput instanceof CustomEditorInput && webviewInput.viewType === viewType;\n\t\t\t},\n\t\t\tresolveWebview: async (webviewInput: CustomEditorInput, cancellation: CancellationToken) => {\n\t\t\t\tconst handle = generateUuid();\n\t\t\t\tconst resource = webviewInput.resource;\n\n\t\t\t\twebviewInput.webview.origin = this._webviewOriginStore.getOrigin(viewType, extension.id);\n\n\t\t\t\tthis.mainThreadWebviewPanels.addWebviewInput(handle, webviewInput, { serializeBuffersForPostMessage });\n\t\t\t\twebviewInput.webview.options = options;\n\t\t\t\twebviewInput.webview.extension = extension;\n\n\t\t\t\t// If there's an old resource this was a move and we must resolve the backup at the same time as the webview\n\t\t\t\t// This is because the backup must be ready upon model creation, and the input resolve method comes after\n\t\t\t\tlet backupId = webviewInput.backupId;\n\t\t\t\tif (webviewInput.oldResource && !webviewInput.backupId) {\n\t\t\t\t\tconst backup = this._editorRenameBackups.get(webviewInput.oldResource.toString());\n\t\t\t\t\tbackupId = backup?.backupId;\n\t\t\t\t\tthis._editorRenameBackups.delete(webviewInput.oldResource.toString());\n\t\t\t\t}\n\n\t\t\t\tlet modelRef: IReference<ICustomEditorModel>;\n\t\t\t\ttry {\n\t\t\t\t\tmodelRef = await this.getOrCreateCustomEditorModel(modelType, resource, viewType, { backupId }, cancellation);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tonUnexpectedError(error);\n\t\t\t\t\twebviewInput.webview.setHtml(this.mainThreadWebview.getWebviewResolvedFailedContent(viewType));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (cancellation.isCancellationRequested) {\n\t\t\t\t\tmodelRef.dispose();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst disposeSub = webviewInput.webview.onDidDispose(() => {\n\t\t\t\t\tdisposeSub.dispose();\n\n\t\t\t\t\t// If the model is still dirty, make sure we have time to save it\n\t\t\t\t\tif (modelRef.object.isDirty()) {\n\t\t\t\t\t\tconst sub = modelRef.object.onDidChangeDirty(() => {\n\t\t\t\t\t\t\tif (!modelRef.object.isDirty()) {\n\t\t\t\t\t\t\t\tsub.dispose();\n\t\t\t\t\t\t\t\tmodelRef.dispose();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tmodelRef.dispose();\n\t\t\t\t});\n\n\t\t\t\tif (capabilities.supportsMove) {\n\t\t\t\t\twebviewInput.onMove(async (newResource: URI) => {\n\t\t\t\t\t\tconst oldModel = modelRef;\n\t\t\t\t\t\tmodelRef = await this.getOrCreateCustomEditorModel(modelType, newResource, viewType, {}, CancellationToken.None);\n\t\t\t\t\t\tthis._proxyCustomEditors.$onMoveCustomEditor(handle, newResource, viewType);\n\t\t\t\t\t\toldModel.dispose();\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\tconst actualResource = modelType === CustomEditorModelType.Text ? this._uriIdentityService.asCanonicalUri(resource) : resource;\n\t\t\t\t\tawait this._proxyCustomEditors.$resolveCustomEditor(actualResource, handle, viewType, {\n\t\t\t\t\t\ttitle: webviewInput.getTitle(),\n\t\t\t\t\t\tcontentOptions: webviewInput.webview.contentOptions,\n\t\t\t\t\t\toptions: webviewInput.webview.options,\n\t\t\t\t\t\tactive: webviewInput === this._editorService.activeEditor,\n\t\t\t\t\t}, editorGroupToColumn(this._editorGroupService, webviewInput.group || 0), cancellation);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tonUnexpectedError(error);\n\t\t\t\t\twebviewInput.webview.setHtml(this.mainThreadWebview.getWebviewResolvedFailedContent(viewType));\n\t\t\t\t\tmodelRef.dispose();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._editorProviders.set(viewType, disposables);\n\t}\n\n\tpublic $unregisterEditorProvider(viewType: string): void {\n\t\tif (!this._editorProviders.has(viewType)) {\n\t\t\tthrow new Error(`No provider for ${viewType} registered`);\n\t\t}\n\n\t\tthis._editorProviders.deleteAndDispose(viewType);\n\n\t\tthis._customEditorService.models.disposeAllModelsForView(viewType);\n\t}\n\n\tprivate async getOrCreateCustomEditorModel(\n\t\tmodelType: CustomEditorModelType,\n\t\tresource: URI,\n\t\tviewType: string,\n\t\toptions: { backupId?: string },\n\t\tcancellation: CancellationToken,\n\t): Promise<IReference<ICustomEditorModel>> {\n\t\tconst existingModel = this._customEditorService.models.tryRetain(resource, viewType);\n\t\tif (existingModel) {\n\t\t\treturn existingModel;\n\t\t}\n\n\t\tswitch (modelType) {\n\t\t\tcase CustomEditorModelType.Text:\n\t\t\t\t{\n\t\t\t\t\tconst model = CustomTextEditorModel.create(this._instantiationService, viewType, resource);\n\t\t\t\t\treturn this._customEditorService.models.add(resource, viewType, model);\n\t\t\t\t}\n\t\t\tcase CustomEditorModelType.Custom:\n\t\t\t\t{\n\t\t\t\t\tconst model = MainThreadCustomEditorModel.create(this._instantiationService, this._proxyCustomEditors, viewType, resource, options, () => {\n\t\t\t\t\t\treturn Array.from(this.mainThreadWebviewPanels.webviewInputs)\n\t\t\t\t\t\t\t.filter(editor => editor instanceof CustomEditorInput && isEqual(editor.resource, resource)) as CustomEditorInput[];\n\t\t\t\t\t}, cancellation);\n\t\t\t\t\treturn this._customEditorService.models.add(resource, viewType, model);\n\t\t\t\t}\n\t\t}\n\t}\n\n\tpublic async $onDidEdit(resourceComponents: UriComponents, viewType: string, editId: number, label: string | undefined): Promise<void> {\n\t\tconst model = await this.getCustomEditorModel(resourceComponents, viewType);\n\t\tmodel.pushEdit(editId, label);\n\t}\n\n\tpublic async $onContentChange(resourceComponents: UriComponents, viewType: string): Promise<void> {\n\t\tconst model = await this.getCustomEditorModel(resourceComponents, viewType);\n\t\tmodel.changeContent();\n\t}\n\n\tprivate async getCustomEditorModel(resourceComponents: UriComponents, viewType: string) {\n\t\tconst resource = URI.revive(resourceComponents);\n\t\tconst model = await this._customEditorService.models.get(resource, viewType);\n\t\tif (!model || !(model instanceof MainThreadCustomEditorModel)) {\n\t\t\tthrow new Error('Could not find model for webview editor');\n\t\t}\n\t\treturn model;\n\t}\n\n\t//#region Working Copy\n\tprivate async onWillRunWorkingCopyFileOperation(e: WorkingCopyFileEvent) {\n\t\tif (e.operation !== FileOperation.MOVE) {\n\t\t\treturn;\n\t\t}\n\t\te.waitUntil((async () => {\n\t\t\tconst models = [];\n\t\t\tfor (const file of e.files) {\n\t\t\t\tif (file.source) {\n\t\t\t\t\tmodels.push(...(await this._customEditorService.models.getAllModels(file.source)));\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor (const model of models) {\n\t\t\t\tif (model instanceof MainThreadCustomEditorModel && model.isDirty()) {\n\t\t\t\t\tconst workingCopy = await model.backup(CancellationToken.None);\n\t\t\t\t\tif (workingCopy.meta) {\n\t\t\t\t\t\t// This cast is safe because we do an instanceof check above and a custom document backup data is always returned\n\t\t\t\t\t\tthis._editorRenameBackups.set(model.editorResource.toString(), workingCopy.meta as CustomDocumentBackupData);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t})());\n\t}\n\t//#endregion\n}\n\nnamespace HotExitState {\n\texport const enum Type {\n\t\tAllowed,\n\t\tNotAllowed,\n\t\tPending,\n\t}\n\n\texport const Allowed = Object.freeze({ type: Type.Allowed } as const);\n\texport const NotAllowed = Object.freeze({ type: Type.NotAllowed } as const);\n\n\texport class Pending {\n\t\treadonly type = Type.Pending;\n\n\t\tconstructor(\n\t\t\tpublic readonly operation: CancelablePromise<string>,\n\t\t) { }\n\t}\n\n\texport type State = typeof Allowed | typeof NotAllowed | Pending;\n}\n\n\nclass MainThreadCustomEditorModel extends ResourceWorkingCopy implements ICustomEditorModel {\n\n\tprivate _fromBackup: boolean = false;\n\tprivate _hotExitState: HotExitState.State = HotExitState.Allowed;\n\tprivate _backupId: string | undefined;\n\n\tprivate _currentEditIndex: number = -1;\n\tprivate _savePoint: number = -1;\n\tprivate readonly _edits: Array<number> = [];\n\tprivate _isDirtyFromContentChange = false;\n\n\tprivate _ongoingSave?: CancelablePromise<void>;\n\n\t// TODO@mjbvz consider to enable a `typeId` that is specific for custom\n\t// editors. Using a distinct `typeId` allows the working copy to have\n\t// any resource (including file based resources) even if other working\n\t// copies exist with the same resource.\n\t//\n\t// IMPORTANT: changing the `typeId` has an impact on backups for this\n\t// working copy. Any value that is not the empty string will be used\n\t// as seed to the backup. Only change the `typeId` if you have implemented\n\t// a fallback solution to resolve any existing backups that do not have\n\t// this seed.\n\treadonly typeId = NO_TYPE_ID;\n\n\tpublic static async create(\n\t\tinstantiationService: IInstantiationService,\n\t\tproxy: extHostProtocol.ExtHostCustomEditorsShape,\n\t\tviewType: string,\n\t\tresource: URI,\n\t\toptions: { backupId?: string },\n\t\tgetEditors: () => CustomEditorInput[],\n\t\tcancellation: CancellationToken,\n\t): Promise<MainThreadCustomEditorModel> {\n\t\tconst editors = getEditors();\n\t\tlet untitledDocumentData: VSBuffer | undefined;\n\t\tif (editors.length !== 0) {\n\t\t\tuntitledDocumentData = editors[0].untitledDocumentData;\n\t\t}\n\t\tconst { editable } = await proxy.$createCustomDocument(resource, viewType, options.backupId, untitledDocumentData, cancellation);\n\t\treturn instantiationService.createInstance(MainThreadCustomEditorModel, proxy, viewType, resource, !!options.backupId, editable, !!untitledDocumentData, getEditors);\n\t}\n\n\tconstructor(\n\t\tprivate readonly _proxy: extHostProtocol.ExtHostCustomEditorsShape,\n\t\tprivate readonly _viewType: string,\n\t\tprivate readonly _editorResource: URI,\n\t\tfromBackup: boolean,\n\t\tprivate readonly _editable: boolean,\n\t\tstartDirty: boolean,\n\t\tprivate readonly _getEditors: () => CustomEditorInput[],\n\t\t@IFileDialogService private readonly _fileDialogService: IFileDialogService,\n\t\t@IFileService fileService: IFileService,\n\t\t@ILabelService private readonly _labelService: ILabelService,\n\t\t@IUndoRedoService private readonly _undoService: IUndoRedoService,\n\t\t@IWorkbenchEnvironmentService private readonly _environmentService: IWorkbenchEnvironmentService,\n\t\t@IWorkingCopyService workingCopyService: IWorkingCopyService,\n\t\t@IPathService private readonly _pathService: IPathService,\n\t\t@IExtensionService extensionService: IExtensionService,\n\t) {\n\t\tsuper(MainThreadCustomEditorModel.toWorkingCopyResource(_viewType, _editorResource), fileService);\n\n\t\tthis._fromBackup = fromBackup;\n\n\t\tif (_editable) {\n\t\t\tthis._register(workingCopyService.registerWorkingCopy(this));\n\n\t\t\tthis._register(extensionService.onWillStop(e => {\n\t\t\t\te.veto(true, localize('vetoExtHostRestart', \"An extension provided editor for '{0}' is still open that would close otherwise.\", this.name));\n\t\t\t}));\n\t\t}\n\n\t\t// Normally means we're re-opening an untitled file\n\t\tif (startDirty) {\n\t\t\tthis._isDirtyFromContentChange = true;\n\t\t}\n\t}\n\n\tget editorResource() {\n\t\treturn this._editorResource;\n\t}\n\n\toverride dispose() {\n\t\tif (this._editable) {\n\t\t\tthis._undoService.removeElements(this._editorResource);\n\t\t}\n\n\t\tthis._proxy.$disposeCustomDocument(this._editorResource, this._viewType);\n\n\t\tsuper.dispose();\n\t}\n\n\t//#region IWorkingCopy\n\n\t// Make sure each custom editor has a unique resource for backup and edits\n\tprivate static toWorkingCopyResource(viewType: string, resource: URI) {\n\t\tconst authority = viewType.replace(/[^a-z0-9\\-_]/gi, '-');\n\t\tconst path = `/${multibyteAwareBtoa(resource.with({ query: null, fragment: null }).toString(true))}`;\n\t\treturn URI.from({\n\t\t\tscheme: Schemas.vscodeCustomEditor,\n\t\t\tauthority: authority,\n\t\t\tpath: path,\n\t\t\tquery: JSON.stringify(resource.toJSON()),\n\t\t});\n\t}\n\n\tpublic get name() {\n\t\treturn basename(this._labelService.getUriLabel(this._editorResource));\n\t}\n\n\tpublic get capabilities(): WorkingCopyCapabilities {\n\t\treturn this.isUntitled() ? WorkingCopyCapabilities.Untitled : WorkingCopyCapabilities.None;\n\t}\n\n\tpublic isDirty(): boolean {\n\t\tif (this._isDirtyFromContentChange) {\n\t\t\treturn true;\n\t\t}\n\t\tif (this._edits.length > 0) {\n\t\t\treturn this._savePoint !== this._currentEditIndex;\n\t\t}\n\t\treturn this._fromBackup;\n\t}\n\n\tprivate isUntitled() {\n\t\treturn this._editorResource.scheme === Schemas.untitled;\n\t}\n\n\tprivate readonly _onDidChangeDirty: Emitter<void> = this._register(new Emitter<void>());\n\treadonly onDidChangeDirty: Event<void> = this._onDidChangeDirty.event;\n\n\tprivate readonly _onDidChangeContent: Emitter<void> = this._register(new Emitter<void>());\n\treadonly onDidChangeContent: Event<void> = this._onDidChangeContent.event;\n\n\tprivate readonly _onDidSave: Emitter<IWorkingCopySaveEvent> = this._register(new Emitter<IWorkingCopySaveEvent>());\n\treadonly onDidSave: Event<IWorkingCopySaveEvent> = this._onDidSave.event;\n\n\treadonly onDidChangeReadonly = Event.None;\n\n\t//#endregion\n\n\tpublic isReadonly(): boolean {\n\t\treturn !this._editable;\n\t}\n\n\tpublic get viewType() {\n\t\treturn this._viewType;\n\t}\n\n\tpublic get backupId() {\n\t\treturn this._backupId;\n\t}\n\n\tpublic pushEdit(editId: number, label: string | undefined) {\n\t\tif (!this._editable) {\n\t\t\tthrow new Error('Document is not editable');\n\t\t}\n\n\t\tthis.change(() => {\n\t\t\tthis.spliceEdits(editId);\n\t\t\tthis._currentEditIndex = this._edits.length - 1;\n\t\t});\n\n\t\tthis._undoService.pushElement({\n\t\t\ttype: UndoRedoElementType.Resource,\n\t\t\tresource: this._editorResource,\n\t\t\tlabel: label ?? localize('defaultEditLabel', \"Edit\"),\n\t\t\tcode: 'undoredo.customEditorEdit',\n\t\t\tundo: () => this.undo(),\n\t\t\tredo: () => this.redo(),\n\t\t});\n\t}\n\n\tpublic changeContent() {\n\t\tthis.change(() => {\n\t\t\tthis._isDirtyFromContentChange = true;\n\t\t});\n\t}\n\n\tprivate async undo(): Promise<void> {\n\t\tif (!this._editable) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._currentEditIndex < 0) {\n\t\t\t// nothing to undo\n\t\t\treturn;\n\t\t}\n\n\t\tconst undoneEdit = this._edits[this._currentEditIndex];\n\t\tthis.change(() => {\n\t\t\t--this._currentEditIndex;\n\t\t});\n\t\tawait this._proxy.$undo(this._editorResource, this.viewType, undoneEdit, this.isDirty());\n\t}\n\n\tprivate async redo(): Promise<void> {\n\t\tif (!this._editable) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._currentEditIndex >= this._edits.length - 1) {\n\t\t\t// nothing to redo\n\t\t\treturn;\n\t\t}\n\n\t\tconst redoneEdit = this._edits[this._currentEditIndex + 1];\n\t\tthis.change(() => {\n\t\t\t++this._currentEditIndex;\n\t\t});\n\t\tawait this._proxy.$redo(this._editorResource, this.viewType, redoneEdit, this.isDirty());\n\t}\n\n\tprivate spliceEdits(editToInsert?: number) {\n\t\tconst start = this._currentEditIndex + 1;\n\t\tconst toRemove = this._edits.length - this._currentEditIndex;\n\n\t\tconst removedEdits = typeof editToInsert === 'number'\n\t\t\t? this._edits.splice(start, toRemove, editToInsert)\n\t\t\t: this._edits.splice(start, toRemove);\n\n\t\tif (removedEdits.length) {\n\t\t\tthis._proxy.$disposeEdits(this._editorResource, this._viewType, removedEdits);\n\t\t}\n\t}\n\n\tprivate change(makeEdit: () => void): void {\n\t\tconst wasDirty = this.isDirty();\n\t\tmakeEdit();\n\t\tthis._onDidChangeContent.fire();\n\n\t\tif (this.isDirty() !== wasDirty) {\n\t\t\tthis._onDidChangeDirty.fire();\n\t\t}\n\t}\n\n\tpublic async revert(options?: IRevertOptions) {\n\t\tif (!this._editable) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._currentEditIndex === this._savePoint && !this._isDirtyFromContentChange && !this._fromBackup) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!options?.soft) {\n\t\t\tthis._proxy.$revert(this._editorResource, this.viewType, CancellationToken.None);\n\t\t}\n\n\t\tthis.change(() => {\n\t\t\tthis._isDirtyFromContentChange = false;\n\t\t\tthis._fromBackup = false;\n\t\t\tthis._currentEditIndex = this._savePoint;\n\t\t\tthis.spliceEdits();\n\t\t});\n\t}\n\n\tpublic async save(options?: ISaveOptions): Promise<boolean> {\n\t\tconst result = !!await this.saveCustomEditor(options);\n\n\t\t// Emit Save Event\n\t\tif (result) {\n\t\t\tthis._onDidSave.fire({ reason: options?.reason, source: options?.source });\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tpublic async saveCustomEditor(options?: ISaveOptions): Promise<URI | undefined> {\n\t\tif (!this._editable) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (this.isUntitled()) {\n\t\t\tconst targetUri = await this.suggestUntitledSavePath(options);\n\t\t\tif (!targetUri) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tawait this.saveCustomEditorAs(this._editorResource, targetUri, options);\n\t\t\treturn targetUri;\n\t\t}\n\n\t\tconst savePromise = createCancelablePromise(token => this._proxy.$onSave(this._editorResource, this.viewType, token));\n\t\tthis._ongoingSave?.cancel();\n\t\tthis._ongoingSave = savePromise;\n\n\t\ttry {\n\t\t\tawait savePromise;\n\n\t\t\tif (this._ongoingSave === savePromise) { // Make sure we are still doing the same save\n\t\t\t\tthis.change(() => {\n\t\t\t\t\tthis._isDirtyFromContentChange = false;\n\t\t\t\t\tthis._savePoint = this._currentEditIndex;\n\t\t\t\t\tthis._fromBackup = false;\n\t\t\t\t});\n\t\t\t}\n\t\t} finally {\n\t\t\tif (this._ongoingSave === savePromise) { // Make sure we are still doing the same save\n\t\t\t\tthis._ongoingSave = undefined;\n\t\t\t}\n\t\t}\n\n\t\treturn this._editorResource;\n\t}\n\n\tprivate suggestUntitledSavePath(options: ISaveOptions | undefined): Promise<URI | undefined> {\n\t\tif (!this.isUntitled()) {\n\t\t\tthrow new Error('Resource is not untitled');\n\t\t}\n\n\t\tconst remoteAuthority = this._environmentService.remoteAuthority;\n\t\tconst localResource = toLocalResource(this._editorResource, remoteAuthority, this._pathService.defaultUriScheme);\n\n\t\treturn this._fileDialogService.pickFileToSave(localResource, options?.availableFileSystems);\n\t}\n\n\tpublic async saveCustomEditorAs(resource: URI, targetResource: URI, _options?: ISaveOptions): Promise<boolean> {\n\t\tif (this._editable) {\n\t\t\t// TODO: handle cancellation\n\t\t\tawait createCancelablePromise(token => this._proxy.$onSaveAs(this._editorResource, this.viewType, targetResource, token));\n\t\t\tthis.change(() => {\n\t\t\t\tthis._savePoint = this._currentEditIndex;\n\t\t\t});\n\t\t\treturn true;\n\t\t} else {\n\t\t\t// Since the editor is readonly, just copy the file over\n\t\t\tawait this.fileService.copy(resource, targetResource, false /* overwrite */);\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tpublic get canHotExit() { return typeof this._backupId === 'string' && this._hotExitState.type === HotExitState.Type.Allowed; }\n\n\tpublic async backup(token: CancellationToken): Promise<IWorkingCopyBackup> {\n\t\tconst editors = this._getEditors();\n\t\tif (!editors.length) {\n\t\t\tthrow new Error('No editors found for resource, cannot back up');\n\t\t}\n\t\tconst primaryEditor = editors[0];\n\n\t\tconst backupMeta: CustomDocumentBackupData = {\n\t\t\tviewType: this.viewType,\n\t\t\teditorResource: this._editorResource,\n\t\t\tcustomTitle: primaryEditor.getWebviewTitle(),\n\t\t\ticonPath: primaryEditor.iconPath,\n\t\t\tbackupId: '',\n\t\t\textension: primaryEditor.extension ? {\n\t\t\t\tid: primaryEditor.extension.id.value,\n\t\t\t\tlocation: primaryEditor.extension.location!,\n\t\t\t} : undefined,\n\t\t\twebview: {\n\t\t\t\torigin: primaryEditor.webview.origin,\n\t\t\t\toptions: primaryEditor.webview.options,\n\t\t\t\tstate: primaryEditor.webview.state,\n\t\t\t}\n\t\t};\n\n\t\tconst backupData: IWorkingCopyBackup = {\n\t\t\tmeta: backupMeta\n\t\t};\n\n\t\tif (!this._editable) {\n\t\t\treturn backupData;\n\t\t}\n\n\t\tif (this._hotExitState.type === HotExitState.Type.Pending) {\n\t\t\tthis._hotExitState.operation.cancel();\n\t\t}\n\n\t\tconst pendingState = new HotExitState.Pending(\n\t\t\tcreateCancelablePromise(token =>\n\t\t\t\tthis._proxy.$backup(this._editorResource.toJSON(), this.viewType, token)));\n\t\tthis._hotExitState = pendingState;\n\n\t\ttoken.onCancellationRequested(() => {\n\t\t\tpendingState.operation.cancel();\n\t\t});\n\n\t\tlet errorMessage = '';\n\t\ttry {\n\t\t\tconst backupId = await pendingState.operation;\n\t\t\t// Make sure state has not changed in the meantime\n\t\t\tif (this._hotExitState === pendingState) {\n\t\t\t\tthis._hotExitState = HotExitState.Allowed;\n\t\t\t\tbackupData.meta!.backupId = backupId;\n\t\t\t\tthis._backupId = backupId;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (isCancellationError(e)) {\n\t\t\t\t// This is expected\n\t\t\t\tthrow e;\n\t\t\t}\n\n\t\t\t// Otherwise it could be a real error. Make sure state has not changed in the meantime.\n\t\t\tif (this._hotExitState === pendingState) {\n\t\t\t\tthis._hotExitState = HotExitState.NotAllowed;\n\t\t\t}\n\t\t\tif (e.message) {\n\t\t\t\terrorMessage = e.message;\n\t\t\t}\n\t\t}\n\n\t\tif (this._hotExitState === HotExitState.Allowed) {\n\t\t\treturn backupData;\n\t\t}\n\n\t\tthrow new Error(`Cannot backup in this state: ${errorMessage}`);\n\t}\n}\n"]}