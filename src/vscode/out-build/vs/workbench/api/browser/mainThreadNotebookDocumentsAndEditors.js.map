{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/browser/mainThreadNotebookDocumentsAndEditors.ts","vs/workbench/api/browser/mainThreadNotebookDocumentsAndEditors.ts"],"names":[],"mappings":"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","file":"mainThreadNotebookDocumentsAndEditors.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { diffMaps, diffSets } from '../../../base/common/collections.js';\nimport { combinedDisposable, DisposableStore, DisposableMap } from '../../../base/common/lifecycle.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { MainThreadNotebookDocuments } from './mainThreadNotebookDocuments.js';\nimport { NotebookDto } from './mainThreadNotebookDto.js';\nimport { MainThreadNotebookEditors } from './mainThreadNotebookEditors.js';\nimport { extHostCustomer, IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { editorGroupToColumn } from '../../services/editor/common/editorGroupColumn.js';\nimport { getNotebookEditorFromEditorPane, IActiveNotebookEditor, INotebookEditor } from '../../contrib/notebook/browser/notebookBrowser.js';\nimport { INotebookEditorService } from '../../contrib/notebook/browser/services/notebookEditorService.js';\nimport { NotebookTextModel } from '../../contrib/notebook/common/model/notebookTextModel.js';\nimport { INotebookService } from '../../contrib/notebook/common/notebookService.js';\nimport { IEditorGroupsService } from '../../services/editor/common/editorGroupsService.js';\nimport { IEditorService } from '../../services/editor/common/editorService.js';\nimport { ExtHostContext, ExtHostNotebookShape, INotebookDocumentsAndEditorsDelta, INotebookEditorAddData, INotebookModelAddedData, MainContext } from '../common/extHost.protocol.js';\nimport { SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\n\ninterface INotebookAndEditorDelta {\n\tremovedDocuments: URI[];\n\taddedDocuments: NotebookTextModel[];\n\tremovedEditors: string[];\n\taddedEditors: IActiveNotebookEditor[];\n\tnewActiveEditor?: string | null;\n\tvisibleEditors?: string[];\n}\n\nclass NotebookAndEditorState {\n\tstatic delta(before: NotebookAndEditorState | undefined, after: NotebookAndEditorState): INotebookAndEditorDelta {\n\t\tif (!before) {\n\t\t\treturn {\n\t\t\t\taddedDocuments: [...after.documents],\n\t\t\t\tremovedDocuments: [],\n\t\t\t\taddedEditors: [...after.textEditors.values()],\n\t\t\t\tremovedEditors: [],\n\t\t\t\tvisibleEditors: [...after.visibleEditors].map(editor => editor[0])\n\t\t\t};\n\t\t}\n\t\tconst documentDelta = diffSets(before.documents, after.documents);\n\t\tconst editorDelta = diffMaps(before.textEditors, after.textEditors);\n\n\t\tconst newActiveEditor = before.activeEditor !== after.activeEditor ? after.activeEditor : undefined;\n\t\tconst visibleEditorDelta = diffMaps(before.visibleEditors, after.visibleEditors);\n\n\t\treturn {\n\t\t\taddedDocuments: documentDelta.added,\n\t\t\tremovedDocuments: documentDelta.removed.map(e => e.uri),\n\t\t\taddedEditors: editorDelta.added,\n\t\t\tremovedEditors: editorDelta.removed.map(removed => removed.getId()),\n\t\t\tnewActiveEditor: newActiveEditor,\n\t\t\tvisibleEditors: visibleEditorDelta.added.length === 0 && visibleEditorDelta.removed.length === 0\n\t\t\t\t? undefined\n\t\t\t\t: [...after.visibleEditors].map(editor => editor[0])\n\t\t};\n\t}\n\n\tconstructor(\n\t\treadonly documents: Set<NotebookTextModel>,\n\t\treadonly textEditors: Map<string, IActiveNotebookEditor>,\n\t\treadonly activeEditor: string | null | undefined,\n\t\treadonly visibleEditors: Map<string, IActiveNotebookEditor>\n\t) {\n\t\t//\n\t}\n}\n\n@extHostCustomer\nexport class MainThreadNotebooksAndEditors {\n\n\t// private readonly _onDidAddNotebooks = new Emitter<NotebookTextModel[]>();\n\t// private readonly _onDidRemoveNotebooks = new Emitter<URI[]>();\n\t// private readonly _onDidAddEditors = new Emitter<IActiveNotebookEditor[]>();\n\t// private readonly _onDidRemoveEditors = new Emitter<string[]>();\n\n\t// readonly onDidAddNotebooks: Event<NotebookTextModel[]> = this._onDidAddNotebooks.event;\n\t// readonly onDidRemoveNotebooks: Event<URI[]> = this._onDidRemoveNotebooks.event;\n\t// readonly onDidAddEditors: Event<IActiveNotebookEditor[]> = this._onDidAddEditors.event;\n\t// readonly onDidRemoveEditors: Event<string[]> = this._onDidRemoveEditors.event;\n\n\tprivate readonly _proxy: Pick<ExtHostNotebookShape, '$acceptDocumentAndEditorsDelta'>;\n\tprivate readonly _disposables = new DisposableStore();\n\n\tprivate readonly _editorListeners = new DisposableMap<string>();\n\n\tprivate _currentState?: NotebookAndEditorState;\n\n\tprivate readonly _mainThreadNotebooks: MainThreadNotebookDocuments;\n\tprivate readonly _mainThreadEditors: MainThreadNotebookEditors;\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@INotebookEditorService private readonly _notebookEditorService: INotebookEditorService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@IEditorGroupsService private readonly _editorGroupService: IEditorGroupsService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostNotebook);\n\n\t\tthis._mainThreadNotebooks = instantiationService.createInstance(MainThreadNotebookDocuments, extHostContext);\n\t\tthis._mainThreadEditors = instantiationService.createInstance(MainThreadNotebookEditors, extHostContext);\n\n\t\textHostContext.set(MainContext.MainThreadNotebookDocuments, this._mainThreadNotebooks);\n\t\textHostContext.set(MainContext.MainThreadNotebookEditors, this._mainThreadEditors);\n\n\t\tthis._notebookService.onWillAddNotebookDocument(() => this._updateState(), this, this._disposables);\n\t\tthis._notebookService.onDidRemoveNotebookDocument(() => this._updateState(), this, this._disposables);\n\t\tthis._editorService.onDidActiveEditorChange(() => this._updateState(), this, this._disposables);\n\t\tthis._editorService.onDidVisibleEditorsChange(() => this._updateState(), this, this._disposables);\n\t\tthis._notebookEditorService.onDidAddNotebookEditor(this._handleEditorAdd, this, this._disposables);\n\t\tthis._notebookEditorService.onDidRemoveNotebookEditor(this._handleEditorRemove, this, this._disposables);\n\t\tthis._updateState();\n\t}\n\n\tdispose() {\n\t\tthis._mainThreadNotebooks.dispose();\n\t\tthis._mainThreadEditors.dispose();\n\t\tthis._disposables.dispose();\n\t\tthis._editorListeners.dispose();\n\t}\n\n\tprivate _handleEditorAdd(editor: INotebookEditor): void {\n\t\tthis._editorListeners.set(editor.getId(), combinedDisposable(\n\t\t\teditor.onDidChangeModel(() => this._updateState()),\n\t\t\teditor.onDidFocusWidget(() => this._updateState(editor)),\n\t\t));\n\t\tthis._updateState();\n\t}\n\n\tprivate _handleEditorRemove(editor: INotebookEditor): void {\n\t\tthis._editorListeners.deleteAndDispose(editor.getId());\n\t\tthis._updateState();\n\t}\n\n\tprivate _updateState(focusedEditor?: INotebookEditor): void {\n\n\t\tconst editors = new Map<string, IActiveNotebookEditor>();\n\t\tconst visibleEditorsMap = new Map<string, IActiveNotebookEditor>();\n\n\t\tfor (const editor of this._notebookEditorService.listNotebookEditors()) {\n\t\t\tif (editor.hasModel()) {\n\t\t\t\teditors.set(editor.getId(), editor);\n\t\t\t}\n\t\t}\n\n\t\tconst activeNotebookEditor = getNotebookEditorFromEditorPane(this._editorService.activeEditorPane);\n\t\tlet activeEditor: string | null = null;\n\t\tif (activeNotebookEditor) {\n\t\t\tactiveEditor = activeNotebookEditor.getId();\n\t\t} else if (focusedEditor?.textModel) {\n\t\t\tactiveEditor = focusedEditor.getId();\n\t\t}\n\t\tif (activeEditor && !editors.has(activeEditor)) {\n\t\t\tthis._logService.trace('MainThreadNotebooksAndEditors#_updateState: active editor is not in editors list', activeEditor, editors.keys());\n\t\t\tactiveEditor = null;\n\t\t}\n\n\t\tfor (const editorPane of this._editorService.visibleEditorPanes) {\n\t\t\tconst notebookEditor = getNotebookEditorFromEditorPane(editorPane);\n\t\t\tif (notebookEditor?.hasModel() && editors.has(notebookEditor.getId())) {\n\t\t\t\tvisibleEditorsMap.set(notebookEditor.getId(), notebookEditor);\n\t\t\t}\n\t\t}\n\n\t\tconst newState = new NotebookAndEditorState(new Set(this._notebookService.listNotebookDocuments()), editors, activeEditor, visibleEditorsMap);\n\t\tthis._onDelta(NotebookAndEditorState.delta(this._currentState, newState));\n\t\tthis._currentState = newState;\n\t}\n\n\tprivate _onDelta(delta: INotebookAndEditorDelta): void {\n\t\tif (MainThreadNotebooksAndEditors._isDeltaEmpty(delta)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst dto: INotebookDocumentsAndEditorsDelta = {\n\t\t\tremovedDocuments: delta.removedDocuments,\n\t\t\tremovedEditors: delta.removedEditors,\n\t\t\tnewActiveEditor: delta.newActiveEditor,\n\t\t\tvisibleEditors: delta.visibleEditors,\n\t\t\taddedDocuments: delta.addedDocuments.map(MainThreadNotebooksAndEditors._asModelAddData),\n\t\t\taddedEditors: delta.addedEditors.map(this._asEditorAddData, this),\n\t\t};\n\n\t\t// send to extension FIRST\n\t\tthis._proxy.$acceptDocumentAndEditorsDelta(new SerializableObjectWithBuffers(dto));\n\n\t\t// handle internally\n\t\tthis._mainThreadEditors.handleEditorsRemoved(delta.removedEditors);\n\t\tthis._mainThreadNotebooks.handleNotebooksRemoved(delta.removedDocuments);\n\t\tthis._mainThreadNotebooks.handleNotebooksAdded(delta.addedDocuments);\n\t\tthis._mainThreadEditors.handleEditorsAdded(delta.addedEditors);\n\t}\n\n\tprivate static _isDeltaEmpty(delta: INotebookAndEditorDelta): boolean {\n\t\tif (delta.addedDocuments !== undefined && delta.addedDocuments.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.removedDocuments !== undefined && delta.removedDocuments.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.addedEditors !== undefined && delta.addedEditors.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.removedEditors !== undefined && delta.removedEditors.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.visibleEditors !== undefined && delta.visibleEditors.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.newActiveEditor !== undefined) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tprivate static _asModelAddData(e: NotebookTextModel): INotebookModelAddedData {\n\t\treturn {\n\t\t\tviewType: e.viewType,\n\t\t\turi: e.uri,\n\t\t\tmetadata: e.metadata,\n\t\t\tversionId: e.versionId,\n\t\t\tcells: e.cells.map(NotebookDto.toNotebookCellDto)\n\t\t};\n\t}\n\n\tprivate _asEditorAddData(add: IActiveNotebookEditor): INotebookEditorAddData {\n\n\t\tconst pane = this._editorService.visibleEditorPanes.find(pane => getNotebookEditorFromEditorPane(pane) === add);\n\n\t\treturn {\n\t\t\tid: add.getId(),\n\t\t\tdocumentUri: add.textModel.uri,\n\t\t\tselections: add.getSelections(),\n\t\t\tvisibleRanges: add.visibleRanges,\n\t\t\tviewColumn: pane && editorGroupToColumn(this._editorGroupService, pane.group),\n\t\t\tviewType: add.getViewModel().viewType\n\t\t};\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { diffMaps, diffSets } from '../../../base/common/collections.js';\nimport { combinedDisposable, DisposableStore, DisposableMap } from '../../../base/common/lifecycle.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { MainThreadNotebookDocuments } from './mainThreadNotebookDocuments.js';\nimport { NotebookDto } from './mainThreadNotebookDto.js';\nimport { MainThreadNotebookEditors } from './mainThreadNotebookEditors.js';\nimport { extHostCustomer, IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { editorGroupToColumn } from '../../services/editor/common/editorGroupColumn.js';\nimport { getNotebookEditorFromEditorPane, IActiveNotebookEditor, INotebookEditor } from '../../contrib/notebook/browser/notebookBrowser.js';\nimport { INotebookEditorService } from '../../contrib/notebook/browser/services/notebookEditorService.js';\nimport { NotebookTextModel } from '../../contrib/notebook/common/model/notebookTextModel.js';\nimport { INotebookService } from '../../contrib/notebook/common/notebookService.js';\nimport { IEditorGroupsService } from '../../services/editor/common/editorGroupsService.js';\nimport { IEditorService } from '../../services/editor/common/editorService.js';\nimport { ExtHostContext, ExtHostNotebookShape, INotebookDocumentsAndEditorsDelta, INotebookEditorAddData, INotebookModelAddedData, MainContext } from '../common/extHost.protocol.js';\nimport { SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\n\ninterface INotebookAndEditorDelta {\n\tremovedDocuments: URI[];\n\taddedDocuments: NotebookTextModel[];\n\tremovedEditors: string[];\n\taddedEditors: IActiveNotebookEditor[];\n\tnewActiveEditor?: string | null;\n\tvisibleEditors?: string[];\n}\n\nclass NotebookAndEditorState {\n\tstatic delta(before: NotebookAndEditorState | undefined, after: NotebookAndEditorState): INotebookAndEditorDelta {\n\t\tif (!before) {\n\t\t\treturn {\n\t\t\t\taddedDocuments: [...after.documents],\n\t\t\t\tremovedDocuments: [],\n\t\t\t\taddedEditors: [...after.textEditors.values()],\n\t\t\t\tremovedEditors: [],\n\t\t\t\tvisibleEditors: [...after.visibleEditors].map(editor => editor[0])\n\t\t\t};\n\t\t}\n\t\tconst documentDelta = diffSets(before.documents, after.documents);\n\t\tconst editorDelta = diffMaps(before.textEditors, after.textEditors);\n\n\t\tconst newActiveEditor = before.activeEditor !== after.activeEditor ? after.activeEditor : undefined;\n\t\tconst visibleEditorDelta = diffMaps(before.visibleEditors, after.visibleEditors);\n\n\t\treturn {\n\t\t\taddedDocuments: documentDelta.added,\n\t\t\tremovedDocuments: documentDelta.removed.map(e => e.uri),\n\t\t\taddedEditors: editorDelta.added,\n\t\t\tremovedEditors: editorDelta.removed.map(removed => removed.getId()),\n\t\t\tnewActiveEditor: newActiveEditor,\n\t\t\tvisibleEditors: visibleEditorDelta.added.length === 0 && visibleEditorDelta.removed.length === 0\n\t\t\t\t? undefined\n\t\t\t\t: [...after.visibleEditors].map(editor => editor[0])\n\t\t};\n\t}\n\n\tconstructor(\n\t\treadonly documents: Set<NotebookTextModel>,\n\t\treadonly textEditors: Map<string, IActiveNotebookEditor>,\n\t\treadonly activeEditor: string | null | undefined,\n\t\treadonly visibleEditors: Map<string, IActiveNotebookEditor>\n\t) {\n\t\t//\n\t}\n}\n\n@extHostCustomer\nexport class MainThreadNotebooksAndEditors {\n\n\t// private readonly _onDidAddNotebooks = new Emitter<NotebookTextModel[]>();\n\t// private readonly _onDidRemoveNotebooks = new Emitter<URI[]>();\n\t// private readonly _onDidAddEditors = new Emitter<IActiveNotebookEditor[]>();\n\t// private readonly _onDidRemoveEditors = new Emitter<string[]>();\n\n\t// readonly onDidAddNotebooks: Event<NotebookTextModel[]> = this._onDidAddNotebooks.event;\n\t// readonly onDidRemoveNotebooks: Event<URI[]> = this._onDidRemoveNotebooks.event;\n\t// readonly onDidAddEditors: Event<IActiveNotebookEditor[]> = this._onDidAddEditors.event;\n\t// readonly onDidRemoveEditors: Event<string[]> = this._onDidRemoveEditors.event;\n\n\tprivate readonly _proxy: Pick<ExtHostNotebookShape, '$acceptDocumentAndEditorsDelta'>;\n\tprivate readonly _disposables = new DisposableStore();\n\n\tprivate readonly _editorListeners = new DisposableMap<string>();\n\n\tprivate _currentState?: NotebookAndEditorState;\n\n\tprivate readonly _mainThreadNotebooks: MainThreadNotebookDocuments;\n\tprivate readonly _mainThreadEditors: MainThreadNotebookEditors;\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@INotebookEditorService private readonly _notebookEditorService: INotebookEditorService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@IEditorGroupsService private readonly _editorGroupService: IEditorGroupsService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostNotebook);\n\n\t\tthis._mainThreadNotebooks = instantiationService.createInstance(MainThreadNotebookDocuments, extHostContext);\n\t\tthis._mainThreadEditors = instantiationService.createInstance(MainThreadNotebookEditors, extHostContext);\n\n\t\textHostContext.set(MainContext.MainThreadNotebookDocuments, this._mainThreadNotebooks);\n\t\textHostContext.set(MainContext.MainThreadNotebookEditors, this._mainThreadEditors);\n\n\t\tthis._notebookService.onWillAddNotebookDocument(() => this._updateState(), this, this._disposables);\n\t\tthis._notebookService.onDidRemoveNotebookDocument(() => this._updateState(), this, this._disposables);\n\t\tthis._editorService.onDidActiveEditorChange(() => this._updateState(), this, this._disposables);\n\t\tthis._editorService.onDidVisibleEditorsChange(() => this._updateState(), this, this._disposables);\n\t\tthis._notebookEditorService.onDidAddNotebookEditor(this._handleEditorAdd, this, this._disposables);\n\t\tthis._notebookEditorService.onDidRemoveNotebookEditor(this._handleEditorRemove, this, this._disposables);\n\t\tthis._updateState();\n\t}\n\n\tdispose() {\n\t\tthis._mainThreadNotebooks.dispose();\n\t\tthis._mainThreadEditors.dispose();\n\t\tthis._disposables.dispose();\n\t\tthis._editorListeners.dispose();\n\t}\n\n\tprivate _handleEditorAdd(editor: INotebookEditor): void {\n\t\tthis._editorListeners.set(editor.getId(), combinedDisposable(\n\t\t\teditor.onDidChangeModel(() => this._updateState()),\n\t\t\teditor.onDidFocusWidget(() => this._updateState(editor)),\n\t\t));\n\t\tthis._updateState();\n\t}\n\n\tprivate _handleEditorRemove(editor: INotebookEditor): void {\n\t\tthis._editorListeners.deleteAndDispose(editor.getId());\n\t\tthis._updateState();\n\t}\n\n\tprivate _updateState(focusedEditor?: INotebookEditor): void {\n\n\t\tconst editors = new Map<string, IActiveNotebookEditor>();\n\t\tconst visibleEditorsMap = new Map<string, IActiveNotebookEditor>();\n\n\t\tfor (const editor of this._notebookEditorService.listNotebookEditors()) {\n\t\t\tif (editor.hasModel()) {\n\t\t\t\teditors.set(editor.getId(), editor);\n\t\t\t}\n\t\t}\n\n\t\tconst activeNotebookEditor = getNotebookEditorFromEditorPane(this._editorService.activeEditorPane);\n\t\tlet activeEditor: string | null = null;\n\t\tif (activeNotebookEditor) {\n\t\t\tactiveEditor = activeNotebookEditor.getId();\n\t\t} else if (focusedEditor?.textModel) {\n\t\t\tactiveEditor = focusedEditor.getId();\n\t\t}\n\t\tif (activeEditor && !editors.has(activeEditor)) {\n\t\t\tthis._logService.trace('MainThreadNotebooksAndEditors#_updateState: active editor is not in editors list', activeEditor, editors.keys());\n\t\t\tactiveEditor = null;\n\t\t}\n\n\t\tfor (const editorPane of this._editorService.visibleEditorPanes) {\n\t\t\tconst notebookEditor = getNotebookEditorFromEditorPane(editorPane);\n\t\t\tif (notebookEditor?.hasModel() && editors.has(notebookEditor.getId())) {\n\t\t\t\tvisibleEditorsMap.set(notebookEditor.getId(), notebookEditor);\n\t\t\t}\n\t\t}\n\n\t\tconst newState = new NotebookAndEditorState(new Set(this._notebookService.listNotebookDocuments()), editors, activeEditor, visibleEditorsMap);\n\t\tthis._onDelta(NotebookAndEditorState.delta(this._currentState, newState));\n\t\tthis._currentState = newState;\n\t}\n\n\tprivate _onDelta(delta: INotebookAndEditorDelta): void {\n\t\tif (MainThreadNotebooksAndEditors._isDeltaEmpty(delta)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst dto: INotebookDocumentsAndEditorsDelta = {\n\t\t\tremovedDocuments: delta.removedDocuments,\n\t\t\tremovedEditors: delta.removedEditors,\n\t\t\tnewActiveEditor: delta.newActiveEditor,\n\t\t\tvisibleEditors: delta.visibleEditors,\n\t\t\taddedDocuments: delta.addedDocuments.map(MainThreadNotebooksAndEditors._asModelAddData),\n\t\t\taddedEditors: delta.addedEditors.map(this._asEditorAddData, this),\n\t\t};\n\n\t\t// send to extension FIRST\n\t\tthis._proxy.$acceptDocumentAndEditorsDelta(new SerializableObjectWithBuffers(dto));\n\n\t\t// handle internally\n\t\tthis._mainThreadEditors.handleEditorsRemoved(delta.removedEditors);\n\t\tthis._mainThreadNotebooks.handleNotebooksRemoved(delta.removedDocuments);\n\t\tthis._mainThreadNotebooks.handleNotebooksAdded(delta.addedDocuments);\n\t\tthis._mainThreadEditors.handleEditorsAdded(delta.addedEditors);\n\t}\n\n\tprivate static _isDeltaEmpty(delta: INotebookAndEditorDelta): boolean {\n\t\tif (delta.addedDocuments !== undefined && delta.addedDocuments.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.removedDocuments !== undefined && delta.removedDocuments.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.addedEditors !== undefined && delta.addedEditors.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.removedEditors !== undefined && delta.removedEditors.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.visibleEditors !== undefined && delta.visibleEditors.length > 0) {\n\t\t\treturn false;\n\t\t}\n\t\tif (delta.newActiveEditor !== undefined) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tprivate static _asModelAddData(e: NotebookTextModel): INotebookModelAddedData {\n\t\treturn {\n\t\t\tviewType: e.viewType,\n\t\t\turi: e.uri,\n\t\t\tmetadata: e.metadata,\n\t\t\tversionId: e.versionId,\n\t\t\tcells: e.cells.map(NotebookDto.toNotebookCellDto)\n\t\t};\n\t}\n\n\tprivate _asEditorAddData(add: IActiveNotebookEditor): INotebookEditorAddData {\n\n\t\tconst pane = this._editorService.visibleEditorPanes.find(pane => getNotebookEditorFromEditorPane(pane) === add);\n\n\t\treturn {\n\t\t\tid: add.getId(),\n\t\t\tdocumentUri: add.textModel.uri,\n\t\t\tselections: add.getSelections(),\n\t\t\tvisibleRanges: add.visibleRanges,\n\t\t\tviewColumn: pane && editorGroupToColumn(this._editorGroupService, pane.group),\n\t\t\tviewType: add.getViewModel().viewType\n\t\t};\n\t}\n}\n"]}