{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/browser/mainThreadChatAgents2.ts","vs/workbench/api/browser/mainThreadChatAgents2.ts"],"names":[],"mappings":"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","file":"mainThreadChatAgents2.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DeferredPromise } from '../../../base/common/async.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { IMarkdownString } from '../../../base/common/htmlContent.js';\nimport { Disposable, DisposableMap, IDisposable } from '../../../base/common/lifecycle.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { escapeRegExpCharacters } from '../../../base/common/strings.js';\nimport { ThemeIcon } from '../../../base/common/themables.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { Position } from '../../../editor/common/core/position.js';\nimport { Range } from '../../../editor/common/core/range.js';\nimport { getWordAtText } from '../../../editor/common/core/wordHelper.js';\nimport { CompletionContext, CompletionItem, CompletionItemKind, CompletionList } from '../../../editor/common/languages.js';\nimport { ITextModel } from '../../../editor/common/model.js';\nimport { ILanguageFeaturesService } from '../../../editor/common/services/languageFeatures.js';\nimport { ExtensionIdentifier } from '../../../platform/extensions/common/extensions.js';\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { IUriIdentityService } from '../../../platform/uriIdentity/common/uriIdentity.js';\nimport { IChatWidgetService } from '../../contrib/chat/browser/chat.js';\nimport { AddDynamicVariableAction, IAddDynamicVariableContext } from '../../contrib/chat/browser/contrib/chatDynamicVariables.js';\nimport { IChatAgentHistoryEntry, IChatAgentImplementation, IChatAgentRequest, IChatAgentService } from '../../contrib/chat/common/chatAgents.js';\nimport { IChatEditingService, IChatRelatedFileProviderMetadata } from '../../contrib/chat/common/chatEditingService.js';\nimport { IChatModel } from '../../contrib/chat/common/chatModel.js';\nimport { ChatRequestAgentPart } from '../../contrib/chat/common/chatParserTypes.js';\nimport { ChatRequestParser } from '../../contrib/chat/common/chatRequestParser.js';\nimport { IChatContentInlineReference, IChatContentReference, IChatFollowup, IChatNotebookEdit, IChatProgress, IChatService, IChatTask, IChatTaskSerialized, IChatWarningMessage } from '../../contrib/chat/common/chatService.js';\nimport { IChatSessionsService } from '../../contrib/chat/common/chatSessionsService.js';\nimport { LocalChatSessionUri } from '../../contrib/chat/common/chatUri.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../contrib/chat/common/constants.js';\nimport { IExtHostContext, extHostNamedCustomer } from '../../services/extensions/common/extHostCustomers.js';\nimport { IExtensionService } from '../../services/extensions/common/extensions.js';\nimport { Dto } from '../../services/extensions/common/proxyIdentifier.js';\nimport { ExtHostChatAgentsShape2, ExtHostContext, IChatNotebookEditDto, IChatParticipantMetadata, IChatProgressDto, IDynamicChatAgentProps, IExtensionChatAgentMetadata, MainContext, MainThreadChatAgentsShape2 } from '../common/extHost.protocol.js';\nimport { NotebookDto } from './mainThreadNotebookDto.js';\n\ninterface AgentData {\n\tdispose: () => void;\n\tid: string;\n\textensionId: ExtensionIdentifier;\n\thasFollowups?: boolean;\n}\n\nexport class MainThreadChatTask implements IChatTask {\n\tpublic readonly kind = 'progressTask';\n\n\tpublic readonly deferred = new DeferredPromise<string | void>();\n\n\tprivate readonly _onDidAddProgress = new Emitter<IChatWarningMessage | IChatContentReference>();\n\tpublic get onDidAddProgress(): Event<IChatWarningMessage | IChatContentReference> { return this._onDidAddProgress.event; }\n\n\tpublic readonly progress: (IChatWarningMessage | IChatContentReference)[] = [];\n\n\tconstructor(public content: IMarkdownString) { }\n\n\ttask() {\n\t\treturn this.deferred.p;\n\t}\n\n\tisSettled() {\n\t\treturn this.deferred.isSettled;\n\t}\n\n\tcomplete(v: string | void) {\n\t\tthis.deferred.complete(v);\n\t}\n\n\tadd(progress: IChatWarningMessage | IChatContentReference): void {\n\t\tthis.progress.push(progress);\n\t\tthis._onDidAddProgress.fire(progress);\n\t}\n\n\ttoJSON(): IChatTaskSerialized {\n\t\treturn {\n\t\t\tkind: 'progressTaskSerialized',\n\t\t\tcontent: this.content,\n\t\t\tprogress: this.progress\n\t\t};\n\t}\n}\n\n@extHostNamedCustomer(MainContext.MainThreadChatAgents2)\nexport class MainThreadChatAgents2 extends Disposable implements MainThreadChatAgentsShape2 {\n\n\tprivate readonly _agents = this._register(new DisposableMap<number, AgentData>());\n\tprivate readonly _agentCompletionProviders = this._register(new DisposableMap<number, IDisposable>());\n\tprivate readonly _agentIdsToCompletionProviders = this._register(new DisposableMap<string, IDisposable>);\n\n\tprivate readonly _chatParticipantDetectionProviders = this._register(new DisposableMap<number, IDisposable>());\n\n\tprivate readonly _chatRelatedFilesProviders = this._register(new DisposableMap<number, IDisposable>());\n\n\tprivate readonly _pendingProgress = new Map<string, { progress: (parts: IChatProgress[]) => void; chatSession: IChatModel | undefined }>();\n\tprivate readonly _proxy: ExtHostChatAgentsShape2;\n\n\tprivate readonly _activeTasks = new Map<string, IChatTask>();\n\n\tprivate readonly _unresolvedAnchors = new Map</* requestId */string, Map</* id */ string, IChatContentInlineReference>>();\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@IChatAgentService private readonly _chatAgentService: IChatAgentService,\n\t\t@IChatSessionsService private readonly _chatSessionService: IChatSessionsService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t\t@IChatEditingService private readonly _chatEditingService: IChatEditingService,\n\t\t@ILanguageFeaturesService private readonly _languageFeaturesService: ILanguageFeaturesService,\n\t\t@IChatWidgetService private readonly _chatWidgetService: IChatWidgetService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@IUriIdentityService private readonly _uriIdentityService: IUriIdentityService,\n\t) {\n\t\tsuper();\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostChatAgents2);\n\n\t\tthis._register(this._chatService.onDidDisposeSession(e => {\n\t\t\tconst localSessionId = LocalChatSessionUri.parseLocalSessionId(e.sessionResource);\n\t\t\tif (localSessionId) {\n\t\t\t\tthis._proxy.$releaseSession(localSessionId);\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._chatService.onDidPerformUserAction(e => {\n\t\t\tif (typeof e.agentId === 'string') {\n\t\t\t\tfor (const [handle, agent] of this._agents) {\n\t\t\t\t\tif (agent.id === e.agentId) {\n\t\t\t\t\t\tif (e.action.kind === 'vote') {\n\t\t\t\t\t\t\tthis._proxy.$acceptFeedback(handle, e.result ?? {}, e.action);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis._proxy.$acceptAction(handle, e.result || {}, e);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\t$unregisterAgent(handle: number): void {\n\t\tthis._agents.deleteAndDispose(handle);\n\t}\n\n\t$transferActiveChatSession(toWorkspace: UriComponents): void {\n\t\tconst widget = this._chatWidgetService.lastFocusedWidget;\n\t\tconst model = widget?.viewModel?.model;\n\t\tif (!model) {\n\t\t\tthis._logService.error(`MainThreadChat#$transferActiveChatSession: No active chat session found`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst location = widget.location;\n\t\tthis._chatService.transferChatSession({ sessionId: model.sessionId, inputState: model.inputModel.state.get(), location }, URI.revive(toWorkspace));\n\t}\n\n\tasync $registerAgent(handle: number, extension: ExtensionIdentifier, id: string, metadata: IExtensionChatAgentMetadata, dynamicProps: IDynamicChatAgentProps | undefined): Promise<void> {\n\t\tawait this._extensionService.whenInstalledExtensionsRegistered();\n\t\tconst staticAgentRegistration = this._chatAgentService.getAgent(id, true);\n\t\tconst chatSessionRegistration = this._chatSessionService.getAllChatSessionContributions().find(c => c.type === id || c.alternativeIds?.includes(id));\n\t\tif (!staticAgentRegistration && !chatSessionRegistration && !dynamicProps) {\n\t\t\tif (this._chatAgentService.getAgentsByName(id).length) {\n\t\t\t\t// Likely some extension authors will not adopt the new ID, so give a hint if they register a\n\t\t\t\t// participant by name instead of ID.\n\t\t\t\tthrow new Error(`chatParticipant must be declared with an ID in package.json. The \"id\" property may be missing! \"${id}\"`);\n\t\t\t}\n\n\t\t\tthrow new Error(`chatParticipant must be declared in package.json: ${id}`);\n\t\t}\n\n\t\tconst impl: IChatAgentImplementation = {\n\t\t\tinvoke: async (request, progress, history, token) => {\n\t\t\t\tconst chatSession = this._chatService.getSession(request.sessionResource);\n\t\t\t\tthis._pendingProgress.set(request.requestId, { progress, chatSession });\n\t\t\t\ttry {\n\t\t\t\t\treturn await this._proxy.$invokeAgent(handle, request, {\n\t\t\t\t\t\thistory,\n\t\t\t\t\t\tchatSessionContext: chatSession?.contributedChatSession\n\t\t\t\t\t}, token) ?? {};\n\t\t\t\t} finally {\n\t\t\t\t\tthis._pendingProgress.delete(request.requestId);\n\t\t\t\t}\n\t\t\t},\n\t\t\tsetRequestTools: (requestId, tools) => {\n\t\t\t\tthis._proxy.$setRequestTools(requestId, tools);\n\t\t\t},\n\t\t\tprovideFollowups: async (request, result, history, token): Promise<IChatFollowup[]> => {\n\t\t\t\tif (!this._agents.get(handle)?.hasFollowups) {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\n\t\t\t\treturn this._proxy.$provideFollowups(request, handle, result, { history }, token);\n\t\t\t},\n\t\t\tprovideChatTitle: (history, token) => {\n\t\t\t\treturn this._proxy.$provideChatTitle(handle, history, token);\n\t\t\t},\n\t\t\tprovideChatSummary: (history, token) => {\n\t\t\t\treturn this._proxy.$provideChatSummary(handle, history, token);\n\t\t\t},\n\t\t};\n\n\t\tlet disposable: IDisposable;\n\t\tif (!staticAgentRegistration && dynamicProps) {\n\t\t\tconst extensionDescription = this._extensionService.extensions.find(e => ExtensionIdentifier.equals(e.identifier, extension));\n\t\t\tdisposable = this._chatAgentService.registerDynamicAgent(\n\t\t\t\t{\n\t\t\t\t\tid,\n\t\t\t\t\tname: dynamicProps.name,\n\t\t\t\t\tdescription: dynamicProps.description,\n\t\t\t\t\textensionId: extension,\n\t\t\t\t\textensionVersion: extensionDescription?.version,\n\t\t\t\t\textensionDisplayName: extensionDescription?.displayName ?? extension.value,\n\t\t\t\t\textensionPublisherId: extensionDescription?.publisher ?? '',\n\t\t\t\t\tpublisherDisplayName: dynamicProps.publisherName,\n\t\t\t\t\tfullName: dynamicProps.fullName,\n\t\t\t\t\tmetadata: revive(metadata),\n\t\t\t\t\tslashCommands: [],\n\t\t\t\t\tdisambiguation: [],\n\t\t\t\t\tlocations: [ChatAgentLocation.Chat],\n\t\t\t\t\tmodes: [ChatModeKind.Ask, ChatModeKind.Agent, ChatModeKind.Edit],\n\t\t\t\t},\n\t\t\t\timpl);\n\t\t} else {\n\t\t\tdisposable = this._chatAgentService.registerAgentImplementation(id, impl);\n\t\t}\n\n\t\tthis._agents.set(handle, {\n\t\t\tid: id,\n\t\t\textensionId: extension,\n\t\t\tdispose: () => disposable.dispose(),\n\t\t\thasFollowups: metadata.hasFollowups\n\t\t});\n\t}\n\n\tasync $updateAgent(handle: number, metadataUpdate: IExtensionChatAgentMetadata): Promise<void> {\n\t\tawait this._extensionService.whenInstalledExtensionsRegistered();\n\t\tconst data = this._agents.get(handle);\n\t\tif (!data) {\n\t\t\tthis._logService.error(`MainThreadChatAgents2#$updateAgent: No agent with handle ${handle} registered`);\n\t\t\treturn;\n\t\t}\n\t\tdata.hasFollowups = metadataUpdate.hasFollowups;\n\t\tthis._chatAgentService.updateAgent(data.id, revive(metadataUpdate));\n\t}\n\n\tasync $handleProgressChunk(requestId: string, chunks: (IChatProgressDto | [IChatProgressDto, number])[]): Promise<void> {\n\t\tconst pendingProgress = this._pendingProgress.get(requestId);\n\t\tif (!pendingProgress) {\n\t\t\tthis._logService.warn(`MainThreadChatAgents2#$handleProgressChunk: No pending progress for requestId ${requestId}`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst { progress, chatSession } = pendingProgress;\n\t\tconst chatProgressParts: IChatProgress[] = [];\n\n\t\tfor (const item of chunks) {\n\t\t\tconst [progress, responsePartHandle] = Array.isArray(item) ? item : [item];\n\n\t\t\tif (progress.kind === 'externalEdits') {\n\t\t\t\t// todo@connor4312: be more specific here, pass response model through to invocation?\n\t\t\t\tconst response = chatSession?.getRequests().at(-1)?.response;\n\t\t\t\tif (chatSession?.editingSession && responsePartHandle !== undefined && response) {\n\t\t\t\t\tconst parts = progress.start\n\t\t\t\t\t\t? await chatSession.editingSession.startExternalEdits(response, responsePartHandle, revive(progress.resources))\n\t\t\t\t\t\t: await chatSession.editingSession.stopExternalEdits(response, responsePartHandle);\n\t\t\t\t\tchatProgressParts.push(...parts);\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst revivedProgress = progress.kind === 'notebookEdit'\n\t\t\t\t? ChatNotebookEdit.fromChatEdit(progress)\n\t\t\t\t: revive(progress) as IChatProgress;\n\n\t\t\tif (revivedProgress.kind === 'notebookEdit'\n\t\t\t\t|| revivedProgress.kind === 'textEdit'\n\t\t\t\t|| revivedProgress.kind === 'codeblockUri'\n\t\t\t) {\n\t\t\t\t// make sure to use the canonical uri\n\t\t\t\trevivedProgress.uri = this._uriIdentityService.asCanonicalUri(revivedProgress.uri);\n\t\t\t}\n\n\t\t\tif (responsePartHandle !== undefined) {\n\n\t\t\t\tif (revivedProgress.kind === 'progressTask') {\n\t\t\t\t\tconst handle = responsePartHandle;\n\t\t\t\t\tconst responsePartId = `${requestId}_${handle}`;\n\t\t\t\t\tconst task = new MainThreadChatTask(revivedProgress.content);\n\t\t\t\t\tthis._activeTasks.set(responsePartId, task);\n\t\t\t\t\tchatProgressParts.push(task);\n\t\t\t\t} else if (responsePartHandle !== undefined) {\n\t\t\t\t\tconst responsePartId = `${requestId}_${responsePartHandle}`;\n\t\t\t\t\tconst task = this._activeTasks.get(responsePartId);\n\t\t\t\t\tswitch (revivedProgress.kind) {\n\t\t\t\t\t\tcase 'progressTaskResult':\n\t\t\t\t\t\t\tif (task && revivedProgress.content) {\n\t\t\t\t\t\t\t\ttask.complete(revivedProgress.content.value);\n\t\t\t\t\t\t\t\tthis._activeTasks.delete(responsePartId);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\ttask?.complete(undefined);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'warning':\n\t\t\t\t\t\tcase 'reference':\n\t\t\t\t\t\t\ttask?.add(revivedProgress);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (revivedProgress.kind === 'inlineReference' && revivedProgress.resolveId) {\n\t\t\t\tif (!this._unresolvedAnchors.has(requestId)) {\n\t\t\t\t\tthis._unresolvedAnchors.set(requestId, new Map());\n\t\t\t\t}\n\t\t\t\tthis._unresolvedAnchors.get(requestId)?.set(revivedProgress.resolveId, revivedProgress);\n\t\t\t}\n\n\t\t\tchatProgressParts.push(revivedProgress);\n\t\t}\n\n\t\tprogress(chatProgressParts);\n\t}\n\n\t$handleAnchorResolve(requestId: string, handle: string, resolveAnchor: Dto<IChatContentInlineReference> | undefined): void {\n\t\tconst anchor = this._unresolvedAnchors.get(requestId)?.get(handle);\n\t\tif (!anchor) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._unresolvedAnchors.get(requestId)?.delete(handle);\n\t\tif (resolveAnchor) {\n\t\t\tconst revivedAnchor = revive(resolveAnchor) as IChatContentInlineReference;\n\t\t\tanchor.inlineReference = revivedAnchor.inlineReference;\n\t\t}\n\t}\n\n\t$registerAgentCompletionsProvider(handle: number, id: string, triggerCharacters: string[]): void {\n\t\tconst provide = async (query: string, token: CancellationToken) => {\n\t\t\tconst completions = await this._proxy.$invokeCompletionProvider(handle, query, token);\n\t\t\treturn completions.map((c) => ({ ...c, icon: c.icon ? ThemeIcon.fromId(c.icon) : undefined }));\n\t\t};\n\t\tthis._agentIdsToCompletionProviders.set(id, this._chatAgentService.registerAgentCompletionProvider(id, provide));\n\n\t\tthis._agentCompletionProviders.set(handle, this._languageFeaturesService.completionProvider.register({ scheme: Schemas.vscodeChatInput, hasAccessToAllModels: true }, {\n\t\t\t_debugDisplayName: 'chatAgentCompletions:' + handle,\n\t\t\ttriggerCharacters,\n\t\t\tprovideCompletionItems: async (model: ITextModel, position: Position, _context: CompletionContext, token: CancellationToken) => {\n\t\t\t\tconst widget = this._chatWidgetService.getWidgetByInputUri(model.uri);\n\t\t\t\tif (!widget || !widget.viewModel) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst triggerCharsPart = triggerCharacters.map(c => escapeRegExpCharacters(c)).join('');\n\t\t\t\tconst wordRegex = new RegExp(`[${triggerCharsPart}]\\\\S*`, 'g');\n\t\t\t\tconst query = getWordAtText(position.column, wordRegex, model.getLineContent(position.lineNumber), 0)?.word ?? '';\n\n\t\t\t\tif (query && !triggerCharacters.some(c => query.startsWith(c))) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst parsedRequest = this._instantiationService.createInstance(ChatRequestParser).parseChatRequest(widget.viewModel.sessionResource, model.getValue()).parts;\n\t\t\t\tconst agentPart = parsedRequest.find((part): part is ChatRequestAgentPart => part instanceof ChatRequestAgentPart);\n\t\t\t\tconst thisAgentId = this._agents.get(handle)?.id;\n\t\t\t\tif (agentPart?.agent.id !== thisAgentId) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst range = computeCompletionRanges(model, position, wordRegex);\n\t\t\t\tif (!range) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst result = await provide(query, token);\n\t\t\t\tconst variableItems = result.map(v => {\n\t\t\t\t\tconst insertText = v.insertText ?? (typeof v.label === 'string' ? v.label : v.label.label);\n\t\t\t\t\tconst rangeAfterInsert = new Range(range.insert.startLineNumber, range.insert.startColumn, range.insert.endLineNumber, range.insert.startColumn + insertText.length);\n\t\t\t\t\treturn {\n\t\t\t\t\t\tlabel: v.label,\n\t\t\t\t\t\trange,\n\t\t\t\t\t\tinsertText: insertText + ' ',\n\t\t\t\t\t\tkind: CompletionItemKind.Text,\n\t\t\t\t\t\tdetail: v.detail,\n\t\t\t\t\t\tdocumentation: v.documentation,\n\t\t\t\t\t\tcommand: { id: AddDynamicVariableAction.ID, title: '', arguments: [{ id: v.id, widget, range: rangeAfterInsert, variableData: revive(v.value), command: v.command } satisfies IAddDynamicVariableContext] }\n\t\t\t\t\t} satisfies CompletionItem;\n\t\t\t\t});\n\n\t\t\t\treturn {\n\t\t\t\t\tsuggestions: variableItems\n\t\t\t\t} satisfies CompletionList;\n\t\t\t}\n\t\t}));\n\t}\n\n\t$unregisterAgentCompletionsProvider(handle: number, id: string): void {\n\t\tthis._agentCompletionProviders.deleteAndDispose(handle);\n\t\tthis._agentIdsToCompletionProviders.deleteAndDispose(id);\n\t}\n\n\t$registerChatParticipantDetectionProvider(handle: number): void {\n\t\tthis._chatParticipantDetectionProviders.set(handle, this._chatAgentService.registerChatParticipantDetectionProvider(handle,\n\t\t\t{\n\t\t\t\tprovideParticipantDetection: async (request: IChatAgentRequest, history: IChatAgentHistoryEntry[], options: { location: ChatAgentLocation; participants: IChatParticipantMetadata[] }, token: CancellationToken) => {\n\t\t\t\t\treturn await this._proxy.$detectChatParticipant(handle, request, { history }, options, token);\n\t\t\t\t}\n\t\t\t}\n\t\t));\n\t}\n\n\t$unregisterChatParticipantDetectionProvider(handle: number): void {\n\t\tthis._chatParticipantDetectionProviders.deleteAndDispose(handle);\n\t}\n\n\t$registerRelatedFilesProvider(handle: number, metadata: IChatRelatedFileProviderMetadata): void {\n\t\tthis._chatRelatedFilesProviders.set(handle, this._chatEditingService.registerRelatedFilesProvider(handle, {\n\t\t\tdescription: metadata.description,\n\t\t\tprovideRelatedFiles: async (request, token) => {\n\t\t\t\treturn (await this._proxy.$provideRelatedFiles(handle, request, token))?.map((v) => ({ uri: URI.from(v.uri), description: v.description })) ?? [];\n\t\t\t}\n\t\t}));\n\t}\n\n\t$unregisterRelatedFilesProvider(handle: number): void {\n\t\tthis._chatRelatedFilesProviders.deleteAndDispose(handle);\n\t}\n}\n\n\nfunction computeCompletionRanges(model: ITextModel, position: Position, reg: RegExp): { insert: Range; replace: Range } | undefined {\n\tconst varWord = getWordAtText(position.column, reg, model.getLineContent(position.lineNumber), 0);\n\tif (!varWord && model.getWordUntilPosition(position).word) {\n\t\t// inside a \"normal\" word\n\t\treturn;\n\t}\n\n\tlet insert: Range;\n\tlet replace: Range;\n\tif (!varWord) {\n\t\tinsert = replace = Range.fromPositions(position);\n\t} else {\n\t\tinsert = new Range(position.lineNumber, varWord.startColumn, position.lineNumber, position.column);\n\t\treplace = new Range(position.lineNumber, varWord.startColumn, position.lineNumber, varWord.endColumn);\n\t}\n\n\treturn { insert, replace };\n}\n\nnamespace ChatNotebookEdit {\n\texport function fromChatEdit(part: IChatNotebookEditDto): IChatNotebookEdit {\n\t\treturn {\n\t\t\tkind: 'notebookEdit',\n\t\t\turi: URI.revive(part.uri),\n\t\t\tdone: part.done,\n\t\t\tedits: part.edits.map(NotebookDto.fromCellEditOperationDto)\n\t\t};\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DeferredPromise } from '../../../base/common/async.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { IMarkdownString } from '../../../base/common/htmlContent.js';\nimport { Disposable, DisposableMap, IDisposable } from '../../../base/common/lifecycle.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { escapeRegExpCharacters } from '../../../base/common/strings.js';\nimport { ThemeIcon } from '../../../base/common/themables.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { Position } from '../../../editor/common/core/position.js';\nimport { Range } from '../../../editor/common/core/range.js';\nimport { getWordAtText } from '../../../editor/common/core/wordHelper.js';\nimport { CompletionContext, CompletionItem, CompletionItemKind, CompletionList } from '../../../editor/common/languages.js';\nimport { ITextModel } from '../../../editor/common/model.js';\nimport { ILanguageFeaturesService } from '../../../editor/common/services/languageFeatures.js';\nimport { ExtensionIdentifier } from '../../../platform/extensions/common/extensions.js';\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { IUriIdentityService } from '../../../platform/uriIdentity/common/uriIdentity.js';\nimport { IChatWidgetService } from '../../contrib/chat/browser/chat.js';\nimport { AddDynamicVariableAction, IAddDynamicVariableContext } from '../../contrib/chat/browser/contrib/chatDynamicVariables.js';\nimport { IChatAgentHistoryEntry, IChatAgentImplementation, IChatAgentRequest, IChatAgentService } from '../../contrib/chat/common/chatAgents.js';\nimport { IChatEditingService, IChatRelatedFileProviderMetadata } from '../../contrib/chat/common/chatEditingService.js';\nimport { IChatModel } from '../../contrib/chat/common/chatModel.js';\nimport { ChatRequestAgentPart } from '../../contrib/chat/common/chatParserTypes.js';\nimport { ChatRequestParser } from '../../contrib/chat/common/chatRequestParser.js';\nimport { IChatContentInlineReference, IChatContentReference, IChatFollowup, IChatNotebookEdit, IChatProgress, IChatService, IChatTask, IChatTaskSerialized, IChatWarningMessage } from '../../contrib/chat/common/chatService.js';\nimport { IChatSessionsService } from '../../contrib/chat/common/chatSessionsService.js';\nimport { LocalChatSessionUri } from '../../contrib/chat/common/chatUri.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../contrib/chat/common/constants.js';\nimport { IExtHostContext, extHostNamedCustomer } from '../../services/extensions/common/extHostCustomers.js';\nimport { IExtensionService } from '../../services/extensions/common/extensions.js';\nimport { Dto } from '../../services/extensions/common/proxyIdentifier.js';\nimport { ExtHostChatAgentsShape2, ExtHostContext, IChatNotebookEditDto, IChatParticipantMetadata, IChatProgressDto, IDynamicChatAgentProps, IExtensionChatAgentMetadata, MainContext, MainThreadChatAgentsShape2 } from '../common/extHost.protocol.js';\nimport { NotebookDto } from './mainThreadNotebookDto.js';\n\ninterface AgentData {\n\tdispose: () => void;\n\tid: string;\n\textensionId: ExtensionIdentifier;\n\thasFollowups?: boolean;\n}\n\nexport class MainThreadChatTask implements IChatTask {\n\tpublic readonly kind = 'progressTask';\n\n\tpublic readonly deferred = new DeferredPromise<string | void>();\n\n\tprivate readonly _onDidAddProgress = new Emitter<IChatWarningMessage | IChatContentReference>();\n\tpublic get onDidAddProgress(): Event<IChatWarningMessage | IChatContentReference> { return this._onDidAddProgress.event; }\n\n\tpublic readonly progress: (IChatWarningMessage | IChatContentReference)[] = [];\n\n\tconstructor(public content: IMarkdownString) { }\n\n\ttask() {\n\t\treturn this.deferred.p;\n\t}\n\n\tisSettled() {\n\t\treturn this.deferred.isSettled;\n\t}\n\n\tcomplete(v: string | void) {\n\t\tthis.deferred.complete(v);\n\t}\n\n\tadd(progress: IChatWarningMessage | IChatContentReference): void {\n\t\tthis.progress.push(progress);\n\t\tthis._onDidAddProgress.fire(progress);\n\t}\n\n\ttoJSON(): IChatTaskSerialized {\n\t\treturn {\n\t\t\tkind: 'progressTaskSerialized',\n\t\t\tcontent: this.content,\n\t\t\tprogress: this.progress\n\t\t};\n\t}\n}\n\n@extHostNamedCustomer(MainContext.MainThreadChatAgents2)\nexport class MainThreadChatAgents2 extends Disposable implements MainThreadChatAgentsShape2 {\n\n\tprivate readonly _agents = this._register(new DisposableMap<number, AgentData>());\n\tprivate readonly _agentCompletionProviders = this._register(new DisposableMap<number, IDisposable>());\n\tprivate readonly _agentIdsToCompletionProviders = this._register(new DisposableMap<string, IDisposable>);\n\n\tprivate readonly _chatParticipantDetectionProviders = this._register(new DisposableMap<number, IDisposable>());\n\n\tprivate readonly _chatRelatedFilesProviders = this._register(new DisposableMap<number, IDisposable>());\n\n\tprivate readonly _pendingProgress = new Map<string, { progress: (parts: IChatProgress[]) => void; chatSession: IChatModel | undefined }>();\n\tprivate readonly _proxy: ExtHostChatAgentsShape2;\n\n\tprivate readonly _activeTasks = new Map<string, IChatTask>();\n\n\tprivate readonly _unresolvedAnchors = new Map</* requestId */string, Map</* id */ string, IChatContentInlineReference>>();\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@IChatAgentService private readonly _chatAgentService: IChatAgentService,\n\t\t@IChatSessionsService private readonly _chatSessionService: IChatSessionsService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t\t@IChatEditingService private readonly _chatEditingService: IChatEditingService,\n\t\t@ILanguageFeaturesService private readonly _languageFeaturesService: ILanguageFeaturesService,\n\t\t@IChatWidgetService private readonly _chatWidgetService: IChatWidgetService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@IUriIdentityService private readonly _uriIdentityService: IUriIdentityService,\n\t) {\n\t\tsuper();\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostChatAgents2);\n\n\t\tthis._register(this._chatService.onDidDisposeSession(e => {\n\t\t\tconst localSessionId = LocalChatSessionUri.parseLocalSessionId(e.sessionResource);\n\t\t\tif (localSessionId) {\n\t\t\t\tthis._proxy.$releaseSession(localSessionId);\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._chatService.onDidPerformUserAction(e => {\n\t\t\tif (typeof e.agentId === 'string') {\n\t\t\t\tfor (const [handle, agent] of this._agents) {\n\t\t\t\t\tif (agent.id === e.agentId) {\n\t\t\t\t\t\tif (e.action.kind === 'vote') {\n\t\t\t\t\t\t\tthis._proxy.$acceptFeedback(handle, e.result ?? {}, e.action);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis._proxy.$acceptAction(handle, e.result || {}, e);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\t$unregisterAgent(handle: number): void {\n\t\tthis._agents.deleteAndDispose(handle);\n\t}\n\n\t$transferActiveChatSession(toWorkspace: UriComponents): void {\n\t\tconst widget = this._chatWidgetService.lastFocusedWidget;\n\t\tconst model = widget?.viewModel?.model;\n\t\tif (!model) {\n\t\t\tthis._logService.error(`MainThreadChat#$transferActiveChatSession: No active chat session found`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst location = widget.location;\n\t\tthis._chatService.transferChatSession({ sessionId: model.sessionId, inputState: model.inputModel.state.get(), location }, URI.revive(toWorkspace));\n\t}\n\n\tasync $registerAgent(handle: number, extension: ExtensionIdentifier, id: string, metadata: IExtensionChatAgentMetadata, dynamicProps: IDynamicChatAgentProps | undefined): Promise<void> {\n\t\tawait this._extensionService.whenInstalledExtensionsRegistered();\n\t\tconst staticAgentRegistration = this._chatAgentService.getAgent(id, true);\n\t\tconst chatSessionRegistration = this._chatSessionService.getAllChatSessionContributions().find(c => c.type === id || c.alternativeIds?.includes(id));\n\t\tif (!staticAgentRegistration && !chatSessionRegistration && !dynamicProps) {\n\t\t\tif (this._chatAgentService.getAgentsByName(id).length) {\n\t\t\t\t// Likely some extension authors will not adopt the new ID, so give a hint if they register a\n\t\t\t\t// participant by name instead of ID.\n\t\t\t\tthrow new Error(`chatParticipant must be declared with an ID in package.json. The \"id\" property may be missing! \"${id}\"`);\n\t\t\t}\n\n\t\t\tthrow new Error(`chatParticipant must be declared in package.json: ${id}`);\n\t\t}\n\n\t\tconst impl: IChatAgentImplementation = {\n\t\t\tinvoke: async (request, progress, history, token) => {\n\t\t\t\tconst chatSession = this._chatService.getSession(request.sessionResource);\n\t\t\t\tthis._pendingProgress.set(request.requestId, { progress, chatSession });\n\t\t\t\ttry {\n\t\t\t\t\treturn await this._proxy.$invokeAgent(handle, request, {\n\t\t\t\t\t\thistory,\n\t\t\t\t\t\tchatSessionContext: chatSession?.contributedChatSession\n\t\t\t\t\t}, token) ?? {};\n\t\t\t\t} finally {\n\t\t\t\t\tthis._pendingProgress.delete(request.requestId);\n\t\t\t\t}\n\t\t\t},\n\t\t\tsetRequestTools: (requestId, tools) => {\n\t\t\t\tthis._proxy.$setRequestTools(requestId, tools);\n\t\t\t},\n\t\t\tprovideFollowups: async (request, result, history, token): Promise<IChatFollowup[]> => {\n\t\t\t\tif (!this._agents.get(handle)?.hasFollowups) {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\n\t\t\t\treturn this._proxy.$provideFollowups(request, handle, result, { history }, token);\n\t\t\t},\n\t\t\tprovideChatTitle: (history, token) => {\n\t\t\t\treturn this._proxy.$provideChatTitle(handle, history, token);\n\t\t\t},\n\t\t\tprovideChatSummary: (history, token) => {\n\t\t\t\treturn this._proxy.$provideChatSummary(handle, history, token);\n\t\t\t},\n\t\t};\n\n\t\tlet disposable: IDisposable;\n\t\tif (!staticAgentRegistration && dynamicProps) {\n\t\t\tconst extensionDescription = this._extensionService.extensions.find(e => ExtensionIdentifier.equals(e.identifier, extension));\n\t\t\tdisposable = this._chatAgentService.registerDynamicAgent(\n\t\t\t\t{\n\t\t\t\t\tid,\n\t\t\t\t\tname: dynamicProps.name,\n\t\t\t\t\tdescription: dynamicProps.description,\n\t\t\t\t\textensionId: extension,\n\t\t\t\t\textensionVersion: extensionDescription?.version,\n\t\t\t\t\textensionDisplayName: extensionDescription?.displayName ?? extension.value,\n\t\t\t\t\textensionPublisherId: extensionDescription?.publisher ?? '',\n\t\t\t\t\tpublisherDisplayName: dynamicProps.publisherName,\n\t\t\t\t\tfullName: dynamicProps.fullName,\n\t\t\t\t\tmetadata: revive(metadata),\n\t\t\t\t\tslashCommands: [],\n\t\t\t\t\tdisambiguation: [],\n\t\t\t\t\tlocations: [ChatAgentLocation.Chat],\n\t\t\t\t\tmodes: [ChatModeKind.Ask, ChatModeKind.Agent, ChatModeKind.Edit],\n\t\t\t\t},\n\t\t\t\timpl);\n\t\t} else {\n\t\t\tdisposable = this._chatAgentService.registerAgentImplementation(id, impl);\n\t\t}\n\n\t\tthis._agents.set(handle, {\n\t\t\tid: id,\n\t\t\textensionId: extension,\n\t\t\tdispose: () => disposable.dispose(),\n\t\t\thasFollowups: metadata.hasFollowups\n\t\t});\n\t}\n\n\tasync $updateAgent(handle: number, metadataUpdate: IExtensionChatAgentMetadata): Promise<void> {\n\t\tawait this._extensionService.whenInstalledExtensionsRegistered();\n\t\tconst data = this._agents.get(handle);\n\t\tif (!data) {\n\t\t\tthis._logService.error(`MainThreadChatAgents2#$updateAgent: No agent with handle ${handle} registered`);\n\t\t\treturn;\n\t\t}\n\t\tdata.hasFollowups = metadataUpdate.hasFollowups;\n\t\tthis._chatAgentService.updateAgent(data.id, revive(metadataUpdate));\n\t}\n\n\tasync $handleProgressChunk(requestId: string, chunks: (IChatProgressDto | [IChatProgressDto, number])[]): Promise<void> {\n\t\tconst pendingProgress = this._pendingProgress.get(requestId);\n\t\tif (!pendingProgress) {\n\t\t\tthis._logService.warn(`MainThreadChatAgents2#$handleProgressChunk: No pending progress for requestId ${requestId}`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst { progress, chatSession } = pendingProgress;\n\t\tconst chatProgressParts: IChatProgress[] = [];\n\n\t\tfor (const item of chunks) {\n\t\t\tconst [progress, responsePartHandle] = Array.isArray(item) ? item : [item];\n\n\t\t\tif (progress.kind === 'externalEdits') {\n\t\t\t\t// todo@connor4312: be more specific here, pass response model through to invocation?\n\t\t\t\tconst response = chatSession?.getRequests().at(-1)?.response;\n\t\t\t\tif (chatSession?.editingSession && responsePartHandle !== undefined && response) {\n\t\t\t\t\tconst parts = progress.start\n\t\t\t\t\t\t? await chatSession.editingSession.startExternalEdits(response, responsePartHandle, revive(progress.resources))\n\t\t\t\t\t\t: await chatSession.editingSession.stopExternalEdits(response, responsePartHandle);\n\t\t\t\t\tchatProgressParts.push(...parts);\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst revivedProgress = progress.kind === 'notebookEdit'\n\t\t\t\t? ChatNotebookEdit.fromChatEdit(progress)\n\t\t\t\t: revive(progress) as IChatProgress;\n\n\t\t\tif (revivedProgress.kind === 'notebookEdit'\n\t\t\t\t|| revivedProgress.kind === 'textEdit'\n\t\t\t\t|| revivedProgress.kind === 'codeblockUri'\n\t\t\t) {\n\t\t\t\t// make sure to use the canonical uri\n\t\t\t\trevivedProgress.uri = this._uriIdentityService.asCanonicalUri(revivedProgress.uri);\n\t\t\t}\n\n\t\t\tif (responsePartHandle !== undefined) {\n\n\t\t\t\tif (revivedProgress.kind === 'progressTask') {\n\t\t\t\t\tconst handle = responsePartHandle;\n\t\t\t\t\tconst responsePartId = `${requestId}_${handle}`;\n\t\t\t\t\tconst task = new MainThreadChatTask(revivedProgress.content);\n\t\t\t\t\tthis._activeTasks.set(responsePartId, task);\n\t\t\t\t\tchatProgressParts.push(task);\n\t\t\t\t} else if (responsePartHandle !== undefined) {\n\t\t\t\t\tconst responsePartId = `${requestId}_${responsePartHandle}`;\n\t\t\t\t\tconst task = this._activeTasks.get(responsePartId);\n\t\t\t\t\tswitch (revivedProgress.kind) {\n\t\t\t\t\t\tcase 'progressTaskResult':\n\t\t\t\t\t\t\tif (task && revivedProgress.content) {\n\t\t\t\t\t\t\t\ttask.complete(revivedProgress.content.value);\n\t\t\t\t\t\t\t\tthis._activeTasks.delete(responsePartId);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\ttask?.complete(undefined);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'warning':\n\t\t\t\t\t\tcase 'reference':\n\t\t\t\t\t\t\ttask?.add(revivedProgress);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (revivedProgress.kind === 'inlineReference' && revivedProgress.resolveId) {\n\t\t\t\tif (!this._unresolvedAnchors.has(requestId)) {\n\t\t\t\t\tthis._unresolvedAnchors.set(requestId, new Map());\n\t\t\t\t}\n\t\t\t\tthis._unresolvedAnchors.get(requestId)?.set(revivedProgress.resolveId, revivedProgress);\n\t\t\t}\n\n\t\t\tchatProgressParts.push(revivedProgress);\n\t\t}\n\n\t\tprogress(chatProgressParts);\n\t}\n\n\t$handleAnchorResolve(requestId: string, handle: string, resolveAnchor: Dto<IChatContentInlineReference> | undefined): void {\n\t\tconst anchor = this._unresolvedAnchors.get(requestId)?.get(handle);\n\t\tif (!anchor) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._unresolvedAnchors.get(requestId)?.delete(handle);\n\t\tif (resolveAnchor) {\n\t\t\tconst revivedAnchor = revive(resolveAnchor) as IChatContentInlineReference;\n\t\t\tanchor.inlineReference = revivedAnchor.inlineReference;\n\t\t}\n\t}\n\n\t$registerAgentCompletionsProvider(handle: number, id: string, triggerCharacters: string[]): void {\n\t\tconst provide = async (query: string, token: CancellationToken) => {\n\t\t\tconst completions = await this._proxy.$invokeCompletionProvider(handle, query, token);\n\t\t\treturn completions.map((c) => ({ ...c, icon: c.icon ? ThemeIcon.fromId(c.icon) : undefined }));\n\t\t};\n\t\tthis._agentIdsToCompletionProviders.set(id, this._chatAgentService.registerAgentCompletionProvider(id, provide));\n\n\t\tthis._agentCompletionProviders.set(handle, this._languageFeaturesService.completionProvider.register({ scheme: Schemas.vscodeChatInput, hasAccessToAllModels: true }, {\n\t\t\t_debugDisplayName: 'chatAgentCompletions:' + handle,\n\t\t\ttriggerCharacters,\n\t\t\tprovideCompletionItems: async (model: ITextModel, position: Position, _context: CompletionContext, token: CancellationToken) => {\n\t\t\t\tconst widget = this._chatWidgetService.getWidgetByInputUri(model.uri);\n\t\t\t\tif (!widget || !widget.viewModel) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst triggerCharsPart = triggerCharacters.map(c => escapeRegExpCharacters(c)).join('');\n\t\t\t\tconst wordRegex = new RegExp(`[${triggerCharsPart}]\\\\S*`, 'g');\n\t\t\t\tconst query = getWordAtText(position.column, wordRegex, model.getLineContent(position.lineNumber), 0)?.word ?? '';\n\n\t\t\t\tif (query && !triggerCharacters.some(c => query.startsWith(c))) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst parsedRequest = this._instantiationService.createInstance(ChatRequestParser).parseChatRequest(widget.viewModel.sessionResource, model.getValue()).parts;\n\t\t\t\tconst agentPart = parsedRequest.find((part): part is ChatRequestAgentPart => part instanceof ChatRequestAgentPart);\n\t\t\t\tconst thisAgentId = this._agents.get(handle)?.id;\n\t\t\t\tif (agentPart?.agent.id !== thisAgentId) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst range = computeCompletionRanges(model, position, wordRegex);\n\t\t\t\tif (!range) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst result = await provide(query, token);\n\t\t\t\tconst variableItems = result.map(v => {\n\t\t\t\t\tconst insertText = v.insertText ?? (typeof v.label === 'string' ? v.label : v.label.label);\n\t\t\t\t\tconst rangeAfterInsert = new Range(range.insert.startLineNumber, range.insert.startColumn, range.insert.endLineNumber, range.insert.startColumn + insertText.length);\n\t\t\t\t\treturn {\n\t\t\t\t\t\tlabel: v.label,\n\t\t\t\t\t\trange,\n\t\t\t\t\t\tinsertText: insertText + ' ',\n\t\t\t\t\t\tkind: CompletionItemKind.Text,\n\t\t\t\t\t\tdetail: v.detail,\n\t\t\t\t\t\tdocumentation: v.documentation,\n\t\t\t\t\t\tcommand: { id: AddDynamicVariableAction.ID, title: '', arguments: [{ id: v.id, widget, range: rangeAfterInsert, variableData: revive(v.value), command: v.command } satisfies IAddDynamicVariableContext] }\n\t\t\t\t\t} satisfies CompletionItem;\n\t\t\t\t});\n\n\t\t\t\treturn {\n\t\t\t\t\tsuggestions: variableItems\n\t\t\t\t} satisfies CompletionList;\n\t\t\t}\n\t\t}));\n\t}\n\n\t$unregisterAgentCompletionsProvider(handle: number, id: string): void {\n\t\tthis._agentCompletionProviders.deleteAndDispose(handle);\n\t\tthis._agentIdsToCompletionProviders.deleteAndDispose(id);\n\t}\n\n\t$registerChatParticipantDetectionProvider(handle: number): void {\n\t\tthis._chatParticipantDetectionProviders.set(handle, this._chatAgentService.registerChatParticipantDetectionProvider(handle,\n\t\t\t{\n\t\t\t\tprovideParticipantDetection: async (request: IChatAgentRequest, history: IChatAgentHistoryEntry[], options: { location: ChatAgentLocation; participants: IChatParticipantMetadata[] }, token: CancellationToken) => {\n\t\t\t\t\treturn await this._proxy.$detectChatParticipant(handle, request, { history }, options, token);\n\t\t\t\t}\n\t\t\t}\n\t\t));\n\t}\n\n\t$unregisterChatParticipantDetectionProvider(handle: number): void {\n\t\tthis._chatParticipantDetectionProviders.deleteAndDispose(handle);\n\t}\n\n\t$registerRelatedFilesProvider(handle: number, metadata: IChatRelatedFileProviderMetadata): void {\n\t\tthis._chatRelatedFilesProviders.set(handle, this._chatEditingService.registerRelatedFilesProvider(handle, {\n\t\t\tdescription: metadata.description,\n\t\t\tprovideRelatedFiles: async (request, token) => {\n\t\t\t\treturn (await this._proxy.$provideRelatedFiles(handle, request, token))?.map((v) => ({ uri: URI.from(v.uri), description: v.description })) ?? [];\n\t\t\t}\n\t\t}));\n\t}\n\n\t$unregisterRelatedFilesProvider(handle: number): void {\n\t\tthis._chatRelatedFilesProviders.deleteAndDispose(handle);\n\t}\n}\n\n\nfunction computeCompletionRanges(model: ITextModel, position: Position, reg: RegExp): { insert: Range; replace: Range } | undefined {\n\tconst varWord = getWordAtText(position.column, reg, model.getLineContent(position.lineNumber), 0);\n\tif (!varWord && model.getWordUntilPosition(position).word) {\n\t\t// inside a \"normal\" word\n\t\treturn;\n\t}\n\n\tlet insert: Range;\n\tlet replace: Range;\n\tif (!varWord) {\n\t\tinsert = replace = Range.fromPositions(position);\n\t} else {\n\t\tinsert = new Range(position.lineNumber, varWord.startColumn, position.lineNumber, position.column);\n\t\treplace = new Range(position.lineNumber, varWord.startColumn, position.lineNumber, varWord.endColumn);\n\t}\n\n\treturn { insert, replace };\n}\n\nnamespace ChatNotebookEdit {\n\texport function fromChatEdit(part: IChatNotebookEditDto): IChatNotebookEdit {\n\t\treturn {\n\t\t\tkind: 'notebookEdit',\n\t\t\turi: URI.revive(part.uri),\n\t\t\tdone: part.done,\n\t\t\tedits: part.edits.map(NotebookDto.fromCellEditOperationDto)\n\t\t};\n\t}\n}\n"]}