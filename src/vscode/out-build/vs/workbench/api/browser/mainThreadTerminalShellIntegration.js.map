{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/browser/mainThreadTerminalShellIntegration.ts","vs/workbench/api/browser/mainThreadTerminalShellIntegration.ts"],"names":[],"mappings":"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","file":"mainThreadTerminalShellIntegration.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from '../../../base/common/event.js';\nimport { Disposable, toDisposable, type IDisposable } from '../../../base/common/lifecycle.js';\nimport { TerminalCapability, type ITerminalCommand } from '../../../platform/terminal/common/capabilities/capabilities.js';\nimport { ExtHostContext, MainContext, type ExtHostTerminalShellIntegrationShape, type MainThreadTerminalShellIntegrationShape } from '../common/extHost.protocol.js';\nimport { ITerminalService, type ITerminalInstance } from '../../contrib/terminal/browser/terminal.js';\nimport { IWorkbenchEnvironmentService } from '../../services/environment/common/environmentService.js';\nimport { extHostNamedCustomer, type IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { TerminalShellExecutionCommandLineConfidence } from '../common/extHostTypes.js';\nimport { IExtensionService } from '../../services/extensions/common/extensions.js';\n\n@extHostNamedCustomer(MainContext.MainThreadTerminalShellIntegration)\nexport class MainThreadTerminalShellIntegration extends Disposable implements MainThreadTerminalShellIntegrationShape {\n\tprivate readonly _proxy: ExtHostTerminalShellIntegrationShape;\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@ITerminalService private readonly _terminalService: ITerminalService,\n\t\t@IWorkbenchEnvironmentService workbenchEnvironmentService: IWorkbenchEnvironmentService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService\n\t) {\n\t\tsuper();\n\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostTerminalShellIntegration);\n\n\t\tconst instanceDataListeners: Map<number, IDisposable> = new Map();\n\t\tthis._register(toDisposable(() => {\n\t\t\tfor (const listener of instanceDataListeners.values()) {\n\t\t\t\tlistener.dispose();\n\t\t\t}\n\t\t}));\n\n\t\t// onDidChangeTerminalShellIntegration initial state\n\t\tfor (const terminal of this._terminalService.instances) {\n\t\t\tconst cmdDetection = terminal.capabilities.get(TerminalCapability.CommandDetection);\n\t\t\tif (cmdDetection) {\n\t\t\t\tthis._enableShellIntegration(terminal);\n\t\t\t}\n\t\t}\n\n\t\t// onDidChangeTerminalShellIntegration via command detection\n\t\tconst onDidAddCommandDetection = this._store.add(this._terminalService.createOnInstanceEvent(instance => {\n\t\t\treturn Event.map(\n\t\t\t\tinstance.capabilities.onDidAddCommandDetectionCapability,\n\t\t\t\t() => instance\n\t\t\t);\n\t\t})).event;\n\t\tthis._store.add(onDidAddCommandDetection(e => this._enableShellIntegration(e)));\n\n\t\t// onDidChangeTerminalShellIntegration via cwd\n\t\tconst cwdChangeEvent = this._store.add(this._terminalService.createOnInstanceCapabilityEvent(TerminalCapability.CwdDetection, e => e.onDidChangeCwd));\n\t\tthis._store.add(cwdChangeEvent.event(e => {\n\t\t\tthis._proxy.$cwdChange(e.instance.instanceId, e.data);\n\t\t}));\n\n\t\t// onDidChangeTerminalShellIntegration via env\n\t\tconst envChangeEvent = this._store.add(this._terminalService.createOnInstanceCapabilityEvent(TerminalCapability.ShellEnvDetection, e => e.onDidChangeEnv));\n\t\tthis._store.add(envChangeEvent.event(e => {\n\t\t\tif (e.data.value && typeof e.data.value === 'object') {\n\t\t\t\tconst envValue = e.data.value as { [key: string]: string | undefined };\n\n\t\t\t\t// Extract keys and values\n\t\t\t\tconst keysArr = Object.keys(envValue);\n\t\t\t\tconst valuesArr = Object.values(envValue);\n\t\t\t\tthis._proxy.$shellEnvChange(e.instance.instanceId, keysArr, valuesArr as string[], e.data.isTrusted);\n\t\t\t}\n\t\t}));\n\n\t\t// onDidStartTerminalShellExecution\n\t\tconst commandDetectionStartEvent = this._store.add(this._terminalService.createOnInstanceCapabilityEvent(TerminalCapability.CommandDetection, e => e.onCommandExecuted));\n\t\tlet currentCommand: ITerminalCommand | undefined;\n\t\tthis._store.add(commandDetectionStartEvent.event(e => {\n\t\t\t// Prevent duplicate events from being sent in case command detection double fires the\n\t\t\t// event\n\t\t\tif (e.data === currentCommand) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// String paths are not exposed in the extension API\n\t\t\tcurrentCommand = e.data;\n\t\t\tconst instanceId = e.instance.instanceId;\n\t\t\tthis._proxy.$shellExecutionStart(instanceId, instanceSupportsExecuteCommandApi(e.instance), e.data.command, convertToExtHostCommandLineConfidence(e.data), e.data.isTrusted, e.data.cwd);\n\n\t\t\t// TerminalShellExecution.createDataStream\n\t\t\t// Debounce events to reduce the message count - when this listener is disposed the events will be flushed\n\t\t\tinstanceDataListeners.get(instanceId)?.dispose();\n\t\t\tinstanceDataListeners.set(instanceId, Event.accumulate(e.instance.onData, 50, this._store)(events => {\n\t\t\t\tthis._proxy.$shellExecutionData(instanceId, events.join(''));\n\t\t\t}));\n\t\t}));\n\n\t\t// onDidEndTerminalShellExecution\n\t\tconst commandDetectionEndEvent = this._store.add(this._terminalService.createOnInstanceCapabilityEvent(TerminalCapability.CommandDetection, e => e.onCommandFinished));\n\t\tthis._store.add(commandDetectionEndEvent.event(e => {\n\t\t\tcurrentCommand = undefined;\n\t\t\tconst instanceId = e.instance.instanceId;\n\t\t\tinstanceDataListeners.get(instanceId)?.dispose();\n\t\t\t// Shell integration C (executed) and D (command finished) sequences should always be in\n\t\t\t// their own events, so send this immediately. This means that the D sequence will not\n\t\t\t// be included as it's currently being parsed when the command finished event fires.\n\t\t\tthis._proxy.$shellExecutionEnd(instanceId, e.data.command, convertToExtHostCommandLineConfidence(e.data), e.data.isTrusted, e.data.exitCode);\n\t\t}));\n\n\t\t// Clean up after dispose\n\t\tthis._store.add(this._terminalService.onDidDisposeInstance(e => this._proxy.$closeTerminal(e.instanceId)));\n\t}\n\n\t$executeCommand(terminalId: number, commandLine: string): void {\n\t\tthis._terminalService.getInstanceFromId(terminalId)?.runCommand(commandLine, true);\n\t}\n\n\tprivate _enableShellIntegration(instance: ITerminalInstance): void {\n\t\tthis._extensionService.activateByEvent('onTerminalShellIntegration:*');\n\t\tif (instance.shellType) {\n\t\t\tthis._extensionService.activateByEvent(`onTerminalShellIntegration:${instance.shellType}`);\n\t\t}\n\t\tthis._proxy.$shellIntegrationChange(instance.instanceId, instanceSupportsExecuteCommandApi(instance));\n\t\tconst cwdDetection = instance.capabilities.get(TerminalCapability.CwdDetection);\n\t\tif (cwdDetection) {\n\t\t\tthis._proxy.$cwdChange(instance.instanceId, cwdDetection.getCwd());\n\t\t}\n\t}\n}\n\nfunction convertToExtHostCommandLineConfidence(command: ITerminalCommand): TerminalShellExecutionCommandLineConfidence {\n\tswitch (command.commandLineConfidence) {\n\t\tcase 'high':\n\t\t\treturn TerminalShellExecutionCommandLineConfidence.High;\n\t\tcase 'medium':\n\t\t\treturn TerminalShellExecutionCommandLineConfidence.Medium;\n\t\tcase 'low':\n\t\tdefault:\n\t\t\treturn TerminalShellExecutionCommandLineConfidence.Low;\n\t}\n}\n\nfunction instanceSupportsExecuteCommandApi(instance: ITerminalInstance): boolean {\n\treturn instance.shellLaunchConfig.type !== 'Task';\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from '../../../base/common/event.js';\nimport { Disposable, toDisposable, type IDisposable } from '../../../base/common/lifecycle.js';\nimport { TerminalCapability, type ITerminalCommand } from '../../../platform/terminal/common/capabilities/capabilities.js';\nimport { ExtHostContext, MainContext, type ExtHostTerminalShellIntegrationShape, type MainThreadTerminalShellIntegrationShape } from '../common/extHost.protocol.js';\nimport { ITerminalService, type ITerminalInstance } from '../../contrib/terminal/browser/terminal.js';\nimport { IWorkbenchEnvironmentService } from '../../services/environment/common/environmentService.js';\nimport { extHostNamedCustomer, type IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { TerminalShellExecutionCommandLineConfidence } from '../common/extHostTypes.js';\nimport { IExtensionService } from '../../services/extensions/common/extensions.js';\n\n@extHostNamedCustomer(MainContext.MainThreadTerminalShellIntegration)\nexport class MainThreadTerminalShellIntegration extends Disposable implements MainThreadTerminalShellIntegrationShape {\n\tprivate readonly _proxy: ExtHostTerminalShellIntegrationShape;\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@ITerminalService private readonly _terminalService: ITerminalService,\n\t\t@IWorkbenchEnvironmentService workbenchEnvironmentService: IWorkbenchEnvironmentService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService\n\t) {\n\t\tsuper();\n\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostTerminalShellIntegration);\n\n\t\tconst instanceDataListeners: Map<number, IDisposable> = new Map();\n\t\tthis._register(toDisposable(() => {\n\t\t\tfor (const listener of instanceDataListeners.values()) {\n\t\t\t\tlistener.dispose();\n\t\t\t}\n\t\t}));\n\n\t\t// onDidChangeTerminalShellIntegration initial state\n\t\tfor (const terminal of this._terminalService.instances) {\n\t\t\tconst cmdDetection = terminal.capabilities.get(TerminalCapability.CommandDetection);\n\t\t\tif (cmdDetection) {\n\t\t\t\tthis._enableShellIntegration(terminal);\n\t\t\t}\n\t\t}\n\n\t\t// onDidChangeTerminalShellIntegration via command detection\n\t\tconst onDidAddCommandDetection = this._store.add(this._terminalService.createOnInstanceEvent(instance => {\n\t\t\treturn Event.map(\n\t\t\t\tinstance.capabilities.onDidAddCommandDetectionCapability,\n\t\t\t\t() => instance\n\t\t\t);\n\t\t})).event;\n\t\tthis._store.add(onDidAddCommandDetection(e => this._enableShellIntegration(e)));\n\n\t\t// onDidChangeTerminalShellIntegration via cwd\n\t\tconst cwdChangeEvent = this._store.add(this._terminalService.createOnInstanceCapabilityEvent(TerminalCapability.CwdDetection, e => e.onDidChangeCwd));\n\t\tthis._store.add(cwdChangeEvent.event(e => {\n\t\t\tthis._proxy.$cwdChange(e.instance.instanceId, e.data);\n\t\t}));\n\n\t\t// onDidChangeTerminalShellIntegration via env\n\t\tconst envChangeEvent = this._store.add(this._terminalService.createOnInstanceCapabilityEvent(TerminalCapability.ShellEnvDetection, e => e.onDidChangeEnv));\n\t\tthis._store.add(envChangeEvent.event(e => {\n\t\t\tif (e.data.value && typeof e.data.value === 'object') {\n\t\t\t\tconst envValue = e.data.value as { [key: string]: string | undefined };\n\n\t\t\t\t// Extract keys and values\n\t\t\t\tconst keysArr = Object.keys(envValue);\n\t\t\t\tconst valuesArr = Object.values(envValue);\n\t\t\t\tthis._proxy.$shellEnvChange(e.instance.instanceId, keysArr, valuesArr as string[], e.data.isTrusted);\n\t\t\t}\n\t\t}));\n\n\t\t// onDidStartTerminalShellExecution\n\t\tconst commandDetectionStartEvent = this._store.add(this._terminalService.createOnInstanceCapabilityEvent(TerminalCapability.CommandDetection, e => e.onCommandExecuted));\n\t\tlet currentCommand: ITerminalCommand | undefined;\n\t\tthis._store.add(commandDetectionStartEvent.event(e => {\n\t\t\t// Prevent duplicate events from being sent in case command detection double fires the\n\t\t\t// event\n\t\t\tif (e.data === currentCommand) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// String paths are not exposed in the extension API\n\t\t\tcurrentCommand = e.data;\n\t\t\tconst instanceId = e.instance.instanceId;\n\t\t\tthis._proxy.$shellExecutionStart(instanceId, instanceSupportsExecuteCommandApi(e.instance), e.data.command, convertToExtHostCommandLineConfidence(e.data), e.data.isTrusted, e.data.cwd);\n\n\t\t\t// TerminalShellExecution.createDataStream\n\t\t\t// Debounce events to reduce the message count - when this listener is disposed the events will be flushed\n\t\t\tinstanceDataListeners.get(instanceId)?.dispose();\n\t\t\tinstanceDataListeners.set(instanceId, Event.accumulate(e.instance.onData, 50, this._store)(events => {\n\t\t\t\tthis._proxy.$shellExecutionData(instanceId, events.join(''));\n\t\t\t}));\n\t\t}));\n\n\t\t// onDidEndTerminalShellExecution\n\t\tconst commandDetectionEndEvent = this._store.add(this._terminalService.createOnInstanceCapabilityEvent(TerminalCapability.CommandDetection, e => e.onCommandFinished));\n\t\tthis._store.add(commandDetectionEndEvent.event(e => {\n\t\t\tcurrentCommand = undefined;\n\t\t\tconst instanceId = e.instance.instanceId;\n\t\t\tinstanceDataListeners.get(instanceId)?.dispose();\n\t\t\t// Shell integration C (executed) and D (command finished) sequences should always be in\n\t\t\t// their own events, so send this immediately. This means that the D sequence will not\n\t\t\t// be included as it's currently being parsed when the command finished event fires.\n\t\t\tthis._proxy.$shellExecutionEnd(instanceId, e.data.command, convertToExtHostCommandLineConfidence(e.data), e.data.isTrusted, e.data.exitCode);\n\t\t}));\n\n\t\t// Clean up after dispose\n\t\tthis._store.add(this._terminalService.onDidDisposeInstance(e => this._proxy.$closeTerminal(e.instanceId)));\n\t}\n\n\t$executeCommand(terminalId: number, commandLine: string): void {\n\t\tthis._terminalService.getInstanceFromId(terminalId)?.runCommand(commandLine, true);\n\t}\n\n\tprivate _enableShellIntegration(instance: ITerminalInstance): void {\n\t\tthis._extensionService.activateByEvent('onTerminalShellIntegration:*');\n\t\tif (instance.shellType) {\n\t\t\tthis._extensionService.activateByEvent(`onTerminalShellIntegration:${instance.shellType}`);\n\t\t}\n\t\tthis._proxy.$shellIntegrationChange(instance.instanceId, instanceSupportsExecuteCommandApi(instance));\n\t\tconst cwdDetection = instance.capabilities.get(TerminalCapability.CwdDetection);\n\t\tif (cwdDetection) {\n\t\t\tthis._proxy.$cwdChange(instance.instanceId, cwdDetection.getCwd());\n\t\t}\n\t}\n}\n\nfunction convertToExtHostCommandLineConfidence(command: ITerminalCommand): TerminalShellExecutionCommandLineConfidence {\n\tswitch (command.commandLineConfidence) {\n\t\tcase 'high':\n\t\t\treturn TerminalShellExecutionCommandLineConfidence.High;\n\t\tcase 'medium':\n\t\t\treturn TerminalShellExecutionCommandLineConfidence.Medium;\n\t\tcase 'low':\n\t\tdefault:\n\t\t\treturn TerminalShellExecutionCommandLineConfidence.Low;\n\t}\n}\n\nfunction instanceSupportsExecuteCommandApi(instance: ITerminalInstance): boolean {\n\treturn instance.shellLaunchConfig.type !== 'Task';\n}\n"]}