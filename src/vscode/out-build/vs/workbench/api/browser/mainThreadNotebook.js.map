{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/browser/mainThreadNotebook.ts","vs/workbench/api/browser/mainThreadNotebook.ts"],"names":[],"mappings":"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","file":"mainThreadNotebook.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer } from '../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { DisposableStore, dispose, IDisposable } from '../../../base/common/lifecycle.js';\nimport { StopWatch } from '../../../base/common/stopwatch.js';\nimport { assertType } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { CommandsRegistry } from '../../../platform/commands/common/commands.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { NotebookDto } from './mainThreadNotebookDto.js';\nimport { INotebookCellStatusBarService } from '../../contrib/notebook/common/notebookCellStatusBarService.js';\nimport { INotebookCellStatusBarItemProvider, INotebookContributionData, INotebookExclusiveDocumentFilter, NotebookData, NotebookExtensionDescription, TransientOptions } from '../../contrib/notebook/common/notebookCommon.js';\nimport { INotebookService, SimpleNotebookProviderInfo } from '../../contrib/notebook/common/notebookService.js';\nimport { extHostNamedCustomer, IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\nimport { ExtHostContext, ExtHostNotebookShape, MainContext, MainThreadNotebookShape, NotebookDataDto } from '../common/extHost.protocol.js';\nimport { IRelativePattern } from '../../../base/common/glob.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { INotebookFileMatchNoModel } from '../../contrib/search/common/searchNotebookHelpers.js';\nimport { NotebookPriorityInfo } from '../../contrib/search/common/search.js';\nimport { coalesce } from '../../../base/common/arrays.js';\nimport { FileOperationError } from '../../../platform/files/common/files.js';\n\n@extHostNamedCustomer(MainContext.MainThreadNotebook)\nexport class MainThreadNotebooks implements MainThreadNotebookShape {\n\n\tprivate readonly _disposables = new DisposableStore();\n\n\tprivate readonly _proxy: ExtHostNotebookShape;\n\tprivate readonly _notebookSerializer = new Map<number, IDisposable>();\n\tprivate readonly _notebookCellStatusBarRegistrations = new Map<number, IDisposable>();\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@INotebookCellStatusBarService private readonly _cellStatusBarService: INotebookCellStatusBarService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostNotebook);\n\t}\n\n\tdispose(): void {\n\t\tthis._disposables.dispose();\n\t\tdispose(this._notebookSerializer.values());\n\t}\n\n\t$registerNotebookSerializer(handle: number, extension: NotebookExtensionDescription, viewType: string, options: TransientOptions, data: INotebookContributionData | undefined): void {\n\t\tconst disposables = new DisposableStore();\n\n\t\tdisposables.add(this._notebookService.registerNotebookSerializer(viewType, extension, {\n\t\t\toptions,\n\t\t\tdataToNotebook: async (data: VSBuffer): Promise<NotebookData> => {\n\t\t\t\tconst sw = new StopWatch();\n\t\t\t\tlet result: NotebookData;\n\t\t\t\tif (data.byteLength === 0 && viewType === 'interactive') {\n\t\t\t\t\t// we don't want any starting cells for an empty interactive window.\n\t\t\t\t\tresult = NotebookDto.fromNotebookDataDto({ cells: [], metadata: {} });\n\t\t\t\t} else {\n\t\t\t\t\tconst dto = await this._proxy.$dataToNotebook(handle, data, CancellationToken.None);\n\t\t\t\t\tresult = NotebookDto.fromNotebookDataDto(dto.value);\n\t\t\t\t}\n\t\t\t\tthis._logService.trace(`[NotebookSerializer] dataToNotebook DONE after ${sw.elapsed()}ms`, {\n\t\t\t\t\tviewType,\n\t\t\t\t\textensionId: extension.id.value,\n\t\t\t\t});\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\tnotebookToData: (data: NotebookData): Promise<VSBuffer> => {\n\t\t\t\tconst sw = new StopWatch();\n\t\t\t\tconst result = this._proxy.$notebookToData(handle, new SerializableObjectWithBuffers(NotebookDto.toNotebookDataDto(data)), CancellationToken.None);\n\t\t\t\tthis._logService.trace(`[NotebookSerializer] notebookToData DONE after ${sw.elapsed()}`, {\n\t\t\t\t\tviewType,\n\t\t\t\t\textensionId: extension.id.value,\n\t\t\t\t});\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\tsave: async (uri, versionId, options, token) => {\n\t\t\t\tconst stat = await this._proxy.$saveNotebook(handle, uri, versionId, options, token);\n\t\t\t\tif (isFileOperationError(stat)) {\n\t\t\t\t\tthrow new FileOperationError(stat.message, stat.fileOperationResult, stat.options);\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\t...stat,\n\t\t\t\t\tchildren: undefined,\n\t\t\t\t\tresource: uri\n\t\t\t\t};\n\t\t\t},\n\t\t\tsearchInNotebooks: async (textQuery, token, allPriorityInfo): Promise<{ results: INotebookFileMatchNoModel<URI>[]; limitHit: boolean }> => {\n\t\t\t\tconst contributedType = this._notebookService.getContributedNotebookType(viewType);\n\t\t\t\tif (!contributedType) {\n\t\t\t\t\treturn { results: [], limitHit: false };\n\t\t\t\t}\n\t\t\t\tconst fileNames = contributedType.selectors;\n\n\t\t\t\tconst includes = fileNames.map((selector) => {\n\t\t\t\t\tconst globPattern = (selector as INotebookExclusiveDocumentFilter).include || selector as IRelativePattern | string;\n\t\t\t\t\treturn globPattern.toString();\n\t\t\t\t});\n\n\t\t\t\tif (!includes.length) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresults: [], limitHit: false\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tconst thisPriorityInfo = coalesce<NotebookPriorityInfo>([{ isFromSettings: false, filenamePatterns: includes }, ...allPriorityInfo.get(viewType) ?? []]);\n\t\t\t\tconst otherEditorsPriorityInfo = Array.from(allPriorityInfo.keys())\n\t\t\t\t\t.flatMap(key => {\n\t\t\t\t\t\tif (key !== viewType) {\n\t\t\t\t\t\t\treturn allPriorityInfo.get(key) ?? [];\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t});\n\n\t\t\t\tconst searchComplete = await this._proxy.$searchInNotebooks(handle, textQuery, thisPriorityInfo, otherEditorsPriorityInfo, token);\n\t\t\t\tconst revivedResults: INotebookFileMatchNoModel<URI>[] = searchComplete.results.map(result => {\n\t\t\t\t\tconst resource = URI.revive(result.resource);\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresource,\n\t\t\t\t\t\tcellResults: result.cellResults.map(e => revive(e))\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t\treturn { results: revivedResults, limitHit: searchComplete.limitHit };\n\t\t\t}\n\t\t}));\n\n\t\tif (data) {\n\t\t\tdisposables.add(this._notebookService.registerContributedNotebookType(viewType, data));\n\t\t}\n\t\tthis._notebookSerializer.set(handle, disposables);\n\n\t\tthis._logService.trace('[NotebookSerializer] registered notebook serializer', {\n\t\t\tviewType,\n\t\t\textensionId: extension.id.value,\n\t\t});\n\t}\n\n\t$unregisterNotebookSerializer(handle: number): void {\n\t\tthis._notebookSerializer.get(handle)?.dispose();\n\t\tthis._notebookSerializer.delete(handle);\n\t}\n\n\t$emitCellStatusBarEvent(eventHandle: number): void {\n\t\tconst emitter = this._notebookCellStatusBarRegistrations.get(eventHandle);\n\t\tif (emitter instanceof Emitter) {\n\t\t\temitter.fire(undefined);\n\t\t}\n\t}\n\n\tasync $registerNotebookCellStatusBarItemProvider(handle: number, eventHandle: number | undefined, viewType: string): Promise<void> {\n\t\tconst that = this;\n\t\tconst provider: INotebookCellStatusBarItemProvider = {\n\t\t\tasync provideCellStatusBarItems(uri: URI, index: number, token: CancellationToken) {\n\t\t\t\tconst result = await that._proxy.$provideNotebookCellStatusBarItems(handle, uri, index, token);\n\t\t\t\treturn {\n\t\t\t\t\titems: result?.items ?? [],\n\t\t\t\t\tdispose() {\n\t\t\t\t\t\tif (result) {\n\t\t\t\t\t\t\tthat._proxy.$releaseNotebookCellStatusBarItems(result.cacheId);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t},\n\t\t\tviewType\n\t\t};\n\n\t\tif (typeof eventHandle === 'number') {\n\t\t\tconst emitter = new Emitter<void>();\n\t\t\tthis._notebookCellStatusBarRegistrations.set(eventHandle, emitter);\n\t\t\tprovider.onDidChangeStatusBarItems = emitter.event;\n\t\t}\n\n\t\tconst disposable = this._cellStatusBarService.registerCellStatusBarItemProvider(provider);\n\t\tthis._notebookCellStatusBarRegistrations.set(handle, disposable);\n\t}\n\n\tasync $unregisterNotebookCellStatusBarItemProvider(handle: number, eventHandle: number | undefined): Promise<void> {\n\t\tconst unregisterThing = (handle: number) => {\n\t\t\tconst entry = this._notebookCellStatusBarRegistrations.get(handle);\n\t\t\tif (entry) {\n\t\t\t\tthis._notebookCellStatusBarRegistrations.get(handle)?.dispose();\n\t\t\t\tthis._notebookCellStatusBarRegistrations.delete(handle);\n\t\t\t}\n\t\t};\n\t\tunregisterThing(handle);\n\t\tif (typeof eventHandle === 'number') {\n\t\t\tunregisterThing(eventHandle);\n\t\t}\n\t}\n}\n\nCommandsRegistry.registerCommand('_executeDataToNotebook', async (accessor, ...args) => {\n\n\tconst [notebookType, bytes] = args;\n\tassertType(typeof notebookType === 'string', 'string');\n\tassertType(bytes instanceof VSBuffer, 'VSBuffer');\n\n\tconst notebookService = accessor.get(INotebookService);\n\tconst info = await notebookService.withNotebookDataProvider(notebookType);\n\tif (!(info instanceof SimpleNotebookProviderInfo)) {\n\t\treturn;\n\t}\n\n\tconst dto = await info.serializer.dataToNotebook(bytes);\n\treturn new SerializableObjectWithBuffers(NotebookDto.toNotebookDataDto(dto));\n});\n\nCommandsRegistry.registerCommand('_executeNotebookToData', async (accessor, notebookType: string, dto: SerializableObjectWithBuffers<NotebookDataDto>) => {\n\tassertType(typeof notebookType === 'string', 'string');\n\n\tconst notebookService = accessor.get(INotebookService);\n\tconst info = await notebookService.withNotebookDataProvider(notebookType);\n\tif (!(info instanceof SimpleNotebookProviderInfo)) {\n\t\treturn;\n\t}\n\n\tconst data = NotebookDto.fromNotebookDataDto(dto.value);\n\tconst bytes = await info.serializer.notebookToData(data);\n\treturn bytes;\n});\n\nfunction isFileOperationError(error: unknown): error is FileOperationError {\n\tconst candidate = error as FileOperationError | undefined;\n\treturn typeof candidate?.fileOperationResult === 'number' && typeof candidate?.message === 'string';\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer } from '../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { DisposableStore, dispose, IDisposable } from '../../../base/common/lifecycle.js';\nimport { StopWatch } from '../../../base/common/stopwatch.js';\nimport { assertType } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { CommandsRegistry } from '../../../platform/commands/common/commands.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { NotebookDto } from './mainThreadNotebookDto.js';\nimport { INotebookCellStatusBarService } from '../../contrib/notebook/common/notebookCellStatusBarService.js';\nimport { INotebookCellStatusBarItemProvider, INotebookContributionData, INotebookExclusiveDocumentFilter, NotebookData, NotebookExtensionDescription, TransientOptions } from '../../contrib/notebook/common/notebookCommon.js';\nimport { INotebookService, SimpleNotebookProviderInfo } from '../../contrib/notebook/common/notebookService.js';\nimport { extHostNamedCustomer, IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\nimport { ExtHostContext, ExtHostNotebookShape, MainContext, MainThreadNotebookShape, NotebookDataDto } from '../common/extHost.protocol.js';\nimport { IRelativePattern } from '../../../base/common/glob.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { INotebookFileMatchNoModel } from '../../contrib/search/common/searchNotebookHelpers.js';\nimport { NotebookPriorityInfo } from '../../contrib/search/common/search.js';\nimport { coalesce } from '../../../base/common/arrays.js';\nimport { FileOperationError } from '../../../platform/files/common/files.js';\n\n@extHostNamedCustomer(MainContext.MainThreadNotebook)\nexport class MainThreadNotebooks implements MainThreadNotebookShape {\n\n\tprivate readonly _disposables = new DisposableStore();\n\n\tprivate readonly _proxy: ExtHostNotebookShape;\n\tprivate readonly _notebookSerializer = new Map<number, IDisposable>();\n\tprivate readonly _notebookCellStatusBarRegistrations = new Map<number, IDisposable>();\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@INotebookCellStatusBarService private readonly _cellStatusBarService: INotebookCellStatusBarService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostNotebook);\n\t}\n\n\tdispose(): void {\n\t\tthis._disposables.dispose();\n\t\tdispose(this._notebookSerializer.values());\n\t}\n\n\t$registerNotebookSerializer(handle: number, extension: NotebookExtensionDescription, viewType: string, options: TransientOptions, data: INotebookContributionData | undefined): void {\n\t\tconst disposables = new DisposableStore();\n\n\t\tdisposables.add(this._notebookService.registerNotebookSerializer(viewType, extension, {\n\t\t\toptions,\n\t\t\tdataToNotebook: async (data: VSBuffer): Promise<NotebookData> => {\n\t\t\t\tconst sw = new StopWatch();\n\t\t\t\tlet result: NotebookData;\n\t\t\t\tif (data.byteLength === 0 && viewType === 'interactive') {\n\t\t\t\t\t// we don't want any starting cells for an empty interactive window.\n\t\t\t\t\tresult = NotebookDto.fromNotebookDataDto({ cells: [], metadata: {} });\n\t\t\t\t} else {\n\t\t\t\t\tconst dto = await this._proxy.$dataToNotebook(handle, data, CancellationToken.None);\n\t\t\t\t\tresult = NotebookDto.fromNotebookDataDto(dto.value);\n\t\t\t\t}\n\t\t\t\tthis._logService.trace(`[NotebookSerializer] dataToNotebook DONE after ${sw.elapsed()}ms`, {\n\t\t\t\t\tviewType,\n\t\t\t\t\textensionId: extension.id.value,\n\t\t\t\t});\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\tnotebookToData: (data: NotebookData): Promise<VSBuffer> => {\n\t\t\t\tconst sw = new StopWatch();\n\t\t\t\tconst result = this._proxy.$notebookToData(handle, new SerializableObjectWithBuffers(NotebookDto.toNotebookDataDto(data)), CancellationToken.None);\n\t\t\t\tthis._logService.trace(`[NotebookSerializer] notebookToData DONE after ${sw.elapsed()}`, {\n\t\t\t\t\tviewType,\n\t\t\t\t\textensionId: extension.id.value,\n\t\t\t\t});\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\tsave: async (uri, versionId, options, token) => {\n\t\t\t\tconst stat = await this._proxy.$saveNotebook(handle, uri, versionId, options, token);\n\t\t\t\tif (isFileOperationError(stat)) {\n\t\t\t\t\tthrow new FileOperationError(stat.message, stat.fileOperationResult, stat.options);\n\t\t\t\t}\n\t\t\t\treturn {\n\t\t\t\t\t...stat,\n\t\t\t\t\tchildren: undefined,\n\t\t\t\t\tresource: uri\n\t\t\t\t};\n\t\t\t},\n\t\t\tsearchInNotebooks: async (textQuery, token, allPriorityInfo): Promise<{ results: INotebookFileMatchNoModel<URI>[]; limitHit: boolean }> => {\n\t\t\t\tconst contributedType = this._notebookService.getContributedNotebookType(viewType);\n\t\t\t\tif (!contributedType) {\n\t\t\t\t\treturn { results: [], limitHit: false };\n\t\t\t\t}\n\t\t\t\tconst fileNames = contributedType.selectors;\n\n\t\t\t\tconst includes = fileNames.map((selector) => {\n\t\t\t\t\tconst globPattern = (selector as INotebookExclusiveDocumentFilter).include || selector as IRelativePattern | string;\n\t\t\t\t\treturn globPattern.toString();\n\t\t\t\t});\n\n\t\t\t\tif (!includes.length) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresults: [], limitHit: false\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tconst thisPriorityInfo = coalesce<NotebookPriorityInfo>([{ isFromSettings: false, filenamePatterns: includes }, ...allPriorityInfo.get(viewType) ?? []]);\n\t\t\t\tconst otherEditorsPriorityInfo = Array.from(allPriorityInfo.keys())\n\t\t\t\t\t.flatMap(key => {\n\t\t\t\t\t\tif (key !== viewType) {\n\t\t\t\t\t\t\treturn allPriorityInfo.get(key) ?? [];\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t});\n\n\t\t\t\tconst searchComplete = await this._proxy.$searchInNotebooks(handle, textQuery, thisPriorityInfo, otherEditorsPriorityInfo, token);\n\t\t\t\tconst revivedResults: INotebookFileMatchNoModel<URI>[] = searchComplete.results.map(result => {\n\t\t\t\t\tconst resource = URI.revive(result.resource);\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresource,\n\t\t\t\t\t\tcellResults: result.cellResults.map(e => revive(e))\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t\treturn { results: revivedResults, limitHit: searchComplete.limitHit };\n\t\t\t}\n\t\t}));\n\n\t\tif (data) {\n\t\t\tdisposables.add(this._notebookService.registerContributedNotebookType(viewType, data));\n\t\t}\n\t\tthis._notebookSerializer.set(handle, disposables);\n\n\t\tthis._logService.trace('[NotebookSerializer] registered notebook serializer', {\n\t\t\tviewType,\n\t\t\textensionId: extension.id.value,\n\t\t});\n\t}\n\n\t$unregisterNotebookSerializer(handle: number): void {\n\t\tthis._notebookSerializer.get(handle)?.dispose();\n\t\tthis._notebookSerializer.delete(handle);\n\t}\n\n\t$emitCellStatusBarEvent(eventHandle: number): void {\n\t\tconst emitter = this._notebookCellStatusBarRegistrations.get(eventHandle);\n\t\tif (emitter instanceof Emitter) {\n\t\t\temitter.fire(undefined);\n\t\t}\n\t}\n\n\tasync $registerNotebookCellStatusBarItemProvider(handle: number, eventHandle: number | undefined, viewType: string): Promise<void> {\n\t\tconst that = this;\n\t\tconst provider: INotebookCellStatusBarItemProvider = {\n\t\t\tasync provideCellStatusBarItems(uri: URI, index: number, token: CancellationToken) {\n\t\t\t\tconst result = await that._proxy.$provideNotebookCellStatusBarItems(handle, uri, index, token);\n\t\t\t\treturn {\n\t\t\t\t\titems: result?.items ?? [],\n\t\t\t\t\tdispose() {\n\t\t\t\t\t\tif (result) {\n\t\t\t\t\t\t\tthat._proxy.$releaseNotebookCellStatusBarItems(result.cacheId);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t},\n\t\t\tviewType\n\t\t};\n\n\t\tif (typeof eventHandle === 'number') {\n\t\t\tconst emitter = new Emitter<void>();\n\t\t\tthis._notebookCellStatusBarRegistrations.set(eventHandle, emitter);\n\t\t\tprovider.onDidChangeStatusBarItems = emitter.event;\n\t\t}\n\n\t\tconst disposable = this._cellStatusBarService.registerCellStatusBarItemProvider(provider);\n\t\tthis._notebookCellStatusBarRegistrations.set(handle, disposable);\n\t}\n\n\tasync $unregisterNotebookCellStatusBarItemProvider(handle: number, eventHandle: number | undefined): Promise<void> {\n\t\tconst unregisterThing = (handle: number) => {\n\t\t\tconst entry = this._notebookCellStatusBarRegistrations.get(handle);\n\t\t\tif (entry) {\n\t\t\t\tthis._notebookCellStatusBarRegistrations.get(handle)?.dispose();\n\t\t\t\tthis._notebookCellStatusBarRegistrations.delete(handle);\n\t\t\t}\n\t\t};\n\t\tunregisterThing(handle);\n\t\tif (typeof eventHandle === 'number') {\n\t\t\tunregisterThing(eventHandle);\n\t\t}\n\t}\n}\n\nCommandsRegistry.registerCommand('_executeDataToNotebook', async (accessor, ...args) => {\n\n\tconst [notebookType, bytes] = args;\n\tassertType(typeof notebookType === 'string', 'string');\n\tassertType(bytes instanceof VSBuffer, 'VSBuffer');\n\n\tconst notebookService = accessor.get(INotebookService);\n\tconst info = await notebookService.withNotebookDataProvider(notebookType);\n\tif (!(info instanceof SimpleNotebookProviderInfo)) {\n\t\treturn;\n\t}\n\n\tconst dto = await info.serializer.dataToNotebook(bytes);\n\treturn new SerializableObjectWithBuffers(NotebookDto.toNotebookDataDto(dto));\n});\n\nCommandsRegistry.registerCommand('_executeNotebookToData', async (accessor, notebookType: string, dto: SerializableObjectWithBuffers<NotebookDataDto>) => {\n\tassertType(typeof notebookType === 'string', 'string');\n\n\tconst notebookService = accessor.get(INotebookService);\n\tconst info = await notebookService.withNotebookDataProvider(notebookType);\n\tif (!(info instanceof SimpleNotebookProviderInfo)) {\n\t\treturn;\n\t}\n\n\tconst data = NotebookDto.fromNotebookDataDto(dto.value);\n\tconst bytes = await info.serializer.notebookToData(data);\n\treturn bytes;\n});\n\nfunction isFileOperationError(error: unknown): error is FileOperationError {\n\tconst candidate = error as FileOperationError | undefined;\n\treturn typeof candidate?.fileOperationResult === 'number' && typeof candidate?.message === 'string';\n}\n"]}