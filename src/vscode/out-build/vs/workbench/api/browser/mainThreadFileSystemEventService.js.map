{"version":3,"sources":["vs/workbench/api/browser/mainThreadFileSystemEventService.ts"],"names":[],"mappings":"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","file":"mainThreadFileSystemEventService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DisposableMap, DisposableStore } from '../../../base/common/lifecycle.js';\nimport { FileOperation, IFileService, IWatchOptions } from '../../../platform/files/common/files.js';\nimport { extHostNamedCustomer, IExtHostContext } from '../../services/extensions/common/extHostCustomers.js';\nimport { ExtHostContext, ExtHostFileSystemEventServiceShape, MainContext, MainThreadFileSystemEventServiceShape } from '../common/extHost.protocol.js';\nimport { localize } from '../../../nls.js';\nimport { IWorkingCopyFileOperationParticipant, IWorkingCopyFileService, SourceTargetPair, IFileOperationUndoRedoInfo } from '../../services/workingCopy/common/workingCopyFileService.js';\nimport { IBulkEditService } from '../../../editor/browser/services/bulkEditService.js';\nimport { IProgressService, ProgressLocation } from '../../../platform/progress/common/progress.js';\nimport { raceCancellation } from '../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { IDialogService } from '../../../platform/dialogs/common/dialogs.js';\nimport Severity from '../../../base/common/severity.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../platform/storage/common/storage.js';\nimport { Action2, registerAction2 } from '../../../platform/actions/common/actions.js';\nimport { ServicesAccessor } from '../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { IEnvironmentService } from '../../../platform/environment/common/environment.js';\nimport { IUriIdentityService } from '../../../platform/uriIdentity/common/uriIdentity.js';\nimport { reviveWorkspaceEditDto } from './mainThreadBulkEdits.js';\nimport { UriComponents, URI } from '../../../base/common/uri.js';\n\n@extHostNamedCustomer(MainContext.MainThreadFileSystemEventService)\nexport class MainThreadFileSystemEventService implements MainThreadFileSystemEventServiceShape {\n\n\tstatic readonly MementoKeyAdditionalEdits = `file.particpants.additionalEdits`;\n\n\tprivate readonly _proxy: ExtHostFileSystemEventServiceShape;\n\n\tprivate readonly _listener = new DisposableStore();\n\tprivate readonly _watches = new DisposableMap<number>();\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@IWorkingCopyFileService workingCopyFileService: IWorkingCopyFileService,\n\t\t@IBulkEditService bulkEditService: IBulkEditService,\n\t\t@IProgressService progressService: IProgressService,\n\t\t@IDialogService dialogService: IDialogService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@ILogService logService: ILogService,\n\t\t@IEnvironmentService envService: IEnvironmentService,\n\t\t@IUriIdentityService uriIdentService: IUriIdentityService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostFileSystemEventService);\n\n\t\tthis._listener.add(_fileService.onDidFilesChange(event => {\n\t\t\tthis._proxy.$onFileEvent({\n\t\t\t\tcreated: event.rawAdded,\n\t\t\t\tchanged: event.rawUpdated,\n\t\t\t\tdeleted: event.rawDeleted\n\t\t\t});\n\t\t}));\n\n\t\tconst that = this;\n\t\tconst fileOperationParticipant = new class implements IWorkingCopyFileOperationParticipant {\n\t\t\tasync participate(files: SourceTargetPair[], operation: FileOperation, undoInfo: IFileOperationUndoRedoInfo | undefined, timeout: number, token: CancellationToken) {\n\t\t\t\tif (undoInfo?.isUndoing) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst cts = new CancellationTokenSource(token);\n\t\t\t\tconst timer = setTimeout(() => cts.cancel(), timeout);\n\n\t\t\t\tconst data = await progressService.withProgress({\n\t\t\t\t\tlocation: ProgressLocation.Notification,\n\t\t\t\t\ttitle: this._progressLabel(operation),\n\t\t\t\t\tcancellable: true,\n\t\t\t\t\tdelay: Math.min(timeout / 2, 3000)\n\t\t\t\t}, () => {\n\t\t\t\t\t// race extension host event delivery against timeout AND user-cancel\n\t\t\t\t\tconst onWillEvent = that._proxy.$onWillRunFileOperation(operation, files, timeout, cts.token);\n\t\t\t\t\treturn raceCancellation(onWillEvent, cts.token);\n\t\t\t\t}, () => {\n\t\t\t\t\t// user-cancel\n\t\t\t\t\tcts.cancel();\n\n\t\t\t\t}).finally(() => {\n\t\t\t\t\tcts.dispose();\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t});\n\n\t\t\t\tif (!data || data.edit.edits.length === 0) {\n\t\t\t\t\t// cancelled, no reply, or no edits\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst needsConfirmation = data.edit.edits.some(edit => edit.metadata?.needsConfirmation);\n\t\t\t\tlet showPreview = storageService.getBoolean(MainThreadFileSystemEventService.MementoKeyAdditionalEdits, StorageScope.PROFILE);\n\n\t\t\t\tif (envService.extensionTestsLocationURI) {\n\t\t\t\t\t// don't show dialog in tests\n\t\t\t\t\tshowPreview = false;\n\t\t\t\t}\n\n\t\t\t\tif (showPreview === undefined) {\n\t\t\t\t\t// show a user facing message\n\n\t\t\t\t\tlet message: string;\n\t\t\t\t\tif (data.extensionNames.length === 1) {\n\t\t\t\t\t\tif (operation === FileOperation.CREATE) {\n\t\t\t\t\t\t\tmessage = localize('ask.1.create', \"Extension '{0}' wants to make refactoring changes with this file creation\", data.extensionNames[0]);\n\t\t\t\t\t\t} else if (operation === FileOperation.COPY) {\n\t\t\t\t\t\t\tmessage = localize('ask.1.copy', \"Extension '{0}' wants to make refactoring changes with this file copy\", data.extensionNames[0]);\n\t\t\t\t\t\t} else if (operation === FileOperation.MOVE) {\n\t\t\t\t\t\t\tmessage = localize('ask.1.move', \"Extension '{0}' wants to make refactoring changes with this file move\", data.extensionNames[0]);\n\t\t\t\t\t\t} else /* if (operation === FileOperation.DELETE) */ {\n\t\t\t\t\t\t\tmessage = localize('ask.1.delete', \"Extension '{0}' wants to make refactoring changes with this file deletion\", data.extensionNames[0]);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (operation === FileOperation.CREATE) {\n\t\t\t\t\t\t\tmessage = localize({ key: 'ask.N.create', comment: ['{0} is a number, e.g \"3 extensions want...\"'] }, \"{0} extensions want to make refactoring changes with this file creation\", data.extensionNames.length);\n\t\t\t\t\t\t} else if (operation === FileOperation.COPY) {\n\t\t\t\t\t\t\tmessage = localize({ key: 'ask.N.copy', comment: ['{0} is a number, e.g \"3 extensions want...\"'] }, \"{0} extensions want to make refactoring changes with this file copy\", data.extensionNames.length);\n\t\t\t\t\t\t} else if (operation === FileOperation.MOVE) {\n\t\t\t\t\t\t\tmessage = localize({ key: 'ask.N.move', comment: ['{0} is a number, e.g \"3 extensions want...\"'] }, \"{0} extensions want to make refactoring changes with this file move\", data.extensionNames.length);\n\t\t\t\t\t\t} else /* if (operation === FileOperation.DELETE) */ {\n\t\t\t\t\t\t\tmessage = localize({ key: 'ask.N.delete', comment: ['{0} is a number, e.g \"3 extensions want...\"'] }, \"{0} extensions want to make refactoring changes with this file deletion\", data.extensionNames.length);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (needsConfirmation) {\n\t\t\t\t\t\t// edit which needs confirmation -> always show dialog\n\t\t\t\t\t\tconst { confirmed } = await dialogService.confirm({\n\t\t\t\t\t\t\ttype: Severity.Info,\n\t\t\t\t\t\t\tmessage,\n\t\t\t\t\t\t\tprimaryButton: localize('preview', \"Show &&Preview\"),\n\t\t\t\t\t\t\tcancelButton: localize('cancel', \"Skip Changes\")\n\t\t\t\t\t\t});\n\t\t\t\t\t\tshowPreview = true;\n\t\t\t\t\t\tif (!confirmed) {\n\t\t\t\t\t\t\t// no changes wanted\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// choice\n\t\t\t\t\t\tenum Choice {\n\t\t\t\t\t\t\tOK = 0,\n\t\t\t\t\t\t\tPreview = 1,\n\t\t\t\t\t\t\tCancel = 2\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst { result, checkboxChecked } = await dialogService.prompt<Choice>({\n\t\t\t\t\t\t\ttype: Severity.Info,\n\t\t\t\t\t\t\tmessage,\n\t\t\t\t\t\t\tbuttons: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlabel: localize({ key: 'ok', comment: ['&& denotes a mnemonic'] }, \"&&OK\"),\n\t\t\t\t\t\t\t\t\trun: () => Choice.OK\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlabel: localize({ key: 'preview', comment: ['&& denotes a mnemonic'] }, \"Show &&Preview\"),\n\t\t\t\t\t\t\t\t\trun: () => Choice.Preview\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tcancelButton: {\n\t\t\t\t\t\t\t\tlabel: localize('cancel', \"Skip Changes\"),\n\t\t\t\t\t\t\t\trun: () => Choice.Cancel\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tcheckbox: { label: localize('again', \"Do not ask me again\") }\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (result === Choice.Cancel) {\n\t\t\t\t\t\t\t// no changes wanted, don't persist cancel option\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tshowPreview = result === Choice.Preview;\n\t\t\t\t\t\tif (checkboxChecked) {\n\t\t\t\t\t\t\tstorageService.store(MainThreadFileSystemEventService.MementoKeyAdditionalEdits, showPreview, StorageScope.PROFILE, StorageTarget.USER);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlogService.info('[onWill-handler] applying additional workspace edit from extensions', data.extensionNames);\n\n\t\t\t\tawait bulkEditService.apply(\n\t\t\t\t\treviveWorkspaceEditDto(data.edit, uriIdentService),\n\t\t\t\t\t{ undoRedoGroupId: undoInfo?.undoRedoGroupId, showPreview }\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tprivate _progressLabel(operation: FileOperation): string {\n\t\t\t\tswitch (operation) {\n\t\t\t\t\tcase FileOperation.CREATE:\n\t\t\t\t\t\treturn localize('msg-create', \"Running 'File Create' participants...\");\n\t\t\t\t\tcase FileOperation.MOVE:\n\t\t\t\t\t\treturn localize('msg-rename', \"Running 'File Rename' participants...\");\n\t\t\t\t\tcase FileOperation.COPY:\n\t\t\t\t\t\treturn localize('msg-copy', \"Running 'File Copy' participants...\");\n\t\t\t\t\tcase FileOperation.DELETE:\n\t\t\t\t\t\treturn localize('msg-delete', \"Running 'File Delete' participants...\");\n\t\t\t\t\tcase FileOperation.WRITE:\n\t\t\t\t\t\treturn localize('msg-write', \"Running 'File Write' participants...\");\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\t// BEFORE file operation\n\t\tthis._listener.add(workingCopyFileService.addFileOperationParticipant(fileOperationParticipant));\n\n\t\t// AFTER file operation\n\t\tthis._listener.add(workingCopyFileService.onDidRunWorkingCopyFileOperation(e => this._proxy.$onDidRunFileOperation(e.operation, e.files)));\n\t}\n\n\tasync $watch(extensionId: string, session: number, resource: UriComponents, unvalidatedOpts: IWatchOptions, correlate: boolean): Promise<void> {\n\t\tconst uri = URI.revive(resource);\n\n\t\tconst canHandleWatcher = await this._fileService.canHandleResource(uri);\n\t\tif (!canHandleWatcher) {\n\t\t\tthis._logService.warn(`MainThreadFileSystemEventService#$watch(): cannot watch resource as its scheme is not handled by the file service (extension: ${extensionId}, path: ${uri.toString(true)})`);\n\t\t}\n\n\t\tconst opts: IWatchOptions = {\n\t\t\t...unvalidatedOpts\n\t\t};\n\n\t\t// Convert a recursive watcher to a flat watcher if the path\n\t\t// turns out to not be a folder. Recursive watching is only\n\t\t// possible on folders, so we help all file watchers by checking\n\t\t// early.\n\t\tif (opts.recursive) {\n\t\t\ttry {\n\t\t\t\tconst stat = await this._fileService.stat(uri);\n\t\t\t\tif (!stat.isDirectory) {\n\t\t\t\t\topts.recursive = false;\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\t// ignore\n\t\t\t}\n\t\t}\n\n\t\t// Correlated file watching: use an exclusive `createWatcher()`\n\t\t// Note: currently not enabled for extensions (but leaving in in case of future usage)\n\t\tif (correlate && !opts.recursive) {\n\t\t\tthis._logService.trace(`MainThreadFileSystemEventService#$watch(): request to start watching correlated (extension: ${extensionId}, path: ${uri.toString(true)}, recursive: ${opts.recursive}, session: ${session}, excludes: ${JSON.stringify(opts.excludes)}, includes: ${JSON.stringify(opts.includes)})`);\n\n\t\t\tconst watcherDisposables = new DisposableStore();\n\t\t\tconst subscription = watcherDisposables.add(this._fileService.createWatcher(uri, { ...opts, recursive: false }));\n\t\t\twatcherDisposables.add(subscription.onDidChange(event => {\n\t\t\t\tthis._proxy.$onFileEvent({\n\t\t\t\t\tsession,\n\t\t\t\t\tcreated: event.rawAdded,\n\t\t\t\t\tchanged: event.rawUpdated,\n\t\t\t\t\tdeleted: event.rawDeleted\n\t\t\t\t});\n\t\t\t}));\n\n\t\t\tthis._watches.set(session, watcherDisposables);\n\t\t}\n\n\t\t// Uncorrelated file watching: via shared `watch()`\n\t\telse {\n\t\t\tthis._logService.trace(`MainThreadFileSystemEventService#$watch(): request to start watching uncorrelated (extension: ${extensionId}, path: ${uri.toString(true)}, recursive: ${opts.recursive}, session: ${session}, excludes: ${JSON.stringify(opts.excludes)}, includes: ${JSON.stringify(opts.includes)})`);\n\n\t\t\tconst subscription = this._fileService.watch(uri, opts);\n\t\t\tthis._watches.set(session, subscription);\n\t\t}\n\t}\n\n\t$unwatch(session: number): void {\n\t\tif (this._watches.has(session)) {\n\t\t\tthis._logService.trace(`MainThreadFileSystemEventService#$unwatch(): request to stop watching (session: ${session})`);\n\t\t\tthis._watches.deleteAndDispose(session);\n\t\t}\n\t}\n\n\tdispose(): void {\n\t\tthis._listener.dispose();\n\t\tthis._watches.dispose();\n\t}\n}\n\nregisterAction2(class ResetMemento extends Action2 {\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: 'files.participants.resetChoice',\n\t\t\ttitle: {\n\t\t\t\tvalue: localize('label', \"Reset choice for 'File operation needs preview'\"),\n\t\t\t\toriginal: `Reset choice for 'File operation needs preview'`\n\t\t\t},\n\t\t\tf1: true\n\t\t});\n\t}\n\trun(accessor: ServicesAccessor) {\n\t\taccessor.get(IStorageService).remove(MainThreadFileSystemEventService.MementoKeyAdditionalEdits, StorageScope.PROFILE);\n\t}\n});\n"]}