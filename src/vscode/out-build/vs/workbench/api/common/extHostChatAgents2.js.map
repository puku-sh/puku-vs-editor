{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostChatAgents2.ts","vs/workbench/api/common/extHostChatAgents2.ts"],"names":[],"mappings":"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","file":"extHostChatAgents2.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type * as vscode from 'vscode';\nimport { coalesce } from '../../../base/common/arrays.js';\nimport { timeout } from '../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { toErrorMessage } from '../../../base/common/errorMessage.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { Iterable } from '../../../base/common/iterator.js';\nimport { Disposable, DisposableMap, DisposableStore, toDisposable } from '../../../base/common/lifecycle.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { StopWatch } from '../../../base/common/stopwatch.js';\nimport { assertType } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { Location } from '../../../editor/common/languages.js';\nimport { ExtensionIdentifier, IExtensionDescription, IRelaxedExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { isChatViewTitleActionContext } from '../../contrib/chat/common/chatActions.js';\nimport { IChatAgentRequest, IChatAgentResult, IChatAgentResultTimings, UserSelectedTools } from '../../contrib/chat/common/chatAgents.js';\nimport { IChatRelatedFile, IChatRequestDraft } from '../../contrib/chat/common/chatEditingService.js';\nimport { ChatAgentVoteDirection, IChatContentReference, IChatFollowup, IChatResponseErrorDetails, IChatUserActionEvent, IChatVoteAction } from '../../contrib/chat/common/chatService.js';\nimport { ChatAgentLocation } from '../../contrib/chat/common/constants.js';\nimport { checkProposedApiEnabled, isProposedApiEnabled } from '../../services/extensions/common/extensions.js';\nimport { Dto } from '../../services/extensions/common/proxyIdentifier.js';\nimport { ExtHostChatAgentsShape2, IChatAgentCompletionItem, IChatAgentHistoryEntryDto, IChatAgentProgressShape, IChatProgressDto, IChatSessionContextDto, IExtensionChatAgentMetadata, IMainContext, MainContext, MainThreadChatAgentsShape2 } from './extHost.protocol.js';\nimport { CommandsConverter, ExtHostCommands } from './extHostCommands.js';\nimport { ExtHostDiagnostics } from './extHostDiagnostics.js';\nimport { ExtHostDocuments } from './extHostDocuments.js';\nimport { ExtHostLanguageModels } from './extHostLanguageModels.js';\nimport { ExtHostLanguageModelTools } from './extHostLanguageModelTools.js';\nimport * as typeConvert from './extHostTypeConverters.js';\nimport * as extHostTypes from './extHostTypes.js';\n\nexport class ChatAgentResponseStream {\n\n\tprivate _stopWatch = StopWatch.create(false);\n\tprivate _isClosed: boolean = false;\n\tprivate _firstProgress: number | undefined;\n\tprivate _apiObject: vscode.ChatResponseStream | undefined;\n\n\tconstructor(\n\t\tprivate readonly _extension: IExtensionDescription,\n\t\tprivate readonly _request: IChatAgentRequest,\n\t\tprivate readonly _proxy: IChatAgentProgressShape,\n\t\tprivate readonly _commandsConverter: CommandsConverter,\n\t\tprivate readonly _sessionDisposables: DisposableStore\n\t) { }\n\n\tclose() {\n\t\tthis._isClosed = true;\n\t}\n\n\tget timings(): IChatAgentResultTimings {\n\t\treturn {\n\t\t\tfirstProgress: this._firstProgress,\n\t\t\ttotalElapsed: this._stopWatch.elapsed()\n\t\t};\n\t}\n\n\tget apiObject() {\n\n\t\tif (!this._apiObject) {\n\n\t\t\tconst that = this;\n\t\t\tthis._stopWatch.reset();\n\n\n\t\t\tlet taskHandlePool = 0;\n\n\n\t\t\tfunction throwIfDone(source: Function | undefined) {\n\t\t\t\tif (that._isClosed) {\n\t\t\t\t\tconst err = new Error('Response stream has been closed');\n\t\t\t\t\tError.captureStackTrace(err, source);\n\t\t\t\t\tthrow err;\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\tconst sendQueue: (IChatProgressDto | [IChatProgressDto, number])[] = [];\n\t\t\tlet notify: Function[] = [];\n\n\t\t\tfunction send(chunk: IChatProgressDto): void;\n\t\t\tfunction send(chunk: IChatProgressDto, handle: number): Promise<void>;\n\t\t\tfunction send(chunk: IChatProgressDto, handle?: number) {\n\t\t\t\t// push data into send queue. the first entry schedules the micro task which\n\t\t\t\t// does the actual send to the main thread\n\t\t\t\tconst newLen = sendQueue.push(handle !== undefined ? [chunk, handle] : chunk);\n\t\t\t\tif (newLen === 1) {\n\t\t\t\t\tqueueMicrotask(() => {\n\t\t\t\t\t\tconst toNotify = notify;\n\t\t\t\t\t\tnotify = [];\n\t\t\t\t\t\tthat._proxy.$handleProgressChunk(that._request.requestId, sendQueue).finally(() => {\n\t\t\t\t\t\t\ttoNotify.forEach(f => f());\n\t\t\t\t\t\t});\n\t\t\t\t\t\tsendQueue.length = 0;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (handle !== undefined) {\n\t\t\t\t\treturn new Promise<void>(resolve => { notify.push(resolve); });\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst _report = (progress: IChatProgressDto, task?: (progress: vscode.Progress<vscode.ChatResponseWarningPart | vscode.ChatResponseReferencePart>) => Thenable<string | void>) => {\n\t\t\t\t// Measure the time to the first progress update with real markdown content\n\t\t\t\tif (typeof this._firstProgress === 'undefined' && (progress.kind === 'markdownContent' || progress.kind === 'markdownVuln' || progress.kind === 'prepareToolInvocation')) {\n\t\t\t\t\tthis._firstProgress = this._stopWatch.elapsed();\n\t\t\t\t}\n\n\t\t\t\tif (task) {\n\t\t\t\t\tconst myHandle = taskHandlePool++;\n\t\t\t\t\tconst progressReporterPromise = send(progress, myHandle);\n\t\t\t\t\tconst progressReporter = {\n\t\t\t\t\t\treport: (p: vscode.ChatResponseWarningPart | vscode.ChatResponseReferencePart) => {\n\t\t\t\t\t\t\tprogressReporterPromise.then(() => {\n\t\t\t\t\t\t\t\tif (extHostTypes.MarkdownString.isMarkdownString(p.value)) {\n\t\t\t\t\t\t\t\t\tsend(typeConvert.ChatResponseWarningPart.from(<vscode.ChatResponseWarningPart>p), myHandle);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tsend(typeConvert.ChatResponseReferencePart.from(<vscode.ChatResponseReferencePart>p), myHandle);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\tPromise.all([progressReporterPromise, task(progressReporter)]).then(([_void, res]) => {\n\t\t\t\t\t\tsend(typeConvert.ChatTaskResult.from(res), myHandle);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tsend(progress);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis._apiObject = Object.freeze<vscode.ChatResponseStream>({\n\t\t\t\tclearToPreviousToolInvocation(reason) {\n\t\t\t\t\tthrowIfDone(this.markdown);\n\t\t\t\t\tsend({ kind: 'clearToPreviousToolInvocation', reason: reason });\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tmarkdown(value) {\n\t\t\t\t\tthrowIfDone(this.markdown);\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseMarkdownPart(value);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseMarkdownPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tmarkdownWithVulnerabilities(value, vulnerabilities) {\n\t\t\t\t\tthrowIfDone(this.markdown);\n\t\t\t\t\tif (vulnerabilities) {\n\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseMarkdownWithVulnerabilitiesPart(value, vulnerabilities);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseMarkdownWithVulnerabilitiesPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tcodeblockUri(value, isEdit) {\n\t\t\t\t\tthrowIfDone(this.codeblockUri);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseCodeblockUriPart(value, isEdit);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseCodeblockUriPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tfiletree(value, baseUri) {\n\t\t\t\t\tthrowIfDone(this.filetree);\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseFileTreePart(value, baseUri);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseFilesPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tanchor(value, title?: string) {\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseAnchorPart(value, title);\n\t\t\t\t\treturn this.push(part);\n\t\t\t\t},\n\t\t\t\tbutton(value) {\n\t\t\t\t\tthrowIfDone(this.anchor);\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseCommandButtonPart(value);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseCommandButtonPart.from(part, that._commandsConverter, that._sessionDisposables);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tprogress(value, task?: ((progress: vscode.Progress<vscode.ChatResponseWarningPart>) => Thenable<string | void>)) {\n\t\t\t\t\tthrowIfDone(this.progress);\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseProgressPart2(value, task);\n\t\t\t\t\tconst dto = task ? typeConvert.ChatTask.from(part) : typeConvert.ChatResponseProgressPart.from(part);\n\t\t\t\t\t_report(dto, task);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tthinkingProgress(thinkingDelta: vscode.ThinkingDelta) {\n\t\t\t\t\tthrowIfDone(this.thinkingProgress);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseThinkingProgressPart(thinkingDelta.text ?? '', thinkingDelta.id, thinkingDelta.metadata);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseThinkingProgressPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\twarning(value) {\n\t\t\t\t\tthrowIfDone(this.progress);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseWarningPart(value);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseWarningPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\treference(value, iconPath) {\n\t\t\t\t\treturn this.reference2(value, iconPath);\n\t\t\t\t},\n\t\t\t\treference2(value, iconPath, options) {\n\t\t\t\t\tthrowIfDone(this.reference);\n\n\t\t\t\t\tif (typeof value === 'object' && 'variableName' in value) {\n\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof value === 'object' && 'variableName' in value && !value.value) {\n\t\t\t\t\t\t// The participant used this variable. Does that variable have any references to pull in?\n\t\t\t\t\t\tconst matchingVarData = that._request.variables.variables.find(v => v.name === value.variableName);\n\t\t\t\t\t\tif (matchingVarData) {\n\t\t\t\t\t\t\tlet references: Dto<IChatContentReference>[] | undefined;\n\t\t\t\t\t\t\tif (matchingVarData.references?.length) {\n\t\t\t\t\t\t\t\treferences = matchingVarData.references.map(r => ({\n\t\t\t\t\t\t\t\t\tkind: 'reference',\n\t\t\t\t\t\t\t\t\treference: { variableName: value.variableName, value: r.reference as URI | Location }\n\t\t\t\t\t\t\t\t} satisfies IChatContentReference));\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// Participant sent a variableName reference but the variable produced no references. Show variable reference with no value\n\t\t\t\t\t\t\t\tconst part = new extHostTypes.ChatResponseReferencePart(value, iconPath, options);\n\t\t\t\t\t\t\t\tconst dto = typeConvert.ChatResponseReferencePart.from(part);\n\t\t\t\t\t\t\t\treferences = [dto];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treferences.forEach(r => _report(r));\n\t\t\t\t\t\t\treturn this;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Something went wrong- that variable doesn't actually exist\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst part = new extHostTypes.ChatResponseReferencePart(value, iconPath, options);\n\t\t\t\t\t\tconst dto = typeConvert.ChatResponseReferencePart.from(part);\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tcodeCitation(value: vscode.Uri, license: string, snippet: string): void {\n\t\t\t\t\tthrowIfDone(this.codeCitation);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseCodeCitationPart(value, license, snippet);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseCodeCitationPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t},\n\t\t\t\ttextEdit(target, edits) {\n\t\t\t\t\tthrowIfDone(this.textEdit);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseTextEditPart(target, edits);\n\t\t\t\t\tpart.isDone = edits === true ? true : undefined;\n\t\t\t\t\tconst dto = typeConvert.ChatResponseTextEditPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tnotebookEdit(target, edits) {\n\t\t\t\t\tthrowIfDone(this.notebookEdit);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseNotebookEditPart(target, edits);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseNotebookEditPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tasync externalEdit(target, callback) {\n\t\t\t\t\tthrowIfDone(this.externalEdit);\n\t\t\t\t\tconst resources = Array.isArray(target) ? target : [target];\n\t\t\t\t\tconst operationId = taskHandlePool++;\n\n\t\t\t\t\tawait send({ kind: 'externalEdits', start: true, resources }, operationId);\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn await callback();\n\t\t\t\t\t} finally {\n\t\t\t\t\t\tawait send({ kind: 'externalEdits', start: false, resources }, operationId);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tconfirmation(title, message, data, buttons) {\n\t\t\t\t\tthrowIfDone(this.confirmation);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseConfirmationPart(title, message, data, buttons);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseConfirmationPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tprepareToolInvocation(toolName) {\n\t\t\t\t\tthrowIfDone(this.prepareToolInvocation);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatPrepareToolInvocationPart(toolName);\n\t\t\t\t\tconst dto = typeConvert.ChatPrepareToolInvocationPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tpush(part) {\n\t\t\t\t\tthrowIfDone(this.push);\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseTextEditPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseNotebookEditPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseMarkdownWithVulnerabilitiesPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseWarningPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseConfirmationPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseCodeCitationPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseMovePart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseExtensionsPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseExternalEditPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseThinkingProgressPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponsePullRequestPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseProgressPart2\n\t\t\t\t\t) {\n\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\t}\n\n\t\t\t\t\tif (part instanceof extHostTypes.ChatResponseReferencePart) {\n\t\t\t\t\t\t// Ensure variable reference values get fixed up\n\t\t\t\t\t\tthis.reference2(part.value, part.iconPath, part.options);\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatResponseProgressPart2) {\n\t\t\t\t\t\tconst dto = part.task ? typeConvert.ChatTask.from(part) : typeConvert.ChatResponseProgressPart.from(part);\n\t\t\t\t\t\t_report(dto, part.task);\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatResponseThinkingProgressPart) {\n\t\t\t\t\t\tconst dto = typeConvert.ChatResponseThinkingProgressPart.from(part);\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatResponseAnchorPart) {\n\t\t\t\t\t\tconst dto = typeConvert.ChatResponseAnchorPart.from(part);\n\n\t\t\t\t\t\tif (part.resolve) {\n\t\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\t\t\tdto.resolveId = generateUuid();\n\n\t\t\t\t\t\t\tconst cts = new CancellationTokenSource();\n\t\t\t\t\t\t\tpart.resolve(cts.token)\n\t\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\t\tconst resolvedDto = typeConvert.ChatResponseAnchorPart.from(part);\n\t\t\t\t\t\t\t\t\tthat._proxy.$handleAnchorResolve(that._request.requestId, dto.resolveId!, resolvedDto);\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(() => cts.dispose(), () => cts.dispose());\n\t\t\t\t\t\t\tthat._sessionDisposables.add(toDisposable(() => cts.dispose(true)));\n\t\t\t\t\t\t}\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatPrepareToolInvocationPart) {\n\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\t\tconst dto = typeConvert.ChatPrepareToolInvocationPart.from(part);\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t\treturn this;\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatResponseExternalEditPart) {\n\t\t\t\t\t\tconst p = this.externalEdit(part.uris, part.callback);\n\t\t\t\t\t\tp.then(() => part.didGetApplied());\n\t\t\t\t\t\treturn this;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst dto = typeConvert.ChatResponsePart.from(part, that._commandsConverter, that._sessionDisposables);\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn this._apiObject;\n\t}\n}\n\ninterface InFlightChatRequest {\n\trequestId: string;\n\textRequest: vscode.ChatRequest;\n\textension: IRelaxedExtensionDescription;\n}\n\nexport class ExtHostChatAgents2 extends Disposable implements ExtHostChatAgentsShape2 {\n\n\tprivate static _idPool = 0;\n\n\tprivate readonly _agents = new Map<number, ExtHostChatAgent>();\n\tprivate readonly _proxy: MainThreadChatAgentsShape2;\n\n\tprivate static _participantDetectionProviderIdPool = 0;\n\tprivate readonly _participantDetectionProviders = new Map<number, ExtHostParticipantDetector>();\n\n\tprivate static _relatedFilesProviderIdPool = 0;\n\tprivate readonly _relatedFilesProviders = new Map<number, ExtHostRelatedFilesProvider>();\n\n\tprivate readonly _sessionDisposables: DisposableMap<string, DisposableStore> = this._register(new DisposableMap());\n\tprivate readonly _completionDisposables: DisposableMap<number, DisposableStore> = this._register(new DisposableMap());\n\n\tprivate readonly _inFlightRequests = new Set<InFlightChatRequest>();\n\n\tprivate readonly _onDidChangeChatRequestTools = this._register(new Emitter<vscode.ChatRequest>());\n\treadonly onDidChangeChatRequestTools = this._onDidChangeChatRequestTools.event;\n\n\tprivate readonly _onDidDisposeChatSession = this._register(new Emitter<string>());\n\treadonly onDidDisposeChatSession = this._onDidDisposeChatSession.event;\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _commands: ExtHostCommands,\n\t\tprivate readonly _documents: ExtHostDocuments,\n\t\tprivate readonly _languageModels: ExtHostLanguageModels,\n\t\tprivate readonly _diagnostics: ExtHostDiagnostics,\n\t\tprivate readonly _tools: ExtHostLanguageModelTools\n\t) {\n\t\tsuper();\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadChatAgents2);\n\n\t\t_commands.registerArgumentProcessor({\n\t\t\tprocessArgument: (arg) => {\n\t\t\t\t// Don't send this argument to extension commands\n\t\t\t\tif (isChatViewTitleActionContext(arg)) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn arg;\n\t\t\t}\n\t\t});\n\t}\n\n\ttransferActiveChat(newWorkspace: vscode.Uri): void {\n\t\tthis._proxy.$transferActiveChatSession(newWorkspace);\n\t}\n\n\tcreateChatAgent(extension: IExtensionDescription, id: string, handler: vscode.ChatExtendedRequestHandler): vscode.ChatParticipant {\n\t\tconst handle = ExtHostChatAgents2._idPool++;\n\t\tconst agent = new ExtHostChatAgent(extension, id, this._proxy, handle, handler);\n\t\tthis._agents.set(handle, agent);\n\n\t\tthis._proxy.$registerAgent(handle, extension.identifier, id, {}, undefined);\n\t\treturn agent.apiAgent;\n\t}\n\n\tcreateDynamicChatAgent(extension: IExtensionDescription, id: string, dynamicProps: vscode.DynamicChatParticipantProps, handler: vscode.ChatExtendedRequestHandler): vscode.ChatParticipant {\n\t\tconst handle = ExtHostChatAgents2._idPool++;\n\t\tconst agent = new ExtHostChatAgent(extension, id, this._proxy, handle, handler);\n\t\tthis._agents.set(handle, agent);\n\n\t\tthis._proxy.$registerAgent(handle, extension.identifier, id, { isSticky: true } satisfies IExtensionChatAgentMetadata, dynamicProps);\n\t\treturn agent.apiAgent;\n\t}\n\n\tregisterChatParticipantDetectionProvider(extension: IExtensionDescription, provider: vscode.ChatParticipantDetectionProvider): vscode.Disposable {\n\t\tconst handle = ExtHostChatAgents2._participantDetectionProviderIdPool++;\n\t\tthis._participantDetectionProviders.set(handle, new ExtHostParticipantDetector(extension, provider));\n\t\tthis._proxy.$registerChatParticipantDetectionProvider(handle);\n\t\treturn toDisposable(() => {\n\t\t\tthis._participantDetectionProviders.delete(handle);\n\t\t\tthis._proxy.$unregisterChatParticipantDetectionProvider(handle);\n\t\t});\n\t}\n\n\tregisterRelatedFilesProvider(extension: IExtensionDescription, provider: vscode.ChatRelatedFilesProvider, metadata: vscode.ChatRelatedFilesProviderMetadata): vscode.Disposable {\n\t\tconst handle = ExtHostChatAgents2._relatedFilesProviderIdPool++;\n\t\tthis._relatedFilesProviders.set(handle, new ExtHostRelatedFilesProvider(extension, provider));\n\t\tthis._proxy.$registerRelatedFilesProvider(handle, metadata);\n\t\treturn toDisposable(() => {\n\t\t\tthis._relatedFilesProviders.delete(handle);\n\t\t\tthis._proxy.$unregisterRelatedFilesProvider(handle);\n\t\t});\n\t}\n\n\tasync $provideRelatedFiles(handle: number, request: IChatRequestDraft, token: CancellationToken): Promise<Dto<IChatRelatedFile>[] | undefined> {\n\t\tconst provider = this._relatedFilesProviders.get(handle);\n\t\tif (!provider) {\n\t\t\treturn Promise.resolve([]);\n\t\t}\n\n\t\tconst extRequestDraft = typeConvert.ChatRequestDraft.to(request);\n\t\treturn await provider.provider.provideRelatedFiles(extRequestDraft, token) ?? undefined;\n\t}\n\n\tasync $detectChatParticipant(handle: number, requestDto: Dto<IChatAgentRequest>, context: { history: IChatAgentHistoryEntryDto[] }, options: { location: ChatAgentLocation; participants?: vscode.ChatParticipantMetadata[] }, token: CancellationToken): Promise<vscode.ChatParticipantDetectionResult | null | undefined> {\n\t\tconst detector = this._participantDetectionProviders.get(handle);\n\t\tif (!detector) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst { request, location, history } = await this._createRequest(requestDto, context, detector.extension);\n\n\t\tconst model = await this.getModelForRequest(request, detector.extension);\n\t\tconst extRequest = typeConvert.ChatAgentRequest.to(\n\t\t\trequest,\n\t\t\tlocation,\n\t\t\tmodel,\n\t\t\tthis.getDiagnosticsWhenEnabled(detector.extension),\n\t\t\tthis.getToolsForRequest(detector.extension, request.userSelectedTools),\n\t\t\tdetector.extension,\n\t\t\tthis._logService);\n\n\t\treturn detector.provider.provideParticipantDetection(\n\t\t\textRequest,\n\t\t\t{ history },\n\t\t\t{ participants: options.participants, location: typeConvert.ChatLocation.to(options.location) },\n\t\t\ttoken\n\t\t);\n\t}\n\n\tprivate async _createRequest(requestDto: Dto<IChatAgentRequest>, context: { history: IChatAgentHistoryEntryDto[] }, extension: IExtensionDescription) {\n\t\tconst request = revive<IChatAgentRequest>(requestDto);\n\t\tconst convertedHistory = await this.prepareHistoryTurns(extension, request.agentId, context);\n\n\t\t// in-place converting for location-data\n\t\tlet location: vscode.ChatRequestEditorData | vscode.ChatRequestNotebookData | undefined;\n\t\tif (request.locationData?.type === ChatAgentLocation.EditorInline) {\n\t\t\t// editor data\n\t\t\tconst document = this._documents.getDocument(request.locationData.document);\n\t\t\tlocation = new extHostTypes.ChatRequestEditorData(document, typeConvert.Selection.to(request.locationData.selection), typeConvert.Range.to(request.locationData.wholeRange));\n\n\t\t} else if (request.locationData?.type === ChatAgentLocation.Notebook) {\n\t\t\t// notebook data\n\t\t\tconst cell = this._documents.getDocument(request.locationData.sessionInputUri);\n\t\t\tlocation = new extHostTypes.ChatRequestNotebookData(cell);\n\n\t\t} else if (request.locationData?.type === ChatAgentLocation.Terminal) {\n\t\t\t// TBD\n\t\t}\n\n\t\treturn { request, location, history: convertedHistory };\n\t}\n\n\tprivate async getModelForRequest(request: IChatAgentRequest, extension: IExtensionDescription): Promise<vscode.LanguageModelChat> {\n\t\tlet model: vscode.LanguageModelChat | undefined;\n\t\tif (request.userSelectedModelId) {\n\t\t\tmodel = await this._languageModels.getLanguageModelByIdentifier(extension, request.userSelectedModelId);\n\t\t}\n\t\tif (!model) {\n\t\t\tmodel = await this._languageModels.getDefaultLanguageModel(extension);\n\t\t\tif (!model) {\n\t\t\t\tthrow new Error('Language model unavailable');\n\t\t\t}\n\t\t}\n\n\t\treturn model;\n\t}\n\n\n\tasync $setRequestTools(requestId: string, tools: UserSelectedTools) {\n\t\tconst request = [...this._inFlightRequests].find(r => r.requestId === requestId);\n\t\tif (!request) {\n\t\t\treturn;\n\t\t}\n\n\t\trequest.extRequest.tools.clear();\n\t\tfor (const [k, v] of this.getToolsForRequest(request.extension, tools)) {\n\t\t\trequest.extRequest.tools.set(k, v);\n\t\t}\n\t\tthis._onDidChangeChatRequestTools.fire(request.extRequest);\n\t}\n\n\tasync $invokeAgent(handle: number, requestDto: Dto<IChatAgentRequest>, context: { history: IChatAgentHistoryEntryDto[]; chatSessionContext?: IChatSessionContextDto }, token: CancellationToken): Promise<IChatAgentResult | undefined> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\tthrow new Error(`[CHAT](${handle}) CANNOT invoke agent because the agent is not registered`);\n\t\t}\n\n\t\tlet stream: ChatAgentResponseStream | undefined;\n\t\tlet inFlightRequest: InFlightChatRequest | undefined;\n\n\t\ttry {\n\t\t\tconst { request, location, history } = await this._createRequest(requestDto, context, agent.extension);\n\n\t\t\t// Init session disposables\n\t\t\tlet sessionDisposables = this._sessionDisposables.get(request.sessionId);\n\t\t\tif (!sessionDisposables) {\n\t\t\t\tsessionDisposables = new DisposableStore();\n\t\t\t\tthis._sessionDisposables.set(request.sessionId, sessionDisposables);\n\t\t\t}\n\n\t\t\tstream = new ChatAgentResponseStream(agent.extension, request, this._proxy, this._commands.converter, sessionDisposables);\n\n\t\t\tconst model = await this.getModelForRequest(request, agent.extension);\n\t\t\tconst extRequest = typeConvert.ChatAgentRequest.to(\n\t\t\t\trequest,\n\t\t\t\tlocation,\n\t\t\t\tmodel,\n\t\t\t\tthis.getDiagnosticsWhenEnabled(agent.extension),\n\t\t\t\tthis.getToolsForRequest(agent.extension, request.userSelectedTools),\n\t\t\t\tagent.extension,\n\t\t\t\tthis._logService\n\t\t\t);\n\t\t\tinFlightRequest = { requestId: requestDto.requestId, extRequest, extension: agent.extension };\n\t\t\tthis._inFlightRequests.add(inFlightRequest);\n\n\n\t\t\t// If this request originates from a contributed chat session editor, attempt to resolve the ChatSession API object\n\t\t\tlet chatSessionContext: vscode.ChatSessionContext | undefined;\n\t\t\tif (context.chatSessionContext) {\n\t\t\t\tchatSessionContext = {\n\t\t\t\t\tchatSessionItem: {\n\t\t\t\t\t\tresource: URI.revive(context.chatSessionContext.chatSessionResource),\n\t\t\t\t\t\tlabel: context.chatSessionContext.isUntitled ? 'Untitled Session' : 'Session',\n\t\t\t\t\t},\n\t\t\t\t\tisUntitled: context.chatSessionContext.isUntitled,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst chatContext: vscode.ChatContext = { history, chatSessionContext };\n\t\t\tconst task = agent.invoke(\n\t\t\t\textRequest,\n\t\t\t\tchatContext,\n\t\t\t\tstream.apiObject,\n\t\t\t\ttoken\n\t\t\t);\n\n\t\t\treturn await raceCancellationWithTimeout(1000, Promise.resolve(task).then((result) => {\n\t\t\t\tif (result?.metadata) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tJSON.stringify(result.metadata);\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\tconst msg = `result.metadata MUST be JSON.stringify-able. Got error: ${err.message}`;\n\t\t\t\t\t\tthis._logService.error(`[${agent.extension.identifier.value}] [@${agent.id}] ${msg}`, agent.extension);\n\t\t\t\t\t\treturn { errorDetails: { message: msg }, timings: stream?.timings, nextQuestion: result.nextQuestion, };\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet errorDetails: IChatResponseErrorDetails | undefined;\n\t\t\t\tif (result?.errorDetails) {\n\t\t\t\t\terrorDetails = {\n\t\t\t\t\t\t...result.errorDetails,\n\t\t\t\t\t\tresponseIsIncomplete: true\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tif (errorDetails?.responseIsRedacted || errorDetails?.isQuotaExceeded || errorDetails?.isRateLimited || errorDetails?.confirmationButtons || errorDetails?.code) {\n\t\t\t\t\tcheckProposedApiEnabled(agent.extension, 'chatParticipantPrivate');\n\t\t\t\t}\n\n\t\t\t\treturn { errorDetails, timings: stream?.timings, metadata: result?.metadata, nextQuestion: result?.nextQuestion, details: result?.details } satisfies IChatAgentResult;\n\t\t\t}), token);\n\t\t} catch (e) {\n\t\t\tthis._logService.error(e, agent.extension);\n\n\t\t\tif (e instanceof extHostTypes.LanguageModelError && e.cause) {\n\t\t\t\te = e.cause;\n\t\t\t}\n\n\t\t\tconst isQuotaExceeded = e instanceof Error && e.name === 'ChatQuotaExceeded';\n\t\t\tconst isRateLimited = e instanceof Error && e.name === 'ChatRateLimited';\n\t\t\treturn { errorDetails: { message: toErrorMessage(e), responseIsIncomplete: true, isQuotaExceeded, isRateLimited } };\n\n\t\t} finally {\n\t\t\tif (inFlightRequest) {\n\t\t\t\tthis._inFlightRequests.delete(inFlightRequest);\n\t\t\t}\n\t\t\tstream?.close();\n\t\t}\n\t}\n\n\tprivate getDiagnosticsWhenEnabled(extension: Readonly<IRelaxedExtensionDescription>) {\n\t\tif (!isProposedApiEnabled(extension, 'chatReferenceDiagnostic')) {\n\t\t\treturn [];\n\t\t}\n\t\treturn this._diagnostics.getDiagnostics();\n\t}\n\n\tprivate getToolsForRequest(extension: IExtensionDescription, tools: UserSelectedTools | undefined): Map<string, boolean> {\n\t\tif (!tools) {\n\t\t\treturn new Map();\n\t\t}\n\t\tconst result = new Map<string, boolean>();\n\t\tfor (const tool of this._tools.getTools(extension)) {\n\t\t\tif (typeof tools[tool.name] === 'boolean') {\n\t\t\t\tresult.set(tool.name, tools[tool.name]);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate async prepareHistoryTurns(extension: Readonly<IRelaxedExtensionDescription>, agentId: string, context: { history: IChatAgentHistoryEntryDto[] }): Promise<(vscode.ChatRequestTurn | vscode.ChatResponseTurn)[]> {\n\t\tconst res: (vscode.ChatRequestTurn | vscode.ChatResponseTurn)[] = [];\n\n\t\tfor (const h of context.history) {\n\t\t\tconst ehResult = typeConvert.ChatAgentResult.to(h.result);\n\t\t\tconst result: vscode.ChatResult = agentId === h.request.agentId ?\n\t\t\t\tehResult :\n\t\t\t\t{ ...ehResult, metadata: undefined };\n\n\t\t\t// REQUEST turn\n\t\t\tconst varsWithoutTools: vscode.ChatPromptReference[] = [];\n\t\t\tconst toolReferences: vscode.ChatLanguageModelToolReference[] = [];\n\t\t\tfor (const v of h.request.variables.variables) {\n\t\t\t\tif (v.kind === 'tool') {\n\t\t\t\t\ttoolReferences.push(typeConvert.ChatLanguageModelToolReference.to(v));\n\t\t\t\t} else if (v.kind === 'toolset') {\n\t\t\t\t\ttoolReferences.push(...v.value.map(typeConvert.ChatLanguageModelToolReference.to));\n\t\t\t\t} else {\n\t\t\t\t\tconst ref = typeConvert.ChatPromptReference.to(v, this.getDiagnosticsWhenEnabled(extension), this._logService);\n\t\t\t\t\tif (ref) {\n\t\t\t\t\t\tvarsWithoutTools.push(ref);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst editedFileEvents = isProposedApiEnabled(extension, 'chatParticipantPrivate') ? h.request.editedFileEvents : undefined;\n\t\t\tconst turn = new extHostTypes.ChatRequestTurn(h.request.message, h.request.command, varsWithoutTools, h.request.agentId, toolReferences, editedFileEvents);\n\t\t\tres.push(turn);\n\n\t\t\t// RESPONSE turn\n\t\t\tconst parts = coalesce(h.response.map(r => typeConvert.ChatResponsePart.toContent(r, this._commands.converter)));\n\t\t\tres.push(new extHostTypes.ChatResponseTurn(parts, result, h.request.agentId, h.request.command));\n\t\t}\n\n\t\treturn res;\n\t}\n\n\t$releaseSession(sessionId: string): void {\n\t\tthis._sessionDisposables.deleteAndDispose(sessionId);\n\t\tthis._onDidDisposeChatSession.fire(sessionId);\n\t}\n\n\tasync $provideFollowups(requestDto: Dto<IChatAgentRequest>, handle: number, result: IChatAgentResult, context: { history: IChatAgentHistoryEntryDto[] }, token: CancellationToken): Promise<IChatFollowup[]> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn Promise.resolve([]);\n\t\t}\n\n\t\tconst request = revive<IChatAgentRequest>(requestDto);\n\t\tconst convertedHistory = await this.prepareHistoryTurns(agent.extension, agent.id, context);\n\n\t\tconst ehResult = typeConvert.ChatAgentResult.to(result);\n\t\treturn (await agent.provideFollowups(ehResult, { history: convertedHistory }, token))\n\t\t\t.filter(f => {\n\t\t\t\t// The followup must refer to a participant that exists from the same extension\n\t\t\t\tconst isValid = !f.participant || Iterable.some(\n\t\t\t\t\tthis._agents.values(),\n\t\t\t\t\ta => a.id === f.participant && ExtensionIdentifier.equals(a.extension.identifier, agent.extension.identifier));\n\t\t\t\tif (!isValid) {\n\t\t\t\t\tthis._logService.warn(`[@${agent.id}] ChatFollowup refers to an unknown participant: ${f.participant}`);\n\t\t\t\t}\n\t\t\t\treturn isValid;\n\t\t\t})\n\t\t\t.map(f => typeConvert.ChatFollowup.from(f, request));\n\t}\n\n\t$acceptFeedback(handle: number, result: IChatAgentResult, voteAction: IChatVoteAction): void {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst ehResult = typeConvert.ChatAgentResult.to(result);\n\t\tlet kind: extHostTypes.ChatResultFeedbackKind;\n\t\tswitch (voteAction.direction) {\n\t\t\tcase ChatAgentVoteDirection.Down:\n\t\t\t\tkind = extHostTypes.ChatResultFeedbackKind.Unhelpful;\n\t\t\t\tbreak;\n\t\t\tcase ChatAgentVoteDirection.Up:\n\t\t\t\tkind = extHostTypes.ChatResultFeedbackKind.Helpful;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tconst feedback: vscode.ChatResultFeedback = {\n\t\t\tresult: ehResult,\n\t\t\tkind,\n\t\t\tunhelpfulReason: isProposedApiEnabled(agent.extension, 'chatParticipantAdditions') ? voteAction.reason : undefined,\n\t\t};\n\t\tagent.acceptFeedback(Object.freeze(feedback));\n\t}\n\n\t$acceptAction(handle: number, result: IChatAgentResult, event: IChatUserActionEvent): void {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\t\tif (event.action.kind === 'vote') {\n\t\t\t// handled by $acceptFeedback\n\t\t\treturn;\n\t\t}\n\n\t\tconst ehAction = typeConvert.ChatAgentUserActionEvent.to(result, event, this._commands.converter);\n\t\tif (ehAction) {\n\t\t\tagent.acceptAction(Object.freeze(ehAction));\n\t\t}\n\t}\n\n\tasync $invokeCompletionProvider(handle: number, query: string, token: CancellationToken): Promise<IChatAgentCompletionItem[]> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn [];\n\t\t}\n\n\t\tlet disposables = this._completionDisposables.get(handle);\n\t\tif (disposables) {\n\t\t\t// Clear any disposables from the last invocation of this completion provider\n\t\t\tdisposables.clear();\n\t\t} else {\n\t\t\tdisposables = new DisposableStore();\n\t\t\tthis._completionDisposables.set(handle, disposables);\n\t\t}\n\n\t\tconst items = await agent.invokeCompletionProvider(query, token);\n\n\t\treturn items.map((i) => typeConvert.ChatAgentCompletionItem.from(i, this._commands.converter, disposables));\n\t}\n\n\tasync $provideChatTitle(handle: number, context: IChatAgentHistoryEntryDto[], token: CancellationToken): Promise<string | undefined> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst history = await this.prepareHistoryTurns(agent.extension, agent.id, { history: context });\n\t\treturn await agent.provideTitle({ history }, token);\n\t}\n\n\tasync $provideChatSummary(handle: number, context: IChatAgentHistoryEntryDto[], token: CancellationToken): Promise<string | undefined> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst history = await this.prepareHistoryTurns(agent.extension, agent.id, { history: context });\n\t\treturn await agent.provideSummary({ history }, token);\n\t}\n}\n\nclass ExtHostParticipantDetector {\n\tconstructor(\n\t\tpublic readonly extension: IExtensionDescription,\n\t\tpublic readonly provider: vscode.ChatParticipantDetectionProvider,\n\t) { }\n}\n\nclass ExtHostRelatedFilesProvider {\n\tconstructor(\n\t\tpublic readonly extension: IExtensionDescription,\n\t\tpublic readonly provider: vscode.ChatRelatedFilesProvider,\n\t) { }\n}\n\nclass ExtHostChatAgent {\n\n\tprivate _followupProvider: vscode.ChatFollowupProvider | undefined;\n\tprivate _iconPath: vscode.Uri | { light: vscode.Uri; dark: vscode.Uri } | vscode.ThemeIcon | undefined;\n\tprivate _helpTextPrefix: string | vscode.MarkdownString | undefined;\n\tprivate _helpTextPostfix: string | vscode.MarkdownString | undefined;\n\tprivate _onDidReceiveFeedback = new Emitter<vscode.ChatResultFeedback>();\n\tprivate _onDidPerformAction = new Emitter<vscode.ChatUserActionEvent>();\n\tprivate _supportIssueReporting: boolean | undefined;\n\tprivate _agentVariableProvider?: { provider: vscode.ChatParticipantCompletionItemProvider; triggerCharacters: string[] };\n\tprivate _additionalWelcomeMessage?: string | vscode.MarkdownString | undefined;\n\tprivate _titleProvider?: vscode.ChatTitleProvider | undefined;\n\tprivate _summarizer?: vscode.ChatSummarizer | undefined;\n\tprivate _pauseStateEmitter = new Emitter<vscode.ChatParticipantPauseStateEvent>();\n\n\tconstructor(\n\t\tpublic readonly extension: IExtensionDescription,\n\t\tpublic readonly id: string,\n\t\tprivate readonly _proxy: MainThreadChatAgentsShape2,\n\t\tprivate readonly _handle: number,\n\t\tprivate _requestHandler: vscode.ChatExtendedRequestHandler,\n\t) { }\n\n\tacceptFeedback(feedback: vscode.ChatResultFeedback) {\n\t\tthis._onDidReceiveFeedback.fire(feedback);\n\t}\n\n\tacceptAction(event: vscode.ChatUserActionEvent) {\n\t\tthis._onDidPerformAction.fire(event);\n\t}\n\n\tsetChatRequestPauseState(pauseState: vscode.ChatParticipantPauseStateEvent) {\n\t\tthis._pauseStateEmitter.fire(pauseState);\n\t}\n\n\tasync invokeCompletionProvider(query: string, token: CancellationToken): Promise<vscode.ChatCompletionItem[]> {\n\t\tif (!this._agentVariableProvider) {\n\t\t\treturn [];\n\t\t}\n\n\t\treturn await this._agentVariableProvider.provider.provideCompletionItems(query, token) ?? [];\n\t}\n\n\tasync provideFollowups(result: vscode.ChatResult, context: vscode.ChatContext, token: CancellationToken): Promise<vscode.ChatFollowup[]> {\n\t\tif (!this._followupProvider) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst followups = await this._followupProvider.provideFollowups(result, context, token);\n\t\tif (!followups) {\n\t\t\treturn [];\n\t\t}\n\t\treturn followups\n\t\t\t// Filter out \"command followups\" from older providers\n\t\t\t.filter(f => !(f && 'commandId' in f))\n\t\t\t// Filter out followups from older providers before 'message' changed to 'prompt'\n\t\t\t.filter(f => !(f && 'message' in f));\n\t}\n\n\tasync provideTitle(context: vscode.ChatContext, token: CancellationToken): Promise<string | undefined> {\n\t\tif (!this._titleProvider) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn await this._titleProvider.provideChatTitle(context, token) ?? undefined;\n\t}\n\n\tasync provideSummary(context: vscode.ChatContext, token: CancellationToken): Promise<string | undefined> {\n\t\tif (!this._summarizer) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn await this._summarizer.provideChatSummary(context, token) ?? undefined;\n\t}\n\n\tget apiAgent(): vscode.ChatParticipant {\n\t\tlet disposed = false;\n\t\tlet updateScheduled = false;\n\t\tconst updateMetadataSoon = () => {\n\t\t\tif (disposed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (updateScheduled) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tupdateScheduled = true;\n\t\t\tqueueMicrotask(() => {\n\t\t\t\tthis._proxy.$updateAgent(this._handle, {\n\t\t\t\t\ticon: !this._iconPath ? undefined :\n\t\t\t\t\t\tthis._iconPath instanceof URI ? this._iconPath :\n\t\t\t\t\t\t\t'light' in this._iconPath ? this._iconPath.light :\n\t\t\t\t\t\t\t\tundefined,\n\t\t\t\t\ticonDark: !this._iconPath ? undefined :\n\t\t\t\t\t\t'dark' in this._iconPath ? this._iconPath.dark :\n\t\t\t\t\t\t\tundefined,\n\t\t\t\t\tthemeIcon: this._iconPath instanceof extHostTypes.ThemeIcon ? this._iconPath : undefined,\n\t\t\t\t\thasFollowups: this._followupProvider !== undefined,\n\t\t\t\t\thelpTextPrefix: (!this._helpTextPrefix || typeof this._helpTextPrefix === 'string') ? this._helpTextPrefix : typeConvert.MarkdownString.from(this._helpTextPrefix),\n\t\t\t\t\thelpTextPostfix: (!this._helpTextPostfix || typeof this._helpTextPostfix === 'string') ? this._helpTextPostfix : typeConvert.MarkdownString.from(this._helpTextPostfix),\n\t\t\t\t\tsupportIssueReporting: this._supportIssueReporting,\n\t\t\t\t\tadditionalWelcomeMessage: (!this._additionalWelcomeMessage || typeof this._additionalWelcomeMessage === 'string') ? this._additionalWelcomeMessage : typeConvert.MarkdownString.from(this._additionalWelcomeMessage),\n\t\t\t\t});\n\t\t\t\tupdateScheduled = false;\n\t\t\t});\n\t\t};\n\n\t\tconst that = this;\n\t\treturn {\n\t\t\tget id() {\n\t\t\t\treturn that.id;\n\t\t\t},\n\t\t\tget iconPath() {\n\t\t\t\treturn that._iconPath;\n\t\t\t},\n\t\t\tset iconPath(v) {\n\t\t\t\tthat._iconPath = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget requestHandler() {\n\t\t\t\treturn that._requestHandler;\n\t\t\t},\n\t\t\tset requestHandler(v) {\n\t\t\t\tassertType(typeof v === 'function', 'Invalid request handler');\n\t\t\t\tthat._requestHandler = v;\n\t\t\t},\n\t\t\tget followupProvider() {\n\t\t\t\treturn that._followupProvider;\n\t\t\t},\n\t\t\tset followupProvider(v) {\n\t\t\t\tthat._followupProvider = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget helpTextPrefix() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._helpTextPrefix;\n\t\t\t},\n\t\t\tset helpTextPrefix(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._helpTextPrefix = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget helpTextPostfix() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._helpTextPostfix;\n\t\t\t},\n\t\t\tset helpTextPostfix(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._helpTextPostfix = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget supportIssueReporting() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantPrivate');\n\t\t\t\treturn that._supportIssueReporting;\n\t\t\t},\n\t\t\tset supportIssueReporting(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantPrivate');\n\t\t\t\tthat._supportIssueReporting = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget onDidReceiveFeedback() {\n\t\t\t\treturn that._onDidReceiveFeedback.event;\n\t\t\t},\n\t\t\tset participantVariableProvider(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantAdditions');\n\t\t\t\tthat._agentVariableProvider = v;\n\t\t\t\tif (v) {\n\t\t\t\t\tif (!v.triggerCharacters.length) {\n\t\t\t\t\t\tthrow new Error('triggerCharacters are required');\n\t\t\t\t\t}\n\n\t\t\t\t\tthat._proxy.$registerAgentCompletionsProvider(that._handle, that.id, v.triggerCharacters);\n\t\t\t\t} else {\n\t\t\t\t\tthat._proxy.$unregisterAgentCompletionsProvider(that._handle, that.id);\n\t\t\t\t}\n\t\t\t},\n\t\t\tget participantVariableProvider() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantAdditions');\n\t\t\t\treturn that._agentVariableProvider;\n\t\t\t},\n\t\t\tset additionalWelcomeMessage(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._additionalWelcomeMessage = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget additionalWelcomeMessage() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._additionalWelcomeMessage;\n\t\t\t},\n\t\t\tset titleProvider(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._titleProvider = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget titleProvider() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._titleProvider;\n\t\t\t},\n\t\t\tset summarizer(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._summarizer = v;\n\t\t\t},\n\t\t\tget summarizer() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._summarizer;\n\t\t\t},\n\t\t\tget onDidChangePauseState() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantAdditions');\n\t\t\t\treturn that._pauseStateEmitter.event;\n\t\t\t},\n\t\t\tonDidPerformAction: !isProposedApiEnabled(this.extension, 'chatParticipantAdditions')\n\t\t\t\t? undefined!\n\t\t\t\t: this._onDidPerformAction.event\n\t\t\t,\n\t\t\tdispose() {\n\t\t\t\tdisposed = true;\n\t\t\t\tthat._followupProvider = undefined;\n\t\t\t\tthat._onDidReceiveFeedback.dispose();\n\t\t\t\tthat._proxy.$unregisterAgent(that._handle);\n\t\t\t},\n\t\t} satisfies vscode.ChatParticipant;\n\t}\n\n\tinvoke(request: vscode.ChatRequest, context: vscode.ChatContext, response: vscode.ChatResponseStream, token: CancellationToken): vscode.ProviderResult<vscode.ChatResult | void> {\n\t\treturn this._requestHandler(request, context, response, token);\n\t}\n}\n\n/**\n * raceCancellation, but give the promise a little time to complete to see if we can get a real result quickly.\n */\nfunction raceCancellationWithTimeout<T>(cancelWait: number, promise: Promise<T>, token: CancellationToken): Promise<T | undefined> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst ref = token.onCancellationRequested(async () => {\n\t\t\tref.dispose();\n\t\t\tawait timeout(cancelWait);\n\t\t\tresolve(undefined);\n\t\t});\n\t\tpromise.then(resolve, reject).finally(() => ref.dispose());\n\t});\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type * as vscode from 'vscode';\nimport { coalesce } from '../../../base/common/arrays.js';\nimport { timeout } from '../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { toErrorMessage } from '../../../base/common/errorMessage.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { Iterable } from '../../../base/common/iterator.js';\nimport { Disposable, DisposableMap, DisposableStore, toDisposable } from '../../../base/common/lifecycle.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { StopWatch } from '../../../base/common/stopwatch.js';\nimport { assertType } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { Location } from '../../../editor/common/languages.js';\nimport { ExtensionIdentifier, IExtensionDescription, IRelaxedExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { isChatViewTitleActionContext } from '../../contrib/chat/common/chatActions.js';\nimport { IChatAgentRequest, IChatAgentResult, IChatAgentResultTimings, UserSelectedTools } from '../../contrib/chat/common/chatAgents.js';\nimport { IChatRelatedFile, IChatRequestDraft } from '../../contrib/chat/common/chatEditingService.js';\nimport { ChatAgentVoteDirection, IChatContentReference, IChatFollowup, IChatResponseErrorDetails, IChatUserActionEvent, IChatVoteAction } from '../../contrib/chat/common/chatService.js';\nimport { ChatAgentLocation } from '../../contrib/chat/common/constants.js';\nimport { checkProposedApiEnabled, isProposedApiEnabled } from '../../services/extensions/common/extensions.js';\nimport { Dto } from '../../services/extensions/common/proxyIdentifier.js';\nimport { ExtHostChatAgentsShape2, IChatAgentCompletionItem, IChatAgentHistoryEntryDto, IChatAgentProgressShape, IChatProgressDto, IChatSessionContextDto, IExtensionChatAgentMetadata, IMainContext, MainContext, MainThreadChatAgentsShape2 } from './extHost.protocol.js';\nimport { CommandsConverter, ExtHostCommands } from './extHostCommands.js';\nimport { ExtHostDiagnostics } from './extHostDiagnostics.js';\nimport { ExtHostDocuments } from './extHostDocuments.js';\nimport { ExtHostLanguageModels } from './extHostLanguageModels.js';\nimport { ExtHostLanguageModelTools } from './extHostLanguageModelTools.js';\nimport * as typeConvert from './extHostTypeConverters.js';\nimport * as extHostTypes from './extHostTypes.js';\n\nexport class ChatAgentResponseStream {\n\n\tprivate _stopWatch = StopWatch.create(false);\n\tprivate _isClosed: boolean = false;\n\tprivate _firstProgress: number | undefined;\n\tprivate _apiObject: vscode.ChatResponseStream | undefined;\n\n\tconstructor(\n\t\tprivate readonly _extension: IExtensionDescription,\n\t\tprivate readonly _request: IChatAgentRequest,\n\t\tprivate readonly _proxy: IChatAgentProgressShape,\n\t\tprivate readonly _commandsConverter: CommandsConverter,\n\t\tprivate readonly _sessionDisposables: DisposableStore\n\t) { }\n\n\tclose() {\n\t\tthis._isClosed = true;\n\t}\n\n\tget timings(): IChatAgentResultTimings {\n\t\treturn {\n\t\t\tfirstProgress: this._firstProgress,\n\t\t\ttotalElapsed: this._stopWatch.elapsed()\n\t\t};\n\t}\n\n\tget apiObject() {\n\n\t\tif (!this._apiObject) {\n\n\t\t\tconst that = this;\n\t\t\tthis._stopWatch.reset();\n\n\n\t\t\tlet taskHandlePool = 0;\n\n\n\t\t\tfunction throwIfDone(source: Function | undefined) {\n\t\t\t\tif (that._isClosed) {\n\t\t\t\t\tconst err = new Error('Response stream has been closed');\n\t\t\t\t\tError.captureStackTrace(err, source);\n\t\t\t\t\tthrow err;\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\tconst sendQueue: (IChatProgressDto | [IChatProgressDto, number])[] = [];\n\t\t\tlet notify: Function[] = [];\n\n\t\t\tfunction send(chunk: IChatProgressDto): void;\n\t\t\tfunction send(chunk: IChatProgressDto, handle: number): Promise<void>;\n\t\t\tfunction send(chunk: IChatProgressDto, handle?: number) {\n\t\t\t\t// push data into send queue. the first entry schedules the micro task which\n\t\t\t\t// does the actual send to the main thread\n\t\t\t\tconst newLen = sendQueue.push(handle !== undefined ? [chunk, handle] : chunk);\n\t\t\t\tif (newLen === 1) {\n\t\t\t\t\tqueueMicrotask(() => {\n\t\t\t\t\t\tconst toNotify = notify;\n\t\t\t\t\t\tnotify = [];\n\t\t\t\t\t\tthat._proxy.$handleProgressChunk(that._request.requestId, sendQueue).finally(() => {\n\t\t\t\t\t\t\ttoNotify.forEach(f => f());\n\t\t\t\t\t\t});\n\t\t\t\t\t\tsendQueue.length = 0;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (handle !== undefined) {\n\t\t\t\t\treturn new Promise<void>(resolve => { notify.push(resolve); });\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst _report = (progress: IChatProgressDto, task?: (progress: vscode.Progress<vscode.ChatResponseWarningPart | vscode.ChatResponseReferencePart>) => Thenable<string | void>) => {\n\t\t\t\t// Measure the time to the first progress update with real markdown content\n\t\t\t\tif (typeof this._firstProgress === 'undefined' && (progress.kind === 'markdownContent' || progress.kind === 'markdownVuln' || progress.kind === 'prepareToolInvocation')) {\n\t\t\t\t\tthis._firstProgress = this._stopWatch.elapsed();\n\t\t\t\t}\n\n\t\t\t\tif (task) {\n\t\t\t\t\tconst myHandle = taskHandlePool++;\n\t\t\t\t\tconst progressReporterPromise = send(progress, myHandle);\n\t\t\t\t\tconst progressReporter = {\n\t\t\t\t\t\treport: (p: vscode.ChatResponseWarningPart | vscode.ChatResponseReferencePart) => {\n\t\t\t\t\t\t\tprogressReporterPromise.then(() => {\n\t\t\t\t\t\t\t\tif (extHostTypes.MarkdownString.isMarkdownString(p.value)) {\n\t\t\t\t\t\t\t\t\tsend(typeConvert.ChatResponseWarningPart.from(<vscode.ChatResponseWarningPart>p), myHandle);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tsend(typeConvert.ChatResponseReferencePart.from(<vscode.ChatResponseReferencePart>p), myHandle);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\n\t\t\t\t\tPromise.all([progressReporterPromise, task(progressReporter)]).then(([_void, res]) => {\n\t\t\t\t\t\tsend(typeConvert.ChatTaskResult.from(res), myHandle);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tsend(progress);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis._apiObject = Object.freeze<vscode.ChatResponseStream>({\n\t\t\t\tclearToPreviousToolInvocation(reason) {\n\t\t\t\t\tthrowIfDone(this.markdown);\n\t\t\t\t\tsend({ kind: 'clearToPreviousToolInvocation', reason: reason });\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tmarkdown(value) {\n\t\t\t\t\tthrowIfDone(this.markdown);\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseMarkdownPart(value);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseMarkdownPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tmarkdownWithVulnerabilities(value, vulnerabilities) {\n\t\t\t\t\tthrowIfDone(this.markdown);\n\t\t\t\t\tif (vulnerabilities) {\n\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseMarkdownWithVulnerabilitiesPart(value, vulnerabilities);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseMarkdownWithVulnerabilitiesPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tcodeblockUri(value, isEdit) {\n\t\t\t\t\tthrowIfDone(this.codeblockUri);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseCodeblockUriPart(value, isEdit);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseCodeblockUriPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tfiletree(value, baseUri) {\n\t\t\t\t\tthrowIfDone(this.filetree);\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseFileTreePart(value, baseUri);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseFilesPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tanchor(value, title?: string) {\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseAnchorPart(value, title);\n\t\t\t\t\treturn this.push(part);\n\t\t\t\t},\n\t\t\t\tbutton(value) {\n\t\t\t\t\tthrowIfDone(this.anchor);\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseCommandButtonPart(value);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseCommandButtonPart.from(part, that._commandsConverter, that._sessionDisposables);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tprogress(value, task?: ((progress: vscode.Progress<vscode.ChatResponseWarningPart>) => Thenable<string | void>)) {\n\t\t\t\t\tthrowIfDone(this.progress);\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseProgressPart2(value, task);\n\t\t\t\t\tconst dto = task ? typeConvert.ChatTask.from(part) : typeConvert.ChatResponseProgressPart.from(part);\n\t\t\t\t\t_report(dto, task);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tthinkingProgress(thinkingDelta: vscode.ThinkingDelta) {\n\t\t\t\t\tthrowIfDone(this.thinkingProgress);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseThinkingProgressPart(thinkingDelta.text ?? '', thinkingDelta.id, thinkingDelta.metadata);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseThinkingProgressPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\twarning(value) {\n\t\t\t\t\tthrowIfDone(this.progress);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseWarningPart(value);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseWarningPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\treference(value, iconPath) {\n\t\t\t\t\treturn this.reference2(value, iconPath);\n\t\t\t\t},\n\t\t\t\treference2(value, iconPath, options) {\n\t\t\t\t\tthrowIfDone(this.reference);\n\n\t\t\t\t\tif (typeof value === 'object' && 'variableName' in value) {\n\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof value === 'object' && 'variableName' in value && !value.value) {\n\t\t\t\t\t\t// The participant used this variable. Does that variable have any references to pull in?\n\t\t\t\t\t\tconst matchingVarData = that._request.variables.variables.find(v => v.name === value.variableName);\n\t\t\t\t\t\tif (matchingVarData) {\n\t\t\t\t\t\t\tlet references: Dto<IChatContentReference>[] | undefined;\n\t\t\t\t\t\t\tif (matchingVarData.references?.length) {\n\t\t\t\t\t\t\t\treferences = matchingVarData.references.map(r => ({\n\t\t\t\t\t\t\t\t\tkind: 'reference',\n\t\t\t\t\t\t\t\t\treference: { variableName: value.variableName, value: r.reference as URI | Location }\n\t\t\t\t\t\t\t\t} satisfies IChatContentReference));\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// Participant sent a variableName reference but the variable produced no references. Show variable reference with no value\n\t\t\t\t\t\t\t\tconst part = new extHostTypes.ChatResponseReferencePart(value, iconPath, options);\n\t\t\t\t\t\t\t\tconst dto = typeConvert.ChatResponseReferencePart.from(part);\n\t\t\t\t\t\t\t\treferences = [dto];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treferences.forEach(r => _report(r));\n\t\t\t\t\t\t\treturn this;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Something went wrong- that variable doesn't actually exist\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst part = new extHostTypes.ChatResponseReferencePart(value, iconPath, options);\n\t\t\t\t\t\tconst dto = typeConvert.ChatResponseReferencePart.from(part);\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tcodeCitation(value: vscode.Uri, license: string, snippet: string): void {\n\t\t\t\t\tthrowIfDone(this.codeCitation);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseCodeCitationPart(value, license, snippet);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseCodeCitationPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t},\n\t\t\t\ttextEdit(target, edits) {\n\t\t\t\t\tthrowIfDone(this.textEdit);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseTextEditPart(target, edits);\n\t\t\t\t\tpart.isDone = edits === true ? true : undefined;\n\t\t\t\t\tconst dto = typeConvert.ChatResponseTextEditPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tnotebookEdit(target, edits) {\n\t\t\t\t\tthrowIfDone(this.notebookEdit);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseNotebookEditPart(target, edits);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseNotebookEditPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tasync externalEdit(target, callback) {\n\t\t\t\t\tthrowIfDone(this.externalEdit);\n\t\t\t\t\tconst resources = Array.isArray(target) ? target : [target];\n\t\t\t\t\tconst operationId = taskHandlePool++;\n\n\t\t\t\t\tawait send({ kind: 'externalEdits', start: true, resources }, operationId);\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn await callback();\n\t\t\t\t\t} finally {\n\t\t\t\t\t\tawait send({ kind: 'externalEdits', start: false, resources }, operationId);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tconfirmation(title, message, data, buttons) {\n\t\t\t\t\tthrowIfDone(this.confirmation);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatResponseConfirmationPart(title, message, data, buttons);\n\t\t\t\t\tconst dto = typeConvert.ChatResponseConfirmationPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tprepareToolInvocation(toolName) {\n\t\t\t\t\tthrowIfDone(this.prepareToolInvocation);\n\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\tconst part = new extHostTypes.ChatPrepareToolInvocationPart(toolName);\n\t\t\t\t\tconst dto = typeConvert.ChatPrepareToolInvocationPart.from(part);\n\t\t\t\t\t_report(dto);\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t\tpush(part) {\n\t\t\t\t\tthrowIfDone(this.push);\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseTextEditPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseNotebookEditPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseMarkdownWithVulnerabilitiesPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseWarningPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseConfirmationPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseCodeCitationPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseMovePart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseExtensionsPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseExternalEditPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseThinkingProgressPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponsePullRequestPart ||\n\t\t\t\t\t\tpart instanceof extHostTypes.ChatResponseProgressPart2\n\t\t\t\t\t) {\n\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\t}\n\n\t\t\t\t\tif (part instanceof extHostTypes.ChatResponseReferencePart) {\n\t\t\t\t\t\t// Ensure variable reference values get fixed up\n\t\t\t\t\t\tthis.reference2(part.value, part.iconPath, part.options);\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatResponseProgressPart2) {\n\t\t\t\t\t\tconst dto = part.task ? typeConvert.ChatTask.from(part) : typeConvert.ChatResponseProgressPart.from(part);\n\t\t\t\t\t\t_report(dto, part.task);\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatResponseThinkingProgressPart) {\n\t\t\t\t\t\tconst dto = typeConvert.ChatResponseThinkingProgressPart.from(part);\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatResponseAnchorPart) {\n\t\t\t\t\t\tconst dto = typeConvert.ChatResponseAnchorPart.from(part);\n\n\t\t\t\t\t\tif (part.resolve) {\n\t\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\n\t\t\t\t\t\t\tdto.resolveId = generateUuid();\n\n\t\t\t\t\t\t\tconst cts = new CancellationTokenSource();\n\t\t\t\t\t\t\tpart.resolve(cts.token)\n\t\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\t\tconst resolvedDto = typeConvert.ChatResponseAnchorPart.from(part);\n\t\t\t\t\t\t\t\t\tthat._proxy.$handleAnchorResolve(that._request.requestId, dto.resolveId!, resolvedDto);\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(() => cts.dispose(), () => cts.dispose());\n\t\t\t\t\t\t\tthat._sessionDisposables.add(toDisposable(() => cts.dispose(true)));\n\t\t\t\t\t\t}\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatPrepareToolInvocationPart) {\n\t\t\t\t\t\tcheckProposedApiEnabled(that._extension, 'chatParticipantAdditions');\n\t\t\t\t\t\tconst dto = typeConvert.ChatPrepareToolInvocationPart.from(part);\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t\treturn this;\n\t\t\t\t\t} else if (part instanceof extHostTypes.ChatResponseExternalEditPart) {\n\t\t\t\t\t\tconst p = this.externalEdit(part.uris, part.callback);\n\t\t\t\t\t\tp.then(() => part.didGetApplied());\n\t\t\t\t\t\treturn this;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst dto = typeConvert.ChatResponsePart.from(part, that._commandsConverter, that._sessionDisposables);\n\t\t\t\t\t\t_report(dto);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\treturn this._apiObject;\n\t}\n}\n\ninterface InFlightChatRequest {\n\trequestId: string;\n\textRequest: vscode.ChatRequest;\n\textension: IRelaxedExtensionDescription;\n}\n\nexport class ExtHostChatAgents2 extends Disposable implements ExtHostChatAgentsShape2 {\n\n\tprivate static _idPool = 0;\n\n\tprivate readonly _agents = new Map<number, ExtHostChatAgent>();\n\tprivate readonly _proxy: MainThreadChatAgentsShape2;\n\n\tprivate static _participantDetectionProviderIdPool = 0;\n\tprivate readonly _participantDetectionProviders = new Map<number, ExtHostParticipantDetector>();\n\n\tprivate static _relatedFilesProviderIdPool = 0;\n\tprivate readonly _relatedFilesProviders = new Map<number, ExtHostRelatedFilesProvider>();\n\n\tprivate readonly _sessionDisposables: DisposableMap<string, DisposableStore> = this._register(new DisposableMap());\n\tprivate readonly _completionDisposables: DisposableMap<number, DisposableStore> = this._register(new DisposableMap());\n\n\tprivate readonly _inFlightRequests = new Set<InFlightChatRequest>();\n\n\tprivate readonly _onDidChangeChatRequestTools = this._register(new Emitter<vscode.ChatRequest>());\n\treadonly onDidChangeChatRequestTools = this._onDidChangeChatRequestTools.event;\n\n\tprivate readonly _onDidDisposeChatSession = this._register(new Emitter<string>());\n\treadonly onDidDisposeChatSession = this._onDidDisposeChatSession.event;\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _commands: ExtHostCommands,\n\t\tprivate readonly _documents: ExtHostDocuments,\n\t\tprivate readonly _languageModels: ExtHostLanguageModels,\n\t\tprivate readonly _diagnostics: ExtHostDiagnostics,\n\t\tprivate readonly _tools: ExtHostLanguageModelTools\n\t) {\n\t\tsuper();\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadChatAgents2);\n\n\t\t_commands.registerArgumentProcessor({\n\t\t\tprocessArgument: (arg) => {\n\t\t\t\t// Don't send this argument to extension commands\n\t\t\t\tif (isChatViewTitleActionContext(arg)) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn arg;\n\t\t\t}\n\t\t});\n\t}\n\n\ttransferActiveChat(newWorkspace: vscode.Uri): void {\n\t\tthis._proxy.$transferActiveChatSession(newWorkspace);\n\t}\n\n\tcreateChatAgent(extension: IExtensionDescription, id: string, handler: vscode.ChatExtendedRequestHandler): vscode.ChatParticipant {\n\t\tconst handle = ExtHostChatAgents2._idPool++;\n\t\tconst agent = new ExtHostChatAgent(extension, id, this._proxy, handle, handler);\n\t\tthis._agents.set(handle, agent);\n\n\t\tthis._proxy.$registerAgent(handle, extension.identifier, id, {}, undefined);\n\t\treturn agent.apiAgent;\n\t}\n\n\tcreateDynamicChatAgent(extension: IExtensionDescription, id: string, dynamicProps: vscode.DynamicChatParticipantProps, handler: vscode.ChatExtendedRequestHandler): vscode.ChatParticipant {\n\t\tconst handle = ExtHostChatAgents2._idPool++;\n\t\tconst agent = new ExtHostChatAgent(extension, id, this._proxy, handle, handler);\n\t\tthis._agents.set(handle, agent);\n\n\t\tthis._proxy.$registerAgent(handle, extension.identifier, id, { isSticky: true } satisfies IExtensionChatAgentMetadata, dynamicProps);\n\t\treturn agent.apiAgent;\n\t}\n\n\tregisterChatParticipantDetectionProvider(extension: IExtensionDescription, provider: vscode.ChatParticipantDetectionProvider): vscode.Disposable {\n\t\tconst handle = ExtHostChatAgents2._participantDetectionProviderIdPool++;\n\t\tthis._participantDetectionProviders.set(handle, new ExtHostParticipantDetector(extension, provider));\n\t\tthis._proxy.$registerChatParticipantDetectionProvider(handle);\n\t\treturn toDisposable(() => {\n\t\t\tthis._participantDetectionProviders.delete(handle);\n\t\t\tthis._proxy.$unregisterChatParticipantDetectionProvider(handle);\n\t\t});\n\t}\n\n\tregisterRelatedFilesProvider(extension: IExtensionDescription, provider: vscode.ChatRelatedFilesProvider, metadata: vscode.ChatRelatedFilesProviderMetadata): vscode.Disposable {\n\t\tconst handle = ExtHostChatAgents2._relatedFilesProviderIdPool++;\n\t\tthis._relatedFilesProviders.set(handle, new ExtHostRelatedFilesProvider(extension, provider));\n\t\tthis._proxy.$registerRelatedFilesProvider(handle, metadata);\n\t\treturn toDisposable(() => {\n\t\t\tthis._relatedFilesProviders.delete(handle);\n\t\t\tthis._proxy.$unregisterRelatedFilesProvider(handle);\n\t\t});\n\t}\n\n\tasync $provideRelatedFiles(handle: number, request: IChatRequestDraft, token: CancellationToken): Promise<Dto<IChatRelatedFile>[] | undefined> {\n\t\tconst provider = this._relatedFilesProviders.get(handle);\n\t\tif (!provider) {\n\t\t\treturn Promise.resolve([]);\n\t\t}\n\n\t\tconst extRequestDraft = typeConvert.ChatRequestDraft.to(request);\n\t\treturn await provider.provider.provideRelatedFiles(extRequestDraft, token) ?? undefined;\n\t}\n\n\tasync $detectChatParticipant(handle: number, requestDto: Dto<IChatAgentRequest>, context: { history: IChatAgentHistoryEntryDto[] }, options: { location: ChatAgentLocation; participants?: vscode.ChatParticipantMetadata[] }, token: CancellationToken): Promise<vscode.ChatParticipantDetectionResult | null | undefined> {\n\t\tconst detector = this._participantDetectionProviders.get(handle);\n\t\tif (!detector) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst { request, location, history } = await this._createRequest(requestDto, context, detector.extension);\n\n\t\tconst model = await this.getModelForRequest(request, detector.extension);\n\t\tconst extRequest = typeConvert.ChatAgentRequest.to(\n\t\t\trequest,\n\t\t\tlocation,\n\t\t\tmodel,\n\t\t\tthis.getDiagnosticsWhenEnabled(detector.extension),\n\t\t\tthis.getToolsForRequest(detector.extension, request.userSelectedTools),\n\t\t\tdetector.extension,\n\t\t\tthis._logService);\n\n\t\treturn detector.provider.provideParticipantDetection(\n\t\t\textRequest,\n\t\t\t{ history },\n\t\t\t{ participants: options.participants, location: typeConvert.ChatLocation.to(options.location) },\n\t\t\ttoken\n\t\t);\n\t}\n\n\tprivate async _createRequest(requestDto: Dto<IChatAgentRequest>, context: { history: IChatAgentHistoryEntryDto[] }, extension: IExtensionDescription) {\n\t\tconst request = revive<IChatAgentRequest>(requestDto);\n\t\tconst convertedHistory = await this.prepareHistoryTurns(extension, request.agentId, context);\n\n\t\t// in-place converting for location-data\n\t\tlet location: vscode.ChatRequestEditorData | vscode.ChatRequestNotebookData | undefined;\n\t\tif (request.locationData?.type === ChatAgentLocation.EditorInline) {\n\t\t\t// editor data\n\t\t\tconst document = this._documents.getDocument(request.locationData.document);\n\t\t\tlocation = new extHostTypes.ChatRequestEditorData(document, typeConvert.Selection.to(request.locationData.selection), typeConvert.Range.to(request.locationData.wholeRange));\n\n\t\t} else if (request.locationData?.type === ChatAgentLocation.Notebook) {\n\t\t\t// notebook data\n\t\t\tconst cell = this._documents.getDocument(request.locationData.sessionInputUri);\n\t\t\tlocation = new extHostTypes.ChatRequestNotebookData(cell);\n\n\t\t} else if (request.locationData?.type === ChatAgentLocation.Terminal) {\n\t\t\t// TBD\n\t\t}\n\n\t\treturn { request, location, history: convertedHistory };\n\t}\n\n\tprivate async getModelForRequest(request: IChatAgentRequest, extension: IExtensionDescription): Promise<vscode.LanguageModelChat> {\n\t\tlet model: vscode.LanguageModelChat | undefined;\n\t\tif (request.userSelectedModelId) {\n\t\t\tmodel = await this._languageModels.getLanguageModelByIdentifier(extension, request.userSelectedModelId);\n\t\t}\n\t\tif (!model) {\n\t\t\tmodel = await this._languageModels.getDefaultLanguageModel(extension);\n\t\t\tif (!model) {\n\t\t\t\tthrow new Error('Language model unavailable');\n\t\t\t}\n\t\t}\n\n\t\treturn model;\n\t}\n\n\n\tasync $setRequestTools(requestId: string, tools: UserSelectedTools) {\n\t\tconst request = [...this._inFlightRequests].find(r => r.requestId === requestId);\n\t\tif (!request) {\n\t\t\treturn;\n\t\t}\n\n\t\trequest.extRequest.tools.clear();\n\t\tfor (const [k, v] of this.getToolsForRequest(request.extension, tools)) {\n\t\t\trequest.extRequest.tools.set(k, v);\n\t\t}\n\t\tthis._onDidChangeChatRequestTools.fire(request.extRequest);\n\t}\n\n\tasync $invokeAgent(handle: number, requestDto: Dto<IChatAgentRequest>, context: { history: IChatAgentHistoryEntryDto[]; chatSessionContext?: IChatSessionContextDto }, token: CancellationToken): Promise<IChatAgentResult | undefined> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\tthrow new Error(`[CHAT](${handle}) CANNOT invoke agent because the agent is not registered`);\n\t\t}\n\n\t\tlet stream: ChatAgentResponseStream | undefined;\n\t\tlet inFlightRequest: InFlightChatRequest | undefined;\n\n\t\ttry {\n\t\t\tconst { request, location, history } = await this._createRequest(requestDto, context, agent.extension);\n\n\t\t\t// Init session disposables\n\t\t\tlet sessionDisposables = this._sessionDisposables.get(request.sessionId);\n\t\t\tif (!sessionDisposables) {\n\t\t\t\tsessionDisposables = new DisposableStore();\n\t\t\t\tthis._sessionDisposables.set(request.sessionId, sessionDisposables);\n\t\t\t}\n\n\t\t\tstream = new ChatAgentResponseStream(agent.extension, request, this._proxy, this._commands.converter, sessionDisposables);\n\n\t\t\tconst model = await this.getModelForRequest(request, agent.extension);\n\t\t\tconst extRequest = typeConvert.ChatAgentRequest.to(\n\t\t\t\trequest,\n\t\t\t\tlocation,\n\t\t\t\tmodel,\n\t\t\t\tthis.getDiagnosticsWhenEnabled(agent.extension),\n\t\t\t\tthis.getToolsForRequest(agent.extension, request.userSelectedTools),\n\t\t\t\tagent.extension,\n\t\t\t\tthis._logService\n\t\t\t);\n\t\t\tinFlightRequest = { requestId: requestDto.requestId, extRequest, extension: agent.extension };\n\t\t\tthis._inFlightRequests.add(inFlightRequest);\n\n\n\t\t\t// If this request originates from a contributed chat session editor, attempt to resolve the ChatSession API object\n\t\t\tlet chatSessionContext: vscode.ChatSessionContext | undefined;\n\t\t\tif (context.chatSessionContext) {\n\t\t\t\tchatSessionContext = {\n\t\t\t\t\tchatSessionItem: {\n\t\t\t\t\t\tresource: URI.revive(context.chatSessionContext.chatSessionResource),\n\t\t\t\t\t\tlabel: context.chatSessionContext.isUntitled ? 'Untitled Session' : 'Session',\n\t\t\t\t\t},\n\t\t\t\t\tisUntitled: context.chatSessionContext.isUntitled,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst chatContext: vscode.ChatContext = { history, chatSessionContext };\n\t\t\tconst task = agent.invoke(\n\t\t\t\textRequest,\n\t\t\t\tchatContext,\n\t\t\t\tstream.apiObject,\n\t\t\t\ttoken\n\t\t\t);\n\n\t\t\treturn await raceCancellationWithTimeout(1000, Promise.resolve(task).then((result) => {\n\t\t\t\tif (result?.metadata) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tJSON.stringify(result.metadata);\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\tconst msg = `result.metadata MUST be JSON.stringify-able. Got error: ${err.message}`;\n\t\t\t\t\t\tthis._logService.error(`[${agent.extension.identifier.value}] [@${agent.id}] ${msg}`, agent.extension);\n\t\t\t\t\t\treturn { errorDetails: { message: msg }, timings: stream?.timings, nextQuestion: result.nextQuestion, };\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet errorDetails: IChatResponseErrorDetails | undefined;\n\t\t\t\tif (result?.errorDetails) {\n\t\t\t\t\terrorDetails = {\n\t\t\t\t\t\t...result.errorDetails,\n\t\t\t\t\t\tresponseIsIncomplete: true\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\tif (errorDetails?.responseIsRedacted || errorDetails?.isQuotaExceeded || errorDetails?.isRateLimited || errorDetails?.confirmationButtons || errorDetails?.code) {\n\t\t\t\t\tcheckProposedApiEnabled(agent.extension, 'chatParticipantPrivate');\n\t\t\t\t}\n\n\t\t\t\treturn { errorDetails, timings: stream?.timings, metadata: result?.metadata, nextQuestion: result?.nextQuestion, details: result?.details } satisfies IChatAgentResult;\n\t\t\t}), token);\n\t\t} catch (e) {\n\t\t\tthis._logService.error(e, agent.extension);\n\n\t\t\tif (e instanceof extHostTypes.LanguageModelError && e.cause) {\n\t\t\t\te = e.cause;\n\t\t\t}\n\n\t\t\tconst isQuotaExceeded = e instanceof Error && e.name === 'ChatQuotaExceeded';\n\t\t\tconst isRateLimited = e instanceof Error && e.name === 'ChatRateLimited';\n\t\t\treturn { errorDetails: { message: toErrorMessage(e), responseIsIncomplete: true, isQuotaExceeded, isRateLimited } };\n\n\t\t} finally {\n\t\t\tif (inFlightRequest) {\n\t\t\t\tthis._inFlightRequests.delete(inFlightRequest);\n\t\t\t}\n\t\t\tstream?.close();\n\t\t}\n\t}\n\n\tprivate getDiagnosticsWhenEnabled(extension: Readonly<IRelaxedExtensionDescription>) {\n\t\tif (!isProposedApiEnabled(extension, 'chatReferenceDiagnostic')) {\n\t\t\treturn [];\n\t\t}\n\t\treturn this._diagnostics.getDiagnostics();\n\t}\n\n\tprivate getToolsForRequest(extension: IExtensionDescription, tools: UserSelectedTools | undefined): Map<string, boolean> {\n\t\tif (!tools) {\n\t\t\treturn new Map();\n\t\t}\n\t\tconst result = new Map<string, boolean>();\n\t\tfor (const tool of this._tools.getTools(extension)) {\n\t\t\tif (typeof tools[tool.name] === 'boolean') {\n\t\t\t\tresult.set(tool.name, tools[tool.name]);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate async prepareHistoryTurns(extension: Readonly<IRelaxedExtensionDescription>, agentId: string, context: { history: IChatAgentHistoryEntryDto[] }): Promise<(vscode.ChatRequestTurn | vscode.ChatResponseTurn)[]> {\n\t\tconst res: (vscode.ChatRequestTurn | vscode.ChatResponseTurn)[] = [];\n\n\t\tfor (const h of context.history) {\n\t\t\tconst ehResult = typeConvert.ChatAgentResult.to(h.result);\n\t\t\tconst result: vscode.ChatResult = agentId === h.request.agentId ?\n\t\t\t\tehResult :\n\t\t\t\t{ ...ehResult, metadata: undefined };\n\n\t\t\t// REQUEST turn\n\t\t\tconst varsWithoutTools: vscode.ChatPromptReference[] = [];\n\t\t\tconst toolReferences: vscode.ChatLanguageModelToolReference[] = [];\n\t\t\tfor (const v of h.request.variables.variables) {\n\t\t\t\tif (v.kind === 'tool') {\n\t\t\t\t\ttoolReferences.push(typeConvert.ChatLanguageModelToolReference.to(v));\n\t\t\t\t} else if (v.kind === 'toolset') {\n\t\t\t\t\ttoolReferences.push(...v.value.map(typeConvert.ChatLanguageModelToolReference.to));\n\t\t\t\t} else {\n\t\t\t\t\tconst ref = typeConvert.ChatPromptReference.to(v, this.getDiagnosticsWhenEnabled(extension), this._logService);\n\t\t\t\t\tif (ref) {\n\t\t\t\t\t\tvarsWithoutTools.push(ref);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst editedFileEvents = isProposedApiEnabled(extension, 'chatParticipantPrivate') ? h.request.editedFileEvents : undefined;\n\t\t\tconst turn = new extHostTypes.ChatRequestTurn(h.request.message, h.request.command, varsWithoutTools, h.request.agentId, toolReferences, editedFileEvents);\n\t\t\tres.push(turn);\n\n\t\t\t// RESPONSE turn\n\t\t\tconst parts = coalesce(h.response.map(r => typeConvert.ChatResponsePart.toContent(r, this._commands.converter)));\n\t\t\tres.push(new extHostTypes.ChatResponseTurn(parts, result, h.request.agentId, h.request.command));\n\t\t}\n\n\t\treturn res;\n\t}\n\n\t$releaseSession(sessionId: string): void {\n\t\tthis._sessionDisposables.deleteAndDispose(sessionId);\n\t\tthis._onDidDisposeChatSession.fire(sessionId);\n\t}\n\n\tasync $provideFollowups(requestDto: Dto<IChatAgentRequest>, handle: number, result: IChatAgentResult, context: { history: IChatAgentHistoryEntryDto[] }, token: CancellationToken): Promise<IChatFollowup[]> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn Promise.resolve([]);\n\t\t}\n\n\t\tconst request = revive<IChatAgentRequest>(requestDto);\n\t\tconst convertedHistory = await this.prepareHistoryTurns(agent.extension, agent.id, context);\n\n\t\tconst ehResult = typeConvert.ChatAgentResult.to(result);\n\t\treturn (await agent.provideFollowups(ehResult, { history: convertedHistory }, token))\n\t\t\t.filter(f => {\n\t\t\t\t// The followup must refer to a participant that exists from the same extension\n\t\t\t\tconst isValid = !f.participant || Iterable.some(\n\t\t\t\t\tthis._agents.values(),\n\t\t\t\t\ta => a.id === f.participant && ExtensionIdentifier.equals(a.extension.identifier, agent.extension.identifier));\n\t\t\t\tif (!isValid) {\n\t\t\t\t\tthis._logService.warn(`[@${agent.id}] ChatFollowup refers to an unknown participant: ${f.participant}`);\n\t\t\t\t}\n\t\t\t\treturn isValid;\n\t\t\t})\n\t\t\t.map(f => typeConvert.ChatFollowup.from(f, request));\n\t}\n\n\t$acceptFeedback(handle: number, result: IChatAgentResult, voteAction: IChatVoteAction): void {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst ehResult = typeConvert.ChatAgentResult.to(result);\n\t\tlet kind: extHostTypes.ChatResultFeedbackKind;\n\t\tswitch (voteAction.direction) {\n\t\t\tcase ChatAgentVoteDirection.Down:\n\t\t\t\tkind = extHostTypes.ChatResultFeedbackKind.Unhelpful;\n\t\t\t\tbreak;\n\t\t\tcase ChatAgentVoteDirection.Up:\n\t\t\t\tkind = extHostTypes.ChatResultFeedbackKind.Helpful;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tconst feedback: vscode.ChatResultFeedback = {\n\t\t\tresult: ehResult,\n\t\t\tkind,\n\t\t\tunhelpfulReason: isProposedApiEnabled(agent.extension, 'chatParticipantAdditions') ? voteAction.reason : undefined,\n\t\t};\n\t\tagent.acceptFeedback(Object.freeze(feedback));\n\t}\n\n\t$acceptAction(handle: number, result: IChatAgentResult, event: IChatUserActionEvent): void {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\t\tif (event.action.kind === 'vote') {\n\t\t\t// handled by $acceptFeedback\n\t\t\treturn;\n\t\t}\n\n\t\tconst ehAction = typeConvert.ChatAgentUserActionEvent.to(result, event, this._commands.converter);\n\t\tif (ehAction) {\n\t\t\tagent.acceptAction(Object.freeze(ehAction));\n\t\t}\n\t}\n\n\tasync $invokeCompletionProvider(handle: number, query: string, token: CancellationToken): Promise<IChatAgentCompletionItem[]> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn [];\n\t\t}\n\n\t\tlet disposables = this._completionDisposables.get(handle);\n\t\tif (disposables) {\n\t\t\t// Clear any disposables from the last invocation of this completion provider\n\t\t\tdisposables.clear();\n\t\t} else {\n\t\t\tdisposables = new DisposableStore();\n\t\t\tthis._completionDisposables.set(handle, disposables);\n\t\t}\n\n\t\tconst items = await agent.invokeCompletionProvider(query, token);\n\n\t\treturn items.map((i) => typeConvert.ChatAgentCompletionItem.from(i, this._commands.converter, disposables));\n\t}\n\n\tasync $provideChatTitle(handle: number, context: IChatAgentHistoryEntryDto[], token: CancellationToken): Promise<string | undefined> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst history = await this.prepareHistoryTurns(agent.extension, agent.id, { history: context });\n\t\treturn await agent.provideTitle({ history }, token);\n\t}\n\n\tasync $provideChatSummary(handle: number, context: IChatAgentHistoryEntryDto[], token: CancellationToken): Promise<string | undefined> {\n\t\tconst agent = this._agents.get(handle);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst history = await this.prepareHistoryTurns(agent.extension, agent.id, { history: context });\n\t\treturn await agent.provideSummary({ history }, token);\n\t}\n}\n\nclass ExtHostParticipantDetector {\n\tconstructor(\n\t\tpublic readonly extension: IExtensionDescription,\n\t\tpublic readonly provider: vscode.ChatParticipantDetectionProvider,\n\t) { }\n}\n\nclass ExtHostRelatedFilesProvider {\n\tconstructor(\n\t\tpublic readonly extension: IExtensionDescription,\n\t\tpublic readonly provider: vscode.ChatRelatedFilesProvider,\n\t) { }\n}\n\nclass ExtHostChatAgent {\n\n\tprivate _followupProvider: vscode.ChatFollowupProvider | undefined;\n\tprivate _iconPath: vscode.Uri | { light: vscode.Uri; dark: vscode.Uri } | vscode.ThemeIcon | undefined;\n\tprivate _helpTextPrefix: string | vscode.MarkdownString | undefined;\n\tprivate _helpTextPostfix: string | vscode.MarkdownString | undefined;\n\tprivate _onDidReceiveFeedback = new Emitter<vscode.ChatResultFeedback>();\n\tprivate _onDidPerformAction = new Emitter<vscode.ChatUserActionEvent>();\n\tprivate _supportIssueReporting: boolean | undefined;\n\tprivate _agentVariableProvider?: { provider: vscode.ChatParticipantCompletionItemProvider; triggerCharacters: string[] };\n\tprivate _additionalWelcomeMessage?: string | vscode.MarkdownString | undefined;\n\tprivate _titleProvider?: vscode.ChatTitleProvider | undefined;\n\tprivate _summarizer?: vscode.ChatSummarizer | undefined;\n\tprivate _pauseStateEmitter = new Emitter<vscode.ChatParticipantPauseStateEvent>();\n\n\tconstructor(\n\t\tpublic readonly extension: IExtensionDescription,\n\t\tpublic readonly id: string,\n\t\tprivate readonly _proxy: MainThreadChatAgentsShape2,\n\t\tprivate readonly _handle: number,\n\t\tprivate _requestHandler: vscode.ChatExtendedRequestHandler,\n\t) { }\n\n\tacceptFeedback(feedback: vscode.ChatResultFeedback) {\n\t\tthis._onDidReceiveFeedback.fire(feedback);\n\t}\n\n\tacceptAction(event: vscode.ChatUserActionEvent) {\n\t\tthis._onDidPerformAction.fire(event);\n\t}\n\n\tsetChatRequestPauseState(pauseState: vscode.ChatParticipantPauseStateEvent) {\n\t\tthis._pauseStateEmitter.fire(pauseState);\n\t}\n\n\tasync invokeCompletionProvider(query: string, token: CancellationToken): Promise<vscode.ChatCompletionItem[]> {\n\t\tif (!this._agentVariableProvider) {\n\t\t\treturn [];\n\t\t}\n\n\t\treturn await this._agentVariableProvider.provider.provideCompletionItems(query, token) ?? [];\n\t}\n\n\tasync provideFollowups(result: vscode.ChatResult, context: vscode.ChatContext, token: CancellationToken): Promise<vscode.ChatFollowup[]> {\n\t\tif (!this._followupProvider) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst followups = await this._followupProvider.provideFollowups(result, context, token);\n\t\tif (!followups) {\n\t\t\treturn [];\n\t\t}\n\t\treturn followups\n\t\t\t// Filter out \"command followups\" from older providers\n\t\t\t.filter(f => !(f && 'commandId' in f))\n\t\t\t// Filter out followups from older providers before 'message' changed to 'prompt'\n\t\t\t.filter(f => !(f && 'message' in f));\n\t}\n\n\tasync provideTitle(context: vscode.ChatContext, token: CancellationToken): Promise<string | undefined> {\n\t\tif (!this._titleProvider) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn await this._titleProvider.provideChatTitle(context, token) ?? undefined;\n\t}\n\n\tasync provideSummary(context: vscode.ChatContext, token: CancellationToken): Promise<string | undefined> {\n\t\tif (!this._summarizer) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn await this._summarizer.provideChatSummary(context, token) ?? undefined;\n\t}\n\n\tget apiAgent(): vscode.ChatParticipant {\n\t\tlet disposed = false;\n\t\tlet updateScheduled = false;\n\t\tconst updateMetadataSoon = () => {\n\t\t\tif (disposed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (updateScheduled) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tupdateScheduled = true;\n\t\t\tqueueMicrotask(() => {\n\t\t\t\tthis._proxy.$updateAgent(this._handle, {\n\t\t\t\t\ticon: !this._iconPath ? undefined :\n\t\t\t\t\t\tthis._iconPath instanceof URI ? this._iconPath :\n\t\t\t\t\t\t\t'light' in this._iconPath ? this._iconPath.light :\n\t\t\t\t\t\t\t\tundefined,\n\t\t\t\t\ticonDark: !this._iconPath ? undefined :\n\t\t\t\t\t\t'dark' in this._iconPath ? this._iconPath.dark :\n\t\t\t\t\t\t\tundefined,\n\t\t\t\t\tthemeIcon: this._iconPath instanceof extHostTypes.ThemeIcon ? this._iconPath : undefined,\n\t\t\t\t\thasFollowups: this._followupProvider !== undefined,\n\t\t\t\t\thelpTextPrefix: (!this._helpTextPrefix || typeof this._helpTextPrefix === 'string') ? this._helpTextPrefix : typeConvert.MarkdownString.from(this._helpTextPrefix),\n\t\t\t\t\thelpTextPostfix: (!this._helpTextPostfix || typeof this._helpTextPostfix === 'string') ? this._helpTextPostfix : typeConvert.MarkdownString.from(this._helpTextPostfix),\n\t\t\t\t\tsupportIssueReporting: this._supportIssueReporting,\n\t\t\t\t\tadditionalWelcomeMessage: (!this._additionalWelcomeMessage || typeof this._additionalWelcomeMessage === 'string') ? this._additionalWelcomeMessage : typeConvert.MarkdownString.from(this._additionalWelcomeMessage),\n\t\t\t\t});\n\t\t\t\tupdateScheduled = false;\n\t\t\t});\n\t\t};\n\n\t\tconst that = this;\n\t\treturn {\n\t\t\tget id() {\n\t\t\t\treturn that.id;\n\t\t\t},\n\t\t\tget iconPath() {\n\t\t\t\treturn that._iconPath;\n\t\t\t},\n\t\t\tset iconPath(v) {\n\t\t\t\tthat._iconPath = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget requestHandler() {\n\t\t\t\treturn that._requestHandler;\n\t\t\t},\n\t\t\tset requestHandler(v) {\n\t\t\t\tassertType(typeof v === 'function', 'Invalid request handler');\n\t\t\t\tthat._requestHandler = v;\n\t\t\t},\n\t\t\tget followupProvider() {\n\t\t\t\treturn that._followupProvider;\n\t\t\t},\n\t\t\tset followupProvider(v) {\n\t\t\t\tthat._followupProvider = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget helpTextPrefix() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._helpTextPrefix;\n\t\t\t},\n\t\t\tset helpTextPrefix(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._helpTextPrefix = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget helpTextPostfix() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._helpTextPostfix;\n\t\t\t},\n\t\t\tset helpTextPostfix(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._helpTextPostfix = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget supportIssueReporting() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantPrivate');\n\t\t\t\treturn that._supportIssueReporting;\n\t\t\t},\n\t\t\tset supportIssueReporting(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantPrivate');\n\t\t\t\tthat._supportIssueReporting = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget onDidReceiveFeedback() {\n\t\t\t\treturn that._onDidReceiveFeedback.event;\n\t\t\t},\n\t\t\tset participantVariableProvider(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantAdditions');\n\t\t\t\tthat._agentVariableProvider = v;\n\t\t\t\tif (v) {\n\t\t\t\t\tif (!v.triggerCharacters.length) {\n\t\t\t\t\t\tthrow new Error('triggerCharacters are required');\n\t\t\t\t\t}\n\n\t\t\t\t\tthat._proxy.$registerAgentCompletionsProvider(that._handle, that.id, v.triggerCharacters);\n\t\t\t\t} else {\n\t\t\t\t\tthat._proxy.$unregisterAgentCompletionsProvider(that._handle, that.id);\n\t\t\t\t}\n\t\t\t},\n\t\t\tget participantVariableProvider() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantAdditions');\n\t\t\t\treturn that._agentVariableProvider;\n\t\t\t},\n\t\t\tset additionalWelcomeMessage(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._additionalWelcomeMessage = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget additionalWelcomeMessage() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._additionalWelcomeMessage;\n\t\t\t},\n\t\t\tset titleProvider(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._titleProvider = v;\n\t\t\t\tupdateMetadataSoon();\n\t\t\t},\n\t\t\tget titleProvider() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._titleProvider;\n\t\t\t},\n\t\t\tset summarizer(v) {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\tthat._summarizer = v;\n\t\t\t},\n\t\t\tget summarizer() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'defaultChatParticipant');\n\t\t\t\treturn that._summarizer;\n\t\t\t},\n\t\t\tget onDidChangePauseState() {\n\t\t\t\tcheckProposedApiEnabled(that.extension, 'chatParticipantAdditions');\n\t\t\t\treturn that._pauseStateEmitter.event;\n\t\t\t},\n\t\t\tonDidPerformAction: !isProposedApiEnabled(this.extension, 'chatParticipantAdditions')\n\t\t\t\t? undefined!\n\t\t\t\t: this._onDidPerformAction.event\n\t\t\t,\n\t\t\tdispose() {\n\t\t\t\tdisposed = true;\n\t\t\t\tthat._followupProvider = undefined;\n\t\t\t\tthat._onDidReceiveFeedback.dispose();\n\t\t\t\tthat._proxy.$unregisterAgent(that._handle);\n\t\t\t},\n\t\t} satisfies vscode.ChatParticipant;\n\t}\n\n\tinvoke(request: vscode.ChatRequest, context: vscode.ChatContext, response: vscode.ChatResponseStream, token: CancellationToken): vscode.ProviderResult<vscode.ChatResult | void> {\n\t\treturn this._requestHandler(request, context, response, token);\n\t}\n}\n\n/**\n * raceCancellation, but give the promise a little time to complete to see if we can get a real result quickly.\n */\nfunction raceCancellationWithTimeout<T>(cancelWait: number, promise: Promise<T>, token: CancellationToken): Promise<T | undefined> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst ref = token.onCancellationRequested(async () => {\n\t\t\tref.dispose();\n\t\t\tawait timeout(cancelWait);\n\t\t\tresolve(undefined);\n\t\t});\n\t\tpromise.then(resolve, reject).finally(() => ref.dispose());\n\t});\n}\n"]}