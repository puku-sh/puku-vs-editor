{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostLanguageModelTools.ts","vs/workbench/api/common/extHostLanguageModelTools.ts"],"names":[],"mappings":"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","file":"extHostLanguageModelTools.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type * as vscode from 'vscode';\nimport { raceCancellation } from '../../../base/common/async.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { CancellationError } from '../../../base/common/errors.js';\nimport { Lazy } from '../../../base/common/lazy.js';\nimport { IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { IPreparedToolInvocation, isToolInvocationContext, IToolInvocation, IToolInvocationContext, IToolInvocationPreparationContext, IToolResult, ToolInvocationPresentation } from '../../contrib/chat/common/languageModelToolsService.js';\nimport { ExtensionEditToolId, InternalEditToolId } from '../../contrib/chat/common/tools/editFileTool.js';\nimport { InternalFetchWebPageToolId } from '../../contrib/chat/common/tools/tools.js';\nimport { SearchExtensionsToolId } from '../../contrib/extensions/common/searchExtensionsTool.js';\nimport { checkProposedApiEnabled, isProposedApiEnabled } from '../../services/extensions/common/extensions.js';\nimport { Dto, SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\nimport { ExtHostLanguageModelToolsShape, IMainContext, IToolDataDto, MainContext, MainThreadLanguageModelToolsShape } from './extHost.protocol.js';\nimport { ExtHostLanguageModels } from './extHostLanguageModels.js';\nimport * as typeConvert from './extHostTypeConverters.js';\n\nclass Tool {\n\n\tprivate _data: IToolDataDto;\n\tprivate _apiObject = new Lazy<vscode.LanguageModelToolInformation>(() => {\n\t\tconst that = this;\n\t\treturn Object.freeze({\n\t\t\tget name() { return that._data.id; },\n\t\t\tget description() { return that._data.modelDescription; },\n\t\t\tget inputSchema() { return that._data.inputSchema; },\n\t\t\tget tags() { return that._data.tags ?? []; },\n\t\t\tget source() { return undefined; }\n\t\t});\n\t});\n\n\tprivate _apiObjectWithChatParticipantAdditions = new Lazy<vscode.LanguageModelToolInformation>(() => {\n\t\tconst that = this;\n\t\tconst source = typeConvert.LanguageModelToolSource.to(that._data.source);\n\n\t\treturn Object.freeze({\n\t\t\tget name() { return that._data.id; },\n\t\t\tget description() { return that._data.modelDescription; },\n\t\t\tget inputSchema() { return that._data.inputSchema; },\n\t\t\tget tags() { return that._data.tags ?? []; },\n\t\t\tget source() { return source; }\n\t\t});\n\t});\n\n\tconstructor(data: IToolDataDto) {\n\t\tthis._data = data;\n\t}\n\n\tupdate(newData: IToolDataDto): void {\n\t\tthis._data = newData;\n\t}\n\n\tget data(): IToolDataDto {\n\t\treturn this._data;\n\t}\n\n\tget apiObject(): vscode.LanguageModelToolInformation {\n\t\treturn this._apiObject.value;\n\t}\n\n\tget apiObjectWithChatParticipantAdditions() {\n\t\treturn this._apiObjectWithChatParticipantAdditions.value;\n\t}\n}\n\nexport class ExtHostLanguageModelTools implements ExtHostLanguageModelToolsShape {\n\t/** A map of tools that were registered in this EH */\n\tprivate readonly _registeredTools = new Map<string, { extension: IExtensionDescription; tool: vscode.LanguageModelTool<Object> }>();\n\tprivate readonly _proxy: MainThreadLanguageModelToolsShape;\n\tprivate readonly _tokenCountFuncs = new Map</* call ID */string, (text: string, token?: vscode.CancellationToken) => Thenable<number>>();\n\n\t/** A map of all known tools, from other EHs or registered in vscode core */\n\tprivate readonly _allTools = new Map<string, Tool>();\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tprivate readonly _languageModels: ExtHostLanguageModels,\n\t) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadLanguageModelTools);\n\n\t\tthis._proxy.$getTools().then(tools => {\n\t\t\tfor (const tool of tools) {\n\t\t\t\tthis._allTools.set(tool.id, new Tool(revive(tool)));\n\t\t\t}\n\t\t});\n\t}\n\n\tasync $countTokensForInvocation(callId: string, input: string, token: CancellationToken): Promise<number> {\n\t\tconst fn = this._tokenCountFuncs.get(callId);\n\t\tif (!fn) {\n\t\t\tthrow new Error(`Tool invocation call ${callId} not found`);\n\t\t}\n\n\t\treturn await fn(input, token);\n\t}\n\n\tasync invokeTool(extension: IExtensionDescription, toolId: string, options: vscode.LanguageModelToolInvocationOptions<any>, token?: CancellationToken): Promise<vscode.LanguageModelToolResult> {\n\t\tconst callId = generateUuid();\n\t\tif (options.tokenizationOptions) {\n\t\t\tthis._tokenCountFuncs.set(callId, options.tokenizationOptions.countTokens);\n\t\t}\n\n\t\ttry {\n\t\t\tif (options.toolInvocationToken && !isToolInvocationContext(options.toolInvocationToken)) {\n\t\t\t\tthrow new Error(`Invalid tool invocation token`);\n\t\t\t}\n\n\t\t\tif ((toolId === InternalEditToolId || toolId === ExtensionEditToolId) && !isProposedApiEnabled(extension, 'chatParticipantPrivate')) {\n\t\t\t\tthrow new Error(`Invalid tool: ${toolId}`);\n\t\t\t}\n\n\t\t\t// Making the round trip here because not all tools were necessarily registered in this EH\n\t\t\tconst result = await this._proxy.$invokeTool({\n\t\t\t\ttoolId,\n\t\t\t\tcallId,\n\t\t\t\tparameters: options.input,\n\t\t\t\ttokenBudget: options.tokenizationOptions?.tokenBudget,\n\t\t\t\tcontext: options.toolInvocationToken as IToolInvocationContext | undefined,\n\t\t\t\tchatRequestId: isProposedApiEnabled(extension, 'chatParticipantPrivate') ? options.chatRequestId : undefined,\n\t\t\t\tchatInteractionId: isProposedApiEnabled(extension, 'chatParticipantPrivate') ? options.chatInteractionId : undefined,\n\t\t\t\tfromSubAgent: isProposedApiEnabled(extension, 'chatParticipantPrivate') ? options.fromSubAgent : undefined,\n\t\t\t}, token);\n\n\t\t\tconst dto: Dto<IToolResult> = result instanceof SerializableObjectWithBuffers ? result.value : result;\n\t\t\treturn typeConvert.LanguageModelToolResult.to(revive(dto));\n\t\t} finally {\n\t\t\tthis._tokenCountFuncs.delete(callId);\n\t\t}\n\t}\n\n\t$onDidChangeTools(tools: IToolDataDto[]): void {\n\n\t\tconst oldTools = new Set(this._registeredTools.keys());\n\n\t\tfor (const tool of tools) {\n\t\t\toldTools.delete(tool.id);\n\t\t\tconst existing = this._allTools.get(tool.id);\n\t\t\tif (existing) {\n\t\t\t\texisting.update(tool);\n\t\t\t} else {\n\t\t\t\tthis._allTools.set(tool.id, new Tool(revive(tool)));\n\t\t\t}\n\t\t}\n\n\t\tfor (const id of oldTools) {\n\t\t\tthis._allTools.delete(id);\n\t\t}\n\t}\n\n\tgetTools(extension: IExtensionDescription): vscode.LanguageModelToolInformation[] {\n\t\tconst hasParticipantAdditions = isProposedApiEnabled(extension, 'chatParticipantPrivate');\n\t\treturn Array.from(this._allTools.values())\n\t\t\t.map(tool => hasParticipantAdditions ? tool.apiObjectWithChatParticipantAdditions : tool.apiObject)\n\t\t\t.filter(tool => {\n\t\t\t\tswitch (tool.name) {\n\t\t\t\t\tcase InternalEditToolId:\n\t\t\t\t\tcase ExtensionEditToolId:\n\t\t\t\t\tcase InternalFetchWebPageToolId:\n\t\t\t\t\tcase SearchExtensionsToolId:\n\t\t\t\t\t\treturn isProposedApiEnabled(extension, 'chatParticipantPrivate');\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tasync $invokeTool(dto: Dto<IToolInvocation>, token: CancellationToken): Promise<Dto<IToolResult> | SerializableObjectWithBuffers<Dto<IToolResult>>> {\n\t\tconst item = this._registeredTools.get(dto.toolId);\n\t\tif (!item) {\n\t\t\tthrow new Error(`Unknown tool ${dto.toolId}`);\n\t\t}\n\n\t\tconst options: vscode.LanguageModelToolInvocationOptions<Object> = {\n\t\t\tinput: dto.parameters,\n\t\t\ttoolInvocationToken: revive(dto.context) as unknown as vscode.ChatParticipantToolToken | undefined,\n\t\t};\n\t\tif (isProposedApiEnabled(item.extension, 'chatParticipantPrivate')) {\n\t\t\toptions.chatRequestId = dto.chatRequestId;\n\t\t\toptions.chatInteractionId = dto.chatInteractionId;\n\t\t\toptions.chatSessionId = dto.context?.sessionId;\n\t\t\toptions.fromSubAgent = dto.fromSubAgent;\n\t\t}\n\n\t\tif (isProposedApiEnabled(item.extension, 'chatParticipantAdditions') && dto.modelId) {\n\t\t\toptions.model = await this.getModel(dto.modelId, item.extension);\n\t\t}\n\n\t\tif (dto.tokenBudget !== undefined) {\n\t\t\toptions.tokenizationOptions = {\n\t\t\t\ttokenBudget: dto.tokenBudget,\n\t\t\t\tcountTokens: this._tokenCountFuncs.get(dto.callId) || ((value, token = CancellationToken.None) =>\n\t\t\t\t\tthis._proxy.$countTokensForInvocation(dto.callId, value, token))\n\t\t\t};\n\t\t}\n\n\t\tlet progress: vscode.Progress<{ message?: string | vscode.MarkdownString; increment?: number }> | undefined;\n\t\tif (isProposedApiEnabled(item.extension, 'toolProgress')) {\n\t\t\tlet lastProgress: number | undefined;\n\t\t\tprogress = {\n\t\t\t\treport: value => {\n\t\t\t\t\tif (value.increment !== undefined) {\n\t\t\t\t\t\tlastProgress = (lastProgress ?? 0) + value.increment;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._proxy.$acceptToolProgress(dto.callId, {\n\t\t\t\t\t\tmessage: typeConvert.MarkdownString.fromStrict(value.message),\n\t\t\t\t\t\tprogress: lastProgress === undefined ? undefined : lastProgress / 100,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\t// todo: 'any' cast because TS can't handle the overloads\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tconst extensionResult = await raceCancellation(Promise.resolve((item.tool.invoke as any)(options, token, progress!)), token);\n\t\tif (!extensionResult) {\n\t\t\tthrow new CancellationError();\n\t\t}\n\n\t\treturn typeConvert.LanguageModelToolResult.from(extensionResult, item.extension);\n\t}\n\n\tprivate async getModel(modelId: string, extension: IExtensionDescription): Promise<vscode.LanguageModelChat> {\n\t\tlet model: vscode.LanguageModelChat | undefined;\n\t\tif (modelId) {\n\t\t\tmodel = await this._languageModels.getLanguageModelByIdentifier(extension, modelId);\n\t\t}\n\t\tif (!model) {\n\t\t\tmodel = await this._languageModels.getDefaultLanguageModel(extension);\n\t\t\tif (!model) {\n\t\t\t\tthrow new Error('Language model unavailable');\n\t\t\t}\n\t\t}\n\n\t\treturn model;\n\t}\n\n\tasync $prepareToolInvocation(toolId: string, context: IToolInvocationPreparationContext, token: CancellationToken): Promise<IPreparedToolInvocation | undefined> {\n\t\tconst item = this._registeredTools.get(toolId);\n\t\tif (!item) {\n\t\t\tthrow new Error(`Unknown tool ${toolId}`);\n\t\t}\n\n\t\tconst options: vscode.LanguageModelToolInvocationPrepareOptions<any> = {\n\t\t\tinput: context.parameters,\n\t\t\tchatRequestId: context.chatRequestId,\n\t\t\tchatSessionId: context.chatSessionId,\n\t\t\tchatInteractionId: context.chatInteractionId\n\t\t};\n\t\tif (item.tool.prepareInvocation) {\n\t\t\tconst result = await item.tool.prepareInvocation(options, token);\n\t\t\tif (!result) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tif (result.pastTenseMessage || result.presentation) {\n\t\t\t\tcheckProposedApiEnabled(item.extension, 'chatParticipantPrivate');\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tconfirmationMessages: result.confirmationMessages ? {\n\t\t\t\t\ttitle: typeof result.confirmationMessages.title === 'string' ? result.confirmationMessages.title : typeConvert.MarkdownString.from(result.confirmationMessages.title),\n\t\t\t\t\tmessage: typeof result.confirmationMessages.message === 'string' ? result.confirmationMessages.message : typeConvert.MarkdownString.from(result.confirmationMessages.message),\n\t\t\t\t} : undefined,\n\t\t\t\tinvocationMessage: typeConvert.MarkdownString.fromStrict(result.invocationMessage),\n\t\t\t\tpastTenseMessage: typeConvert.MarkdownString.fromStrict(result.pastTenseMessage),\n\t\t\t\tpresentation: result.presentation as ToolInvocationPresentation | undefined\n\t\t\t};\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tregisterTool(extension: IExtensionDescription, id: string, tool: vscode.LanguageModelTool<any>): IDisposable {\n\t\tthis._registeredTools.set(id, { extension, tool });\n\t\tthis._proxy.$registerTool(id);\n\n\t\treturn toDisposable(() => {\n\t\t\tthis._registeredTools.delete(id);\n\t\t\tthis._proxy.$unregisterTool(id);\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type * as vscode from 'vscode';\nimport { raceCancellation } from '../../../base/common/async.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { CancellationError } from '../../../base/common/errors.js';\nimport { Lazy } from '../../../base/common/lazy.js';\nimport { IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { revive } from '../../../base/common/marshalling.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { IPreparedToolInvocation, isToolInvocationContext, IToolInvocation, IToolInvocationContext, IToolInvocationPreparationContext, IToolResult, ToolInvocationPresentation } from '../../contrib/chat/common/languageModelToolsService.js';\nimport { ExtensionEditToolId, InternalEditToolId } from '../../contrib/chat/common/tools/editFileTool.js';\nimport { InternalFetchWebPageToolId } from '../../contrib/chat/common/tools/tools.js';\nimport { SearchExtensionsToolId } from '../../contrib/extensions/common/searchExtensionsTool.js';\nimport { checkProposedApiEnabled, isProposedApiEnabled } from '../../services/extensions/common/extensions.js';\nimport { Dto, SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\nimport { ExtHostLanguageModelToolsShape, IMainContext, IToolDataDto, MainContext, MainThreadLanguageModelToolsShape } from './extHost.protocol.js';\nimport { ExtHostLanguageModels } from './extHostLanguageModels.js';\nimport * as typeConvert from './extHostTypeConverters.js';\n\nclass Tool {\n\n\tprivate _data: IToolDataDto;\n\tprivate _apiObject = new Lazy<vscode.LanguageModelToolInformation>(() => {\n\t\tconst that = this;\n\t\treturn Object.freeze({\n\t\t\tget name() { return that._data.id; },\n\t\t\tget description() { return that._data.modelDescription; },\n\t\t\tget inputSchema() { return that._data.inputSchema; },\n\t\t\tget tags() { return that._data.tags ?? []; },\n\t\t\tget source() { return undefined; }\n\t\t});\n\t});\n\n\tprivate _apiObjectWithChatParticipantAdditions = new Lazy<vscode.LanguageModelToolInformation>(() => {\n\t\tconst that = this;\n\t\tconst source = typeConvert.LanguageModelToolSource.to(that._data.source);\n\n\t\treturn Object.freeze({\n\t\t\tget name() { return that._data.id; },\n\t\t\tget description() { return that._data.modelDescription; },\n\t\t\tget inputSchema() { return that._data.inputSchema; },\n\t\t\tget tags() { return that._data.tags ?? []; },\n\t\t\tget source() { return source; }\n\t\t});\n\t});\n\n\tconstructor(data: IToolDataDto) {\n\t\tthis._data = data;\n\t}\n\n\tupdate(newData: IToolDataDto): void {\n\t\tthis._data = newData;\n\t}\n\n\tget data(): IToolDataDto {\n\t\treturn this._data;\n\t}\n\n\tget apiObject(): vscode.LanguageModelToolInformation {\n\t\treturn this._apiObject.value;\n\t}\n\n\tget apiObjectWithChatParticipantAdditions() {\n\t\treturn this._apiObjectWithChatParticipantAdditions.value;\n\t}\n}\n\nexport class ExtHostLanguageModelTools implements ExtHostLanguageModelToolsShape {\n\t/** A map of tools that were registered in this EH */\n\tprivate readonly _registeredTools = new Map<string, { extension: IExtensionDescription; tool: vscode.LanguageModelTool<Object> }>();\n\tprivate readonly _proxy: MainThreadLanguageModelToolsShape;\n\tprivate readonly _tokenCountFuncs = new Map</* call ID */string, (text: string, token?: vscode.CancellationToken) => Thenable<number>>();\n\n\t/** A map of all known tools, from other EHs or registered in vscode core */\n\tprivate readonly _allTools = new Map<string, Tool>();\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tprivate readonly _languageModels: ExtHostLanguageModels,\n\t) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadLanguageModelTools);\n\n\t\tthis._proxy.$getTools().then(tools => {\n\t\t\tfor (const tool of tools) {\n\t\t\t\tthis._allTools.set(tool.id, new Tool(revive(tool)));\n\t\t\t}\n\t\t});\n\t}\n\n\tasync $countTokensForInvocation(callId: string, input: string, token: CancellationToken): Promise<number> {\n\t\tconst fn = this._tokenCountFuncs.get(callId);\n\t\tif (!fn) {\n\t\t\tthrow new Error(`Tool invocation call ${callId} not found`);\n\t\t}\n\n\t\treturn await fn(input, token);\n\t}\n\n\tasync invokeTool(extension: IExtensionDescription, toolId: string, options: vscode.LanguageModelToolInvocationOptions<any>, token?: CancellationToken): Promise<vscode.LanguageModelToolResult> {\n\t\tconst callId = generateUuid();\n\t\tif (options.tokenizationOptions) {\n\t\t\tthis._tokenCountFuncs.set(callId, options.tokenizationOptions.countTokens);\n\t\t}\n\n\t\ttry {\n\t\t\tif (options.toolInvocationToken && !isToolInvocationContext(options.toolInvocationToken)) {\n\t\t\t\tthrow new Error(`Invalid tool invocation token`);\n\t\t\t}\n\n\t\t\tif ((toolId === InternalEditToolId || toolId === ExtensionEditToolId) && !isProposedApiEnabled(extension, 'chatParticipantPrivate')) {\n\t\t\t\tthrow new Error(`Invalid tool: ${toolId}`);\n\t\t\t}\n\n\t\t\t// Making the round trip here because not all tools were necessarily registered in this EH\n\t\t\tconst result = await this._proxy.$invokeTool({\n\t\t\t\ttoolId,\n\t\t\t\tcallId,\n\t\t\t\tparameters: options.input,\n\t\t\t\ttokenBudget: options.tokenizationOptions?.tokenBudget,\n\t\t\t\tcontext: options.toolInvocationToken as IToolInvocationContext | undefined,\n\t\t\t\tchatRequestId: isProposedApiEnabled(extension, 'chatParticipantPrivate') ? options.chatRequestId : undefined,\n\t\t\t\tchatInteractionId: isProposedApiEnabled(extension, 'chatParticipantPrivate') ? options.chatInteractionId : undefined,\n\t\t\t\tfromSubAgent: isProposedApiEnabled(extension, 'chatParticipantPrivate') ? options.fromSubAgent : undefined,\n\t\t\t}, token);\n\n\t\t\tconst dto: Dto<IToolResult> = result instanceof SerializableObjectWithBuffers ? result.value : result;\n\t\t\treturn typeConvert.LanguageModelToolResult.to(revive(dto));\n\t\t} finally {\n\t\t\tthis._tokenCountFuncs.delete(callId);\n\t\t}\n\t}\n\n\t$onDidChangeTools(tools: IToolDataDto[]): void {\n\n\t\tconst oldTools = new Set(this._registeredTools.keys());\n\n\t\tfor (const tool of tools) {\n\t\t\toldTools.delete(tool.id);\n\t\t\tconst existing = this._allTools.get(tool.id);\n\t\t\tif (existing) {\n\t\t\t\texisting.update(tool);\n\t\t\t} else {\n\t\t\t\tthis._allTools.set(tool.id, new Tool(revive(tool)));\n\t\t\t}\n\t\t}\n\n\t\tfor (const id of oldTools) {\n\t\t\tthis._allTools.delete(id);\n\t\t}\n\t}\n\n\tgetTools(extension: IExtensionDescription): vscode.LanguageModelToolInformation[] {\n\t\tconst hasParticipantAdditions = isProposedApiEnabled(extension, 'chatParticipantPrivate');\n\t\treturn Array.from(this._allTools.values())\n\t\t\t.map(tool => hasParticipantAdditions ? tool.apiObjectWithChatParticipantAdditions : tool.apiObject)\n\t\t\t.filter(tool => {\n\t\t\t\tswitch (tool.name) {\n\t\t\t\t\tcase InternalEditToolId:\n\t\t\t\t\tcase ExtensionEditToolId:\n\t\t\t\t\tcase InternalFetchWebPageToolId:\n\t\t\t\t\tcase SearchExtensionsToolId:\n\t\t\t\t\t\treturn isProposedApiEnabled(extension, 'chatParticipantPrivate');\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tasync $invokeTool(dto: Dto<IToolInvocation>, token: CancellationToken): Promise<Dto<IToolResult> | SerializableObjectWithBuffers<Dto<IToolResult>>> {\n\t\tconst item = this._registeredTools.get(dto.toolId);\n\t\tif (!item) {\n\t\t\tthrow new Error(`Unknown tool ${dto.toolId}`);\n\t\t}\n\n\t\tconst options: vscode.LanguageModelToolInvocationOptions<Object> = {\n\t\t\tinput: dto.parameters,\n\t\t\ttoolInvocationToken: revive(dto.context) as unknown as vscode.ChatParticipantToolToken | undefined,\n\t\t};\n\t\tif (isProposedApiEnabled(item.extension, 'chatParticipantPrivate')) {\n\t\t\toptions.chatRequestId = dto.chatRequestId;\n\t\t\toptions.chatInteractionId = dto.chatInteractionId;\n\t\t\toptions.chatSessionId = dto.context?.sessionId;\n\t\t\toptions.fromSubAgent = dto.fromSubAgent;\n\t\t}\n\n\t\tif (isProposedApiEnabled(item.extension, 'chatParticipantAdditions') && dto.modelId) {\n\t\t\toptions.model = await this.getModel(dto.modelId, item.extension);\n\t\t}\n\n\t\tif (dto.tokenBudget !== undefined) {\n\t\t\toptions.tokenizationOptions = {\n\t\t\t\ttokenBudget: dto.tokenBudget,\n\t\t\t\tcountTokens: this._tokenCountFuncs.get(dto.callId) || ((value, token = CancellationToken.None) =>\n\t\t\t\t\tthis._proxy.$countTokensForInvocation(dto.callId, value, token))\n\t\t\t};\n\t\t}\n\n\t\tlet progress: vscode.Progress<{ message?: string | vscode.MarkdownString; increment?: number }> | undefined;\n\t\tif (isProposedApiEnabled(item.extension, 'toolProgress')) {\n\t\t\tlet lastProgress: number | undefined;\n\t\t\tprogress = {\n\t\t\t\treport: value => {\n\t\t\t\t\tif (value.increment !== undefined) {\n\t\t\t\t\t\tlastProgress = (lastProgress ?? 0) + value.increment;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._proxy.$acceptToolProgress(dto.callId, {\n\t\t\t\t\t\tmessage: typeConvert.MarkdownString.fromStrict(value.message),\n\t\t\t\t\t\tprogress: lastProgress === undefined ? undefined : lastProgress / 100,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\t// todo: 'any' cast because TS can't handle the overloads\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tconst extensionResult = await raceCancellation(Promise.resolve((item.tool.invoke as any)(options, token, progress!)), token);\n\t\tif (!extensionResult) {\n\t\t\tthrow new CancellationError();\n\t\t}\n\n\t\treturn typeConvert.LanguageModelToolResult.from(extensionResult, item.extension);\n\t}\n\n\tprivate async getModel(modelId: string, extension: IExtensionDescription): Promise<vscode.LanguageModelChat> {\n\t\tlet model: vscode.LanguageModelChat | undefined;\n\t\tif (modelId) {\n\t\t\tmodel = await this._languageModels.getLanguageModelByIdentifier(extension, modelId);\n\t\t}\n\t\tif (!model) {\n\t\t\tmodel = await this._languageModels.getDefaultLanguageModel(extension);\n\t\t\tif (!model) {\n\t\t\t\tthrow new Error('Language model unavailable');\n\t\t\t}\n\t\t}\n\n\t\treturn model;\n\t}\n\n\tasync $prepareToolInvocation(toolId: string, context: IToolInvocationPreparationContext, token: CancellationToken): Promise<IPreparedToolInvocation | undefined> {\n\t\tconst item = this._registeredTools.get(toolId);\n\t\tif (!item) {\n\t\t\tthrow new Error(`Unknown tool ${toolId}`);\n\t\t}\n\n\t\tconst options: vscode.LanguageModelToolInvocationPrepareOptions<any> = {\n\t\t\tinput: context.parameters,\n\t\t\tchatRequestId: context.chatRequestId,\n\t\t\tchatSessionId: context.chatSessionId,\n\t\t\tchatInteractionId: context.chatInteractionId\n\t\t};\n\t\tif (item.tool.prepareInvocation) {\n\t\t\tconst result = await item.tool.prepareInvocation(options, token);\n\t\t\tif (!result) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tif (result.pastTenseMessage || result.presentation) {\n\t\t\t\tcheckProposedApiEnabled(item.extension, 'chatParticipantPrivate');\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tconfirmationMessages: result.confirmationMessages ? {\n\t\t\t\t\ttitle: typeof result.confirmationMessages.title === 'string' ? result.confirmationMessages.title : typeConvert.MarkdownString.from(result.confirmationMessages.title),\n\t\t\t\t\tmessage: typeof result.confirmationMessages.message === 'string' ? result.confirmationMessages.message : typeConvert.MarkdownString.from(result.confirmationMessages.message),\n\t\t\t\t} : undefined,\n\t\t\t\tinvocationMessage: typeConvert.MarkdownString.fromStrict(result.invocationMessage),\n\t\t\t\tpastTenseMessage: typeConvert.MarkdownString.fromStrict(result.pastTenseMessage),\n\t\t\t\tpresentation: result.presentation as ToolInvocationPresentation | undefined\n\t\t\t};\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tregisterTool(extension: IExtensionDescription, id: string, tool: vscode.LanguageModelTool<any>): IDisposable {\n\t\tthis._registeredTools.set(id, { extension, tool });\n\t\tthis._proxy.$registerTool(id);\n\n\t\treturn toDisposable(() => {\n\t\t\tthis._registeredTools.delete(id);\n\t\t\tthis._proxy.$unregisterTool(id);\n\t\t});\n\t}\n}\n"]}