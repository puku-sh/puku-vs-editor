{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostDocumentsAndEditors.ts","vs/workbench/api/common/extHostDocumentsAndEditors.ts"],"names":[],"mappings":"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","file":"extHostDocumentsAndEditors.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as assert from '../../../base/common/assert.js';\nimport * as vscode from 'vscode';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { dispose } from '../../../base/common/lifecycle.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { createDecorator } from '../../../platform/instantiation/common/instantiation.js';\nimport { ExtHostDocumentsAndEditorsShape, IDocumentsAndEditorsDelta, MainContext } from './extHost.protocol.js';\nimport { ExtHostDocumentData } from './extHostDocumentData.js';\nimport { IExtHostRpcService } from './extHostRpcService.js';\nimport { ExtHostTextEditor } from './extHostTextEditor.js';\nimport * as typeConverters from './extHostTypeConverters.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { ResourceMap } from '../../../base/common/map.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { Iterable } from '../../../base/common/iterator.js';\nimport { Lazy } from '../../../base/common/lazy.js';\n\nclass Reference<T> {\n\tprivate _count = 0;\n\tconstructor(readonly value: T) { }\n\tref() {\n\t\tthis._count++;\n\t}\n\tunref() {\n\t\treturn --this._count === 0;\n\t}\n}\n\nexport class ExtHostDocumentsAndEditors implements ExtHostDocumentsAndEditorsShape {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate _activeEditorId: string | null = null;\n\n\tprivate readonly _editors = new Map<string, ExtHostTextEditor>();\n\tprivate readonly _documents = new ResourceMap<Reference<ExtHostDocumentData>>();\n\n\tprivate readonly _onDidAddDocuments = new Emitter<readonly ExtHostDocumentData[]>();\n\tprivate readonly _onDidRemoveDocuments = new Emitter<readonly ExtHostDocumentData[]>();\n\tprivate readonly _onDidChangeVisibleTextEditors = new Emitter<readonly vscode.TextEditor[]>();\n\tprivate readonly _onDidChangeActiveTextEditor = new Emitter<vscode.TextEditor | undefined>();\n\n\treadonly onDidAddDocuments: Event<readonly ExtHostDocumentData[]> = this._onDidAddDocuments.event;\n\treadonly onDidRemoveDocuments: Event<readonly ExtHostDocumentData[]> = this._onDidRemoveDocuments.event;\n\treadonly onDidChangeVisibleTextEditors: Event<readonly vscode.TextEditor[]> = this._onDidChangeVisibleTextEditors.event;\n\treadonly onDidChangeActiveTextEditor: Event<vscode.TextEditor | undefined> = this._onDidChangeActiveTextEditor.event;\n\n\tconstructor(\n\t\t@IExtHostRpcService private readonly _extHostRpc: IExtHostRpcService,\n\t\t@ILogService private readonly _logService: ILogService\n\t) { }\n\n\t$acceptDocumentsAndEditorsDelta(delta: IDocumentsAndEditorsDelta): void {\n\t\tthis.acceptDocumentsAndEditorsDelta(delta);\n\t}\n\n\tacceptDocumentsAndEditorsDelta(delta: IDocumentsAndEditorsDelta): void {\n\n\t\tconst removedDocuments: ExtHostDocumentData[] = [];\n\t\tconst addedDocuments: ExtHostDocumentData[] = [];\n\t\tconst removedEditors: ExtHostTextEditor[] = [];\n\n\t\tif (delta.removedDocuments) {\n\t\t\tfor (const uriComponent of delta.removedDocuments) {\n\t\t\t\tconst uri = URI.revive(uriComponent);\n\t\t\t\tconst data = this._documents.get(uri);\n\t\t\t\tif (data?.unref()) {\n\t\t\t\t\tthis._documents.delete(uri);\n\t\t\t\t\tremovedDocuments.push(data.value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (delta.addedDocuments) {\n\t\t\tfor (const data of delta.addedDocuments) {\n\t\t\t\tconst resource = URI.revive(data.uri);\n\t\t\t\tlet ref = this._documents.get(resource);\n\n\t\t\t\t// double check -> only notebook cell documents should be\n\t\t\t\t// referenced/opened more than once...\n\t\t\t\tif (ref) {\n\t\t\t\t\tif (resource.scheme !== Schemas.vscodeNotebookCell && resource.scheme !== Schemas.vscodeInteractiveInput) {\n\t\t\t\t\t\tthrow new Error(`document '${resource} already exists!'`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!ref) {\n\t\t\t\t\tref = new Reference(new ExtHostDocumentData(\n\t\t\t\t\t\tthis._extHostRpc.getProxy(MainContext.MainThreadDocuments),\n\t\t\t\t\t\tresource,\n\t\t\t\t\t\tdata.lines,\n\t\t\t\t\t\tdata.EOL,\n\t\t\t\t\t\tdata.versionId,\n\t\t\t\t\t\tdata.languageId,\n\t\t\t\t\t\tdata.isDirty,\n\t\t\t\t\t\tdata.encoding\n\t\t\t\t\t));\n\t\t\t\t\tthis._documents.set(resource, ref);\n\t\t\t\t\taddedDocuments.push(ref.value);\n\t\t\t\t}\n\n\t\t\t\tref.ref();\n\t\t\t}\n\t\t}\n\n\t\tif (delta.removedEditors) {\n\t\t\tfor (const id of delta.removedEditors) {\n\t\t\t\tconst editor = this._editors.get(id);\n\t\t\t\tthis._editors.delete(id);\n\t\t\t\tif (editor) {\n\t\t\t\t\tremovedEditors.push(editor);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (delta.addedEditors) {\n\t\t\tfor (const data of delta.addedEditors) {\n\t\t\t\tconst resource = URI.revive(data.documentUri);\n\t\t\t\tassert.ok(this._documents.has(resource), `document '${resource}' does not exist`);\n\t\t\t\tassert.ok(!this._editors.has(data.id), `editor '${data.id}' already exists!`);\n\n\t\t\t\tconst documentData = this._documents.get(resource)!.value;\n\t\t\t\tconst editor = new ExtHostTextEditor(\n\t\t\t\t\tdata.id,\n\t\t\t\t\tthis._extHostRpc.getProxy(MainContext.MainThreadTextEditors),\n\t\t\t\t\tthis._logService,\n\t\t\t\t\tnew Lazy(() => documentData.document),\n\t\t\t\t\tdata.selections.map(typeConverters.Selection.to),\n\t\t\t\t\tdata.options,\n\t\t\t\t\tdata.visibleRanges.map(range => typeConverters.Range.to(range)),\n\t\t\t\t\ttypeof data.editorPosition === 'number' ? typeConverters.ViewColumn.to(data.editorPosition) : undefined\n\t\t\t\t);\n\t\t\t\tthis._editors.set(data.id, editor);\n\t\t\t}\n\t\t}\n\n\t\tif (delta.newActiveEditor !== undefined) {\n\t\t\tassert.ok(delta.newActiveEditor === null || this._editors.has(delta.newActiveEditor), `active editor '${delta.newActiveEditor}' does not exist`);\n\t\t\tthis._activeEditorId = delta.newActiveEditor;\n\t\t}\n\n\t\tdispose(removedDocuments);\n\t\tdispose(removedEditors);\n\n\t\t// now that the internal state is complete, fire events\n\t\tif (delta.removedDocuments) {\n\t\t\tthis._onDidRemoveDocuments.fire(removedDocuments);\n\t\t}\n\t\tif (delta.addedDocuments) {\n\t\t\tthis._onDidAddDocuments.fire(addedDocuments);\n\t\t}\n\n\t\tif (delta.removedEditors || delta.addedEditors) {\n\t\t\tthis._onDidChangeVisibleTextEditors.fire(this.allEditors().map(editor => editor.value));\n\t\t}\n\t\tif (delta.newActiveEditor !== undefined) {\n\t\t\tthis._onDidChangeActiveTextEditor.fire(this.activeEditor());\n\t\t}\n\t}\n\n\tgetDocument(uri: URI): ExtHostDocumentData | undefined {\n\t\treturn this._documents.get(uri)?.value;\n\t}\n\n\tallDocuments(): Iterable<ExtHostDocumentData> {\n\t\treturn Iterable.map(this._documents.values(), ref => ref.value);\n\t}\n\n\tgetEditor(id: string): ExtHostTextEditor | undefined {\n\t\treturn this._editors.get(id);\n\t}\n\n\tactiveEditor(): vscode.TextEditor | undefined;\n\tactiveEditor(internal: true): ExtHostTextEditor | undefined;\n\tactiveEditor(internal?: true): vscode.TextEditor | ExtHostTextEditor | undefined {\n\t\tif (!this._activeEditorId) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst editor = this._editors.get(this._activeEditorId);\n\t\tif (internal) {\n\t\t\treturn editor;\n\t\t} else {\n\t\t\treturn editor?.value;\n\t\t}\n\t}\n\n\tallEditors(): ExtHostTextEditor[] {\n\t\treturn [...this._editors.values()];\n\t}\n}\n\nexport interface IExtHostDocumentsAndEditors extends ExtHostDocumentsAndEditors { }\nexport const IExtHostDocumentsAndEditors = createDecorator<IExtHostDocumentsAndEditors>('IExtHostDocumentsAndEditors');\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as assert from '../../../base/common/assert.js';\nimport * as vscode from 'vscode';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { dispose } from '../../../base/common/lifecycle.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { createDecorator } from '../../../platform/instantiation/common/instantiation.js';\nimport { ExtHostDocumentsAndEditorsShape, IDocumentsAndEditorsDelta, MainContext } from './extHost.protocol.js';\nimport { ExtHostDocumentData } from './extHostDocumentData.js';\nimport { IExtHostRpcService } from './extHostRpcService.js';\nimport { ExtHostTextEditor } from './extHostTextEditor.js';\nimport * as typeConverters from './extHostTypeConverters.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { ResourceMap } from '../../../base/common/map.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { Iterable } from '../../../base/common/iterator.js';\nimport { Lazy } from '../../../base/common/lazy.js';\n\nclass Reference<T> {\n\tprivate _count = 0;\n\tconstructor(readonly value: T) { }\n\tref() {\n\t\tthis._count++;\n\t}\n\tunref() {\n\t\treturn --this._count === 0;\n\t}\n}\n\nexport class ExtHostDocumentsAndEditors implements ExtHostDocumentsAndEditorsShape {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate _activeEditorId: string | null = null;\n\n\tprivate readonly _editors = new Map<string, ExtHostTextEditor>();\n\tprivate readonly _documents = new ResourceMap<Reference<ExtHostDocumentData>>();\n\n\tprivate readonly _onDidAddDocuments = new Emitter<readonly ExtHostDocumentData[]>();\n\tprivate readonly _onDidRemoveDocuments = new Emitter<readonly ExtHostDocumentData[]>();\n\tprivate readonly _onDidChangeVisibleTextEditors = new Emitter<readonly vscode.TextEditor[]>();\n\tprivate readonly _onDidChangeActiveTextEditor = new Emitter<vscode.TextEditor | undefined>();\n\n\treadonly onDidAddDocuments: Event<readonly ExtHostDocumentData[]> = this._onDidAddDocuments.event;\n\treadonly onDidRemoveDocuments: Event<readonly ExtHostDocumentData[]> = this._onDidRemoveDocuments.event;\n\treadonly onDidChangeVisibleTextEditors: Event<readonly vscode.TextEditor[]> = this._onDidChangeVisibleTextEditors.event;\n\treadonly onDidChangeActiveTextEditor: Event<vscode.TextEditor | undefined> = this._onDidChangeActiveTextEditor.event;\n\n\tconstructor(\n\t\t@IExtHostRpcService private readonly _extHostRpc: IExtHostRpcService,\n\t\t@ILogService private readonly _logService: ILogService\n\t) { }\n\n\t$acceptDocumentsAndEditorsDelta(delta: IDocumentsAndEditorsDelta): void {\n\t\tthis.acceptDocumentsAndEditorsDelta(delta);\n\t}\n\n\tacceptDocumentsAndEditorsDelta(delta: IDocumentsAndEditorsDelta): void {\n\n\t\tconst removedDocuments: ExtHostDocumentData[] = [];\n\t\tconst addedDocuments: ExtHostDocumentData[] = [];\n\t\tconst removedEditors: ExtHostTextEditor[] = [];\n\n\t\tif (delta.removedDocuments) {\n\t\t\tfor (const uriComponent of delta.removedDocuments) {\n\t\t\t\tconst uri = URI.revive(uriComponent);\n\t\t\t\tconst data = this._documents.get(uri);\n\t\t\t\tif (data?.unref()) {\n\t\t\t\t\tthis._documents.delete(uri);\n\t\t\t\t\tremovedDocuments.push(data.value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (delta.addedDocuments) {\n\t\t\tfor (const data of delta.addedDocuments) {\n\t\t\t\tconst resource = URI.revive(data.uri);\n\t\t\t\tlet ref = this._documents.get(resource);\n\n\t\t\t\t// double check -> only notebook cell documents should be\n\t\t\t\t// referenced/opened more than once...\n\t\t\t\tif (ref) {\n\t\t\t\t\tif (resource.scheme !== Schemas.vscodeNotebookCell && resource.scheme !== Schemas.vscodeInteractiveInput) {\n\t\t\t\t\t\tthrow new Error(`document '${resource} already exists!'`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!ref) {\n\t\t\t\t\tref = new Reference(new ExtHostDocumentData(\n\t\t\t\t\t\tthis._extHostRpc.getProxy(MainContext.MainThreadDocuments),\n\t\t\t\t\t\tresource,\n\t\t\t\t\t\tdata.lines,\n\t\t\t\t\t\tdata.EOL,\n\t\t\t\t\t\tdata.versionId,\n\t\t\t\t\t\tdata.languageId,\n\t\t\t\t\t\tdata.isDirty,\n\t\t\t\t\t\tdata.encoding\n\t\t\t\t\t));\n\t\t\t\t\tthis._documents.set(resource, ref);\n\t\t\t\t\taddedDocuments.push(ref.value);\n\t\t\t\t}\n\n\t\t\t\tref.ref();\n\t\t\t}\n\t\t}\n\n\t\tif (delta.removedEditors) {\n\t\t\tfor (const id of delta.removedEditors) {\n\t\t\t\tconst editor = this._editors.get(id);\n\t\t\t\tthis._editors.delete(id);\n\t\t\t\tif (editor) {\n\t\t\t\t\tremovedEditors.push(editor);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (delta.addedEditors) {\n\t\t\tfor (const data of delta.addedEditors) {\n\t\t\t\tconst resource = URI.revive(data.documentUri);\n\t\t\t\tassert.ok(this._documents.has(resource), `document '${resource}' does not exist`);\n\t\t\t\tassert.ok(!this._editors.has(data.id), `editor '${data.id}' already exists!`);\n\n\t\t\t\tconst documentData = this._documents.get(resource)!.value;\n\t\t\t\tconst editor = new ExtHostTextEditor(\n\t\t\t\t\tdata.id,\n\t\t\t\t\tthis._extHostRpc.getProxy(MainContext.MainThreadTextEditors),\n\t\t\t\t\tthis._logService,\n\t\t\t\t\tnew Lazy(() => documentData.document),\n\t\t\t\t\tdata.selections.map(typeConverters.Selection.to),\n\t\t\t\t\tdata.options,\n\t\t\t\t\tdata.visibleRanges.map(range => typeConverters.Range.to(range)),\n\t\t\t\t\ttypeof data.editorPosition === 'number' ? typeConverters.ViewColumn.to(data.editorPosition) : undefined\n\t\t\t\t);\n\t\t\t\tthis._editors.set(data.id, editor);\n\t\t\t}\n\t\t}\n\n\t\tif (delta.newActiveEditor !== undefined) {\n\t\t\tassert.ok(delta.newActiveEditor === null || this._editors.has(delta.newActiveEditor), `active editor '${delta.newActiveEditor}' does not exist`);\n\t\t\tthis._activeEditorId = delta.newActiveEditor;\n\t\t}\n\n\t\tdispose(removedDocuments);\n\t\tdispose(removedEditors);\n\n\t\t// now that the internal state is complete, fire events\n\t\tif (delta.removedDocuments) {\n\t\t\tthis._onDidRemoveDocuments.fire(removedDocuments);\n\t\t}\n\t\tif (delta.addedDocuments) {\n\t\t\tthis._onDidAddDocuments.fire(addedDocuments);\n\t\t}\n\n\t\tif (delta.removedEditors || delta.addedEditors) {\n\t\t\tthis._onDidChangeVisibleTextEditors.fire(this.allEditors().map(editor => editor.value));\n\t\t}\n\t\tif (delta.newActiveEditor !== undefined) {\n\t\t\tthis._onDidChangeActiveTextEditor.fire(this.activeEditor());\n\t\t}\n\t}\n\n\tgetDocument(uri: URI): ExtHostDocumentData | undefined {\n\t\treturn this._documents.get(uri)?.value;\n\t}\n\n\tallDocuments(): Iterable<ExtHostDocumentData> {\n\t\treturn Iterable.map(this._documents.values(), ref => ref.value);\n\t}\n\n\tgetEditor(id: string): ExtHostTextEditor | undefined {\n\t\treturn this._editors.get(id);\n\t}\n\n\tactiveEditor(): vscode.TextEditor | undefined;\n\tactiveEditor(internal: true): ExtHostTextEditor | undefined;\n\tactiveEditor(internal?: true): vscode.TextEditor | ExtHostTextEditor | undefined {\n\t\tif (!this._activeEditorId) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst editor = this._editors.get(this._activeEditorId);\n\t\tif (internal) {\n\t\t\treturn editor;\n\t\t} else {\n\t\t\treturn editor?.value;\n\t\t}\n\t}\n\n\tallEditors(): ExtHostTextEditor[] {\n\t\treturn [...this._editors.values()];\n\t}\n}\n\nexport interface IExtHostDocumentsAndEditors extends ExtHostDocumentsAndEditors { }\nexport const IExtHostDocumentsAndEditors = createDecorator<IExtHostDocumentsAndEditors>('IExtHostDocumentsAndEditors');\n"]}