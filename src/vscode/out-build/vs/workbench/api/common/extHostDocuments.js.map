{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostDocuments.ts","vs/workbench/api/common/extHostDocuments.ts"],"names":[],"mappings":"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","file":"extHostDocuments.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { DisposableStore } from '../../../base/common/lifecycle.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { ExtHostDocumentsShape, IMainContext, MainContext, MainThreadDocumentsShape } from './extHost.protocol.js';\nimport { ExtHostDocumentData, setWordDefinitionFor } from './extHostDocumentData.js';\nimport { ExtHostDocumentsAndEditors } from './extHostDocumentsAndEditors.js';\nimport * as TypeConverters from './extHostTypeConverters.js';\nimport type * as vscode from 'vscode';\nimport { assertReturnsDefined } from '../../../base/common/types.js';\nimport { deepFreeze } from '../../../base/common/objects.js';\nimport { TextDocumentChangeReason } from './extHostTypes.js';\nimport { ISerializedModelContentChangedEvent } from '../../../editor/common/textModelEvents.js';\n\nexport class ExtHostDocuments implements ExtHostDocumentsShape {\n\n\tprivate readonly _onDidAddDocument = new Emitter<vscode.TextDocument>();\n\tprivate readonly _onDidRemoveDocument = new Emitter<vscode.TextDocument>();\n\tprivate readonly _onDidChangeDocument = new Emitter<Omit<vscode.TextDocumentChangeEvent, 'detailedReason'>>();\n\tprivate readonly _onDidChangeDocumentWithReason = new Emitter<vscode.TextDocumentChangeEvent>();\n\tprivate readonly _onDidSaveDocument = new Emitter<vscode.TextDocument>();\n\n\treadonly onDidAddDocument: Event<vscode.TextDocument> = this._onDidAddDocument.event;\n\treadonly onDidRemoveDocument: Event<vscode.TextDocument> = this._onDidRemoveDocument.event;\n\treadonly onDidChangeDocument: Event<vscode.TextDocumentChangeEvent> = this._onDidChangeDocument.event as Event<vscode.TextDocumentChangeEvent>;\n\treadonly onDidChangeDocumentWithReason: Event<vscode.TextDocumentChangeEvent> = this._onDidChangeDocumentWithReason.event;\n\treadonly onDidSaveDocument: Event<vscode.TextDocument> = this._onDidSaveDocument.event;\n\n\tprivate readonly _toDispose = new DisposableStore();\n\tprivate _proxy: MainThreadDocumentsShape;\n\tprivate _documentsAndEditors: ExtHostDocumentsAndEditors;\n\tprivate _documentLoader = new Map<string, Promise<ExtHostDocumentData>>();\n\n\tconstructor(mainContext: IMainContext, documentsAndEditors: ExtHostDocumentsAndEditors) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadDocuments);\n\t\tthis._documentsAndEditors = documentsAndEditors;\n\n\t\tthis._documentsAndEditors.onDidRemoveDocuments(documents => {\n\t\t\tfor (const data of documents) {\n\t\t\t\tthis._onDidRemoveDocument.fire(data.document);\n\t\t\t}\n\t\t}, undefined, this._toDispose);\n\t\tthis._documentsAndEditors.onDidAddDocuments(documents => {\n\t\t\tfor (const data of documents) {\n\t\t\t\tthis._onDidAddDocument.fire(data.document);\n\t\t\t}\n\t\t}, undefined, this._toDispose);\n\t}\n\n\tpublic dispose(): void {\n\t\tthis._toDispose.dispose();\n\t}\n\n\tpublic getAllDocumentData(): ExtHostDocumentData[] {\n\t\treturn [...this._documentsAndEditors.allDocuments()];\n\t}\n\n\tpublic getDocumentData(resource: vscode.Uri): ExtHostDocumentData | undefined {\n\t\tif (!resource) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst data = this._documentsAndEditors.getDocument(resource);\n\t\tif (data) {\n\t\t\treturn data;\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tpublic getDocument(resource: vscode.Uri): vscode.TextDocument {\n\t\tconst data = this.getDocumentData(resource);\n\t\tif (!data?.document) {\n\t\t\tthrow new Error(`Unable to retrieve document from URI '${resource}'`);\n\t\t}\n\t\treturn data.document;\n\t}\n\n\tpublic ensureDocumentData(uri: URI, options?: { encoding?: string }): Promise<ExtHostDocumentData> {\n\n\t\tconst cached = this._documentsAndEditors.getDocument(uri);\n\t\tif (cached && (!options?.encoding || cached.document.encoding === options.encoding)) {\n\t\t\treturn Promise.resolve(cached);\n\t\t}\n\n\t\tlet promise = this._documentLoader.get(uri.toString());\n\t\tif (!promise) {\n\t\t\tpromise = this._proxy.$tryOpenDocument(uri, options).then(uriData => {\n\t\t\t\tthis._documentLoader.delete(uri.toString());\n\t\t\t\tconst canonicalUri = URI.revive(uriData);\n\t\t\t\treturn assertReturnsDefined(this._documentsAndEditors.getDocument(canonicalUri));\n\t\t\t}, err => {\n\t\t\t\tthis._documentLoader.delete(uri.toString());\n\t\t\t\treturn Promise.reject(err);\n\t\t\t});\n\t\t\tthis._documentLoader.set(uri.toString(), promise);\n\t\t} else {\n\t\t\tif (options?.encoding) {\n\t\t\t\tpromise = promise.then(data => {\n\t\t\t\t\tif (data.document.encoding !== options.encoding) {\n\t\t\t\t\t\treturn this.ensureDocumentData(uri, options);\n\t\t\t\t\t}\n\t\t\t\t\treturn data;\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn promise;\n\t}\n\n\tpublic createDocumentData(options?: { language?: string; content?: string; encoding?: string }): Promise<URI> {\n\t\treturn this._proxy.$tryCreateDocument(options).then(data => URI.revive(data));\n\t}\n\n\tpublic $acceptModelLanguageChanged(uriComponents: UriComponents, newLanguageId: string): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\t// Treat a language change as a remove + add\n\n\t\tthis._onDidRemoveDocument.fire(data.document);\n\t\tdata._acceptLanguageId(newLanguageId);\n\t\tthis._onDidAddDocument.fire(data.document);\n\t}\n\n\tpublic $acceptModelSaved(uriComponents: UriComponents): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\tthis.$acceptDirtyStateChanged(uriComponents, false);\n\t\tthis._onDidSaveDocument.fire(data.document);\n\t}\n\n\tpublic $acceptDirtyStateChanged(uriComponents: UriComponents, isDirty: boolean): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\tdata._acceptIsDirty(isDirty);\n\t\tthis._onDidChangeDocument.fire({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: [],\n\t\t\treason: undefined,\n\t\t});\n\t\tthis._onDidChangeDocumentWithReason.fire({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: [],\n\t\t\treason: undefined,\n\t\t\tdetailedReason: undefined,\n\t\t});\n\t}\n\n\tpublic $acceptEncodingChanged(uriComponents: UriComponents, encoding: string): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\tdata._acceptEncoding(encoding);\n\t\tthis._onDidChangeDocument.fire({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: [],\n\t\t\treason: undefined,\n\t\t});\n\t\tthis._onDidChangeDocumentWithReason.fire({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: [],\n\t\t\treason: undefined,\n\t\t\tdetailedReason: undefined,\n\t\t});\n\t}\n\n\tpublic $acceptModelChanged(uriComponents: UriComponents, events: ISerializedModelContentChangedEvent, isDirty: boolean): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\tdata._acceptIsDirty(isDirty);\n\t\tdata.onEvents(events);\n\n\t\tlet reason: vscode.TextDocumentChangeReason | undefined = undefined;\n\t\tif (events.isUndoing) {\n\t\t\treason = TextDocumentChangeReason.Undo;\n\t\t} else if (events.isRedoing) {\n\t\t\treason = TextDocumentChangeReason.Redo;\n\t\t}\n\n\t\tthis._onDidChangeDocument.fire(deepFreeze<Omit<vscode.TextDocumentChangeEvent, 'detailedReason'>>({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: events.changes.map((change) => {\n\t\t\t\treturn {\n\t\t\t\t\trange: TypeConverters.Range.to(change.range),\n\t\t\t\t\trangeOffset: change.rangeOffset,\n\t\t\t\t\trangeLength: change.rangeLength,\n\t\t\t\t\ttext: change.text\n\t\t\t\t};\n\t\t\t}),\n\t\t\treason,\n\t\t}));\n\t\tthis._onDidChangeDocumentWithReason.fire(deepFreeze<vscode.TextDocumentChangeEvent>({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: events.changes.map((change) => {\n\t\t\t\treturn {\n\t\t\t\t\trange: TypeConverters.Range.to(change.range),\n\t\t\t\t\trangeOffset: change.rangeOffset,\n\t\t\t\t\trangeLength: change.rangeLength,\n\t\t\t\t\ttext: change.text\n\t\t\t\t};\n\t\t\t}),\n\t\t\treason,\n\t\t\tdetailedReason: events.detailedReason ? {\n\t\t\t\tsource: events.detailedReason.source as string,\n\t\t\t\tmetadata: events.detailedReason,\n\t\t\t} : undefined,\n\t\t}));\n\t}\n\n\tpublic setWordDefinitionFor(languageId: string, wordDefinition: RegExp | undefined): void {\n\t\tsetWordDefinitionFor(languageId, wordDefinition);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { DisposableStore } from '../../../base/common/lifecycle.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { ExtHostDocumentsShape, IMainContext, MainContext, MainThreadDocumentsShape } from './extHost.protocol.js';\nimport { ExtHostDocumentData, setWordDefinitionFor } from './extHostDocumentData.js';\nimport { ExtHostDocumentsAndEditors } from './extHostDocumentsAndEditors.js';\nimport * as TypeConverters from './extHostTypeConverters.js';\nimport type * as vscode from 'vscode';\nimport { assertReturnsDefined } from '../../../base/common/types.js';\nimport { deepFreeze } from '../../../base/common/objects.js';\nimport { TextDocumentChangeReason } from './extHostTypes.js';\nimport { ISerializedModelContentChangedEvent } from '../../../editor/common/textModelEvents.js';\n\nexport class ExtHostDocuments implements ExtHostDocumentsShape {\n\n\tprivate readonly _onDidAddDocument = new Emitter<vscode.TextDocument>();\n\tprivate readonly _onDidRemoveDocument = new Emitter<vscode.TextDocument>();\n\tprivate readonly _onDidChangeDocument = new Emitter<Omit<vscode.TextDocumentChangeEvent, 'detailedReason'>>();\n\tprivate readonly _onDidChangeDocumentWithReason = new Emitter<vscode.TextDocumentChangeEvent>();\n\tprivate readonly _onDidSaveDocument = new Emitter<vscode.TextDocument>();\n\n\treadonly onDidAddDocument: Event<vscode.TextDocument> = this._onDidAddDocument.event;\n\treadonly onDidRemoveDocument: Event<vscode.TextDocument> = this._onDidRemoveDocument.event;\n\treadonly onDidChangeDocument: Event<vscode.TextDocumentChangeEvent> = this._onDidChangeDocument.event as Event<vscode.TextDocumentChangeEvent>;\n\treadonly onDidChangeDocumentWithReason: Event<vscode.TextDocumentChangeEvent> = this._onDidChangeDocumentWithReason.event;\n\treadonly onDidSaveDocument: Event<vscode.TextDocument> = this._onDidSaveDocument.event;\n\n\tprivate readonly _toDispose = new DisposableStore();\n\tprivate _proxy: MainThreadDocumentsShape;\n\tprivate _documentsAndEditors: ExtHostDocumentsAndEditors;\n\tprivate _documentLoader = new Map<string, Promise<ExtHostDocumentData>>();\n\n\tconstructor(mainContext: IMainContext, documentsAndEditors: ExtHostDocumentsAndEditors) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadDocuments);\n\t\tthis._documentsAndEditors = documentsAndEditors;\n\n\t\tthis._documentsAndEditors.onDidRemoveDocuments(documents => {\n\t\t\tfor (const data of documents) {\n\t\t\t\tthis._onDidRemoveDocument.fire(data.document);\n\t\t\t}\n\t\t}, undefined, this._toDispose);\n\t\tthis._documentsAndEditors.onDidAddDocuments(documents => {\n\t\t\tfor (const data of documents) {\n\t\t\t\tthis._onDidAddDocument.fire(data.document);\n\t\t\t}\n\t\t}, undefined, this._toDispose);\n\t}\n\n\tpublic dispose(): void {\n\t\tthis._toDispose.dispose();\n\t}\n\n\tpublic getAllDocumentData(): ExtHostDocumentData[] {\n\t\treturn [...this._documentsAndEditors.allDocuments()];\n\t}\n\n\tpublic getDocumentData(resource: vscode.Uri): ExtHostDocumentData | undefined {\n\t\tif (!resource) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst data = this._documentsAndEditors.getDocument(resource);\n\t\tif (data) {\n\t\t\treturn data;\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tpublic getDocument(resource: vscode.Uri): vscode.TextDocument {\n\t\tconst data = this.getDocumentData(resource);\n\t\tif (!data?.document) {\n\t\t\tthrow new Error(`Unable to retrieve document from URI '${resource}'`);\n\t\t}\n\t\treturn data.document;\n\t}\n\n\tpublic ensureDocumentData(uri: URI, options?: { encoding?: string }): Promise<ExtHostDocumentData> {\n\n\t\tconst cached = this._documentsAndEditors.getDocument(uri);\n\t\tif (cached && (!options?.encoding || cached.document.encoding === options.encoding)) {\n\t\t\treturn Promise.resolve(cached);\n\t\t}\n\n\t\tlet promise = this._documentLoader.get(uri.toString());\n\t\tif (!promise) {\n\t\t\tpromise = this._proxy.$tryOpenDocument(uri, options).then(uriData => {\n\t\t\t\tthis._documentLoader.delete(uri.toString());\n\t\t\t\tconst canonicalUri = URI.revive(uriData);\n\t\t\t\treturn assertReturnsDefined(this._documentsAndEditors.getDocument(canonicalUri));\n\t\t\t}, err => {\n\t\t\t\tthis._documentLoader.delete(uri.toString());\n\t\t\t\treturn Promise.reject(err);\n\t\t\t});\n\t\t\tthis._documentLoader.set(uri.toString(), promise);\n\t\t} else {\n\t\t\tif (options?.encoding) {\n\t\t\t\tpromise = promise.then(data => {\n\t\t\t\t\tif (data.document.encoding !== options.encoding) {\n\t\t\t\t\t\treturn this.ensureDocumentData(uri, options);\n\t\t\t\t\t}\n\t\t\t\t\treturn data;\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn promise;\n\t}\n\n\tpublic createDocumentData(options?: { language?: string; content?: string; encoding?: string }): Promise<URI> {\n\t\treturn this._proxy.$tryCreateDocument(options).then(data => URI.revive(data));\n\t}\n\n\tpublic $acceptModelLanguageChanged(uriComponents: UriComponents, newLanguageId: string): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\t// Treat a language change as a remove + add\n\n\t\tthis._onDidRemoveDocument.fire(data.document);\n\t\tdata._acceptLanguageId(newLanguageId);\n\t\tthis._onDidAddDocument.fire(data.document);\n\t}\n\n\tpublic $acceptModelSaved(uriComponents: UriComponents): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\tthis.$acceptDirtyStateChanged(uriComponents, false);\n\t\tthis._onDidSaveDocument.fire(data.document);\n\t}\n\n\tpublic $acceptDirtyStateChanged(uriComponents: UriComponents, isDirty: boolean): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\tdata._acceptIsDirty(isDirty);\n\t\tthis._onDidChangeDocument.fire({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: [],\n\t\t\treason: undefined,\n\t\t});\n\t\tthis._onDidChangeDocumentWithReason.fire({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: [],\n\t\t\treason: undefined,\n\t\t\tdetailedReason: undefined,\n\t\t});\n\t}\n\n\tpublic $acceptEncodingChanged(uriComponents: UriComponents, encoding: string): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\tdata._acceptEncoding(encoding);\n\t\tthis._onDidChangeDocument.fire({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: [],\n\t\t\treason: undefined,\n\t\t});\n\t\tthis._onDidChangeDocumentWithReason.fire({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: [],\n\t\t\treason: undefined,\n\t\t\tdetailedReason: undefined,\n\t\t});\n\t}\n\n\tpublic $acceptModelChanged(uriComponents: UriComponents, events: ISerializedModelContentChangedEvent, isDirty: boolean): void {\n\t\tconst uri = URI.revive(uriComponents);\n\t\tconst data = this._documentsAndEditors.getDocument(uri);\n\t\tif (!data) {\n\t\t\tthrow new Error('unknown document');\n\t\t}\n\t\tdata._acceptIsDirty(isDirty);\n\t\tdata.onEvents(events);\n\n\t\tlet reason: vscode.TextDocumentChangeReason | undefined = undefined;\n\t\tif (events.isUndoing) {\n\t\t\treason = TextDocumentChangeReason.Undo;\n\t\t} else if (events.isRedoing) {\n\t\t\treason = TextDocumentChangeReason.Redo;\n\t\t}\n\n\t\tthis._onDidChangeDocument.fire(deepFreeze<Omit<vscode.TextDocumentChangeEvent, 'detailedReason'>>({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: events.changes.map((change) => {\n\t\t\t\treturn {\n\t\t\t\t\trange: TypeConverters.Range.to(change.range),\n\t\t\t\t\trangeOffset: change.rangeOffset,\n\t\t\t\t\trangeLength: change.rangeLength,\n\t\t\t\t\ttext: change.text\n\t\t\t\t};\n\t\t\t}),\n\t\t\treason,\n\t\t}));\n\t\tthis._onDidChangeDocumentWithReason.fire(deepFreeze<vscode.TextDocumentChangeEvent>({\n\t\t\tdocument: data.document,\n\t\t\tcontentChanges: events.changes.map((change) => {\n\t\t\t\treturn {\n\t\t\t\t\trange: TypeConverters.Range.to(change.range),\n\t\t\t\t\trangeOffset: change.rangeOffset,\n\t\t\t\t\trangeLength: change.rangeLength,\n\t\t\t\t\ttext: change.text\n\t\t\t\t};\n\t\t\t}),\n\t\t\treason,\n\t\t\tdetailedReason: events.detailedReason ? {\n\t\t\t\tsource: events.detailedReason.source as string,\n\t\t\t\tmetadata: events.detailedReason,\n\t\t\t} : undefined,\n\t\t}));\n\t}\n\n\tpublic setWordDefinitionFor(languageId: string, wordDefinition: RegExp | undefined): void {\n\t\tsetWordDefinitionFor(languageId, wordDefinition);\n\t}\n}\n"]}