{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostRequireInterceptor.ts","vs/workbench/api/common/extHostRequireInterceptor.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;;AAEhG,OAAO,KAAK,WAAW,MAAM,qCAAqC,CAAC;AACnE,OAAO,EAAE,GAAG,EAAE,MAAM,6BAA6B,CAAC;AAClD,OAAO,EAA4B,WAAW,EAAE,MAAM,uBAAuB,CAAC;AAC9E,OAAO,EAAyB,qBAAqB,EAAE,MAAM,2BAA2B,CAAC;AACzF,OAAO,EAAE,wBAAwB,EAAE,MAAM,gDAAgD,CAAC;AAE1F,OAAO,EAAE,sBAAsB,EAAE,MAAM,mDAAmD,CAAC;AAE3F,OAAO,EAAE,kBAAkB,EAAE,MAAM,wBAAwB,CAAC;AAC5D,OAAO,EAAE,uBAAuB,EAAE,MAAM,6BAA6B,CAAC;AACtE,OAAO,EAAE,qBAAqB,EAAE,MAAM,yDAAyD,CAAC;AAChG,OAAO,EAAkB,wBAAwB,EAAE,MAAM,8BAA8B,CAAC;AACxF,OAAO,EAAE,WAAW,EAAE,MAAM,qCAAqC,CAAC;AAClE,OAAO,EAAE,sBAAsB,EAAE,MAAM,iCAAiC,CAAC;AAgBlE,IAAe,kBAAkB,GAAjC,MAAe,kBAAkB;IAKvC,YACS,WAAiC,EACjC,kBAAwC,EACR,aAAoC,EACpC,qBAA4C,EACzC,wBAAkD,EACnD,SAAkC,EAC9C,WAAwB;QAN9C,gBAAW,GAAX,WAAW,CAAsB;QACjC,uBAAkB,GAAlB,kBAAkB,CAAsB;QACR,kBAAa,GAAb,aAAa,CAAuB;QACpC,0BAAqB,GAArB,qBAAqB,CAAuB;QACzC,6BAAwB,GAAxB,wBAAwB,CAA0B;QACnD,cAAS,GAAT,SAAS,CAAyB;QAC9C,gBAAW,GAAX,WAAW,CAAa;QAEtD,IAAI,CAAC,UAAU,GAAG,IAAI,GAAG,EAA8B,CAAC;QACxD,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;IACzB,CAAC;IAED,KAAK,CAAC,OAAO;QAEZ,IAAI,CAAC,mBAAmB,EAAE,CAAC;QAE3B,WAAW,CAAC,IAAI,CAAC,gCAAgC,CAAC,CAAC;QACnD,MAAM,cAAc,GAAG,MAAM,IAAI,CAAC,qBAAqB,CAAC,iBAAiB,EAAE,CAAC;QAC5E,WAAW,CAAC,IAAI,CAAC,+BAA+B,CAAC,CAAC;QAClD,MAAM,cAAc,GAAG,MAAM,IAAI,CAAC,wBAAwB,CAAC,qBAAqB,EAAE,CAAC;QAEnF,IAAI,CAAC,QAAQ,CAAC,IAAI,uBAAuB,CAAC,IAAI,CAAC,WAAW,EAAE,cAAc,EAAE,IAAI,CAAC,kBAAkB,EAAE,cAAc,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC;QACxI,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,+BAA+B,CAAC,CAAC,CAAC;QAClF,IAAI,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC;YACpC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,qBAAqB,EAAE,cAAc,EAAE,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC,CAAC;QAClI,CAAC;IACF,CAAC;IAIM,QAAQ,CAAC,WAA4D;QAC3E,IAAI,gBAAgB,IAAI,WAAW,EAAE,CAAC;YACrC,IAAI,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,cAAc,CAAC,EAAE,CAAC;gBAC/C,KAAK,MAAM,UAAU,IAAI,WAAW,CAAC,cAAc,EAAE,CAAC;oBACrD,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,UAAU,EAAE,WAAW,CAAC,CAAC;gBAC9C,CAAC;YACF,CAAC;iBAAM,CAAC;gBACP,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,WAAW,CAAC,cAAc,EAAE,WAAW,CAAC,CAAC;YAC9D,CAAC;QACF,CAAC;QAED,IAAI,OAAO,WAAW,CAAC,qBAAqB,KAAK,UAAU,EAAE,CAAC;YAC7D,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,UAAU,EAAE,EAAE;gBACtC,OAAO,WAAW,CAAC,qBAAsB,CAAC,UAAU,CAAC,CAAC;YACvD,CAAC,CAAC,CAAC;QACJ,CAAC;IACF,CAAC;CACD,CAAA;AArDqB,kBAAkB;IAQrC,WAAA,qBAAqB,CAAA;IACrB,WAAA,qBAAqB,CAAA;IACrB,WAAA,wBAAwB,CAAA;IACxB,WAAA,uBAAuB,CAAA;IACvB,WAAA,WAAW,CAAA;GAZQ,kBAAkB,CAqDvC;;AAED,4BAA4B;AAE5B,IAAM,+BAA+B,GAArC,MAAM,+BAA+B;;IACpC;;;OAGG;aACqB,YAAO,GAAgC,IAAI,GAAG,CAAC;QACtE,CAAC,gBAAgB,EAAE,iBAAiB,CAAC;QACrC,CAAC,yBAAyB,EAAE,0BAA0B,CAAC;KACvD,CAH8B,AAG7B,CAAC;IAIH,YAAqC,QAAiC;QACrE,IAAI,QAAQ,CAAC,WAAW,CAAC,OAAO,IAAI,iCAA+B,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC;YAClF,MAAM,IAAI,GAAG,sBAAsB,CAAC,IAAI,CAAC,mBAAmB,CAAC,QAAQ,CAAC,WAAW,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;YACnG,4FAA4F;YAC5F,0FAA0F;YAC1F,wEAAwE;YACxE,MAAM,SAAS,GAAG,aAAa,CAAC;YAChC,MAAM,aAAa,GAAG,IAAI,SAAS,OAAO,SAAS,KAAK,SAAS,GAAG,CAAC;YACrE,MAAM,aAAa,GAAG,kDAAkD,CAAC;YACzE,IAAI,CAAC,EAAE,GAAG,IAAI,MAAM,CAAC,KAAK,IAAI,IAAI,aAAa,QAAQ,aAAa,QAAQ,EAAE,GAAG,CAAC,CAAC;QACpF,CAAC;IACF,CAAC;IAEM,qBAAqB,CAAC,IAAY;QACxC,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE,CAAC;YACd,OAAO;QACR,CAAC;QAED,MAAM,MAAM,GAAG,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC,CAAC;QAC5D,IAAI,CAAC,MAAM,EAAE,CAAC;YACb,OAAO;QACR,CAAC;QAED,MAAM,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,MAAM,CAAC,GAAG,MAAM,CAAC;QAC9C,MAAM,SAAS,GAAG,iCAA+B,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;QAC1E,IAAI,SAAS,KAAK,SAAS,EAAE,CAAC;YAC7B,OAAO;QACR,CAAC;QAED,OAAO,CAAC,IAAI,CAAC,GAAG,UAAU,uBAAuB,SAAS,8BAA8B,CAAC,CAAC;QAE1F,OAAO,MAAM,GAAG,SAAS,GAAG,MAAM,CAAC;IACpC,CAAC;IAEO,mBAAmB,CAAC,GAAW;QACtC,OAAO,GAAG,CAAC,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;IAChC,CAAC;;AAhDI,+BAA+B;IAYvB,WAAA,uBAAuB,CAAA;GAZ/B,+BAA+B,CAiDpC;AAED,YAAY;AAEZ,2BAA2B;AAE3B,MAAM,uBAAuB;IAM5B,YACkB,WAAiC,EACjC,eAA+B,EAC/B,kBAAwC,EACxC,eAAsC,EACtC,WAAwB;QAJxB,gBAAW,GAAX,WAAW,CAAsB;QACjC,oBAAe,GAAf,eAAe,CAAgB;QAC/B,uBAAkB,GAAlB,kBAAkB,CAAsB;QACxC,oBAAe,GAAf,eAAe,CAAuB;QACtC,gBAAW,GAAX,WAAW,CAAa;QAV1B,mBAAc,GAAG,QAAQ,CAAC;QAEzB,gBAAW,GAAG,IAAI,sBAAsB,EAAiB,CAAC;IAU3E,CAAC;IAEM,IAAI,CAAC,QAAgB,EAAE,MAAW;QAExC,uDAAuD;QACvD,MAAM,GAAG,GAAG,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QACpD,IAAI,GAAG,EAAE,CAAC;YACT,IAAI,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC;YACnD,IAAI,CAAC,OAAO,EAAE,CAAC;gBACd,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,EAAE,IAAI,CAAC,kBAAkB,EAAE,IAAI,CAAC,eAAe,CAAC,CAAC;gBAC/E,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;YAC/C,CAAC;YACD,OAAO,OAAO,CAAC;QAChB,CAAC;QAED,wCAAwC;QACxC,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC;YAC3B,IAAI,oBAAoB,GAAG,EAAE,CAAC;YAC9B,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC,KAAK,EAAE,KAAK,EAAE,EAAE,CAAC,oBAAoB,IAAI,KAAK,KAAK,OAAO,KAAK,CAAC,UAAU,CAAC,KAAK,IAAI,CAAC,CAAC;YACpH,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,+DAA+D,MAAM,8CAA8C,oBAAoB,EAAE,CAAC,CAAC;YACjK,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,WAAW,CAAC,wBAAwB,EAAE,IAAI,CAAC,kBAAkB,EAAE,IAAI,CAAC,eAAe,CAAC,CAAC;QAClH,CAAC;QACD,OAAO,IAAI,CAAC,eAAe,CAAC;IAC7B,CAAC;CACD;AAmBD,IAAM,qBAAqB,GAA3B,MAAM,qBAAqB;IAS1B,YACkB,eAA+B,EAC/B,aAAqB,EAClB,UAA8B;QAFjC,oBAAe,GAAf,eAAe,CAAgB;QAC/B,kBAAa,GAAb,aAAa,CAAQ;QATvB,mBAAc,GAAa,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;QAa1D,IAAI,CAAC,oBAAoB,GAAG,UAAU,CAAC,QAAQ,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC;QACjF,MAAM,gBAAgB,GAAG,UAAU,CAAC,QAAQ,CAAC,WAAW,CAAC,gBAAgB,CAAC,CAAC;QAE3E,IAAI,CAAC,KAAK,GAAG,CAAC,MAAM,EAAE,OAAO,EAAE,EAAE;YAChC,MAAM,GAAG,GAAQ,GAAG,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;YACnC,8CAA8C;YAC9C,IAAI,OAAO,EAAE,CAAC;gBACb,OAAO,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;YAC3C,CAAC;YACD,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,IAAI,GAAG,CAAC,MAAM,KAAK,OAAO,EAAE,CAAC;gBACrD,OAAO,gBAAgB,CAAC,QAAQ,CAAC,GAAG,EAAE,MAAM,EAAE,EAAE,cAAc,EAAE,IAAI,EAAE,CAAC,CAAC;YACzE,CAAC;iBAAM,IAAI,GAAG,CAAC,MAAM,KAAK,QAAQ,IAAI,GAAG,CAAC,MAAM,KAAK,IAAI,CAAC,aAAa,EAAE,CAAC;gBACzE,OAAO,gBAAgB,CAAC,QAAQ,CAAC,GAAG,EAAE,MAAM,EAAE,EAAE,CAAC,CAAC;YACnD,CAAC;YACD,OAAO,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;QAC3C,CAAC,CAAC;IACH,CAAC;IAEM,IAAI,CAAC,OAAe,EAAE,MAAW,EAAE,QAAsB;QAC/D,uDAAuD;QACvD,MAAM,SAAS,GAAG,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QAC1D,IAAI,SAAS,EAAE,CAAC;YACf,IAAI,CAAC,YAAY,GAAG,SAAS,CAAC,UAAU,CAAC,KAAK,CAAC;YAC/C,IAAI,CAAC,qBAAqB,EAAE,CAAC;QAC9B,CAAC;QAED,IAAI,CAAC,SAAS,GAAG,QAAQ,CAAC,OAAO,CAAC,CAAC;QACnC,OAAO,IAAI,CAAC,KAAK,CAAC;IACnB,CAAC;IAEO,YAAY,CAAC,MAAc,EAAE,OAAgC;QACpE,IAAI,CAAC,sBAAsB,EAAE,CAAC;QAC9B,OAAO,IAAI,CAAC,SAAU,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;IACzC,CAAC;IAEO,qBAAqB;QAC5B,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC;YACxB,OAAO;QACR,CAAC;QAMD,IAAI,CAAC,oBAAoB,CAAC,WAAW,CAAoD,eAAe,EAAE,EAAE,SAAS,EAAE,IAAI,CAAC,YAAY,EAAE,CAAC,CAAC;IAC7I,CAAC;IAEO,sBAAsB;QAC7B,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC;YACxB,OAAO;QACR,CAAC;QAMD,IAAI,CAAC,oBAAoB,CAAC,WAAW,CAAiE,8BAA8B,EAAE,EAAE,SAAS,EAAE,IAAI,CAAC,YAAY,EAAE,CAAC,CAAC;IACzK,CAAC;CACD,CAAA;AAzEK,qBAAqB;IAYxB,WAAA,kBAAkB,CAAA;GAZf,qBAAqB,CAyE1B;AAED,YAAY","file":"extHostRequireInterceptor.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as performance from '../../../base/common/performance.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { MainThreadTelemetryShape, MainContext } from './extHost.protocol.js';\nimport { ExtHostConfigProvider, IExtHostConfiguration } from './extHostConfiguration.js';\nimport { nullExtensionDescription } from '../../services/extensions/common/extensions.js';\nimport * as vscode from 'vscode';\nimport { ExtensionIdentifierMap } from '../../../platform/extensions/common/extensions.js';\nimport { IExtensionApiFactory, IExtensionRegistries } from './extHost.api.impl.js';\nimport { IExtHostRpcService } from './extHostRpcService.js';\nimport { IExtHostInitDataService } from './extHostInitDataService.js';\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\nimport { ExtensionPaths, IExtHostExtensionService } from './extHostExtensionService.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { escapeRegExpCharacters } from '../../../base/common/strings.js';\n\n\ninterface LoadFunction {\n\t(request: string): any;\n}\n\ninterface IAlternativeModuleProvider {\n\talternativeModuleName(name: string): string | undefined;\n}\n\nexport interface INodeModuleFactory extends Partial<IAlternativeModuleProvider> {\n\treadonly nodeModuleName: string | string[];\n\tload(request: string, parent: URI, original: LoadFunction): any;\n}\n\nexport abstract class RequireInterceptor {\n\n\tprotected readonly _factories: Map<string, INodeModuleFactory>;\n\tprotected readonly _alternatives: ((moduleName: string) => string | undefined)[];\n\n\tconstructor(\n\t\tprivate _apiFactory: IExtensionApiFactory,\n\t\tprivate _extensionRegistry: IExtensionRegistries,\n\t\t@IInstantiationService private readonly _instaService: IInstantiationService,\n\t\t@IExtHostConfiguration private readonly _extHostConfiguration: IExtHostConfiguration,\n\t\t@IExtHostExtensionService private readonly _extHostExtensionService: IExtHostExtensionService,\n\t\t@IExtHostInitDataService private readonly _initData: IExtHostInitDataService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._factories = new Map<string, INodeModuleFactory>();\n\t\tthis._alternatives = [];\n\t}\n\n\tasync install(): Promise<void> {\n\n\t\tthis._installInterceptor();\n\n\t\tperformance.mark('code/extHost/willWaitForConfig');\n\t\tconst configProvider = await this._extHostConfiguration.getConfigProvider();\n\t\tperformance.mark('code/extHost/didWaitForConfig');\n\t\tconst extensionPaths = await this._extHostExtensionService.getExtensionPathIndex();\n\n\t\tthis.register(new VSCodeNodeModuleFactory(this._apiFactory, extensionPaths, this._extensionRegistry, configProvider, this._logService));\n\t\tthis.register(this._instaService.createInstance(NodeModuleAliasingModuleFactory));\n\t\tif (this._initData.remote.isRemote) {\n\t\t\tthis.register(this._instaService.createInstance(OpenNodeModuleFactory, extensionPaths, this._initData.environment.appUriScheme));\n\t\t}\n\t}\n\n\tprotected abstract _installInterceptor(): void;\n\n\tpublic register(interceptor: INodeModuleFactory | IAlternativeModuleProvider): void {\n\t\tif ('nodeModuleName' in interceptor) {\n\t\t\tif (Array.isArray(interceptor.nodeModuleName)) {\n\t\t\t\tfor (const moduleName of interceptor.nodeModuleName) {\n\t\t\t\t\tthis._factories.set(moduleName, interceptor);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis._factories.set(interceptor.nodeModuleName, interceptor);\n\t\t\t}\n\t\t}\n\n\t\tif (typeof interceptor.alternativeModuleName === 'function') {\n\t\t\tthis._alternatives.push((moduleName) => {\n\t\t\t\treturn interceptor.alternativeModuleName!(moduleName);\n\t\t\t});\n\t\t}\n\t}\n}\n\n//#region --- module renames\n\nclass NodeModuleAliasingModuleFactory implements IAlternativeModuleProvider {\n\t/**\n\t * Map of aliased internal node_modules, used to allow for modules to be\n\t * renamed without breaking extensions. In the form \"original -> new name\".\n\t */\n\tprivate static readonly aliased: ReadonlyMap<string, string> = new Map([\n\t\t['vscode-ripgrep', '@vscode/ripgrep'],\n\t\t['vscode-windows-registry', '@vscode/windows-registry'],\n\t]);\n\n\tprivate readonly re?: RegExp;\n\n\tconstructor(@IExtHostInitDataService initData: IExtHostInitDataService) {\n\t\tif (initData.environment.appRoot && NodeModuleAliasingModuleFactory.aliased.size) {\n\t\t\tconst root = escapeRegExpCharacters(this.forceForwardSlashes(initData.environment.appRoot.fsPath));\n\t\t\t// decompose ${appRoot}/node_modules/foo/bin to ['${appRoot}/node_modules/', 'foo', '/bin'],\n\t\t\t// and likewise the more complex form ${appRoot}/node_modules.asar.unpacked/@vcode/foo/bin\n\t\t\t// to ['${appRoot}/node_modules.asar.unpacked/',' @vscode/foo', '/bin'].\n\t\t\tconst npmIdChrs = `[a-z0-9_.-]`;\n\t\t\tconst npmModuleName = `@${npmIdChrs}+\\\\/${npmIdChrs}+|${npmIdChrs}+`;\n\t\t\tconst moduleFolders = 'node_modules|node_modules\\\\.asar(?:\\\\.unpacked)?';\n\t\t\tthis.re = new RegExp(`^(${root}/${moduleFolders}\\\\/)(${npmModuleName})(.*)$`, 'i');\n\t\t}\n\t}\n\n\tpublic alternativeModuleName(name: string): string | undefined {\n\t\tif (!this.re) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst result = this.re.exec(this.forceForwardSlashes(name));\n\t\tif (!result) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst [, prefix, moduleName, suffix] = result;\n\t\tconst dealiased = NodeModuleAliasingModuleFactory.aliased.get(moduleName);\n\t\tif (dealiased === undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.warn(`${moduleName} as been renamed to ${dealiased}, please update your imports`);\n\n\t\treturn prefix + dealiased + suffix;\n\t}\n\n\tprivate forceForwardSlashes(str: string) {\n\t\treturn str.replace(/\\\\/g, '/');\n\t}\n}\n\n//#endregion\n\n//#region --- vscode-module\n\nclass VSCodeNodeModuleFactory implements INodeModuleFactory {\n\tpublic readonly nodeModuleName = 'vscode';\n\n\tprivate readonly _extApiImpl = new ExtensionIdentifierMap<typeof vscode>();\n\tprivate _defaultApiImpl?: typeof vscode;\n\n\tconstructor(\n\t\tprivate readonly _apiFactory: IExtensionApiFactory,\n\t\tprivate readonly _extensionPaths: ExtensionPaths,\n\t\tprivate readonly _extensionRegistry: IExtensionRegistries,\n\t\tprivate readonly _configProvider: ExtHostConfigProvider,\n\t\tprivate readonly _logService: ILogService,\n\t) {\n\t}\n\n\tpublic load(_request: string, parent: URI): any {\n\n\t\t// get extension id from filename and api for extension\n\t\tconst ext = this._extensionPaths.findSubstr(parent);\n\t\tif (ext) {\n\t\t\tlet apiImpl = this._extApiImpl.get(ext.identifier);\n\t\t\tif (!apiImpl) {\n\t\t\t\tapiImpl = this._apiFactory(ext, this._extensionRegistry, this._configProvider);\n\t\t\t\tthis._extApiImpl.set(ext.identifier, apiImpl);\n\t\t\t}\n\t\t\treturn apiImpl;\n\t\t}\n\n\t\t// fall back to a default implementation\n\t\tif (!this._defaultApiImpl) {\n\t\t\tlet extensionPathsPretty = '';\n\t\t\tthis._extensionPaths.forEach((value, index) => extensionPathsPretty += `\\t${index} -> ${value.identifier.value}\\n`);\n\t\t\tthis._logService.warn(`Could not identify extension for 'vscode' require call from ${parent}. These are the extension path mappings: \\n${extensionPathsPretty}`);\n\t\t\tthis._defaultApiImpl = this._apiFactory(nullExtensionDescription, this._extensionRegistry, this._configProvider);\n\t\t}\n\t\treturn this._defaultApiImpl;\n\t}\n}\n\n//#endregion\n\n//#region --- opn/open-module\n\ninterface OpenOptions {\n\twait: boolean;\n\tapp: string | string[];\n}\n\ninterface IOriginalOpen {\n\t(target: string, options?: OpenOptions): Thenable<any>;\n}\n\ninterface IOpenModule {\n\t(target: string, options?: OpenOptions): Thenable<void>;\n}\n\nclass OpenNodeModuleFactory implements INodeModuleFactory {\n\n\tpublic readonly nodeModuleName: string[] = ['open', 'opn'];\n\n\tprivate _extensionId: string | undefined;\n\tprivate _original?: IOriginalOpen;\n\tprivate _impl: IOpenModule;\n\tprivate _mainThreadTelemetry: MainThreadTelemetryShape;\n\n\tconstructor(\n\t\tprivate readonly _extensionPaths: ExtensionPaths,\n\t\tprivate readonly _appUriScheme: string,\n\t\t@IExtHostRpcService rpcService: IExtHostRpcService,\n\t) {\n\n\t\tthis._mainThreadTelemetry = rpcService.getProxy(MainContext.MainThreadTelemetry);\n\t\tconst mainThreadWindow = rpcService.getProxy(MainContext.MainThreadWindow);\n\n\t\tthis._impl = (target, options) => {\n\t\t\tconst uri: URI = URI.parse(target);\n\t\t\t// If we have options use the original method.\n\t\t\tif (options) {\n\t\t\t\treturn this.callOriginal(target, options);\n\t\t\t}\n\t\t\tif (uri.scheme === 'http' || uri.scheme === 'https') {\n\t\t\t\treturn mainThreadWindow.$openUri(uri, target, { allowTunneling: true });\n\t\t\t} else if (uri.scheme === 'mailto' || uri.scheme === this._appUriScheme) {\n\t\t\t\treturn mainThreadWindow.$openUri(uri, target, {});\n\t\t\t}\n\t\t\treturn this.callOriginal(target, options);\n\t\t};\n\t}\n\n\tpublic load(request: string, parent: URI, original: LoadFunction): any {\n\t\t// get extension id from filename and api for extension\n\t\tconst extension = this._extensionPaths.findSubstr(parent);\n\t\tif (extension) {\n\t\t\tthis._extensionId = extension.identifier.value;\n\t\t\tthis.sendShimmingTelemetry();\n\t\t}\n\n\t\tthis._original = original(request);\n\t\treturn this._impl;\n\t}\n\n\tprivate callOriginal(target: string, options: OpenOptions | undefined): Thenable<any> {\n\t\tthis.sendNoForwardTelemetry();\n\t\treturn this._original!(target, options);\n\t}\n\n\tprivate sendShimmingTelemetry(): void {\n\t\tif (!this._extensionId) {\n\t\t\treturn;\n\t\t}\n\t\ttype ShimmingOpenClassification = {\n\t\t\towner: 'jrieken';\n\t\t\tcomment: 'Know when the open-shim was used';\n\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The extension is question' };\n\t\t};\n\t\tthis._mainThreadTelemetry.$publicLog2<{ extension: string }, ShimmingOpenClassification>('shimming.open', { extension: this._extensionId });\n\t}\n\n\tprivate sendNoForwardTelemetry(): void {\n\t\tif (!this._extensionId) {\n\t\t\treturn;\n\t\t}\n\t\ttype ShimmingOpenCallNoForwardClassification = {\n\t\t\towner: 'jrieken';\n\t\t\tcomment: 'Know when the open-shim was used';\n\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The extension is question' };\n\t\t};\n\t\tthis._mainThreadTelemetry.$publicLog2<{ extension: string }, ShimmingOpenCallNoForwardClassification>('shimming.open.call.noForward', { extension: this._extensionId });\n\t}\n}\n\n//#endregion\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as performance from '../../../base/common/performance.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { MainThreadTelemetryShape, MainContext } from './extHost.protocol.js';\nimport { ExtHostConfigProvider, IExtHostConfiguration } from './extHostConfiguration.js';\nimport { nullExtensionDescription } from '../../services/extensions/common/extensions.js';\nimport * as vscode from 'vscode';\nimport { ExtensionIdentifierMap } from '../../../platform/extensions/common/extensions.js';\nimport { IExtensionApiFactory, IExtensionRegistries } from './extHost.api.impl.js';\nimport { IExtHostRpcService } from './extHostRpcService.js';\nimport { IExtHostInitDataService } from './extHostInitDataService.js';\nimport { IInstantiationService } from '../../../platform/instantiation/common/instantiation.js';\nimport { ExtensionPaths, IExtHostExtensionService } from './extHostExtensionService.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { escapeRegExpCharacters } from '../../../base/common/strings.js';\n\n\ninterface LoadFunction {\n\t(request: string): any;\n}\n\ninterface IAlternativeModuleProvider {\n\talternativeModuleName(name: string): string | undefined;\n}\n\nexport interface INodeModuleFactory extends Partial<IAlternativeModuleProvider> {\n\treadonly nodeModuleName: string | string[];\n\tload(request: string, parent: URI, original: LoadFunction): any;\n}\n\nexport abstract class RequireInterceptor {\n\n\tprotected readonly _factories: Map<string, INodeModuleFactory>;\n\tprotected readonly _alternatives: ((moduleName: string) => string | undefined)[];\n\n\tconstructor(\n\t\tprivate _apiFactory: IExtensionApiFactory,\n\t\tprivate _extensionRegistry: IExtensionRegistries,\n\t\t@IInstantiationService private readonly _instaService: IInstantiationService,\n\t\t@IExtHostConfiguration private readonly _extHostConfiguration: IExtHostConfiguration,\n\t\t@IExtHostExtensionService private readonly _extHostExtensionService: IExtHostExtensionService,\n\t\t@IExtHostInitDataService private readonly _initData: IExtHostInitDataService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._factories = new Map<string, INodeModuleFactory>();\n\t\tthis._alternatives = [];\n\t}\n\n\tasync install(): Promise<void> {\n\n\t\tthis._installInterceptor();\n\n\t\tperformance.mark('code/extHost/willWaitForConfig');\n\t\tconst configProvider = await this._extHostConfiguration.getConfigProvider();\n\t\tperformance.mark('code/extHost/didWaitForConfig');\n\t\tconst extensionPaths = await this._extHostExtensionService.getExtensionPathIndex();\n\n\t\tthis.register(new VSCodeNodeModuleFactory(this._apiFactory, extensionPaths, this._extensionRegistry, configProvider, this._logService));\n\t\tthis.register(this._instaService.createInstance(NodeModuleAliasingModuleFactory));\n\t\tif (this._initData.remote.isRemote) {\n\t\t\tthis.register(this._instaService.createInstance(OpenNodeModuleFactory, extensionPaths, this._initData.environment.appUriScheme));\n\t\t}\n\t}\n\n\tprotected abstract _installInterceptor(): void;\n\n\tpublic register(interceptor: INodeModuleFactory | IAlternativeModuleProvider): void {\n\t\tif ('nodeModuleName' in interceptor) {\n\t\t\tif (Array.isArray(interceptor.nodeModuleName)) {\n\t\t\t\tfor (const moduleName of interceptor.nodeModuleName) {\n\t\t\t\t\tthis._factories.set(moduleName, interceptor);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis._factories.set(interceptor.nodeModuleName, interceptor);\n\t\t\t}\n\t\t}\n\n\t\tif (typeof interceptor.alternativeModuleName === 'function') {\n\t\t\tthis._alternatives.push((moduleName) => {\n\t\t\t\treturn interceptor.alternativeModuleName!(moduleName);\n\t\t\t});\n\t\t}\n\t}\n}\n\n//#region --- module renames\n\nclass NodeModuleAliasingModuleFactory implements IAlternativeModuleProvider {\n\t/**\n\t * Map of aliased internal node_modules, used to allow for modules to be\n\t * renamed without breaking extensions. In the form \"original -> new name\".\n\t */\n\tprivate static readonly aliased: ReadonlyMap<string, string> = new Map([\n\t\t['vscode-ripgrep', '@vscode/ripgrep'],\n\t\t['vscode-windows-registry', '@vscode/windows-registry'],\n\t]);\n\n\tprivate readonly re?: RegExp;\n\n\tconstructor(@IExtHostInitDataService initData: IExtHostInitDataService) {\n\t\tif (initData.environment.appRoot && NodeModuleAliasingModuleFactory.aliased.size) {\n\t\t\tconst root = escapeRegExpCharacters(this.forceForwardSlashes(initData.environment.appRoot.fsPath));\n\t\t\t// decompose ${appRoot}/node_modules/foo/bin to ['${appRoot}/node_modules/', 'foo', '/bin'],\n\t\t\t// and likewise the more complex form ${appRoot}/node_modules.asar.unpacked/@vcode/foo/bin\n\t\t\t// to ['${appRoot}/node_modules.asar.unpacked/',' @vscode/foo', '/bin'].\n\t\t\tconst npmIdChrs = `[a-z0-9_.-]`;\n\t\t\tconst npmModuleName = `@${npmIdChrs}+\\\\/${npmIdChrs}+|${npmIdChrs}+`;\n\t\t\tconst moduleFolders = 'node_modules|node_modules\\\\.asar(?:\\\\.unpacked)?';\n\t\t\tthis.re = new RegExp(`^(${root}/${moduleFolders}\\\\/)(${npmModuleName})(.*)$`, 'i');\n\t\t}\n\t}\n\n\tpublic alternativeModuleName(name: string): string | undefined {\n\t\tif (!this.re) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst result = this.re.exec(this.forceForwardSlashes(name));\n\t\tif (!result) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst [, prefix, moduleName, suffix] = result;\n\t\tconst dealiased = NodeModuleAliasingModuleFactory.aliased.get(moduleName);\n\t\tif (dealiased === undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.warn(`${moduleName} as been renamed to ${dealiased}, please update your imports`);\n\n\t\treturn prefix + dealiased + suffix;\n\t}\n\n\tprivate forceForwardSlashes(str: string) {\n\t\treturn str.replace(/\\\\/g, '/');\n\t}\n}\n\n//#endregion\n\n//#region --- vscode-module\n\nclass VSCodeNodeModuleFactory implements INodeModuleFactory {\n\tpublic readonly nodeModuleName = 'vscode';\n\n\tprivate readonly _extApiImpl = new ExtensionIdentifierMap<typeof vscode>();\n\tprivate _defaultApiImpl?: typeof vscode;\n\n\tconstructor(\n\t\tprivate readonly _apiFactory: IExtensionApiFactory,\n\t\tprivate readonly _extensionPaths: ExtensionPaths,\n\t\tprivate readonly _extensionRegistry: IExtensionRegistries,\n\t\tprivate readonly _configProvider: ExtHostConfigProvider,\n\t\tprivate readonly _logService: ILogService,\n\t) {\n\t}\n\n\tpublic load(_request: string, parent: URI): any {\n\n\t\t// get extension id from filename and api for extension\n\t\tconst ext = this._extensionPaths.findSubstr(parent);\n\t\tif (ext) {\n\t\t\tlet apiImpl = this._extApiImpl.get(ext.identifier);\n\t\t\tif (!apiImpl) {\n\t\t\t\tapiImpl = this._apiFactory(ext, this._extensionRegistry, this._configProvider);\n\t\t\t\tthis._extApiImpl.set(ext.identifier, apiImpl);\n\t\t\t}\n\t\t\treturn apiImpl;\n\t\t}\n\n\t\t// fall back to a default implementation\n\t\tif (!this._defaultApiImpl) {\n\t\t\tlet extensionPathsPretty = '';\n\t\t\tthis._extensionPaths.forEach((value, index) => extensionPathsPretty += `\\t${index} -> ${value.identifier.value}\\n`);\n\t\t\tthis._logService.warn(`Could not identify extension for 'vscode' require call from ${parent}. These are the extension path mappings: \\n${extensionPathsPretty}`);\n\t\t\tthis._defaultApiImpl = this._apiFactory(nullExtensionDescription, this._extensionRegistry, this._configProvider);\n\t\t}\n\t\treturn this._defaultApiImpl;\n\t}\n}\n\n//#endregion\n\n//#region --- opn/open-module\n\ninterface OpenOptions {\n\twait: boolean;\n\tapp: string | string[];\n}\n\ninterface IOriginalOpen {\n\t(target: string, options?: OpenOptions): Thenable<any>;\n}\n\ninterface IOpenModule {\n\t(target: string, options?: OpenOptions): Thenable<void>;\n}\n\nclass OpenNodeModuleFactory implements INodeModuleFactory {\n\n\tpublic readonly nodeModuleName: string[] = ['open', 'opn'];\n\n\tprivate _extensionId: string | undefined;\n\tprivate _original?: IOriginalOpen;\n\tprivate _impl: IOpenModule;\n\tprivate _mainThreadTelemetry: MainThreadTelemetryShape;\n\n\tconstructor(\n\t\tprivate readonly _extensionPaths: ExtensionPaths,\n\t\tprivate readonly _appUriScheme: string,\n\t\t@IExtHostRpcService rpcService: IExtHostRpcService,\n\t) {\n\n\t\tthis._mainThreadTelemetry = rpcService.getProxy(MainContext.MainThreadTelemetry);\n\t\tconst mainThreadWindow = rpcService.getProxy(MainContext.MainThreadWindow);\n\n\t\tthis._impl = (target, options) => {\n\t\t\tconst uri: URI = URI.parse(target);\n\t\t\t// If we have options use the original method.\n\t\t\tif (options) {\n\t\t\t\treturn this.callOriginal(target, options);\n\t\t\t}\n\t\t\tif (uri.scheme === 'http' || uri.scheme === 'https') {\n\t\t\t\treturn mainThreadWindow.$openUri(uri, target, { allowTunneling: true });\n\t\t\t} else if (uri.scheme === 'mailto' || uri.scheme === this._appUriScheme) {\n\t\t\t\treturn mainThreadWindow.$openUri(uri, target, {});\n\t\t\t}\n\t\t\treturn this.callOriginal(target, options);\n\t\t};\n\t}\n\n\tpublic load(request: string, parent: URI, original: LoadFunction): any {\n\t\t// get extension id from filename and api for extension\n\t\tconst extension = this._extensionPaths.findSubstr(parent);\n\t\tif (extension) {\n\t\t\tthis._extensionId = extension.identifier.value;\n\t\t\tthis.sendShimmingTelemetry();\n\t\t}\n\n\t\tthis._original = original(request);\n\t\treturn this._impl;\n\t}\n\n\tprivate callOriginal(target: string, options: OpenOptions | undefined): Thenable<any> {\n\t\tthis.sendNoForwardTelemetry();\n\t\treturn this._original!(target, options);\n\t}\n\n\tprivate sendShimmingTelemetry(): void {\n\t\tif (!this._extensionId) {\n\t\t\treturn;\n\t\t}\n\t\ttype ShimmingOpenClassification = {\n\t\t\towner: 'jrieken';\n\t\t\tcomment: 'Know when the open-shim was used';\n\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The extension is question' };\n\t\t};\n\t\tthis._mainThreadTelemetry.$publicLog2<{ extension: string }, ShimmingOpenClassification>('shimming.open', { extension: this._extensionId });\n\t}\n\n\tprivate sendNoForwardTelemetry(): void {\n\t\tif (!this._extensionId) {\n\t\t\treturn;\n\t\t}\n\t\ttype ShimmingOpenCallNoForwardClassification = {\n\t\t\towner: 'jrieken';\n\t\t\tcomment: 'Know when the open-shim was used';\n\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The extension is question' };\n\t\t};\n\t\tthis._mainThreadTelemetry.$publicLog2<{ extension: string }, ShimmingOpenCallNoForwardClassification>('shimming.open.call.noForward', { extension: this._extensionId });\n\t}\n}\n\n//#endregion\n"]}