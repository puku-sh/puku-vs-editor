{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostNotebookKernels.ts","vs/workbench/api/common/extHostNotebookKernels.ts"],"names":[],"mappings":"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","file":"extHostNotebookKernels.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { asArray } from '../../../base/common/arrays.js';\nimport { DeferredPromise, timeout } from '../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../base/common/map.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { ExtensionIdentifier, IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { ExtHostNotebookKernelsShape, ICellExecuteUpdateDto, IMainContext, INotebookKernelDto2, MainContext, MainThreadNotebookKernelsShape, NotebookOutputDto, VariablesResult } from './extHost.protocol.js';\nimport { ApiCommand, ApiCommandArgument, ApiCommandResult, ExtHostCommands } from './extHostCommands.js';\nimport { IExtHostInitDataService } from './extHostInitDataService.js';\nimport { ExtHostNotebookController } from './extHostNotebook.js';\nimport { ExtHostCell, ExtHostNotebookDocument } from './extHostNotebookDocument.js';\nimport * as extHostTypeConverters from './extHostTypeConverters.js';\nimport { NotebookCellOutput, NotebookControllerAffinity2, NotebookVariablesRequestKind } from './extHostTypes.js';\nimport { asWebviewUri } from '../../contrib/webview/common/webview.js';\nimport { INotebookKernelSourceAction } from '../../contrib/notebook/common/notebookCommon.js';\nimport { CellExecutionUpdateType } from '../../contrib/notebook/common/notebookExecutionService.js';\nimport { checkProposedApiEnabled } from '../../services/extensions/common/extensions.js';\nimport { SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\nimport * as vscode from 'vscode';\nimport { variablePageSize } from '../../contrib/notebook/common/notebookKernelService.js';\n\ninterface IKernelData {\n\textensionId: ExtensionIdentifier;\n\tcontroller: vscode.NotebookController;\n\tonDidChangeSelection: Emitter<{ selected: boolean; notebook: vscode.NotebookDocument }>;\n\tonDidReceiveMessage: Emitter<{ editor: vscode.NotebookEditor; message: unknown }>;\n\tassociatedNotebooks: ResourceMap<boolean>;\n}\n\ntype ExtHostSelectKernelArgs = ControllerInfo | { notebookEditor: vscode.NotebookEditor } | ControllerInfo & { notebookEditor: vscode.NotebookEditor } | undefined;\ntype SelectKernelReturnArgs = ControllerInfo | { notebookEditorId: string } | ControllerInfo & { notebookEditorId: string } | undefined;\ntype ControllerInfo = { id: string; extension: string };\n\n\nexport class ExtHostNotebookKernels implements ExtHostNotebookKernelsShape {\n\n\tprivate readonly _proxy: MainThreadNotebookKernelsShape;\n\tprivate readonly _activeExecutions = new ResourceMap<NotebookCellExecutionTask>();\n\tprivate readonly _activeNotebookExecutions = new ResourceMap<[NotebookExecutionTask, IDisposable]>();\n\n\tprivate _kernelDetectionTask = new Map<number, vscode.NotebookControllerDetectionTask>();\n\tprivate _kernelDetectionTaskHandlePool: number = 0;\n\n\tprivate _kernelSourceActionProviders = new Map<number, vscode.NotebookKernelSourceActionProvider>();\n\tprivate _kernelSourceActionProviderHandlePool: number = 0;\n\n\tprivate readonly _kernelData = new Map<number, IKernelData>();\n\tprivate _handlePool: number = 0;\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tprivate readonly _initData: IExtHostInitDataService,\n\t\tprivate readonly _extHostNotebook: ExtHostNotebookController,\n\t\tprivate _commands: ExtHostCommands,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadNotebookKernels);\n\n\t\t// todo@rebornix @joyceerhl: move to APICommands once stabilized.\n\t\tconst selectKernelApiCommand = new ApiCommand(\n\t\t\t'notebook.selectKernel',\n\t\t\t'_notebook.selectKernel',\n\t\t\t'Trigger kernel picker for specified notebook editor widget',\n\t\t\t[\n\t\t\t\tnew ApiCommandArgument<ExtHostSelectKernelArgs, SelectKernelReturnArgs>('options', 'Select kernel options', v => true, (v: ExtHostSelectKernelArgs) => {\n\t\t\t\t\tif (v && 'notebookEditor' in v && 'id' in v) {\n\t\t\t\t\t\tconst notebookEditorId = this._extHostNotebook.getIdByEditor(v.notebookEditor);\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tid: v.id, extension: v.extension, notebookEditorId\n\t\t\t\t\t\t};\n\t\t\t\t\t} else if (v && 'notebookEditor' in v) {\n\t\t\t\t\t\tconst notebookEditorId = this._extHostNotebook.getIdByEditor(v.notebookEditor);\n\t\t\t\t\t\tif (notebookEditorId === undefined) {\n\t\t\t\t\t\t\tthrow new Error(`Cannot invoke 'notebook.selectKernel' for unrecognized notebook editor ${v.notebookEditor.notebook.uri.toString()}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ('skipIfAlreadySelected' in v) {\n\t\t\t\t\t\t\treturn { notebookEditorId, skipIfAlreadySelected: v.skipIfAlreadySelected };\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn { notebookEditorId };\n\t\t\t\t\t}\n\t\t\t\t\treturn v;\n\t\t\t\t})\n\t\t\t],\n\t\t\tApiCommandResult.Void);\n\n\t\tconst requestKernelVariablesApiCommand = new ApiCommand(\n\t\t\t'vscode.executeNotebookVariableProvider',\n\t\t\t'_executeNotebookVariableProvider',\n\t\t\t'Execute notebook variable provider',\n\t\t\t[ApiCommandArgument.Uri],\n\t\t\tnew ApiCommandResult<VariablesResult[], vscode.VariablesResult[]>('A promise that resolves to an array of variables', (value, apiArgs) => {\n\t\t\t\treturn value.map(variable => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tvariable: {\n\t\t\t\t\t\t\tname: variable.name,\n\t\t\t\t\t\t\tvalue: variable.value,\n\t\t\t\t\t\t\texpression: variable.expression,\n\t\t\t\t\t\t\ttype: variable.type,\n\t\t\t\t\t\t\tlanguage: variable.language\n\t\t\t\t\t\t},\n\t\t\t\t\t\thasNamedChildren: variable.hasNamedChildren,\n\t\t\t\t\t\tindexedChildrenCount: variable.indexedChildrenCount\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t})\n\t\t);\n\t\tthis._commands.registerApiCommand(selectKernelApiCommand);\n\t\tthis._commands.registerApiCommand(requestKernelVariablesApiCommand);\n\t}\n\n\tcreateNotebookController(extension: IExtensionDescription, id: string, viewType: string, label: string, handler?: (cells: vscode.NotebookCell[], notebook: vscode.NotebookDocument, controller: vscode.NotebookController) => void | Thenable<void>, preloads?: vscode.NotebookRendererScript[]): vscode.NotebookController {\n\n\t\tfor (const data of this._kernelData.values()) {\n\t\t\tif (data.controller.id === id && ExtensionIdentifier.equals(extension.identifier, data.extensionId)) {\n\t\t\t\tthrow new Error(`notebook controller with id '${id}' ALREADY exist`);\n\t\t\t}\n\t\t}\n\n\n\t\tconst handle = this._handlePool++;\n\t\tconst that = this;\n\n\t\tthis._logService.trace(`NotebookController[${handle}], CREATED by ${extension.identifier.value}, ${id}`);\n\n\t\tconst _defaultExecutHandler = () => console.warn(`NO execute handler from notebook controller '${data.id}' of extension: '${extension.identifier}'`);\n\n\t\tlet isDisposed = false;\n\n\t\tconst onDidChangeSelection = new Emitter<{ selected: boolean; notebook: vscode.NotebookDocument }>();\n\t\tconst onDidReceiveMessage = new Emitter<{ editor: vscode.NotebookEditor; message: unknown }>();\n\n\t\tconst data: INotebookKernelDto2 = {\n\t\t\tid: createKernelId(extension.identifier, id),\n\t\t\tnotebookType: viewType,\n\t\t\textensionId: extension.identifier,\n\t\t\textensionLocation: extension.extensionLocation,\n\t\t\tlabel: label || extension.identifier.value,\n\t\t\tpreloads: preloads ? preloads.map(extHostTypeConverters.NotebookRendererScript.from) : []\n\t\t};\n\n\t\t//\n\t\tlet _executeHandler = handler ?? _defaultExecutHandler;\n\t\tlet _interruptHandler: ((this: vscode.NotebookController, notebook: vscode.NotebookDocument) => void | Thenable<void>) | undefined;\n\t\tlet _variableProvider: vscode.NotebookVariableProvider | undefined;\n\n\t\tthis._proxy.$addKernel(handle, data).catch(err => {\n\t\t\t// this can happen when a kernel with that ID is already registered\n\t\t\tconsole.log(err);\n\t\t\tisDisposed = true;\n\t\t});\n\n\t\t// update: all setters write directly into the dto object\n\t\t// and trigger an update. the actual update will only happen\n\t\t// once per event loop execution\n\t\tlet tokenPool = 0;\n\t\tconst _update = () => {\n\t\t\tif (isDisposed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst myToken = ++tokenPool;\n\t\t\tPromise.resolve().then(() => {\n\t\t\t\tif (myToken === tokenPool) {\n\t\t\t\t\tthis._proxy.$updateKernel(handle, data);\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\n\t\t// notebook documents that are associated to this controller\n\t\tconst associatedNotebooks = new ResourceMap<boolean>();\n\n\t\tconst controller: vscode.NotebookController = {\n\t\t\tget id() { return id; },\n\t\t\tget notebookType() { return data.notebookType; },\n\t\t\tonDidChangeSelectedNotebooks: onDidChangeSelection.event,\n\t\t\tget label() {\n\t\t\t\treturn data.label;\n\t\t\t},\n\t\t\tset label(value) {\n\t\t\t\tdata.label = value ?? extension.displayName ?? extension.name;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget detail() {\n\t\t\t\treturn data.detail ?? '';\n\t\t\t},\n\t\t\tset detail(value) {\n\t\t\t\tdata.detail = value;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget description() {\n\t\t\t\treturn data.description ?? '';\n\t\t\t},\n\t\t\tset description(value) {\n\t\t\t\tdata.description = value;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget supportedLanguages() {\n\t\t\t\treturn data.supportedLanguages;\n\t\t\t},\n\t\t\tset supportedLanguages(value) {\n\t\t\t\tdata.supportedLanguages = value;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget supportsExecutionOrder() {\n\t\t\t\treturn data.supportsExecutionOrder ?? false;\n\t\t\t},\n\t\t\tset supportsExecutionOrder(value) {\n\t\t\t\tdata.supportsExecutionOrder = value;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget rendererScripts() {\n\t\t\t\treturn data.preloads ? data.preloads.map(extHostTypeConverters.NotebookRendererScript.to) : [];\n\t\t\t},\n\t\t\tget executeHandler() {\n\t\t\t\treturn _executeHandler;\n\t\t\t},\n\t\t\tset executeHandler(value) {\n\t\t\t\t_executeHandler = value ?? _defaultExecutHandler;\n\t\t\t},\n\t\t\tget interruptHandler() {\n\t\t\t\treturn _interruptHandler;\n\t\t\t},\n\t\t\tset interruptHandler(value) {\n\t\t\t\t_interruptHandler = value;\n\t\t\t\tdata.supportsInterrupt = Boolean(value);\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tset variableProvider(value) {\n\t\t\t\tcheckProposedApiEnabled(extension, 'notebookVariableProvider');\n\t\t\t\t_variableProvider = value;\n\t\t\t\tdata.hasVariableProvider = !!value;\n\t\t\t\tvalue?.onDidChangeVariables(e => that._proxy.$variablesUpdated(e.uri));\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget variableProvider() {\n\t\t\t\treturn _variableProvider;\n\t\t\t},\n\t\t\tcreateNotebookCellExecution(cell) {\n\t\t\t\tif (isDisposed) {\n\t\t\t\t\tthrow new Error('notebook controller is DISPOSED');\n\t\t\t\t}\n\t\t\t\tif (!associatedNotebooks.has(cell.notebook.uri)) {\n\t\t\t\t\tthat._logService.trace(`NotebookController[${handle}] NOT associated to notebook, associated to THESE notebooks:`, Array.from(associatedNotebooks.keys()).map(u => u.toString()));\n\t\t\t\t\tthrow new Error(`notebook controller is NOT associated to notebook: ${cell.notebook.uri.toString()}`);\n\t\t\t\t}\n\t\t\t\treturn that._createNotebookCellExecution(cell, createKernelId(extension.identifier, this.id));\n\t\t\t},\n\t\t\tcreateNotebookExecution(notebook) {\n\t\t\t\tcheckProposedApiEnabled(extension, 'notebookExecution');\n\t\t\t\tif (isDisposed) {\n\t\t\t\t\tthrow new Error('notebook controller is DISPOSED');\n\t\t\t\t}\n\t\t\t\tif (!associatedNotebooks.has(notebook.uri)) {\n\t\t\t\t\tthat._logService.trace(`NotebookController[${handle}] NOT associated to notebook, associated to THESE notebooks:`, Array.from(associatedNotebooks.keys()).map(u => u.toString()));\n\t\t\t\t\tthrow new Error(`notebook controller is NOT associated to notebook: ${notebook.uri.toString()}`);\n\t\t\t\t}\n\t\t\t\treturn that._createNotebookExecution(notebook, createKernelId(extension.identifier, this.id));\n\t\t\t},\n\t\t\tdispose: () => {\n\t\t\t\tif (!isDisposed) {\n\t\t\t\t\tthis._logService.trace(`NotebookController[${handle}], DISPOSED`);\n\t\t\t\t\tisDisposed = true;\n\t\t\t\t\tthis._kernelData.delete(handle);\n\t\t\t\t\tonDidChangeSelection.dispose();\n\t\t\t\t\tonDidReceiveMessage.dispose();\n\t\t\t\t\tthis._proxy.$removeKernel(handle);\n\t\t\t\t}\n\t\t\t},\n\t\t\t// --- priority\n\t\t\tupdateNotebookAffinity(notebook, priority) {\n\t\t\t\tif (priority === NotebookControllerAffinity2.Hidden) {\n\t\t\t\t\t// This api only adds an extra enum value, the function is the same, so just gate on the new value being passed\n\t\t\t\t\t// for proposedAPI check.\n\t\t\t\t\tcheckProposedApiEnabled(extension, 'notebookControllerAffinityHidden');\n\t\t\t\t}\n\t\t\t\tthat._proxy.$updateNotebookPriority(handle, notebook.uri, priority);\n\t\t\t},\n\t\t\t// --- ipc\n\t\t\tonDidReceiveMessage: onDidReceiveMessage.event,\n\t\t\tpostMessage(message, editor) {\n\t\t\t\tcheckProposedApiEnabled(extension, 'notebookMessaging');\n\t\t\t\treturn that._proxy.$postMessage(handle, editor && that._extHostNotebook.getIdByEditor(editor), message);\n\t\t\t},\n\t\t\tasWebviewUri(uri: URI) {\n\t\t\t\tcheckProposedApiEnabled(extension, 'notebookMessaging');\n\t\t\t\treturn asWebviewUri(uri, that._initData.remote);\n\t\t\t},\n\t\t};\n\n\t\tthis._kernelData.set(handle, {\n\t\t\textensionId: extension.identifier,\n\t\t\tcontroller,\n\t\t\tonDidReceiveMessage,\n\t\t\tonDidChangeSelection,\n\t\t\tassociatedNotebooks\n\t\t});\n\t\treturn controller;\n\t}\n\n\tgetIdByController(controller: vscode.NotebookController) {\n\t\tfor (const [_, candidate] of this._kernelData) {\n\t\t\tif (candidate.controller === controller) {\n\t\t\t\treturn createKernelId(candidate.extensionId, controller.id);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\tcreateNotebookControllerDetectionTask(extension: IExtensionDescription, viewType: string): vscode.NotebookControllerDetectionTask {\n\t\tconst handle = this._kernelDetectionTaskHandlePool++;\n\t\tconst that = this;\n\n\t\tthis._logService.trace(`NotebookControllerDetectionTask[${handle}], CREATED by ${extension.identifier.value}`);\n\t\tthis._proxy.$addKernelDetectionTask(handle, viewType);\n\n\t\tconst detectionTask: vscode.NotebookControllerDetectionTask = {\n\t\t\tdispose: () => {\n\t\t\t\tthis._kernelDetectionTask.delete(handle);\n\t\t\t\tthat._proxy.$removeKernelDetectionTask(handle);\n\t\t\t}\n\t\t};\n\n\t\tthis._kernelDetectionTask.set(handle, detectionTask);\n\t\treturn detectionTask;\n\t}\n\n\tregisterKernelSourceActionProvider(extension: IExtensionDescription, viewType: string, provider: vscode.NotebookKernelSourceActionProvider) {\n\t\tconst handle = this._kernelSourceActionProviderHandlePool++;\n\t\tconst eventHandle = typeof provider.onDidChangeNotebookKernelSourceActions === 'function' ? handle : undefined;\n\t\tconst that = this;\n\n\t\tthis._kernelSourceActionProviders.set(handle, provider);\n\t\tthis._logService.trace(`NotebookKernelSourceActionProvider[${handle}], CREATED by ${extension.identifier.value}`);\n\t\tthis._proxy.$addKernelSourceActionProvider(handle, handle, viewType);\n\n\t\tlet subscription: vscode.Disposable | undefined;\n\t\tif (eventHandle !== undefined) {\n\t\t\tsubscription = provider.onDidChangeNotebookKernelSourceActions!(_ => this._proxy.$emitNotebookKernelSourceActionsChangeEvent(eventHandle));\n\t\t}\n\n\t\treturn {\n\t\t\tdispose: () => {\n\t\t\t\tthis._kernelSourceActionProviders.delete(handle);\n\t\t\t\tthat._proxy.$removeKernelSourceActionProvider(handle, handle);\n\t\t\t\tsubscription?.dispose();\n\t\t\t}\n\t\t};\n\t}\n\n\tasync $provideKernelSourceActions(handle: number, token: CancellationToken): Promise<INotebookKernelSourceAction[]> {\n\t\tconst provider = this._kernelSourceActionProviders.get(handle);\n\t\tif (provider) {\n\t\t\tconst disposables = new DisposableStore();\n\t\t\tconst ret = await provider.provideNotebookKernelSourceActions(token);\n\t\t\treturn (ret ?? []).map(item => extHostTypeConverters.NotebookKernelSourceAction.from(item, this._commands.converter, disposables));\n\t\t}\n\t\treturn [];\n\t}\n\n\t$acceptNotebookAssociation(handle: number, uri: UriComponents, value: boolean): void {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (obj) {\n\t\t\t// update data structure\n\t\t\tconst notebook = this._extHostNotebook.getNotebookDocument(URI.revive(uri))!;\n\t\t\tif (value) {\n\t\t\t\tobj.associatedNotebooks.set(notebook.uri, true);\n\t\t\t} else {\n\t\t\t\tobj.associatedNotebooks.delete(notebook.uri);\n\t\t\t}\n\t\t\tthis._logService.trace(`NotebookController[${handle}] ASSOCIATE notebook`, notebook.uri.toString(), value);\n\t\t\t// send event\n\t\t\tobj.onDidChangeSelection.fire({\n\t\t\t\tselected: value,\n\t\t\t\tnotebook: notebook.apiNotebook\n\t\t\t});\n\t\t}\n\t}\n\n\tasync $executeCells(handle: number, uri: UriComponents, handles: number[]): Promise<void> {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (!obj) {\n\t\t\t// extension can dispose kernels in the meantime\n\t\t\treturn;\n\t\t}\n\t\tconst document = this._extHostNotebook.getNotebookDocument(URI.revive(uri));\n\t\tconst cells: vscode.NotebookCell[] = [];\n\t\tfor (const cellHandle of handles) {\n\t\t\tconst cell = document.getCell(cellHandle);\n\t\t\tif (cell) {\n\t\t\t\tcells.push(cell.apiCell);\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tthis._logService.trace(`NotebookController[${handle}] EXECUTE cells`, document.uri.toString(), cells.length);\n\t\t\tawait obj.controller.executeHandler.call(obj.controller, cells, document.apiNotebook, obj.controller);\n\t\t} catch (err) {\n\t\t\t//\n\t\t\tthis._logService.error(`NotebookController[${handle}] execute cells FAILED`, err);\n\t\t\tconsole.error(err);\n\t\t}\n\t}\n\n\tasync $cancelCells(handle: number, uri: UriComponents, handles: number[]): Promise<void> {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (!obj) {\n\t\t\t// extension can dispose kernels in the meantime\n\t\t\treturn;\n\t\t}\n\n\t\t// cancel or interrupt depends on the controller. When an interrupt handler is used we\n\t\t// don't trigger the cancelation token of executions.\n\t\tconst document = this._extHostNotebook.getNotebookDocument(URI.revive(uri));\n\t\tif (obj.controller.interruptHandler) {\n\t\t\tawait obj.controller.interruptHandler.call(obj.controller, document.apiNotebook);\n\n\t\t} else {\n\t\t\tfor (const cellHandle of handles) {\n\t\t\t\tconst cell = document.getCell(cellHandle);\n\t\t\t\tif (cell) {\n\t\t\t\t\tthis._activeExecutions.get(cell.uri)?.cancel();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (obj.controller.interruptHandler) {\n\t\t\t// If we're interrupting all cells, we also need to cancel the notebook level execution.\n\t\t\tconst items = this._activeNotebookExecutions.get(document.uri);\n\t\t\tthis._activeNotebookExecutions.delete(document.uri);\n\t\t\tif (handles.length && Array.isArray(items) && items.length) {\n\t\t\t\titems.forEach(d => d.dispose());\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate id = 0;\n\tprivate variableStore: Record<string, vscode.Variable> = {};\n\n\tasync $provideVariables(handle: number, requestId: string, notebookUri: UriComponents, parentId: number | undefined, kind: 'named' | 'indexed', start: number, token: CancellationToken): Promise<void> {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (!obj) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst document = this._extHostNotebook.getNotebookDocument(URI.revive(notebookUri));\n\t\tconst variableProvider = obj.controller.variableProvider;\n\t\tif (!variableProvider) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet parent: vscode.Variable | undefined = undefined;\n\t\tif (parentId !== undefined) {\n\t\t\tparent = this.variableStore[parentId];\n\t\t\tif (!parent) {\n\t\t\t\t// request for unknown parent\n\t\t\t\treturn;\n\t\t\t}\n\t\t} else {\n\t\t\t// root request, clear store\n\t\t\tthis.variableStore = {};\n\t\t}\n\n\n\t\tconst requestKind = kind === 'named' ? NotebookVariablesRequestKind.Named : NotebookVariablesRequestKind.Indexed;\n\t\tconst variableResults = variableProvider.provideVariables(document.apiNotebook, parent, requestKind, start, token);\n\n\t\tlet resultCount = 0;\n\t\tfor await (const result of variableResults) {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst variable = {\n\t\t\t\tid: this.id++,\n\t\t\t\tname: result.variable.name,\n\t\t\t\tvalue: result.variable.value,\n\t\t\t\ttype: result.variable.type,\n\t\t\t\tinterfaces: result.variable.interfaces,\n\t\t\t\tlanguage: result.variable.language,\n\t\t\t\texpression: result.variable.expression,\n\t\t\t\thasNamedChildren: result.hasNamedChildren,\n\t\t\t\tindexedChildrenCount: result.indexedChildrenCount,\n\t\t\t\textensionId: obj.extensionId.value,\n\t\t\t};\n\t\t\tthis.variableStore[variable.id] = result.variable;\n\t\t\tthis._proxy.$receiveVariable(requestId, variable);\n\n\t\t\tif (resultCount++ >= variablePageSize) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\t$acceptKernelMessageFromRenderer(handle: number, editorId: string, message: unknown): void {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (!obj) {\n\t\t\t// extension can dispose kernels in the meantime\n\t\t\treturn;\n\t\t}\n\n\t\tconst editor = this._extHostNotebook.getEditorById(editorId);\n\t\tobj.onDidReceiveMessage.fire(Object.freeze({ editor: editor.apiEditor, message }));\n\t}\n\n\n\t// ---\n\n\t_createNotebookCellExecution(cell: vscode.NotebookCell, controllerId: string): vscode.NotebookCellExecution {\n\t\tif (cell.index < 0) {\n\t\t\tthrow new Error('CANNOT execute cell that has been REMOVED from notebook');\n\t\t}\n\t\tconst notebook = this._extHostNotebook.getNotebookDocument(cell.notebook.uri);\n\t\tconst cellObj = notebook.getCellFromApiCell(cell);\n\t\tif (!cellObj) {\n\t\t\tthrow new Error('invalid cell');\n\t\t}\n\t\tif (this._activeExecutions.has(cellObj.uri)) {\n\t\t\tthrow new Error(`duplicate execution for ${cellObj.uri}`);\n\t\t}\n\t\tconst execution = new NotebookCellExecutionTask(controllerId, cellObj, this._proxy);\n\t\tthis._activeExecutions.set(cellObj.uri, execution);\n\t\tconst listener = execution.onDidChangeState(() => {\n\t\t\tif (execution.state === NotebookCellExecutionTaskState.Resolved) {\n\t\t\t\texecution.dispose();\n\t\t\t\tlistener.dispose();\n\t\t\t\tthis._activeExecutions.delete(cellObj.uri);\n\t\t\t}\n\t\t});\n\t\treturn execution.asApiObject();\n\t}\n\n\t// ---\n\n\t_createNotebookExecution(nb: vscode.NotebookDocument, controllerId: string): vscode.NotebookExecution {\n\t\tconst notebook = this._extHostNotebook.getNotebookDocument(nb.uri);\n\t\tconst runningCell = nb.getCells().find(cell => {\n\t\t\tconst apiCell = notebook.getCellFromApiCell(cell);\n\t\t\treturn apiCell && this._activeExecutions.has(apiCell.uri);\n\t\t});\n\t\tif (runningCell) {\n\t\t\tthrow new Error(`duplicate cell execution for ${runningCell.document.uri}`);\n\t\t}\n\t\tif (this._activeNotebookExecutions.has(notebook.uri)) {\n\t\t\tthrow new Error(`duplicate notebook execution for ${notebook.uri}`);\n\t\t}\n\t\tconst execution = new NotebookExecutionTask(controllerId, notebook, this._proxy);\n\t\tconst listener = execution.onDidChangeState(() => {\n\t\t\tif (execution.state === NotebookExecutionTaskState.Resolved) {\n\t\t\t\texecution.dispose();\n\t\t\t\tlistener.dispose();\n\t\t\t\tthis._activeNotebookExecutions.delete(notebook.uri);\n\t\t\t}\n\t\t});\n\t\tthis._activeNotebookExecutions.set(notebook.uri, [execution, listener]);\n\t\treturn execution.asApiObject();\n\t}\n}\n\n\nenum NotebookCellExecutionTaskState {\n\tInit,\n\tStarted,\n\tResolved\n}\n\nclass NotebookCellExecutionTask extends Disposable {\n\tprivate static HANDLE = 0;\n\tprivate _handle = NotebookCellExecutionTask.HANDLE++;\n\n\tprivate _onDidChangeState = new Emitter<void>();\n\treadonly onDidChangeState = this._onDidChangeState.event;\n\n\tprivate _state = NotebookCellExecutionTaskState.Init;\n\tget state(): NotebookCellExecutionTaskState { return this._state; }\n\n\tprivate readonly _tokenSource = this._register(new CancellationTokenSource());\n\n\tprivate readonly _collector: TimeoutBasedCollector<ICellExecuteUpdateDto>;\n\n\tprivate _executionOrder: number | undefined;\n\n\tconstructor(\n\t\tcontrollerId: string,\n\t\tprivate readonly _cell: ExtHostCell,\n\t\tprivate readonly _proxy: MainThreadNotebookKernelsShape\n\t) {\n\t\tsuper();\n\n\t\tthis._collector = new TimeoutBasedCollector(10, updates => this.update(updates));\n\n\t\tthis._executionOrder = _cell.internalMetadata.executionOrder;\n\t\tthis._proxy.$createExecution(this._handle, controllerId, this._cell.notebook.uri, this._cell.handle);\n\t}\n\n\tcancel(): void {\n\t\tthis._tokenSource.cancel();\n\t}\n\n\tprivate async updateSoon(update: ICellExecuteUpdateDto): Promise<void> {\n\t\tawait this._collector.addItem(update);\n\t}\n\n\tprivate async update(update: ICellExecuteUpdateDto | ICellExecuteUpdateDto[]): Promise<void> {\n\t\tconst updates = Array.isArray(update) ? update : [update];\n\t\treturn this._proxy.$updateExecution(this._handle, new SerializableObjectWithBuffers(updates));\n\t}\n\n\tprivate verifyStateForOutput() {\n\t\tif (this._state === NotebookCellExecutionTaskState.Init) {\n\t\t\tthrow new Error('Must call start before modifying cell output');\n\t\t}\n\n\t\tif (this._state === NotebookCellExecutionTaskState.Resolved) {\n\t\t\tthrow new Error('Cannot modify cell output after calling resolve');\n\t\t}\n\t}\n\n\tprivate cellIndexToHandle(cellOrCellIndex: vscode.NotebookCell | undefined): number {\n\t\tlet cell: ExtHostCell | undefined = this._cell;\n\t\tif (cellOrCellIndex) {\n\t\t\tcell = this._cell.notebook.getCellFromApiCell(cellOrCellIndex);\n\t\t}\n\t\tif (!cell) {\n\t\t\tthrow new Error('INVALID cell');\n\t\t}\n\t\treturn cell.handle;\n\t}\n\n\tprivate validateAndConvertOutputs(items: vscode.NotebookCellOutput[]): NotebookOutputDto[] {\n\t\treturn items.map(output => {\n\t\t\tconst newOutput = NotebookCellOutput.ensureUniqueMimeTypes(output.items, true);\n\t\t\tif (newOutput === output.items) {\n\t\t\t\treturn extHostTypeConverters.NotebookCellOutput.from(output);\n\t\t\t}\n\t\t\treturn extHostTypeConverters.NotebookCellOutput.from({\n\t\t\t\titems: newOutput,\n\t\t\t\tid: output.id,\n\t\t\t\tmetadata: output.metadata\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate async updateOutputs(outputs: vscode.NotebookCellOutput | vscode.NotebookCellOutput[], cell: vscode.NotebookCell | undefined, append: boolean): Promise<void> {\n\t\tconst handle = this.cellIndexToHandle(cell);\n\t\tconst outputDtos = this.validateAndConvertOutputs(asArray(outputs));\n\t\treturn this.updateSoon(\n\t\t\t{\n\t\t\t\teditType: CellExecutionUpdateType.Output,\n\t\t\t\tcellHandle: handle,\n\t\t\t\tappend,\n\t\t\t\toutputs: outputDtos\n\t\t\t});\n\t}\n\n\tprivate async updateOutputItems(items: vscode.NotebookCellOutputItem | vscode.NotebookCellOutputItem[], output: vscode.NotebookCellOutput, append: boolean): Promise<void> {\n\t\titems = NotebookCellOutput.ensureUniqueMimeTypes(asArray(items), true);\n\t\treturn this.updateSoon({\n\t\t\teditType: CellExecutionUpdateType.OutputItems,\n\t\t\titems: items.map(extHostTypeConverters.NotebookCellOutputItem.from),\n\t\t\toutputId: output.id,\n\t\t\tappend\n\t\t});\n\t}\n\n\tasApiObject(): vscode.NotebookCellExecution {\n\t\tconst that = this;\n\t\tconst result: vscode.NotebookCellExecution = {\n\t\t\tget token() { return that._tokenSource.token; },\n\t\t\tget cell() { return that._cell.apiCell; },\n\t\t\tget executionOrder() { return that._executionOrder; },\n\t\t\tset executionOrder(v: number | undefined) {\n\t\t\t\tthat._executionOrder = v;\n\t\t\t\tthat.update([{\n\t\t\t\t\teditType: CellExecutionUpdateType.ExecutionState,\n\t\t\t\t\texecutionOrder: that._executionOrder\n\t\t\t\t}]);\n\t\t\t},\n\n\t\t\tstart(startTime?: number): void {\n\t\t\t\tif (that._state === NotebookCellExecutionTaskState.Resolved || that._state === NotebookCellExecutionTaskState.Started) {\n\t\t\t\t\tthrow new Error('Cannot call start again');\n\t\t\t\t}\n\n\t\t\t\tthat._state = NotebookCellExecutionTaskState.Started;\n\t\t\t\tthat._onDidChangeState.fire();\n\n\t\t\t\tthat.update({\n\t\t\t\t\teditType: CellExecutionUpdateType.ExecutionState,\n\t\t\t\t\trunStartTime: startTime\n\t\t\t\t});\n\t\t\t},\n\n\t\t\tend(success: boolean | undefined, endTime?: number, executionError?: vscode.CellExecutionError): void {\n\t\t\t\tif (that._state === NotebookCellExecutionTaskState.Resolved) {\n\t\t\t\t\tthrow new Error('Cannot call resolve twice');\n\t\t\t\t}\n\n\t\t\t\tthat._state = NotebookCellExecutionTaskState.Resolved;\n\t\t\t\tthat._onDidChangeState.fire();\n\n\t\t\t\t// The last update needs to be ordered correctly and applied immediately,\n\t\t\t\t// so we use updateSoon and immediately flush.\n\t\t\t\tthat._collector.flush();\n\n\t\t\t\tconst error = createSerializeableError(executionError);\n\n\t\t\t\tthat._proxy.$completeExecution(that._handle, new SerializableObjectWithBuffers({\n\t\t\t\t\trunEndTime: endTime,\n\t\t\t\t\tlastRunSuccess: success,\n\t\t\t\t\terror\n\t\t\t\t}));\n\t\t\t},\n\n\t\t\tclearOutput(cell?: vscode.NotebookCell): Thenable<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputs([], cell, false);\n\t\t\t},\n\n\t\t\tappendOutput(outputs: vscode.NotebookCellOutput | vscode.NotebookCellOutput[], cell?: vscode.NotebookCell): Promise<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputs(outputs, cell, true);\n\t\t\t},\n\n\t\t\treplaceOutput(outputs: vscode.NotebookCellOutput | vscode.NotebookCellOutput[], cell?: vscode.NotebookCell): Promise<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputs(outputs, cell, false);\n\t\t\t},\n\n\t\t\tappendOutputItems(items: vscode.NotebookCellOutputItem | vscode.NotebookCellOutputItem[], output: vscode.NotebookCellOutput): Promise<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputItems(items, output, true);\n\t\t\t},\n\n\t\t\treplaceOutputItems(items: vscode.NotebookCellOutputItem | vscode.NotebookCellOutputItem[], output: vscode.NotebookCellOutput): Promise<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputItems(items, output, false);\n\t\t\t}\n\t\t};\n\t\treturn Object.freeze(result);\n\t}\n}\n\nfunction createSerializeableError(executionError: vscode.CellExecutionError | undefined) {\n\tconst convertRange = (range: vscode.Range | undefined) => (range ? {\n\t\tstartLineNumber: range.start.line,\n\t\tstartColumn: range.start.character,\n\t\tendLineNumber: range.end.line,\n\t\tendColumn: range.end.character\n\t} : undefined);\n\n\tconst convertStackFrame = (frame: vscode.CellErrorStackFrame) => ({\n\t\turi: frame.uri,\n\t\tposition: frame.position,\n\t\tlabel: frame.label\n\t});\n\n\tconst error = executionError ? {\n\t\tname: executionError.name,\n\t\tmessage: executionError.message,\n\t\tstack: executionError.stack instanceof Array\n\t\t\t? executionError.stack.map(frame => convertStackFrame(frame))\n\t\t\t: executionError.stack,\n\t\tlocation: convertRange(executionError.location),\n\t\turi: executionError.uri\n\t} : undefined;\n\treturn error;\n}\n\nenum NotebookExecutionTaskState {\n\tInit,\n\tStarted,\n\tResolved\n}\n\n\nclass NotebookExecutionTask extends Disposable {\n\tprivate static HANDLE = 0;\n\tprivate _handle = NotebookExecutionTask.HANDLE++;\n\n\tprivate _onDidChangeState = new Emitter<void>();\n\treadonly onDidChangeState = this._onDidChangeState.event;\n\n\tprivate _state = NotebookExecutionTaskState.Init;\n\tget state(): NotebookExecutionTaskState { return this._state; }\n\n\tprivate readonly _tokenSource = this._register(new CancellationTokenSource());\n\n\tconstructor(\n\t\tcontrollerId: string,\n\t\tprivate readonly _notebook: ExtHostNotebookDocument,\n\t\tprivate readonly _proxy: MainThreadNotebookKernelsShape\n\t) {\n\t\tsuper();\n\n\t\tthis._proxy.$createNotebookExecution(this._handle, controllerId, this._notebook.uri);\n\t}\n\n\tcancel(): void {\n\t\tthis._tokenSource.cancel();\n\t}\n\tasApiObject(): vscode.NotebookExecution {\n\t\tconst result: vscode.NotebookExecution = {\n\t\t\tstart: () => {\n\t\t\t\tif (this._state === NotebookExecutionTaskState.Resolved || this._state === NotebookExecutionTaskState.Started) {\n\t\t\t\t\tthrow new Error('Cannot call start again');\n\t\t\t\t}\n\n\t\t\t\tthis._state = NotebookExecutionTaskState.Started;\n\t\t\t\tthis._onDidChangeState.fire();\n\n\t\t\t\tthis._proxy.$beginNotebookExecution(this._handle);\n\t\t\t},\n\n\t\t\tend: () => {\n\t\t\t\tif (this._state === NotebookExecutionTaskState.Resolved) {\n\t\t\t\t\tthrow new Error('Cannot call resolve twice');\n\t\t\t\t}\n\n\t\t\t\tthis._state = NotebookExecutionTaskState.Resolved;\n\t\t\t\tthis._onDidChangeState.fire();\n\n\t\t\t\tthis._proxy.$completeNotebookExecution(this._handle);\n\t\t\t},\n\n\t\t};\n\t\treturn Object.freeze(result);\n\t}\n}\n\nclass TimeoutBasedCollector<T> {\n\tprivate batch: T[] = [];\n\tprivate startedTimer = Date.now();\n\tprivate currentDeferred: DeferredPromise<void> | undefined;\n\n\tconstructor(\n\t\tprivate readonly delay: number,\n\t\tprivate readonly callback: (items: T[]) => Promise<void>) { }\n\n\taddItem(item: T): Promise<void> {\n\t\tthis.batch.push(item);\n\t\tif (!this.currentDeferred) {\n\t\t\tthis.currentDeferred = new DeferredPromise<void>();\n\t\t\tthis.startedTimer = Date.now();\n\t\t\ttimeout(this.delay).then(() => {\n\t\t\t\treturn this.flush();\n\t\t\t});\n\t\t}\n\n\t\t// This can be called by the extension repeatedly for a long time before the timeout is able to run.\n\t\t// Force a flush after the delay.\n\t\tif (Date.now() - this.startedTimer > this.delay) {\n\t\t\treturn this.flush();\n\t\t}\n\n\t\treturn this.currentDeferred.p;\n\t}\n\n\tflush(): Promise<void> {\n\t\tif (this.batch.length === 0 || !this.currentDeferred) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tconst deferred = this.currentDeferred;\n\t\tthis.currentDeferred = undefined;\n\t\tconst batch = this.batch;\n\t\tthis.batch = [];\n\t\treturn this.callback(batch)\n\t\t\t.finally(() => deferred.complete());\n\t}\n}\n\nexport function createKernelId(extensionIdentifier: ExtensionIdentifier, id: string): string {\n\treturn `${extensionIdentifier.value}/${id}`;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { asArray } from '../../../base/common/arrays.js';\nimport { DeferredPromise, timeout } from '../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../base/common/map.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { ExtensionIdentifier, IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { ExtHostNotebookKernelsShape, ICellExecuteUpdateDto, IMainContext, INotebookKernelDto2, MainContext, MainThreadNotebookKernelsShape, NotebookOutputDto, VariablesResult } from './extHost.protocol.js';\nimport { ApiCommand, ApiCommandArgument, ApiCommandResult, ExtHostCommands } from './extHostCommands.js';\nimport { IExtHostInitDataService } from './extHostInitDataService.js';\nimport { ExtHostNotebookController } from './extHostNotebook.js';\nimport { ExtHostCell, ExtHostNotebookDocument } from './extHostNotebookDocument.js';\nimport * as extHostTypeConverters from './extHostTypeConverters.js';\nimport { NotebookCellOutput, NotebookControllerAffinity2, NotebookVariablesRequestKind } from './extHostTypes.js';\nimport { asWebviewUri } from '../../contrib/webview/common/webview.js';\nimport { INotebookKernelSourceAction } from '../../contrib/notebook/common/notebookCommon.js';\nimport { CellExecutionUpdateType } from '../../contrib/notebook/common/notebookExecutionService.js';\nimport { checkProposedApiEnabled } from '../../services/extensions/common/extensions.js';\nimport { SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\nimport * as vscode from 'vscode';\nimport { variablePageSize } from '../../contrib/notebook/common/notebookKernelService.js';\n\ninterface IKernelData {\n\textensionId: ExtensionIdentifier;\n\tcontroller: vscode.NotebookController;\n\tonDidChangeSelection: Emitter<{ selected: boolean; notebook: vscode.NotebookDocument }>;\n\tonDidReceiveMessage: Emitter<{ editor: vscode.NotebookEditor; message: unknown }>;\n\tassociatedNotebooks: ResourceMap<boolean>;\n}\n\ntype ExtHostSelectKernelArgs = ControllerInfo | { notebookEditor: vscode.NotebookEditor } | ControllerInfo & { notebookEditor: vscode.NotebookEditor } | undefined;\ntype SelectKernelReturnArgs = ControllerInfo | { notebookEditorId: string } | ControllerInfo & { notebookEditorId: string } | undefined;\ntype ControllerInfo = { id: string; extension: string };\n\n\nexport class ExtHostNotebookKernels implements ExtHostNotebookKernelsShape {\n\n\tprivate readonly _proxy: MainThreadNotebookKernelsShape;\n\tprivate readonly _activeExecutions = new ResourceMap<NotebookCellExecutionTask>();\n\tprivate readonly _activeNotebookExecutions = new ResourceMap<[NotebookExecutionTask, IDisposable]>();\n\n\tprivate _kernelDetectionTask = new Map<number, vscode.NotebookControllerDetectionTask>();\n\tprivate _kernelDetectionTaskHandlePool: number = 0;\n\n\tprivate _kernelSourceActionProviders = new Map<number, vscode.NotebookKernelSourceActionProvider>();\n\tprivate _kernelSourceActionProviderHandlePool: number = 0;\n\n\tprivate readonly _kernelData = new Map<number, IKernelData>();\n\tprivate _handlePool: number = 0;\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tprivate readonly _initData: IExtHostInitDataService,\n\t\tprivate readonly _extHostNotebook: ExtHostNotebookController,\n\t\tprivate _commands: ExtHostCommands,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadNotebookKernels);\n\n\t\t// todo@rebornix @joyceerhl: move to APICommands once stabilized.\n\t\tconst selectKernelApiCommand = new ApiCommand(\n\t\t\t'notebook.selectKernel',\n\t\t\t'_notebook.selectKernel',\n\t\t\t'Trigger kernel picker for specified notebook editor widget',\n\t\t\t[\n\t\t\t\tnew ApiCommandArgument<ExtHostSelectKernelArgs, SelectKernelReturnArgs>('options', 'Select kernel options', v => true, (v: ExtHostSelectKernelArgs) => {\n\t\t\t\t\tif (v && 'notebookEditor' in v && 'id' in v) {\n\t\t\t\t\t\tconst notebookEditorId = this._extHostNotebook.getIdByEditor(v.notebookEditor);\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tid: v.id, extension: v.extension, notebookEditorId\n\t\t\t\t\t\t};\n\t\t\t\t\t} else if (v && 'notebookEditor' in v) {\n\t\t\t\t\t\tconst notebookEditorId = this._extHostNotebook.getIdByEditor(v.notebookEditor);\n\t\t\t\t\t\tif (notebookEditorId === undefined) {\n\t\t\t\t\t\t\tthrow new Error(`Cannot invoke 'notebook.selectKernel' for unrecognized notebook editor ${v.notebookEditor.notebook.uri.toString()}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ('skipIfAlreadySelected' in v) {\n\t\t\t\t\t\t\treturn { notebookEditorId, skipIfAlreadySelected: v.skipIfAlreadySelected };\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn { notebookEditorId };\n\t\t\t\t\t}\n\t\t\t\t\treturn v;\n\t\t\t\t})\n\t\t\t],\n\t\t\tApiCommandResult.Void);\n\n\t\tconst requestKernelVariablesApiCommand = new ApiCommand(\n\t\t\t'vscode.executeNotebookVariableProvider',\n\t\t\t'_executeNotebookVariableProvider',\n\t\t\t'Execute notebook variable provider',\n\t\t\t[ApiCommandArgument.Uri],\n\t\t\tnew ApiCommandResult<VariablesResult[], vscode.VariablesResult[]>('A promise that resolves to an array of variables', (value, apiArgs) => {\n\t\t\t\treturn value.map(variable => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tvariable: {\n\t\t\t\t\t\t\tname: variable.name,\n\t\t\t\t\t\t\tvalue: variable.value,\n\t\t\t\t\t\t\texpression: variable.expression,\n\t\t\t\t\t\t\ttype: variable.type,\n\t\t\t\t\t\t\tlanguage: variable.language\n\t\t\t\t\t\t},\n\t\t\t\t\t\thasNamedChildren: variable.hasNamedChildren,\n\t\t\t\t\t\tindexedChildrenCount: variable.indexedChildrenCount\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t})\n\t\t);\n\t\tthis._commands.registerApiCommand(selectKernelApiCommand);\n\t\tthis._commands.registerApiCommand(requestKernelVariablesApiCommand);\n\t}\n\n\tcreateNotebookController(extension: IExtensionDescription, id: string, viewType: string, label: string, handler?: (cells: vscode.NotebookCell[], notebook: vscode.NotebookDocument, controller: vscode.NotebookController) => void | Thenable<void>, preloads?: vscode.NotebookRendererScript[]): vscode.NotebookController {\n\n\t\tfor (const data of this._kernelData.values()) {\n\t\t\tif (data.controller.id === id && ExtensionIdentifier.equals(extension.identifier, data.extensionId)) {\n\t\t\t\tthrow new Error(`notebook controller with id '${id}' ALREADY exist`);\n\t\t\t}\n\t\t}\n\n\n\t\tconst handle = this._handlePool++;\n\t\tconst that = this;\n\n\t\tthis._logService.trace(`NotebookController[${handle}], CREATED by ${extension.identifier.value}, ${id}`);\n\n\t\tconst _defaultExecutHandler = () => console.warn(`NO execute handler from notebook controller '${data.id}' of extension: '${extension.identifier}'`);\n\n\t\tlet isDisposed = false;\n\n\t\tconst onDidChangeSelection = new Emitter<{ selected: boolean; notebook: vscode.NotebookDocument }>();\n\t\tconst onDidReceiveMessage = new Emitter<{ editor: vscode.NotebookEditor; message: unknown }>();\n\n\t\tconst data: INotebookKernelDto2 = {\n\t\t\tid: createKernelId(extension.identifier, id),\n\t\t\tnotebookType: viewType,\n\t\t\textensionId: extension.identifier,\n\t\t\textensionLocation: extension.extensionLocation,\n\t\t\tlabel: label || extension.identifier.value,\n\t\t\tpreloads: preloads ? preloads.map(extHostTypeConverters.NotebookRendererScript.from) : []\n\t\t};\n\n\t\t//\n\t\tlet _executeHandler = handler ?? _defaultExecutHandler;\n\t\tlet _interruptHandler: ((this: vscode.NotebookController, notebook: vscode.NotebookDocument) => void | Thenable<void>) | undefined;\n\t\tlet _variableProvider: vscode.NotebookVariableProvider | undefined;\n\n\t\tthis._proxy.$addKernel(handle, data).catch(err => {\n\t\t\t// this can happen when a kernel with that ID is already registered\n\t\t\tconsole.log(err);\n\t\t\tisDisposed = true;\n\t\t});\n\n\t\t// update: all setters write directly into the dto object\n\t\t// and trigger an update. the actual update will only happen\n\t\t// once per event loop execution\n\t\tlet tokenPool = 0;\n\t\tconst _update = () => {\n\t\t\tif (isDisposed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst myToken = ++tokenPool;\n\t\t\tPromise.resolve().then(() => {\n\t\t\t\tif (myToken === tokenPool) {\n\t\t\t\t\tthis._proxy.$updateKernel(handle, data);\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\n\t\t// notebook documents that are associated to this controller\n\t\tconst associatedNotebooks = new ResourceMap<boolean>();\n\n\t\tconst controller: vscode.NotebookController = {\n\t\t\tget id() { return id; },\n\t\t\tget notebookType() { return data.notebookType; },\n\t\t\tonDidChangeSelectedNotebooks: onDidChangeSelection.event,\n\t\t\tget label() {\n\t\t\t\treturn data.label;\n\t\t\t},\n\t\t\tset label(value) {\n\t\t\t\tdata.label = value ?? extension.displayName ?? extension.name;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget detail() {\n\t\t\t\treturn data.detail ?? '';\n\t\t\t},\n\t\t\tset detail(value) {\n\t\t\t\tdata.detail = value;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget description() {\n\t\t\t\treturn data.description ?? '';\n\t\t\t},\n\t\t\tset description(value) {\n\t\t\t\tdata.description = value;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget supportedLanguages() {\n\t\t\t\treturn data.supportedLanguages;\n\t\t\t},\n\t\t\tset supportedLanguages(value) {\n\t\t\t\tdata.supportedLanguages = value;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget supportsExecutionOrder() {\n\t\t\t\treturn data.supportsExecutionOrder ?? false;\n\t\t\t},\n\t\t\tset supportsExecutionOrder(value) {\n\t\t\t\tdata.supportsExecutionOrder = value;\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget rendererScripts() {\n\t\t\t\treturn data.preloads ? data.preloads.map(extHostTypeConverters.NotebookRendererScript.to) : [];\n\t\t\t},\n\t\t\tget executeHandler() {\n\t\t\t\treturn _executeHandler;\n\t\t\t},\n\t\t\tset executeHandler(value) {\n\t\t\t\t_executeHandler = value ?? _defaultExecutHandler;\n\t\t\t},\n\t\t\tget interruptHandler() {\n\t\t\t\treturn _interruptHandler;\n\t\t\t},\n\t\t\tset interruptHandler(value) {\n\t\t\t\t_interruptHandler = value;\n\t\t\t\tdata.supportsInterrupt = Boolean(value);\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tset variableProvider(value) {\n\t\t\t\tcheckProposedApiEnabled(extension, 'notebookVariableProvider');\n\t\t\t\t_variableProvider = value;\n\t\t\t\tdata.hasVariableProvider = !!value;\n\t\t\t\tvalue?.onDidChangeVariables(e => that._proxy.$variablesUpdated(e.uri));\n\t\t\t\t_update();\n\t\t\t},\n\t\t\tget variableProvider() {\n\t\t\t\treturn _variableProvider;\n\t\t\t},\n\t\t\tcreateNotebookCellExecution(cell) {\n\t\t\t\tif (isDisposed) {\n\t\t\t\t\tthrow new Error('notebook controller is DISPOSED');\n\t\t\t\t}\n\t\t\t\tif (!associatedNotebooks.has(cell.notebook.uri)) {\n\t\t\t\t\tthat._logService.trace(`NotebookController[${handle}] NOT associated to notebook, associated to THESE notebooks:`, Array.from(associatedNotebooks.keys()).map(u => u.toString()));\n\t\t\t\t\tthrow new Error(`notebook controller is NOT associated to notebook: ${cell.notebook.uri.toString()}`);\n\t\t\t\t}\n\t\t\t\treturn that._createNotebookCellExecution(cell, createKernelId(extension.identifier, this.id));\n\t\t\t},\n\t\t\tcreateNotebookExecution(notebook) {\n\t\t\t\tcheckProposedApiEnabled(extension, 'notebookExecution');\n\t\t\t\tif (isDisposed) {\n\t\t\t\t\tthrow new Error('notebook controller is DISPOSED');\n\t\t\t\t}\n\t\t\t\tif (!associatedNotebooks.has(notebook.uri)) {\n\t\t\t\t\tthat._logService.trace(`NotebookController[${handle}] NOT associated to notebook, associated to THESE notebooks:`, Array.from(associatedNotebooks.keys()).map(u => u.toString()));\n\t\t\t\t\tthrow new Error(`notebook controller is NOT associated to notebook: ${notebook.uri.toString()}`);\n\t\t\t\t}\n\t\t\t\treturn that._createNotebookExecution(notebook, createKernelId(extension.identifier, this.id));\n\t\t\t},\n\t\t\tdispose: () => {\n\t\t\t\tif (!isDisposed) {\n\t\t\t\t\tthis._logService.trace(`NotebookController[${handle}], DISPOSED`);\n\t\t\t\t\tisDisposed = true;\n\t\t\t\t\tthis._kernelData.delete(handle);\n\t\t\t\t\tonDidChangeSelection.dispose();\n\t\t\t\t\tonDidReceiveMessage.dispose();\n\t\t\t\t\tthis._proxy.$removeKernel(handle);\n\t\t\t\t}\n\t\t\t},\n\t\t\t// --- priority\n\t\t\tupdateNotebookAffinity(notebook, priority) {\n\t\t\t\tif (priority === NotebookControllerAffinity2.Hidden) {\n\t\t\t\t\t// This api only adds an extra enum value, the function is the same, so just gate on the new value being passed\n\t\t\t\t\t// for proposedAPI check.\n\t\t\t\t\tcheckProposedApiEnabled(extension, 'notebookControllerAffinityHidden');\n\t\t\t\t}\n\t\t\t\tthat._proxy.$updateNotebookPriority(handle, notebook.uri, priority);\n\t\t\t},\n\t\t\t// --- ipc\n\t\t\tonDidReceiveMessage: onDidReceiveMessage.event,\n\t\t\tpostMessage(message, editor) {\n\t\t\t\tcheckProposedApiEnabled(extension, 'notebookMessaging');\n\t\t\t\treturn that._proxy.$postMessage(handle, editor && that._extHostNotebook.getIdByEditor(editor), message);\n\t\t\t},\n\t\t\tasWebviewUri(uri: URI) {\n\t\t\t\tcheckProposedApiEnabled(extension, 'notebookMessaging');\n\t\t\t\treturn asWebviewUri(uri, that._initData.remote);\n\t\t\t},\n\t\t};\n\n\t\tthis._kernelData.set(handle, {\n\t\t\textensionId: extension.identifier,\n\t\t\tcontroller,\n\t\t\tonDidReceiveMessage,\n\t\t\tonDidChangeSelection,\n\t\t\tassociatedNotebooks\n\t\t});\n\t\treturn controller;\n\t}\n\n\tgetIdByController(controller: vscode.NotebookController) {\n\t\tfor (const [_, candidate] of this._kernelData) {\n\t\t\tif (candidate.controller === controller) {\n\t\t\t\treturn createKernelId(candidate.extensionId, controller.id);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\tcreateNotebookControllerDetectionTask(extension: IExtensionDescription, viewType: string): vscode.NotebookControllerDetectionTask {\n\t\tconst handle = this._kernelDetectionTaskHandlePool++;\n\t\tconst that = this;\n\n\t\tthis._logService.trace(`NotebookControllerDetectionTask[${handle}], CREATED by ${extension.identifier.value}`);\n\t\tthis._proxy.$addKernelDetectionTask(handle, viewType);\n\n\t\tconst detectionTask: vscode.NotebookControllerDetectionTask = {\n\t\t\tdispose: () => {\n\t\t\t\tthis._kernelDetectionTask.delete(handle);\n\t\t\t\tthat._proxy.$removeKernelDetectionTask(handle);\n\t\t\t}\n\t\t};\n\n\t\tthis._kernelDetectionTask.set(handle, detectionTask);\n\t\treturn detectionTask;\n\t}\n\n\tregisterKernelSourceActionProvider(extension: IExtensionDescription, viewType: string, provider: vscode.NotebookKernelSourceActionProvider) {\n\t\tconst handle = this._kernelSourceActionProviderHandlePool++;\n\t\tconst eventHandle = typeof provider.onDidChangeNotebookKernelSourceActions === 'function' ? handle : undefined;\n\t\tconst that = this;\n\n\t\tthis._kernelSourceActionProviders.set(handle, provider);\n\t\tthis._logService.trace(`NotebookKernelSourceActionProvider[${handle}], CREATED by ${extension.identifier.value}`);\n\t\tthis._proxy.$addKernelSourceActionProvider(handle, handle, viewType);\n\n\t\tlet subscription: vscode.Disposable | undefined;\n\t\tif (eventHandle !== undefined) {\n\t\t\tsubscription = provider.onDidChangeNotebookKernelSourceActions!(_ => this._proxy.$emitNotebookKernelSourceActionsChangeEvent(eventHandle));\n\t\t}\n\n\t\treturn {\n\t\t\tdispose: () => {\n\t\t\t\tthis._kernelSourceActionProviders.delete(handle);\n\t\t\t\tthat._proxy.$removeKernelSourceActionProvider(handle, handle);\n\t\t\t\tsubscription?.dispose();\n\t\t\t}\n\t\t};\n\t}\n\n\tasync $provideKernelSourceActions(handle: number, token: CancellationToken): Promise<INotebookKernelSourceAction[]> {\n\t\tconst provider = this._kernelSourceActionProviders.get(handle);\n\t\tif (provider) {\n\t\t\tconst disposables = new DisposableStore();\n\t\t\tconst ret = await provider.provideNotebookKernelSourceActions(token);\n\t\t\treturn (ret ?? []).map(item => extHostTypeConverters.NotebookKernelSourceAction.from(item, this._commands.converter, disposables));\n\t\t}\n\t\treturn [];\n\t}\n\n\t$acceptNotebookAssociation(handle: number, uri: UriComponents, value: boolean): void {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (obj) {\n\t\t\t// update data structure\n\t\t\tconst notebook = this._extHostNotebook.getNotebookDocument(URI.revive(uri))!;\n\t\t\tif (value) {\n\t\t\t\tobj.associatedNotebooks.set(notebook.uri, true);\n\t\t\t} else {\n\t\t\t\tobj.associatedNotebooks.delete(notebook.uri);\n\t\t\t}\n\t\t\tthis._logService.trace(`NotebookController[${handle}] ASSOCIATE notebook`, notebook.uri.toString(), value);\n\t\t\t// send event\n\t\t\tobj.onDidChangeSelection.fire({\n\t\t\t\tselected: value,\n\t\t\t\tnotebook: notebook.apiNotebook\n\t\t\t});\n\t\t}\n\t}\n\n\tasync $executeCells(handle: number, uri: UriComponents, handles: number[]): Promise<void> {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (!obj) {\n\t\t\t// extension can dispose kernels in the meantime\n\t\t\treturn;\n\t\t}\n\t\tconst document = this._extHostNotebook.getNotebookDocument(URI.revive(uri));\n\t\tconst cells: vscode.NotebookCell[] = [];\n\t\tfor (const cellHandle of handles) {\n\t\t\tconst cell = document.getCell(cellHandle);\n\t\t\tif (cell) {\n\t\t\t\tcells.push(cell.apiCell);\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tthis._logService.trace(`NotebookController[${handle}] EXECUTE cells`, document.uri.toString(), cells.length);\n\t\t\tawait obj.controller.executeHandler.call(obj.controller, cells, document.apiNotebook, obj.controller);\n\t\t} catch (err) {\n\t\t\t//\n\t\t\tthis._logService.error(`NotebookController[${handle}] execute cells FAILED`, err);\n\t\t\tconsole.error(err);\n\t\t}\n\t}\n\n\tasync $cancelCells(handle: number, uri: UriComponents, handles: number[]): Promise<void> {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (!obj) {\n\t\t\t// extension can dispose kernels in the meantime\n\t\t\treturn;\n\t\t}\n\n\t\t// cancel or interrupt depends on the controller. When an interrupt handler is used we\n\t\t// don't trigger the cancelation token of executions.\n\t\tconst document = this._extHostNotebook.getNotebookDocument(URI.revive(uri));\n\t\tif (obj.controller.interruptHandler) {\n\t\t\tawait obj.controller.interruptHandler.call(obj.controller, document.apiNotebook);\n\n\t\t} else {\n\t\t\tfor (const cellHandle of handles) {\n\t\t\t\tconst cell = document.getCell(cellHandle);\n\t\t\t\tif (cell) {\n\t\t\t\t\tthis._activeExecutions.get(cell.uri)?.cancel();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (obj.controller.interruptHandler) {\n\t\t\t// If we're interrupting all cells, we also need to cancel the notebook level execution.\n\t\t\tconst items = this._activeNotebookExecutions.get(document.uri);\n\t\t\tthis._activeNotebookExecutions.delete(document.uri);\n\t\t\tif (handles.length && Array.isArray(items) && items.length) {\n\t\t\t\titems.forEach(d => d.dispose());\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate id = 0;\n\tprivate variableStore: Record<string, vscode.Variable> = {};\n\n\tasync $provideVariables(handle: number, requestId: string, notebookUri: UriComponents, parentId: number | undefined, kind: 'named' | 'indexed', start: number, token: CancellationToken): Promise<void> {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (!obj) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst document = this._extHostNotebook.getNotebookDocument(URI.revive(notebookUri));\n\t\tconst variableProvider = obj.controller.variableProvider;\n\t\tif (!variableProvider) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet parent: vscode.Variable | undefined = undefined;\n\t\tif (parentId !== undefined) {\n\t\t\tparent = this.variableStore[parentId];\n\t\t\tif (!parent) {\n\t\t\t\t// request for unknown parent\n\t\t\t\treturn;\n\t\t\t}\n\t\t} else {\n\t\t\t// root request, clear store\n\t\t\tthis.variableStore = {};\n\t\t}\n\n\n\t\tconst requestKind = kind === 'named' ? NotebookVariablesRequestKind.Named : NotebookVariablesRequestKind.Indexed;\n\t\tconst variableResults = variableProvider.provideVariables(document.apiNotebook, parent, requestKind, start, token);\n\n\t\tlet resultCount = 0;\n\t\tfor await (const result of variableResults) {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst variable = {\n\t\t\t\tid: this.id++,\n\t\t\t\tname: result.variable.name,\n\t\t\t\tvalue: result.variable.value,\n\t\t\t\ttype: result.variable.type,\n\t\t\t\tinterfaces: result.variable.interfaces,\n\t\t\t\tlanguage: result.variable.language,\n\t\t\t\texpression: result.variable.expression,\n\t\t\t\thasNamedChildren: result.hasNamedChildren,\n\t\t\t\tindexedChildrenCount: result.indexedChildrenCount,\n\t\t\t\textensionId: obj.extensionId.value,\n\t\t\t};\n\t\t\tthis.variableStore[variable.id] = result.variable;\n\t\t\tthis._proxy.$receiveVariable(requestId, variable);\n\n\t\t\tif (resultCount++ >= variablePageSize) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\t$acceptKernelMessageFromRenderer(handle: number, editorId: string, message: unknown): void {\n\t\tconst obj = this._kernelData.get(handle);\n\t\tif (!obj) {\n\t\t\t// extension can dispose kernels in the meantime\n\t\t\treturn;\n\t\t}\n\n\t\tconst editor = this._extHostNotebook.getEditorById(editorId);\n\t\tobj.onDidReceiveMessage.fire(Object.freeze({ editor: editor.apiEditor, message }));\n\t}\n\n\n\t// ---\n\n\t_createNotebookCellExecution(cell: vscode.NotebookCell, controllerId: string): vscode.NotebookCellExecution {\n\t\tif (cell.index < 0) {\n\t\t\tthrow new Error('CANNOT execute cell that has been REMOVED from notebook');\n\t\t}\n\t\tconst notebook = this._extHostNotebook.getNotebookDocument(cell.notebook.uri);\n\t\tconst cellObj = notebook.getCellFromApiCell(cell);\n\t\tif (!cellObj) {\n\t\t\tthrow new Error('invalid cell');\n\t\t}\n\t\tif (this._activeExecutions.has(cellObj.uri)) {\n\t\t\tthrow new Error(`duplicate execution for ${cellObj.uri}`);\n\t\t}\n\t\tconst execution = new NotebookCellExecutionTask(controllerId, cellObj, this._proxy);\n\t\tthis._activeExecutions.set(cellObj.uri, execution);\n\t\tconst listener = execution.onDidChangeState(() => {\n\t\t\tif (execution.state === NotebookCellExecutionTaskState.Resolved) {\n\t\t\t\texecution.dispose();\n\t\t\t\tlistener.dispose();\n\t\t\t\tthis._activeExecutions.delete(cellObj.uri);\n\t\t\t}\n\t\t});\n\t\treturn execution.asApiObject();\n\t}\n\n\t// ---\n\n\t_createNotebookExecution(nb: vscode.NotebookDocument, controllerId: string): vscode.NotebookExecution {\n\t\tconst notebook = this._extHostNotebook.getNotebookDocument(nb.uri);\n\t\tconst runningCell = nb.getCells().find(cell => {\n\t\t\tconst apiCell = notebook.getCellFromApiCell(cell);\n\t\t\treturn apiCell && this._activeExecutions.has(apiCell.uri);\n\t\t});\n\t\tif (runningCell) {\n\t\t\tthrow new Error(`duplicate cell execution for ${runningCell.document.uri}`);\n\t\t}\n\t\tif (this._activeNotebookExecutions.has(notebook.uri)) {\n\t\t\tthrow new Error(`duplicate notebook execution for ${notebook.uri}`);\n\t\t}\n\t\tconst execution = new NotebookExecutionTask(controllerId, notebook, this._proxy);\n\t\tconst listener = execution.onDidChangeState(() => {\n\t\t\tif (execution.state === NotebookExecutionTaskState.Resolved) {\n\t\t\t\texecution.dispose();\n\t\t\t\tlistener.dispose();\n\t\t\t\tthis._activeNotebookExecutions.delete(notebook.uri);\n\t\t\t}\n\t\t});\n\t\tthis._activeNotebookExecutions.set(notebook.uri, [execution, listener]);\n\t\treturn execution.asApiObject();\n\t}\n}\n\n\nenum NotebookCellExecutionTaskState {\n\tInit,\n\tStarted,\n\tResolved\n}\n\nclass NotebookCellExecutionTask extends Disposable {\n\tprivate static HANDLE = 0;\n\tprivate _handle = NotebookCellExecutionTask.HANDLE++;\n\n\tprivate _onDidChangeState = new Emitter<void>();\n\treadonly onDidChangeState = this._onDidChangeState.event;\n\n\tprivate _state = NotebookCellExecutionTaskState.Init;\n\tget state(): NotebookCellExecutionTaskState { return this._state; }\n\n\tprivate readonly _tokenSource = this._register(new CancellationTokenSource());\n\n\tprivate readonly _collector: TimeoutBasedCollector<ICellExecuteUpdateDto>;\n\n\tprivate _executionOrder: number | undefined;\n\n\tconstructor(\n\t\tcontrollerId: string,\n\t\tprivate readonly _cell: ExtHostCell,\n\t\tprivate readonly _proxy: MainThreadNotebookKernelsShape\n\t) {\n\t\tsuper();\n\n\t\tthis._collector = new TimeoutBasedCollector(10, updates => this.update(updates));\n\n\t\tthis._executionOrder = _cell.internalMetadata.executionOrder;\n\t\tthis._proxy.$createExecution(this._handle, controllerId, this._cell.notebook.uri, this._cell.handle);\n\t}\n\n\tcancel(): void {\n\t\tthis._tokenSource.cancel();\n\t}\n\n\tprivate async updateSoon(update: ICellExecuteUpdateDto): Promise<void> {\n\t\tawait this._collector.addItem(update);\n\t}\n\n\tprivate async update(update: ICellExecuteUpdateDto | ICellExecuteUpdateDto[]): Promise<void> {\n\t\tconst updates = Array.isArray(update) ? update : [update];\n\t\treturn this._proxy.$updateExecution(this._handle, new SerializableObjectWithBuffers(updates));\n\t}\n\n\tprivate verifyStateForOutput() {\n\t\tif (this._state === NotebookCellExecutionTaskState.Init) {\n\t\t\tthrow new Error('Must call start before modifying cell output');\n\t\t}\n\n\t\tif (this._state === NotebookCellExecutionTaskState.Resolved) {\n\t\t\tthrow new Error('Cannot modify cell output after calling resolve');\n\t\t}\n\t}\n\n\tprivate cellIndexToHandle(cellOrCellIndex: vscode.NotebookCell | undefined): number {\n\t\tlet cell: ExtHostCell | undefined = this._cell;\n\t\tif (cellOrCellIndex) {\n\t\t\tcell = this._cell.notebook.getCellFromApiCell(cellOrCellIndex);\n\t\t}\n\t\tif (!cell) {\n\t\t\tthrow new Error('INVALID cell');\n\t\t}\n\t\treturn cell.handle;\n\t}\n\n\tprivate validateAndConvertOutputs(items: vscode.NotebookCellOutput[]): NotebookOutputDto[] {\n\t\treturn items.map(output => {\n\t\t\tconst newOutput = NotebookCellOutput.ensureUniqueMimeTypes(output.items, true);\n\t\t\tif (newOutput === output.items) {\n\t\t\t\treturn extHostTypeConverters.NotebookCellOutput.from(output);\n\t\t\t}\n\t\t\treturn extHostTypeConverters.NotebookCellOutput.from({\n\t\t\t\titems: newOutput,\n\t\t\t\tid: output.id,\n\t\t\t\tmetadata: output.metadata\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate async updateOutputs(outputs: vscode.NotebookCellOutput | vscode.NotebookCellOutput[], cell: vscode.NotebookCell | undefined, append: boolean): Promise<void> {\n\t\tconst handle = this.cellIndexToHandle(cell);\n\t\tconst outputDtos = this.validateAndConvertOutputs(asArray(outputs));\n\t\treturn this.updateSoon(\n\t\t\t{\n\t\t\t\teditType: CellExecutionUpdateType.Output,\n\t\t\t\tcellHandle: handle,\n\t\t\t\tappend,\n\t\t\t\toutputs: outputDtos\n\t\t\t});\n\t}\n\n\tprivate async updateOutputItems(items: vscode.NotebookCellOutputItem | vscode.NotebookCellOutputItem[], output: vscode.NotebookCellOutput, append: boolean): Promise<void> {\n\t\titems = NotebookCellOutput.ensureUniqueMimeTypes(asArray(items), true);\n\t\treturn this.updateSoon({\n\t\t\teditType: CellExecutionUpdateType.OutputItems,\n\t\t\titems: items.map(extHostTypeConverters.NotebookCellOutputItem.from),\n\t\t\toutputId: output.id,\n\t\t\tappend\n\t\t});\n\t}\n\n\tasApiObject(): vscode.NotebookCellExecution {\n\t\tconst that = this;\n\t\tconst result: vscode.NotebookCellExecution = {\n\t\t\tget token() { return that._tokenSource.token; },\n\t\t\tget cell() { return that._cell.apiCell; },\n\t\t\tget executionOrder() { return that._executionOrder; },\n\t\t\tset executionOrder(v: number | undefined) {\n\t\t\t\tthat._executionOrder = v;\n\t\t\t\tthat.update([{\n\t\t\t\t\teditType: CellExecutionUpdateType.ExecutionState,\n\t\t\t\t\texecutionOrder: that._executionOrder\n\t\t\t\t}]);\n\t\t\t},\n\n\t\t\tstart(startTime?: number): void {\n\t\t\t\tif (that._state === NotebookCellExecutionTaskState.Resolved || that._state === NotebookCellExecutionTaskState.Started) {\n\t\t\t\t\tthrow new Error('Cannot call start again');\n\t\t\t\t}\n\n\t\t\t\tthat._state = NotebookCellExecutionTaskState.Started;\n\t\t\t\tthat._onDidChangeState.fire();\n\n\t\t\t\tthat.update({\n\t\t\t\t\teditType: CellExecutionUpdateType.ExecutionState,\n\t\t\t\t\trunStartTime: startTime\n\t\t\t\t});\n\t\t\t},\n\n\t\t\tend(success: boolean | undefined, endTime?: number, executionError?: vscode.CellExecutionError): void {\n\t\t\t\tif (that._state === NotebookCellExecutionTaskState.Resolved) {\n\t\t\t\t\tthrow new Error('Cannot call resolve twice');\n\t\t\t\t}\n\n\t\t\t\tthat._state = NotebookCellExecutionTaskState.Resolved;\n\t\t\t\tthat._onDidChangeState.fire();\n\n\t\t\t\t// The last update needs to be ordered correctly and applied immediately,\n\t\t\t\t// so we use updateSoon and immediately flush.\n\t\t\t\tthat._collector.flush();\n\n\t\t\t\tconst error = createSerializeableError(executionError);\n\n\t\t\t\tthat._proxy.$completeExecution(that._handle, new SerializableObjectWithBuffers({\n\t\t\t\t\trunEndTime: endTime,\n\t\t\t\t\tlastRunSuccess: success,\n\t\t\t\t\terror\n\t\t\t\t}));\n\t\t\t},\n\n\t\t\tclearOutput(cell?: vscode.NotebookCell): Thenable<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputs([], cell, false);\n\t\t\t},\n\n\t\t\tappendOutput(outputs: vscode.NotebookCellOutput | vscode.NotebookCellOutput[], cell?: vscode.NotebookCell): Promise<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputs(outputs, cell, true);\n\t\t\t},\n\n\t\t\treplaceOutput(outputs: vscode.NotebookCellOutput | vscode.NotebookCellOutput[], cell?: vscode.NotebookCell): Promise<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputs(outputs, cell, false);\n\t\t\t},\n\n\t\t\tappendOutputItems(items: vscode.NotebookCellOutputItem | vscode.NotebookCellOutputItem[], output: vscode.NotebookCellOutput): Promise<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputItems(items, output, true);\n\t\t\t},\n\n\t\t\treplaceOutputItems(items: vscode.NotebookCellOutputItem | vscode.NotebookCellOutputItem[], output: vscode.NotebookCellOutput): Promise<void> {\n\t\t\t\tthat.verifyStateForOutput();\n\t\t\t\treturn that.updateOutputItems(items, output, false);\n\t\t\t}\n\t\t};\n\t\treturn Object.freeze(result);\n\t}\n}\n\nfunction createSerializeableError(executionError: vscode.CellExecutionError | undefined) {\n\tconst convertRange = (range: vscode.Range | undefined) => (range ? {\n\t\tstartLineNumber: range.start.line,\n\t\tstartColumn: range.start.character,\n\t\tendLineNumber: range.end.line,\n\t\tendColumn: range.end.character\n\t} : undefined);\n\n\tconst convertStackFrame = (frame: vscode.CellErrorStackFrame) => ({\n\t\turi: frame.uri,\n\t\tposition: frame.position,\n\t\tlabel: frame.label\n\t});\n\n\tconst error = executionError ? {\n\t\tname: executionError.name,\n\t\tmessage: executionError.message,\n\t\tstack: executionError.stack instanceof Array\n\t\t\t? executionError.stack.map(frame => convertStackFrame(frame))\n\t\t\t: executionError.stack,\n\t\tlocation: convertRange(executionError.location),\n\t\turi: executionError.uri\n\t} : undefined;\n\treturn error;\n}\n\nenum NotebookExecutionTaskState {\n\tInit,\n\tStarted,\n\tResolved\n}\n\n\nclass NotebookExecutionTask extends Disposable {\n\tprivate static HANDLE = 0;\n\tprivate _handle = NotebookExecutionTask.HANDLE++;\n\n\tprivate _onDidChangeState = new Emitter<void>();\n\treadonly onDidChangeState = this._onDidChangeState.event;\n\n\tprivate _state = NotebookExecutionTaskState.Init;\n\tget state(): NotebookExecutionTaskState { return this._state; }\n\n\tprivate readonly _tokenSource = this._register(new CancellationTokenSource());\n\n\tconstructor(\n\t\tcontrollerId: string,\n\t\tprivate readonly _notebook: ExtHostNotebookDocument,\n\t\tprivate readonly _proxy: MainThreadNotebookKernelsShape\n\t) {\n\t\tsuper();\n\n\t\tthis._proxy.$createNotebookExecution(this._handle, controllerId, this._notebook.uri);\n\t}\n\n\tcancel(): void {\n\t\tthis._tokenSource.cancel();\n\t}\n\tasApiObject(): vscode.NotebookExecution {\n\t\tconst result: vscode.NotebookExecution = {\n\t\t\tstart: () => {\n\t\t\t\tif (this._state === NotebookExecutionTaskState.Resolved || this._state === NotebookExecutionTaskState.Started) {\n\t\t\t\t\tthrow new Error('Cannot call start again');\n\t\t\t\t}\n\n\t\t\t\tthis._state = NotebookExecutionTaskState.Started;\n\t\t\t\tthis._onDidChangeState.fire();\n\n\t\t\t\tthis._proxy.$beginNotebookExecution(this._handle);\n\t\t\t},\n\n\t\t\tend: () => {\n\t\t\t\tif (this._state === NotebookExecutionTaskState.Resolved) {\n\t\t\t\t\tthrow new Error('Cannot call resolve twice');\n\t\t\t\t}\n\n\t\t\t\tthis._state = NotebookExecutionTaskState.Resolved;\n\t\t\t\tthis._onDidChangeState.fire();\n\n\t\t\t\tthis._proxy.$completeNotebookExecution(this._handle);\n\t\t\t},\n\n\t\t};\n\t\treturn Object.freeze(result);\n\t}\n}\n\nclass TimeoutBasedCollector<T> {\n\tprivate batch: T[] = [];\n\tprivate startedTimer = Date.now();\n\tprivate currentDeferred: DeferredPromise<void> | undefined;\n\n\tconstructor(\n\t\tprivate readonly delay: number,\n\t\tprivate readonly callback: (items: T[]) => Promise<void>) { }\n\n\taddItem(item: T): Promise<void> {\n\t\tthis.batch.push(item);\n\t\tif (!this.currentDeferred) {\n\t\t\tthis.currentDeferred = new DeferredPromise<void>();\n\t\t\tthis.startedTimer = Date.now();\n\t\t\ttimeout(this.delay).then(() => {\n\t\t\t\treturn this.flush();\n\t\t\t});\n\t\t}\n\n\t\t// This can be called by the extension repeatedly for a long time before the timeout is able to run.\n\t\t// Force a flush after the delay.\n\t\tif (Date.now() - this.startedTimer > this.delay) {\n\t\t\treturn this.flush();\n\t\t}\n\n\t\treturn this.currentDeferred.p;\n\t}\n\n\tflush(): Promise<void> {\n\t\tif (this.batch.length === 0 || !this.currentDeferred) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tconst deferred = this.currentDeferred;\n\t\tthis.currentDeferred = undefined;\n\t\tconst batch = this.batch;\n\t\tthis.batch = [];\n\t\treturn this.callback(batch)\n\t\t\t.finally(() => deferred.complete());\n\t}\n}\n\nexport function createKernelId(extensionIdentifier: ExtensionIdentifier, id: string): string {\n\treturn `${extensionIdentifier.value}/${id}`;\n}\n"]}