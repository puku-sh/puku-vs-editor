{"version":3,"sources":["vs/workbench/api/common/extHostAuthentication.ts"],"names":[],"mappings":"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","file":"extHostAuthentication.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type * as vscode from 'vscode';\nimport * as nls from '../../../nls.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { MainContext, MainThreadAuthenticationShape, ExtHostAuthenticationShape } from './extHost.protocol.js';\nimport { Disposable, ProgressLocation } from './extHostTypes.js';\nimport { IExtensionDescription, ExtensionIdentifier } from '../../../platform/extensions/common/extensions.js';\nimport { INTERNAL_AUTH_PROVIDER_PREFIX, isAuthenticationWwwAuthenticateRequest } from '../../services/authentication/common/authentication.js';\nimport { createDecorator } from '../../../platform/instantiation/common/instantiation.js';\nimport { IExtHostRpcService } from './extHostRpcService.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { AuthorizationErrorType, fetchDynamicRegistration, getClaimsFromJWT, IAuthorizationJWTClaims, IAuthorizationProtectedResourceMetadata, IAuthorizationServerMetadata, IAuthorizationTokenResponse, isAuthorizationErrorResponse, isAuthorizationTokenResponse } from '../../../base/common/oauth.js';\nimport { IExtHostWindow } from './extHostWindow.js';\nimport { IExtHostInitDataService } from './extHostInitDataService.js';\nimport { ILogger, ILoggerService, ILogService } from '../../../platform/log/common/log.js';\nimport { autorun, derivedOpts, IObservable, ISettableObservable, observableValue } from '../../../base/common/observable.js';\nimport { stringHash } from '../../../base/common/hash.js';\nimport { DisposableStore, IDisposable } from '../../../base/common/lifecycle.js';\nimport { IExtHostUrlsService } from './extHostUrls.js';\nimport { encodeBase64, VSBuffer } from '../../../base/common/buffer.js';\nimport { equals as arraysEqual } from '../../../base/common/arrays.js';\nimport { IExtHostProgress } from './extHostProgress.js';\nimport { IProgressStep } from '../../../platform/progress/common/progress.js';\nimport { CancellationError, isCancellationError } from '../../../base/common/errors.js';\nimport { raceCancellationError, SequencerByKey } from '../../../base/common/async.js';\n\nexport interface IExtHostAuthentication extends ExtHostAuthentication { }\nexport const IExtHostAuthentication = createDecorator<IExtHostAuthentication>('IExtHostAuthentication');\n\ninterface ProviderWithMetadata {\n\tlabel: string;\n\tprovider: vscode.AuthenticationProvider;\n\tdisposable?: vscode.Disposable;\n\toptions: vscode.AuthenticationProviderOptions;\n}\n\nexport class ExtHostAuthentication implements ExtHostAuthenticationShape {\n\n\tdeclare _serviceBrand: undefined;\n\n\tprotected readonly _dynamicAuthProviderCtor = DynamicAuthProvider;\n\n\tprivate _proxy: MainThreadAuthenticationShape;\n\tprivate _authenticationProviders: Map<string, ProviderWithMetadata> = new Map<string, ProviderWithMetadata>();\n\tprivate _providerOperations = new SequencerByKey<string>();\n\n\tprivate _onDidChangeSessions = new Emitter<vscode.AuthenticationSessionsChangeEvent & { extensionIdFilter?: string[] }>();\n\tprivate _getSessionTaskSingler = new TaskSingler<vscode.AuthenticationSession | undefined>();\n\n\tprivate _onDidDynamicAuthProviderTokensChange = new Emitter<{ authProviderId: string; clientId: string; tokens: IAuthorizationToken[] }>();\n\n\tconstructor(\n\t\t@IExtHostRpcService extHostRpc: IExtHostRpcService,\n\t\t@IExtHostInitDataService private readonly _initData: IExtHostInitDataService,\n\t\t@IExtHostWindow private readonly _extHostWindow: IExtHostWindow,\n\t\t@IExtHostUrlsService private readonly _extHostUrls: IExtHostUrlsService,\n\t\t@IExtHostProgress private readonly _extHostProgress: IExtHostProgress,\n\t\t@ILoggerService private readonly _extHostLoggerService: ILoggerService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = extHostRpc.getProxy(MainContext.MainThreadAuthentication);\n\t}\n\n\t/**\n\t * This sets up an event that will fire when the auth sessions change with a built-in filter for the extensionId\n\t * if a session change only affects a specific extension.\n\t * @param extensionId The extension that is interested in the event.\n\t * @returns An event with a built-in filter for the extensionId\n\t */\n\tgetExtensionScopedSessionsEvent(extensionId: string): Event<vscode.AuthenticationSessionsChangeEvent> {\n\t\tconst normalizedExtensionId = extensionId.toLowerCase();\n\t\treturn Event.chain(this._onDidChangeSessions.event, ($) => $\n\t\t\t.filter(e => !e.extensionIdFilter || e.extensionIdFilter.includes(normalizedExtensionId))\n\t\t\t.map(e => ({ provider: e.provider }))\n\t\t);\n\t}\n\n\tasync getSession(requestingExtension: IExtensionDescription, providerId: string, scopesOrRequest: readonly string[] | vscode.AuthenticationWwwAuthenticateRequest, options: vscode.AuthenticationGetSessionOptions & ({ createIfNone: true } | { forceNewSession: true } | { forceNewSession: vscode.AuthenticationForceNewSessionOptions })): Promise<vscode.AuthenticationSession>;\n\tasync getSession(requestingExtension: IExtensionDescription, providerId: string, scopesOrRequest: readonly string[] | vscode.AuthenticationWwwAuthenticateRequest, options: vscode.AuthenticationGetSessionOptions & { forceNewSession: true }): Promise<vscode.AuthenticationSession>;\n\tasync getSession(requestingExtension: IExtensionDescription, providerId: string, scopesOrRequest: readonly string[] | vscode.AuthenticationWwwAuthenticateRequest, options: vscode.AuthenticationGetSessionOptions & { forceNewSession: vscode.AuthenticationForceNewSessionOptions }): Promise<vscode.AuthenticationSession>;\n\tasync getSession(requestingExtension: IExtensionDescription, providerId: string, scopesOrRequest: readonly string[] | vscode.AuthenticationWwwAuthenticateRequest, options: vscode.AuthenticationGetSessionOptions): Promise<vscode.AuthenticationSession | undefined>;\n\tasync getSession(requestingExtension: IExtensionDescription, providerId: string, scopesOrRequest: readonly string[] | vscode.AuthenticationWwwAuthenticateRequest, options: vscode.AuthenticationGetSessionOptions = {}): Promise<vscode.AuthenticationSession | undefined> {\n\t\tconst extensionId = ExtensionIdentifier.toKey(requestingExtension.identifier);\n\t\tconst keys: (keyof vscode.AuthenticationGetSessionOptions)[] = Object.keys(options) as (keyof vscode.AuthenticationGetSessionOptions)[];\n\t\t// TODO: pull this out into a utility function somewhere\n\t\tconst optionsStr = keys\n\t\t\t.map(key => {\n\t\t\t\tswitch (key) {\n\t\t\t\t\tcase 'account':\n\t\t\t\t\t\treturn `${key}:${options.account?.id}`;\n\t\t\t\t\tcase 'createIfNone':\n\t\t\t\t\tcase 'forceNewSession': {\n\t\t\t\t\t\tconst value = typeof options[key] === 'boolean'\n\t\t\t\t\t\t\t? `${options[key]}`\n\t\t\t\t\t\t\t: `'${options[key]?.detail}/${options[key]?.learnMore?.toString()}'`;\n\t\t\t\t\t\treturn `${key}:${value}`;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'authorizationServer':\n\t\t\t\t\t\treturn `${key}:${options.authorizationServer?.toString(true)}`;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn `${key}:${!!options[key]}`;\n\t\t\t\t}\n\t\t\t})\n\t\t\t.sort()\n\t\t\t.join(', ');\n\n\t\tlet singlerKey: string;\n\t\tif (isAuthenticationWwwAuthenticateRequest(scopesOrRequest)) {\n\t\t\tconst challenge = scopesOrRequest as vscode.AuthenticationWwwAuthenticateRequest;\n\t\t\tconst challengeStr = challenge.wwwAuthenticate;\n\t\t\tconst scopesStr = challenge.fallbackScopes ? [...challenge.fallbackScopes].sort().join(' ') : '';\n\t\t\tsinglerKey = `${extensionId} ${providerId} challenge:${challengeStr} ${scopesStr} ${optionsStr}`;\n\t\t} else {\n\t\t\tconst sortedScopes = [...scopesOrRequest].sort().join(' ');\n\t\t\tsinglerKey = `${extensionId} ${providerId} ${sortedScopes} ${optionsStr}`;\n\t\t}\n\n\t\treturn await this._getSessionTaskSingler.getOrCreate(singlerKey, async () => {\n\t\t\tawait this._proxy.$ensureProvider(providerId);\n\t\t\tconst extensionName = requestingExtension.displayName || requestingExtension.name;\n\t\t\treturn this._proxy.$getSession(providerId, scopesOrRequest, extensionId, extensionName, options);\n\t\t});\n\t}\n\n\tasync getAccounts(providerId: string) {\n\t\tawait this._proxy.$ensureProvider(providerId);\n\t\treturn await this._proxy.$getAccounts(providerId);\n\t}\n\n\tregisterAuthenticationProvider(id: string, label: string, provider: vscode.AuthenticationProvider, options?: vscode.AuthenticationProviderOptions): vscode.Disposable {\n\t\t// register\n\t\tvoid this._providerOperations.queue(id, async () => {\n\t\t\t// This use to be synchronous, but that wasn't an accurate representation because the main thread\n\t\t\t// may have unregistered the provider in the meantime. I don't see how this could really be done\n\t\t\t// synchronously, so we just say first one wins.\n\t\t\tif (this._authenticationProviders.get(id)) {\n\t\t\t\tthis._logService.error(`An authentication provider with id '${id}' is already registered. The existing provider will not be replaced.`);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst listener = provider.onDidChangeSessions(e => this._proxy.$sendDidChangeSessions(id, e));\n\t\t\tthis._authenticationProviders.set(id, { label, provider, disposable: listener, options: options ?? { supportsMultipleAccounts: false } });\n\t\t\tawait this._proxy.$registerAuthenticationProvider({\n\t\t\t\tid,\n\t\t\t\tlabel,\n\t\t\t\tsupportsMultipleAccounts: options?.supportsMultipleAccounts ?? false,\n\t\t\t\tsupportedAuthorizationServers: options?.supportedAuthorizationServers,\n\t\t\t\tsupportsChallenges: options?.supportsChallenges\n\t\t\t});\n\t\t});\n\n\t\t// unregister\n\t\treturn new Disposable(() => {\n\t\t\tvoid this._providerOperations.queue(id, async () => {\n\t\t\t\tconst providerData = this._authenticationProviders.get(id);\n\t\t\t\tif (providerData) {\n\t\t\t\t\tproviderData.disposable?.dispose();\n\t\t\t\t\tthis._authenticationProviders.delete(id);\n\t\t\t\t\tawait this._proxy.$unregisterAuthenticationProvider(id);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\t$createSession(providerId: string, scopes: string[], options: vscode.AuthenticationProviderSessionOptions): Promise<vscode.AuthenticationSession> {\n\t\treturn this._providerOperations.queue(providerId, async () => {\n\t\t\tconst providerData = this._authenticationProviders.get(providerId);\n\t\t\tif (providerData) {\n\t\t\t\toptions.authorizationServer = URI.revive(options.authorizationServer);\n\t\t\t\treturn await providerData.provider.createSession(scopes, options);\n\t\t\t}\n\n\t\t\tthrow new Error(`Unable to find authentication provider with handle: ${providerId}`);\n\t\t});\n\t}\n\n\t$removeSession(providerId: string, sessionId: string): Promise<void> {\n\t\treturn this._providerOperations.queue(providerId, async () => {\n\t\t\tconst providerData = this._authenticationProviders.get(providerId);\n\t\t\tif (providerData) {\n\t\t\t\treturn await providerData.provider.removeSession(sessionId);\n\t\t\t}\n\n\t\t\tthrow new Error(`Unable to find authentication provider with handle: ${providerId}`);\n\t\t});\n\t}\n\n\t$getSessions(providerId: string, scopes: ReadonlyArray<string> | undefined, options: vscode.AuthenticationProviderSessionOptions): Promise<ReadonlyArray<vscode.AuthenticationSession>> {\n\t\treturn this._providerOperations.queue(providerId, async () => {\n\t\t\tconst providerData = this._authenticationProviders.get(providerId);\n\t\t\tif (providerData) {\n\t\t\t\toptions.authorizationServer = URI.revive(options.authorizationServer);\n\t\t\t\treturn await providerData.provider.getSessions(scopes, options);\n\t\t\t}\n\n\t\t\tthrow new Error(`Unable to find authentication provider with handle: ${providerId}`);\n\t\t});\n\t}\n\n\t$getSessionsFromChallenges(providerId: string, constraint: vscode.AuthenticationConstraint, options: vscode.AuthenticationProviderSessionOptions): Promise<ReadonlyArray<vscode.AuthenticationSession>> {\n\t\treturn this._providerOperations.queue(providerId, async () => {\n\t\t\tconst providerData = this._authenticationProviders.get(providerId);\n\t\t\tif (providerData) {\n\t\t\t\tconst provider = providerData.provider;\n\t\t\t\t// Check if provider supports challenges\n\t\t\t\tif (typeof provider.getSessionsFromChallenges === 'function') {\n\t\t\t\t\toptions.authorizationServer = URI.revive(options.authorizationServer);\n\t\t\t\t\treturn await provider.getSessionsFromChallenges(constraint, options);\n\t\t\t\t}\n\t\t\t\tthrow new Error(`Authentication provider with handle: ${providerId} does not support getSessionsFromChallenges`);\n\t\t\t}\n\n\t\t\tthrow new Error(`Unable to find authentication provider with handle: ${providerId}`);\n\t\t});\n\t}\n\n\t$createSessionFromChallenges(providerId: string, constraint: vscode.AuthenticationConstraint, options: vscode.AuthenticationProviderSessionOptions): Promise<vscode.AuthenticationSession> {\n\t\treturn this._providerOperations.queue(providerId, async () => {\n\t\t\tconst providerData = this._authenticationProviders.get(providerId);\n\t\t\tif (providerData) {\n\t\t\t\tconst provider = providerData.provider;\n\t\t\t\t// Check if provider supports challenges\n\t\t\t\tif (typeof provider.createSessionFromChallenges === 'function') {\n\t\t\t\t\toptions.authorizationServer = URI.revive(options.authorizationServer);\n\t\t\t\t\treturn await provider.createSessionFromChallenges(constraint, options);\n\t\t\t\t}\n\t\t\t\tthrow new Error(`Authentication provider with handle: ${providerId} does not support createSessionFromChallenges`);\n\t\t\t}\n\n\t\t\tthrow new Error(`Unable to find authentication provider with handle: ${providerId}`);\n\t\t});\n\t}\n\n\t$onDidChangeAuthenticationSessions(id: string, label: string, extensionIdFilter?: string[]) {\n\t\t// Don't fire events for the internal auth providers\n\t\tif (!id.startsWith(INTERNAL_AUTH_PROVIDER_PREFIX)) {\n\t\t\tthis._onDidChangeSessions.fire({ provider: { id, label }, extensionIdFilter });\n\t\t}\n\t\treturn Promise.resolve();\n\t}\n\n\t$onDidUnregisterAuthenticationProvider(id: string): Promise<void> {\n\t\treturn this._providerOperations.queue(id, async () => {\n\t\t\tconst providerData = this._authenticationProviders.get(id);\n\t\t\tif (providerData) {\n\t\t\t\tproviderData.disposable?.dispose();\n\t\t\t\tthis._authenticationProviders.delete(id);\n\t\t\t}\n\t\t});\n\t}\n\n\tasync $registerDynamicAuthProvider(\n\t\tauthorizationServerComponents: UriComponents,\n\t\tserverMetadata: IAuthorizationServerMetadata,\n\t\tresourceMetadata: IAuthorizationProtectedResourceMetadata | undefined,\n\t\tclientId: string | undefined,\n\t\tclientSecret: string | undefined,\n\t\tinitialTokens: IAuthorizationToken[] | undefined\n\t): Promise<string> {\n\t\tif (!clientId) {\n\t\t\tconst authorizationServer = URI.revive(authorizationServerComponents);\n\t\t\tif (serverMetadata.registration_endpoint) {\n\t\t\t\ttry {\n\t\t\t\t\tconst registration = await fetchDynamicRegistration(serverMetadata, this._initData.environment.appName, resourceMetadata?.scopes_supported);\n\t\t\t\t\tclientId = registration.client_id;\n\t\t\t\t\tclientSecret = registration.client_secret;\n\t\t\t\t} catch (err) {\n\t\t\t\t\tthis._logService.warn(`Dynamic registration failed for ${authorizationServer.toString()}: ${err.message}. Prompting user for client ID and client secret...`);\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Still no client id so dynamic client registration was either not supported or failed\n\t\t\tif (!clientId) {\n\t\t\t\tthis._logService.info(`Prompting user for client registration details for ${authorizationServer.toString()}`);\n\t\t\t\tconst clientDetails = await this._proxy.$promptForClientRegistration(authorizationServer.toString());\n\t\t\t\tif (!clientDetails) {\n\t\t\t\t\tthrow new Error('User did not provide client details');\n\t\t\t\t}\n\t\t\t\tclientId = clientDetails.clientId;\n\t\t\t\tclientSecret = clientDetails.clientSecret;\n\t\t\t\tthis._logService.info(`User provided client registration for ${authorizationServer.toString()}`);\n\t\t\t\tif (clientSecret) {\n\t\t\t\t\tthis._logService.trace(`User provided client secret for ${authorizationServer.toString()}`);\n\t\t\t\t} else {\n\t\t\t\t\tthis._logService.trace(`User did not provide client secret for ${authorizationServer.toString()}`);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tconst provider = new this._dynamicAuthProviderCtor(\n\t\t\tthis._extHostWindow,\n\t\t\tthis._extHostUrls,\n\t\t\tthis._initData,\n\t\t\tthis._extHostProgress,\n\t\t\tthis._extHostLoggerService,\n\t\t\tthis._proxy,\n\t\t\tURI.revive(authorizationServerComponents),\n\t\t\tserverMetadata,\n\t\t\tresourceMetadata,\n\t\t\tclientId,\n\t\t\tclientSecret,\n\t\t\tthis._onDidDynamicAuthProviderTokensChange,\n\t\t\tinitialTokens || []\n\t\t);\n\n\t\t// Use the sequencer to ensure dynamic provider registration is serialized\n\t\tawait this._providerOperations.queue(provider.id, async () => {\n\t\t\tthis._authenticationProviders.set(\n\t\t\t\tprovider.id,\n\t\t\t\t{\n\t\t\t\t\tlabel: provider.label,\n\t\t\t\t\tprovider,\n\t\t\t\t\tdisposable: Disposable.from(\n\t\t\t\t\t\tprovider,\n\t\t\t\t\t\tprovider.onDidChangeSessions(e => this._proxy.$sendDidChangeSessions(provider.id, e)),\n\t\t\t\t\t\tprovider.onDidChangeClientId(() => this._proxy.$sendDidChangeDynamicProviderInfo({\n\t\t\t\t\t\t\tproviderId: provider.id,\n\t\t\t\t\t\t\tclientId: provider.clientId,\n\t\t\t\t\t\t\tclientSecret: provider.clientSecret\n\t\t\t\t\t\t}))\n\t\t\t\t\t),\n\t\t\t\t\toptions: { supportsMultipleAccounts: true }\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tawait this._proxy.$registerDynamicAuthenticationProvider({\n\t\t\t\tid: provider.id,\n\t\t\t\tlabel: provider.label,\n\t\t\t\tsupportsMultipleAccounts: true,\n\t\t\t\tauthorizationServer: authorizationServerComponents,\n\t\t\t\tresourceServer: resourceMetadata ? URI.parse(resourceMetadata.resource) : undefined,\n\t\t\t\tclientId: provider.clientId,\n\t\t\t\tclientSecret: provider.clientSecret\n\t\t\t});\n\t\t});\n\n\n\n\n\t\treturn provider.id;\n\t}\n\n\tasync $onDidChangeDynamicAuthProviderTokens(authProviderId: string, clientId: string, tokens: IAuthorizationToken[]): Promise<void> {\n\t\tthis._onDidDynamicAuthProviderTokensChange.fire({ authProviderId, clientId, tokens });\n\t}\n}\n\nclass TaskSingler<T> {\n\tprivate _inFlightPromises = new Map<string, Promise<T>>();\n\tgetOrCreate(key: string, promiseFactory: () => Promise<T>) {\n\t\tconst inFlight = this._inFlightPromises.get(key);\n\t\tif (inFlight) {\n\t\t\treturn inFlight;\n\t\t}\n\n\t\tconst promise = promiseFactory().finally(() => this._inFlightPromises.delete(key));\n\t\tthis._inFlightPromises.set(key, promise);\n\n\t\treturn promise;\n\t}\n}\n\nexport class DynamicAuthProvider implements vscode.AuthenticationProvider {\n\treadonly id: string;\n\treadonly label: string;\n\n\tprivate _onDidChangeSessions = new Emitter<vscode.AuthenticationProviderAuthenticationSessionsChangeEvent>();\n\treadonly onDidChangeSessions = this._onDidChangeSessions.event;\n\n\tprivate readonly _onDidChangeClientId = new Emitter<void>();\n\treadonly onDidChangeClientId = this._onDidChangeClientId.event;\n\n\tprivate readonly _tokenStore: TokenStore;\n\n\tprotected readonly _createFlows: Array<{\n\t\tlabel: string;\n\t\thandler: (scopes: string[], progress: vscode.Progress<{ message: string }>, token: vscode.CancellationToken) => Promise<IAuthorizationTokenResponse>;\n\t}>;\n\n\tprotected readonly _logger: ILogger;\n\tprivate readonly _disposable: DisposableStore;\n\n\tconstructor(\n\t\t@IExtHostWindow protected readonly _extHostWindow: IExtHostWindow,\n\t\t@IExtHostUrlsService protected readonly _extHostUrls: IExtHostUrlsService,\n\t\t@IExtHostInitDataService protected readonly _initData: IExtHostInitDataService,\n\t\t@IExtHostProgress private readonly _extHostProgress: IExtHostProgress,\n\t\t@ILoggerService loggerService: ILoggerService,\n\t\tprotected readonly _proxy: MainThreadAuthenticationShape,\n\t\treadonly authorizationServer: URI,\n\t\tprotected readonly _serverMetadata: IAuthorizationServerMetadata,\n\t\tprotected readonly _resourceMetadata: IAuthorizationProtectedResourceMetadata | undefined,\n\t\tprotected _clientId: string,\n\t\tprotected _clientSecret: string | undefined,\n\t\tonDidDynamicAuthProviderTokensChange: Emitter<{ authProviderId: string; clientId: string; tokens: IAuthorizationToken[] }>,\n\t\tinitialTokens: IAuthorizationToken[],\n\t) {\n\t\tconst stringifiedServer = authorizationServer.toString(true);\n\t\t// Auth Provider Id is a combination of the authorization server and the resource, if provided.\n\t\tthis.id = _resourceMetadata?.resource\n\t\t\t? stringifiedServer + ' ' + _resourceMetadata?.resource\n\t\t\t: stringifiedServer;\n\t\t// Auth Provider label is just the resource name if provided, otherwise the authority of the authorization server.\n\t\tthis.label = _resourceMetadata?.resource_name ?? this.authorizationServer.authority;\n\n\t\tthis._logger = loggerService.createLogger(this.id, { name: `Auth: ${this.label}` });\n\t\tthis._disposable = new DisposableStore();\n\t\tthis._disposable.add(this._onDidChangeSessions);\n\t\tconst scopedEvent = Event.chain(onDidDynamicAuthProviderTokensChange.event, $ => $\n\t\t\t.filter(e => e.authProviderId === this.id && e.clientId === _clientId)\n\t\t\t.map(e => e.tokens)\n\t\t);\n\t\tthis._tokenStore = this._disposable.add(new TokenStore(\n\t\t\t{\n\t\t\t\tonDidChange: scopedEvent,\n\t\t\t\tset: (tokens) => _proxy.$setSessionsForDynamicAuthProvider(this.id, this.clientId, tokens),\n\t\t\t},\n\t\t\tinitialTokens,\n\t\t\tthis._logger\n\t\t));\n\t\tthis._disposable.add(this._tokenStore.onDidChangeSessions(e => this._onDidChangeSessions.fire(e)));\n\t\t// Will be extended later to support other flows\n\t\tthis._createFlows = [];\n\t\tif (_serverMetadata.authorization_endpoint) {\n\t\t\tthis._createFlows.push({\n\t\t\t\tlabel: nls.localize('url handler', \"URL Handler\"),\n\t\t\t\thandler: (scopes, progress, token) => this._createWithUrlHandler(scopes, progress, token)\n\t\t\t});\n\t\t}\n\t}\n\n\tget clientId(): string {\n\t\treturn this._clientId;\n\t}\n\n\tget clientSecret(): string | undefined {\n\t\treturn this._clientSecret;\n\t}\n\n\tasync getSessions(scopes: readonly string[] | undefined, _options: vscode.AuthenticationProviderSessionOptions): Promise<vscode.AuthenticationSession[]> {\n\t\tthis._logger.info(`Getting sessions for scopes: ${scopes?.join(' ') ?? 'all'}`);\n\t\tif (!scopes) {\n\t\t\treturn this._tokenStore.sessions;\n\t\t}\n\t\t// The oauth spec says tthat order doesn't matter so we sort the scopes for easy comparison\n\t\t// https://datatracker.ietf.org/doc/html/rfc6749#section-3.3\n\t\t// TODO@TylerLeonhardt: Do this for all scope handling in the auth APIs\n\t\tconst sortedScopes = [...scopes].sort();\n\t\tconst scopeStr = scopes.join(' ');\n\t\tlet sessions = this._tokenStore.sessions.filter(session => arraysEqual([...session.scopes].sort(), sortedScopes));\n\t\tthis._logger.info(`Found ${sessions.length} sessions for scopes: ${scopeStr}`);\n\t\tif (sessions.length) {\n\t\t\tconst newTokens: IAuthorizationToken[] = [];\n\t\t\tconst removedTokens: IAuthorizationToken[] = [];\n\t\t\tconst tokenMap = new Map<string, IAuthorizationToken>(this._tokenStore.tokens.map(token => [token.access_token, token]));\n\t\t\tfor (const session of sessions) {\n\t\t\t\tconst token = tokenMap.get(session.accessToken);\n\t\t\t\tif (token && token.expires_in) {\n\t\t\t\t\tconst now = Date.now();\n\t\t\t\t\tconst expiresInMS = token.expires_in * 1000;\n\t\t\t\t\t// Check if the token is about to expire in 5 minutes or if it is expired\n\t\t\t\t\tif (now > token.created_at + expiresInMS - (5 * 60 * 1000)) {\n\t\t\t\t\t\tthis._logger.info(`Token for session ${session.id} is about to expire, refreshing...`);\n\t\t\t\t\t\tremovedTokens.push(token);\n\t\t\t\t\t\tif (!token.refresh_token) {\n\t\t\t\t\t\t\t// No refresh token available, cannot refresh\n\t\t\t\t\t\t\tthis._logger.warn(`No refresh token available for scopes ${session.scopes.join(' ')}. Throwing away token.`);\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst newToken = await this.exchangeRefreshTokenForToken(token.refresh_token);\n\t\t\t\t\t\t\t// TODO@TylerLeonhardt: When the core scope handling doesn't care about order, this check should be\n\t\t\t\t\t\t\t// updated to not care about order\n\t\t\t\t\t\t\tif (newToken.scope !== scopeStr) {\n\t\t\t\t\t\t\t\tthis._logger.warn(`Token scopes '${newToken.scope}' do not match requested scopes '${scopeStr}'. Overwriting token with what was requested...`);\n\t\t\t\t\t\t\t\tnewToken.scope = scopeStr;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis._logger.info(`Successfully created a new token for scopes ${session.scopes.join(' ')}.`);\n\t\t\t\t\t\t\tnewTokens.push(newToken);\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\tthis._logger.error(`Failed to refresh token: ${err}`);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (newTokens.length || removedTokens.length) {\n\t\t\t\tthis._tokenStore.update({ added: newTokens, removed: removedTokens });\n\t\t\t\t// Since we updated the tokens, we need to re-filter the sessions\n\t\t\t\t// to get the latest state\n\t\t\t\tsessions = this._tokenStore.sessions.filter(session => arraysEqual([...session.scopes].sort(), sortedScopes));\n\t\t\t}\n\t\t\tthis._logger.info(`Found ${sessions.length} sessions for scopes: ${scopeStr}`);\n\t\t\treturn sessions;\n\t\t}\n\t\treturn [];\n\t}\n\n\tasync createSession(scopes: string[], _options: vscode.AuthenticationProviderSessionOptions): Promise<vscode.AuthenticationSession> {\n\t\tthis._logger.info(`Creating session for scopes: ${scopes.join(' ')}`);\n\t\tlet token: IAuthorizationTokenResponse | undefined;\n\t\tfor (let i = 0; i < this._createFlows.length; i++) {\n\t\t\tconst { handler } = this._createFlows[i];\n\t\t\ttry {\n\t\t\t\ttoken = await this._extHostProgress.withProgressFromSource(\n\t\t\t\t\t{ label: this.label, id: this.id },\n\t\t\t\t\t{\n\t\t\t\t\t\tlocation: ProgressLocation.Notification,\n\t\t\t\t\t\ttitle: nls.localize('authenticatingTo', \"Authenticating to '{0}'\", this.label),\n\t\t\t\t\t\tcancellable: true\n\t\t\t\t\t},\n\t\t\t\t\t(progress, token) => handler(scopes, progress, token));\n\t\t\t\tif (token) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tconst nextMode = this._createFlows[i + 1]?.label;\n\t\t\t\tif (!nextMode) {\n\t\t\t\t\tbreak; // No more flows to try\n\t\t\t\t}\n\t\t\t\tconst message = isCancellationError(err)\n\t\t\t\t\t? nls.localize('userCanceledContinue', \"Having trouble authenticating to '{0}'? Would you like to try a different way? ({1})\", this.label, nextMode)\n\t\t\t\t\t: nls.localize('continueWith', \"You have not yet finished authenticating to '{0}'. Would you like to try a different way? ({1})\", this.label, nextMode);\n\n\t\t\t\tconst result = await this._proxy.$showContinueNotification(message);\n\t\t\t\tif (!result) {\n\t\t\t\t\tthrow new CancellationError();\n\t\t\t\t}\n\t\t\t\tthis._logger.error(`Failed to create token via flow '${nextMode}': ${err}`);\n\t\t\t}\n\t\t}\n\t\tif (!token) {\n\t\t\tthrow new Error('Failed to create authentication token');\n\t\t}\n\t\tif (token.scope !== scopes.join(' ')) {\n\t\t\tthis._logger.warn(`Token scopes '${token.scope}' do not match requested scopes '${scopes.join(' ')}'. Overwriting token with what was requested...`);\n\t\t\ttoken.scope = scopes.join(' ');\n\t\t}\n\n\t\t// Store session for later retrieval\n\t\tthis._tokenStore.update({ added: [{ ...token, created_at: Date.now() }], removed: [] });\n\t\tconst session = this._tokenStore.sessions.find(t => t.accessToken === token.access_token)!;\n\t\tthis._logger.info(`Created ${token.refresh_token ? 'refreshable' : 'non-refreshable'} session for scopes: ${token.scope}${token.expires_in ? ` that expires in ${token.expires_in} seconds` : ''}`);\n\t\treturn session;\n\t}\n\n\tasync removeSession(sessionId: string): Promise<void> {\n\t\tthis._logger.info(`Removing session with id: ${sessionId}`);\n\t\tconst session = this._tokenStore.sessions.find(session => session.id === sessionId);\n\t\tif (!session) {\n\t\t\tthis._logger.error(`Session with id ${sessionId} not found`);\n\t\t\treturn;\n\t\t}\n\t\tconst token = this._tokenStore.tokens.find(token => token.access_token === session.accessToken);\n\t\tif (!token) {\n\t\t\tthis._logger.error(`Failed to retrieve token for removed session: ${session.id}`);\n\t\t\treturn;\n\t\t}\n\t\tthis._tokenStore.update({ added: [], removed: [token] });\n\t\tthis._logger.info(`Removed token for session: ${session.id} with scopes: ${session.scopes.join(' ')}`);\n\t}\n\n\tdispose(): void {\n\t\tthis._disposable.dispose();\n\t}\n\n\tprivate async _createWithUrlHandler(scopes: string[], progress: vscode.Progress<IProgressStep>, token: vscode.CancellationToken): Promise<IAuthorizationTokenResponse> {\n\t\tif (!this._serverMetadata.authorization_endpoint) {\n\t\t\tthrow new Error('Authorization Endpoint required');\n\t\t}\n\t\tif (!this._serverMetadata.token_endpoint) {\n\t\t\tthrow new Error('Token endpoint not available in server metadata');\n\t\t}\n\n\t\t// Generate PKCE code verifier (random string) and code challenge (SHA-256 hash of verifier)\n\t\tconst codeVerifier = this.generateRandomString(64);\n\t\tconst codeChallenge = await this.generateCodeChallenge(codeVerifier);\n\n\t\t// Generate a random state value to prevent CSRF\n\t\tconst nonce = this.generateRandomString(32);\n\t\tconst callbackUri = URI.parse(`${this._initData.environment.appUriScheme}://dynamicauthprovider/${this.authorizationServer.authority}/authorize?nonce=${nonce}`);\n\t\tlet state: URI;\n\t\ttry {\n\t\t\tstate = await this._extHostUrls.createAppUri(callbackUri);\n\t\t} catch (error) {\n\t\t\tthrow new Error(`Failed to create external URI: ${error}`);\n\t\t}\n\n\t\t// Prepare the authorization request URL\n\t\tconst authorizationUrl = new URL(this._serverMetadata.authorization_endpoint);\n\t\tauthorizationUrl.searchParams.append('client_id', this._clientId);\n\t\tauthorizationUrl.searchParams.append('response_type', 'code');\n\t\tauthorizationUrl.searchParams.append('state', state.toString());\n\t\tauthorizationUrl.searchParams.append('code_challenge', codeChallenge);\n\t\tauthorizationUrl.searchParams.append('code_challenge_method', 'S256');\n\t\tconst scopeString = scopes.join(' ');\n\t\tif (scopeString) {\n\t\t\t// If non-empty scopes are provided, include scope parameter in the request\n\t\t\tauthorizationUrl.searchParams.append('scope', scopeString);\n\t\t}\n\t\tif (this._resourceMetadata?.resource) {\n\t\t\t// If a resource is specified, include it in the request\n\t\t\tauthorizationUrl.searchParams.append('resource', this._resourceMetadata.resource);\n\t\t}\n\n\t\t// Use a redirect URI that matches what was registered during dynamic registration\n\t\tconst redirectUri = 'https://vscode.dev/redirect';\n\t\tauthorizationUrl.searchParams.append('redirect_uri', redirectUri);\n\n\t\tconst promise = this.waitForAuthorizationCode(callbackUri);\n\n\t\t// Open the browser for user authorization\n\t\tthis._logger.info(`Opening authorization URL for scopes: ${scopeString}`);\n\t\tthis._logger.trace(`Authorization URL: ${authorizationUrl.toString()}`);\n\t\tconst opened = await this._extHostWindow.openUri(authorizationUrl.toString(), {});\n\t\tif (!opened) {\n\t\t\tthrow new CancellationError();\n\t\t}\n\t\tprogress.report({\n\t\t\tmessage: nls.localize('completeAuth', \"Complete the authentication in the browser window that has opened.\"),\n\t\t});\n\n\t\t// Wait for the authorization code via a redirect\n\t\tlet code: string | undefined;\n\t\ttry {\n\t\t\tconst response = await raceCancellationError(promise, token);\n\t\t\tcode = response.code;\n\t\t} catch (err) {\n\t\t\tif (isCancellationError(err)) {\n\t\t\t\tthis._logger.info('Authorization code request was cancelled by the user.');\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t\tthis._logger.error(`Failed to receive authorization code: ${err}`);\n\t\t\tthrow new Error(`Failed to receive authorization code: ${err}`);\n\t\t}\n\t\tthis._logger.info(`Authorization code received for scopes: ${scopeString}`);\n\n\t\t// Exchange the authorization code for tokens\n\t\tconst tokenResponse = await this.exchangeCodeForToken(code, codeVerifier, redirectUri);\n\t\treturn tokenResponse;\n\t}\n\n\tprotected generateRandomString(length: number): string {\n\t\tconst array = new Uint8Array(length);\n\t\tcrypto.getRandomValues(array);\n\t\treturn Array.from(array)\n\t\t\t.map(b => b.toString(16).padStart(2, '0'))\n\t\t\t.join('')\n\t\t\t.substring(0, length);\n\t}\n\n\tprotected async generateCodeChallenge(codeVerifier: string): Promise<string> {\n\t\tconst encoder = new TextEncoder();\n\t\tconst data = encoder.encode(codeVerifier);\n\t\tconst digest = await crypto.subtle.digest('SHA-256', data);\n\n\t\t// Base64url encode the digest\n\t\treturn encodeBase64(VSBuffer.wrap(new Uint8Array(digest)), false, false)\n\t\t\t.replace(/\\+/g, '-')\n\t\t\t.replace(/\\//g, '_')\n\t\t\t.replace(/=+$/, '');\n\t}\n\n\tprivate async waitForAuthorizationCode(expectedState: URI): Promise<{ code: string }> {\n\t\tconst result = await this._proxy.$waitForUriHandler(expectedState);\n\t\t// Extract the code parameter directly from the query string. NOTE, URLSearchParams does not work here because\n\t\t// it will decode the query string and we need to keep it encoded.\n\t\tconst codeMatch = /[?&]code=([^&]+)/.exec(result.query || '');\n\t\tif (!codeMatch || codeMatch.length < 2) {\n\t\t\t// No code parameter found in the query string\n\t\t\tthrow new Error('Authentication failed: No authorization code received');\n\t\t}\n\t\treturn { code: codeMatch[1] };\n\t}\n\n\tprotected async exchangeCodeForToken(code: string, codeVerifier: string, redirectUri: string): Promise<IAuthorizationTokenResponse> {\n\t\tif (!this._serverMetadata.token_endpoint) {\n\t\t\tthrow new Error('Token endpoint not available in server metadata');\n\t\t}\n\n\t\tconst tokenRequest = new URLSearchParams();\n\t\ttokenRequest.append('client_id', this._clientId);\n\t\ttokenRequest.append('grant_type', 'authorization_code');\n\t\ttokenRequest.append('code', code);\n\t\ttokenRequest.append('redirect_uri', redirectUri);\n\t\ttokenRequest.append('code_verifier', codeVerifier);\n\n\t\t// Add resource indicator if available (RFC 8707)\n\t\tif (this._resourceMetadata?.resource) {\n\t\t\ttokenRequest.append('resource', this._resourceMetadata.resource);\n\t\t}\n\n\t\t// Add client secret if available\n\t\tif (this._clientSecret) {\n\t\t\ttokenRequest.append('client_secret', this._clientSecret);\n\t\t}\n\n\t\tthis._logger.info('Exchanging authorization code for token...');\n\t\tthis._logger.trace(`Url: ${this._serverMetadata.token_endpoint}`);\n\t\tthis._logger.trace(`Token request body: ${tokenRequest.toString()}`);\n\t\tlet response: Response;\n\t\ttry {\n\t\t\tresponse = await fetch(this._serverMetadata.token_endpoint, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t\t'Accept': 'application/json'\n\t\t\t\t},\n\t\t\t\tbody: tokenRequest.toString()\n\t\t\t});\n\t\t} catch (err) {\n\t\t\tthis._logger.error(`Failed to exchange authorization code for token: ${err}`);\n\t\t\tthrow new Error(`Failed to exchange authorization code for token: ${err}`);\n\t\t}\n\n\t\tif (!response.ok) {\n\t\t\tconst text = await response.text();\n\t\t\tthrow new Error(`Token exchange failed: ${response.status} ${response.statusText} - ${text}`);\n\t\t}\n\n\t\tconst result = await response.json();\n\t\tif (isAuthorizationTokenResponse(result)) {\n\t\t\tthis._logger.info(`Successfully exchanged authorization code for token.`);\n\t\t\treturn result;\n\t\t} else if (isAuthorizationErrorResponse(result) && result.error === AuthorizationErrorType.InvalidClient) {\n\t\t\tthis._logger.warn(`Client ID (${this._clientId}) was invalid, generated a new one.`);\n\t\t\tawait this._generateNewClientId();\n\t\t\tthrow new Error(`Client ID was invalid, generated a new one. Please try again.`);\n\t\t}\n\t\tthrow new Error(`Invalid authorization token response: ${JSON.stringify(result)}`);\n\t}\n\n\tprotected async exchangeRefreshTokenForToken(refreshToken: string): Promise<IAuthorizationToken> {\n\t\tif (!this._serverMetadata.token_endpoint) {\n\t\t\tthrow new Error('Token endpoint not available in server metadata');\n\t\t}\n\n\t\tconst tokenRequest = new URLSearchParams();\n\t\ttokenRequest.append('client_id', this._clientId);\n\t\ttokenRequest.append('grant_type', 'refresh_token');\n\t\ttokenRequest.append('refresh_token', refreshToken);\n\n\t\t// Add resource indicator if available (RFC 8707)\n\t\tif (this._resourceMetadata?.resource) {\n\t\t\ttokenRequest.append('resource', this._resourceMetadata.resource);\n\t\t}\n\n\t\t// Add client secret if available\n\t\tif (this._clientSecret) {\n\t\t\ttokenRequest.append('client_secret', this._clientSecret);\n\t\t}\n\n\t\tconst response = await fetch(this._serverMetadata.token_endpoint, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t'Accept': 'application/json'\n\t\t\t},\n\t\t\tbody: tokenRequest.toString()\n\t\t});\n\n\t\tconst result = await response.json();\n\t\tif (isAuthorizationTokenResponse(result)) {\n\t\t\treturn {\n\t\t\t\t...result,\n\t\t\t\tcreated_at: Date.now(),\n\t\t\t};\n\t\t} else if (isAuthorizationErrorResponse(result) && result.error === AuthorizationErrorType.InvalidClient) {\n\t\t\tthis._logger.warn(`Client ID (${this._clientId}) was invalid, generated a new one.`);\n\t\t\tawait this._generateNewClientId();\n\t\t\tthrow new Error(`Client ID was invalid, generated a new one. Please try again.`);\n\t\t}\n\t\tthrow new Error(`Invalid authorization token response: ${JSON.stringify(result)}`);\n\t}\n\n\tprotected async _generateNewClientId(): Promise<void> {\n\t\ttry {\n\t\t\tconst registration = await fetchDynamicRegistration(this._serverMetadata, this._initData.environment.appName, this._resourceMetadata?.scopes_supported);\n\t\t\tthis._clientId = registration.client_id;\n\t\t\tthis._clientSecret = registration.client_secret;\n\t\t\tthis._onDidChangeClientId.fire();\n\t\t} catch (err) {\n\t\t\t// When DCR fails, try to prompt the user for a client ID and client secret\n\t\t\tthis._logger.info(`Dynamic registration failed for ${this.authorizationServer.toString()}: ${err}. Prompting user for client ID and client secret.`);\n\n\t\t\ttry {\n\t\t\t\tconst clientDetails = await this._proxy.$promptForClientRegistration(this.authorizationServer.toString());\n\t\t\t\tif (!clientDetails) {\n\t\t\t\t\tthrow new Error('User did not provide client details');\n\t\t\t\t}\n\t\t\t\tthis._clientId = clientDetails.clientId;\n\t\t\t\tthis._clientSecret = clientDetails.clientSecret;\n\t\t\t\tthis._logger.info(`User provided client ID for ${this.authorizationServer.toString()}`);\n\t\t\t\tif (clientDetails.clientSecret) {\n\t\t\t\t\tthis._logger.info(`User provided client secret for ${this.authorizationServer.toString()}`);\n\t\t\t\t} else {\n\t\t\t\t\tthis._logger.info(`User did not provide client secret for ${this.authorizationServer.toString()} (optional)`);\n\t\t\t\t}\n\n\t\t\t\tthis._onDidChangeClientId.fire();\n\t\t\t} catch (promptErr) {\n\t\t\t\tthis._logger.error(`Failed to fetch new client ID and user did not provide one: ${err}`);\n\t\t\t\tthrow new Error(`Failed to fetch new client ID and user did not provide one: ${err}`);\n\t\t\t}\n\t\t}\n\t}\n}\n\ntype IAuthorizationToken = IAuthorizationTokenResponse & {\n\t/**\n\t * The time when the token was created, in milliseconds since the epoch.\n\t */\n\tcreated_at: number;\n};\n\nclass TokenStore implements Disposable {\n\tprivate readonly _tokensObservable: ISettableObservable<IAuthorizationToken[]>;\n\tprivate readonly _sessionsObservable: IObservable<vscode.AuthenticationSession[]>;\n\n\tprivate readonly _onDidChangeSessions = new Emitter<vscode.AuthenticationProviderAuthenticationSessionsChangeEvent>();\n\treadonly onDidChangeSessions = this._onDidChangeSessions.event;\n\n\tprivate readonly _disposable: DisposableStore;\n\n\tconstructor(\n\t\tprivate readonly _persistence: { onDidChange: Event<IAuthorizationToken[]>; set: (tokens: IAuthorizationToken[]) => void },\n\t\tinitialTokens: IAuthorizationToken[],\n\t\tprivate readonly _logger: ILogger\n\t) {\n\t\tthis._disposable = new DisposableStore();\n\t\tthis._tokensObservable = observableValue<IAuthorizationToken[]>('tokens', initialTokens);\n\t\tthis._sessionsObservable = derivedOpts(\n\t\t\t{ equalsFn: (a, b) => arraysEqual(a, b, (a, b) => a.accessToken === b.accessToken) },\n\t\t\t(reader) => this._tokensObservable.read(reader).map(t => this._getSessionFromToken(t))\n\t\t);\n\t\tthis._disposable.add(this._registerChangeEventAutorun());\n\t\tthis._disposable.add(this._persistence.onDidChange((tokens) => this._tokensObservable.set(tokens, undefined)));\n\t}\n\n\tget tokens(): IAuthorizationToken[] {\n\t\treturn this._tokensObservable.get();\n\t}\n\n\tget sessions(): vscode.AuthenticationSession[] {\n\t\treturn this._sessionsObservable.get();\n\t}\n\n\tdispose() {\n\t\tthis._disposable.dispose();\n\t}\n\n\tupdate({ added, removed }: { added: IAuthorizationToken[]; removed: IAuthorizationToken[] }): void {\n\t\tthis._logger.trace(`Updating tokens: added ${added.length}, removed ${removed.length}`);\n\t\tconst currentTokens = [...this._tokensObservable.get()];\n\t\tfor (const token of removed) {\n\t\t\tconst index = currentTokens.findIndex(t => t.access_token === token.access_token);\n\t\t\tif (index !== -1) {\n\t\t\t\tcurrentTokens.splice(index, 1);\n\t\t\t}\n\t\t}\n\t\tfor (const token of added) {\n\t\t\tconst index = currentTokens.findIndex(t => t.access_token === token.access_token);\n\t\t\tif (index === -1) {\n\t\t\t\tcurrentTokens.push(token);\n\t\t\t} else {\n\t\t\t\tcurrentTokens[index] = token;\n\t\t\t}\n\t\t}\n\t\tif (added.length || removed.length) {\n\t\t\tthis._tokensObservable.set(currentTokens, undefined);\n\t\t\tvoid this._persistence.set(currentTokens);\n\t\t}\n\t\tthis._logger.trace(`Tokens updated: ${currentTokens.length} tokens stored.`);\n\t}\n\n\tprivate _registerChangeEventAutorun(): IDisposable {\n\t\tlet previousSessions: vscode.AuthenticationSession[] = [];\n\t\treturn autorun((reader) => {\n\t\t\tthis._logger.trace('Checking for session changes...');\n\t\t\tconst currentSessions = this._sessionsObservable.read(reader);\n\t\t\tif (previousSessions === currentSessions) {\n\t\t\t\tthis._logger.trace('No session changes detected.');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!currentSessions || currentSessions.length === 0) {\n\t\t\t\t// If currentSessions is undefined, all previous sessions are considered removed\n\t\t\t\tthis._logger.trace('All sessions removed.');\n\t\t\t\tif (previousSessions.length > 0) {\n\t\t\t\t\tthis._onDidChangeSessions.fire({\n\t\t\t\t\t\tadded: [],\n\t\t\t\t\t\tremoved: previousSessions,\n\t\t\t\t\t\tchanged: []\n\t\t\t\t\t});\n\t\t\t\t\tpreviousSessions = [];\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst added: vscode.AuthenticationSession[] = [];\n\t\t\tconst removed: vscode.AuthenticationSession[] = [];\n\n\t\t\t// Find added sessions\n\t\t\tfor (const current of currentSessions) {\n\t\t\t\tconst exists = previousSessions.some(prev => prev.accessToken === current.accessToken);\n\t\t\t\tif (!exists) {\n\t\t\t\t\tadded.push(current);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Find removed sessions\n\t\t\tfor (const prev of previousSessions) {\n\t\t\t\tconst exists = currentSessions.some(current => current.accessToken === prev.accessToken);\n\t\t\t\tif (!exists) {\n\t\t\t\t\tremoved.push(prev);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Fire the event if there are any changes\n\t\t\tif (added.length > 0 || removed.length > 0) {\n\t\t\t\tthis._logger.trace(`Sessions changed: added ${added.length}, removed ${removed.length}`);\n\t\t\t\tthis._onDidChangeSessions.fire({ added, removed, changed: [] });\n\t\t\t}\n\n\t\t\t// Update previous sessions reference\n\t\t\tpreviousSessions = currentSessions;\n\t\t});\n\t}\n\n\tprivate _getSessionFromToken(token: IAuthorizationTokenResponse): vscode.AuthenticationSession {\n\t\tlet claims: IAuthorizationJWTClaims | undefined;\n\t\tif (token.id_token) {\n\t\t\ttry {\n\t\t\t\tclaims = getClaimsFromJWT(token.id_token);\n\t\t\t} catch (e) {\n\t\t\t\t// log\n\t\t\t}\n\t\t}\n\t\tif (!claims) {\n\t\t\ttry {\n\t\t\t\tclaims = getClaimsFromJWT(token.access_token);\n\t\t\t} catch (e) {\n\t\t\t\t// log\n\t\t\t}\n\t\t}\n\t\tconst scopes = token.scope\n\t\t\t? token.scope.split(' ')\n\t\t\t: claims?.scope\n\t\t\t\t? claims.scope.split(' ')\n\t\t\t\t: [];\n\t\treturn {\n\t\t\tid: stringHash(token.access_token, 0).toString(),\n\t\t\taccessToken: token.access_token,\n\t\t\taccount: {\n\t\t\t\tid: claims?.sub || 'unknown',\n\t\t\t\t// TODO: Don't say MCP...\n\t\t\t\tlabel: claims?.preferred_username || claims?.name || claims?.email || 'MCP',\n\t\t\t},\n\t\t\tscopes: scopes,\n\t\t\tidToken: token.id_token\n\t\t};\n\t}\n}\n"]}