{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostTimeline.ts","vs/workbench/api/common/extHostTimeline.ts"],"names":[],"mappings":"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","file":"extHostTimeline.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as vscode from 'vscode';\nimport { UriComponents, URI } from '../../../base/common/uri.js';\nimport { createDecorator } from '../../../platform/instantiation/common/instantiation.js';\nimport { ExtHostTimelineShape, MainThreadTimelineShape, IMainContext, MainContext } from './extHost.protocol.js';\nimport { Timeline, TimelineItem, TimelineOptions, TimelineProvider } from '../../contrib/timeline/common/timeline.js';\nimport { IDisposable, toDisposable, DisposableStore } from '../../../base/common/lifecycle.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { CommandsConverter, ExtHostCommands } from './extHostCommands.js';\nimport { ThemeIcon, MarkdownString as MarkdownStringType } from './extHostTypes.js';\nimport { MarkdownString } from './extHostTypeConverters.js';\nimport { ExtensionIdentifier } from '../../../platform/extensions/common/extensions.js';\nimport { MarshalledId } from '../../../base/common/marshallingIds.js';\nimport { isString } from '../../../base/common/types.js';\nimport { isProposedApiEnabled } from '../../services/extensions/common/extensions.js';\n\nexport interface IExtHostTimeline extends ExtHostTimelineShape {\n\treadonly _serviceBrand: undefined;\n\t$getTimeline(id: string, uri: UriComponents, options: vscode.TimelineOptions, token: vscode.CancellationToken): Promise<Timeline | undefined>;\n}\n\nexport const IExtHostTimeline = createDecorator<IExtHostTimeline>('IExtHostTimeline');\n\nexport class ExtHostTimeline implements IExtHostTimeline {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate _proxy: MainThreadTimelineShape;\n\n\tprivate _providers = new Map<string, { provider: TimelineProvider; extension: ExtensionIdentifier }>();\n\n\tprivate _itemsBySourceAndUriMap = new Map<string, Map<string | undefined, Map<string, vscode.TimelineItem>>>();\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tcommands: ExtHostCommands,\n\t) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadTimeline);\n\n\t\tcommands.registerArgumentProcessor({\n\t\t\tprocessArgument: (arg, extension) => {\n\t\t\t\tif (arg && arg.$mid === MarshalledId.TimelineActionContext) {\n\t\t\t\t\tif (this._providers.get(arg.source) && extension && isProposedApiEnabled(extension, 'timeline')) {\n\t\t\t\t\t\tconst uri = arg.uri === undefined ? undefined : URI.revive(arg.uri);\n\t\t\t\t\t\treturn this._itemsBySourceAndUriMap.get(arg.source)?.get(getUriKey(uri))?.get(arg.handle);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn arg;\n\t\t\t}\n\t\t});\n\t}\n\n\tasync $getTimeline(id: string, uri: UriComponents, options: vscode.TimelineOptions, token: vscode.CancellationToken): Promise<Timeline | undefined> {\n\t\tconst item = this._providers.get(id);\n\t\treturn item?.provider.provideTimeline(URI.revive(uri), options, token);\n\t}\n\n\tregisterTimelineProvider(scheme: string | string[], provider: vscode.TimelineProvider, extensionId: ExtensionIdentifier, commandConverter: CommandsConverter): IDisposable {\n\t\tconst timelineDisposables = new DisposableStore();\n\n\t\tconst convertTimelineItem = this.convertTimelineItem(provider.id, commandConverter, timelineDisposables).bind(this);\n\n\t\tlet disposable: IDisposable | undefined;\n\t\tif (provider.onDidChange) {\n\t\t\tdisposable = provider.onDidChange(e => this._proxy.$emitTimelineChangeEvent({ uri: undefined, reset: true, ...e, id: provider.id }), this);\n\t\t}\n\n\t\tconst itemsBySourceAndUriMap = this._itemsBySourceAndUriMap;\n\t\treturn this.registerTimelineProviderCore({\n\t\t\t...provider,\n\t\t\tscheme: scheme,\n\t\t\tonDidChange: undefined,\n\t\t\tasync provideTimeline(uri: URI, options: TimelineOptions, token: CancellationToken) {\n\t\t\t\tif (options?.resetCache) {\n\t\t\t\t\ttimelineDisposables.clear();\n\n\t\t\t\t\t// For now, only allow the caching of a single Uri\n\t\t\t\t\t// itemsBySourceAndUriMap.get(provider.id)?.get(getUriKey(uri))?.clear();\n\t\t\t\t\titemsBySourceAndUriMap.get(provider.id)?.clear();\n\t\t\t\t}\n\n\t\t\t\tconst result = await provider.provideTimeline(uri, options, token);\n\t\t\t\tif (result === undefined || result === null) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\n\t\t\t\t// TODO: Should we bother converting all the data if we aren't caching? Meaning it is being requested by an extension?\n\n\t\t\t\tconst convertItem = convertTimelineItem(uri, options);\n\t\t\t\treturn {\n\t\t\t\t\t...result,\n\t\t\t\t\tsource: provider.id,\n\t\t\t\t\titems: result.items.map(convertItem)\n\t\t\t\t};\n\t\t\t},\n\t\t\tdispose() {\n\t\t\t\tfor (const sourceMap of itemsBySourceAndUriMap.values()) {\n\t\t\t\t\tsourceMap.get(provider.id)?.clear();\n\t\t\t\t}\n\n\t\t\t\tdisposable?.dispose();\n\t\t\t\ttimelineDisposables.dispose();\n\t\t\t}\n\t\t}, extensionId);\n\t}\n\n\tprivate convertTimelineItem(source: string, commandConverter: CommandsConverter, disposables: DisposableStore) {\n\t\treturn (uri: URI, options?: TimelineOptions) => {\n\t\t\tlet items: Map<string, vscode.TimelineItem> | undefined;\n\t\t\tif (options?.cacheResults) {\n\t\t\t\tlet itemsByUri = this._itemsBySourceAndUriMap.get(source);\n\t\t\t\tif (itemsByUri === undefined) {\n\t\t\t\t\titemsByUri = new Map();\n\t\t\t\t\tthis._itemsBySourceAndUriMap.set(source, itemsByUri);\n\t\t\t\t}\n\n\t\t\t\tconst uriKey = getUriKey(uri);\n\t\t\t\titems = itemsByUri.get(uriKey);\n\t\t\t\tif (items === undefined) {\n\t\t\t\t\titems = new Map();\n\t\t\t\t\titemsByUri.set(uriKey, items);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn (item: vscode.TimelineItem): TimelineItem => {\n\t\t\t\tconst { iconPath, ...props } = item;\n\n\t\t\t\tconst handle = `${source}|${item.id ?? item.timestamp}`;\n\t\t\t\titems?.set(handle, item);\n\n\t\t\t\tlet icon;\n\t\t\t\tlet iconDark;\n\t\t\t\tlet themeIcon;\n\t\t\t\tif (item.iconPath) {\n\t\t\t\t\tif (iconPath instanceof ThemeIcon) {\n\t\t\t\t\t\tthemeIcon = { id: iconPath.id, color: iconPath.color };\n\t\t\t\t\t}\n\t\t\t\t\telse if (URI.isUri(iconPath)) {\n\t\t\t\t\t\ticon = iconPath;\n\t\t\t\t\t\ticonDark = iconPath;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t({ light: icon, dark: iconDark } = iconPath as { light: URI; dark: URI });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlet tooltip;\n\t\t\t\tif (MarkdownStringType.isMarkdownString(props.tooltip)) {\n\t\t\t\t\ttooltip = MarkdownString.from(props.tooltip);\n\t\t\t\t}\n\t\t\t\telse if (isString(props.tooltip)) {\n\t\t\t\t\ttooltip = props.tooltip;\n\t\t\t\t}\n\t\t\t\t// TODO @jkearl, remove once migration complete.\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\telse if (MarkdownStringType.isMarkdownString((props as any).detail)) {\n\t\t\t\t\tconsole.warn('Using deprecated TimelineItem.detail, migrate to TimelineItem.tooltip');\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\ttooltip = MarkdownString.from((props as any).detail);\n\t\t\t\t}\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\telse if (isString((props as any).detail)) {\n\t\t\t\t\tconsole.warn('Using deprecated TimelineItem.detail, migrate to TimelineItem.tooltip');\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\ttooltip = (props as any).detail;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...props,\n\t\t\t\t\tid: props.id ?? undefined,\n\t\t\t\t\thandle: handle,\n\t\t\t\t\tsource: source,\n\t\t\t\t\tcommand: item.command ? commandConverter.toInternal(item.command, disposables) : undefined,\n\t\t\t\t\ticon: icon,\n\t\t\t\t\ticonDark: iconDark,\n\t\t\t\t\tthemeIcon: themeIcon,\n\t\t\t\t\ttooltip,\n\t\t\t\t\taccessibilityInformation: item.accessibilityInformation\n\t\t\t\t};\n\t\t\t};\n\t\t};\n\t}\n\n\tprivate registerTimelineProviderCore(provider: TimelineProvider, extension: ExtensionIdentifier): IDisposable {\n\t\t// console.log(`ExtHostTimeline#registerTimelineProvider: id=${provider.id}`);\n\n\t\tconst existing = this._providers.get(provider.id);\n\t\tif (existing) {\n\t\t\tthrow new Error(`Timeline Provider ${provider.id} already exists.`);\n\t\t}\n\n\t\tthis._proxy.$registerTimelineProvider({\n\t\t\tid: provider.id,\n\t\t\tlabel: provider.label,\n\t\t\tscheme: provider.scheme\n\t\t});\n\t\tthis._providers.set(provider.id, { provider, extension });\n\n\t\treturn toDisposable(() => {\n\t\t\tfor (const sourceMap of this._itemsBySourceAndUriMap.values()) {\n\t\t\t\tsourceMap.get(provider.id)?.clear();\n\t\t\t}\n\n\t\t\tthis._providers.delete(provider.id);\n\t\t\tthis._proxy.$unregisterTimelineProvider(provider.id);\n\t\t\tprovider.dispose();\n\t\t});\n\t}\n}\n\nfunction getUriKey(uri: URI | undefined): string | undefined {\n\treturn uri?.toString();\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as vscode from 'vscode';\nimport { UriComponents, URI } from '../../../base/common/uri.js';\nimport { createDecorator } from '../../../platform/instantiation/common/instantiation.js';\nimport { ExtHostTimelineShape, MainThreadTimelineShape, IMainContext, MainContext } from './extHost.protocol.js';\nimport { Timeline, TimelineItem, TimelineOptions, TimelineProvider } from '../../contrib/timeline/common/timeline.js';\nimport { IDisposable, toDisposable, DisposableStore } from '../../../base/common/lifecycle.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { CommandsConverter, ExtHostCommands } from './extHostCommands.js';\nimport { ThemeIcon, MarkdownString as MarkdownStringType } from './extHostTypes.js';\nimport { MarkdownString } from './extHostTypeConverters.js';\nimport { ExtensionIdentifier } from '../../../platform/extensions/common/extensions.js';\nimport { MarshalledId } from '../../../base/common/marshallingIds.js';\nimport { isString } from '../../../base/common/types.js';\nimport { isProposedApiEnabled } from '../../services/extensions/common/extensions.js';\n\nexport interface IExtHostTimeline extends ExtHostTimelineShape {\n\treadonly _serviceBrand: undefined;\n\t$getTimeline(id: string, uri: UriComponents, options: vscode.TimelineOptions, token: vscode.CancellationToken): Promise<Timeline | undefined>;\n}\n\nexport const IExtHostTimeline = createDecorator<IExtHostTimeline>('IExtHostTimeline');\n\nexport class ExtHostTimeline implements IExtHostTimeline {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate _proxy: MainThreadTimelineShape;\n\n\tprivate _providers = new Map<string, { provider: TimelineProvider; extension: ExtensionIdentifier }>();\n\n\tprivate _itemsBySourceAndUriMap = new Map<string, Map<string | undefined, Map<string, vscode.TimelineItem>>>();\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tcommands: ExtHostCommands,\n\t) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadTimeline);\n\n\t\tcommands.registerArgumentProcessor({\n\t\t\tprocessArgument: (arg, extension) => {\n\t\t\t\tif (arg && arg.$mid === MarshalledId.TimelineActionContext) {\n\t\t\t\t\tif (this._providers.get(arg.source) && extension && isProposedApiEnabled(extension, 'timeline')) {\n\t\t\t\t\t\tconst uri = arg.uri === undefined ? undefined : URI.revive(arg.uri);\n\t\t\t\t\t\treturn this._itemsBySourceAndUriMap.get(arg.source)?.get(getUriKey(uri))?.get(arg.handle);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn arg;\n\t\t\t}\n\t\t});\n\t}\n\n\tasync $getTimeline(id: string, uri: UriComponents, options: vscode.TimelineOptions, token: vscode.CancellationToken): Promise<Timeline | undefined> {\n\t\tconst item = this._providers.get(id);\n\t\treturn item?.provider.provideTimeline(URI.revive(uri), options, token);\n\t}\n\n\tregisterTimelineProvider(scheme: string | string[], provider: vscode.TimelineProvider, extensionId: ExtensionIdentifier, commandConverter: CommandsConverter): IDisposable {\n\t\tconst timelineDisposables = new DisposableStore();\n\n\t\tconst convertTimelineItem = this.convertTimelineItem(provider.id, commandConverter, timelineDisposables).bind(this);\n\n\t\tlet disposable: IDisposable | undefined;\n\t\tif (provider.onDidChange) {\n\t\t\tdisposable = provider.onDidChange(e => this._proxy.$emitTimelineChangeEvent({ uri: undefined, reset: true, ...e, id: provider.id }), this);\n\t\t}\n\n\t\tconst itemsBySourceAndUriMap = this._itemsBySourceAndUriMap;\n\t\treturn this.registerTimelineProviderCore({\n\t\t\t...provider,\n\t\t\tscheme: scheme,\n\t\t\tonDidChange: undefined,\n\t\t\tasync provideTimeline(uri: URI, options: TimelineOptions, token: CancellationToken) {\n\t\t\t\tif (options?.resetCache) {\n\t\t\t\t\ttimelineDisposables.clear();\n\n\t\t\t\t\t// For now, only allow the caching of a single Uri\n\t\t\t\t\t// itemsBySourceAndUriMap.get(provider.id)?.get(getUriKey(uri))?.clear();\n\t\t\t\t\titemsBySourceAndUriMap.get(provider.id)?.clear();\n\t\t\t\t}\n\n\t\t\t\tconst result = await provider.provideTimeline(uri, options, token);\n\t\t\t\tif (result === undefined || result === null) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\n\t\t\t\t// TODO: Should we bother converting all the data if we aren't caching? Meaning it is being requested by an extension?\n\n\t\t\t\tconst convertItem = convertTimelineItem(uri, options);\n\t\t\t\treturn {\n\t\t\t\t\t...result,\n\t\t\t\t\tsource: provider.id,\n\t\t\t\t\titems: result.items.map(convertItem)\n\t\t\t\t};\n\t\t\t},\n\t\t\tdispose() {\n\t\t\t\tfor (const sourceMap of itemsBySourceAndUriMap.values()) {\n\t\t\t\t\tsourceMap.get(provider.id)?.clear();\n\t\t\t\t}\n\n\t\t\t\tdisposable?.dispose();\n\t\t\t\ttimelineDisposables.dispose();\n\t\t\t}\n\t\t}, extensionId);\n\t}\n\n\tprivate convertTimelineItem(source: string, commandConverter: CommandsConverter, disposables: DisposableStore) {\n\t\treturn (uri: URI, options?: TimelineOptions) => {\n\t\t\tlet items: Map<string, vscode.TimelineItem> | undefined;\n\t\t\tif (options?.cacheResults) {\n\t\t\t\tlet itemsByUri = this._itemsBySourceAndUriMap.get(source);\n\t\t\t\tif (itemsByUri === undefined) {\n\t\t\t\t\titemsByUri = new Map();\n\t\t\t\t\tthis._itemsBySourceAndUriMap.set(source, itemsByUri);\n\t\t\t\t}\n\n\t\t\t\tconst uriKey = getUriKey(uri);\n\t\t\t\titems = itemsByUri.get(uriKey);\n\t\t\t\tif (items === undefined) {\n\t\t\t\t\titems = new Map();\n\t\t\t\t\titemsByUri.set(uriKey, items);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn (item: vscode.TimelineItem): TimelineItem => {\n\t\t\t\tconst { iconPath, ...props } = item;\n\n\t\t\t\tconst handle = `${source}|${item.id ?? item.timestamp}`;\n\t\t\t\titems?.set(handle, item);\n\n\t\t\t\tlet icon;\n\t\t\t\tlet iconDark;\n\t\t\t\tlet themeIcon;\n\t\t\t\tif (item.iconPath) {\n\t\t\t\t\tif (iconPath instanceof ThemeIcon) {\n\t\t\t\t\t\tthemeIcon = { id: iconPath.id, color: iconPath.color };\n\t\t\t\t\t}\n\t\t\t\t\telse if (URI.isUri(iconPath)) {\n\t\t\t\t\t\ticon = iconPath;\n\t\t\t\t\t\ticonDark = iconPath;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t({ light: icon, dark: iconDark } = iconPath as { light: URI; dark: URI });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlet tooltip;\n\t\t\t\tif (MarkdownStringType.isMarkdownString(props.tooltip)) {\n\t\t\t\t\ttooltip = MarkdownString.from(props.tooltip);\n\t\t\t\t}\n\t\t\t\telse if (isString(props.tooltip)) {\n\t\t\t\t\ttooltip = props.tooltip;\n\t\t\t\t}\n\t\t\t\t// TODO @jkearl, remove once migration complete.\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\telse if (MarkdownStringType.isMarkdownString((props as any).detail)) {\n\t\t\t\t\tconsole.warn('Using deprecated TimelineItem.detail, migrate to TimelineItem.tooltip');\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\ttooltip = MarkdownString.from((props as any).detail);\n\t\t\t\t}\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\telse if (isString((props as any).detail)) {\n\t\t\t\t\tconsole.warn('Using deprecated TimelineItem.detail, migrate to TimelineItem.tooltip');\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\ttooltip = (props as any).detail;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\t...props,\n\t\t\t\t\tid: props.id ?? undefined,\n\t\t\t\t\thandle: handle,\n\t\t\t\t\tsource: source,\n\t\t\t\t\tcommand: item.command ? commandConverter.toInternal(item.command, disposables) : undefined,\n\t\t\t\t\ticon: icon,\n\t\t\t\t\ticonDark: iconDark,\n\t\t\t\t\tthemeIcon: themeIcon,\n\t\t\t\t\ttooltip,\n\t\t\t\t\taccessibilityInformation: item.accessibilityInformation\n\t\t\t\t};\n\t\t\t};\n\t\t};\n\t}\n\n\tprivate registerTimelineProviderCore(provider: TimelineProvider, extension: ExtensionIdentifier): IDisposable {\n\t\t// console.log(`ExtHostTimeline#registerTimelineProvider: id=${provider.id}`);\n\n\t\tconst existing = this._providers.get(provider.id);\n\t\tif (existing) {\n\t\t\tthrow new Error(`Timeline Provider ${provider.id} already exists.`);\n\t\t}\n\n\t\tthis._proxy.$registerTimelineProvider({\n\t\t\tid: provider.id,\n\t\t\tlabel: provider.label,\n\t\t\tscheme: provider.scheme\n\t\t});\n\t\tthis._providers.set(provider.id, { provider, extension });\n\n\t\treturn toDisposable(() => {\n\t\t\tfor (const sourceMap of this._itemsBySourceAndUriMap.values()) {\n\t\t\t\tsourceMap.get(provider.id)?.clear();\n\t\t\t}\n\n\t\t\tthis._providers.delete(provider.id);\n\t\t\tthis._proxy.$unregisterTimelineProvider(provider.id);\n\t\t\tprovider.dispose();\n\t\t});\n\t}\n}\n\nfunction getUriKey(uri: URI | undefined): string | undefined {\n\treturn uri?.toString();\n}\n"]}