{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostDocumentSaveParticipant.ts","vs/workbench/api/common/extHostDocumentSaveParticipant.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAGhG,OAAO,EAAE,GAAG,EAAiB,MAAM,6BAA6B,CAAC;AACjE,OAAO,EAAE,YAAY,EAAE,MAAM,gCAAgC,CAAC;AAE9D,OAAO,EAAE,QAAQ,EAAE,MAAM,mBAAmB,CAAC;AAC7C,OAAO,EAAE,KAAK,EAAE,sBAAsB,EAAE,SAAS,EAAE,MAAM,4BAA4B,CAAC;AAItF,OAAO,EAAE,UAAU,EAAE,MAAM,oCAAoC,CAAC;AAGhE,OAAO,EAAE,6BAA6B,EAAE,MAAM,qDAAqD,CAAC;AAIpG,MAAM,OAAO,8BAA8B;IAK1C,YACkB,WAAwB,EACxB,UAA4B,EAC5B,oBAA8C,EAC9C,cAAmD,EAAE,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,EAAE;QAH/E,gBAAW,GAAX,WAAW,CAAa;QACxB,eAAU,GAAV,UAAU,CAAkB;QAC5B,yBAAoB,GAApB,oBAAoB,CAA0B;QAC9C,gBAAW,GAAX,WAAW,CAAoE;QAPhF,eAAU,GAAG,IAAI,UAAU,EAAY,CAAC;QACxC,kBAAa,GAAG,IAAI,OAAO,EAAoB,CAAC;QAQhE,EAAE;IACH,CAAC;IAED,OAAO;QACN,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE,CAAC;IACzB,CAAC;IAED,8BAA8B,CAAC,SAAgC;QAC9D,OAAO,CAAC,QAAQ,EAAE,OAAO,EAAE,WAAW,EAAE,EAAE;YACzC,MAAM,MAAM,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,QAAQ,EAAE,OAAO,EAAE,SAAS,CAAC,CAAC,CAAC;YACpE,MAAM,MAAM,GAAG,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC;YACnC,IAAI,KAAK,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE,CAAC;gBAChC,WAAW,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC1B,CAAC;YACD,OAAO,MAAM,CAAC;QACf,CAAC,CAAC;IACH,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,IAAmB,EAAE,MAAkB;QAC/D,MAAM,QAAQ,GAAG,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAElC,IAAI,UAAU,GAAG,KAAK,CAAC;QACvB,MAAM,gBAAgB,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,UAAU,GAAG,IAAI,EAAE,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;QAEvF,MAAM,OAAO,GAAc,EAAE,CAAC;QAC9B,IAAI,CAAC;YACJ,KAAK,MAAM,QAAQ,IAAI,CAAC,GAAG,IAAI,CAAC,UAAU,CAAC,EAAE,CAAC,CAAC,2CAA2C;gBACzF,IAAI,UAAU,EAAE,CAAC;oBAChB,8BAA8B;oBAC9B,MAAM;gBACP,CAAC;gBACD,MAAM,QAAQ,GAAG,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;gBAEvD,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,sCAAsC,CAAC,QAAQ,EAAE,EAAE,QAAQ,EAAE,MAAM,EAAE,sBAAsB,CAAC,EAAE,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;gBACrI,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YACvB,CAAC;QACF,CAAC;gBAAS,CAAC;YACV,YAAY,CAAC,gBAAgB,CAAC,CAAC;QAChC,CAAC;QACD,OAAO,OAAO,CAAC;IAChB,CAAC;IAEO,sCAAsC,CAAC,CAAC,QAAQ,EAAE,OAAO,EAAE,SAAS,CAAW,EAAE,SAAwE;QAChK,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAChD,IAAI,OAAO,MAAM,KAAK,QAAQ,IAAI,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE,CAAC;YACpE,wBAAwB;YACxB,OAAO,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QAC/B,CAAC;QAED,OAAO,IAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,QAAQ,EAAE,OAAO,EAAE,SAAS,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE;YACjF,oCAAoC;YACpC,OAAO,IAAI,CAAC;QAEb,CAAC,EAAE,GAAG,CAAC,EAAE;YAER,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,mDAAmD,SAAS,CAAC,UAAU,CAAC,KAAK,eAAe,CAAC,CAAC;YACrH,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAE5B,IAAI,CAAC,CAAC,GAAG,YAAY,KAAK,CAAC,IAAY,GAAI,CAAC,OAAO,KAAK,kBAAkB,EAAE,CAAC;gBAC5E,MAAM,MAAM,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;gBAChD,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;gBAE3D,IAAI,OAAO,MAAM,KAAK,QAAQ,IAAI,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE,CAAC;oBACpE,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,mDAAmD,SAAS,CAAC,UAAU,CAAC,KAAK,yDAAyD,CAAC,CAAC;gBAC/J,CAAC;YACF,CAAC;YACD,OAAO,KAAK,CAAC;QACd,CAAC,CAAC,CAAC;IACJ,CAAC;IAEO,kBAAkB,CAAC,SAAgC,EAAE,QAAkB,EAAE,OAAgB,EAAE,SAAwE;QAE1K,MAAM,QAAQ,GAAiC,EAAE,CAAC;QAElD,MAAM,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACtB,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG,SAAS,CAAC;QACvC,MAAM,EAAE,OAAO,EAAE,GAAG,QAAQ,CAAC;QAE7B,MAAM,KAAK,GAAG,MAAM,CAAC,MAAM,CAAmC;YAC7D,QAAQ;YACR,MAAM;YACN,8DAA8D;YAC9D,SAAS,CAAC,CAAmC;gBAC5C,IAAI,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,CAAC;oBAC/B,MAAM,YAAY,CAAC,mCAAmC,CAAC,CAAC;gBACzD,CAAC;gBACD,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;YACnC,CAAC;SACD,CAAC,CAAC;QAEH,IAAI,CAAC;YACJ,aAAa;YACb,QAAQ,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC,KAAK,CAAC,CAAC,CAAC;QAClC,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACd,OAAO,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAC5B,CAAC;QAED,mCAAmC;QACnC,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;QAExB,OAAO,IAAI,OAAO,CAAsB,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YAC3D,sDAAsD;YACtD,MAAM,MAAM,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,SAAS,CAAC,CAAC,EAAE,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;YAExF,OAAO,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;gBACzC,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,mDAAmD,SAAS,CAAC,UAAU,CAAC,KAAK,oBAAoB,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,CAAC;gBAC/I,YAAY,CAAC,MAAM,CAAC,CAAC;gBACrB,OAAO,CAAC,KAAK,CAAC,CAAC;YAChB,CAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE;gBACd,YAAY,CAAC,MAAM,CAAC,CAAC;gBACrB,MAAM,CAAC,GAAG,CAAC,CAAC;YACb,CAAC,CAAC,CAAC;QAEJ,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;YAChB,MAAM,GAAG,GAAsB,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC;YAC7C,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;gBAC5B,IAAI,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,IAAwB,KAAM,CAAC,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,YAAY,QAAQ,CAAC,EAAE,CAAC;oBAC1F,KAAK,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,KAAK,EAAE,CAAC;wBAChD,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC;4BACd,QAAQ,EAAE,QAAQ,CAAC,GAAG;4BACtB,SAAS,EAAE,SAAS;4BACpB,QAAQ,EAAE;gCACT,KAAK,EAAE,KAAK,IAAI,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC;gCACjC,IAAI,EAAE,OAAO;gCACb,GAAG,EAAE,MAAM,IAAI,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC;6BACrC;yBACD,CAAC,CAAC;oBACJ,CAAC;gBACF,CAAC;YACF,CAAC;YAED,qCAAqC;YACrC,wCAAwC;YACxC,IAAI,GAAG,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBAC5B,OAAO,SAAS,CAAC;YAClB,CAAC;YAED,IAAI,OAAO,KAAK,QAAQ,CAAC,OAAO,EAAE,CAAC;gBAClC,OAAO,IAAI,CAAC,oBAAoB,CAAC,sBAAsB,CAAC,IAAI,6BAA6B,CAAC,GAAG,CAAC,CAAC,CAAC;YACjG,CAAC;YAED,OAAO,OAAO,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,kBAAkB,CAAC,CAAC,CAAC;QACtD,CAAC,CAAC,CAAC;IACJ,CAAC;CACD","file":"extHostDocumentSaveParticipant.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from '../../../base/common/event.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { illegalState } from '../../../base/common/errors.js';\nimport { ExtHostDocumentSaveParticipantShape, IWorkspaceEditDto, MainThreadBulkEditsShape } from './extHost.protocol.js';\nimport { TextEdit } from './extHostTypes.js';\nimport { Range, TextDocumentSaveReason, EndOfLine } from './extHostTypeConverters.js';\nimport { ExtHostDocuments } from './extHostDocuments.js';\nimport { SaveReason } from '../../common/editor.js';\nimport type * as vscode from 'vscode';\nimport { LinkedList } from '../../../base/common/linkedList.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\n\ntype Listener = [Function, unknown, IExtensionDescription];\n\nexport class ExtHostDocumentSaveParticipant implements ExtHostDocumentSaveParticipantShape {\n\n\tprivate readonly _callbacks = new LinkedList<Listener>();\n\tprivate readonly _badListeners = new WeakMap<Function, number>();\n\n\tconstructor(\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _documents: ExtHostDocuments,\n\t\tprivate readonly _mainThreadBulkEdits: MainThreadBulkEditsShape,\n\t\tprivate readonly _thresholds: { timeout: number; errors: number } = { timeout: 1500, errors: 3 }\n\t) {\n\t\t//\n\t}\n\n\tdispose(): void {\n\t\tthis._callbacks.clear();\n\t}\n\n\tgetOnWillSaveTextDocumentEvent(extension: IExtensionDescription): Event<vscode.TextDocumentWillSaveEvent> {\n\t\treturn (listener, thisArg, disposables) => {\n\t\t\tconst remove = this._callbacks.push([listener, thisArg, extension]);\n\t\t\tconst result = { dispose: remove };\n\t\t\tif (Array.isArray(disposables)) {\n\t\t\t\tdisposables.push(result);\n\t\t\t}\n\t\t\treturn result;\n\t\t};\n\t}\n\n\tasync $participateInSave(data: UriComponents, reason: SaveReason): Promise<boolean[]> {\n\t\tconst resource = URI.revive(data);\n\n\t\tlet didTimeout = false;\n\t\tconst didTimeoutHandle = setTimeout(() => didTimeout = true, this._thresholds.timeout);\n\n\t\tconst results: boolean[] = [];\n\t\ttry {\n\t\t\tfor (const listener of [...this._callbacks]) { // copy to prevent concurrent modifications\n\t\t\t\tif (didTimeout) {\n\t\t\t\t\t// timeout - no more listeners\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tconst document = this._documents.getDocument(resource);\n\n\t\t\t\tconst success = await this._deliverEventAsyncAndBlameBadListeners(listener, { document, reason: TextDocumentSaveReason.to(reason) });\n\t\t\t\tresults.push(success);\n\t\t\t}\n\t\t} finally {\n\t\t\tclearTimeout(didTimeoutHandle);\n\t\t}\n\t\treturn results;\n\t}\n\n\tprivate _deliverEventAsyncAndBlameBadListeners([listener, thisArg, extension]: Listener, stubEvent: Pick<vscode.TextDocumentWillSaveEvent, 'document' | 'reason'>): Promise<boolean> {\n\t\tconst errors = this._badListeners.get(listener);\n\t\tif (typeof errors === 'number' && errors > this._thresholds.errors) {\n\t\t\t// bad listener - ignore\n\t\t\treturn Promise.resolve(false);\n\t\t}\n\n\t\treturn this._deliverEventAsync(extension, listener, thisArg, stubEvent).then(() => {\n\t\t\t// don't send result across the wire\n\t\t\treturn true;\n\n\t\t}, err => {\n\n\t\t\tthis._logService.error(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' threw ERROR`);\n\t\t\tthis._logService.error(err);\n\n\t\t\tif (!(err instanceof Error) || (<Error>err).message !== 'concurrent_edits') {\n\t\t\t\tconst errors = this._badListeners.get(listener);\n\t\t\t\tthis._badListeners.set(listener, !errors ? 1 : errors + 1);\n\n\t\t\t\tif (typeof errors === 'number' && errors > this._thresholds.errors) {\n\t\t\t\t\tthis._logService.info(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' will now be IGNORED because of timeouts and/or errors`);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tprivate _deliverEventAsync(extension: IExtensionDescription, listener: Function, thisArg: unknown, stubEvent: Pick<vscode.TextDocumentWillSaveEvent, 'document' | 'reason'>): Promise<boolean | undefined> {\n\n\t\tconst promises: Promise<vscode.TextEdit[]>[] = [];\n\n\t\tconst t1 = Date.now();\n\t\tconst { document, reason } = stubEvent;\n\t\tconst { version } = document;\n\n\t\tconst event = Object.freeze<vscode.TextDocumentWillSaveEvent>({\n\t\t\tdocument,\n\t\t\treason,\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\twaitUntil(p: Promise<any | vscode.TextEdit[]>) {\n\t\t\t\tif (Object.isFrozen(promises)) {\n\t\t\t\t\tthrow illegalState('waitUntil can not be called async');\n\t\t\t\t}\n\t\t\t\tpromises.push(Promise.resolve(p));\n\t\t\t}\n\t\t});\n\n\t\ttry {\n\t\t\t// fire event\n\t\t\tlistener.apply(thisArg, [event]);\n\t\t} catch (err) {\n\t\t\treturn Promise.reject(err);\n\t\t}\n\n\t\t// freeze promises after event call\n\t\tObject.freeze(promises);\n\n\t\treturn new Promise<vscode.TextEdit[][]>((resolve, reject) => {\n\t\t\t// join on all listener promises, reject after timeout\n\t\t\tconst handle = setTimeout(() => reject(new Error('timeout')), this._thresholds.timeout);\n\n\t\t\treturn Promise.all(promises).then(edits => {\n\t\t\t\tthis._logService.debug(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' finished after ${(Date.now() - t1)}ms`);\n\t\t\t\tclearTimeout(handle);\n\t\t\t\tresolve(edits);\n\t\t\t}).catch(err => {\n\t\t\t\tclearTimeout(handle);\n\t\t\t\treject(err);\n\t\t\t});\n\n\t\t}).then(values => {\n\t\t\tconst dto: IWorkspaceEditDto = { edits: [] };\n\t\t\tfor (const value of values) {\n\t\t\t\tif (Array.isArray(value) && (<vscode.TextEdit[]>value).every(e => e instanceof TextEdit)) {\n\t\t\t\t\tfor (const { newText, newEol, range } of value) {\n\t\t\t\t\t\tdto.edits.push({\n\t\t\t\t\t\t\tresource: document.uri,\n\t\t\t\t\t\t\tversionId: undefined,\n\t\t\t\t\t\t\ttextEdit: {\n\t\t\t\t\t\t\t\trange: range && Range.from(range),\n\t\t\t\t\t\t\t\ttext: newText,\n\t\t\t\t\t\t\t\teol: newEol && EndOfLine.from(newEol),\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// apply edits if any and if document\n\t\t\t// didn't change somehow in the meantime\n\t\t\tif (dto.edits.length === 0) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tif (version === document.version) {\n\t\t\t\treturn this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(new SerializableObjectWithBuffers(dto));\n\t\t\t}\n\n\t\t\treturn Promise.reject(new Error('concurrent_edits'));\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from '../../../base/common/event.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { illegalState } from '../../../base/common/errors.js';\nimport { ExtHostDocumentSaveParticipantShape, IWorkspaceEditDto, MainThreadBulkEditsShape } from './extHost.protocol.js';\nimport { TextEdit } from './extHostTypes.js';\nimport { Range, TextDocumentSaveReason, EndOfLine } from './extHostTypeConverters.js';\nimport { ExtHostDocuments } from './extHostDocuments.js';\nimport { SaveReason } from '../../common/editor.js';\nimport type * as vscode from 'vscode';\nimport { LinkedList } from '../../../base/common/linkedList.js';\nimport { ILogService } from '../../../platform/log/common/log.js';\nimport { IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { SerializableObjectWithBuffers } from '../../services/extensions/common/proxyIdentifier.js';\n\ntype Listener = [Function, unknown, IExtensionDescription];\n\nexport class ExtHostDocumentSaveParticipant implements ExtHostDocumentSaveParticipantShape {\n\n\tprivate readonly _callbacks = new LinkedList<Listener>();\n\tprivate readonly _badListeners = new WeakMap<Function, number>();\n\n\tconstructor(\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _documents: ExtHostDocuments,\n\t\tprivate readonly _mainThreadBulkEdits: MainThreadBulkEditsShape,\n\t\tprivate readonly _thresholds: { timeout: number; errors: number } = { timeout: 1500, errors: 3 }\n\t) {\n\t\t//\n\t}\n\n\tdispose(): void {\n\t\tthis._callbacks.clear();\n\t}\n\n\tgetOnWillSaveTextDocumentEvent(extension: IExtensionDescription): Event<vscode.TextDocumentWillSaveEvent> {\n\t\treturn (listener, thisArg, disposables) => {\n\t\t\tconst remove = this._callbacks.push([listener, thisArg, extension]);\n\t\t\tconst result = { dispose: remove };\n\t\t\tif (Array.isArray(disposables)) {\n\t\t\t\tdisposables.push(result);\n\t\t\t}\n\t\t\treturn result;\n\t\t};\n\t}\n\n\tasync $participateInSave(data: UriComponents, reason: SaveReason): Promise<boolean[]> {\n\t\tconst resource = URI.revive(data);\n\n\t\tlet didTimeout = false;\n\t\tconst didTimeoutHandle = setTimeout(() => didTimeout = true, this._thresholds.timeout);\n\n\t\tconst results: boolean[] = [];\n\t\ttry {\n\t\t\tfor (const listener of [...this._callbacks]) { // copy to prevent concurrent modifications\n\t\t\t\tif (didTimeout) {\n\t\t\t\t\t// timeout - no more listeners\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tconst document = this._documents.getDocument(resource);\n\n\t\t\t\tconst success = await this._deliverEventAsyncAndBlameBadListeners(listener, { document, reason: TextDocumentSaveReason.to(reason) });\n\t\t\t\tresults.push(success);\n\t\t\t}\n\t\t} finally {\n\t\t\tclearTimeout(didTimeoutHandle);\n\t\t}\n\t\treturn results;\n\t}\n\n\tprivate _deliverEventAsyncAndBlameBadListeners([listener, thisArg, extension]: Listener, stubEvent: Pick<vscode.TextDocumentWillSaveEvent, 'document' | 'reason'>): Promise<boolean> {\n\t\tconst errors = this._badListeners.get(listener);\n\t\tif (typeof errors === 'number' && errors > this._thresholds.errors) {\n\t\t\t// bad listener - ignore\n\t\t\treturn Promise.resolve(false);\n\t\t}\n\n\t\treturn this._deliverEventAsync(extension, listener, thisArg, stubEvent).then(() => {\n\t\t\t// don't send result across the wire\n\t\t\treturn true;\n\n\t\t}, err => {\n\n\t\t\tthis._logService.error(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' threw ERROR`);\n\t\t\tthis._logService.error(err);\n\n\t\t\tif (!(err instanceof Error) || (<Error>err).message !== 'concurrent_edits') {\n\t\t\t\tconst errors = this._badListeners.get(listener);\n\t\t\t\tthis._badListeners.set(listener, !errors ? 1 : errors + 1);\n\n\t\t\t\tif (typeof errors === 'number' && errors > this._thresholds.errors) {\n\t\t\t\t\tthis._logService.info(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' will now be IGNORED because of timeouts and/or errors`);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t}\n\n\tprivate _deliverEventAsync(extension: IExtensionDescription, listener: Function, thisArg: unknown, stubEvent: Pick<vscode.TextDocumentWillSaveEvent, 'document' | 'reason'>): Promise<boolean | undefined> {\n\n\t\tconst promises: Promise<vscode.TextEdit[]>[] = [];\n\n\t\tconst t1 = Date.now();\n\t\tconst { document, reason } = stubEvent;\n\t\tconst { version } = document;\n\n\t\tconst event = Object.freeze<vscode.TextDocumentWillSaveEvent>({\n\t\t\tdocument,\n\t\t\treason,\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t\twaitUntil(p: Promise<any | vscode.TextEdit[]>) {\n\t\t\t\tif (Object.isFrozen(promises)) {\n\t\t\t\t\tthrow illegalState('waitUntil can not be called async');\n\t\t\t\t}\n\t\t\t\tpromises.push(Promise.resolve(p));\n\t\t\t}\n\t\t});\n\n\t\ttry {\n\t\t\t// fire event\n\t\t\tlistener.apply(thisArg, [event]);\n\t\t} catch (err) {\n\t\t\treturn Promise.reject(err);\n\t\t}\n\n\t\t// freeze promises after event call\n\t\tObject.freeze(promises);\n\n\t\treturn new Promise<vscode.TextEdit[][]>((resolve, reject) => {\n\t\t\t// join on all listener promises, reject after timeout\n\t\t\tconst handle = setTimeout(() => reject(new Error('timeout')), this._thresholds.timeout);\n\n\t\t\treturn Promise.all(promises).then(edits => {\n\t\t\t\tthis._logService.debug(`onWillSaveTextDocument-listener from extension '${extension.identifier.value}' finished after ${(Date.now() - t1)}ms`);\n\t\t\t\tclearTimeout(handle);\n\t\t\t\tresolve(edits);\n\t\t\t}).catch(err => {\n\t\t\t\tclearTimeout(handle);\n\t\t\t\treject(err);\n\t\t\t});\n\n\t\t}).then(values => {\n\t\t\tconst dto: IWorkspaceEditDto = { edits: [] };\n\t\t\tfor (const value of values) {\n\t\t\t\tif (Array.isArray(value) && (<vscode.TextEdit[]>value).every(e => e instanceof TextEdit)) {\n\t\t\t\t\tfor (const { newText, newEol, range } of value) {\n\t\t\t\t\t\tdto.edits.push({\n\t\t\t\t\t\t\tresource: document.uri,\n\t\t\t\t\t\t\tversionId: undefined,\n\t\t\t\t\t\t\ttextEdit: {\n\t\t\t\t\t\t\t\trange: range && Range.from(range),\n\t\t\t\t\t\t\t\ttext: newText,\n\t\t\t\t\t\t\t\teol: newEol && EndOfLine.from(newEol),\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// apply edits if any and if document\n\t\t\t// didn't change somehow in the meantime\n\t\t\tif (dto.edits.length === 0) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tif (version === document.version) {\n\t\t\t\treturn this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(new SerializableObjectWithBuffers(dto));\n\t\t\t}\n\n\t\t\treturn Promise.reject(new Error('concurrent_edits'));\n\t\t});\n\t}\n}\n"]}