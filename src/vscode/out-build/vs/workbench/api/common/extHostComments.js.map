{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/common/extHostComments.ts","vs/workbench/api/common/extHostComments.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;AAEhG,OAAO,EAAE,SAAS,EAAE,MAAM,+BAA+B,CAAC;AAE1D,OAAO,EAAE,QAAQ,EAAE,MAAM,oCAAoC,CAAC;AAC9D,OAAO,EAAE,OAAO,EAAE,MAAM,+BAA+B,CAAC;AACxD,OAAO,EAAE,eAAe,EAAE,iBAAiB,EAAE,MAAM,mCAAmC,CAAC;AAEvF,OAAO,EAAE,GAAG,EAAiB,MAAM,6BAA6B,CAAC;AAEjE,OAAO,KAAK,SAAS,MAAM,qCAAqC,CAAC;AACjE,OAAO,EAAE,sBAAsB,EAAyB,MAAM,mDAAmD,CAAC;AAElH,OAAO,KAAK,oBAAoB,MAAM,4BAA4B,CAAC;AACnE,OAAO,KAAK,KAAK,MAAM,mBAAmB,CAAC;AAE3C,OAAO,EAAsC,WAAW,EAAwC,MAAM,uBAAuB,CAAC;AAE9H,OAAO,EAAE,uBAAuB,EAAE,MAAM,gDAAgD,CAAC;AASzF,MAAM,UAAU,qBAAqB,CAAC,WAAyB,EAAE,QAAyB,EAAE,SAA2B;IACtH,MAAM,KAAK,GAAG,WAAW,CAAC,QAAQ,CAAC,WAAW,CAAC,kBAAkB,CAAC,CAAC;IAEnE,MAAM,mBAAmB;iBAET,eAAU,GAAG,CAAH,AAAI,CAAC;QAQ9B;YALQ,wBAAmB,GAAkD,IAAI,GAAG,EAA4C,CAAC;YAEzH,mCAA8B,GAAuD,IAAI,sBAAsB,EAA8B,CAAC;YAKrJ,QAAQ,CAAC,yBAAyB,CAAC;gBAClC,eAAe,EAAE,GAAG,CAAC,EAAE;oBACtB,IAAI,GAAG,IAAI,GAAG,CAAC,IAAI,2CAAmC,EAAE,CAAC;wBACxD,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;wBAEnE,IAAI,CAAC,iBAAiB,EAAE,CAAC;4BACxB,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,OAAO,iBAAiB,CAAC,KAAK,CAAC;oBAChC,CAAC;yBAAM,IAAI,GAAG,IAAI,GAAG,CAAC,IAAI,uCAA+B,EAAE,CAAC;wBAC3D,MAAM,uBAAuB,GAA4B,GAAG,CAAC;wBAC7D,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,uBAAuB,CAAC,oBAAoB,CAAC,CAAC;wBAErG,IAAI,CAAC,iBAAiB,EAAE,CAAC;4BACxB,OAAO,uBAAuB,CAAC;wBAChC,CAAC;wBAED,MAAM,aAAa,GAAG,iBAAiB,CAAC,gBAAgB,CAAC,uBAAuB,CAAC,mBAAmB,CAAC,CAAC;wBAEtG,IAAI,CAAC,aAAa,EAAE,CAAC;4BACpB,OAAO,uBAAuB,CAAC;wBAChC,CAAC;wBAED,OAAO,aAAa,CAAC,KAAK,CAAC;oBAC5B,CAAC;yBAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,4CAAoC,IAAI,GAAG,CAAC,IAAI,+CAAuC,CAAC,EAAE,CAAC;wBACrH,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC;wBAExF,IAAI,CAAC,iBAAiB,EAAE,CAAC;4BACxB,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,MAAM,aAAa,GAAG,iBAAiB,CAAC,gBAAgB,CAAC,GAAG,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;wBAEzF,IAAI,CAAC,aAAa,EAAE,CAAC;4BACpB,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,IAAI,GAAG,CAAC,IAAI,+CAAuC,EAAE,CAAC;4BACrD,OAAO,aAAa,CAAC,KAAK,CAAC;wBAC5B,CAAC;wBAED,OAAO;4BACN,MAAM,EAAE,aAAa,CAAC,KAAK;4BAC3B,IAAI,EAAE,GAAG,CAAC,IAAI;yBACd,CAAC;oBACH,CAAC;yBAAM,IAAI,GAAG,IAAI,GAAG,CAAC,IAAI,sCAA6B,EAAE,CAAC;wBACzD,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC;wBAExF,IAAI,CAAC,iBAAiB,EAAE,CAAC;4BACxB,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,MAAM,aAAa,GAAG,iBAAiB,CAAC,gBAAgB,CAAC,GAAG,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;wBAEzF,IAAI,CAAC,aAAa,EAAE,CAAC;4BACpB,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,MAAM,eAAe,GAAG,GAAG,CAAC,eAAe,CAAC;wBAE5C,MAAM,OAAO,GAAG,aAAa,CAAC,oBAAoB,CAAC,eAAe,CAAC,CAAC;wBAEpE,IAAI,CAAC,OAAO,EAAE,CAAC;4BACd,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,OAAO,OAAO,CAAC;oBAEhB,CAAC;yBAAM,IAAI,GAAG,IAAI,GAAG,CAAC,IAAI,4CAAmC,EAAE,CAAC;wBAC/D,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM,CAAC,oBAAoB,CAAC,CAAC;wBAExF,IAAI,CAAC,iBAAiB,EAAE,CAAC;4BACxB,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,MAAM,aAAa,GAAG,iBAAiB,CAAC,gBAAgB,CAAC,GAAG,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC;wBAEzF,IAAI,CAAC,aAAa,EAAE,CAAC;4BACpB,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,MAAM,IAAI,GAAW,GAAG,CAAC,IAAI,CAAC;wBAC9B,MAAM,eAAe,GAAG,GAAG,CAAC,eAAe,CAAC;wBAE5C,MAAM,OAAO,GAAG,aAAa,CAAC,oBAAoB,CAAC,eAAe,CAAC,CAAC;wBAEpE,IAAI,CAAC,OAAO,EAAE,CAAC;4BACd,OAAO,GAAG,CAAC;wBACZ,CAAC;wBAED,iFAAiF;wBACjF,IAAI,OAAO,OAAO,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;4BACtC,OAAO,CAAC,IAAI,GAAG,IAAI,CAAC;wBACrB,CAAC;6BAAM,CAAC;4BACP,OAAO,CAAC,IAAI,GAAG,IAAI,KAAK,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;wBAC/C,CAAC;wBACD,OAAO,OAAO,CAAC;oBAChB,CAAC;oBAED,OAAO,GAAG,CAAC;gBACZ,CAAC;aACD,CAAC,CAAC;QACJ,CAAC;QAED,uBAAuB,CAAC,SAAgC,EAAE,EAAU,EAAE,KAAa;YAClF,MAAM,MAAM,GAAG,mBAAmB,CAAC,UAAU,EAAE,CAAC;YAChD,MAAM,iBAAiB,GAAG,IAAI,wBAAwB,CAAC,SAAS,EAAE,MAAM,EAAE,EAAE,EAAE,KAAK,CAAC,CAAC;YACrF,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,iBAAiB,CAAC,MAAM,EAAE,iBAAiB,CAAC,CAAC;YAE1E,MAAM,kBAAkB,GAAG,IAAI,CAAC,8BAA8B,CAAC,GAAG,CAAC,SAAS,CAAC,UAAU,CAAC,IAAI,EAAE,CAAC;YAC/F,kBAAkB,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC;YAC3C,IAAI,CAAC,8BAA8B,CAAC,GAAG,CAAC,SAAS,CAAC,UAAU,EAAE,kBAAkB,CAAC,CAAC;YAElF,OAAO,iBAAiB,CAAC,KAAK,CAAC;QAChC,CAAC;QAED,KAAK,CAAC,4BAA4B,CAAC,uBAA+B,EAAE,aAA4B,EAAE,KAAyB,EAAE,QAAiB;YAC7I,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;YAEhF,IAAI,CAAC,iBAAiB,EAAE,CAAC;gBACxB,OAAO;YACR,CAAC;YAED,iBAAiB,CAAC,4BAA4B,CAAC,aAAa,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC;QAChF,CAAC;QAED,KAAK,CAAC,iBAAiB,CAAC,gBAAwB,EAAE,WAAuE;YACxH,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC;YAEzE,IAAI,CAAC,iBAAiB,EAAE,CAAC;gBACxB,OAAO;YACR,CAAC;YAED,iBAAiB,CAAC,iBAAiB,CAAC,WAAW,IAAI,SAAS,CAAC,CAAC;QAC/D,CAAC;QAED,KAAK,CAAC,4BAA4B,CAAC,uBAA+B,EAAE,YAAoB,EAAE,KAAa;YACtG,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;YAEhF,IAAI,CAAC,iBAAiB,EAAE,CAAC;gBACxB,OAAO;YACR,CAAC;YAED,iBAAiB,CAAC,4BAA4B,CAAC,YAAY,EAAE,KAAK,CAAC,CAAC;QACrE,CAAC;QAED,oBAAoB,CAAC,uBAA+B,EAAE,mBAA2B;YAChF,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;YAEhF,iBAAiB,EAAE,oBAAoB,CAAC,mBAAmB,CAAC,CAAC;QAC9D,CAAC;QAED,KAAK,CAAC,oBAAoB,CAAC,uBAA+B,EAAE,mBAA2B,EAAE,OAA6B;YACrH,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;YAEhF,iBAAiB,EAAE,oBAAoB,CAAC,mBAAmB,EAAE,OAAO,CAAC,CAAC;QACvE,CAAC;QAED,KAAK,CAAC,wBAAwB,CAAC,uBAA+B,EAAE,aAA4B,EAAE,KAAwB;YACrH,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;YAEhF,IAAI,CAAC,iBAAiB,IAAI,CAAC,iBAAiB,CAAC,uBAAuB,EAAE,CAAC;gBACtE,OAAO,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YACnC,CAAC;YAED,MAAM,QAAQ,GAAG,MAAM,SAAS,CAAC,kBAAkB,CAAC,GAAG,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC;YAC/E,OAAO,SAAS,CAAC,KAAK,IAAI,EAAE;gBAC3B,MAAM,YAAY,GAAG,MAAM,iBAAiB,CAAC,uBAAuB,EAAE,uBAAuB,CAAC,QAAQ,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;gBACxH,IAAI,MAAqE,CAAC;gBAC1E,IAAI,KAAK,CAAC,OAAO,CAAC,YAAY,CAAC,EAAE,CAAC;oBACjC,MAAM,GAAG;wBACR,MAAM,EAAE,YAAY;wBACpB,YAAY,EAAE,KAAK;qBACnB,CAAC;gBACH,CAAC;qBAAM,IAAI,YAAY,EAAE,CAAC;oBACzB,MAAM,GAAG;wBACR,MAAM,EAAE,YAAY,CAAC,MAAM,IAAI,EAAE;wBACjC,YAAY,EAAE,YAAY,CAAC,kBAAkB,IAAI,KAAK;qBACtD,CAAC;gBACH,CAAC;qBAAM,CAAC;oBACP,MAAM,GAAG,YAAY,IAAI,SAAS,CAAC;gBACpC,CAAC;gBACD,OAAO,MAAM,CAAC;YACf,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;gBAChB,IAAI,eAAe,GAA4D,SAAS,CAAC;gBACzF,IAAI,MAAM,EAAE,CAAC;oBACZ,eAAe,GAAG;wBACjB,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,oBAAoB,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;wBAClE,YAAY,EAAE,MAAM,CAAC,YAAY;qBACjC,CAAC;gBACH,CAAC;gBACD,OAAO,eAAe,CAAC;YACxB,CAAC,CAAC,CAAC;QACJ,CAAC;QAED,eAAe,CAAC,uBAA+B,EAAE,YAAoB,EAAE,GAAkB,EAAE,OAA0B,EAAE,QAAmC;YACzJ,MAAM,iBAAiB,GAAG,IAAI,CAAC,mBAAmB,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;YAEhF,IAAI,CAAC,iBAAiB,IAAI,CAAC,iBAAiB,CAAC,eAAe,EAAE,CAAC;gBAC9D,OAAO,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YACnC,CAAC;YAED,OAAO,SAAS,CAAC,GAAG,EAAE;gBACrB,MAAM,aAAa,GAAG,iBAAiB,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;gBACvE,IAAI,aAAa,EAAE,CAAC;oBACnB,MAAM,aAAa,GAAG,aAAa,CAAC,oBAAoB,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;oBAEnF,IAAI,iBAAiB,KAAK,SAAS,IAAI,aAAa,EAAE,CAAC;wBACtD,IAAI,iBAAiB,CAAC,eAAe,EAAE,CAAC;4BACvC,OAAO,iBAAiB,CAAC,eAAe,CAAC,aAAa,EAAE,mBAAmB,CAAC,QAAQ,CAAC,CAAC,CAAC;wBACxF,CAAC;oBACF,CAAC;gBACF,CAAC;gBAED,OAAO,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;YACnC,CAAC,CAAC,CAAC;QACJ,CAAC;;IAcF,MAAM,oBAAoB;iBACV,gBAAW,GAAW,CAAX,AAAY,CAAC;QAMvC,IAAI,QAAQ,CAAC,EAAU;YACtB,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC;QACf,CAAC;QAED,IAAI,QAAQ;YACX,OAAO,IAAI,CAAC,GAAI,CAAC;QAClB,CAAC;QAED,IAAI,EAAE;YACL,OAAO,IAAI,CAAC,GAAI,CAAC;QAClB,CAAC;QAED,IAAI,QAAQ;YACX,OAAO,IAAI,CAAC,IAAI,CAAC;QAClB,CAAC;QAED,IAAI,GAAG;YACN,OAAO,IAAI,CAAC,IAAI,CAAC;QAClB,CAAC;QAKD,IAAI,KAAK,CAAC,KAA+B;YACxC,IAAI,CAAC,CAAC,KAAK,KAAK,SAAS,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,KAAK,SAAS,CAAC,CAAC,IAAI,CAAC,CAAC,KAAK,IAAI,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC;gBACxH,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;gBACpB,IAAI,CAAC,aAAa,CAAC,KAAK,GAAG,KAAK,CAAC;gBACjC,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,CAAC;YACvC,CAAC;QACF,CAAC;QAED,IAAI,KAAK;YACR,OAAO,IAAI,CAAC,MAAM,CAAC;QACpB,CAAC;QAID,IAAI,QAAQ,CAAC,KAAgD;YAC5D,IAAI,IAAI,CAAC,SAAS,KAAK,KAAK,EAAE,CAAC;gBAC9B,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;gBACvB,IAAI,CAAC,aAAa,CAAC,QAAQ,GAAG,KAAK,CAAC;gBACpC,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,CAAC;YACvC,CAAC;QACF,CAAC;QACD,IAAI,QAAQ;YACX,OAAO,IAAI,CAAC,SAAS,CAAC;QACvB,CAAC;QAID,IAAI,KAAK;YACR,OAAO,IAAI,CAAC,MAAM,CAAC;QACpB,CAAC;QAED,IAAI,KAAK,CAAC,KAAyB;YAClC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;YACpB,IAAI,CAAC,aAAa,CAAC,KAAK,GAAG,KAAK,CAAC;YACjC,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,CAAC;QACvC,CAAC;QAID,IAAI,YAAY;YACf,OAAO,IAAI,CAAC,aAAa,CAAC;QAC3B,CAAC;QAED,IAAI,YAAY,CAAC,OAA2B;YAC3C,IAAI,CAAC,aAAa,GAAG,OAAO,CAAC;YAC7B,IAAI,CAAC,aAAa,CAAC,YAAY,GAAG,OAAO,CAAC;YAC1C,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,CAAC;QACvC,CAAC;QAED,IAAI,QAAQ;YACX,OAAO,IAAI,CAAC,SAAS,CAAC;QACvB,CAAC;QAED,IAAI,QAAQ,CAAC,WAA6B;YACzC,IAAI,CAAC,SAAS,GAAG,WAAW,CAAC;YAC7B,IAAI,CAAC,aAAa,CAAC,QAAQ,GAAG,WAAW,CAAC;YAC1C,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,CAAC;QACvC,CAAC;QAID,IAAI,gBAAgB;YACnB,OAAO,IAAI,CAAC,cAAe,CAAC;QAC7B,CAAC;QAED,IAAI,gBAAgB,CAAC,QAA8C;YAClE,IAAI,IAAI,CAAC,cAAc,KAAK,QAAQ,EAAE,CAAC;gBACtC,OAAO;YACR,CAAC;YACD,IAAI,CAAC,cAAc,GAAG,QAAQ,CAAC;YAC/B,IAAI,CAAC,aAAa,CAAC,gBAAgB,GAAG,QAAQ,CAAC;YAC/C,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,CAAC;QACvC,CAAC;QAID,IAAI,KAAK;YACR,OAAO,IAAI,CAAC,MAAO,CAAC;QACrB,CAAC;QAED,IAAI,KAAK,CAAC,QAAiI;YAC1I,IAAI,CAAC,MAAM,GAAG,QAAQ,CAAC;YACvB,IAAI,OAAO,QAAQ,KAAK,QAAQ,EAAE,CAAC;gBAClC,uBAAuB,CAAC,IAAI,CAAC,oBAAoB,EAAE,4BAA4B,CAAC,CAAC;gBACjF,IAAI,CAAC,aAAa,CAAC,KAAK,GAAG,QAAQ,CAAC,QAAQ,CAAC;gBAC7C,IAAI,CAAC,aAAa,CAAC,aAAa,GAAG,QAAQ,CAAC,aAAa,CAAC;YAC3D,CAAC;iBAAM,CAAC;gBACP,IAAI,CAAC,aAAa,CAAC,KAAK,GAAG,QAAQ,CAAC;YACrC,CAAC;YACD,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,CAAC;QACvC,CAAC;QAMD,IAAW,UAAU;YACpB,OAAO,IAAI,CAAC,UAAU,CAAC;QACxB,CAAC;QAQD,YACC,mBAA2B,EACnB,wBAAgC,EAChC,GAAuB,EACvB,IAAgB,EAChB,MAAgC,EAChC,SAA2B,EACnB,oBAA2C,EACnD,WAAoB,EAC5B,QAAiB;YAPT,6BAAwB,GAAxB,wBAAwB,CAAQ;YAChC,QAAG,GAAH,GAAG,CAAoB;YACvB,SAAI,GAAJ,IAAI,CAAY;YAChB,WAAM,GAAN,MAAM,CAA0B;YAChC,cAAS,GAAT,SAAS,CAAkB;YACnB,yBAAoB,GAApB,oBAAoB,CAAuB;YACnD,gBAAW,GAAX,WAAW,CAAS;YA9IpB,WAAM,GAAG,oBAAoB,CAAC,WAAW,EAAE,CAAC;YAC9C,kBAAa,GAAW,CAAC,CAAC;YAEzB,kBAAa,GAA8B,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YAsBtD,8BAAyB,GAAG,IAAI,OAAO,EAAQ,CAAC;YACxD,6BAAwB,GAAG,IAAI,CAAC,yBAAyB,CAAC,KAAK,CAAC;YAcjE,cAAS,GAA8C,IAAI,CAAC;YAwF5D,iBAAY,GAAgC,IAAI,GAAG,EAA0B,CAAC;YAErE,4BAAuB,GAAG,IAAI,iBAAiB,EAAmB,CAAC;YAenF,IAAI,CAAC,uBAAuB,CAAC,KAAK,GAAG,IAAI,eAAe,EAAE,CAAC;YAE3D,IAAI,IAAI,CAAC,GAAG,KAAK,SAAS,EAAE,CAAC;gBAC5B,IAAI,CAAC,GAAG,GAAG,GAAG,mBAAmB,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;YACpD,CAAC;YAED,KAAK,CAAC,oBAAoB,CACzB,wBAAwB,EACxB,IAAI,CAAC,MAAM,EACX,IAAI,CAAC,GAAG,EACR,IAAI,CAAC,IAAI,EACT,oBAAoB,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,EAC5C,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,mBAAmB,CAAC,IAAI,EAAE,GAAG,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,oBAAoB,CAAC,CAAC,EACvG,oBAAoB,CAAC,UAAU,EAC/B,IAAI,CAAC,WAAW,EAChB,QAAQ,CACR,CAAC;YAEF,IAAI,CAAC,iBAAiB,GAAG,EAAE,CAAC;YAC5B,IAAI,CAAC,UAAU,GAAG,KAAK,CAAC;YAExB,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,IAAI,CAAC,wBAAwB,CAAC,GAAG,EAAE;gBAC9D,IAAI,CAAC,6BAA6B,EAAE,CAAC;YACtC,CAAC,CAAC,CAAC,CAAC;YAEJ,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC;gBAC3B,OAAO,EAAE,GAAG,EAAE;oBACb,KAAK,CAAC,oBAAoB,CACzB,wBAAwB,EACxB,IAAI,CAAC,MAAM,CACX,CAAC;gBACH,CAAC;aACD,CAAC,CAAC;YAEH,MAAM,IAAI,GAAG,IAAI,CAAC;YAClB,IAAI,CAAC,KAAK,GAAG;gBACZ,IAAI,GAAG,KAAK,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC;gBAC9B,IAAI,KAAK,KAAK,OAAO,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC;gBAClC,IAAI,KAAK,CAAC,KAA+B,IAAI,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC;gBAClE,IAAI,QAAQ,KAAK,OAAO,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACxC,IAAI,QAAQ,CAAC,KAAuB,IAAI,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC,CAAC,CAAC;gBAChE,IAAI,gBAAgB,KAAK,OAAO,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC;gBACxD,IAAI,gBAAgB,CAAC,KAA2C,IAAI,IAAI,CAAC,gBAAgB,GAAG,KAAK,CAAC,CAAC,CAAC;gBACpG,IAAI,QAAQ,KAAK,OAAO,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACxC,IAAI,QAAQ,CAAC,KAAgD,IAAI,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC,CAAC,CAAC;gBACzF,IAAI,YAAY,KAAK,OAAO,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC;gBAChD,IAAI,YAAY,CAAC,KAAyB,IAAI,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC,CAAC,CAAC;gBAC1E,IAAI,KAAK,KAAK,OAAO,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC;gBAClC,IAAI,KAAK,CAAC,KAAyB,IAAI,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC;gBAC5D,IAAI,KAAK,KAA0I,OAAO,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC;gBACvK,IAAI,KAAK,CAAC,KAA8H,IAAI,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC;gBACjK,MAAM,EAAE,CAAC,OAA4D,EAAE,OAA2C,EAAE,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,OAAO,CAAC;gBACpJ,IAAI,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE;gBACvB,OAAO,EAAE,GAAG,EAAE;oBACb,IAAI,CAAC,OAAO,EAAE,CAAC;gBAChB,CAAC;aACD,CAAC;QACH,CAAC;QAEO,gBAAgB;YACvB,IAAI,IAAI,CAAC,WAAW,EAAE,CAAC;gBACtB,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;gBACzB,IAAI,CAAC,aAAa,CAAC,UAAU,GAAG,KAAK,CAAC;YACvC,CAAC;QACF,CAAC;QAGD,6BAA6B;YAC5B,IAAI,IAAI,CAAC,UAAU,EAAE,CAAC;gBACrB,OAAO;YACR,CAAC;YACD,IAAI,CAAC,gBAAgB,EAAE,CAAC;YAExB,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,KAAK,EAAE,CAAC;gBACzC,IAAI,CAAC,uBAAuB,CAAC,KAAK,GAAG,IAAI,eAAe,EAAE,CAAC;YAC5D,CAAC;YAED,MAAM,QAAQ,GAAG,CAAC,KAAsC,EAAW,EAAE,CACpE,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC;YAEjE,MAAM,sBAAsB,GAAyB,EAAE,CAAC;YACxD,IAAI,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;gBACvB,sBAAsB,CAAC,KAAK,GAAG,oBAAoB,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC7E,CAAC;YACD,IAAI,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;gBACvB,sBAAsB,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;YAC3C,CAAC;YACD,IAAI,QAAQ,CAAC,cAAc,CAAC,EAAE,CAAC;gBAC9B;;;mBAGG;gBACH,sBAAsB,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC;YACjE,CAAC;YACD,IAAI,QAAQ,CAAC,UAAU,CAAC,EAAE,CAAC;gBAC1B,sBAAsB,CAAC,QAAQ;oBAC9B,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,mBAAmB,CAAC,IAAI,EAAE,GAAG,EAAE,IAAI,CAAC,YAAY,EAAE,IAAI,CAAC,oBAAoB,CAAC,CAAC,CAAC;YAC1G,CAAC;YACD,IAAI,QAAQ,CAAC,kBAAkB,CAAC,EAAE,CAAC;gBAClC,sBAAsB,CAAC,aAAa,GAAG,yBAAyB,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;YACvF,CAAC;YACD,IAAI,QAAQ,CAAC,UAAU,CAAC,EAAE,CAAC;gBAC1B,sBAAsB,CAAC,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;YACjD,CAAC;YACD,IAAI,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;gBACvB,sBAAsB,CAAC,KAAK,GAAG,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC5D,CAAC;YACD,IAAI,QAAQ,CAAC,eAAe,CAAC,EAAE,CAAC;gBAC/B,sBAAsB,CAAC,aAAa,GAAG,kBAAkB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACxE,CAAC;YACD,IAAI,QAAQ,CAAC,YAAY,CAAC,EAAE,CAAC;gBAC5B,sBAAsB,CAAC,UAAU,GAAG,IAAI,CAAC,WAAW,CAAC;YACtD,CAAC;YACD,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;YAExB,KAAK,CAAC,oBAAoB,CACzB,IAAI,CAAC,wBAAwB,EAC7B,IAAI,CAAC,MAAM,EACX,IAAI,CAAC,GAAI,EACT,IAAI,CAAC,IAAI,EACT,sBAAsB,CACtB,CAAC;QACH,CAAC;QAED,oBAAoB,CAAC,QAAgB;YACpC,KAAK,MAAM,GAAG,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;gBACrC,MAAM,OAAO,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC;gBACvB,MAAM,EAAE,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC;gBAClB,IAAI,QAAQ,KAAK,EAAE,EAAE,CAAC;oBACrB,OAAO,OAAO,CAAC;gBAChB,CAAC;YACF,CAAC;YAED,OAAO;QACR,CAAC;QAED,KAAK,CAAC,MAAM,CAAC,gBAAqE,EAAE,OAA2C;YAC9H,uBAAuB,CAAC,IAAI,CAAC,oBAAoB,EAAE,eAAe,CAAC,CAAC;YACpE,IAAI,OAAmC,CAAC;YACxC,IAAI,gBAAgB,IAAK,gBAAmC,CAAC,IAAI,KAAK,SAAS,EAAE,CAAC;gBACjF,OAAO,GAAG,gBAAkC,CAAC;YAC9C,CAAC;iBAAM,CAAC;gBACP,OAAO,GAAG,OAAO,IAAI,gBAAqD,CAAC;YAC5E,CAAC;YACD,IAAI,eAAe,GAAG,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;YAC3E,eAAe,KAAK,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAE,CAAC;YAC9D,IAAI,aAAa,GAAY,IAAI,CAAC;YAClC,IAAI,UAAU,GAAY,KAAK,CAAC;YAChC,IAAI,OAAO,EAAE,KAAK,KAAK,KAAK,CAAC,kBAAkB,CAAC,KAAK,EAAE,CAAC;gBACvD,UAAU,GAAG,IAAI,CAAC;gBAClB,aAAa,GAAG,KAAK,CAAC;YACvB,CAAC;iBAAM,IAAI,OAAO,EAAE,KAAK,KAAK,KAAK,CAAC,kBAAkB,CAAC,OAAO,EAAE,CAAC;gBAChE,aAAa,GAAG,KAAK,CAAC;YACvB,CAAC;YACD,OAAO,KAAK,CAAC,oBAAoB,CAAC,IAAI,CAAC,wBAAwB,EAAE,IAAI,CAAC,MAAM,EAAE,eAAe,EAAE,EAAE,aAAa,EAAE,UAAU,EAAE,CAAC,CAAC;QAC/H,CAAC;QAED,KAAK,CAAC,IAAI;YACT,OAAO,KAAK,CAAC,kBAAkB,CAAC,IAAI,CAAC,wBAAwB,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;QAC7E,CAAC;QAED,OAAO;YACN,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;YACvB,IAAI,CAAC,uBAAuB,CAAC,OAAO,EAAE,CAAC;YACvC,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC,CAAC;QACpE,CAAC;;IAlGD;QADC,QAAQ,CAAC,GAAG,CAAC;6EAwDb;IAgDF,MAAM,wBAAwB;QAC7B,IAAI,EAAE;YACL,OAAO,IAAI,CAAC,GAAG,CAAC;QACjB,CAAC;QAED,IAAI,KAAK;YACR,OAAO,IAAI,CAAC,MAAM,CAAC;QACpB,CAAC;QAED,IAAW,MAAM;YAChB,OAAO,IAAI,CAAC,OAAO,CAAC;QACrB,CAAC;QAKD,IAAI,uBAAuB;YAC1B,OAAO,IAAI,CAAC,wBAAwB,CAAC;QACtC,CAAC;QAED,IAAI,uBAAuB,CAAC,QAAoD;YAC/E,IAAI,CAAC,wBAAwB,GAAG,QAAQ,CAAC;YACzC,IAAI,QAAQ,EAAE,aAAa,EAAE,CAAC;gBAC7B,uBAAuB,CAAC,IAAI,CAAC,UAAU,EAAE,qBAAqB,CAAC,CAAC;YACjE,CAAC;YACD,KAAK,CAAC,uBAAuB,CAAC,IAAI,CAAC,MAAM,EAAE,QAAQ,EAAE,aAAa,CAAC,CAAC;QACrE,CAAC;QAID,IAAI,eAAe;YAClB,OAAO,IAAI,CAAC,gBAAgB,CAAC;QAC9B,CAAC;QAED,IAAI,eAAe,CAAC,OAAoC;YACvD,IAAI,CAAC,gBAAgB,GAAG,OAAO,CAAC;YAEhC,KAAK,CAAC,gCAAgC,CAAC,IAAI,CAAC,MAAM,EAAE,EAAE,eAAe,EAAE,CAAC,CAAC,OAAO,EAAE,CAAC,CAAC;QACrF,CAAC;QAID,IAAI,OAAO;YACV,OAAO,IAAI,CAAC,QAAQ,CAAC;QACtB,CAAC;QAED,IAAI,OAAO,CAAC,OAA6C;YACxD,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;YAExB,KAAK,CAAC,gCAAgC,CAAC,IAAI,CAAC,MAAM,EAAE,EAAE,OAAO,EAAE,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC;QACjF,CAAC;QAID,IAAI,aAAa;YAChB,uBAAuB,CAAC,IAAI,CAAC,UAAU,EAAE,eAAe,CAAC,CAAC;YAC1D,OAAO,IAAI,CAAC,cAAc,CAAC;QAC5B,CAAC;QAID,IAAI,mBAAmB;YACtB,uBAAuB,CAAC,IAAI,CAAC,UAAU,EAAE,eAAe,CAAC,CAAC;YAC1D,OAAO,IAAI,CAAC,aAAa,EAAE,KAAK,CAAC;QAClC,CAAC;QAKD,YACS,UAAiC,EACjC,OAAe,EACf,GAAW,EACX,MAAc;YAHd,eAAU,GAAV,UAAU,CAAuB;YACjC,YAAO,GAAP,OAAO,CAAQ;YACf,QAAG,GAAH,GAAG,CAAQ;YACX,WAAM,GAAN,MAAM,CAAQ;YA5Df,aAAQ,GAAsC,IAAI,GAAG,EAAgC,CAAC;YA8D7F,KAAK,CAAC,0BAA0B,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,EAAE,MAAM,EAAE,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;YAE7F,MAAM,IAAI,GAAG,IAAI,CAAC;YAClB,IAAI,CAAC,KAAK,GAAG,MAAM,CAAC,MAAM,CAAC;gBAC1B,EAAE,EAAE,IAAI,CAAC,EAAE;gBACX,KAAK,EAAE,IAAI,CAAC,KAAK;gBACjB,IAAI,OAAO,KAAK,OAAO,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC;gBACtC,IAAI,OAAO,CAAC,OAA0C,IAAI,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC,CAAC,CAAC;gBACnF,IAAI,uBAAuB,KAAiD,OAAO,IAAI,CAAC,uBAAuB,CAAC,CAAC,CAAC;gBAClH,IAAI,uBAAuB,CAAC,uBAAmE,IAAI,IAAI,CAAC,uBAAuB,GAAG,uBAAuB,CAAC,CAAC,CAAC;gBAC5J,IAAI,eAAe,KAAkC,OAAO,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC;gBACnF,IAAI,eAAe,CAAC,OAAoC,IAAI,IAAI,CAAC,eAAe,GAAG,OAAO,CAAC,CAAC,CAAC;gBAC7F,kFAAkF;gBAClF,IAAI,mBAAmB,KAAuC,OAAO,IAAI,CAAC,mBAAuD,CAAC,CAAC,CAAC;gBACpI,mBAAmB,CAAC,GAAe,EAAE,KAA+B,EAAE,QAA0B;oBAC/F,OAAO,IAAI,CAAC,mBAAmB,CAAC,GAAG,EAAE,KAAK,EAAE,QAAQ,CAAC,CAAC,KAA6B,CAAC;gBACrF,CAAC;gBACD,OAAO,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;aAClC,CAAC,CAAC;YAEH,IAAI,CAAC,iBAAiB,GAAG,EAAE,CAAC;YAC5B,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC;gBAC3B,OAAO,EAAE,GAAG,EAAE;oBACb,KAAK,CAAC,4BAA4B,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;gBACjD,CAAC;aACD,CAAC,CAAC;QACJ,CAAC;QAED,mBAAmB,CAAC,QAAoB,EAAE,KAA+B,EAAE,QAA0B;YACpG,MAAM,aAAa,GAAG,IAAI,oBAAoB,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;YACnI,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,aAAa,CAAC,MAAM,EAAE,aAAa,CAAC,CAAC;YACvD,OAAO,aAAa,CAAC;QACtB,CAAC;QAED,iBAAiB,CAAC,WAAmF;YACpG,IAAI,CAAC,WAAW,EAAE,CAAC;gBAClB,IAAI,CAAC,cAAc,GAAG,SAAS,CAAC;gBAChC,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;gBAC/B,OAAO;YACR,CAAC;YACD,MAAM,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,WAAW,CAAC,mBAAmB,CAAC,CAAC;YAClE,IAAI,MAAM,EAAE,CAAC;gBACZ,IAAI,CAAC,cAAc,GAAG,WAAW,CAAC,gBAAgB,CAAC,CAAC,CAAC,MAAM,CAAC,oBAAoB,CAAC,WAAW,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;gBAC3H,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC;YAC7B,CAAC;QACF,CAAC;QAED,4BAA4B,CAAC,aAA4B,EAAE,KAAyB,EAAE,QAAiB;YACtG,MAAM,aAAa,GAAG,IAAI,oBAAoB,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,GAAG,CAAC,MAAM,CAAC,aAAa,CAAC,EAAE,oBAAoB,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,EAAE,EAAE,EAAE,IAAI,CAAC,UAAU,EAAE,IAAI,EAAE,QAAQ,CAAC,CAAC;YACtL,aAAa,CAAC,gBAAgB,GAAG,SAAS,CAAC,6BAA6B,CAAC,QAAQ,CAAC;YAClF,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,aAAa,CAAC,MAAM,EAAE,aAAa,CAAC,CAAC;YACvD,OAAO,aAAa,CAAC;QACtB,CAAC;QAED,4BAA4B,CAAC,YAAoB,EAAE,KAAa;YAC/D,MAAM,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;YAC/C,IAAI,MAAM,EAAE,CAAC;gBACZ,MAAM,CAAC,KAAK,GAAG,oBAAoB,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC;YACrD,CAAC;QACF,CAAC;QAED,oBAAoB,CAAC,YAAoB,EAAE,OAA6B;YACvE,MAAM,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;YAC/C,IAAI,CAAC,MAAM,EAAE,CAAC;gBACb,OAAO;YACR,CAAC;YAED,MAAM,QAAQ,GAAG,CAAC,KAAiC,EAAW,EAAE,CAC/D,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;YAEtD,IAAI,QAAQ,CAAC,eAAe,CAAC,EAAE,CAAC;gBAC/B,MAAM,CAAC,gBAAgB,GAAG,yBAAyB,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;YAC5E,CAAC;QACF,CAAC;QAED,oBAAoB,CAAC,YAAoB;YACxC,MAAM,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;YAE/C,MAAM,EAAE,OAAO,EAAE,CAAC;YAElB,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;QACpC,CAAC;QAED,gBAAgB,CAAC,MAAc;YAC9B,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QAClC,CAAC;QAED,OAAO;YACN,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;gBAC7B,KAAK,CAAC,OAAO,EAAE,CAAC;YACjB,CAAC,CAAC,CAAC;YAEH,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC,CAAC;QACpE,CAAC;KACD;IAED,SAAS,mBAAmB,CAAC,MAA4B,EAAE,aAA6B,EAAE,WAAwC,EAAE,SAAgC;QACnK,IAAI,eAAe,GAAG,WAAW,CAAC,GAAG,CAAC,aAAa,CAAE,CAAC;QACtD,IAAI,CAAC,eAAe,EAAE,CAAC;YACtB,eAAe,GAAG,EAAE,MAAM,CAAC,aAAa,CAAC;YACzC,WAAW,CAAC,GAAG,CAAC,aAAa,EAAE,eAAe,CAAC,CAAC;QACjD,CAAC;QAED,IAAI,aAAa,CAAC,KAAK,KAAK,SAAS,EAAE,CAAC;YACvC,uBAAuB,CAAC,SAAS,EAAE,oBAAoB,CAAC,CAAC;QAC1D,CAAC;QAED,IAAI,aAAa,CAAC,SAAS,EAAE,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,QAAQ,CAAC,QAAQ,KAAK,SAAS,CAAC,EAAE,CAAC;YAChF,uBAAuB,CAAC,SAAS,EAAE,gBAAgB,CAAC,CAAC;QACtD,CAAC;QAED,OAAO;YACN,IAAI,EAAE,aAAa,CAAC,IAAI;YACxB,YAAY,EAAE,aAAa,CAAC,YAAY;YACxC,gBAAgB,EAAE,eAAe;YACjC,IAAI,EAAE,CAAC,OAAO,aAAa,CAAC,IAAI,KAAK,QAAQ,CAAC,CAAC,CAAC,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC,oBAAoB,CAAC,cAAc,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC;YAClI,QAAQ,EAAE,aAAa,CAAC,MAAM,CAAC,IAAI;YACnC,YAAY,EAAE,aAAa,CAAC,MAAM,CAAC,QAAQ;YAC3C,KAAK,EAAE,aAAa,CAAC,KAAK;YAC1B,gBAAgB,EAAE,aAAa,CAAC,SAAS,CAAC,CAAC,CAAC,aAAa,CAAC,SAAS,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS;YAC5H,KAAK,EAAE,aAAa,CAAC,KAAK;YAC1B,SAAS,EAAE,aAAa,CAAC,SAAS,EAAE,MAAM,EAAE;SAC5C,CAAC;IACH,CAAC;IAED,SAAS,iBAAiB,CAAC,QAAgC;QAC1D,OAAO;YACN,KAAK,EAAE,QAAQ,CAAC,KAAK;YACrB,QAAQ,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,oBAAoB,CAAC,cAAc,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,SAAS;YAChG,KAAK,EAAE,QAAQ,CAAC,KAAK;YACrB,UAAU,EAAE,QAAQ,CAAC,gBAAgB;YACrC,QAAQ,EAAE,CAAC,CAAC,QAAQ,CAAC,QAAQ,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,KAAK,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAE,QAAQ,CAAC,QAAiD,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAa;SAC1O,CAAC;IACH,CAAC;IAED,SAAS,mBAAmB,CAAC,QAAmC;QAC/D,OAAO;YACN,KAAK,EAAE,QAAQ,CAAC,KAAK,IAAI,EAAE;YAC3B,KAAK,EAAE,QAAQ,CAAC,KAAK,IAAI,CAAC;YAC1B,QAAQ,EAAE,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,EAAE;YAChE,gBAAgB,EAAE,QAAQ,CAAC,UAAU,IAAI,KAAK;YAC9C,QAAQ,EAAE,QAAQ,CAAC,QAAQ,EAAE,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;SAChE,CAAC;IACH,CAAC;IAED,SAAS,yBAAyB,CAAC,IAAsD;QACxF,IAAI,IAAI,KAAK,SAAS,EAAE,CAAC;YACxB,QAAQ,IAAI,EAAE,CAAC;gBACd,KAAK,KAAK,CAAC,6BAA6B,CAAC,QAAQ;oBAChD,OAAO,SAAS,CAAC,6BAA6B,CAAC,QAAQ,CAAC;gBACzD,KAAK,KAAK,CAAC,6BAA6B,CAAC,SAAS;oBACjD,OAAO,SAAS,CAAC,6BAA6B,CAAC,SAAS,CAAC;YAC3D,CAAC;QACF,CAAC;QACD,OAAO,SAAS,CAAC,6BAA6B,CAAC,SAAS,CAAC;IAC1D,CAAC;IAED,SAAS,cAAc,CAAC,IAAyI;QAChK,IAAI,YAAmD,CAAC;QACxD,IAAI,OAAO,IAAI,KAAK,QAAQ,EAAE,CAAC;YAC9B,YAAY,GAAG,IAAI,CAAC,QAAQ,CAAC;QAC9B,CAAC;aAAM,CAAC;YACP,YAAY,GAAG,IAAI,CAAC;QACrB,CAAC;QAED,IAAI,YAAY,KAAK,SAAS,EAAE,CAAC;YAChC,QAAQ,YAAY,EAAE,CAAC;gBACtB,KAAK,KAAK,CAAC,kBAAkB,CAAC,UAAU;oBACvC,OAAO,SAAS,CAAC,kBAAkB,CAAC,UAAU,CAAC;gBAChD,KAAK,KAAK,CAAC,kBAAkB,CAAC,QAAQ;oBACrC,OAAO,SAAS,CAAC,kBAAkB,CAAC,QAAQ,CAAC;YAC/C,CAAC;QACF,CAAC;QACD,OAAO,SAAS,CAAC,kBAAkB,CAAC,UAAU,CAAC;IAChD,CAAC;IAED,SAAS,kBAAkB,CAAC,IAAyI;QACpK,IAAI,iBAAiB,GAAkD,SAAS,CAAC;QACjF,IAAI,OAAO,IAAI,KAAK,QAAQ,EAAE,CAAC;YAC9B,iBAAiB,GAAG,IAAI,CAAC,aAAa,CAAC;QACxC,CAAC;QAED,IAAI,iBAAiB,KAAK,SAAS,EAAE,CAAC;YACrC,QAAQ,iBAAiB,EAAE,CAAC;gBAC3B,KAAK,KAAK,CAAC,0BAA0B,CAAC,OAAO;oBAC5C,OAAO,SAAS,CAAC,0BAA0B,CAAC,OAAO,CAAC;gBACrD,KAAK,KAAK,CAAC,0BAA0B,CAAC,QAAQ;oBAC7C,OAAO,SAAS,CAAC,0BAA0B,CAAC,QAAQ,CAAC;YACvD,CAAC;QACF,CAAC;QACD,OAAO,SAAS,CAAC,0BAA0B,CAAC,OAAO,CAAC;IACrD,CAAC;IAED,OAAO,IAAI,mBAAmB,EAAE,CAAC;AAClC,CAAC","file":"extHostComments.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { asPromise } from '../../../base/common/async.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { debounce } from '../../../base/common/decorators.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { DisposableStore, MutableDisposable } from '../../../base/common/lifecycle.js';\nimport { MarshalledId } from '../../../base/common/marshallingIds.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { IRange } from '../../../editor/common/core/range.js';\nimport * as languages from '../../../editor/common/languages.js';\nimport { ExtensionIdentifierMap, IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { ExtHostDocuments } from './extHostDocuments.js';\nimport * as extHostTypeConverter from './extHostTypeConverters.js';\nimport * as types from './extHostTypes.js';\nimport type * as vscode from 'vscode';\nimport { ExtHostCommentsShape, IMainContext, MainContext, CommentThreadChanges, CommentChanges } from './extHost.protocol.js';\nimport { ExtHostCommands } from './extHostCommands.js';\nimport { checkProposedApiEnabled } from '../../services/extensions/common/extensions.js';\nimport { MarshalledCommentThread } from '../../common/comments.js';\n\ntype ProviderHandle = number;\n\ninterface ExtHostComments {\n\tcreateCommentController(extension: IExtensionDescription, id: string, label: string): vscode.CommentController;\n}\n\nexport function createExtHostComments(mainContext: IMainContext, commands: ExtHostCommands, documents: ExtHostDocuments): ExtHostCommentsShape & ExtHostComments {\n\tconst proxy = mainContext.getProxy(MainContext.MainThreadComments);\n\n\tclass ExtHostCommentsImpl implements ExtHostCommentsShape, ExtHostComments {\n\n\t\tprivate static handlePool = 0;\n\n\n\t\tprivate _commentControllers: Map<ProviderHandle, ExtHostCommentController> = new Map<ProviderHandle, ExtHostCommentController>();\n\n\t\tprivate _commentControllersByExtension: ExtensionIdentifierMap<ExtHostCommentController[]> = new ExtensionIdentifierMap<ExtHostCommentController[]>();\n\n\n\t\tconstructor(\n\t\t) {\n\t\t\tcommands.registerArgumentProcessor({\n\t\t\t\tprocessArgument: arg => {\n\t\t\t\t\tif (arg && arg.$mid === MarshalledId.CommentController) {\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(arg.handle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn commentController.value;\n\t\t\t\t\t} else if (arg && arg.$mid === MarshalledId.CommentThread) {\n\t\t\t\t\t\tconst marshalledCommentThread: MarshalledCommentThread = arg;\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(marshalledCommentThread.commentControlHandle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn marshalledCommentThread;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentThread = commentController.getCommentThread(marshalledCommentThread.commentThreadHandle);\n\n\t\t\t\t\t\tif (!commentThread) {\n\t\t\t\t\t\t\treturn marshalledCommentThread;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn commentThread.value;\n\t\t\t\t\t} else if (arg && (arg.$mid === MarshalledId.CommentThreadReply || arg.$mid === MarshalledId.CommentThreadInstance)) {\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(arg.thread.commentControlHandle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentThread = commentController.getCommentThread(arg.thread.commentThreadHandle);\n\n\t\t\t\t\t\tif (!commentThread) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (arg.$mid === MarshalledId.CommentThreadInstance) {\n\t\t\t\t\t\t\treturn commentThread.value;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tthread: commentThread.value,\n\t\t\t\t\t\t\ttext: arg.text\n\t\t\t\t\t\t};\n\t\t\t\t\t} else if (arg && arg.$mid === MarshalledId.CommentNode) {\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(arg.thread.commentControlHandle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentThread = commentController.getCommentThread(arg.thread.commentThreadHandle);\n\n\t\t\t\t\t\tif (!commentThread) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentUniqueId = arg.commentUniqueId;\n\n\t\t\t\t\t\tconst comment = commentThread.getCommentByUniqueId(commentUniqueId);\n\n\t\t\t\t\t\tif (!comment) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn comment;\n\n\t\t\t\t\t} else if (arg && arg.$mid === MarshalledId.CommentThreadNode) {\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(arg.thread.commentControlHandle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentThread = commentController.getCommentThread(arg.thread.commentThreadHandle);\n\n\t\t\t\t\t\tif (!commentThread) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst body: string = arg.text;\n\t\t\t\t\t\tconst commentUniqueId = arg.commentUniqueId;\n\n\t\t\t\t\t\tconst comment = commentThread.getCommentByUniqueId(commentUniqueId);\n\n\t\t\t\t\t\tif (!comment) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// If the old comment body was a markdown string, use a markdown string here too.\n\t\t\t\t\t\tif (typeof comment.body === 'string') {\n\t\t\t\t\t\t\tcomment.body = body;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcomment.body = new types.MarkdownString(body);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn comment;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn arg;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tcreateCommentController(extension: IExtensionDescription, id: string, label: string): vscode.CommentController {\n\t\t\tconst handle = ExtHostCommentsImpl.handlePool++;\n\t\t\tconst commentController = new ExtHostCommentController(extension, handle, id, label);\n\t\t\tthis._commentControllers.set(commentController.handle, commentController);\n\n\t\t\tconst commentControllers = this._commentControllersByExtension.get(extension.identifier) || [];\n\t\t\tcommentControllers.push(commentController);\n\t\t\tthis._commentControllersByExtension.set(extension.identifier, commentControllers);\n\n\t\t\treturn commentController.value;\n\t\t}\n\n\t\tasync $createCommentThreadTemplate(commentControllerHandle: number, uriComponents: UriComponents, range: IRange | undefined, editorId?: string): Promise<void> {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tif (!commentController) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcommentController.$createCommentThreadTemplate(uriComponents, range, editorId);\n\t\t}\n\n\t\tasync $setActiveComment(controllerHandle: number, commentInfo: { commentThreadHandle: number; uniqueIdInThread?: number }): Promise<void> {\n\t\t\tconst commentController = this._commentControllers.get(controllerHandle);\n\n\t\t\tif (!commentController) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcommentController.$setActiveComment(commentInfo ?? undefined);\n\t\t}\n\n\t\tasync $updateCommentThreadTemplate(commentControllerHandle: number, threadHandle: number, range: IRange) {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tif (!commentController) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcommentController.$updateCommentThreadTemplate(threadHandle, range);\n\t\t}\n\n\t\t$deleteCommentThread(commentControllerHandle: number, commentThreadHandle: number) {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tcommentController?.$deleteCommentThread(commentThreadHandle);\n\t\t}\n\n\t\tasync $updateCommentThread(commentControllerHandle: number, commentThreadHandle: number, changes: CommentThreadChanges) {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tcommentController?.$updateCommentThread(commentThreadHandle, changes);\n\t\t}\n\n\t\tasync $provideCommentingRanges(commentControllerHandle: number, uriComponents: UriComponents, token: CancellationToken): Promise<{ ranges: IRange[]; fileComments: boolean } | undefined> {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tif (!commentController || !commentController.commentingRangeProvider) {\n\t\t\t\treturn Promise.resolve(undefined);\n\t\t\t}\n\n\t\t\tconst document = await documents.ensureDocumentData(URI.revive(uriComponents));\n\t\t\treturn asPromise(async () => {\n\t\t\t\tconst rangesResult = await commentController.commentingRangeProvider?.provideCommentingRanges(document.document, token);\n\t\t\t\tlet ranges: { ranges: vscode.Range[]; fileComments: boolean } | undefined;\n\t\t\t\tif (Array.isArray(rangesResult)) {\n\t\t\t\t\tranges = {\n\t\t\t\t\t\tranges: rangesResult,\n\t\t\t\t\t\tfileComments: false\n\t\t\t\t\t};\n\t\t\t\t} else if (rangesResult) {\n\t\t\t\t\tranges = {\n\t\t\t\t\t\tranges: rangesResult.ranges || [],\n\t\t\t\t\t\tfileComments: rangesResult.enableFileComments || false\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tranges = rangesResult ?? undefined;\n\t\t\t\t}\n\t\t\t\treturn ranges;\n\t\t\t}).then(ranges => {\n\t\t\t\tlet convertedResult: { ranges: IRange[]; fileComments: boolean } | undefined = undefined;\n\t\t\t\tif (ranges) {\n\t\t\t\t\tconvertedResult = {\n\t\t\t\t\t\tranges: ranges.ranges.map(x => extHostTypeConverter.Range.from(x)),\n\t\t\t\t\t\tfileComments: ranges.fileComments\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\treturn convertedResult;\n\t\t\t});\n\t\t}\n\n\t\t$toggleReaction(commentControllerHandle: number, threadHandle: number, uri: UriComponents, comment: languages.Comment, reaction: languages.CommentReaction): Promise<void> {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tif (!commentController || !commentController.reactionHandler) {\n\t\t\t\treturn Promise.resolve(undefined);\n\t\t\t}\n\n\t\t\treturn asPromise(() => {\n\t\t\t\tconst commentThread = commentController.getCommentThread(threadHandle);\n\t\t\t\tif (commentThread) {\n\t\t\t\t\tconst vscodeComment = commentThread.getCommentByUniqueId(comment.uniqueIdInThread);\n\n\t\t\t\t\tif (commentController !== undefined && vscodeComment) {\n\t\t\t\t\t\tif (commentController.reactionHandler) {\n\t\t\t\t\t\t\treturn commentController.reactionHandler(vscodeComment, convertFromReaction(reaction));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn Promise.resolve(undefined);\n\t\t\t});\n\t\t}\n\t}\n\ttype CommentThreadModification = Partial<{\n\t\trange: vscode.Range;\n\t\tlabel: string | undefined;\n\t\tcontextValue: string | undefined;\n\t\tcomments: vscode.Comment[];\n\t\tcollapsibleState: vscode.CommentThreadCollapsibleState;\n\t\tcanReply: boolean | vscode.CommentAuthorInformation;\n\t\tstate: vscode.CommentThreadState;\n\t\tisTemplate: boolean;\n\t\tapplicability: vscode.CommentThreadApplicability;\n\t}>;\n\n\tclass ExtHostCommentThread implements vscode.CommentThread2 {\n\t\tprivate static _handlePool: number = 0;\n\t\treadonly handle = ExtHostCommentThread._handlePool++;\n\t\tpublic commentHandle: number = 0;\n\n\t\tprivate modifications: CommentThreadModification = Object.create(null);\n\n\t\tset threadId(id: string) {\n\t\t\tthis._id = id;\n\t\t}\n\n\t\tget threadId(): string {\n\t\t\treturn this._id!;\n\t\t}\n\n\t\tget id(): string {\n\t\t\treturn this._id!;\n\t\t}\n\n\t\tget resource(): vscode.Uri {\n\t\t\treturn this._uri;\n\t\t}\n\n\t\tget uri(): vscode.Uri {\n\t\t\treturn this._uri;\n\t\t}\n\n\t\tprivate readonly _onDidUpdateCommentThread = new Emitter<void>();\n\t\treadonly onDidUpdateCommentThread = this._onDidUpdateCommentThread.event;\n\n\t\tset range(range: vscode.Range | undefined) {\n\t\t\tif (((range === undefined) !== (this._range === undefined)) || (!range || !this._range || !range.isEqual(this._range))) {\n\t\t\t\tthis._range = range;\n\t\t\t\tthis.modifications.range = range;\n\t\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t\t}\n\t\t}\n\n\t\tget range(): vscode.Range | undefined {\n\t\t\treturn this._range;\n\t\t}\n\n\t\tprivate _canReply: boolean | vscode.CommentAuthorInformation = true;\n\n\t\tset canReply(state: boolean | vscode.CommentAuthorInformation) {\n\t\t\tif (this._canReply !== state) {\n\t\t\t\tthis._canReply = state;\n\t\t\t\tthis.modifications.canReply = state;\n\t\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t\t}\n\t\t}\n\t\tget canReply() {\n\t\t\treturn this._canReply;\n\t\t}\n\n\t\tprivate _label: string | undefined;\n\n\t\tget label(): string | undefined {\n\t\t\treturn this._label;\n\t\t}\n\n\t\tset label(label: string | undefined) {\n\t\t\tthis._label = label;\n\t\t\tthis.modifications.label = label;\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tprivate _contextValue: string | undefined;\n\n\t\tget contextValue(): string | undefined {\n\t\t\treturn this._contextValue;\n\t\t}\n\n\t\tset contextValue(context: string | undefined) {\n\t\t\tthis._contextValue = context;\n\t\t\tthis.modifications.contextValue = context;\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tget comments(): vscode.Comment[] {\n\t\t\treturn this._comments;\n\t\t}\n\n\t\tset comments(newComments: vscode.Comment[]) {\n\t\t\tthis._comments = newComments;\n\t\t\tthis.modifications.comments = newComments;\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tprivate _collapseState?: vscode.CommentThreadCollapsibleState;\n\n\t\tget collapsibleState(): vscode.CommentThreadCollapsibleState {\n\t\t\treturn this._collapseState!;\n\t\t}\n\n\t\tset collapsibleState(newState: vscode.CommentThreadCollapsibleState) {\n\t\t\tif (this._collapseState === newState) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis._collapseState = newState;\n\t\t\tthis.modifications.collapsibleState = newState;\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tprivate _state?: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability };\n\n\t\tget state(): vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability } | undefined {\n\t\t\treturn this._state!;\n\t\t}\n\n\t\tset state(newState: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability }) {\n\t\t\tthis._state = newState;\n\t\t\tif (typeof newState === 'object') {\n\t\t\t\tcheckProposedApiEnabled(this.extensionDescription, 'commentThreadApplicability');\n\t\t\t\tthis.modifications.state = newState.resolved;\n\t\t\t\tthis.modifications.applicability = newState.applicability;\n\t\t\t} else {\n\t\t\t\tthis.modifications.state = newState;\n\t\t\t}\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tprivate _localDisposables: types.Disposable[];\n\n\t\tprivate _isDiposed: boolean;\n\n\t\tpublic get isDisposed(): boolean {\n\t\t\treturn this._isDiposed;\n\t\t}\n\n\t\tprivate _commentsMap: Map<vscode.Comment, number> = new Map<vscode.Comment, number>();\n\n\t\tprivate readonly _acceptInputDisposables = new MutableDisposable<DisposableStore>();\n\n\t\treadonly value: vscode.CommentThread2;\n\n\t\tconstructor(\n\t\t\tcommentControllerId: string,\n\t\t\tprivate _commentControllerHandle: number,\n\t\t\tprivate _id: string | undefined,\n\t\t\tprivate _uri: vscode.Uri,\n\t\t\tprivate _range: vscode.Range | undefined,\n\t\t\tprivate _comments: vscode.Comment[],\n\t\t\tpublic readonly extensionDescription: IExtensionDescription,\n\t\t\tprivate _isTemplate: boolean,\n\t\t\teditorId?: string\n\t\t) {\n\t\t\tthis._acceptInputDisposables.value = new DisposableStore();\n\n\t\t\tif (this._id === undefined) {\n\t\t\t\tthis._id = `${commentControllerId}.${this.handle}`;\n\t\t\t}\n\n\t\t\tproxy.$createCommentThread(\n\t\t\t\t_commentControllerHandle,\n\t\t\t\tthis.handle,\n\t\t\t\tthis._id,\n\t\t\t\tthis._uri,\n\t\t\t\textHostTypeConverter.Range.from(this._range),\n\t\t\t\tthis._comments.map(cmt => convertToDTOComment(this, cmt, this._commentsMap, this.extensionDescription)),\n\t\t\t\textensionDescription.identifier,\n\t\t\t\tthis._isTemplate,\n\t\t\t\teditorId\n\t\t\t);\n\n\t\t\tthis._localDisposables = [];\n\t\t\tthis._isDiposed = false;\n\n\t\t\tthis._localDisposables.push(this.onDidUpdateCommentThread(() => {\n\t\t\t\tthis.eventuallyUpdateCommentThread();\n\t\t\t}));\n\n\t\t\tthis._localDisposables.push({\n\t\t\t\tdispose: () => {\n\t\t\t\t\tproxy.$deleteCommentThread(\n\t\t\t\t\t\t_commentControllerHandle,\n\t\t\t\t\t\tthis.handle\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconst that = this;\n\t\t\tthis.value = {\n\t\t\t\tget uri() { return that.uri; },\n\t\t\t\tget range() { return that.range; },\n\t\t\t\tset range(value: vscode.Range | undefined) { that.range = value; },\n\t\t\t\tget comments() { return that.comments; },\n\t\t\t\tset comments(value: vscode.Comment[]) { that.comments = value; },\n\t\t\t\tget collapsibleState() { return that.collapsibleState; },\n\t\t\t\tset collapsibleState(value: vscode.CommentThreadCollapsibleState) { that.collapsibleState = value; },\n\t\t\t\tget canReply() { return that.canReply; },\n\t\t\t\tset canReply(state: boolean | vscode.CommentAuthorInformation) { that.canReply = state; },\n\t\t\t\tget contextValue() { return that.contextValue; },\n\t\t\t\tset contextValue(value: string | undefined) { that.contextValue = value; },\n\t\t\t\tget label() { return that.label; },\n\t\t\t\tset label(value: string | undefined) { that.label = value; },\n\t\t\t\tget state(): vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability } | undefined { return that.state; },\n\t\t\t\tset state(value: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability }) { that.state = value; },\n\t\t\t\treveal: (comment?: vscode.Comment | vscode.CommentThreadRevealOptions, options?: vscode.CommentThreadRevealOptions) => that.reveal(comment, options),\n\t\t\t\thide: () => that.hide(),\n\t\t\t\tdispose: () => {\n\t\t\t\t\tthat.dispose();\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\tprivate updateIsTemplate() {\n\t\t\tif (this._isTemplate) {\n\t\t\t\tthis._isTemplate = false;\n\t\t\t\tthis.modifications.isTemplate = false;\n\t\t\t}\n\t\t}\n\n\t\t@debounce(100)\n\t\teventuallyUpdateCommentThread(): void {\n\t\t\tif (this._isDiposed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.updateIsTemplate();\n\n\t\t\tif (!this._acceptInputDisposables.value) {\n\t\t\t\tthis._acceptInputDisposables.value = new DisposableStore();\n\t\t\t}\n\n\t\t\tconst modified = (value: keyof CommentThreadModification): boolean =>\n\t\t\t\tObject.prototype.hasOwnProperty.call(this.modifications, value);\n\n\t\t\tconst formattedModifications: CommentThreadChanges = {};\n\t\t\tif (modified('range')) {\n\t\t\t\tformattedModifications.range = extHostTypeConverter.Range.from(this._range);\n\t\t\t}\n\t\t\tif (modified('label')) {\n\t\t\t\tformattedModifications.label = this.label;\n\t\t\t}\n\t\t\tif (modified('contextValue')) {\n\t\t\t\t/*\n\t\t\t\t * null -> cleared contextValue\n\t\t\t\t * undefined -> no change\n\t\t\t\t */\n\t\t\t\tformattedModifications.contextValue = this.contextValue ?? null;\n\t\t\t}\n\t\t\tif (modified('comments')) {\n\t\t\t\tformattedModifications.comments =\n\t\t\t\t\tthis._comments.map(cmt => convertToDTOComment(this, cmt, this._commentsMap, this.extensionDescription));\n\t\t\t}\n\t\t\tif (modified('collapsibleState')) {\n\t\t\t\tformattedModifications.collapseState = convertToCollapsibleState(this._collapseState);\n\t\t\t}\n\t\t\tif (modified('canReply')) {\n\t\t\t\tformattedModifications.canReply = this.canReply;\n\t\t\t}\n\t\t\tif (modified('state')) {\n\t\t\t\tformattedModifications.state = convertToState(this._state);\n\t\t\t}\n\t\t\tif (modified('applicability')) {\n\t\t\t\tformattedModifications.applicability = convertToRelevance(this._state);\n\t\t\t}\n\t\t\tif (modified('isTemplate')) {\n\t\t\t\tformattedModifications.isTemplate = this._isTemplate;\n\t\t\t}\n\t\t\tthis.modifications = {};\n\n\t\t\tproxy.$updateCommentThread(\n\t\t\t\tthis._commentControllerHandle,\n\t\t\t\tthis.handle,\n\t\t\t\tthis._id!,\n\t\t\t\tthis._uri,\n\t\t\t\tformattedModifications\n\t\t\t);\n\t\t}\n\n\t\tgetCommentByUniqueId(uniqueId: number): vscode.Comment | undefined {\n\t\t\tfor (const key of this._commentsMap) {\n\t\t\t\tconst comment = key[0];\n\t\t\t\tconst id = key[1];\n\t\t\t\tif (uniqueId === id) {\n\t\t\t\t\treturn comment;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tasync reveal(commentOrOptions?: vscode.Comment | vscode.CommentThreadRevealOptions, options?: vscode.CommentThreadRevealOptions): Promise<void> {\n\t\t\tcheckProposedApiEnabled(this.extensionDescription, 'commentReveal');\n\t\t\tlet comment: vscode.Comment | undefined;\n\t\t\tif (commentOrOptions && (commentOrOptions as vscode.Comment).body !== undefined) {\n\t\t\t\tcomment = commentOrOptions as vscode.Comment;\n\t\t\t} else {\n\t\t\t\toptions = options ?? commentOrOptions as vscode.CommentThreadRevealOptions;\n\t\t\t}\n\t\t\tlet commentToReveal = comment ? this._commentsMap.get(comment) : undefined;\n\t\t\tcommentToReveal ??= this._commentsMap.get(this._comments[0])!;\n\t\t\tlet preserveFocus: boolean = true;\n\t\t\tlet focusReply: boolean = false;\n\t\t\tif (options?.focus === types.CommentThreadFocus.Reply) {\n\t\t\t\tfocusReply = true;\n\t\t\t\tpreserveFocus = false;\n\t\t\t} else if (options?.focus === types.CommentThreadFocus.Comment) {\n\t\t\t\tpreserveFocus = false;\n\t\t\t}\n\t\t\treturn proxy.$revealCommentThread(this._commentControllerHandle, this.handle, commentToReveal, { preserveFocus, focusReply });\n\t\t}\n\n\t\tasync hide(): Promise<void> {\n\t\t\treturn proxy.$hideCommentThread(this._commentControllerHandle, this.handle);\n\t\t}\n\n\t\tdispose() {\n\t\t\tthis._isDiposed = true;\n\t\t\tthis._acceptInputDisposables.dispose();\n\t\t\tthis._localDisposables.forEach(disposable => disposable.dispose());\n\t\t}\n\t}\n\n\ttype ReactionHandler = (comment: vscode.Comment, reaction: vscode.CommentReaction) => Promise<void>;\n\n\tclass ExtHostCommentController {\n\t\tget id(): string {\n\t\t\treturn this._id;\n\t\t}\n\n\t\tget label(): string {\n\t\t\treturn this._label;\n\t\t}\n\n\t\tpublic get handle(): number {\n\t\t\treturn this._handle;\n\t\t}\n\n\t\tprivate _threads: Map<number, ExtHostCommentThread> = new Map<number, ExtHostCommentThread>();\n\n\t\tprivate _commentingRangeProvider?: vscode.CommentingRangeProvider;\n\t\tget commentingRangeProvider(): vscode.CommentingRangeProvider | undefined {\n\t\t\treturn this._commentingRangeProvider;\n\t\t}\n\n\t\tset commentingRangeProvider(provider: vscode.CommentingRangeProvider | undefined) {\n\t\t\tthis._commentingRangeProvider = provider;\n\t\t\tif (provider?.resourceHints) {\n\t\t\t\tcheckProposedApiEnabled(this._extension, 'commentingRangeHint');\n\t\t\t}\n\t\t\tproxy.$updateCommentingRanges(this.handle, provider?.resourceHints);\n\t\t}\n\n\t\tprivate _reactionHandler?: ReactionHandler;\n\n\t\tget reactionHandler(): ReactionHandler | undefined {\n\t\t\treturn this._reactionHandler;\n\t\t}\n\n\t\tset reactionHandler(handler: ReactionHandler | undefined) {\n\t\t\tthis._reactionHandler = handler;\n\n\t\t\tproxy.$updateCommentControllerFeatures(this.handle, { reactionHandler: !!handler });\n\t\t}\n\n\t\tprivate _options: languages.CommentOptions | undefined;\n\n\t\tget options() {\n\t\t\treturn this._options;\n\t\t}\n\n\t\tset options(options: languages.CommentOptions | undefined) {\n\t\t\tthis._options = options;\n\n\t\t\tproxy.$updateCommentControllerFeatures(this.handle, { options: this._options });\n\t\t}\n\n\t\tprivate _activeComment: vscode.Comment | undefined;\n\n\t\tget activeComment(): vscode.Comment | undefined {\n\t\t\tcheckProposedApiEnabled(this._extension, 'activeComment');\n\t\t\treturn this._activeComment;\n\t\t}\n\n\t\tprivate _activeThread: ExtHostCommentThread | undefined;\n\n\t\tget activeCommentThread(): vscode.CommentThread2 | undefined {\n\t\t\tcheckProposedApiEnabled(this._extension, 'activeComment');\n\t\t\treturn this._activeThread?.value;\n\t\t}\n\n\t\tprivate _localDisposables: types.Disposable[];\n\t\treadonly value: vscode.CommentController;\n\n\t\tconstructor(\n\t\t\tprivate _extension: IExtensionDescription,\n\t\t\tprivate _handle: number,\n\t\t\tprivate _id: string,\n\t\t\tprivate _label: string\n\t\t) {\n\t\t\tproxy.$registerCommentController(this.handle, _id, _label, this._extension.identifier.value);\n\n\t\t\tconst that = this;\n\t\t\tthis.value = Object.freeze({\n\t\t\t\tid: that.id,\n\t\t\t\tlabel: that.label,\n\t\t\t\tget options() { return that.options; },\n\t\t\t\tset options(options: vscode.CommentOptions | undefined) { that.options = options; },\n\t\t\t\tget commentingRangeProvider(): vscode.CommentingRangeProvider | undefined { return that.commentingRangeProvider; },\n\t\t\t\tset commentingRangeProvider(commentingRangeProvider: vscode.CommentingRangeProvider | undefined) { that.commentingRangeProvider = commentingRangeProvider; },\n\t\t\t\tget reactionHandler(): ReactionHandler | undefined { return that.reactionHandler; },\n\t\t\t\tset reactionHandler(handler: ReactionHandler | undefined) { that.reactionHandler = handler; },\n\t\t\t\t// get activeComment(): vscode.Comment | undefined { return that.activeComment; },\n\t\t\t\tget activeCommentThread(): vscode.CommentThread | undefined { return that.activeCommentThread as vscode.CommentThread | undefined; },\n\t\t\t\tcreateCommentThread(uri: vscode.Uri, range: vscode.Range | undefined, comments: vscode.Comment[]): vscode.CommentThread {\n\t\t\t\t\treturn that.createCommentThread(uri, range, comments).value as vscode.CommentThread;\n\t\t\t\t},\n\t\t\t\tdispose: () => { that.dispose(); },\n\t\t\t});\n\n\t\t\tthis._localDisposables = [];\n\t\t\tthis._localDisposables.push({\n\t\t\t\tdispose: () => {\n\t\t\t\t\tproxy.$unregisterCommentController(this.handle);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tcreateCommentThread(resource: vscode.Uri, range: vscode.Range | undefined, comments: vscode.Comment[]): ExtHostCommentThread {\n\t\t\tconst commentThread = new ExtHostCommentThread(this.id, this.handle, undefined, resource, range, comments, this._extension, false);\n\t\t\tthis._threads.set(commentThread.handle, commentThread);\n\t\t\treturn commentThread;\n\t\t}\n\n\t\t$setActiveComment(commentInfo: { commentThreadHandle: number; uniqueIdInThread?: number } | undefined) {\n\t\t\tif (!commentInfo) {\n\t\t\t\tthis._activeComment = undefined;\n\t\t\t\tthis._activeThread = undefined;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst thread = this._threads.get(commentInfo.commentThreadHandle);\n\t\t\tif (thread) {\n\t\t\t\tthis._activeComment = commentInfo.uniqueIdInThread ? thread.getCommentByUniqueId(commentInfo.uniqueIdInThread) : undefined;\n\t\t\t\tthis._activeThread = thread;\n\t\t\t}\n\t\t}\n\n\t\t$createCommentThreadTemplate(uriComponents: UriComponents, range: IRange | undefined, editorId?: string): ExtHostCommentThread {\n\t\t\tconst commentThread = new ExtHostCommentThread(this.id, this.handle, undefined, URI.revive(uriComponents), extHostTypeConverter.Range.to(range), [], this._extension, true, editorId);\n\t\t\tcommentThread.collapsibleState = languages.CommentThreadCollapsibleState.Expanded;\n\t\t\tthis._threads.set(commentThread.handle, commentThread);\n\t\t\treturn commentThread;\n\t\t}\n\n\t\t$updateCommentThreadTemplate(threadHandle: number, range: IRange): void {\n\t\t\tconst thread = this._threads.get(threadHandle);\n\t\t\tif (thread) {\n\t\t\t\tthread.range = extHostTypeConverter.Range.to(range);\n\t\t\t}\n\t\t}\n\n\t\t$updateCommentThread(threadHandle: number, changes: CommentThreadChanges): void {\n\t\t\tconst thread = this._threads.get(threadHandle);\n\t\t\tif (!thread) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst modified = (value: keyof CommentThreadChanges): boolean =>\n\t\t\t\tObject.prototype.hasOwnProperty.call(changes, value);\n\n\t\t\tif (modified('collapseState')) {\n\t\t\t\tthread.collapsibleState = convertToCollapsibleState(changes.collapseState);\n\t\t\t}\n\t\t}\n\n\t\t$deleteCommentThread(threadHandle: number): void {\n\t\t\tconst thread = this._threads.get(threadHandle);\n\n\t\t\tthread?.dispose();\n\n\t\t\tthis._threads.delete(threadHandle);\n\t\t}\n\n\t\tgetCommentThread(handle: number): ExtHostCommentThread | undefined {\n\t\t\treturn this._threads.get(handle);\n\t\t}\n\n\t\tdispose(): void {\n\t\t\tthis._threads.forEach(value => {\n\t\t\t\tvalue.dispose();\n\t\t\t});\n\n\t\t\tthis._localDisposables.forEach(disposable => disposable.dispose());\n\t\t}\n\t}\n\n\tfunction convertToDTOComment(thread: ExtHostCommentThread, vscodeComment: vscode.Comment, commentsMap: Map<vscode.Comment, number>, extension: IExtensionDescription): CommentChanges {\n\t\tlet commentUniqueId = commentsMap.get(vscodeComment)!;\n\t\tif (!commentUniqueId) {\n\t\t\tcommentUniqueId = ++thread.commentHandle;\n\t\t\tcommentsMap.set(vscodeComment, commentUniqueId);\n\t\t}\n\n\t\tif (vscodeComment.state !== undefined) {\n\t\t\tcheckProposedApiEnabled(extension, 'commentsDraftState');\n\t\t}\n\n\t\tif (vscodeComment.reactions?.some(reaction => reaction.reactors !== undefined)) {\n\t\t\tcheckProposedApiEnabled(extension, 'commentReactor');\n\t\t}\n\n\t\treturn {\n\t\t\tmode: vscodeComment.mode,\n\t\t\tcontextValue: vscodeComment.contextValue,\n\t\t\tuniqueIdInThread: commentUniqueId,\n\t\t\tbody: (typeof vscodeComment.body === 'string') ? vscodeComment.body : extHostTypeConverter.MarkdownString.from(vscodeComment.body),\n\t\t\tuserName: vscodeComment.author.name,\n\t\t\tuserIconPath: vscodeComment.author.iconPath,\n\t\t\tlabel: vscodeComment.label,\n\t\t\tcommentReactions: vscodeComment.reactions ? vscodeComment.reactions.map(reaction => convertToReaction(reaction)) : undefined,\n\t\t\tstate: vscodeComment.state,\n\t\t\ttimestamp: vscodeComment.timestamp?.toJSON()\n\t\t};\n\t}\n\n\tfunction convertToReaction(reaction: vscode.CommentReaction): languages.CommentReaction {\n\t\treturn {\n\t\t\tlabel: reaction.label,\n\t\t\ticonPath: reaction.iconPath ? extHostTypeConverter.pathOrURIToURI(reaction.iconPath) : undefined,\n\t\t\tcount: reaction.count,\n\t\t\thasReacted: reaction.authorHasReacted,\n\t\t\treactors: ((reaction.reactors && (reaction.reactors.length > 0) && (typeof reaction.reactors[0] !== 'string')) ? (reaction.reactors as languages.CommentAuthorInformation[]).map(reactor => reactor.name) : reaction.reactors) as string[]\n\t\t};\n\t}\n\n\tfunction convertFromReaction(reaction: languages.CommentReaction): vscode.CommentReaction {\n\t\treturn {\n\t\t\tlabel: reaction.label || '',\n\t\t\tcount: reaction.count || 0,\n\t\t\ticonPath: reaction.iconPath ? URI.revive(reaction.iconPath) : '',\n\t\t\tauthorHasReacted: reaction.hasReacted || false,\n\t\t\treactors: reaction.reactors?.map(reactor => ({ name: reactor }))\n\t\t};\n\t}\n\n\tfunction convertToCollapsibleState(kind: vscode.CommentThreadCollapsibleState | undefined): languages.CommentThreadCollapsibleState {\n\t\tif (kind !== undefined) {\n\t\t\tswitch (kind) {\n\t\t\t\tcase types.CommentThreadCollapsibleState.Expanded:\n\t\t\t\t\treturn languages.CommentThreadCollapsibleState.Expanded;\n\t\t\t\tcase types.CommentThreadCollapsibleState.Collapsed:\n\t\t\t\t\treturn languages.CommentThreadCollapsibleState.Collapsed;\n\t\t\t}\n\t\t}\n\t\treturn languages.CommentThreadCollapsibleState.Collapsed;\n\t}\n\n\tfunction convertToState(kind: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability } | undefined): languages.CommentThreadState {\n\t\tlet resolvedKind: vscode.CommentThreadState | undefined;\n\t\tif (typeof kind === 'object') {\n\t\t\tresolvedKind = kind.resolved;\n\t\t} else {\n\t\t\tresolvedKind = kind;\n\t\t}\n\n\t\tif (resolvedKind !== undefined) {\n\t\t\tswitch (resolvedKind) {\n\t\t\t\tcase types.CommentThreadState.Unresolved:\n\t\t\t\t\treturn languages.CommentThreadState.Unresolved;\n\t\t\t\tcase types.CommentThreadState.Resolved:\n\t\t\t\t\treturn languages.CommentThreadState.Resolved;\n\t\t\t}\n\t\t}\n\t\treturn languages.CommentThreadState.Unresolved;\n\t}\n\n\tfunction convertToRelevance(kind: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability } | undefined): languages.CommentThreadApplicability {\n\t\tlet applicabilityKind: vscode.CommentThreadApplicability | undefined = undefined;\n\t\tif (typeof kind === 'object') {\n\t\t\tapplicabilityKind = kind.applicability;\n\t\t}\n\n\t\tif (applicabilityKind !== undefined) {\n\t\t\tswitch (applicabilityKind) {\n\t\t\t\tcase types.CommentThreadApplicability.Current:\n\t\t\t\t\treturn languages.CommentThreadApplicability.Current;\n\t\t\t\tcase types.CommentThreadApplicability.Outdated:\n\t\t\t\t\treturn languages.CommentThreadApplicability.Outdated;\n\t\t\t}\n\t\t}\n\t\treturn languages.CommentThreadApplicability.Current;\n\t}\n\n\treturn new ExtHostCommentsImpl();\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { asPromise } from '../../../base/common/async.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { debounce } from '../../../base/common/decorators.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { DisposableStore, MutableDisposable } from '../../../base/common/lifecycle.js';\nimport { MarshalledId } from '../../../base/common/marshallingIds.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { IRange } from '../../../editor/common/core/range.js';\nimport * as languages from '../../../editor/common/languages.js';\nimport { ExtensionIdentifierMap, IExtensionDescription } from '../../../platform/extensions/common/extensions.js';\nimport { ExtHostDocuments } from './extHostDocuments.js';\nimport * as extHostTypeConverter from './extHostTypeConverters.js';\nimport * as types from './extHostTypes.js';\nimport type * as vscode from 'vscode';\nimport { ExtHostCommentsShape, IMainContext, MainContext, CommentThreadChanges, CommentChanges } from './extHost.protocol.js';\nimport { ExtHostCommands } from './extHostCommands.js';\nimport { checkProposedApiEnabled } from '../../services/extensions/common/extensions.js';\nimport { MarshalledCommentThread } from '../../common/comments.js';\n\ntype ProviderHandle = number;\n\ninterface ExtHostComments {\n\tcreateCommentController(extension: IExtensionDescription, id: string, label: string): vscode.CommentController;\n}\n\nexport function createExtHostComments(mainContext: IMainContext, commands: ExtHostCommands, documents: ExtHostDocuments): ExtHostCommentsShape & ExtHostComments {\n\tconst proxy = mainContext.getProxy(MainContext.MainThreadComments);\n\n\tclass ExtHostCommentsImpl implements ExtHostCommentsShape, ExtHostComments {\n\n\t\tprivate static handlePool = 0;\n\n\n\t\tprivate _commentControllers: Map<ProviderHandle, ExtHostCommentController> = new Map<ProviderHandle, ExtHostCommentController>();\n\n\t\tprivate _commentControllersByExtension: ExtensionIdentifierMap<ExtHostCommentController[]> = new ExtensionIdentifierMap<ExtHostCommentController[]>();\n\n\n\t\tconstructor(\n\t\t) {\n\t\t\tcommands.registerArgumentProcessor({\n\t\t\t\tprocessArgument: arg => {\n\t\t\t\t\tif (arg && arg.$mid === MarshalledId.CommentController) {\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(arg.handle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn commentController.value;\n\t\t\t\t\t} else if (arg && arg.$mid === MarshalledId.CommentThread) {\n\t\t\t\t\t\tconst marshalledCommentThread: MarshalledCommentThread = arg;\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(marshalledCommentThread.commentControlHandle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn marshalledCommentThread;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentThread = commentController.getCommentThread(marshalledCommentThread.commentThreadHandle);\n\n\t\t\t\t\t\tif (!commentThread) {\n\t\t\t\t\t\t\treturn marshalledCommentThread;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn commentThread.value;\n\t\t\t\t\t} else if (arg && (arg.$mid === MarshalledId.CommentThreadReply || arg.$mid === MarshalledId.CommentThreadInstance)) {\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(arg.thread.commentControlHandle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentThread = commentController.getCommentThread(arg.thread.commentThreadHandle);\n\n\t\t\t\t\t\tif (!commentThread) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (arg.$mid === MarshalledId.CommentThreadInstance) {\n\t\t\t\t\t\t\treturn commentThread.value;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tthread: commentThread.value,\n\t\t\t\t\t\t\ttext: arg.text\n\t\t\t\t\t\t};\n\t\t\t\t\t} else if (arg && arg.$mid === MarshalledId.CommentNode) {\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(arg.thread.commentControlHandle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentThread = commentController.getCommentThread(arg.thread.commentThreadHandle);\n\n\t\t\t\t\t\tif (!commentThread) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentUniqueId = arg.commentUniqueId;\n\n\t\t\t\t\t\tconst comment = commentThread.getCommentByUniqueId(commentUniqueId);\n\n\t\t\t\t\t\tif (!comment) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn comment;\n\n\t\t\t\t\t} else if (arg && arg.$mid === MarshalledId.CommentThreadNode) {\n\t\t\t\t\t\tconst commentController = this._commentControllers.get(arg.thread.commentControlHandle);\n\n\t\t\t\t\t\tif (!commentController) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst commentThread = commentController.getCommentThread(arg.thread.commentThreadHandle);\n\n\t\t\t\t\t\tif (!commentThread) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst body: string = arg.text;\n\t\t\t\t\t\tconst commentUniqueId = arg.commentUniqueId;\n\n\t\t\t\t\t\tconst comment = commentThread.getCommentByUniqueId(commentUniqueId);\n\n\t\t\t\t\t\tif (!comment) {\n\t\t\t\t\t\t\treturn arg;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// If the old comment body was a markdown string, use a markdown string here too.\n\t\t\t\t\t\tif (typeof comment.body === 'string') {\n\t\t\t\t\t\t\tcomment.body = body;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcomment.body = new types.MarkdownString(body);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn comment;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn arg;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tcreateCommentController(extension: IExtensionDescription, id: string, label: string): vscode.CommentController {\n\t\t\tconst handle = ExtHostCommentsImpl.handlePool++;\n\t\t\tconst commentController = new ExtHostCommentController(extension, handle, id, label);\n\t\t\tthis._commentControllers.set(commentController.handle, commentController);\n\n\t\t\tconst commentControllers = this._commentControllersByExtension.get(extension.identifier) || [];\n\t\t\tcommentControllers.push(commentController);\n\t\t\tthis._commentControllersByExtension.set(extension.identifier, commentControllers);\n\n\t\t\treturn commentController.value;\n\t\t}\n\n\t\tasync $createCommentThreadTemplate(commentControllerHandle: number, uriComponents: UriComponents, range: IRange | undefined, editorId?: string): Promise<void> {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tif (!commentController) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcommentController.$createCommentThreadTemplate(uriComponents, range, editorId);\n\t\t}\n\n\t\tasync $setActiveComment(controllerHandle: number, commentInfo: { commentThreadHandle: number; uniqueIdInThread?: number }): Promise<void> {\n\t\t\tconst commentController = this._commentControllers.get(controllerHandle);\n\n\t\t\tif (!commentController) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcommentController.$setActiveComment(commentInfo ?? undefined);\n\t\t}\n\n\t\tasync $updateCommentThreadTemplate(commentControllerHandle: number, threadHandle: number, range: IRange) {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tif (!commentController) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcommentController.$updateCommentThreadTemplate(threadHandle, range);\n\t\t}\n\n\t\t$deleteCommentThread(commentControllerHandle: number, commentThreadHandle: number) {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tcommentController?.$deleteCommentThread(commentThreadHandle);\n\t\t}\n\n\t\tasync $updateCommentThread(commentControllerHandle: number, commentThreadHandle: number, changes: CommentThreadChanges) {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tcommentController?.$updateCommentThread(commentThreadHandle, changes);\n\t\t}\n\n\t\tasync $provideCommentingRanges(commentControllerHandle: number, uriComponents: UriComponents, token: CancellationToken): Promise<{ ranges: IRange[]; fileComments: boolean } | undefined> {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tif (!commentController || !commentController.commentingRangeProvider) {\n\t\t\t\treturn Promise.resolve(undefined);\n\t\t\t}\n\n\t\t\tconst document = await documents.ensureDocumentData(URI.revive(uriComponents));\n\t\t\treturn asPromise(async () => {\n\t\t\t\tconst rangesResult = await commentController.commentingRangeProvider?.provideCommentingRanges(document.document, token);\n\t\t\t\tlet ranges: { ranges: vscode.Range[]; fileComments: boolean } | undefined;\n\t\t\t\tif (Array.isArray(rangesResult)) {\n\t\t\t\t\tranges = {\n\t\t\t\t\t\tranges: rangesResult,\n\t\t\t\t\t\tfileComments: false\n\t\t\t\t\t};\n\t\t\t\t} else if (rangesResult) {\n\t\t\t\t\tranges = {\n\t\t\t\t\t\tranges: rangesResult.ranges || [],\n\t\t\t\t\t\tfileComments: rangesResult.enableFileComments || false\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tranges = rangesResult ?? undefined;\n\t\t\t\t}\n\t\t\t\treturn ranges;\n\t\t\t}).then(ranges => {\n\t\t\t\tlet convertedResult: { ranges: IRange[]; fileComments: boolean } | undefined = undefined;\n\t\t\t\tif (ranges) {\n\t\t\t\t\tconvertedResult = {\n\t\t\t\t\t\tranges: ranges.ranges.map(x => extHostTypeConverter.Range.from(x)),\n\t\t\t\t\t\tfileComments: ranges.fileComments\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\treturn convertedResult;\n\t\t\t});\n\t\t}\n\n\t\t$toggleReaction(commentControllerHandle: number, threadHandle: number, uri: UriComponents, comment: languages.Comment, reaction: languages.CommentReaction): Promise<void> {\n\t\t\tconst commentController = this._commentControllers.get(commentControllerHandle);\n\n\t\t\tif (!commentController || !commentController.reactionHandler) {\n\t\t\t\treturn Promise.resolve(undefined);\n\t\t\t}\n\n\t\t\treturn asPromise(() => {\n\t\t\t\tconst commentThread = commentController.getCommentThread(threadHandle);\n\t\t\t\tif (commentThread) {\n\t\t\t\t\tconst vscodeComment = commentThread.getCommentByUniqueId(comment.uniqueIdInThread);\n\n\t\t\t\t\tif (commentController !== undefined && vscodeComment) {\n\t\t\t\t\t\tif (commentController.reactionHandler) {\n\t\t\t\t\t\t\treturn commentController.reactionHandler(vscodeComment, convertFromReaction(reaction));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn Promise.resolve(undefined);\n\t\t\t});\n\t\t}\n\t}\n\ttype CommentThreadModification = Partial<{\n\t\trange: vscode.Range;\n\t\tlabel: string | undefined;\n\t\tcontextValue: string | undefined;\n\t\tcomments: vscode.Comment[];\n\t\tcollapsibleState: vscode.CommentThreadCollapsibleState;\n\t\tcanReply: boolean | vscode.CommentAuthorInformation;\n\t\tstate: vscode.CommentThreadState;\n\t\tisTemplate: boolean;\n\t\tapplicability: vscode.CommentThreadApplicability;\n\t}>;\n\n\tclass ExtHostCommentThread implements vscode.CommentThread2 {\n\t\tprivate static _handlePool: number = 0;\n\t\treadonly handle = ExtHostCommentThread._handlePool++;\n\t\tpublic commentHandle: number = 0;\n\n\t\tprivate modifications: CommentThreadModification = Object.create(null);\n\n\t\tset threadId(id: string) {\n\t\t\tthis._id = id;\n\t\t}\n\n\t\tget threadId(): string {\n\t\t\treturn this._id!;\n\t\t}\n\n\t\tget id(): string {\n\t\t\treturn this._id!;\n\t\t}\n\n\t\tget resource(): vscode.Uri {\n\t\t\treturn this._uri;\n\t\t}\n\n\t\tget uri(): vscode.Uri {\n\t\t\treturn this._uri;\n\t\t}\n\n\t\tprivate readonly _onDidUpdateCommentThread = new Emitter<void>();\n\t\treadonly onDidUpdateCommentThread = this._onDidUpdateCommentThread.event;\n\n\t\tset range(range: vscode.Range | undefined) {\n\t\t\tif (((range === undefined) !== (this._range === undefined)) || (!range || !this._range || !range.isEqual(this._range))) {\n\t\t\t\tthis._range = range;\n\t\t\t\tthis.modifications.range = range;\n\t\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t\t}\n\t\t}\n\n\t\tget range(): vscode.Range | undefined {\n\t\t\treturn this._range;\n\t\t}\n\n\t\tprivate _canReply: boolean | vscode.CommentAuthorInformation = true;\n\n\t\tset canReply(state: boolean | vscode.CommentAuthorInformation) {\n\t\t\tif (this._canReply !== state) {\n\t\t\t\tthis._canReply = state;\n\t\t\t\tthis.modifications.canReply = state;\n\t\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t\t}\n\t\t}\n\t\tget canReply() {\n\t\t\treturn this._canReply;\n\t\t}\n\n\t\tprivate _label: string | undefined;\n\n\t\tget label(): string | undefined {\n\t\t\treturn this._label;\n\t\t}\n\n\t\tset label(label: string | undefined) {\n\t\t\tthis._label = label;\n\t\t\tthis.modifications.label = label;\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tprivate _contextValue: string | undefined;\n\n\t\tget contextValue(): string | undefined {\n\t\t\treturn this._contextValue;\n\t\t}\n\n\t\tset contextValue(context: string | undefined) {\n\t\t\tthis._contextValue = context;\n\t\t\tthis.modifications.contextValue = context;\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tget comments(): vscode.Comment[] {\n\t\t\treturn this._comments;\n\t\t}\n\n\t\tset comments(newComments: vscode.Comment[]) {\n\t\t\tthis._comments = newComments;\n\t\t\tthis.modifications.comments = newComments;\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tprivate _collapseState?: vscode.CommentThreadCollapsibleState;\n\n\t\tget collapsibleState(): vscode.CommentThreadCollapsibleState {\n\t\t\treturn this._collapseState!;\n\t\t}\n\n\t\tset collapsibleState(newState: vscode.CommentThreadCollapsibleState) {\n\t\t\tif (this._collapseState === newState) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis._collapseState = newState;\n\t\t\tthis.modifications.collapsibleState = newState;\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tprivate _state?: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability };\n\n\t\tget state(): vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability } | undefined {\n\t\t\treturn this._state!;\n\t\t}\n\n\t\tset state(newState: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability }) {\n\t\t\tthis._state = newState;\n\t\t\tif (typeof newState === 'object') {\n\t\t\t\tcheckProposedApiEnabled(this.extensionDescription, 'commentThreadApplicability');\n\t\t\t\tthis.modifications.state = newState.resolved;\n\t\t\t\tthis.modifications.applicability = newState.applicability;\n\t\t\t} else {\n\t\t\t\tthis.modifications.state = newState;\n\t\t\t}\n\t\t\tthis._onDidUpdateCommentThread.fire();\n\t\t}\n\n\t\tprivate _localDisposables: types.Disposable[];\n\n\t\tprivate _isDiposed: boolean;\n\n\t\tpublic get isDisposed(): boolean {\n\t\t\treturn this._isDiposed;\n\t\t}\n\n\t\tprivate _commentsMap: Map<vscode.Comment, number> = new Map<vscode.Comment, number>();\n\n\t\tprivate readonly _acceptInputDisposables = new MutableDisposable<DisposableStore>();\n\n\t\treadonly value: vscode.CommentThread2;\n\n\t\tconstructor(\n\t\t\tcommentControllerId: string,\n\t\t\tprivate _commentControllerHandle: number,\n\t\t\tprivate _id: string | undefined,\n\t\t\tprivate _uri: vscode.Uri,\n\t\t\tprivate _range: vscode.Range | undefined,\n\t\t\tprivate _comments: vscode.Comment[],\n\t\t\tpublic readonly extensionDescription: IExtensionDescription,\n\t\t\tprivate _isTemplate: boolean,\n\t\t\teditorId?: string\n\t\t) {\n\t\t\tthis._acceptInputDisposables.value = new DisposableStore();\n\n\t\t\tif (this._id === undefined) {\n\t\t\t\tthis._id = `${commentControllerId}.${this.handle}`;\n\t\t\t}\n\n\t\t\tproxy.$createCommentThread(\n\t\t\t\t_commentControllerHandle,\n\t\t\t\tthis.handle,\n\t\t\t\tthis._id,\n\t\t\t\tthis._uri,\n\t\t\t\textHostTypeConverter.Range.from(this._range),\n\t\t\t\tthis._comments.map(cmt => convertToDTOComment(this, cmt, this._commentsMap, this.extensionDescription)),\n\t\t\t\textensionDescription.identifier,\n\t\t\t\tthis._isTemplate,\n\t\t\t\teditorId\n\t\t\t);\n\n\t\t\tthis._localDisposables = [];\n\t\t\tthis._isDiposed = false;\n\n\t\t\tthis._localDisposables.push(this.onDidUpdateCommentThread(() => {\n\t\t\t\tthis.eventuallyUpdateCommentThread();\n\t\t\t}));\n\n\t\t\tthis._localDisposables.push({\n\t\t\t\tdispose: () => {\n\t\t\t\t\tproxy.$deleteCommentThread(\n\t\t\t\t\t\t_commentControllerHandle,\n\t\t\t\t\t\tthis.handle\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tconst that = this;\n\t\t\tthis.value = {\n\t\t\t\tget uri() { return that.uri; },\n\t\t\t\tget range() { return that.range; },\n\t\t\t\tset range(value: vscode.Range | undefined) { that.range = value; },\n\t\t\t\tget comments() { return that.comments; },\n\t\t\t\tset comments(value: vscode.Comment[]) { that.comments = value; },\n\t\t\t\tget collapsibleState() { return that.collapsibleState; },\n\t\t\t\tset collapsibleState(value: vscode.CommentThreadCollapsibleState) { that.collapsibleState = value; },\n\t\t\t\tget canReply() { return that.canReply; },\n\t\t\t\tset canReply(state: boolean | vscode.CommentAuthorInformation) { that.canReply = state; },\n\t\t\t\tget contextValue() { return that.contextValue; },\n\t\t\t\tset contextValue(value: string | undefined) { that.contextValue = value; },\n\t\t\t\tget label() { return that.label; },\n\t\t\t\tset label(value: string | undefined) { that.label = value; },\n\t\t\t\tget state(): vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability } | undefined { return that.state; },\n\t\t\t\tset state(value: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability }) { that.state = value; },\n\t\t\t\treveal: (comment?: vscode.Comment | vscode.CommentThreadRevealOptions, options?: vscode.CommentThreadRevealOptions) => that.reveal(comment, options),\n\t\t\t\thide: () => that.hide(),\n\t\t\t\tdispose: () => {\n\t\t\t\t\tthat.dispose();\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\tprivate updateIsTemplate() {\n\t\t\tif (this._isTemplate) {\n\t\t\t\tthis._isTemplate = false;\n\t\t\t\tthis.modifications.isTemplate = false;\n\t\t\t}\n\t\t}\n\n\t\t@debounce(100)\n\t\teventuallyUpdateCommentThread(): void {\n\t\t\tif (this._isDiposed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.updateIsTemplate();\n\n\t\t\tif (!this._acceptInputDisposables.value) {\n\t\t\t\tthis._acceptInputDisposables.value = new DisposableStore();\n\t\t\t}\n\n\t\t\tconst modified = (value: keyof CommentThreadModification): boolean =>\n\t\t\t\tObject.prototype.hasOwnProperty.call(this.modifications, value);\n\n\t\t\tconst formattedModifications: CommentThreadChanges = {};\n\t\t\tif (modified('range')) {\n\t\t\t\tformattedModifications.range = extHostTypeConverter.Range.from(this._range);\n\t\t\t}\n\t\t\tif (modified('label')) {\n\t\t\t\tformattedModifications.label = this.label;\n\t\t\t}\n\t\t\tif (modified('contextValue')) {\n\t\t\t\t/*\n\t\t\t\t * null -> cleared contextValue\n\t\t\t\t * undefined -> no change\n\t\t\t\t */\n\t\t\t\tformattedModifications.contextValue = this.contextValue ?? null;\n\t\t\t}\n\t\t\tif (modified('comments')) {\n\t\t\t\tformattedModifications.comments =\n\t\t\t\t\tthis._comments.map(cmt => convertToDTOComment(this, cmt, this._commentsMap, this.extensionDescription));\n\t\t\t}\n\t\t\tif (modified('collapsibleState')) {\n\t\t\t\tformattedModifications.collapseState = convertToCollapsibleState(this._collapseState);\n\t\t\t}\n\t\t\tif (modified('canReply')) {\n\t\t\t\tformattedModifications.canReply = this.canReply;\n\t\t\t}\n\t\t\tif (modified('state')) {\n\t\t\t\tformattedModifications.state = convertToState(this._state);\n\t\t\t}\n\t\t\tif (modified('applicability')) {\n\t\t\t\tformattedModifications.applicability = convertToRelevance(this._state);\n\t\t\t}\n\t\t\tif (modified('isTemplate')) {\n\t\t\t\tformattedModifications.isTemplate = this._isTemplate;\n\t\t\t}\n\t\t\tthis.modifications = {};\n\n\t\t\tproxy.$updateCommentThread(\n\t\t\t\tthis._commentControllerHandle,\n\t\t\t\tthis.handle,\n\t\t\t\tthis._id!,\n\t\t\t\tthis._uri,\n\t\t\t\tformattedModifications\n\t\t\t);\n\t\t}\n\n\t\tgetCommentByUniqueId(uniqueId: number): vscode.Comment | undefined {\n\t\t\tfor (const key of this._commentsMap) {\n\t\t\t\tconst comment = key[0];\n\t\t\t\tconst id = key[1];\n\t\t\t\tif (uniqueId === id) {\n\t\t\t\t\treturn comment;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tasync reveal(commentOrOptions?: vscode.Comment | vscode.CommentThreadRevealOptions, options?: vscode.CommentThreadRevealOptions): Promise<void> {\n\t\t\tcheckProposedApiEnabled(this.extensionDescription, 'commentReveal');\n\t\t\tlet comment: vscode.Comment | undefined;\n\t\t\tif (commentOrOptions && (commentOrOptions as vscode.Comment).body !== undefined) {\n\t\t\t\tcomment = commentOrOptions as vscode.Comment;\n\t\t\t} else {\n\t\t\t\toptions = options ?? commentOrOptions as vscode.CommentThreadRevealOptions;\n\t\t\t}\n\t\t\tlet commentToReveal = comment ? this._commentsMap.get(comment) : undefined;\n\t\t\tcommentToReveal ??= this._commentsMap.get(this._comments[0])!;\n\t\t\tlet preserveFocus: boolean = true;\n\t\t\tlet focusReply: boolean = false;\n\t\t\tif (options?.focus === types.CommentThreadFocus.Reply) {\n\t\t\t\tfocusReply = true;\n\t\t\t\tpreserveFocus = false;\n\t\t\t} else if (options?.focus === types.CommentThreadFocus.Comment) {\n\t\t\t\tpreserveFocus = false;\n\t\t\t}\n\t\t\treturn proxy.$revealCommentThread(this._commentControllerHandle, this.handle, commentToReveal, { preserveFocus, focusReply });\n\t\t}\n\n\t\tasync hide(): Promise<void> {\n\t\t\treturn proxy.$hideCommentThread(this._commentControllerHandle, this.handle);\n\t\t}\n\n\t\tdispose() {\n\t\t\tthis._isDiposed = true;\n\t\t\tthis._acceptInputDisposables.dispose();\n\t\t\tthis._localDisposables.forEach(disposable => disposable.dispose());\n\t\t}\n\t}\n\n\ttype ReactionHandler = (comment: vscode.Comment, reaction: vscode.CommentReaction) => Promise<void>;\n\n\tclass ExtHostCommentController {\n\t\tget id(): string {\n\t\t\treturn this._id;\n\t\t}\n\n\t\tget label(): string {\n\t\t\treturn this._label;\n\t\t}\n\n\t\tpublic get handle(): number {\n\t\t\treturn this._handle;\n\t\t}\n\n\t\tprivate _threads: Map<number, ExtHostCommentThread> = new Map<number, ExtHostCommentThread>();\n\n\t\tprivate _commentingRangeProvider?: vscode.CommentingRangeProvider;\n\t\tget commentingRangeProvider(): vscode.CommentingRangeProvider | undefined {\n\t\t\treturn this._commentingRangeProvider;\n\t\t}\n\n\t\tset commentingRangeProvider(provider: vscode.CommentingRangeProvider | undefined) {\n\t\t\tthis._commentingRangeProvider = provider;\n\t\t\tif (provider?.resourceHints) {\n\t\t\t\tcheckProposedApiEnabled(this._extension, 'commentingRangeHint');\n\t\t\t}\n\t\t\tproxy.$updateCommentingRanges(this.handle, provider?.resourceHints);\n\t\t}\n\n\t\tprivate _reactionHandler?: ReactionHandler;\n\n\t\tget reactionHandler(): ReactionHandler | undefined {\n\t\t\treturn this._reactionHandler;\n\t\t}\n\n\t\tset reactionHandler(handler: ReactionHandler | undefined) {\n\t\t\tthis._reactionHandler = handler;\n\n\t\t\tproxy.$updateCommentControllerFeatures(this.handle, { reactionHandler: !!handler });\n\t\t}\n\n\t\tprivate _options: languages.CommentOptions | undefined;\n\n\t\tget options() {\n\t\t\treturn this._options;\n\t\t}\n\n\t\tset options(options: languages.CommentOptions | undefined) {\n\t\t\tthis._options = options;\n\n\t\t\tproxy.$updateCommentControllerFeatures(this.handle, { options: this._options });\n\t\t}\n\n\t\tprivate _activeComment: vscode.Comment | undefined;\n\n\t\tget activeComment(): vscode.Comment | undefined {\n\t\t\tcheckProposedApiEnabled(this._extension, 'activeComment');\n\t\t\treturn this._activeComment;\n\t\t}\n\n\t\tprivate _activeThread: ExtHostCommentThread | undefined;\n\n\t\tget activeCommentThread(): vscode.CommentThread2 | undefined {\n\t\t\tcheckProposedApiEnabled(this._extension, 'activeComment');\n\t\t\treturn this._activeThread?.value;\n\t\t}\n\n\t\tprivate _localDisposables: types.Disposable[];\n\t\treadonly value: vscode.CommentController;\n\n\t\tconstructor(\n\t\t\tprivate _extension: IExtensionDescription,\n\t\t\tprivate _handle: number,\n\t\t\tprivate _id: string,\n\t\t\tprivate _label: string\n\t\t) {\n\t\t\tproxy.$registerCommentController(this.handle, _id, _label, this._extension.identifier.value);\n\n\t\t\tconst that = this;\n\t\t\tthis.value = Object.freeze({\n\t\t\t\tid: that.id,\n\t\t\t\tlabel: that.label,\n\t\t\t\tget options() { return that.options; },\n\t\t\t\tset options(options: vscode.CommentOptions | undefined) { that.options = options; },\n\t\t\t\tget commentingRangeProvider(): vscode.CommentingRangeProvider | undefined { return that.commentingRangeProvider; },\n\t\t\t\tset commentingRangeProvider(commentingRangeProvider: vscode.CommentingRangeProvider | undefined) { that.commentingRangeProvider = commentingRangeProvider; },\n\t\t\t\tget reactionHandler(): ReactionHandler | undefined { return that.reactionHandler; },\n\t\t\t\tset reactionHandler(handler: ReactionHandler | undefined) { that.reactionHandler = handler; },\n\t\t\t\t// get activeComment(): vscode.Comment | undefined { return that.activeComment; },\n\t\t\t\tget activeCommentThread(): vscode.CommentThread | undefined { return that.activeCommentThread as vscode.CommentThread | undefined; },\n\t\t\t\tcreateCommentThread(uri: vscode.Uri, range: vscode.Range | undefined, comments: vscode.Comment[]): vscode.CommentThread {\n\t\t\t\t\treturn that.createCommentThread(uri, range, comments).value as vscode.CommentThread;\n\t\t\t\t},\n\t\t\t\tdispose: () => { that.dispose(); },\n\t\t\t});\n\n\t\t\tthis._localDisposables = [];\n\t\t\tthis._localDisposables.push({\n\t\t\t\tdispose: () => {\n\t\t\t\t\tproxy.$unregisterCommentController(this.handle);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tcreateCommentThread(resource: vscode.Uri, range: vscode.Range | undefined, comments: vscode.Comment[]): ExtHostCommentThread {\n\t\t\tconst commentThread = new ExtHostCommentThread(this.id, this.handle, undefined, resource, range, comments, this._extension, false);\n\t\t\tthis._threads.set(commentThread.handle, commentThread);\n\t\t\treturn commentThread;\n\t\t}\n\n\t\t$setActiveComment(commentInfo: { commentThreadHandle: number; uniqueIdInThread?: number } | undefined) {\n\t\t\tif (!commentInfo) {\n\t\t\t\tthis._activeComment = undefined;\n\t\t\t\tthis._activeThread = undefined;\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst thread = this._threads.get(commentInfo.commentThreadHandle);\n\t\t\tif (thread) {\n\t\t\t\tthis._activeComment = commentInfo.uniqueIdInThread ? thread.getCommentByUniqueId(commentInfo.uniqueIdInThread) : undefined;\n\t\t\t\tthis._activeThread = thread;\n\t\t\t}\n\t\t}\n\n\t\t$createCommentThreadTemplate(uriComponents: UriComponents, range: IRange | undefined, editorId?: string): ExtHostCommentThread {\n\t\t\tconst commentThread = new ExtHostCommentThread(this.id, this.handle, undefined, URI.revive(uriComponents), extHostTypeConverter.Range.to(range), [], this._extension, true, editorId);\n\t\t\tcommentThread.collapsibleState = languages.CommentThreadCollapsibleState.Expanded;\n\t\t\tthis._threads.set(commentThread.handle, commentThread);\n\t\t\treturn commentThread;\n\t\t}\n\n\t\t$updateCommentThreadTemplate(threadHandle: number, range: IRange): void {\n\t\t\tconst thread = this._threads.get(threadHandle);\n\t\t\tif (thread) {\n\t\t\t\tthread.range = extHostTypeConverter.Range.to(range);\n\t\t\t}\n\t\t}\n\n\t\t$updateCommentThread(threadHandle: number, changes: CommentThreadChanges): void {\n\t\t\tconst thread = this._threads.get(threadHandle);\n\t\t\tif (!thread) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst modified = (value: keyof CommentThreadChanges): boolean =>\n\t\t\t\tObject.prototype.hasOwnProperty.call(changes, value);\n\n\t\t\tif (modified('collapseState')) {\n\t\t\t\tthread.collapsibleState = convertToCollapsibleState(changes.collapseState);\n\t\t\t}\n\t\t}\n\n\t\t$deleteCommentThread(threadHandle: number): void {\n\t\t\tconst thread = this._threads.get(threadHandle);\n\n\t\t\tthread?.dispose();\n\n\t\t\tthis._threads.delete(threadHandle);\n\t\t}\n\n\t\tgetCommentThread(handle: number): ExtHostCommentThread | undefined {\n\t\t\treturn this._threads.get(handle);\n\t\t}\n\n\t\tdispose(): void {\n\t\t\tthis._threads.forEach(value => {\n\t\t\t\tvalue.dispose();\n\t\t\t});\n\n\t\t\tthis._localDisposables.forEach(disposable => disposable.dispose());\n\t\t}\n\t}\n\n\tfunction convertToDTOComment(thread: ExtHostCommentThread, vscodeComment: vscode.Comment, commentsMap: Map<vscode.Comment, number>, extension: IExtensionDescription): CommentChanges {\n\t\tlet commentUniqueId = commentsMap.get(vscodeComment)!;\n\t\tif (!commentUniqueId) {\n\t\t\tcommentUniqueId = ++thread.commentHandle;\n\t\t\tcommentsMap.set(vscodeComment, commentUniqueId);\n\t\t}\n\n\t\tif (vscodeComment.state !== undefined) {\n\t\t\tcheckProposedApiEnabled(extension, 'commentsDraftState');\n\t\t}\n\n\t\tif (vscodeComment.reactions?.some(reaction => reaction.reactors !== undefined)) {\n\t\t\tcheckProposedApiEnabled(extension, 'commentReactor');\n\t\t}\n\n\t\treturn {\n\t\t\tmode: vscodeComment.mode,\n\t\t\tcontextValue: vscodeComment.contextValue,\n\t\t\tuniqueIdInThread: commentUniqueId,\n\t\t\tbody: (typeof vscodeComment.body === 'string') ? vscodeComment.body : extHostTypeConverter.MarkdownString.from(vscodeComment.body),\n\t\t\tuserName: vscodeComment.author.name,\n\t\t\tuserIconPath: vscodeComment.author.iconPath,\n\t\t\tlabel: vscodeComment.label,\n\t\t\tcommentReactions: vscodeComment.reactions ? vscodeComment.reactions.map(reaction => convertToReaction(reaction)) : undefined,\n\t\t\tstate: vscodeComment.state,\n\t\t\ttimestamp: vscodeComment.timestamp?.toJSON()\n\t\t};\n\t}\n\n\tfunction convertToReaction(reaction: vscode.CommentReaction): languages.CommentReaction {\n\t\treturn {\n\t\t\tlabel: reaction.label,\n\t\t\ticonPath: reaction.iconPath ? extHostTypeConverter.pathOrURIToURI(reaction.iconPath) : undefined,\n\t\t\tcount: reaction.count,\n\t\t\thasReacted: reaction.authorHasReacted,\n\t\t\treactors: ((reaction.reactors && (reaction.reactors.length > 0) && (typeof reaction.reactors[0] !== 'string')) ? (reaction.reactors as languages.CommentAuthorInformation[]).map(reactor => reactor.name) : reaction.reactors) as string[]\n\t\t};\n\t}\n\n\tfunction convertFromReaction(reaction: languages.CommentReaction): vscode.CommentReaction {\n\t\treturn {\n\t\t\tlabel: reaction.label || '',\n\t\t\tcount: reaction.count || 0,\n\t\t\ticonPath: reaction.iconPath ? URI.revive(reaction.iconPath) : '',\n\t\t\tauthorHasReacted: reaction.hasReacted || false,\n\t\t\treactors: reaction.reactors?.map(reactor => ({ name: reactor }))\n\t\t};\n\t}\n\n\tfunction convertToCollapsibleState(kind: vscode.CommentThreadCollapsibleState | undefined): languages.CommentThreadCollapsibleState {\n\t\tif (kind !== undefined) {\n\t\t\tswitch (kind) {\n\t\t\t\tcase types.CommentThreadCollapsibleState.Expanded:\n\t\t\t\t\treturn languages.CommentThreadCollapsibleState.Expanded;\n\t\t\t\tcase types.CommentThreadCollapsibleState.Collapsed:\n\t\t\t\t\treturn languages.CommentThreadCollapsibleState.Collapsed;\n\t\t\t}\n\t\t}\n\t\treturn languages.CommentThreadCollapsibleState.Collapsed;\n\t}\n\n\tfunction convertToState(kind: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability } | undefined): languages.CommentThreadState {\n\t\tlet resolvedKind: vscode.CommentThreadState | undefined;\n\t\tif (typeof kind === 'object') {\n\t\t\tresolvedKind = kind.resolved;\n\t\t} else {\n\t\t\tresolvedKind = kind;\n\t\t}\n\n\t\tif (resolvedKind !== undefined) {\n\t\t\tswitch (resolvedKind) {\n\t\t\t\tcase types.CommentThreadState.Unresolved:\n\t\t\t\t\treturn languages.CommentThreadState.Unresolved;\n\t\t\t\tcase types.CommentThreadState.Resolved:\n\t\t\t\t\treturn languages.CommentThreadState.Resolved;\n\t\t\t}\n\t\t}\n\t\treturn languages.CommentThreadState.Unresolved;\n\t}\n\n\tfunction convertToRelevance(kind: vscode.CommentThreadState | { resolved?: vscode.CommentThreadState; applicability?: vscode.CommentThreadApplicability } | undefined): languages.CommentThreadApplicability {\n\t\tlet applicabilityKind: vscode.CommentThreadApplicability | undefined = undefined;\n\t\tif (typeof kind === 'object') {\n\t\t\tapplicabilityKind = kind.applicability;\n\t\t}\n\n\t\tif (applicabilityKind !== undefined) {\n\t\t\tswitch (applicabilityKind) {\n\t\t\t\tcase types.CommentThreadApplicability.Current:\n\t\t\t\t\treturn languages.CommentThreadApplicability.Current;\n\t\t\t\tcase types.CommentThreadApplicability.Outdated:\n\t\t\t\t\treturn languages.CommentThreadApplicability.Outdated;\n\t\t\t}\n\t\t}\n\t\treturn languages.CommentThreadApplicability.Current;\n\t}\n\n\treturn new ExtHostCommentsImpl();\n}\n"]}