{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/worker/extensionHostWorker.ts","vs/workbench/api/worker/extensionHostWorker.ts"],"names":[],"mappings":"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","file":"extensionHostWorker.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IMessagePassingProtocol } from '../../../base/parts/ipc/common/ipc.js';\nimport { VSBuffer } from '../../../base/common/buffer.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { isMessageOfType, MessageType, createMessageOfType, IExtensionHostInitData } from '../../services/extensions/common/extensionHostProtocol.js';\nimport { ExtensionHostMain } from '../common/extensionHostMain.js';\nimport { IHostUtils } from '../common/extHostExtensionService.js';\nimport { NestedWorker } from '../../services/extensions/worker/polyfillNestedWorker.js';\nimport * as path from '../../../base/common/path.js';\nimport * as performance from '../../../base/common/performance.js';\n\nimport '../common/extHost.common.services.js';\nimport './extHost.worker.services.js';\nimport { FileAccess } from '../../../base/common/network.js';\nimport { URI } from '../../../base/common/uri.js';\n\n//#region --- Define, capture, and override some globals\n\ndeclare function postMessage(data: any, transferables?: Transferable[]): void;\ndeclare const name: string; // https://developer.mozilla.org/en-US/docs/Web/API/DedicatedWorkerGlobalScope/name\ndeclare type _Fetch = typeof fetch;\n\ndeclare namespace self {\n\tlet close: any;\n\tlet postMessage: any;\n\tlet addEventListener: any;\n\tlet removeEventListener: any;\n\tlet dispatchEvent: any;\n\tlet indexedDB: { open: any;[k: string]: any };\n\tlet caches: { open: any;[k: string]: any };\n\tlet importScripts: any;\n\tlet fetch: _Fetch;\n\tlet XMLHttpRequest: any;\n}\n\nconst nativeClose = self.close.bind(self);\nself.close = () => console.trace(`'close' has been blocked`);\n\nconst nativePostMessage = postMessage.bind(self);\nself.postMessage = () => console.trace(`'postMessage' has been blocked`);\n\nfunction shouldTransformUri(uri: string): boolean {\n\t// In principle, we could convert any URI, but we have concerns\n\t// that parsing https URIs might end up decoding escape characters\n\t// and result in an unintended transformation\n\treturn /^(file|vscode-remote):/i.test(uri);\n}\n\nconst nativeFetch = fetch.bind(self);\nfunction patchFetching(asBrowserUri: (uri: URI) => Promise<URI>) {\n\tself.fetch = async function (input, init) {\n\t\tif (input instanceof Request) {\n\t\t\t// Request object - massage not supported\n\t\t\treturn nativeFetch(input, init);\n\t\t}\n\t\tif (shouldTransformUri(String(input))) {\n\t\t\tinput = (await asBrowserUri(URI.parse(String(input)))).toString(true);\n\t\t}\n\t\treturn nativeFetch(input, init);\n\t};\n\n\tself.XMLHttpRequest = class extends XMLHttpRequest {\n\t\toverride open(method: string, url: string | URL, async?: boolean, username?: string | null, password?: string | null): void {\n\t\t\t(async () => {\n\t\t\t\tif (shouldTransformUri(url.toString())) {\n\t\t\t\t\turl = (await asBrowserUri(URI.parse(url.toString()))).toString(true);\n\t\t\t\t}\n\t\t\t\tsuper.open(method, url, async ?? true, username, password);\n\t\t\t})();\n\t\t}\n\t};\n}\n\nself.importScripts = () => { throw new Error(`'importScripts' has been blocked`); };\n\n// const nativeAddEventListener = addEventListener.bind(self);\nself.addEventListener = () => console.trace(`'addEventListener' has been blocked`);\n\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['AMDLoader'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['NLSLoaderPlugin'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['define'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['require'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['webkitRequestFileSystem'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['webkitRequestFileSystemSync'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['webkitResolveLocalFileSystemSyncURL'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['webkitResolveLocalFileSystemURL'] = undefined;\n\n// eslint-disable-next-line local/code-no-any-casts\nif ((<any>self).Worker) {\n\n\t// make sure new Worker(...) always uses blob: (to maintain current origin)\n\t// eslint-disable-next-line local/code-no-any-casts\n\tconst _Worker = (<any>self).Worker;\n\t// eslint-disable-next-line local/code-no-any-casts\n\tWorker = <any>function (stringUrl: string | URL, options?: WorkerOptions) {\n\t\tif (/^file:/i.test(stringUrl.toString())) {\n\t\t\tstringUrl = FileAccess.uriToBrowserUri(URI.parse(stringUrl.toString())).toString(true);\n\t\t} else if (/^vscode-remote:/i.test(stringUrl.toString())) {\n\t\t\t// Supporting transformation of vscode-remote URIs requires an async call to the main thread,\n\t\t\t// but we cannot do this call from within the embedded Worker, and the only way out would be\n\t\t\t// to use templating instead of a function in the web api (`resourceUriProvider`)\n\t\t\tthrow new Error(`Creating workers from remote extensions is currently not supported.`);\n\t\t}\n\n\t\t// IMPORTANT: bootstrapFn is stringified and injected as worker blob-url. Because of that it CANNOT\n\t\t// have dependencies on other functions or variables. Only constant values are supported. Due to\n\t\t// that logic of FileAccess.asBrowserUri had to be copied, see `asWorkerBrowserUrl` (below).\n\t\tconst bootstrapFnSource = (function bootstrapFn(workerUrl: string) {\n\t\t\tfunction asWorkerBrowserUrl(url: string | URL | TrustedScriptURL): any {\n\t\t\t\tif (typeof url === 'string' || url instanceof URL) {\n\t\t\t\t\treturn String(url).replace(/^file:\\/\\//i, 'vscode-file://vscode-app');\n\t\t\t\t}\n\t\t\t\treturn url;\n\t\t\t}\n\n\t\t\tconst nativeFetch = fetch.bind(self);\n\t\t\tself.fetch = function (input, init) {\n\t\t\t\tif (input instanceof Request) {\n\t\t\t\t\t// Request object - massage not supported\n\t\t\t\t\treturn nativeFetch(input, init);\n\t\t\t\t}\n\t\t\t\treturn nativeFetch(asWorkerBrowserUrl(input), init);\n\t\t\t};\n\t\t\tself.XMLHttpRequest = class extends XMLHttpRequest {\n\t\t\t\toverride open(method: string, url: string | URL, async?: boolean, username?: string | null, password?: string | null): void {\n\t\t\t\t\treturn super.open(method, asWorkerBrowserUrl(url), async ?? true, username, password);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst nativeImportScripts = importScripts.bind(self);\n\t\t\tself.importScripts = (...urls: string[]) => {\n\t\t\t\tnativeImportScripts(...urls.map(asWorkerBrowserUrl));\n\t\t\t};\n\n\t\t\tnativeImportScripts(workerUrl);\n\t\t}).toString();\n\n\t\tconst js = `(${bootstrapFnSource}('${stringUrl}'))`;\n\t\toptions = options || {};\n\t\toptions.name = `${name} -> ${options.name || path.basename(stringUrl.toString())}`;\n\t\tconst blob = new Blob([js], { type: 'application/javascript' });\n\t\tconst blobUrl = URL.createObjectURL(blob);\n\t\treturn new _Worker(blobUrl, options);\n\t};\n\n} else {\n\t// eslint-disable-next-line local/code-no-any-casts\n\t(<any>self).Worker = class extends NestedWorker {\n\t\tconstructor(stringOrUrl: string | URL, options?: WorkerOptions) {\n\t\t\tsuper(nativePostMessage, stringOrUrl, { name: path.basename(stringOrUrl.toString()), ...options });\n\t\t}\n\t};\n}\n\n//#endregion ---\n\nconst hostUtil = new class implements IHostUtils {\n\tdeclare readonly _serviceBrand: undefined;\n\tpublic readonly pid = undefined;\n\texit(_code?: number | undefined): void {\n\t\tnativeClose();\n\t}\n};\n\n\nclass ExtensionWorker {\n\n\t// protocol\n\treadonly protocol: IMessagePassingProtocol;\n\n\tconstructor() {\n\n\t\tconst channel = new MessageChannel();\n\t\tconst emitter = new Emitter<VSBuffer>();\n\t\tlet terminating = false;\n\n\t\t// send over port2, keep port1\n\t\tnativePostMessage(channel.port2, [channel.port2]);\n\n\t\tchannel.port1.onmessage = event => {\n\t\t\tconst { data } = event;\n\t\t\tif (!(data instanceof ArrayBuffer)) {\n\t\t\t\tconsole.warn('UNKNOWN data received', data);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst msg = VSBuffer.wrap(new Uint8Array(data, 0, data.byteLength));\n\t\t\tif (isMessageOfType(msg, MessageType.Terminate)) {\n\t\t\t\t// handle terminate-message right here\n\t\t\t\tterminating = true;\n\t\t\t\tonTerminate('received terminate message from renderer');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// emit non-terminate messages to the outside\n\t\t\temitter.fire(msg);\n\t\t};\n\n\t\tthis.protocol = {\n\t\t\tonMessage: emitter.event,\n\t\t\tsend: vsbuf => {\n\t\t\t\tif (!terminating) {\n\t\t\t\t\tconst data = vsbuf.buffer.buffer.slice(vsbuf.buffer.byteOffset, vsbuf.buffer.byteOffset + vsbuf.buffer.byteLength);\n\t\t\t\t\tchannel.port1.postMessage(data, [data]);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n}\n\ninterface IRendererConnection {\n\tprotocol: IMessagePassingProtocol;\n\tinitData: IExtensionHostInitData;\n}\nfunction connectToRenderer(protocol: IMessagePassingProtocol): Promise<IRendererConnection> {\n\treturn new Promise<IRendererConnection>(resolve => {\n\t\tconst once = protocol.onMessage(raw => {\n\t\t\tonce.dispose();\n\t\t\tconst initData = <IExtensionHostInitData>JSON.parse(raw.toString());\n\t\t\tprotocol.send(createMessageOfType(MessageType.Initialized));\n\t\t\tresolve({ protocol, initData });\n\t\t});\n\t\tprotocol.send(createMessageOfType(MessageType.Ready));\n\t});\n}\n\nlet onTerminate = (reason: string) => nativeClose();\n\ninterface IInitMessage {\n\treadonly type: 'vscode.init';\n\treadonly data: ReadonlyMap<string, MessagePort>;\n}\n\nfunction isInitMessage(a: any): a is IInitMessage {\n\treturn !!a && typeof a === 'object' && a.type === 'vscode.init' && a.data instanceof Map;\n}\n\nexport function create(): { onmessage: (message: any) => void } {\n\tperformance.mark(`code/extHost/willConnectToRenderer`);\n\tconst res = new ExtensionWorker();\n\n\treturn {\n\t\tonmessage(message: any) {\n\t\t\tif (!isInitMessage(message)) {\n\t\t\t\treturn; // silently ignore foreign messages\n\t\t\t}\n\n\t\t\tconnectToRenderer(res.protocol).then(data => {\n\t\t\t\tperformance.mark(`code/extHost/didWaitForInitData`);\n\t\t\t\tconst extHostMain = new ExtensionHostMain(\n\t\t\t\t\tdata.protocol,\n\t\t\t\t\tdata.initData,\n\t\t\t\t\thostUtil,\n\t\t\t\t\tnull,\n\t\t\t\t\tmessage.data\n\t\t\t\t);\n\n\t\t\t\tpatchFetching(uri => extHostMain.asBrowserUri(uri));\n\n\t\t\t\tonTerminate = (reason: string) => extHostMain.terminate(reason);\n\t\t\t});\n\t\t}\n\t};\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IMessagePassingProtocol } from '../../../base/parts/ipc/common/ipc.js';\nimport { VSBuffer } from '../../../base/common/buffer.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { isMessageOfType, MessageType, createMessageOfType, IExtensionHostInitData } from '../../services/extensions/common/extensionHostProtocol.js';\nimport { ExtensionHostMain } from '../common/extensionHostMain.js';\nimport { IHostUtils } from '../common/extHostExtensionService.js';\nimport { NestedWorker } from '../../services/extensions/worker/polyfillNestedWorker.js';\nimport * as path from '../../../base/common/path.js';\nimport * as performance from '../../../base/common/performance.js';\n\nimport '../common/extHost.common.services.js';\nimport './extHost.worker.services.js';\nimport { FileAccess } from '../../../base/common/network.js';\nimport { URI } from '../../../base/common/uri.js';\n\n//#region --- Define, capture, and override some globals\n\ndeclare function postMessage(data: any, transferables?: Transferable[]): void;\ndeclare const name: string; // https://developer.mozilla.org/en-US/docs/Web/API/DedicatedWorkerGlobalScope/name\ndeclare type _Fetch = typeof fetch;\n\ndeclare namespace self {\n\tlet close: any;\n\tlet postMessage: any;\n\tlet addEventListener: any;\n\tlet removeEventListener: any;\n\tlet dispatchEvent: any;\n\tlet indexedDB: { open: any;[k: string]: any };\n\tlet caches: { open: any;[k: string]: any };\n\tlet importScripts: any;\n\tlet fetch: _Fetch;\n\tlet XMLHttpRequest: any;\n}\n\nconst nativeClose = self.close.bind(self);\nself.close = () => console.trace(`'close' has been blocked`);\n\nconst nativePostMessage = postMessage.bind(self);\nself.postMessage = () => console.trace(`'postMessage' has been blocked`);\n\nfunction shouldTransformUri(uri: string): boolean {\n\t// In principle, we could convert any URI, but we have concerns\n\t// that parsing https URIs might end up decoding escape characters\n\t// and result in an unintended transformation\n\treturn /^(file|vscode-remote):/i.test(uri);\n}\n\nconst nativeFetch = fetch.bind(self);\nfunction patchFetching(asBrowserUri: (uri: URI) => Promise<URI>) {\n\tself.fetch = async function (input, init) {\n\t\tif (input instanceof Request) {\n\t\t\t// Request object - massage not supported\n\t\t\treturn nativeFetch(input, init);\n\t\t}\n\t\tif (shouldTransformUri(String(input))) {\n\t\t\tinput = (await asBrowserUri(URI.parse(String(input)))).toString(true);\n\t\t}\n\t\treturn nativeFetch(input, init);\n\t};\n\n\tself.XMLHttpRequest = class extends XMLHttpRequest {\n\t\toverride open(method: string, url: string | URL, async?: boolean, username?: string | null, password?: string | null): void {\n\t\t\t(async () => {\n\t\t\t\tif (shouldTransformUri(url.toString())) {\n\t\t\t\t\turl = (await asBrowserUri(URI.parse(url.toString()))).toString(true);\n\t\t\t\t}\n\t\t\t\tsuper.open(method, url, async ?? true, username, password);\n\t\t\t})();\n\t\t}\n\t};\n}\n\nself.importScripts = () => { throw new Error(`'importScripts' has been blocked`); };\n\n// const nativeAddEventListener = addEventListener.bind(self);\nself.addEventListener = () => console.trace(`'addEventListener' has been blocked`);\n\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['AMDLoader'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['NLSLoaderPlugin'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['define'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['require'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['webkitRequestFileSystem'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['webkitRequestFileSystemSync'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['webkitResolveLocalFileSystemSyncURL'] = undefined;\n// eslint-disable-next-line local/code-no-any-casts\n(<any>self)['webkitResolveLocalFileSystemURL'] = undefined;\n\n// eslint-disable-next-line local/code-no-any-casts\nif ((<any>self).Worker) {\n\n\t// make sure new Worker(...) always uses blob: (to maintain current origin)\n\t// eslint-disable-next-line local/code-no-any-casts\n\tconst _Worker = (<any>self).Worker;\n\t// eslint-disable-next-line local/code-no-any-casts\n\tWorker = <any>function (stringUrl: string | URL, options?: WorkerOptions) {\n\t\tif (/^file:/i.test(stringUrl.toString())) {\n\t\t\tstringUrl = FileAccess.uriToBrowserUri(URI.parse(stringUrl.toString())).toString(true);\n\t\t} else if (/^vscode-remote:/i.test(stringUrl.toString())) {\n\t\t\t// Supporting transformation of vscode-remote URIs requires an async call to the main thread,\n\t\t\t// but we cannot do this call from within the embedded Worker, and the only way out would be\n\t\t\t// to use templating instead of a function in the web api (`resourceUriProvider`)\n\t\t\tthrow new Error(`Creating workers from remote extensions is currently not supported.`);\n\t\t}\n\n\t\t// IMPORTANT: bootstrapFn is stringified and injected as worker blob-url. Because of that it CANNOT\n\t\t// have dependencies on other functions or variables. Only constant values are supported. Due to\n\t\t// that logic of FileAccess.asBrowserUri had to be copied, see `asWorkerBrowserUrl` (below).\n\t\tconst bootstrapFnSource = (function bootstrapFn(workerUrl: string) {\n\t\t\tfunction asWorkerBrowserUrl(url: string | URL | TrustedScriptURL): any {\n\t\t\t\tif (typeof url === 'string' || url instanceof URL) {\n\t\t\t\t\treturn String(url).replace(/^file:\\/\\//i, 'vscode-file://vscode-app');\n\t\t\t\t}\n\t\t\t\treturn url;\n\t\t\t}\n\n\t\t\tconst nativeFetch = fetch.bind(self);\n\t\t\tself.fetch = function (input, init) {\n\t\t\t\tif (input instanceof Request) {\n\t\t\t\t\t// Request object - massage not supported\n\t\t\t\t\treturn nativeFetch(input, init);\n\t\t\t\t}\n\t\t\t\treturn nativeFetch(asWorkerBrowserUrl(input), init);\n\t\t\t};\n\t\t\tself.XMLHttpRequest = class extends XMLHttpRequest {\n\t\t\t\toverride open(method: string, url: string | URL, async?: boolean, username?: string | null, password?: string | null): void {\n\t\t\t\t\treturn super.open(method, asWorkerBrowserUrl(url), async ?? true, username, password);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst nativeImportScripts = importScripts.bind(self);\n\t\t\tself.importScripts = (...urls: string[]) => {\n\t\t\t\tnativeImportScripts(...urls.map(asWorkerBrowserUrl));\n\t\t\t};\n\n\t\t\tnativeImportScripts(workerUrl);\n\t\t}).toString();\n\n\t\tconst js = `(${bootstrapFnSource}('${stringUrl}'))`;\n\t\toptions = options || {};\n\t\toptions.name = `${name} -> ${options.name || path.basename(stringUrl.toString())}`;\n\t\tconst blob = new Blob([js], { type: 'application/javascript' });\n\t\tconst blobUrl = URL.createObjectURL(blob);\n\t\treturn new _Worker(blobUrl, options);\n\t};\n\n} else {\n\t// eslint-disable-next-line local/code-no-any-casts\n\t(<any>self).Worker = class extends NestedWorker {\n\t\tconstructor(stringOrUrl: string | URL, options?: WorkerOptions) {\n\t\t\tsuper(nativePostMessage, stringOrUrl, { name: path.basename(stringOrUrl.toString()), ...options });\n\t\t}\n\t};\n}\n\n//#endregion ---\n\nconst hostUtil = new class implements IHostUtils {\n\tdeclare readonly _serviceBrand: undefined;\n\tpublic readonly pid = undefined;\n\texit(_code?: number | undefined): void {\n\t\tnativeClose();\n\t}\n};\n\n\nclass ExtensionWorker {\n\n\t// protocol\n\treadonly protocol: IMessagePassingProtocol;\n\n\tconstructor() {\n\n\t\tconst channel = new MessageChannel();\n\t\tconst emitter = new Emitter<VSBuffer>();\n\t\tlet terminating = false;\n\n\t\t// send over port2, keep port1\n\t\tnativePostMessage(channel.port2, [channel.port2]);\n\n\t\tchannel.port1.onmessage = event => {\n\t\t\tconst { data } = event;\n\t\t\tif (!(data instanceof ArrayBuffer)) {\n\t\t\t\tconsole.warn('UNKNOWN data received', data);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst msg = VSBuffer.wrap(new Uint8Array(data, 0, data.byteLength));\n\t\t\tif (isMessageOfType(msg, MessageType.Terminate)) {\n\t\t\t\t// handle terminate-message right here\n\t\t\t\tterminating = true;\n\t\t\t\tonTerminate('received terminate message from renderer');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// emit non-terminate messages to the outside\n\t\t\temitter.fire(msg);\n\t\t};\n\n\t\tthis.protocol = {\n\t\t\tonMessage: emitter.event,\n\t\t\tsend: vsbuf => {\n\t\t\t\tif (!terminating) {\n\t\t\t\t\tconst data = vsbuf.buffer.buffer.slice(vsbuf.buffer.byteOffset, vsbuf.buffer.byteOffset + vsbuf.buffer.byteLength);\n\t\t\t\t\tchannel.port1.postMessage(data, [data]);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n}\n\ninterface IRendererConnection {\n\tprotocol: IMessagePassingProtocol;\n\tinitData: IExtensionHostInitData;\n}\nfunction connectToRenderer(protocol: IMessagePassingProtocol): Promise<IRendererConnection> {\n\treturn new Promise<IRendererConnection>(resolve => {\n\t\tconst once = protocol.onMessage(raw => {\n\t\t\tonce.dispose();\n\t\t\tconst initData = <IExtensionHostInitData>JSON.parse(raw.toString());\n\t\t\tprotocol.send(createMessageOfType(MessageType.Initialized));\n\t\t\tresolve({ protocol, initData });\n\t\t});\n\t\tprotocol.send(createMessageOfType(MessageType.Ready));\n\t});\n}\n\nlet onTerminate = (reason: string) => nativeClose();\n\ninterface IInitMessage {\n\treadonly type: 'vscode.init';\n\treadonly data: ReadonlyMap<string, MessagePort>;\n}\n\nfunction isInitMessage(a: any): a is IInitMessage {\n\treturn !!a && typeof a === 'object' && a.type === 'vscode.init' && a.data instanceof Map;\n}\n\nexport function create(): { onmessage: (message: any) => void } {\n\tperformance.mark(`code/extHost/willConnectToRenderer`);\n\tconst res = new ExtensionWorker();\n\n\treturn {\n\t\tonmessage(message: any) {\n\t\t\tif (!isInitMessage(message)) {\n\t\t\t\treturn; // silently ignore foreign messages\n\t\t\t}\n\n\t\t\tconnectToRenderer(res.protocol).then(data => {\n\t\t\t\tperformance.mark(`code/extHost/didWaitForInitData`);\n\t\t\t\tconst extHostMain = new ExtensionHostMain(\n\t\t\t\t\tdata.protocol,\n\t\t\t\t\tdata.initData,\n\t\t\t\t\thostUtil,\n\t\t\t\t\tnull,\n\t\t\t\t\tmessage.data\n\t\t\t\t);\n\n\t\t\t\tpatchFetching(uri => extHostMain.asBrowserUri(uri));\n\n\t\t\t\tonTerminate = (reason: string) => extHostMain.terminate(reason);\n\t\t\t});\n\t\t}\n\t};\n}\n"]}