{"version":3,"sources":["vs/workbench/api/node/extHostAuthentication.ts"],"names":[],"mappings":"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","file":"extHostAuthentication.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from '../../../nls.js';\nimport type * as vscode from 'vscode';\nimport { URL } from 'url';\nimport { ExtHostAuthentication, DynamicAuthProvider, IExtHostAuthentication } from '../common/extHostAuthentication.js';\nimport { IExtHostRpcService } from '../common/extHostRpcService.js';\nimport { IExtHostInitDataService } from '../common/extHostInitDataService.js';\nimport { IExtHostWindow } from '../common/extHostWindow.js';\nimport { IExtHostUrlsService } from '../common/extHostUrls.js';\nimport { ILoggerService, ILogService } from '../../../platform/log/common/log.js';\nimport { MainThreadAuthenticationShape } from '../common/extHost.protocol.js';\nimport { IAuthorizationServerMetadata, IAuthorizationProtectedResourceMetadata, IAuthorizationTokenResponse, IAuthorizationDeviceResponse, isAuthorizationDeviceResponse, isAuthorizationTokenResponse, IAuthorizationDeviceTokenErrorResponse, AuthorizationErrorType, AuthorizationDeviceCodeErrorType } from '../../../base/common/oauth.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { raceCancellationError } from '../../../base/common/async.js';\nimport { IExtHostProgress } from '../common/extHostProgress.js';\nimport { IProgressStep } from '../../../platform/progress/common/progress.js';\nimport { CancellationError, isCancellationError } from '../../../base/common/errors.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { LoopbackAuthServer } from './loopbackServer.js';\n\nexport class NodeDynamicAuthProvider extends DynamicAuthProvider {\n\n\tconstructor(\n\t\textHostWindow: IExtHostWindow,\n\t\textHostUrls: IExtHostUrlsService,\n\t\tinitData: IExtHostInitDataService,\n\t\textHostProgress: IExtHostProgress,\n\t\tloggerService: ILoggerService,\n\t\tproxy: MainThreadAuthenticationShape,\n\t\tauthorizationServer: URI,\n\t\tserverMetadata: IAuthorizationServerMetadata,\n\t\tresourceMetadata: IAuthorizationProtectedResourceMetadata | undefined,\n\t\tclientId: string,\n\t\tclientSecret: string | undefined,\n\t\tonDidDynamicAuthProviderTokensChange: Emitter<{ authProviderId: string; clientId: string; tokens: any[] }>,\n\t\tinitialTokens: any[]\n\t) {\n\t\tsuper(\n\t\t\textHostWindow,\n\t\t\textHostUrls,\n\t\t\tinitData,\n\t\t\textHostProgress,\n\t\t\tloggerService,\n\t\t\tproxy,\n\t\t\tauthorizationServer,\n\t\t\tserverMetadata,\n\t\t\tresourceMetadata,\n\t\t\tclientId,\n\t\t\tclientSecret,\n\t\t\tonDidDynamicAuthProviderTokensChange,\n\t\t\tinitialTokens\n\t\t);\n\n\t\t// Prepend Node-specific flows to the existing flows\n\t\tif (!initData.remote.isRemote && serverMetadata.authorization_endpoint) {\n\t\t\t// If we are not in a remote environment, we can use the loopback server for authentication\n\t\t\tthis._createFlows.unshift({\n\t\t\t\tlabel: nls.localize('loopback', \"Loopback Server\"),\n\t\t\t\thandler: (scopes, progress, token) => this._createWithLoopbackServer(scopes, progress, token)\n\t\t\t});\n\t\t}\n\n\t\t// Add device code flow to the end since it's not as streamlined\n\t\tif (serverMetadata.device_authorization_endpoint) {\n\t\t\tthis._createFlows.push({\n\t\t\t\tlabel: nls.localize('device code', \"Device Code\"),\n\t\t\t\thandler: (scopes, progress, token) => this._createWithDeviceCode(scopes, progress, token)\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate async _createWithLoopbackServer(scopes: string[], progress: vscode.Progress<IProgressStep>, token: vscode.CancellationToken): Promise<IAuthorizationTokenResponse> {\n\t\tif (!this._serverMetadata.authorization_endpoint) {\n\t\t\tthrow new Error('Authorization Endpoint required');\n\t\t}\n\t\tif (!this._serverMetadata.token_endpoint) {\n\t\t\tthrow new Error('Token endpoint not available in server metadata');\n\t\t}\n\n\t\t// Generate PKCE code verifier (random string) and code challenge (SHA-256 hash of verifier)\n\t\tconst codeVerifier = this.generateRandomString(64);\n\t\tconst codeChallenge = await this.generateCodeChallenge(codeVerifier);\n\n\t\t// Generate a random state value to prevent CSRF\n\t\tconst nonce = this.generateRandomString(32);\n\t\tconst callbackUri = URI.parse(`${this._initData.environment.appUriScheme}://dynamicauthprovider/${this.authorizationServer.authority}/redirect?nonce=${nonce}`);\n\t\tlet appUri: URI;\n\t\ttry {\n\t\t\tappUri = await this._extHostUrls.createAppUri(callbackUri);\n\t\t} catch (error) {\n\t\t\tthrow new Error(`Failed to create external URI: ${error}`);\n\t\t}\n\n\t\t// Prepare the authorization request URL\n\t\tconst authorizationUrl = new URL(this._serverMetadata.authorization_endpoint);\n\t\tauthorizationUrl.searchParams.append('client_id', this._clientId);\n\t\tauthorizationUrl.searchParams.append('response_type', 'code');\n\t\tauthorizationUrl.searchParams.append('code_challenge', codeChallenge);\n\t\tauthorizationUrl.searchParams.append('code_challenge_method', 'S256');\n\t\tconst scopeString = scopes.join(' ');\n\t\tif (scopeString) {\n\t\t\tauthorizationUrl.searchParams.append('scope', scopeString);\n\t\t}\n\t\tif (this._resourceMetadata?.resource) {\n\t\t\t// If a resource is specified, include it in the request\n\t\t\tauthorizationUrl.searchParams.append('resource', this._resourceMetadata.resource);\n\t\t}\n\n\t\t// Create and start the loopback server\n\t\tconst server = new LoopbackAuthServer(\n\t\t\tthis._logger,\n\t\t\tappUri,\n\t\t\tthis._initData.environment.appName\n\t\t);\n\t\ttry {\n\t\t\tawait server.start();\n\t\t} catch (err) {\n\t\t\tthrow new Error(`Failed to start loopback server: ${err}`);\n\t\t}\n\n\t\t// Update the authorization URL with the actual redirect URI\n\t\tauthorizationUrl.searchParams.set('redirect_uri', server.redirectUri);\n\t\tauthorizationUrl.searchParams.set('state', server.state);\n\n\t\tconst promise = server.waitForOAuthResponse();\n\t\t// Set up a Uri Handler but it's just to redirect not to handle the code\n\t\tvoid this._proxy.$waitForUriHandler(appUri);\n\n\t\ttry {\n\t\t\t// Open the browser for user authorization\n\t\t\tthis._logger.info(`Opening authorization URL for scopes: ${scopeString}`);\n\t\t\tthis._logger.trace(`Authorization URL: ${authorizationUrl.toString()}`);\n\t\t\tconst opened = await this._extHostWindow.openUri(authorizationUrl.toString(), {});\n\t\t\tif (!opened) {\n\t\t\t\tthrow new CancellationError();\n\t\t\t}\n\t\t\tprogress.report({\n\t\t\t\tmessage: nls.localize('completeAuth', \"Complete the authentication in the browser window that has opened.\"),\n\t\t\t});\n\n\t\t\t// Wait for the authorization code via the loopback server\n\t\t\tlet code: string | undefined;\n\t\t\ttry {\n\t\t\t\tconst response = await raceCancellationError(promise, token);\n\t\t\t\tcode = response.code;\n\t\t\t} catch (err) {\n\t\t\t\tif (isCancellationError(err)) {\n\t\t\t\t\tthis._logger.info('Authorization code request was cancelled by the user.');\n\t\t\t\t\tthrow err;\n\t\t\t\t}\n\t\t\t\tthis._logger.error(`Failed to receive authorization code: ${err}`);\n\t\t\t\tthrow new Error(`Failed to receive authorization code: ${err}`);\n\t\t\t}\n\t\t\tthis._logger.info(`Authorization code received for scopes: ${scopeString}`);\n\n\t\t\t// Exchange the authorization code for tokens\n\t\t\tconst tokenResponse = await this.exchangeCodeForToken(code, codeVerifier, server.redirectUri);\n\t\t\treturn tokenResponse;\n\t\t} finally {\n\t\t\t// Clean up the server\n\t\t\tsetTimeout(() => {\n\t\t\t\tvoid server.stop();\n\t\t\t}, 5000);\n\t\t}\n\t}\n\n\tprivate async _createWithDeviceCode(scopes: string[], progress: vscode.Progress<IProgressStep>, token: vscode.CancellationToken): Promise<IAuthorizationTokenResponse> {\n\t\tif (!this._serverMetadata.token_endpoint) {\n\t\t\tthrow new Error('Token endpoint not available in server metadata');\n\t\t}\n\t\tif (!this._serverMetadata.device_authorization_endpoint) {\n\t\t\tthrow new Error('Device authorization endpoint not available in server metadata');\n\t\t}\n\n\t\tconst deviceAuthUrl = this._serverMetadata.device_authorization_endpoint;\n\t\tconst scopeString = scopes.join(' ');\n\t\tthis._logger.info(`Starting device code flow for scopes: ${scopeString}`);\n\n\t\t// Step 1: Request device and user codes\n\t\tconst deviceCodeRequest = new URLSearchParams();\n\t\tdeviceCodeRequest.append('client_id', this._clientId);\n\t\tif (scopeString) {\n\t\t\tdeviceCodeRequest.append('scope', scopeString);\n\t\t}\n\t\tif (this._resourceMetadata?.resource) {\n\t\t\t// If a resource is specified, include it in the request\n\t\t\tdeviceCodeRequest.append('resource', this._resourceMetadata.resource);\n\t\t}\n\n\t\tlet deviceCodeResponse: Response;\n\t\ttry {\n\t\t\tdeviceCodeResponse = await fetch(deviceAuthUrl, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t\t'Accept': 'application/json'\n\t\t\t\t},\n\t\t\t\tbody: deviceCodeRequest.toString()\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tthis._logger.error(`Failed to request device code: ${error}`);\n\t\t\tthrow new Error(`Failed to request device code: ${error}`);\n\t\t}\n\n\t\tif (!deviceCodeResponse.ok) {\n\t\t\tconst text = await deviceCodeResponse.text();\n\t\t\tthrow new Error(`Device code request failed: ${deviceCodeResponse.status} ${deviceCodeResponse.statusText} - ${text}`);\n\t\t}\n\n\t\tconst deviceCodeData: IAuthorizationDeviceResponse = await deviceCodeResponse.json();\n\t\tif (!isAuthorizationDeviceResponse(deviceCodeData)) {\n\t\t\tthis._logger.error('Invalid device code response received from server');\n\t\t\tthrow new Error('Invalid device code response received from server');\n\t\t}\n\t\tthis._logger.info(`Device code received: ${deviceCodeData.user_code}`);\n\n\t\t// Step 2: Show the device code modal\n\t\tconst userConfirmed = await this._proxy.$showDeviceCodeModal(\n\t\t\tdeviceCodeData.user_code,\n\t\t\tdeviceCodeData.verification_uri\n\t\t);\n\n\t\tif (!userConfirmed) {\n\t\t\tthrow new CancellationError();\n\t\t}\n\n\t\t// Step 3: Poll for token\n\t\tprogress.report({\n\t\t\tmessage: nls.localize('waitingForAuth', \"Open [{0}]({0}) in a new tab and paste your one-time code: {1}\", deviceCodeData.verification_uri, deviceCodeData.user_code)\n\t\t});\n\n\t\tconst pollInterval = (deviceCodeData.interval || 5) * 1000; // Convert to milliseconds\n\t\tconst expiresAt = Date.now() + (deviceCodeData.expires_in * 1000);\n\n\t\twhile (Date.now() < expiresAt) {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\tthrow new CancellationError();\n\t\t\t}\n\n\t\t\t// Wait for the specified interval\n\t\t\tawait new Promise(resolve => setTimeout(resolve, pollInterval));\n\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\tthrow new CancellationError();\n\t\t\t}\n\n\t\t\t// Poll the token endpoint\n\t\t\tconst tokenRequest = new URLSearchParams();\n\t\t\ttokenRequest.append('grant_type', 'urn:ietf:params:oauth:grant-type:device_code');\n\t\t\ttokenRequest.append('device_code', deviceCodeData.device_code);\n\t\t\ttokenRequest.append('client_id', this._clientId);\n\n\t\t\t// Add resource indicator if available (RFC 8707)\n\t\t\tif (this._resourceMetadata?.resource) {\n\t\t\t\ttokenRequest.append('resource', this._resourceMetadata.resource);\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst tokenResponse = await fetch(this._serverMetadata.token_endpoint, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t\t\t'Accept': 'application/json'\n\t\t\t\t\t},\n\t\t\t\t\tbody: tokenRequest.toString()\n\t\t\t\t});\n\n\t\t\t\tif (tokenResponse.ok) {\n\t\t\t\t\tconst tokenData: IAuthorizationTokenResponse = await tokenResponse.json();\n\t\t\t\t\tif (!isAuthorizationTokenResponse(tokenData)) {\n\t\t\t\t\t\tthis._logger.error('Invalid token response received from server');\n\t\t\t\t\t\tthrow new Error('Invalid token response received from server');\n\t\t\t\t\t}\n\t\t\t\t\tthis._logger.info(`Device code flow completed successfully for scopes: ${scopeString}`);\n\t\t\t\t\treturn tokenData;\n\t\t\t\t} else {\n\t\t\t\t\tlet errorData: IAuthorizationDeviceTokenErrorResponse;\n\t\t\t\t\ttry {\n\t\t\t\t\t\terrorData = await tokenResponse.json();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tthis._logger.error(`Failed to parse error response: ${e}`);\n\t\t\t\t\t\tthrow new Error(`Token request failed with status ${tokenResponse.status}: ${tokenResponse.statusText}`);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Handle known error cases\n\t\t\t\t\tif (errorData.error === AuthorizationDeviceCodeErrorType.AuthorizationPending) {\n\t\t\t\t\t\t// User hasn't completed authorization yet, continue polling\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t} else if (errorData.error === AuthorizationDeviceCodeErrorType.SlowDown) {\n\t\t\t\t\t\t// Server is asking us to slow down\n\t\t\t\t\t\tawait new Promise(resolve => setTimeout(resolve, pollInterval));\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t} else if (errorData.error === AuthorizationDeviceCodeErrorType.ExpiredToken) {\n\t\t\t\t\t\tthrow new Error('Device code expired. Please try again.');\n\t\t\t\t\t} else if (errorData.error === AuthorizationDeviceCodeErrorType.AccessDenied) {\n\t\t\t\t\t\tthrow new CancellationError();\n\t\t\t\t\t} else if (errorData.error === AuthorizationErrorType.InvalidClient) {\n\t\t\t\t\t\tthis._logger.warn(`Client ID (${this._clientId}) was invalid, generated a new one.`);\n\t\t\t\t\t\tawait this._generateNewClientId();\n\t\t\t\t\t\tthrow new Error(`Client ID was invalid, generated a new one. Please try again.`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow new Error(`Token request failed: ${errorData.error_description || errorData.error || 'Unknown error'}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tif (isCancellationError(error)) {\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t\tthrow new Error(`Error polling for token: ${error}`);\n\t\t\t}\n\t\t}\n\n\t\tthrow new Error('Device code flow timed out. Please try again.');\n\t}\n}\n\nexport class NodeExtHostAuthentication extends ExtHostAuthentication implements IExtHostAuthentication {\n\n\tprotected override readonly _dynamicAuthProviderCtor = NodeDynamicAuthProvider;\n\n\tconstructor(\n\t\textHostRpc: IExtHostRpcService,\n\t\tinitData: IExtHostInitDataService,\n\t\textHostWindow: IExtHostWindow,\n\t\textHostUrls: IExtHostUrlsService,\n\t\textHostProgress: IExtHostProgress,\n\t\textHostLoggerService: ILoggerService,\n\t\textHostLogService: ILogService\n\t) {\n\t\tsuper(extHostRpc, initData, extHostWindow, extHostUrls, extHostProgress, extHostLoggerService, extHostLogService);\n\t}\n}\n"]}