{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/test/common/extensionHostMain.test.ts","vs/workbench/api/test/common/extensionHostMain.test.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,MAAM,MAAM,QAAQ,CAAC;AAC5B,OAAO,EAAmB,YAAY,EAAE,iBAAiB,EAAE,MAAM,mCAAmC,CAAC;AACrG,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAE,MAAM,qCAAqC,CAAC;AAC1E,OAAO,EAAE,iBAAiB,EAAE,MAAM,8CAA8C,CAAC;AAEjF,OAAO,EAAE,IAAI,EAAE,MAAM,sCAAsC,CAAC;AAC5D,OAAO,EAAE,uCAAuC,EAAE,MAAM,uCAAuC,CAAC;AAEhG,OAAO,EAAE,oBAAoB,EAAE,MAAM,mEAAmE,CAAC;AACzG,OAAO,EAAE,iBAAiB,EAAE,MAAM,gEAAgE,CAAC;AACnG,OAAO,EAAE,WAAW,EAAE,cAAc,EAAE,MAAM,wCAAwC,CAAC;AAErF,OAAO,EAAE,cAAc,EAAE,wBAAwB,EAAE,MAAM,yCAAyC,CAAC;AACnG,OAAO,EAAE,kBAAkB,EAAE,MAAM,mCAAmC,CAAC;AACvE,OAAO,EAAE,iBAAiB,EAAE,MAAM,kCAAkC,CAAC;AACrE,OAAO,EAAE,YAAY,EAAE,MAAM,mCAAmC,CAAC;AACjE,OAAO,EAAE,wBAAwB,EAAE,MAAM,mDAAmD,CAAC;AAE7F,OAAO,EAAE,6BAA6B,EAAE,yBAAyB,EAAE,MAAM,8CAA8C,CAAC;AACxH,OAAO,EAAE,4BAA4B,EAA2B,MAAM,qEAAqE,CAAC;AAG5I,KAAK,CAAC,qHAAqH,EAAE;IAE5H,IAAI,SAAS,IAAI,QAAQ,EAAE,CAAC;QAC3B,OAAO;IACR,CAAC;IAED,MAAM,eAAe,GAAG,iBAAiB,CAAC,OAAO,EAAyB,CAAC;IAC3E,MAAM,2BAA2B,GAAG,IAAI,KAAM,SAAQ,IAAI,EAAmC;QACnF,wBAAwB,CAAC,WAAgC,EAAE,IAAqB;QAEzF,CAAC;QACD,kBAAkB,CAAC,GAA0B;QAE7C,CAAC;KACD,CAAC;IAEF,MAAM,2BAA2B,GAA4B;QAC5D,oBAAoB,EAAE,CAAC,oBAA2C,EAAY,EAAE;YAC/E,OAAO,EAAE,CAAC;QACX,CAAC;KACD,CAAC;IAEF,MAAM,UAAU,GAAG,IAAI,iBAAiB,CACvC,CAAC,WAAW,EAAE,IAAI,cAAc,EAAE,CAAC,EACnC,CAAC,iBAAiB,EAAE,IAAI,KAAM,SAAQ,IAAI,EAAqB;YAErD,gBAAgB,CAAC,SAA8B,EAAE,KAAY;gBACrE,OAAO,IAAI,CAAC;YACb,CAAC;SACD,CAAC,EACF,CAAC,wBAAwB,EAAE,IAAI,KAAM,SAAQ,IAAI,EAAkC;YAElF,qBAAqB;gBACpB,OAAO,IAAI,KAAM,SAAQ,cAAc;oBAC7B,UAAU,CAAC,GAAQ;wBAC3B,eAAe,EAAE,CAAC;wBAClB,OAAO,wBAAwB,CAAC;oBACjC,CAAC;iBAED,CAAC,eAAe,CAAC,CAAC;YACpB,CAAC;YACD,oBAAoB;gBACnB,OAAO,IAAI,KAAM,SAAQ,4BAA4B;oBAC3C,uBAAuB,CAAC,WAAyC;wBACzE,OAAO,wBAAwB,CAAC;oBACjC,CAAC;iBACD,CAAC,2BAA2B,EAAE,EAAE,CAAC,CAAC;YACpC,CAAC;SACD,CAAC,EACF,CAAC,kBAAkB,EAAE,IAAI,KAAM,SAAQ,IAAI,EAAsB;YAEvD,QAAQ,CAAI,UAA8B;gBAClD,mDAAmD;gBACnD,OAAY,2BAA2B,CAAC;YACzC,CAAC;SACD,CAAC,EACF,CAAC,6BAA6B,EAAE,yBAAyB,CAAC,CAC1D,CAAC;IAEF,MAAM,yBAAyB,GAAG,KAAK,CAAC,iBAAiB,CAAC;IAC1D,MAAM,KAAK,GAAG,IAAI,oBAAoB,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;IAE1D,IAAI,oBAAsC,CAAC;IAC3C,IAAI,eAAe,GAAG,CAAC,CAAC;IAExB,uCAAuC,EAAE,CAAC;IAE1C,UAAU,CAAC,KAAK;QACf,oBAAoB,GAAG,YAAY,CAAC,yBAAyB,EAAE,CAAC;QAChE,MAAM,KAAK,CAAC,cAAc,CAAC,YAAY,CAAC,kBAAkB,CAAC,CAAC;IAC7D,CAAC,CAAC,CAAC;IAEH,aAAa,CAAC;QACb,YAAY,CAAC,yBAAyB,CAAC,oBAAoB,CAAC,CAAC;IAC9D,CAAC,CAAC,CAAC;IAEH,KAAK,CAAC,KAAK;QACV,eAAe,GAAG,CAAC,CAAC;IACrB,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,GAAG,EAAE;QACb,KAAK,CAAC,iBAAiB,GAAG,yBAAyB,CAAC;IACrD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,QAAQ,EAAE;QAEd,MAAM,GAAG,GAAG,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC;QAE/B,iBAAiB,CAAC,GAAG,CAAC,CAAC;QAEvB,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;IAExC,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,sCAAsC,EAAE;QAE5C,MAAM,QAAQ,GAAG,KAAK,CAAC,iBAAiB,CAAC;QACzC,KAAK,CAAC,iBAAiB,GAAG,CAAC,MAAM,EAAE,MAAM,EAAE,EAAE,CAAC,OAAO,CAAC;QACtD,MAAM,QAAQ,GAAG,IAAI,KAAK,EAAE,CAAC;QAC7B,MAAM,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC;QAC7B,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC;QACjB,KAAK,CAAC,iBAAiB,GAAG,QAAQ,CAAC;QACnC,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;QAEvC,kBAAkB;QAClB,iBAAiB,CAAC,QAAQ,CAAC,CAAC;QAC5B,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;QAEvC,iBAAiB;QACjB,MAAM,GAAG,GAAG,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC;QAC/B,iBAAiB,CAAC,GAAG,CAAC,CAAC;QAEvB,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;IACxC,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,iCAAiC,EAAE;QAEvC,SAAS,iBAAiB,CAAC,MAAc;YACxC,OAAO,MAAM,CAAC;QACf,CAAC;QAED,MAAM,QAAQ,GAAG,KAAK,CAAC,iBAAiB,CAAC;QACzC,KAAK,CAAC,iBAAiB,GAAG,CAAC,GAAG,IAAI,EAAE,EAAE;YACrC,OAAO,iBAAiB,CAAC,QAAQ,EAAE,CAAC,GAAG,IAAI,CAAC,CAAC,CAAC;QAC/C,CAAC,CAAC;QACF,MAAM,QAAQ,GAAG,IAAI,KAAK,EAAE,CAAC;QAC7B,MAAM,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC;QAC7B,MAAM,CAAC,EAAE,CAAC,KAAK,CAAC,CAAC;QAGjB,iBAAiB,CAAC,QAAQ,CAAC,CAAC;QAC5B,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;IACxC,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,oBAAoB,EAAE;QAE1B,IAAI,kBAAkB,GAAG,CAAC,CAAC;QAC3B,SAAS,YAAY,CAAC,MAAW;YAChC,kBAAkB,EAAE,CAAC;QACtB,CAAC;QAED,KAAK,CAAC,iBAAiB,GAAG,CAAC,MAAM,EAAE,KAAK,EAAE,EAAE;YAC3C,YAAY,CAAC,KAAK,CAAC,CAAC;YACpB,OAAO,WAAW,CAAC;QACpB,CAAC,CAAC;QAEF,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,EAAE,EAAE,CAAC,EAAE,CAAC;YAChC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;QACnD,CAAC;QAED,MAAM,QAAQ,GAAG,IAAI,KAAK,EAAE,CAAC;QAC7B,MAAM,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC;QAC7B,MAAM,CAAC,WAAW,CAAC,KAAK,EAAE,WAAW,CAAC,CAAC;QAEvC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;QAC5B,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;QAEvC,MAAM,SAAS,GAAG,IAAI,KAAK,EAAE,CAAC;QAC9B,iBAAiB,CAAC,SAAS,CAAC,CAAC;QAC7B,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;QACvC,MAAM,CAAC,WAAW,CAAC,kBAAkB,EAAE,CAAC,CAAC,CAAC;IAC3C,CAAC,CAAC,CAAC;IAGH,KAAK,CAAC,wEAAwE,EAAE;QAE/E,IAAI,CAAC,+BAA+B,EAAE,GAAG,EAAE;YAC1C,cAAc;YACd,IAAI,QAAQ,CAAC;YAEb,cAAc;YACd,QAAQ,GAAG,KAAK,CAAC,iBAAiB,CAAC;YACnC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,IAAI,GAAG,IAAI,KAAK,EAAE,CAAC;YACzB,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACtB,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;YACvC,KAAK,CAAC,iBAAiB,GAAG,QAAQ,CAAC;YAEnC,cAAc;YACd,QAAQ,GAAG,KAAK,CAAC,iBAAiB,CAAC;YACnC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,CAAC,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,KAAK,CAAC,CAAC;YAC7B,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;YACvC,KAAK,CAAC,iBAAiB,GAAG,QAAQ,CAAC;YAEnC,cAAc;YACd,QAAQ,GAAG,KAAK,CAAC,iBAAiB,CAAC;YACnC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,CAAC,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,KAAK,CAAC,CAAC;YAC7B,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;YACvC,KAAK,CAAC,iBAAiB,GAAG,QAAQ,CAAC;YAEnC,cAAc;YACd,QAAQ,GAAG,KAAK,CAAC,iBAAiB,CAAC;YACnC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,CAAC,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,KAAK,CAAC,CAAC;YAC7B,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;YACvC,KAAK,CAAC,iBAAiB,GAAG,QAAQ,CAAC;YAEnC,sBAAsB;YACtB,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACtB,MAAM,CAAC,WAAW,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC;QACxC,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,qCAAqC,EAAE,GAAG,EAAE;YAChD,cAAc;YACd,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,CAAC,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,KAAK,CAAC,CAAC;YAE7B,cAAc;YACd,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,CAAC,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,KAAK,CAAC,CAAC;YAE7B,cAAc;YACd,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,CAAC,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,KAAK,CAAC,CAAC;YAE7B,cAAc;YACd,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,CAAC,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,KAAK,CAAC,CAAC;QAC9B,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC7D,MAAM,QAAQ,GAAG,KAAK,CAAC,iBAAiB,CAAC;YACzC,KAAK,CAAC,iBAAiB,GAAG,CAAC,CAAC,EAAE,KAAK,EAAE,EAAE,CAAC,KAAK,CAAC;YAE9C,iDAAiD;YACjD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;gBAAC,KAAK,CAAC,iBAAiB,GAAG,KAAK,CAAC,iBAAiB,CAAC;YAAC,CAAC;YACvF,MAAM,CAAC,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,KAAK,CAAC,CAAC;YAE7B,KAAK,CAAC,iBAAiB,GAAG,QAAQ,CAAC;QACpC,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC","file":"extensionHostMain.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { SerializedError, errorHandler, onUnexpectedError } from '../../../../base/common/errors.js';\nimport { isFirefox, isSafari } from '../../../../base/common/platform.js';\nimport { TernarySearchTree } from '../../../../base/common/ternarySearchTree.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { mock } from '../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { ExtensionIdentifier, IExtensionDescription } from '../../../../platform/extensions/common/extensions.js';\nimport { InstantiationService } from '../../../../platform/instantiation/common/instantiationService.js';\nimport { ServiceCollection } from '../../../../platform/instantiation/common/serviceCollection.js';\nimport { ILogService, NullLogService } from '../../../../platform/log/common/log.js';\nimport { MainThreadErrorsShape, MainThreadExtensionServiceShape } from '../../common/extHost.protocol.js';\nimport { ExtensionPaths, IExtHostExtensionService } from '../../common/extHostExtensionService.js';\nimport { IExtHostRpcService } from '../../common/extHostRpcService.js';\nimport { IExtHostTelemetry } from '../../common/extHostTelemetry.js';\nimport { ErrorHandler } from '../../common/extensionHostMain.js';\nimport { nullExtensionDescription } from '../../../services/extensions/common/extensions.js';\nimport { ProxyIdentifier, Proxied } from '../../../services/extensions/common/proxyIdentifier.js';\nimport { IExtHostApiDeprecationService, NullApiDeprecationService } from '../../common/extHostApiDeprecationService.js';\nimport { ExtensionDescriptionRegistry, IActivationEventsReader } from '../../../services/extensions/common/extensionDescriptionRegistry.js';\n\n\nsuite('ExtensionHostMain#ErrorHandler - Wrapping prepareStackTrace can cause slowdown and eventual stack overflow #184926 ', function () {\n\n\tif (isFirefox || isSafari) {\n\t\treturn;\n\t}\n\n\tconst extensionsIndex = TernarySearchTree.forUris<IExtensionDescription>();\n\tconst mainThreadExtensionsService = new class extends mock<MainThreadExtensionServiceShape>() implements MainThreadErrorsShape {\n\t\toverride $onExtensionRuntimeError(extensionId: ExtensionIdentifier, data: SerializedError): void {\n\n\t\t}\n\t\t$onUnexpectedError(err: any | SerializedError): void {\n\n\t\t}\n\t};\n\n\tconst basicActivationEventsReader: IActivationEventsReader = {\n\t\treadActivationEvents: (extensionDescription: IExtensionDescription): string[] => {\n\t\t\treturn [];\n\t\t}\n\t};\n\n\tconst collection = new ServiceCollection(\n\t\t[ILogService, new NullLogService()],\n\t\t[IExtHostTelemetry, new class extends mock<IExtHostTelemetry>() {\n\t\t\tdeclare readonly _serviceBrand: undefined;\n\t\t\toverride onExtensionError(extension: ExtensionIdentifier, error: Error): boolean {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}],\n\t\t[IExtHostExtensionService, new class extends mock<IExtHostExtensionService & any>() {\n\t\t\tdeclare readonly _serviceBrand: undefined;\n\t\t\tgetExtensionPathIndex() {\n\t\t\t\treturn new class extends ExtensionPaths {\n\t\t\t\t\toverride findSubstr(key: URI): IExtensionDescription | undefined {\n\t\t\t\t\t\tfindSubstrCount++;\n\t\t\t\t\t\treturn nullExtensionDescription;\n\t\t\t\t\t}\n\n\t\t\t\t}(extensionsIndex);\n\t\t\t}\n\t\t\tgetExtensionRegistry() {\n\t\t\t\treturn new class extends ExtensionDescriptionRegistry {\n\t\t\t\t\toverride getExtensionDescription(extensionId: ExtensionIdentifier | string): IExtensionDescription | undefined {\n\t\t\t\t\t\treturn nullExtensionDescription;\n\t\t\t\t\t}\n\t\t\t\t}(basicActivationEventsReader, []);\n\t\t\t}\n\t\t}],\n\t\t[IExtHostRpcService, new class extends mock<IExtHostRpcService>() {\n\t\t\tdeclare readonly _serviceBrand: undefined;\n\t\t\toverride getProxy<T>(identifier: ProxyIdentifier<T>): Proxied<T> {\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\treturn <any>mainThreadExtensionsService;\n\t\t\t}\n\t\t}],\n\t\t[IExtHostApiDeprecationService, NullApiDeprecationService],\n\t);\n\n\tconst originalPrepareStackTrace = Error.prepareStackTrace;\n\tconst insta = new InstantiationService(collection, false);\n\n\tlet existingErrorHandler: (e: any) => void;\n\tlet findSubstrCount = 0;\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tsuiteSetup(async function () {\n\t\texistingErrorHandler = errorHandler.getUnexpectedErrorHandler();\n\t\tawait insta.invokeFunction(ErrorHandler.installFullHandler);\n\t});\n\n\tsuiteTeardown(function () {\n\t\terrorHandler.setUnexpectedErrorHandler(existingErrorHandler);\n\t});\n\n\tsetup(async function () {\n\t\tfindSubstrCount = 0;\n\t});\n\n\tteardown(() => {\n\t\tError.prepareStackTrace = originalPrepareStackTrace;\n\t});\n\n\ttest('basics', function () {\n\n\t\tconst err = new Error('test1');\n\n\t\tonUnexpectedError(err);\n\n\t\tassert.strictEqual(findSubstrCount, 1);\n\n\t});\n\n\ttest('set/reset prepareStackTrace-callback', function () {\n\n\t\tconst original = Error.prepareStackTrace;\n\t\tError.prepareStackTrace = (_error, _stack) => 'stack';\n\t\tconst probeErr = new Error();\n\t\tconst stack = probeErr.stack;\n\t\tassert.ok(stack);\n\t\tError.prepareStackTrace = original;\n\t\tassert.strictEqual(findSubstrCount, 1);\n\n\t\t// already checked\n\t\tonUnexpectedError(probeErr);\n\t\tassert.strictEqual(findSubstrCount, 1);\n\n\t\t// one more error\n\t\tconst err = new Error('test2');\n\t\tonUnexpectedError(err);\n\n\t\tassert.strictEqual(findSubstrCount, 2);\n\t});\n\n\ttest('wrap prepareStackTrace-callback', function () {\n\n\t\tfunction do_something_else(params: string) {\n\t\t\treturn params;\n\t\t}\n\n\t\tconst original = Error.prepareStackTrace;\n\t\tError.prepareStackTrace = (...args) => {\n\t\t\treturn do_something_else(original?.(...args));\n\t\t};\n\t\tconst probeErr = new Error();\n\t\tconst stack = probeErr.stack;\n\t\tassert.ok(stack);\n\n\n\t\tonUnexpectedError(probeErr);\n\t\tassert.strictEqual(findSubstrCount, 1);\n\t});\n\n\ttest('prevent rewrapping', function () {\n\n\t\tlet do_something_count = 0;\n\t\tfunction do_something(params: any) {\n\t\t\tdo_something_count++;\n\t\t}\n\n\t\tError.prepareStackTrace = (result, stack) => {\n\t\t\tdo_something(stack);\n\t\t\treturn 'fakestack';\n\t\t};\n\n\t\tfor (let i = 0; i < 2_500; ++i) {\n\t\t\tError.prepareStackTrace = Error.prepareStackTrace;\n\t\t}\n\n\t\tconst probeErr = new Error();\n\t\tconst stack = probeErr.stack;\n\t\tassert.strictEqual(stack, 'fakestack');\n\n\t\tonUnexpectedError(probeErr);\n\t\tassert.strictEqual(findSubstrCount, 1);\n\n\t\tconst probeErr2 = new Error();\n\t\tonUnexpectedError(probeErr2);\n\t\tassert.strictEqual(findSubstrCount, 2);\n\t\tassert.strictEqual(do_something_count, 2);\n\t});\n\n\n\tsuite('https://gist.github.com/thecrypticace/f0f2e182082072efdaf0f8e1537d2cce', function () {\n\n\t\ttest('Restored, separate operations', () => {\n\t\t\t// Actual Test\n\t\t\tlet original;\n\n\t\t\t// Operation 1\n\t\t\toriginal = Error.prepareStackTrace;\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tconst err1 = new Error();\n\t\t\tassert.ok(err1.stack);\n\t\t\tassert.strictEqual(findSubstrCount, 1);\n\t\t\tError.prepareStackTrace = original;\n\n\t\t\t// Operation 2\n\t\t\toriginal = Error.prepareStackTrace;\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\t\t\tassert.strictEqual(findSubstrCount, 2);\n\t\t\tError.prepareStackTrace = original;\n\n\t\t\t// Operation 3\n\t\t\toriginal = Error.prepareStackTrace;\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\t\t\tassert.strictEqual(findSubstrCount, 3);\n\t\t\tError.prepareStackTrace = original;\n\n\t\t\t// Operation 4\n\t\t\toriginal = Error.prepareStackTrace;\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\t\t\tassert.strictEqual(findSubstrCount, 4);\n\t\t\tError.prepareStackTrace = original;\n\n\t\t\t// Back to Operation 1\n\t\t\tassert.ok(err1.stack);\n\t\t\tassert.strictEqual(findSubstrCount, 4);\n\t\t});\n\n\t\ttest('Never restored, separate operations', () => {\n\t\t\t// Operation 1\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\n\t\t\t// Operation 2\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\n\t\t\t// Operation 3\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\n\t\t\t// Operation 4\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\t\t});\n\n\t\ttest('Restored, too many uses before restoration', async () => {\n\t\t\tconst original = Error.prepareStackTrace;\n\t\t\tError.prepareStackTrace = (_, stack) => stack;\n\n\t\t\t// Operation 1 — more uses of `prepareStackTrace`\n\t\t\tfor (let i = 0; i < 10_000; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\n\t\t\tError.prepareStackTrace = original;\n\t\t});\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { SerializedError, errorHandler, onUnexpectedError } from '../../../../base/common/errors.js';\nimport { isFirefox, isSafari } from '../../../../base/common/platform.js';\nimport { TernarySearchTree } from '../../../../base/common/ternarySearchTree.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { mock } from '../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { ExtensionIdentifier, IExtensionDescription } from '../../../../platform/extensions/common/extensions.js';\nimport { InstantiationService } from '../../../../platform/instantiation/common/instantiationService.js';\nimport { ServiceCollection } from '../../../../platform/instantiation/common/serviceCollection.js';\nimport { ILogService, NullLogService } from '../../../../platform/log/common/log.js';\nimport { MainThreadErrorsShape, MainThreadExtensionServiceShape } from '../../common/extHost.protocol.js';\nimport { ExtensionPaths, IExtHostExtensionService } from '../../common/extHostExtensionService.js';\nimport { IExtHostRpcService } from '../../common/extHostRpcService.js';\nimport { IExtHostTelemetry } from '../../common/extHostTelemetry.js';\nimport { ErrorHandler } from '../../common/extensionHostMain.js';\nimport { nullExtensionDescription } from '../../../services/extensions/common/extensions.js';\nimport { ProxyIdentifier, Proxied } from '../../../services/extensions/common/proxyIdentifier.js';\nimport { IExtHostApiDeprecationService, NullApiDeprecationService } from '../../common/extHostApiDeprecationService.js';\nimport { ExtensionDescriptionRegistry, IActivationEventsReader } from '../../../services/extensions/common/extensionDescriptionRegistry.js';\n\n\nsuite('ExtensionHostMain#ErrorHandler - Wrapping prepareStackTrace can cause slowdown and eventual stack overflow #184926 ', function () {\n\n\tif (isFirefox || isSafari) {\n\t\treturn;\n\t}\n\n\tconst extensionsIndex = TernarySearchTree.forUris<IExtensionDescription>();\n\tconst mainThreadExtensionsService = new class extends mock<MainThreadExtensionServiceShape>() implements MainThreadErrorsShape {\n\t\toverride $onExtensionRuntimeError(extensionId: ExtensionIdentifier, data: SerializedError): void {\n\n\t\t}\n\t\t$onUnexpectedError(err: any | SerializedError): void {\n\n\t\t}\n\t};\n\n\tconst basicActivationEventsReader: IActivationEventsReader = {\n\t\treadActivationEvents: (extensionDescription: IExtensionDescription): string[] => {\n\t\t\treturn [];\n\t\t}\n\t};\n\n\tconst collection = new ServiceCollection(\n\t\t[ILogService, new NullLogService()],\n\t\t[IExtHostTelemetry, new class extends mock<IExtHostTelemetry>() {\n\t\t\tdeclare readonly _serviceBrand: undefined;\n\t\t\toverride onExtensionError(extension: ExtensionIdentifier, error: Error): boolean {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}],\n\t\t[IExtHostExtensionService, new class extends mock<IExtHostExtensionService & any>() {\n\t\t\tdeclare readonly _serviceBrand: undefined;\n\t\t\tgetExtensionPathIndex() {\n\t\t\t\treturn new class extends ExtensionPaths {\n\t\t\t\t\toverride findSubstr(key: URI): IExtensionDescription | undefined {\n\t\t\t\t\t\tfindSubstrCount++;\n\t\t\t\t\t\treturn nullExtensionDescription;\n\t\t\t\t\t}\n\n\t\t\t\t}(extensionsIndex);\n\t\t\t}\n\t\t\tgetExtensionRegistry() {\n\t\t\t\treturn new class extends ExtensionDescriptionRegistry {\n\t\t\t\t\toverride getExtensionDescription(extensionId: ExtensionIdentifier | string): IExtensionDescription | undefined {\n\t\t\t\t\t\treturn nullExtensionDescription;\n\t\t\t\t\t}\n\t\t\t\t}(basicActivationEventsReader, []);\n\t\t\t}\n\t\t}],\n\t\t[IExtHostRpcService, new class extends mock<IExtHostRpcService>() {\n\t\t\tdeclare readonly _serviceBrand: undefined;\n\t\t\toverride getProxy<T>(identifier: ProxyIdentifier<T>): Proxied<T> {\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\treturn <any>mainThreadExtensionsService;\n\t\t\t}\n\t\t}],\n\t\t[IExtHostApiDeprecationService, NullApiDeprecationService],\n\t);\n\n\tconst originalPrepareStackTrace = Error.prepareStackTrace;\n\tconst insta = new InstantiationService(collection, false);\n\n\tlet existingErrorHandler: (e: any) => void;\n\tlet findSubstrCount = 0;\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tsuiteSetup(async function () {\n\t\texistingErrorHandler = errorHandler.getUnexpectedErrorHandler();\n\t\tawait insta.invokeFunction(ErrorHandler.installFullHandler);\n\t});\n\n\tsuiteTeardown(function () {\n\t\terrorHandler.setUnexpectedErrorHandler(existingErrorHandler);\n\t});\n\n\tsetup(async function () {\n\t\tfindSubstrCount = 0;\n\t});\n\n\tteardown(() => {\n\t\tError.prepareStackTrace = originalPrepareStackTrace;\n\t});\n\n\ttest('basics', function () {\n\n\t\tconst err = new Error('test1');\n\n\t\tonUnexpectedError(err);\n\n\t\tassert.strictEqual(findSubstrCount, 1);\n\n\t});\n\n\ttest('set/reset prepareStackTrace-callback', function () {\n\n\t\tconst original = Error.prepareStackTrace;\n\t\tError.prepareStackTrace = (_error, _stack) => 'stack';\n\t\tconst probeErr = new Error();\n\t\tconst stack = probeErr.stack;\n\t\tassert.ok(stack);\n\t\tError.prepareStackTrace = original;\n\t\tassert.strictEqual(findSubstrCount, 1);\n\n\t\t// already checked\n\t\tonUnexpectedError(probeErr);\n\t\tassert.strictEqual(findSubstrCount, 1);\n\n\t\t// one more error\n\t\tconst err = new Error('test2');\n\t\tonUnexpectedError(err);\n\n\t\tassert.strictEqual(findSubstrCount, 2);\n\t});\n\n\ttest('wrap prepareStackTrace-callback', function () {\n\n\t\tfunction do_something_else(params: string) {\n\t\t\treturn params;\n\t\t}\n\n\t\tconst original = Error.prepareStackTrace;\n\t\tError.prepareStackTrace = (...args) => {\n\t\t\treturn do_something_else(original?.(...args));\n\t\t};\n\t\tconst probeErr = new Error();\n\t\tconst stack = probeErr.stack;\n\t\tassert.ok(stack);\n\n\n\t\tonUnexpectedError(probeErr);\n\t\tassert.strictEqual(findSubstrCount, 1);\n\t});\n\n\ttest('prevent rewrapping', function () {\n\n\t\tlet do_something_count = 0;\n\t\tfunction do_something(params: any) {\n\t\t\tdo_something_count++;\n\t\t}\n\n\t\tError.prepareStackTrace = (result, stack) => {\n\t\t\tdo_something(stack);\n\t\t\treturn 'fakestack';\n\t\t};\n\n\t\tfor (let i = 0; i < 2_500; ++i) {\n\t\t\tError.prepareStackTrace = Error.prepareStackTrace;\n\t\t}\n\n\t\tconst probeErr = new Error();\n\t\tconst stack = probeErr.stack;\n\t\tassert.strictEqual(stack, 'fakestack');\n\n\t\tonUnexpectedError(probeErr);\n\t\tassert.strictEqual(findSubstrCount, 1);\n\n\t\tconst probeErr2 = new Error();\n\t\tonUnexpectedError(probeErr2);\n\t\tassert.strictEqual(findSubstrCount, 2);\n\t\tassert.strictEqual(do_something_count, 2);\n\t});\n\n\n\tsuite('https://gist.github.com/thecrypticace/f0f2e182082072efdaf0f8e1537d2cce', function () {\n\n\t\ttest('Restored, separate operations', () => {\n\t\t\t// Actual Test\n\t\t\tlet original;\n\n\t\t\t// Operation 1\n\t\t\toriginal = Error.prepareStackTrace;\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tconst err1 = new Error();\n\t\t\tassert.ok(err1.stack);\n\t\t\tassert.strictEqual(findSubstrCount, 1);\n\t\t\tError.prepareStackTrace = original;\n\n\t\t\t// Operation 2\n\t\t\toriginal = Error.prepareStackTrace;\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\t\t\tassert.strictEqual(findSubstrCount, 2);\n\t\t\tError.prepareStackTrace = original;\n\n\t\t\t// Operation 3\n\t\t\toriginal = Error.prepareStackTrace;\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\t\t\tassert.strictEqual(findSubstrCount, 3);\n\t\t\tError.prepareStackTrace = original;\n\n\t\t\t// Operation 4\n\t\t\toriginal = Error.prepareStackTrace;\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\t\t\tassert.strictEqual(findSubstrCount, 4);\n\t\t\tError.prepareStackTrace = original;\n\n\t\t\t// Back to Operation 1\n\t\t\tassert.ok(err1.stack);\n\t\t\tassert.strictEqual(findSubstrCount, 4);\n\t\t});\n\n\t\ttest('Never restored, separate operations', () => {\n\t\t\t// Operation 1\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\n\t\t\t// Operation 2\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\n\t\t\t// Operation 3\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\n\t\t\t// Operation 4\n\t\t\tfor (let i = 0; i < 12_500; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\t\t});\n\n\t\ttest('Restored, too many uses before restoration', async () => {\n\t\t\tconst original = Error.prepareStackTrace;\n\t\t\tError.prepareStackTrace = (_, stack) => stack;\n\n\t\t\t// Operation 1 — more uses of `prepareStackTrace`\n\t\t\tfor (let i = 0; i < 10_000; ++i) { Error.prepareStackTrace = Error.prepareStackTrace; }\n\t\t\tassert.ok(new Error().stack);\n\n\t\t\tError.prepareStackTrace = original;\n\t\t});\n\t});\n});\n"]}