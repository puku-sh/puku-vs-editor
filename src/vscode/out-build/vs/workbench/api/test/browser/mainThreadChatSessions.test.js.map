{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/test/browser/mainThreadChatSessions.test.ts","vs/workbench/api/test/browser/mainThreadChatSessions.test.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,MAAM,MAAM,QAAQ,CAAC;AAC5B,OAAO,KAAK,KAAK,MAAM,OAAO,CAAC;AAC/B,OAAO,EAAE,iBAAiB,EAAE,MAAM,yCAAyC,CAAC;AAC5E,OAAO,EAAE,eAAe,EAAE,MAAM,sCAAsC,CAAC;AACvE,OAAO,EAAE,GAAG,EAAE,MAAM,gCAAgC,CAAC;AACrD,OAAO,EAAE,uCAAuC,EAAE,MAAM,uCAAuC,CAAC;AAChG,OAAO,EAAE,qBAAqB,EAAE,MAAM,4DAA4D,CAAC;AACnG,OAAO,EAAE,wBAAwB,EAAE,MAAM,4EAA4E,CAAC;AACtH,OAAO,EAAE,iBAAiB,EAAE,MAAM,8DAA8D,CAAC;AACjG,OAAO,EAAE,kBAAkB,EAAE,MAAM,sDAAsD,CAAC;AAC1F,OAAO,EAAE,cAAc,EAAE,MAAM,gDAAgD,CAAC;AAChF,OAAO,EAAE,wBAAwB,EAAE,MAAM,4EAA4E,CAAC;AACtH,OAAO,EAAE,WAAW,EAAE,cAAc,EAAE,MAAM,wCAAwC,CAAC;AACrF,OAAO,EAAE,mBAAmB,EAAE,MAAM,4DAA4D,CAAC;AAGjG,OAAO,EAAoB,oBAAoB,EAAE,MAAM,qDAAqD,CAAC;AAC7G,OAAO,EAAE,mBAAmB,EAAE,MAAM,yCAAyC,CAAC;AAC9E,OAAO,EAAE,iBAAiB,EAAE,MAAM,2CAA2C,CAAC;AAC9E,OAAO,EAAE,cAAc,EAAE,MAAM,kDAAkD,CAAC;AAGlF,OAAO,EAAE,iBAAiB,EAAE,MAAM,mDAAmD,CAAC;AACtF,OAAO,EAAE,aAAa,EAAE,MAAM,gDAAgD,CAAC;AAC/E,OAAO,EAAE,IAAI,EAAE,oBAAoB,EAAE,MAAM,+CAA+C,CAAC;AAC3F,OAAO,EAAE,sBAAsB,EAAE,qBAAqB,EAAE,MAAM,yCAAyC,CAAC;AAExG,OAAO,EAAE,aAAa,EAAE,MAAM,4CAA4C,CAAC;AAC3E,OAAO,EAAE,OAAO,EAAE,MAAM,sCAAsC,CAAC;AAE/D,KAAK,CAAC,uBAAuB,EAAE;IAC9B,IAAI,WAA4B,CAAC;IACjC,IAAI,UAAuB,CAAC;IAC5B,IAAI,aAA6B,CAAC;IAClC,IAAI,KAA+B,CAAC;IAEpC,KAAK,CAAC;QACL,WAAW,GAAG,IAAI,eAAe,EAAE,CAAC;QACpC,UAAU,GAAG,IAAI,cAAc,EAAE,CAAC;QAElC,aAAa,GAAG,IAAI,KAAM,SAAQ,IAAI,EAAkB;YAC9C,KAAK,CAAC,OAAO;gBACrB,OAAO,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC;YAC5B,CAAC;SACD,CAAC;QAEF,KAAK,GAAG;YACP,0BAA0B,EAAE,KAAK,CAAC,IAAI,EAAE;YACxC,kCAAkC,EAAE,KAAK,CAAC,IAAI,EAAwG,CAAC,QAAQ,CAAC,SAAS,CAAC;YAC1K,2BAA2B,EAAE,KAAK,CAAC,IAAI,EAAE;YACzC,mCAAmC,EAAE,KAAK,CAAC,IAAI,EAAE;YACjD,gCAAgC,EAAE,KAAK,CAAC,IAAI,EAAE;YAC9C,0BAA0B,EAAE,KAAK,CAAC,IAAI,EAAE;YACxC,wBAAwB,EAAE,KAAK,CAAC,IAAI,EAAE;YACtC,0BAA0B,EAAE,KAAK,CAAC,IAAI,EAAE,CAAC,QAAQ,CAAC,EAAE,KAAK,EAAE,aAAa,EAAsB,CAAC;SAC/F,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC;QACR,WAAW,CAAC,OAAO,EAAE,CAAC;QACtB,KAAK,CAAC,OAAO,EAAE,CAAC;IACjB,CAAC,CAAC,CAAC;IAEH,uCAAuC,EAAE,CAAC;IAE1C,SAAS,oBAAoB,CAAC,UAK1B,EAAE;QACL,OAAO;YACN,EAAE,EAAE,OAAO,CAAC,EAAE,IAAI,SAAS;YAC3B,OAAO,EAAE,OAAO,CAAC,OAAO,IAAI,EAAE;YAC9B,yBAAyB,EAAE,OAAO,CAAC,yBAAyB,IAAI,KAAK;YACrE,iBAAiB,EAAE,OAAO,CAAC,iBAAiB,IAAI,KAAK;SACrD,CAAC;IACH,CAAC;IAED,KAAK,UAAU,wBAAwB,CAAC,cAAmB,EAAE,SAAS,GAAG,SAAS;QACjF,MAAM,QAAQ,GAAG,mBAAmB,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;QAC3D,MAAM,OAAO,GAAG,IAAI,qBAAqB,CAAC,QAAQ,EAAE,CAAC,EAAE,KAAK,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC;QACxF,KAAK,CAAC,0BAA8C,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;QAC/E,MAAM,OAAO,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QACjD,OAAO,OAAO,CAAC;IAChB,CAAC;IAED,IAAI,CAAC,uDAAuD,EAAE;QAC7D,MAAM,SAAS,GAAG,SAAS,CAAC;QAC5B,MAAM,QAAQ,GAAG,mBAAmB,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;QAC3D,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,qBAAqB,CAAC,QAAQ,EAAE,CAAC,EAAE,KAAK,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC,CAAC;QAE1G,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,cAAc,EAAE,CAAC,CAAC,CAAC;QAC9C,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;QAC5C,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;QAC/B,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,aAAa,CAAC,CAAC;QAEjC,kDAAkD;QAClD,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,EAAE,EAAE,EAAE,CAAC,CAAC;QACtD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,KAAK,CAAC,CAAC;IACxD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,sEAAsE,EAAE,KAAK;QACjF,MAAM,SAAS,GAAG,SAAS,CAAC;QAC5B,MAAM,QAAQ,GAAG,mBAAmB,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;QAC3D,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,qBAAqB,CAAC,QAAQ,EAAE,CAAC,EAAE,KAAK,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC,CAAC;QAE1G,MAAM,SAAS,GAAkB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QAC5G,MAAM,SAAS,GAAkB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,OAAO,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QAE5G,wDAAwD;QACxD,OAAO,CAAC,mBAAmB,CAAC,MAAM,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC;QACjD,OAAO,CAAC,mBAAmB,CAAC,MAAM,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC;QAEjD,6CAA6C;QAC7C,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,EAAE,EAAE,EAAE,CAAC,CAAC;QAEtD,yBAAyB;QACzB,MAAM,cAAc,GAAG,oBAAoB,EAAE,CAAC;QAC7C,KAAK,CAAC,0BAA8C,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;QAC/E,MAAM,OAAO,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAEjD,iCAAiC;QACjC,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QACxD,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,EAAE,EAAE,CAAC,SAAS,EAAE,SAAS,CAAC,CAAC,CAAC;QAC1E,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC,CAAC,sFAAsF;IAC9I,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,+DAA+D,EAAE,KAAK;QAC1E,MAAM,cAAc,GAAG;YACtB,EAAE,IAAI,EAAE,SAAS,EAAE,MAAM,EAAE,mBAAmB,EAAE;YAChD,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,iBAAiB,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC,EAAE;SACnH,CAAC;QAEF,MAAM,cAAc,GAAG,oBAAoB,CAAC;YAC3C,OAAO,EAAE,cAAc;YACvB,yBAAyB,EAAE,IAAI;YAC/B,iBAAiB,EAAE,IAAI;SACvB,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,MAAM,wBAAwB,CAAC,cAAc,CAAC,CAAC,CAAC;QAEhF,4BAA4B;QAC5B,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QAC9C,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACvD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,mBAAmB,CAAC,CAAC;QACnE,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;QAExD,kCAAkC;QAClC,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,+BAA+B,CAAC,CAAC;QACnD,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;IACnC,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,uDAAuD,EAAE,KAAK;QAClE,MAAM,SAAS,GAAG,SAAS,CAAC;QAC5B,MAAM,QAAQ,GAAG,mBAAmB,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;QAC3D,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,qBAAqB,CAAC,QAAQ,EAAE,CAAC,EAAE,KAAK,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC,CAAC;QAE1G,MAAM,cAAc,GAAG,oBAAoB,EAAE,CAAC;QAC7C,KAAK,CAAC,0BAA8C,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;QAE/E,MAAM,QAAQ,GAAG,OAAO,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAC5D,MAAM,QAAQ,GAAG,OAAO,CAAC,UAAU,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAE5D,MAAM,CAAC,WAAW,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;QACvC,MAAM,QAAQ,CAAC;QAEf,sEAAsE;QACtE,MAAM,CAAC,EAAE,CAAE,KAAK,CAAC,0BAA8C,CAAC,UAAU,CAAC,CAAC;IAC7E,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,wDAAwD,EAAE,KAAK;QACnE,MAAM,cAAc,GAAG,oBAAoB,EAAE,CAAC;QAC9C,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,MAAM,wBAAwB,CAAC,cAAc,CAAC,CAAC,CAAC;QAEhF,MAAM,QAAQ,GAAkB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,cAAc,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QAElH,oCAAoC;QACpC,OAAO,CAAC,mBAAmB,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,CAAC,CAAC;QAEhD,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,EAAE,EAAE,CAAC,QAAQ,CAAC,CAAC,CAAC;QAC9D,sDAAsD;QACtD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;IACvD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,qDAAqD,EAAE,KAAK;QAChE,MAAM,cAAc,GAAG,oBAAoB,EAAE,CAAC;QAC9C,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,MAAM,wBAAwB,CAAC,cAAc,CAAC,CAAC,CAAC;QAEhF,0BAA0B;QAC1B,MAAM,QAAQ,GAAkB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,eAAe,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QACnH,OAAO,CAAC,mBAAmB,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,CAAC,CAAC;QAEhD,0DAA0D;QAC1D,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;QACtD,OAAO,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC;QACvC,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;IACvD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,6EAA6E,EAAE,KAAK;QACxF,MAAM,cAAc,GAAG,oBAAoB,CAAC,EAAE,yBAAyB,EAAE,IAAI,EAAE,CAAC,CAAC;QACjF,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,MAAM,wBAAwB,CAAC,cAAc,CAAC,CAAC,CAAC;QAEhF,yFAAyF;QACzF,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,KAAK,CAAC,CAAC;QAEvD,MAAM,QAAQ,GAAkB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,eAAe,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QACnH,OAAO,CAAC,mBAAmB,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,CAAC,CAAC;QAEhD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,KAAK,CAAC,CAAC;QACvD,OAAO,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC;QAEvC,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;IACvD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,4CAA4C,EAAE,KAAK;QACvD,MAAM,cAAc,GAAG,oBAAoB,CAAC,EAAE,iBAAiB,EAAE,IAAI,EAAE,CAAC,CAAC;QACzE,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,MAAM,wBAAwB,CAAC,cAAc,CAAC,CAAC,CAAC;QAEhF,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;QAElC,MAAM,OAAO,GAAsB;YAClC,SAAS,EAAE,MAAM;YACjB,SAAS,EAAE,cAAc;YACzB,eAAe,EAAE,mBAAmB,CAAC,UAAU,CAAC,cAAc,CAAC;YAC/D,OAAO,EAAE,YAAY;YACrB,OAAO,EAAE,aAAa;YACtB,QAAQ,EAAE,iBAAiB,CAAC,IAAI;YAChC,SAAS,EAAE,EAAE,SAAS,EAAE,EAAE,EAAE;SAC5B,CAAC;QACF,MAAM,gBAAgB,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;QAEtC,MAAM,OAAO,CAAC,cAAe,CAAC,OAAO,EAAE,gBAAgB,EAAE,EAAE,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAErF,MAAM,CAAC,EAAE,CAAE,KAAK,CAAC,gCAA4G,CAAC,cAAc,CAAC,CAAC,EAAE,OAAO,CAAC,eAAe,EAAE,OAAO,EAAE,EAAE,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC,CAAC;IAChN,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,gEAAgE,EAAE,KAAK;QAC3E,MAAM,cAAc,GAAG,oBAAoB,CAAC,EAAE,iBAAiB,EAAE,IAAI,EAAE,CAAC,CAAC;QACzE,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,MAAM,wBAAwB,CAAC,cAAc,CAAC,CAAC,CAAC;QAEhF,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;QAElC,MAAM,OAAO,GAAsB;YAClC,SAAS,EAAE,MAAM;YACjB,SAAS,EAAE,cAAc;YACzB,eAAe,EAAE,mBAAmB,CAAC,UAAU,CAAC,cAAc,CAAC;YAC/D,OAAO,EAAE,YAAY;YACrB,OAAO,EAAE,aAAa;YACtB,QAAQ,EAAE,iBAAiB,CAAC,IAAI;YAChC,SAAS,EAAE,EAAE,SAAS,EAAE,EAAE,EAAE;SAC5B,CAAC;QACF,MAAM,gBAAgB,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;QAEtC,IAAI,cAA0B,CAAC;QAC/B,MAAM,cAAc,GAAG,IAAI,OAAO,CAAO,OAAO,CAAC,EAAE;YAClD,cAAc,GAAG,OAAO,CAAC;QAC1B,CAAC,CAAC,CAAC;QAEF,KAAK,CAAC,gCAAoD,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;QAEpF,MAAM,qBAAqB,GAAG,OAAO,CAAC,cAAe,CAAC,OAAO,EAAE,gBAAgB,EAAE,EAAE,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAE7G,MAAM,SAAS,GAAkB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,YAAY,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QACjH,MAAM,SAAS,GAAkB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,YAAY,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QAEjH,OAAO,CAAC,mBAAmB,CAAC,MAAM,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC;QACjD,OAAO,CAAC,mBAAmB,CAAC,MAAM,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC;QAEjD,oCAAoC;QACpC,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC,CAAC;QAErD,MAAM,CAAC,EAAE,CAAC,gBAAgB,CAAC,WAAW,CAAC,CAAC;QACxC,MAAM,CAAC,eAAe,CAAC,gBAAgB,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC;QACxE,MAAM,CAAC,eAAe,CAAC,gBAAgB,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC;QAEzE,uBAAuB;QACvB,cAAe,EAAE,CAAC;QAClB,MAAM,qBAAqB,CAAC;QAE5B,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;IACvD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,6DAA6D,EAAE;QACnE,MAAM,SAAS,GAAG,SAAS,CAAC;QAC5B,MAAM,QAAQ,GAAG,mBAAmB,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;QAC3D,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,qBAAqB,CAAC,QAAQ,EAAE,CAAC,EAAE,KAAK,EAAE,UAAU,EAAE,aAAa,CAAC,CAAC,CAAC;QAE1G,IAAI,iBAAiB,GAAG,KAAK,CAAC;QAC9B,MAAM,UAAU,GAAG,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE;YAC7C,iBAAiB,GAAG,IAAI,CAAC;QAC1B,CAAC,CAAC,CAAC;QAEH,OAAO,CAAC,OAAO,EAAE,CAAC;QAElB,MAAM,CAAC,EAAE,CAAC,iBAAiB,CAAC,CAAC;QAC7B,MAAM,CAAC,EAAE,CAAE,KAAK,CAAC,0BAAgG,CAAC,cAAc,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC,CAAC;QAE/I,UAAU,CAAC,OAAO,EAAE,CAAC;IACtB,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,yDAAyD,EAAE,KAAK;QACpE,MAAM,cAAc,GAAG;YACtB,EAAE,IAAI,EAAE,SAAS,EAAE,MAAM,EAAE,gBAAgB,EAAE;YAC7C,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,cAAc,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC,EAAE;YAChH,EAAE,IAAI,EAAE,SAAS,EAAE,MAAM,EAAE,iBAAiB,EAAE;YAC9C,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,eAAe,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC,EAAE;SACjH,CAAC;QAEF,MAAM,cAAc,GAAG,oBAAoB,CAAC;YAC3C,OAAO,EAAE,cAAc;YACvB,yBAAyB,EAAE,KAAK;YAChC,iBAAiB,EAAE,KAAK;SACxB,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,WAAW,CAAC,GAAG,CAAC,MAAM,wBAAwB,CAAC,cAAc,CAAC,CAAC,CAAC;QAEhF,0CAA0C;QAC1C,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QAC9C,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACvD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,gBAAgB,CAAC,CAAC;QAChE,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;QACxD,MAAM,CAAC,WAAW,CAAE,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAA0B,CAAC,OAAO,CAAC,KAAK,EAAE,cAAc,CAAC,CAAC;QACxG,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACvD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,iBAAiB,CAAC,CAAC;QACjE,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;QACxD,MAAM,CAAC,WAAW,CAAE,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAA0B,CAAC,OAAO,CAAC,KAAK,EAAE,eAAe,CAAC,CAAC;QAEzG,0DAA0D;QAC1D,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;IACvD,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAEH,KAAK,CAAC,wBAAwB,EAAE;IAC/B,IAAI,oBAA8C,CAAC;IACnD,IAAI,UAAkC,CAAC;IACvC,IAAI,KAA+B,CAAC;IACpC,IAAI,mBAAyC,CAAC;IAC9C,IAAI,WAA4B,CAAC;IAEjC,MAAM,sBAAsB,GAAG,mBAAmB,CAAC,UAAU,CAAC,gBAAgB,CAAC,CAAC;IAEhF,KAAK,CAAC;QACL,WAAW,GAAG,IAAI,eAAe,EAAE,CAAC;QACpC,oBAAoB,GAAG,IAAI,wBAAwB,EAAE,CAAC;QAEtD,KAAK,GAAG;YACP,0BAA0B,EAAE,KAAK,CAAC,IAAI,EAAE;YACxC,kCAAkC,EAAE,KAAK,CAAC,IAAI,EAAwG,CAAC,QAAQ,CAAC,SAAS,CAAC;YAC1K,2BAA2B,EAAE,KAAK,CAAC,IAAI,EAAE;YACzC,mCAAmC,EAAE,KAAK,CAAC,IAAI,EAAE;YACjD,gCAAgC,EAAE,KAAK,CAAC,IAAI,EAAE;YAC9C,0BAA0B,EAAE,KAAK,CAAC,IAAI,EAAE;YACxC,wBAAwB,EAAE,KAAK,CAAC,IAAI,EAAE;YACtC,0BAA0B,EAAE,KAAK,CAAC,IAAI,EAAE,CAAC,QAAQ,CAAC,EAAE,QAAQ,EAAE,sBAAsB,EAAE,KAAK,EAAE,aAAa,EAAsB,CAAC;SACjI,CAAC;QAEF,MAAM,cAAc,GAAG,IAAI;YAAA;gBAC1B,oBAAe,GAAG,EAAE,CAAC;gBACrB,sBAAiB,0CAAkC;YAMpD,CAAC;YALA,OAAO,KAAK,CAAC;YACb,gBAAgB,KAAK,CAAC;YACtB,GAAG,CAAC,CAAM,IAAS,OAAO,IAAI,CAAC,CAAC,CAAC;YACjC,QAAQ,KAAU,OAAO,KAAK,CAAC,CAAC,CAAC;YACjC,KAAK,KAAU,OAAO,IAAI,CAAC,CAAC,CAAC;SAC7B,CAAC;QAEF,oBAAoB,CAAC,IAAI,CAAC,qBAAqB,EAAE,IAAI,wBAAwB,EAAE,CAAC,CAAC;QACjF,oBAAoB,CAAC,IAAI,CAAC,kBAAkB,EAAE,WAAW,CAAC,GAAG,CAAC,oBAAoB,CAAC,cAAc,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC;QACvH,oBAAoB,CAAC,IAAI,CAAC,WAAW,EAAE,IAAI,cAAc,EAAE,CAAC,CAAC;QAC7D,oBAAoB,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,KAAM,SAAQ,IAAI,EAAkB;SAAI,CAAC,CAAC;QACxF,oBAAoB,CAAC,IAAI,CAAC,iBAAiB,EAAE,IAAI,oBAAoB,EAAE,CAAC,CAAC;QACzE,oBAAoB,CAAC,IAAI,CAAC,aAAa,EAAE,IAAI,KAAM,SAAQ,IAAI,EAAiB;YACtE,KAAK,CAAC,QAAQ,KAAK,OAAO,IAAI,CAAC,CAAC,CAAC;SAC1C,CAAC,CAAC;QACH,oBAAoB,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,KAAM,SAAQ,IAAI,EAAkB;YACxE,KAAK,CAAC,OAAO;gBACrB,OAAO,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC;YAC5B,CAAC;SACD,CAAC,CAAC;QACH,oBAAoB,CAAC,IAAI,CAAC,aAAa,EAAE,IAAI,KAAM,SAAQ,IAAI,EAAiB;YACtE,iBAAiB;gBACzB,OAAO;oBACN,OAAO,EAAE,GAAG,EAAE,GAAG,CAAC;iBAClB,CAAC;YACH,CAAC;SACD,CAAC,CAAC;QAEH,mBAAmB,GAAG,WAAW,CAAC,GAAG,CAAC,oBAAoB,CAAC,cAAc,CAAC,mBAAmB,CAAC,CAAC,CAAC;QAChG,oBAAoB,CAAC,IAAI,CAAC,oBAAoB,EAAE,mBAAmB,CAAC,CAAC;QACrE,UAAU,GAAG,WAAW,CAAC,GAAG,CAAC,oBAAoB,CAAC,cAAc,CAAC,sBAAsB,EAAE,cAAc,CAAC,CAAC,CAAC;IAC3G,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC;QACR,WAAW,CAAC,OAAO,EAAE,CAAC;QACtB,oBAAoB,CAAC,OAAO,EAAE,CAAC;QAC/B,KAAK,CAAC,OAAO,EAAE,CAAC;IACjB,CAAC,CAAC,CAAC;IAEH,uCAAuC,EAAE,CAAC;IAE1C,IAAI,CAAC,sDAAsD,EAAE,KAAK;QACjE,UAAU,CAAC,gCAAgC,CAAC,CAAC,EAAE,WAAW,CAAC,CAAC;QAE5D,kCAAkC;QAClC,MAAM,WAAW,GAAsB;YACtC,SAAS,EAAE,cAAc;YACzB,eAAe,EAAE,mBAAmB,CAAC,UAAU,CAAC,cAAc,CAAC;YAC/D,SAAS,EAAE,cAAc;YACzB,OAAO,EAAE,YAAY;YACrB,OAAO,EAAE,WAAW;YACpB,QAAQ,EAAE,iBAAiB,CAAC,IAAI;YAChC,SAAS,EAAE,EAAE,SAAS,EAAE,EAAE,EAAE;SAC5B,CAAC;QAEF,QAAQ;QACR,MAAM,eAAe,GAAG,MAAM,mBAAmB,CAAC,qBAAqB,CAAC,WAAW,EAAE;YACpF,OAAO,EAAE,WAAW;YACpB,QAAQ,EAAE,EAAE;SACZ,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAC3B,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,eAAe,CAAC,QAAQ,EAAE,sBAAsB,CAAC,CAAC,CAAC;QACrE,MAAM,CAAC,WAAW,CAAC,eAAe,CAAC,KAAK,EAAE,aAAa,CAAC,CAAC;QAEzD,oCAAoC;QACpC,MAAM,MAAM,CAAC,OAAO,CACnB,mBAAmB,CAAC,qBAAqB,CAAC,cAAc,EAAE;YACzD,OAAO,EAAE,WAAW;YACpB,QAAQ,EAAE,EAAE;SACZ,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAC1B,CAAC;QAEF,UAAU,CAAC,kCAAkC,CAAC,CAAC,CAAC,CAAC;IAClD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,2DAA2D,EAAE,KAAK;QACtE,MAAM,aAAa,GAAG,mBAAmB,CAAC;QAC1C,UAAU,CAAC,mCAAmC,CAAC,CAAC,EAAE,aAAa,CAAC,CAAC;QAEjE,MAAM,cAAc,GAAG;YACtB,EAAE,EAAE,cAAc;YAClB,OAAO,EAAE,EAAE;YACX,yBAAyB,EAAE,KAAK;YAChC,iBAAiB,EAAE,KAAK;SACxB,CAAC;QAEF,MAAM,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,aAAa,gBAAgB,CAAC,CAAC;QAE5D,KAAK,CAAC,0BAA8C,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;QAC/E,MAAM,QAAQ,GAAG,MAAM,mBAAmB,CAAC,sBAAsB,CAAC,QAAQ,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAEpG,MAAM,CAAC,EAAE,CAAC,QAAQ,CAAC,CAAC;QAEpB,MAAM,QAAQ,GAAG,MAAM,mBAAmB,CAAC,sBAAsB,CAAC,QAAQ,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;QACpG,MAAM,CAAC,WAAW,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;QAEvC,MAAM,CAAC,EAAE,CAAE,KAAK,CAAC,0BAA8C,CAAC,UAAU,CAAC,CAAC;QAC5E,UAAU,CAAC,qCAAqC,CAAC,CAAC,CAAC,CAAC;IACrD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,gDAAgD,EAAE,KAAK;QAC3D,MAAM,aAAa,GAAG,mBAAmB,CAAC;QAE1C,UAAU,CAAC,mCAAmC,CAAC,CAAC,EAAE,aAAa,CAAC,CAAC;QAEjE,MAAM,cAAc,GAAG;YACtB,EAAE,EAAE,cAAc;YAClB,OAAO,EAAE,EAAE;YACX,yBAAyB,EAAE,KAAK;YAChC,iBAAiB,EAAE,KAAK;SACxB,CAAC;QAED,KAAK,CAAC,0BAA8C,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;QAE/E,MAAM,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,aAAa,gBAAgB,CAAC,CAAC;QAC7D,MAAM,OAAO,GAAG,MAAM,mBAAmB,CAAC,sBAAsB,CAAC,QAAQ,EAAE,iBAAiB,CAAC,IAAI,CAA0B,CAAC;QAE5H,MAAM,WAAW,GAAqB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QAChH,MAAM,UAAU,CAAC,oBAAoB,CAAC,CAAC,EAAE,QAAQ,EAAE,MAAM,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC;QAE1E,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QACxD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,iBAAiB,CAAC,CAAC;QAEzE,UAAU,CAAC,qCAAqC,CAAC,CAAC,CAAC,CAAC;IACrD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,gDAAgD,EAAE,KAAK;QAC3D,MAAM,aAAa,GAAG,mBAAmB,CAAC;QAC1C,UAAU,CAAC,mCAAmC,CAAC,CAAC,EAAE,aAAa,CAAC,CAAC;QAEjE,MAAM,cAAc,GAAG;YACtB,EAAE,EAAE,cAAc;YAClB,OAAO,EAAE,EAAE;YACX,yBAAyB,EAAE,KAAK;YAChC,iBAAiB,EAAE,KAAK;SACxB,CAAC;QAED,KAAK,CAAC,0BAA8C,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;QAE/E,MAAM,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,aAAa,gBAAgB,CAAC,CAAC;QAC7D,MAAM,OAAO,GAAG,MAAM,mBAAmB,CAAC,sBAAsB,CAAC,QAAQ,EAAE,iBAAiB,CAAC,IAAI,CAA0B,CAAC;QAE5H,MAAM,WAAW,GAAqB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,MAAM,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC;QAChH,MAAM,UAAU,CAAC,oBAAoB,CAAC,CAAC,EAAE,QAAQ,EAAE,MAAM,EAAE,CAAC,WAAW,CAAC,CAAC,CAAC;QAC1E,UAAU,CAAC,uBAAuB,CAAC,CAAC,EAAE,QAAQ,EAAE,MAAM,CAAC,CAAC;QAExD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;QAEtD,UAAU,CAAC,qCAAqC,CAAC,CAAC,CAAC,CAAC;IACrD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,kDAAkD,EAAE,KAAK;QAC7D,MAAM,aAAa,GAAG,mBAAmB,CAAC;QAC1C,UAAU,CAAC,mCAAmC,CAAC,CAAC,EAAE,aAAa,CAAC,CAAC;QAEjE,MAAM,cAAc,GAAG;YACtB,EAAE,EAAE,oBAAoB;YACxB,OAAO,EAAE;gBACR,EAAE,IAAI,EAAE,SAAS,EAAE,MAAM,EAAE,gBAAgB,EAAE;gBAC7C,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,cAAc,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC,EAAE;gBAChH,EAAE,IAAI,EAAE,SAAS,EAAE,MAAM,EAAE,iBAAiB,EAAE;gBAC9C,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,EAAE,KAAK,EAAE,eAAe,EAAE,SAAS,EAAE,KAAK,EAAE,EAAE,CAAC,EAAE;aACjH;YACD,yBAAyB,EAAE,KAAK;YAChC,iBAAiB,EAAE,KAAK;SACxB,CAAC;QAED,KAAK,CAAC,0BAA8C,CAAC,QAAQ,CAAC,cAAc,CAAC,CAAC;QAE/E,MAAM,QAAQ,GAAG,GAAG,CAAC,KAAK,CAAC,GAAG,aAAa,sBAAsB,CAAC,CAAC;QACnE,MAAM,OAAO,GAAG,MAAM,mBAAmB,CAAC,sBAAsB,CAAC,QAAQ,EAAE,iBAAiB,CAAC,IAAI,CAA0B,CAAC;QAE5H,sCAAsC;QACtC,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC;QACnB,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QAE9C,gDAAgD;QAChD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACvD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,gBAAgB,CAAC,CAAC;QAChE,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;QACxD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACvD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,iBAAiB,CAAC,CAAC;QACjE,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;QAExD,iEAAiE;QACjE,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,aAAa,CAAC,GAAG,EAAE,EAAE,IAAI,CAAC,CAAC;QAEtD,UAAU,CAAC,qCAAqC,CAAC,CAAC,CAAC,CAAC;IACrD,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC","file":"mainThreadChatSessions.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport * as sinon from 'sinon';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { ContextKeyService } from '../../../../platform/contextkey/browser/contextKeyService.js';\nimport { IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { TestInstantiationService } from '../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { ILogService, NullLogService } from '../../../../platform/log/common/log.js';\nimport { ChatSessionsService } from '../../../contrib/chat/browser/chatSessions.contribution.js';\nimport { IChatAgentRequest } from '../../../contrib/chat/common/chatAgents.js';\nimport { IChatProgress, IChatProgressMessage } from '../../../contrib/chat/common/chatService.js';\nimport { IChatSessionItem, IChatSessionsService } from '../../../contrib/chat/common/chatSessionsService.js';\nimport { LocalChatSessionUri } from '../../../contrib/chat/common/chatUri.js';\nimport { ChatAgentLocation } from '../../../contrib/chat/common/constants.js';\nimport { IEditorService } from '../../../services/editor/common/editorService.js';\nimport { IExtHostContext } from '../../../services/extensions/common/extHostCustomers.js';\nimport { ExtensionHostKind } from '../../../services/extensions/common/extensionHostKind.js';\nimport { IExtensionService } from '../../../services/extensions/common/extensions.js';\nimport { IViewsService } from '../../../services/views/common/viewsService.js';\nimport { mock, TestExtensionService } from '../../../test/common/workbenchTestServices.js';\nimport { MainThreadChatSessions, ObservableChatSession } from '../../browser/mainThreadChatSessions.js';\nimport { ExtHostChatSessionsShape, IChatProgressDto, IChatSessionProviderOptions } from '../../common/extHost.protocol.js';\nimport { ILabelService } from '../../../../platform/label/common/label.js';\nimport { isEqual } from '../../../../base/common/resources.js';\n\nsuite('ObservableChatSession', function () {\n\tlet disposables: DisposableStore;\n\tlet logService: ILogService;\n\tlet dialogService: IDialogService;\n\tlet proxy: ExtHostChatSessionsShape;\n\n\tsetup(function () {\n\t\tdisposables = new DisposableStore();\n\t\tlogService = new NullLogService();\n\n\t\tdialogService = new class extends mock<IDialogService>() {\n\t\t\toverride async confirm() {\n\t\t\t\treturn { confirmed: true };\n\t\t\t}\n\t\t};\n\n\t\tproxy = {\n\t\t\t$provideChatSessionContent: sinon.stub(),\n\t\t\t$provideChatSessionProviderOptions: sinon.stub<[providerHandle: number, token: CancellationToken], Promise<IChatSessionProviderOptions | undefined>>().resolves(undefined),\n\t\t\t$provideHandleOptionsChange: sinon.stub(),\n\t\t\t$interruptChatSessionActiveResponse: sinon.stub(),\n\t\t\t$invokeChatSessionRequestHandler: sinon.stub(),\n\t\t\t$disposeChatSessionContent: sinon.stub(),\n\t\t\t$provideChatSessionItems: sinon.stub(),\n\t\t\t$provideNewChatSessionItem: sinon.stub().resolves({ label: 'New Session' } as IChatSessionItem)\n\t\t};\n\t});\n\n\tteardown(function () {\n\t\tdisposables.dispose();\n\t\tsinon.restore();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tfunction createSessionContent(options: {\n\t\tid?: string;\n\t\thistory?: any[];\n\t\thasActiveResponseCallback?: boolean;\n\t\thasRequestHandler?: boolean;\n\t} = {}) {\n\t\treturn {\n\t\t\tid: options.id || 'test-id',\n\t\t\thistory: options.history || [],\n\t\t\thasActiveResponseCallback: options.hasActiveResponseCallback || false,\n\t\t\thasRequestHandler: options.hasRequestHandler || false\n\t\t};\n\t}\n\n\tasync function createInitializedSession(sessionContent: any, sessionId = 'test-id'): Promise<ObservableChatSession> {\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = new ObservableChatSession(resource, 1, proxy, logService, dialogService);\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\t\tawait session.initialize(CancellationToken.None);\n\t\treturn session;\n\t}\n\n\ttest('constructor creates session with proper initial state', function () {\n\t\tconst sessionId = 'test-id';\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = disposables.add(new ObservableChatSession(resource, 1, proxy, logService, dialogService));\n\n\t\tassert.strictEqual(session.providerHandle, 1);\n\t\tassert.deepStrictEqual(session.history, []);\n\t\tassert.ok(session.progressObs);\n\t\tassert.ok(session.isCompleteObs);\n\n\t\t// Initial state should be inactive and incomplete\n\t\tassert.deepStrictEqual(session.progressObs.get(), []);\n\t\tassert.strictEqual(session.isCompleteObs.get(), false);\n\t});\n\n\ttest('session queues progress before initialization and processes it after', async function () {\n\t\tconst sessionId = 'test-id';\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = disposables.add(new ObservableChatSession(resource, 1, proxy, logService, dialogService));\n\n\t\tconst progress1: IChatProgress = { kind: 'progressMessage', content: { value: 'Hello', isTrusted: false } };\n\t\tconst progress2: IChatProgress = { kind: 'progressMessage', content: { value: 'World', isTrusted: false } };\n\n\t\t// Add progress before initialization - should be queued\n\t\tsession.handleProgressChunk('req1', [progress1]);\n\t\tsession.handleProgressChunk('req1', [progress2]);\n\n\t\t// Progress should be queued, not visible yet\n\t\tassert.deepStrictEqual(session.progressObs.get(), []);\n\n\t\t// Initialize the session\n\t\tconst sessionContent = createSessionContent();\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\t\tawait session.initialize(CancellationToken.None);\n\n\t\t// Now progress should be visible\n\t\tassert.strictEqual(session.progressObs.get().length, 2);\n\t\tassert.deepStrictEqual(session.progressObs.get(), [progress1, progress2]);\n\t\tassert.strictEqual(session.isCompleteObs.get(), true); // Should be complete for sessions without active response callback or request handler\n\t});\n\n\ttest('initialization loads session history and sets up capabilities', async function () {\n\t\tconst sessionHistory = [\n\t\t\t{ type: 'request', prompt: 'Previous question' },\n\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'Previous answer', isTrusted: false } }] }\n\t\t];\n\n\t\tconst sessionContent = createSessionContent({\n\t\t\thistory: sessionHistory,\n\t\t\thasActiveResponseCallback: true,\n\t\t\thasRequestHandler: true\n\t\t});\n\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\t// Verify history was loaded\n\t\tassert.strictEqual(session.history.length, 2);\n\t\tassert.strictEqual(session.history[0].type, 'request');\n\t\tassert.strictEqual(session.history[0].prompt, 'Previous question');\n\t\tassert.strictEqual(session.history[1].type, 'response');\n\n\t\t// Verify capabilities were set up\n\t\tassert.ok(session.interruptActiveResponseCallback);\n\t\tassert.ok(session.requestHandler);\n\t});\n\n\ttest('initialization is idempotent and returns same promise', async function () {\n\t\tconst sessionId = 'test-id';\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = disposables.add(new ObservableChatSession(resource, 1, proxy, logService, dialogService));\n\n\t\tconst sessionContent = createSessionContent();\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\n\t\tconst promise1 = session.initialize(CancellationToken.None);\n\t\tconst promise2 = session.initialize(CancellationToken.None);\n\n\t\tassert.strictEqual(promise1, promise2);\n\t\tawait promise1;\n\n\t\t// Should only call proxy once even though initialize was called twice\n\t\tassert.ok((proxy.$provideChatSessionContent as sinon.SinonStub).calledOnce);\n\t});\n\n\ttest('progress handling works correctly after initialization', async function () {\n\t\tconst sessionContent = createSessionContent();\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\tconst progress: IChatProgress = { kind: 'progressMessage', content: { value: 'New progress', isTrusted: false } };\n\n\t\t// Add progress after initialization\n\t\tsession.handleProgressChunk('req1', [progress]);\n\n\t\tassert.deepStrictEqual(session.progressObs.get(), [progress]);\n\t\t// Session with no capabilities should remain complete\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n\n\ttest('progress completion updates session state correctly', async function () {\n\t\tconst sessionContent = createSessionContent();\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\t// Add some progress first\n\t\tconst progress: IChatProgress = { kind: 'progressMessage', content: { value: 'Processing...', isTrusted: false } };\n\t\tsession.handleProgressChunk('req1', [progress]);\n\n\t\t// Session with no capabilities should already be complete\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t\tsession.handleProgressComplete('req1');\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n\n\ttest('session with active response callback becomes active when progress is added', async function () {\n\t\tconst sessionContent = createSessionContent({ hasActiveResponseCallback: true });\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\t// Session should start inactive and incomplete (has capabilities but no active progress)\n\t\tassert.strictEqual(session.isCompleteObs.get(), false);\n\n\t\tconst progress: IChatProgress = { kind: 'progressMessage', content: { value: 'Processing...', isTrusted: false } };\n\t\tsession.handleProgressChunk('req1', [progress]);\n\n\t\tassert.strictEqual(session.isCompleteObs.get(), false);\n\t\tsession.handleProgressComplete('req1');\n\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n\n\ttest('request handler forwards requests to proxy', async function () {\n\t\tconst sessionContent = createSessionContent({ hasRequestHandler: true });\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\tassert.ok(session.requestHandler);\n\n\t\tconst request: IChatAgentRequest = {\n\t\t\trequestId: 'req1',\n\t\t\tsessionId: 'test-session',\n\t\t\tsessionResource: LocalChatSessionUri.forSession('test-session'),\n\t\t\tagentId: 'test-agent',\n\t\t\tmessage: 'Test prompt',\n\t\t\tlocation: ChatAgentLocation.Chat,\n\t\t\tvariables: { variables: [] }\n\t\t};\n\t\tconst progressCallback = sinon.stub();\n\n\t\tawait session.requestHandler!(request, progressCallback, [], CancellationToken.None);\n\n\t\tassert.ok((proxy.$invokeChatSessionRequestHandler as sinon.SinonStubbedMember<typeof proxy.$invokeChatSessionRequestHandler>).calledOnceWith(1, session.sessionResource, request, [], CancellationToken.None));\n\t});\n\n\ttest('request handler forwards progress updates to external callback', async function () {\n\t\tconst sessionContent = createSessionContent({ hasRequestHandler: true });\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\tassert.ok(session.requestHandler);\n\n\t\tconst request: IChatAgentRequest = {\n\t\t\trequestId: 'req1',\n\t\t\tsessionId: 'test-session',\n\t\t\tsessionResource: LocalChatSessionUri.forSession('test-session'),\n\t\t\tagentId: 'test-agent',\n\t\t\tmessage: 'Test prompt',\n\t\t\tlocation: ChatAgentLocation.Chat,\n\t\t\tvariables: { variables: [] }\n\t\t};\n\t\tconst progressCallback = sinon.stub();\n\n\t\tlet resolveRequest: () => void;\n\t\tconst requestPromise = new Promise<void>(resolve => {\n\t\t\tresolveRequest = resolve;\n\t\t});\n\n\t\t(proxy.$invokeChatSessionRequestHandler as sinon.SinonStub).returns(requestPromise);\n\n\t\tconst requestHandlerPromise = session.requestHandler!(request, progressCallback, [], CancellationToken.None);\n\n\t\tconst progress1: IChatProgress = { kind: 'progressMessage', content: { value: 'Progress 1', isTrusted: false } };\n\t\tconst progress2: IChatProgress = { kind: 'progressMessage', content: { value: 'Progress 2', isTrusted: false } };\n\n\t\tsession.handleProgressChunk('req1', [progress1]);\n\t\tsession.handleProgressChunk('req1', [progress2]);\n\n\t\t// Wait a bit for autorun to trigger\n\t\tawait new Promise(resolve => setTimeout(resolve, 0));\n\n\t\tassert.ok(progressCallback.calledTwice);\n\t\tassert.deepStrictEqual(progressCallback.firstCall.args[0], [progress1]);\n\t\tassert.deepStrictEqual(progressCallback.secondCall.args[0], [progress2]);\n\n\t\t// Complete the request\n\t\tresolveRequest!();\n\t\tawait requestHandlerPromise;\n\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n\n\ttest('dispose properly cleans up resources and notifies listeners', function () {\n\t\tconst sessionId = 'test-id';\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = disposables.add(new ObservableChatSession(resource, 1, proxy, logService, dialogService));\n\n\t\tlet disposeEventFired = false;\n\t\tconst disposable = session.onWillDispose(() => {\n\t\t\tdisposeEventFired = true;\n\t\t});\n\n\t\tsession.dispose();\n\n\t\tassert.ok(disposeEventFired);\n\t\tassert.ok((proxy.$disposeChatSessionContent as sinon.SinonStubbedMember<typeof proxy.$disposeChatSessionContent>).calledOnceWith(1, resource));\n\n\t\tdisposable.dispose();\n\t});\n\n\ttest('session with multiple request/response pairs in history', async function () {\n\t\tconst sessionHistory = [\n\t\t\t{ type: 'request', prompt: 'First question' },\n\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'First answer', isTrusted: false } }] },\n\t\t\t{ type: 'request', prompt: 'Second question' },\n\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'Second answer', isTrusted: false } }] }\n\t\t];\n\n\t\tconst sessionContent = createSessionContent({\n\t\t\thistory: sessionHistory,\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t});\n\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\t// Verify all history was loaded correctly\n\t\tassert.strictEqual(session.history.length, 4);\n\t\tassert.strictEqual(session.history[0].type, 'request');\n\t\tassert.strictEqual(session.history[0].prompt, 'First question');\n\t\tassert.strictEqual(session.history[1].type, 'response');\n\t\tassert.strictEqual((session.history[1].parts[0] as IChatProgressMessage).content.value, 'First answer');\n\t\tassert.strictEqual(session.history[2].type, 'request');\n\t\tassert.strictEqual(session.history[2].prompt, 'Second question');\n\t\tassert.strictEqual(session.history[3].type, 'response');\n\t\tassert.strictEqual((session.history[3].parts[0] as IChatProgressMessage).content.value, 'Second answer');\n\n\t\t// Session should be complete since it has no capabilities\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n});\n\nsuite('MainThreadChatSessions', function () {\n\tlet instantiationService: TestInstantiationService;\n\tlet mainThread: MainThreadChatSessions;\n\tlet proxy: ExtHostChatSessionsShape;\n\tlet chatSessionsService: IChatSessionsService;\n\tlet disposables: DisposableStore;\n\n\tconst exampleSessionResource = LocalChatSessionUri.forSession('new-session-id');\n\n\tsetup(function () {\n\t\tdisposables = new DisposableStore();\n\t\tinstantiationService = new TestInstantiationService();\n\n\t\tproxy = {\n\t\t\t$provideChatSessionContent: sinon.stub(),\n\t\t\t$provideChatSessionProviderOptions: sinon.stub<[providerHandle: number, token: CancellationToken], Promise<IChatSessionProviderOptions | undefined>>().resolves(undefined),\n\t\t\t$provideHandleOptionsChange: sinon.stub(),\n\t\t\t$interruptChatSessionActiveResponse: sinon.stub(),\n\t\t\t$invokeChatSessionRequestHandler: sinon.stub(),\n\t\t\t$disposeChatSessionContent: sinon.stub(),\n\t\t\t$provideChatSessionItems: sinon.stub(),\n\t\t\t$provideNewChatSessionItem: sinon.stub().resolves({ resource: exampleSessionResource, label: 'New Session' } as IChatSessionItem)\n\t\t};\n\n\t\tconst extHostContext = new class implements IExtHostContext {\n\t\t\tremoteAuthority = '';\n\t\t\textensionHostKind = ExtensionHostKind.LocalProcess;\n\t\t\tdispose() { }\n\t\t\tassertRegistered() { }\n\t\t\tset(v: any): any { return null; }\n\t\t\tgetProxy(): any { return proxy; }\n\t\t\tdrain(): any { return null; }\n\t\t};\n\n\t\tinstantiationService.stub(IConfigurationService, new TestConfigurationService());\n\t\tinstantiationService.stub(IContextKeyService, disposables.add(instantiationService.createInstance(ContextKeyService)));\n\t\tinstantiationService.stub(ILogService, new NullLogService());\n\t\tinstantiationService.stub(IEditorService, new class extends mock<IEditorService>() { });\n\t\tinstantiationService.stub(IExtensionService, new TestExtensionService());\n\t\tinstantiationService.stub(IViewsService, new class extends mock<IViewsService>() {\n\t\t\toverride async openView() { return null; }\n\t\t});\n\t\tinstantiationService.stub(IDialogService, new class extends mock<IDialogService>() {\n\t\t\toverride async confirm() {\n\t\t\t\treturn { confirmed: true };\n\t\t\t}\n\t\t});\n\t\tinstantiationService.stub(ILabelService, new class extends mock<ILabelService>() {\n\t\t\toverride registerFormatter() {\n\t\t\t\treturn {\n\t\t\t\t\tdispose: () => { }\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tchatSessionsService = disposables.add(instantiationService.createInstance(ChatSessionsService));\n\t\tinstantiationService.stub(IChatSessionsService, chatSessionsService);\n\t\tmainThread = disposables.add(instantiationService.createInstance(MainThreadChatSessions, extHostContext));\n\t});\n\n\tteardown(function () {\n\t\tdisposables.dispose();\n\t\tinstantiationService.dispose();\n\t\tsinon.restore();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('provideNewChatSessionItem creates a new chat session', async function () {\n\t\tmainThread.$registerChatSessionItemProvider(1, 'test-type');\n\n\t\t// Create a mock IChatAgentRequest\n\t\tconst mockRequest: IChatAgentRequest = {\n\t\t\tsessionId: 'test-session',\n\t\t\tsessionResource: LocalChatSessionUri.forSession('test-session'),\n\t\t\trequestId: 'test-request',\n\t\t\tagentId: 'test-agent',\n\t\t\tmessage: 'my prompt',\n\t\t\tlocation: ChatAgentLocation.Chat,\n\t\t\tvariables: { variables: [] }\n\t\t};\n\n\t\t// Valid\n\t\tconst chatSessionItem = await chatSessionsService.getNewChatSessionItem('test-type', {\n\t\t\trequest: mockRequest,\n\t\t\tmetadata: {}\n\t\t}, CancellationToken.None);\n\t\tassert.ok(isEqual(chatSessionItem.resource, exampleSessionResource));\n\t\tassert.strictEqual(chatSessionItem.label, 'New Session');\n\n\t\t// Invalid session type should throw\n\t\tawait assert.rejects(\n\t\t\tchatSessionsService.getNewChatSessionItem('invalid-type', {\n\t\t\t\trequest: mockRequest,\n\t\t\t\tmetadata: {}\n\t\t\t}, CancellationToken.None)\n\t\t);\n\n\t\tmainThread.$unregisterChatSessionItemProvider(1);\n\t});\n\n\ttest('provideChatSessionContent creates and initializes session', async function () {\n\t\tconst sessionScheme = 'test-session-type';\n\t\tmainThread.$registerChatSessionContentProvider(1, sessionScheme);\n\n\t\tconst sessionContent = {\n\t\t\tid: 'test-session',\n\t\t\thistory: [],\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t};\n\n\t\tconst resource = URI.parse(`${sessionScheme}:/test-session`);\n\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\t\tconst session1 = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None);\n\n\t\tassert.ok(session1);\n\n\t\tconst session2 = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None);\n\t\tassert.strictEqual(session1, session2);\n\n\t\tassert.ok((proxy.$provideChatSessionContent as sinon.SinonStub).calledOnce);\n\t\tmainThread.$unregisterChatSessionContentProvider(1);\n\t});\n\n\ttest('$handleProgressChunk routes to correct session', async function () {\n\t\tconst sessionScheme = 'test-session-type';\n\n\t\tmainThread.$registerChatSessionContentProvider(1, sessionScheme);\n\n\t\tconst sessionContent = {\n\t\t\tid: 'test-session',\n\t\t\thistory: [],\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t};\n\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\n\t\tconst resource = URI.parse(`${sessionScheme}:/test-session`);\n\t\tconst session = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None) as ObservableChatSession;\n\n\t\tconst progressDto: IChatProgressDto = { kind: 'progressMessage', content: { value: 'Test', isTrusted: false } };\n\t\tawait mainThread.$handleProgressChunk(1, resource, 'req1', [progressDto]);\n\n\t\tassert.strictEqual(session.progressObs.get().length, 1);\n\t\tassert.strictEqual(session.progressObs.get()[0].kind, 'progressMessage');\n\n\t\tmainThread.$unregisterChatSessionContentProvider(1);\n\t});\n\n\ttest('$handleProgressComplete marks session complete', async function () {\n\t\tconst sessionScheme = 'test-session-type';\n\t\tmainThread.$registerChatSessionContentProvider(1, sessionScheme);\n\n\t\tconst sessionContent = {\n\t\t\tid: 'test-session',\n\t\t\thistory: [],\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t};\n\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\n\t\tconst resource = URI.parse(`${sessionScheme}:/test-session`);\n\t\tconst session = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None) as ObservableChatSession;\n\n\t\tconst progressDto: IChatProgressDto = { kind: 'progressMessage', content: { value: 'Test', isTrusted: false } };\n\t\tawait mainThread.$handleProgressChunk(1, resource, 'req1', [progressDto]);\n\t\tmainThread.$handleProgressComplete(1, resource, 'req1');\n\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\n\t\tmainThread.$unregisterChatSessionContentProvider(1);\n\t});\n\n\ttest('integration with multiple request/response pairs', async function () {\n\t\tconst sessionScheme = 'test-session-type';\n\t\tmainThread.$registerChatSessionContentProvider(1, sessionScheme);\n\n\t\tconst sessionContent = {\n\t\t\tid: 'multi-turn-session',\n\t\t\thistory: [\n\t\t\t\t{ type: 'request', prompt: 'First question' },\n\t\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'First answer', isTrusted: false } }] },\n\t\t\t\t{ type: 'request', prompt: 'Second question' },\n\t\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'Second answer', isTrusted: false } }] }\n\t\t\t],\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t};\n\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\n\t\tconst resource = URI.parse(`${sessionScheme}:/multi-turn-session`);\n\t\tconst session = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None) as ObservableChatSession;\n\n\t\t// Verify the session loaded correctly\n\t\tassert.ok(session);\n\t\tassert.strictEqual(session.history.length, 4);\n\n\t\t// Verify all history items are correctly loaded\n\t\tassert.strictEqual(session.history[0].type, 'request');\n\t\tassert.strictEqual(session.history[0].prompt, 'First question');\n\t\tassert.strictEqual(session.history[1].type, 'response');\n\t\tassert.strictEqual(session.history[2].type, 'request');\n\t\tassert.strictEqual(session.history[2].prompt, 'Second question');\n\t\tassert.strictEqual(session.history[3].type, 'response');\n\n\t\t// Session should be complete since it has no active capabilities\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\n\t\tmainThread.$unregisterChatSessionContentProvider(1);\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport * as sinon from 'sinon';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { ContextKeyService } from '../../../../platform/contextkey/browser/contextKeyService.js';\nimport { IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { TestInstantiationService } from '../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { ILogService, NullLogService } from '../../../../platform/log/common/log.js';\nimport { ChatSessionsService } from '../../../contrib/chat/browser/chatSessions.contribution.js';\nimport { IChatAgentRequest } from '../../../contrib/chat/common/chatAgents.js';\nimport { IChatProgress, IChatProgressMessage } from '../../../contrib/chat/common/chatService.js';\nimport { IChatSessionItem, IChatSessionsService } from '../../../contrib/chat/common/chatSessionsService.js';\nimport { LocalChatSessionUri } from '../../../contrib/chat/common/chatUri.js';\nimport { ChatAgentLocation } from '../../../contrib/chat/common/constants.js';\nimport { IEditorService } from '../../../services/editor/common/editorService.js';\nimport { IExtHostContext } from '../../../services/extensions/common/extHostCustomers.js';\nimport { ExtensionHostKind } from '../../../services/extensions/common/extensionHostKind.js';\nimport { IExtensionService } from '../../../services/extensions/common/extensions.js';\nimport { IViewsService } from '../../../services/views/common/viewsService.js';\nimport { mock, TestExtensionService } from '../../../test/common/workbenchTestServices.js';\nimport { MainThreadChatSessions, ObservableChatSession } from '../../browser/mainThreadChatSessions.js';\nimport { ExtHostChatSessionsShape, IChatProgressDto, IChatSessionProviderOptions } from '../../common/extHost.protocol.js';\nimport { ILabelService } from '../../../../platform/label/common/label.js';\nimport { isEqual } from '../../../../base/common/resources.js';\n\nsuite('ObservableChatSession', function () {\n\tlet disposables: DisposableStore;\n\tlet logService: ILogService;\n\tlet dialogService: IDialogService;\n\tlet proxy: ExtHostChatSessionsShape;\n\n\tsetup(function () {\n\t\tdisposables = new DisposableStore();\n\t\tlogService = new NullLogService();\n\n\t\tdialogService = new class extends mock<IDialogService>() {\n\t\t\toverride async confirm() {\n\t\t\t\treturn { confirmed: true };\n\t\t\t}\n\t\t};\n\n\t\tproxy = {\n\t\t\t$provideChatSessionContent: sinon.stub(),\n\t\t\t$provideChatSessionProviderOptions: sinon.stub<[providerHandle: number, token: CancellationToken], Promise<IChatSessionProviderOptions | undefined>>().resolves(undefined),\n\t\t\t$provideHandleOptionsChange: sinon.stub(),\n\t\t\t$interruptChatSessionActiveResponse: sinon.stub(),\n\t\t\t$invokeChatSessionRequestHandler: sinon.stub(),\n\t\t\t$disposeChatSessionContent: sinon.stub(),\n\t\t\t$provideChatSessionItems: sinon.stub(),\n\t\t\t$provideNewChatSessionItem: sinon.stub().resolves({ label: 'New Session' } as IChatSessionItem)\n\t\t};\n\t});\n\n\tteardown(function () {\n\t\tdisposables.dispose();\n\t\tsinon.restore();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tfunction createSessionContent(options: {\n\t\tid?: string;\n\t\thistory?: any[];\n\t\thasActiveResponseCallback?: boolean;\n\t\thasRequestHandler?: boolean;\n\t} = {}) {\n\t\treturn {\n\t\t\tid: options.id || 'test-id',\n\t\t\thistory: options.history || [],\n\t\t\thasActiveResponseCallback: options.hasActiveResponseCallback || false,\n\t\t\thasRequestHandler: options.hasRequestHandler || false\n\t\t};\n\t}\n\n\tasync function createInitializedSession(sessionContent: any, sessionId = 'test-id'): Promise<ObservableChatSession> {\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = new ObservableChatSession(resource, 1, proxy, logService, dialogService);\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\t\tawait session.initialize(CancellationToken.None);\n\t\treturn session;\n\t}\n\n\ttest('constructor creates session with proper initial state', function () {\n\t\tconst sessionId = 'test-id';\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = disposables.add(new ObservableChatSession(resource, 1, proxy, logService, dialogService));\n\n\t\tassert.strictEqual(session.providerHandle, 1);\n\t\tassert.deepStrictEqual(session.history, []);\n\t\tassert.ok(session.progressObs);\n\t\tassert.ok(session.isCompleteObs);\n\n\t\t// Initial state should be inactive and incomplete\n\t\tassert.deepStrictEqual(session.progressObs.get(), []);\n\t\tassert.strictEqual(session.isCompleteObs.get(), false);\n\t});\n\n\ttest('session queues progress before initialization and processes it after', async function () {\n\t\tconst sessionId = 'test-id';\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = disposables.add(new ObservableChatSession(resource, 1, proxy, logService, dialogService));\n\n\t\tconst progress1: IChatProgress = { kind: 'progressMessage', content: { value: 'Hello', isTrusted: false } };\n\t\tconst progress2: IChatProgress = { kind: 'progressMessage', content: { value: 'World', isTrusted: false } };\n\n\t\t// Add progress before initialization - should be queued\n\t\tsession.handleProgressChunk('req1', [progress1]);\n\t\tsession.handleProgressChunk('req1', [progress2]);\n\n\t\t// Progress should be queued, not visible yet\n\t\tassert.deepStrictEqual(session.progressObs.get(), []);\n\n\t\t// Initialize the session\n\t\tconst sessionContent = createSessionContent();\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\t\tawait session.initialize(CancellationToken.None);\n\n\t\t// Now progress should be visible\n\t\tassert.strictEqual(session.progressObs.get().length, 2);\n\t\tassert.deepStrictEqual(session.progressObs.get(), [progress1, progress2]);\n\t\tassert.strictEqual(session.isCompleteObs.get(), true); // Should be complete for sessions without active response callback or request handler\n\t});\n\n\ttest('initialization loads session history and sets up capabilities', async function () {\n\t\tconst sessionHistory = [\n\t\t\t{ type: 'request', prompt: 'Previous question' },\n\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'Previous answer', isTrusted: false } }] }\n\t\t];\n\n\t\tconst sessionContent = createSessionContent({\n\t\t\thistory: sessionHistory,\n\t\t\thasActiveResponseCallback: true,\n\t\t\thasRequestHandler: true\n\t\t});\n\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\t// Verify history was loaded\n\t\tassert.strictEqual(session.history.length, 2);\n\t\tassert.strictEqual(session.history[0].type, 'request');\n\t\tassert.strictEqual(session.history[0].prompt, 'Previous question');\n\t\tassert.strictEqual(session.history[1].type, 'response');\n\n\t\t// Verify capabilities were set up\n\t\tassert.ok(session.interruptActiveResponseCallback);\n\t\tassert.ok(session.requestHandler);\n\t});\n\n\ttest('initialization is idempotent and returns same promise', async function () {\n\t\tconst sessionId = 'test-id';\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = disposables.add(new ObservableChatSession(resource, 1, proxy, logService, dialogService));\n\n\t\tconst sessionContent = createSessionContent();\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\n\t\tconst promise1 = session.initialize(CancellationToken.None);\n\t\tconst promise2 = session.initialize(CancellationToken.None);\n\n\t\tassert.strictEqual(promise1, promise2);\n\t\tawait promise1;\n\n\t\t// Should only call proxy once even though initialize was called twice\n\t\tassert.ok((proxy.$provideChatSessionContent as sinon.SinonStub).calledOnce);\n\t});\n\n\ttest('progress handling works correctly after initialization', async function () {\n\t\tconst sessionContent = createSessionContent();\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\tconst progress: IChatProgress = { kind: 'progressMessage', content: { value: 'New progress', isTrusted: false } };\n\n\t\t// Add progress after initialization\n\t\tsession.handleProgressChunk('req1', [progress]);\n\n\t\tassert.deepStrictEqual(session.progressObs.get(), [progress]);\n\t\t// Session with no capabilities should remain complete\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n\n\ttest('progress completion updates session state correctly', async function () {\n\t\tconst sessionContent = createSessionContent();\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\t// Add some progress first\n\t\tconst progress: IChatProgress = { kind: 'progressMessage', content: { value: 'Processing...', isTrusted: false } };\n\t\tsession.handleProgressChunk('req1', [progress]);\n\n\t\t// Session with no capabilities should already be complete\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t\tsession.handleProgressComplete('req1');\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n\n\ttest('session with active response callback becomes active when progress is added', async function () {\n\t\tconst sessionContent = createSessionContent({ hasActiveResponseCallback: true });\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\t// Session should start inactive and incomplete (has capabilities but no active progress)\n\t\tassert.strictEqual(session.isCompleteObs.get(), false);\n\n\t\tconst progress: IChatProgress = { kind: 'progressMessage', content: { value: 'Processing...', isTrusted: false } };\n\t\tsession.handleProgressChunk('req1', [progress]);\n\n\t\tassert.strictEqual(session.isCompleteObs.get(), false);\n\t\tsession.handleProgressComplete('req1');\n\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n\n\ttest('request handler forwards requests to proxy', async function () {\n\t\tconst sessionContent = createSessionContent({ hasRequestHandler: true });\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\tassert.ok(session.requestHandler);\n\n\t\tconst request: IChatAgentRequest = {\n\t\t\trequestId: 'req1',\n\t\t\tsessionId: 'test-session',\n\t\t\tsessionResource: LocalChatSessionUri.forSession('test-session'),\n\t\t\tagentId: 'test-agent',\n\t\t\tmessage: 'Test prompt',\n\t\t\tlocation: ChatAgentLocation.Chat,\n\t\t\tvariables: { variables: [] }\n\t\t};\n\t\tconst progressCallback = sinon.stub();\n\n\t\tawait session.requestHandler!(request, progressCallback, [], CancellationToken.None);\n\n\t\tassert.ok((proxy.$invokeChatSessionRequestHandler as sinon.SinonStubbedMember<typeof proxy.$invokeChatSessionRequestHandler>).calledOnceWith(1, session.sessionResource, request, [], CancellationToken.None));\n\t});\n\n\ttest('request handler forwards progress updates to external callback', async function () {\n\t\tconst sessionContent = createSessionContent({ hasRequestHandler: true });\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\tassert.ok(session.requestHandler);\n\n\t\tconst request: IChatAgentRequest = {\n\t\t\trequestId: 'req1',\n\t\t\tsessionId: 'test-session',\n\t\t\tsessionResource: LocalChatSessionUri.forSession('test-session'),\n\t\t\tagentId: 'test-agent',\n\t\t\tmessage: 'Test prompt',\n\t\t\tlocation: ChatAgentLocation.Chat,\n\t\t\tvariables: { variables: [] }\n\t\t};\n\t\tconst progressCallback = sinon.stub();\n\n\t\tlet resolveRequest: () => void;\n\t\tconst requestPromise = new Promise<void>(resolve => {\n\t\t\tresolveRequest = resolve;\n\t\t});\n\n\t\t(proxy.$invokeChatSessionRequestHandler as sinon.SinonStub).returns(requestPromise);\n\n\t\tconst requestHandlerPromise = session.requestHandler!(request, progressCallback, [], CancellationToken.None);\n\n\t\tconst progress1: IChatProgress = { kind: 'progressMessage', content: { value: 'Progress 1', isTrusted: false } };\n\t\tconst progress2: IChatProgress = { kind: 'progressMessage', content: { value: 'Progress 2', isTrusted: false } };\n\n\t\tsession.handleProgressChunk('req1', [progress1]);\n\t\tsession.handleProgressChunk('req1', [progress2]);\n\n\t\t// Wait a bit for autorun to trigger\n\t\tawait new Promise(resolve => setTimeout(resolve, 0));\n\n\t\tassert.ok(progressCallback.calledTwice);\n\t\tassert.deepStrictEqual(progressCallback.firstCall.args[0], [progress1]);\n\t\tassert.deepStrictEqual(progressCallback.secondCall.args[0], [progress2]);\n\n\t\t// Complete the request\n\t\tresolveRequest!();\n\t\tawait requestHandlerPromise;\n\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n\n\ttest('dispose properly cleans up resources and notifies listeners', function () {\n\t\tconst sessionId = 'test-id';\n\t\tconst resource = LocalChatSessionUri.forSession(sessionId);\n\t\tconst session = disposables.add(new ObservableChatSession(resource, 1, proxy, logService, dialogService));\n\n\t\tlet disposeEventFired = false;\n\t\tconst disposable = session.onWillDispose(() => {\n\t\t\tdisposeEventFired = true;\n\t\t});\n\n\t\tsession.dispose();\n\n\t\tassert.ok(disposeEventFired);\n\t\tassert.ok((proxy.$disposeChatSessionContent as sinon.SinonStubbedMember<typeof proxy.$disposeChatSessionContent>).calledOnceWith(1, resource));\n\n\t\tdisposable.dispose();\n\t});\n\n\ttest('session with multiple request/response pairs in history', async function () {\n\t\tconst sessionHistory = [\n\t\t\t{ type: 'request', prompt: 'First question' },\n\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'First answer', isTrusted: false } }] },\n\t\t\t{ type: 'request', prompt: 'Second question' },\n\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'Second answer', isTrusted: false } }] }\n\t\t];\n\n\t\tconst sessionContent = createSessionContent({\n\t\t\thistory: sessionHistory,\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t});\n\n\t\tconst session = disposables.add(await createInitializedSession(sessionContent));\n\n\t\t// Verify all history was loaded correctly\n\t\tassert.strictEqual(session.history.length, 4);\n\t\tassert.strictEqual(session.history[0].type, 'request');\n\t\tassert.strictEqual(session.history[0].prompt, 'First question');\n\t\tassert.strictEqual(session.history[1].type, 'response');\n\t\tassert.strictEqual((session.history[1].parts[0] as IChatProgressMessage).content.value, 'First answer');\n\t\tassert.strictEqual(session.history[2].type, 'request');\n\t\tassert.strictEqual(session.history[2].prompt, 'Second question');\n\t\tassert.strictEqual(session.history[3].type, 'response');\n\t\tassert.strictEqual((session.history[3].parts[0] as IChatProgressMessage).content.value, 'Second answer');\n\n\t\t// Session should be complete since it has no capabilities\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\t});\n});\n\nsuite('MainThreadChatSessions', function () {\n\tlet instantiationService: TestInstantiationService;\n\tlet mainThread: MainThreadChatSessions;\n\tlet proxy: ExtHostChatSessionsShape;\n\tlet chatSessionsService: IChatSessionsService;\n\tlet disposables: DisposableStore;\n\n\tconst exampleSessionResource = LocalChatSessionUri.forSession('new-session-id');\n\n\tsetup(function () {\n\t\tdisposables = new DisposableStore();\n\t\tinstantiationService = new TestInstantiationService();\n\n\t\tproxy = {\n\t\t\t$provideChatSessionContent: sinon.stub(),\n\t\t\t$provideChatSessionProviderOptions: sinon.stub<[providerHandle: number, token: CancellationToken], Promise<IChatSessionProviderOptions | undefined>>().resolves(undefined),\n\t\t\t$provideHandleOptionsChange: sinon.stub(),\n\t\t\t$interruptChatSessionActiveResponse: sinon.stub(),\n\t\t\t$invokeChatSessionRequestHandler: sinon.stub(),\n\t\t\t$disposeChatSessionContent: sinon.stub(),\n\t\t\t$provideChatSessionItems: sinon.stub(),\n\t\t\t$provideNewChatSessionItem: sinon.stub().resolves({ resource: exampleSessionResource, label: 'New Session' } as IChatSessionItem)\n\t\t};\n\n\t\tconst extHostContext = new class implements IExtHostContext {\n\t\t\tremoteAuthority = '';\n\t\t\textensionHostKind = ExtensionHostKind.LocalProcess;\n\t\t\tdispose() { }\n\t\t\tassertRegistered() { }\n\t\t\tset(v: any): any { return null; }\n\t\t\tgetProxy(): any { return proxy; }\n\t\t\tdrain(): any { return null; }\n\t\t};\n\n\t\tinstantiationService.stub(IConfigurationService, new TestConfigurationService());\n\t\tinstantiationService.stub(IContextKeyService, disposables.add(instantiationService.createInstance(ContextKeyService)));\n\t\tinstantiationService.stub(ILogService, new NullLogService());\n\t\tinstantiationService.stub(IEditorService, new class extends mock<IEditorService>() { });\n\t\tinstantiationService.stub(IExtensionService, new TestExtensionService());\n\t\tinstantiationService.stub(IViewsService, new class extends mock<IViewsService>() {\n\t\t\toverride async openView() { return null; }\n\t\t});\n\t\tinstantiationService.stub(IDialogService, new class extends mock<IDialogService>() {\n\t\t\toverride async confirm() {\n\t\t\t\treturn { confirmed: true };\n\t\t\t}\n\t\t});\n\t\tinstantiationService.stub(ILabelService, new class extends mock<ILabelService>() {\n\t\t\toverride registerFormatter() {\n\t\t\t\treturn {\n\t\t\t\t\tdispose: () => { }\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tchatSessionsService = disposables.add(instantiationService.createInstance(ChatSessionsService));\n\t\tinstantiationService.stub(IChatSessionsService, chatSessionsService);\n\t\tmainThread = disposables.add(instantiationService.createInstance(MainThreadChatSessions, extHostContext));\n\t});\n\n\tteardown(function () {\n\t\tdisposables.dispose();\n\t\tinstantiationService.dispose();\n\t\tsinon.restore();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('provideNewChatSessionItem creates a new chat session', async function () {\n\t\tmainThread.$registerChatSessionItemProvider(1, 'test-type');\n\n\t\t// Create a mock IChatAgentRequest\n\t\tconst mockRequest: IChatAgentRequest = {\n\t\t\tsessionId: 'test-session',\n\t\t\tsessionResource: LocalChatSessionUri.forSession('test-session'),\n\t\t\trequestId: 'test-request',\n\t\t\tagentId: 'test-agent',\n\t\t\tmessage: 'my prompt',\n\t\t\tlocation: ChatAgentLocation.Chat,\n\t\t\tvariables: { variables: [] }\n\t\t};\n\n\t\t// Valid\n\t\tconst chatSessionItem = await chatSessionsService.getNewChatSessionItem('test-type', {\n\t\t\trequest: mockRequest,\n\t\t\tmetadata: {}\n\t\t}, CancellationToken.None);\n\t\tassert.ok(isEqual(chatSessionItem.resource, exampleSessionResource));\n\t\tassert.strictEqual(chatSessionItem.label, 'New Session');\n\n\t\t// Invalid session type should throw\n\t\tawait assert.rejects(\n\t\t\tchatSessionsService.getNewChatSessionItem('invalid-type', {\n\t\t\t\trequest: mockRequest,\n\t\t\t\tmetadata: {}\n\t\t\t}, CancellationToken.None)\n\t\t);\n\n\t\tmainThread.$unregisterChatSessionItemProvider(1);\n\t});\n\n\ttest('provideChatSessionContent creates and initializes session', async function () {\n\t\tconst sessionScheme = 'test-session-type';\n\t\tmainThread.$registerChatSessionContentProvider(1, sessionScheme);\n\n\t\tconst sessionContent = {\n\t\t\tid: 'test-session',\n\t\t\thistory: [],\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t};\n\n\t\tconst resource = URI.parse(`${sessionScheme}:/test-session`);\n\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\t\tconst session1 = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None);\n\n\t\tassert.ok(session1);\n\n\t\tconst session2 = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None);\n\t\tassert.strictEqual(session1, session2);\n\n\t\tassert.ok((proxy.$provideChatSessionContent as sinon.SinonStub).calledOnce);\n\t\tmainThread.$unregisterChatSessionContentProvider(1);\n\t});\n\n\ttest('$handleProgressChunk routes to correct session', async function () {\n\t\tconst sessionScheme = 'test-session-type';\n\n\t\tmainThread.$registerChatSessionContentProvider(1, sessionScheme);\n\n\t\tconst sessionContent = {\n\t\t\tid: 'test-session',\n\t\t\thistory: [],\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t};\n\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\n\t\tconst resource = URI.parse(`${sessionScheme}:/test-session`);\n\t\tconst session = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None) as ObservableChatSession;\n\n\t\tconst progressDto: IChatProgressDto = { kind: 'progressMessage', content: { value: 'Test', isTrusted: false } };\n\t\tawait mainThread.$handleProgressChunk(1, resource, 'req1', [progressDto]);\n\n\t\tassert.strictEqual(session.progressObs.get().length, 1);\n\t\tassert.strictEqual(session.progressObs.get()[0].kind, 'progressMessage');\n\n\t\tmainThread.$unregisterChatSessionContentProvider(1);\n\t});\n\n\ttest('$handleProgressComplete marks session complete', async function () {\n\t\tconst sessionScheme = 'test-session-type';\n\t\tmainThread.$registerChatSessionContentProvider(1, sessionScheme);\n\n\t\tconst sessionContent = {\n\t\t\tid: 'test-session',\n\t\t\thistory: [],\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t};\n\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\n\t\tconst resource = URI.parse(`${sessionScheme}:/test-session`);\n\t\tconst session = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None) as ObservableChatSession;\n\n\t\tconst progressDto: IChatProgressDto = { kind: 'progressMessage', content: { value: 'Test', isTrusted: false } };\n\t\tawait mainThread.$handleProgressChunk(1, resource, 'req1', [progressDto]);\n\t\tmainThread.$handleProgressComplete(1, resource, 'req1');\n\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\n\t\tmainThread.$unregisterChatSessionContentProvider(1);\n\t});\n\n\ttest('integration with multiple request/response pairs', async function () {\n\t\tconst sessionScheme = 'test-session-type';\n\t\tmainThread.$registerChatSessionContentProvider(1, sessionScheme);\n\n\t\tconst sessionContent = {\n\t\t\tid: 'multi-turn-session',\n\t\t\thistory: [\n\t\t\t\t{ type: 'request', prompt: 'First question' },\n\t\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'First answer', isTrusted: false } }] },\n\t\t\t\t{ type: 'request', prompt: 'Second question' },\n\t\t\t\t{ type: 'response', parts: [{ kind: 'progressMessage', content: { value: 'Second answer', isTrusted: false } }] }\n\t\t\t],\n\t\t\thasActiveResponseCallback: false,\n\t\t\thasRequestHandler: false\n\t\t};\n\n\t\t(proxy.$provideChatSessionContent as sinon.SinonStub).resolves(sessionContent);\n\n\t\tconst resource = URI.parse(`${sessionScheme}:/multi-turn-session`);\n\t\tconst session = await chatSessionsService.getOrCreateChatSession(resource, CancellationToken.None) as ObservableChatSession;\n\n\t\t// Verify the session loaded correctly\n\t\tassert.ok(session);\n\t\tassert.strictEqual(session.history.length, 4);\n\n\t\t// Verify all history items are correctly loaded\n\t\tassert.strictEqual(session.history[0].type, 'request');\n\t\tassert.strictEqual(session.history[0].prompt, 'First question');\n\t\tassert.strictEqual(session.history[1].type, 'response');\n\t\tassert.strictEqual(session.history[2].type, 'request');\n\t\tassert.strictEqual(session.history[2].prompt, 'Second question');\n\t\tassert.strictEqual(session.history[3].type, 'response');\n\n\t\t// Session should be complete since it has no active capabilities\n\t\tassert.strictEqual(session.isCompleteObs.get(), true);\n\n\t\tmainThread.$unregisterChatSessionContentProvider(1);\n\t});\n});\n"]}