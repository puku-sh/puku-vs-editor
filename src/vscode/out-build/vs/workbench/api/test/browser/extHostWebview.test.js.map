{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/test/browser/extHostWebview.test.ts","vs/workbench/api/test/browser/extHostWebview.test.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,MAAM,MAAM,QAAQ,CAAC;AAC5B,OAAO,EAAE,eAAe,EAAE,MAAM,sCAAsC,CAAC;AACvE,OAAO,EAAE,OAAO,EAAE,MAAM,oCAAoC,CAAC;AAC7D,OAAO,EAAE,GAAG,EAAE,MAAM,gCAAgC,CAAC;AACrD,OAAO,EAAE,IAAI,EAAE,MAAM,sCAAsC,CAAC;AAC5D,OAAO,EAAE,uCAAuC,EAAE,MAAM,uCAAuC,CAAC;AAEhG,OAAO,EAAE,cAAc,EAAE,MAAM,wCAAwC,CAAC;AAExE,OAAO,EAAE,yBAAyB,EAAE,MAAM,8CAA8C,CAAC;AAEzF,OAAO,EAAE,eAAe,EAAE,MAAM,gCAAgC,CAAC;AACjE,OAAO,EAAE,oBAAoB,EAAE,MAAM,sCAAsC,CAAC;AAC5E,OAAO,EAAE,sBAAsB,EAAE,MAAM,8BAA8B,CAAC;AACtE,OAAO,EAAE,eAAe,EAAE,uBAAuB,EAAE,MAAM,4CAA4C,CAAC;AAKtG,KAAK,CAAC,gBAAgB,EAAE,GAAG,EAAE;IAC5B,IAAI,WAA4B,CAAC;IACjC,IAAI,WAA+D,CAAC;IAEpE,KAAK,CAAC,GAAG,EAAE;QACV,WAAW,GAAG,IAAI,eAAe,EAAE,CAAC;QAEpC,MAAM,KAAK,GAAG,4BAA4B,EAAE,CAAC;QAC7C,WAAW,GAAG,sBAAsB,CAAC,KAAK,CAAC,CAAC;IAC7C,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,GAAG,EAAE;QACb,WAAW,CAAC,OAAO,EAAE,CAAC;IACvB,CAAC,CAAC,CAAC;IAEH,uCAAuC,EAAE,CAAC;IAE1C,SAAS,aAAa,CAAC,WAA+D,EAAE,eAAmC;QAC1H,MAAM,eAAe,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,eAAe,CAAC,WAAY,EAAE;YACzE,SAAS,EAAE,eAAe;YAC1B,QAAQ,EAAE,CAAC,CAAC,eAAe;SAC3B,EAAE,SAAS,EAAE,IAAI,cAAc,EAAE,EAAE,yBAAyB,CAAC,CAAC,CAAC;QAEhE,MAAM,oBAAoB,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,oBAAoB,CAAC,WAAY,EAAE,eAAe,EAAE,SAAS,CAAC,CAAC,CAAC;QAEjH,OAAO,WAAW,CAAC,GAAG,CAAC,oBAAoB,CAAC,kBAAkB,CAAC;YAC9D,iBAAiB,EAAE,GAAG,CAAC,IAAI,CAAC;gBAC3B,MAAM,EAAE,eAAe,CAAC,CAAC,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,CAAC,OAAO,CAAC,IAAI;gBAC7D,SAAS,EAAE,eAAe;gBAC1B,IAAI,EAAE,WAAW;aACjB,CAAC;SACuB,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;IACtD,CAAC;IAED,IAAI,CAAC,6DAA6D,EAAE,KAAK,IAAI,EAAE;QAC9E,MAAM,QAAQ,GAAG,WAAW,CAAC;QAE7B,MAAM,eAAe,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,eAAe,CAAC,WAAY,EAAE,EAAE,SAAS,EAAE,SAAS,EAAE,QAAQ,EAAE,KAAK,EAAE,EAAE,SAAS,EAAE,IAAI,cAAc,EAAE,EAAE,yBAAyB,CAAC,CAAC,CAAC;QAElL,MAAM,oBAAoB,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,oBAAoB,CAAC,WAAY,EAAE,eAAe,EAAE,SAAS,CAAC,CAAC,CAAC;QAEjH,IAAI,uBAAuB,GAA8C,SAAS,CAAC;QAEnF,MAAM,cAAc;YACnB,KAAK,CAAC,uBAAuB,CAAC,OAA4B,EAAE,MAAW;gBACtE,uBAAuB,GAAG,IAAI,CAAC;gBAC/B,WAAW,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;YAC1B,CAAC;SACD;QAED,MAAM,SAAS,GAAG,EAA2B,CAAC;QAE9C,MAAM,WAAW,GAAG,IAAI,cAAc,EAAE,CAAC;QACzC,MAAM,WAAW,GAAG,IAAI,cAAc,EAAE,CAAC;QAEzC,MAAM,uBAAuB,GAAG,oBAAoB,CAAC,8BAA8B,CAAC,SAAS,EAAE,QAAQ,EAAE,WAAW,CAAC,CAAC;QAEtH,MAAM,oBAAoB,CAAC,wBAAwB,CAAC,GAAG,EAAE,QAAQ,EAAE;YAClE,KAAK,EAAE,OAAO;YACd,KAAK,EAAE,EAAE;YACT,YAAY,EAAE,EAAE;YAChB,cAAc,EAAE,EAAE;YAClB,MAAM,EAAE,IAAI;SACZ,EAAE,CAAsB,CAAC,CAAC;QAC3B,MAAM,CAAC,WAAW,CAAC,uBAAuB,EAAE,WAAW,CAAC,CAAC;QAEzD,MAAM,CAAC,MAAM,CACZ,GAAG,EAAE,CAAC,WAAW,CAAC,GAAG,CAAC,oBAAoB,CAAC,8BAA8B,CAAC,SAAS,EAAE,QAAQ,EAAE,WAAW,CAAC,CAAC,EAC5G,iEAAiE,CAAC,CAAC;QAEpE,uBAAuB,CAAC,OAAO,EAAE,CAAC;QAElC,WAAW,CAAC,GAAG,CAAC,oBAAoB,CAAC,8BAA8B,CAAC,SAAS,EAAE,QAAQ,EAAE,WAAW,CAAC,CAAC,CAAC;QAEvG,MAAM,oBAAoB,CAAC,wBAAwB,CAAC,GAAG,EAAE,QAAQ,EAAE;YAClE,KAAK,EAAE,OAAO;YACd,KAAK,EAAE,EAAE;YACT,YAAY,EAAE,EAAE;YAChB,cAAc,EAAE,EAAE;YAClB,MAAM,EAAE,IAAI;SACZ,EAAE,CAAsB,CAAC,CAAC;QAC3B,MAAM,CAAC,WAAW,CAAC,uBAAuB,EAAE,WAAW,CAAC,CAAC;IAC1D,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,mCAAmC,EAAE,GAAG,EAAE;QAC9C,MAAM,OAAO,GAAG,aAAa,CAAC,WAAW,EAAE,qBAAqB,CAAA,SAAS,CAAC,CAAC;QAE3E,MAAM,CAAC,WAAW,CACjB,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,+BAA+B,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,EACrF,mCAAmC,uBAAuB,wBAAwB,EAClF,YAAY,CACZ,CAAC;QAEF,MAAM,CAAC,WAAW,CACjB,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,oCAAoC,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,EAC1F,mCAAmC,uBAAuB,6BAA6B,EACvF,+BAA+B,CAC/B,CAAC;QAEF,MAAM,CAAC,WAAW,CACjB,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,kCAAkC,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,EACxF,mCAAmC,uBAAuB,2BAA2B,EACrF,oBAAoB,CACpB,CAAC;QAEF,MAAM,CAAC,WAAW,CACjB,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,wCAAwC,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,EAC9F,4CAA4C,uBAAuB,wBAAwB,EAC3F,gCAAgC,CAChC,CAAC;QAEF,MAAM,CAAC,WAAW,CACjB,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,2BAA2B,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,EACjF,mCAAmC,uBAAuB,sBAAsB,EAChF,iBAAiB,CACjB,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,oCAAoC,EAAE,GAAG,EAAE;QAC/C,MAAM,OAAO,GAAG,aAAa,CAAC,WAAW,EAAE,qBAAqB,CAAC,QAAQ,CAAC,CAAC;QAE3E,MAAM,CAAC,WAAW,CACjB,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,+BAA+B,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,EACrF,kDAAkD,uBAAuB,wBAAwB,EACjG,YAAY,CACZ,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,8CAA8C,EAAE,GAAG,EAAE;QACzD,MAAM,OAAO,GAAG,aAAa,CAAC,WAAW,EAAE,qBAAqB,CAAC,QAAQ,CAAC,CAAC;QAC3E,MAAM,SAAS,GAAG,8BAA8B,CAAC;QAEjD,MAAM,SAAS,GAAG,GAAG,CAAC,IAAI,CAAC;YAC1B,MAAM,EAAE,eAAe;YACvB,SAAS,EAAE,SAAS;YACpB,IAAI,EAAE,mBAAmB;SACzB,CAAC,CAAC;QAEH,MAAM,UAAU,GAAG,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;QAC3D,MAAM,CAAC,WAAW,CACjB,UAAU,CAAC,QAAQ,EAAE,EACrB,sHAAsH,EACtH,iBAAiB,CAAC,CAAC;QAEpB,MAAM,CAAC,WAAW,CACjB,eAAe,CAAC,UAAU,CAAC,SAAS,CAAC,EACrC,iBAAiB,SAAS,iCAAiC,EAC3D,yBAAyB,CACzB,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,2CAA2C,EAAE,GAAG,EAAE;QACtD,MAAM,OAAO,GAAG,aAAa,CAAC,WAAW,EAAE,qBAAqB,CAAC,QAAQ,CAAC,CAAC;QAC3E,MAAM,SAAS,GAAG,gBAAgB,CAAC;QAEnC,MAAM,SAAS,GAAG,GAAG,CAAC,IAAI,CAAC;YAC1B,MAAM,EAAE,eAAe;YACvB,SAAS,EAAE,SAAS;YACpB,IAAI,EAAE,mBAAmB;SACzB,CAAC,CAAC;QAEH,MAAM,UAAU,GAAG,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;QAC3D,MAAM,CAAC,WAAW,CACjB,UAAU,CAAC,QAAQ,EAAE,EACrB,4FAA4F,EAC5F,iBAAiB,CAAC,CAAC;QAEpB,MAAM,CAAC,WAAW,CACjB,eAAe,CAAC,UAAU,CAAC,SAAS,CAAC,EACrC,iBAAiB,SAAS,iCAAiC,EAC3D,yBAAyB,CACzB,CAAC;IACH,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAGH,SAAS,4BAA4B;IACpC,OAAO,IAAI,KAAM,SAAQ,IAAI,EAA4B;QACxD,eAAe,KAAgB,CAAC;QAChC,mBAAmB,KAAgB,CAAC;QACpC,mBAAmB,KAAgB,CAAC;QACpC,qBAAqB,KAAgB,CAAC;KACtC,CAAC;AACH,CAAC","file":"extHostWebview.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { mock } from '../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { IExtensionDescription } from '../../../../platform/extensions/common/extensions.js';\nimport { NullLogService } from '../../../../platform/log/common/log.js';\nimport { MainThreadWebviewManager } from '../../browser/mainThreadWebviewManager.js';\nimport { NullApiDeprecationService } from '../../common/extHostApiDeprecationService.js';\nimport { IExtHostRpcService } from '../../common/extHostRpcService.js';\nimport { ExtHostWebviews } from '../../common/extHostWebview.js';\nimport { ExtHostWebviewPanels } from '../../common/extHostWebviewPanels.js';\nimport { SingleProxyRPCProtocol } from '../common/testRPCProtocol.js';\nimport { decodeAuthority, webviewResourceBaseHost } from '../../../contrib/webview/common/webview.js';\nimport { EditorGroupColumn } from '../../../services/editor/common/editorGroupColumn.js';\nimport { IExtHostContext } from '../../../services/extensions/common/extHostCustomers.js';\nimport type * as vscode from 'vscode';\n\nsuite('ExtHostWebview', () => {\n\tlet disposables: DisposableStore;\n\tlet rpcProtocol: (IExtHostRpcService & IExtHostContext) | undefined;\n\n\tsetup(() => {\n\t\tdisposables = new DisposableStore();\n\n\t\tconst shape = createNoopMainThreadWebviews();\n\t\trpcProtocol = SingleProxyRPCProtocol(shape);\n\t});\n\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tfunction createWebview(rpcProtocol: (IExtHostRpcService & IExtHostContext) | undefined, remoteAuthority: string | undefined) {\n\t\tconst extHostWebviews = disposables.add(new ExtHostWebviews(rpcProtocol!, {\n\t\t\tauthority: remoteAuthority,\n\t\t\tisRemote: !!remoteAuthority,\n\t\t}, undefined, new NullLogService(), NullApiDeprecationService));\n\n\t\tconst extHostWebviewPanels = disposables.add(new ExtHostWebviewPanels(rpcProtocol!, extHostWebviews, undefined));\n\n\t\treturn disposables.add(extHostWebviewPanels.createWebviewPanel({\n\t\t\textensionLocation: URI.from({\n\t\t\t\tscheme: remoteAuthority ? Schemas.vscodeRemote : Schemas.file,\n\t\t\t\tauthority: remoteAuthority,\n\t\t\t\tpath: '/ext/path',\n\t\t\t})\n\t\t} as IExtensionDescription, 'type', 'title', 1, {}));\n\t}\n\n\ttest('Cannot register multiple serializers for the same view type', async () => {\n\t\tconst viewType = 'view.type';\n\n\t\tconst extHostWebviews = disposables.add(new ExtHostWebviews(rpcProtocol!, { authority: undefined, isRemote: false }, undefined, new NullLogService(), NullApiDeprecationService));\n\n\t\tconst extHostWebviewPanels = disposables.add(new ExtHostWebviewPanels(rpcProtocol!, extHostWebviews, undefined));\n\n\t\tlet lastInvokedDeserializer: vscode.WebviewPanelSerializer | undefined = undefined;\n\n\t\tclass NoopSerializer implements vscode.WebviewPanelSerializer {\n\t\t\tasync deserializeWebviewPanel(webview: vscode.WebviewPanel, _state: any): Promise<void> {\n\t\t\t\tlastInvokedDeserializer = this;\n\t\t\t\tdisposables.add(webview);\n\t\t\t}\n\t\t}\n\n\t\tconst extension = {} as IExtensionDescription;\n\n\t\tconst serializerA = new NoopSerializer();\n\t\tconst serializerB = new NoopSerializer();\n\n\t\tconst serializerARegistration = extHostWebviewPanels.registerWebviewPanelSerializer(extension, viewType, serializerA);\n\n\t\tawait extHostWebviewPanels.$deserializeWebviewPanel('x', viewType, {\n\t\t\ttitle: 'title',\n\t\t\tstate: {},\n\t\t\tpanelOptions: {},\n\t\t\twebviewOptions: {},\n\t\t\tactive: true,\n\t\t}, 0 as EditorGroupColumn);\n\t\tassert.strictEqual(lastInvokedDeserializer, serializerA);\n\n\t\tassert.throws(\n\t\t\t() => disposables.add(extHostWebviewPanels.registerWebviewPanelSerializer(extension, viewType, serializerB)),\n\t\t\t'Should throw when registering two serializers for the same view');\n\n\t\tserializerARegistration.dispose();\n\n\t\tdisposables.add(extHostWebviewPanels.registerWebviewPanelSerializer(extension, viewType, serializerB));\n\n\t\tawait extHostWebviewPanels.$deserializeWebviewPanel('x', viewType, {\n\t\t\ttitle: 'title',\n\t\t\tstate: {},\n\t\t\tpanelOptions: {},\n\t\t\twebviewOptions: {},\n\t\t\tactive: true,\n\t\t}, 0 as EditorGroupColumn);\n\t\tassert.strictEqual(lastInvokedDeserializer, serializerB);\n\t});\n\n\ttest('asWebviewUri for local file paths', () => {\n\t\tconst webview = createWebview(rpcProtocol, /* remoteAuthority */undefined);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///Users/codey/file.html')).toString()),\n\t\t\t`https://file%2B.vscode-resource.${webviewResourceBaseHost}/Users/codey/file.html`,\n\t\t\t'Unix basic'\n\t\t);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///Users/codey/file.html#frag')).toString()),\n\t\t\t`https://file%2B.vscode-resource.${webviewResourceBaseHost}/Users/codey/file.html#frag`,\n\t\t\t'Unix should preserve fragment'\n\t\t);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///Users/codey/f%20ile.html')).toString()),\n\t\t\t`https://file%2B.vscode-resource.${webviewResourceBaseHost}/Users/codey/f%20ile.html`,\n\t\t\t'Unix with encoding'\n\t\t);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file://localhost/Users/codey/file.html')).toString()),\n\t\t\t`https://file%2Blocalhost.vscode-resource.${webviewResourceBaseHost}/Users/codey/file.html`,\n\t\t\t'Unix should preserve authority'\n\t\t);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///c:/codey/file.txt')).toString()),\n\t\t\t`https://file%2B.vscode-resource.${webviewResourceBaseHost}/c%3A/codey/file.txt`,\n\t\t\t'Windows C drive'\n\t\t);\n\t});\n\n\ttest('asWebviewUri for remote file paths', () => {\n\t\tconst webview = createWebview(rpcProtocol, /* remoteAuthority */ 'remote');\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///Users/codey/file.html')).toString()),\n\t\t\t`https://vscode-remote%2Bremote.vscode-resource.${webviewResourceBaseHost}/Users/codey/file.html`,\n\t\t\t'Unix basic'\n\t\t);\n\t});\n\n\ttest('asWebviewUri for remote with / and + in name', () => {\n\t\tconst webview = createWebview(rpcProtocol, /* remoteAuthority */ 'remote');\n\t\tconst authority = 'ssh-remote+localhost=foo/bar';\n\n\t\tconst sourceUri = URI.from({\n\t\t\tscheme: 'vscode-remote',\n\t\t\tauthority: authority,\n\t\t\tpath: '/Users/cody/x.png'\n\t\t});\n\n\t\tconst webviewUri = webview.webview.asWebviewUri(sourceUri);\n\t\tassert.strictEqual(\n\t\t\twebviewUri.toString(),\n\t\t\t`https://vscode-remote%2Bssh-002dremote-002blocalhost-003dfoo-002fbar.vscode-resource.vscode-cdn.net/Users/cody/x.png`,\n\t\t\t'Check transform');\n\n\t\tassert.strictEqual(\n\t\t\tdecodeAuthority(webviewUri.authority),\n\t\t\t`vscode-remote+${authority}.vscode-resource.vscode-cdn.net`,\n\t\t\t'Check decoded authority'\n\t\t);\n\t});\n\n\ttest('asWebviewUri for remote with port in name', () => {\n\t\tconst webview = createWebview(rpcProtocol, /* remoteAuthority */ 'remote');\n\t\tconst authority = 'localhost:8080';\n\n\t\tconst sourceUri = URI.from({\n\t\t\tscheme: 'vscode-remote',\n\t\t\tauthority: authority,\n\t\t\tpath: '/Users/cody/x.png'\n\t\t});\n\n\t\tconst webviewUri = webview.webview.asWebviewUri(sourceUri);\n\t\tassert.strictEqual(\n\t\t\twebviewUri.toString(),\n\t\t\t`https://vscode-remote%2Blocalhost-003a8080.vscode-resource.vscode-cdn.net/Users/cody/x.png`,\n\t\t\t'Check transform');\n\n\t\tassert.strictEqual(\n\t\t\tdecodeAuthority(webviewUri.authority),\n\t\t\t`vscode-remote+${authority}.vscode-resource.vscode-cdn.net`,\n\t\t\t'Check decoded authority'\n\t\t);\n\t});\n});\n\n\nfunction createNoopMainThreadWebviews() {\n\treturn new class extends mock<MainThreadWebviewManager>() {\n\t\t$disposeWebview() { /* noop */ }\n\t\t$createWebviewPanel() { /* noop */ }\n\t\t$registerSerializer() { /* noop */ }\n\t\t$unregisterSerializer() { /* noop */ }\n\t};\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { mock } from '../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { IExtensionDescription } from '../../../../platform/extensions/common/extensions.js';\nimport { NullLogService } from '../../../../platform/log/common/log.js';\nimport { MainThreadWebviewManager } from '../../browser/mainThreadWebviewManager.js';\nimport { NullApiDeprecationService } from '../../common/extHostApiDeprecationService.js';\nimport { IExtHostRpcService } from '../../common/extHostRpcService.js';\nimport { ExtHostWebviews } from '../../common/extHostWebview.js';\nimport { ExtHostWebviewPanels } from '../../common/extHostWebviewPanels.js';\nimport { SingleProxyRPCProtocol } from '../common/testRPCProtocol.js';\nimport { decodeAuthority, webviewResourceBaseHost } from '../../../contrib/webview/common/webview.js';\nimport { EditorGroupColumn } from '../../../services/editor/common/editorGroupColumn.js';\nimport { IExtHostContext } from '../../../services/extensions/common/extHostCustomers.js';\nimport type * as vscode from 'vscode';\n\nsuite('ExtHostWebview', () => {\n\tlet disposables: DisposableStore;\n\tlet rpcProtocol: (IExtHostRpcService & IExtHostContext) | undefined;\n\n\tsetup(() => {\n\t\tdisposables = new DisposableStore();\n\n\t\tconst shape = createNoopMainThreadWebviews();\n\t\trpcProtocol = SingleProxyRPCProtocol(shape);\n\t});\n\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tfunction createWebview(rpcProtocol: (IExtHostRpcService & IExtHostContext) | undefined, remoteAuthority: string | undefined) {\n\t\tconst extHostWebviews = disposables.add(new ExtHostWebviews(rpcProtocol!, {\n\t\t\tauthority: remoteAuthority,\n\t\t\tisRemote: !!remoteAuthority,\n\t\t}, undefined, new NullLogService(), NullApiDeprecationService));\n\n\t\tconst extHostWebviewPanels = disposables.add(new ExtHostWebviewPanels(rpcProtocol!, extHostWebviews, undefined));\n\n\t\treturn disposables.add(extHostWebviewPanels.createWebviewPanel({\n\t\t\textensionLocation: URI.from({\n\t\t\t\tscheme: remoteAuthority ? Schemas.vscodeRemote : Schemas.file,\n\t\t\t\tauthority: remoteAuthority,\n\t\t\t\tpath: '/ext/path',\n\t\t\t})\n\t\t} as IExtensionDescription, 'type', 'title', 1, {}));\n\t}\n\n\ttest('Cannot register multiple serializers for the same view type', async () => {\n\t\tconst viewType = 'view.type';\n\n\t\tconst extHostWebviews = disposables.add(new ExtHostWebviews(rpcProtocol!, { authority: undefined, isRemote: false }, undefined, new NullLogService(), NullApiDeprecationService));\n\n\t\tconst extHostWebviewPanels = disposables.add(new ExtHostWebviewPanels(rpcProtocol!, extHostWebviews, undefined));\n\n\t\tlet lastInvokedDeserializer: vscode.WebviewPanelSerializer | undefined = undefined;\n\n\t\tclass NoopSerializer implements vscode.WebviewPanelSerializer {\n\t\t\tasync deserializeWebviewPanel(webview: vscode.WebviewPanel, _state: any): Promise<void> {\n\t\t\t\tlastInvokedDeserializer = this;\n\t\t\t\tdisposables.add(webview);\n\t\t\t}\n\t\t}\n\n\t\tconst extension = {} as IExtensionDescription;\n\n\t\tconst serializerA = new NoopSerializer();\n\t\tconst serializerB = new NoopSerializer();\n\n\t\tconst serializerARegistration = extHostWebviewPanels.registerWebviewPanelSerializer(extension, viewType, serializerA);\n\n\t\tawait extHostWebviewPanels.$deserializeWebviewPanel('x', viewType, {\n\t\t\ttitle: 'title',\n\t\t\tstate: {},\n\t\t\tpanelOptions: {},\n\t\t\twebviewOptions: {},\n\t\t\tactive: true,\n\t\t}, 0 as EditorGroupColumn);\n\t\tassert.strictEqual(lastInvokedDeserializer, serializerA);\n\n\t\tassert.throws(\n\t\t\t() => disposables.add(extHostWebviewPanels.registerWebviewPanelSerializer(extension, viewType, serializerB)),\n\t\t\t'Should throw when registering two serializers for the same view');\n\n\t\tserializerARegistration.dispose();\n\n\t\tdisposables.add(extHostWebviewPanels.registerWebviewPanelSerializer(extension, viewType, serializerB));\n\n\t\tawait extHostWebviewPanels.$deserializeWebviewPanel('x', viewType, {\n\t\t\ttitle: 'title',\n\t\t\tstate: {},\n\t\t\tpanelOptions: {},\n\t\t\twebviewOptions: {},\n\t\t\tactive: true,\n\t\t}, 0 as EditorGroupColumn);\n\t\tassert.strictEqual(lastInvokedDeserializer, serializerB);\n\t});\n\n\ttest('asWebviewUri for local file paths', () => {\n\t\tconst webview = createWebview(rpcProtocol, /* remoteAuthority */undefined);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///Users/codey/file.html')).toString()),\n\t\t\t`https://file%2B.vscode-resource.${webviewResourceBaseHost}/Users/codey/file.html`,\n\t\t\t'Unix basic'\n\t\t);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///Users/codey/file.html#frag')).toString()),\n\t\t\t`https://file%2B.vscode-resource.${webviewResourceBaseHost}/Users/codey/file.html#frag`,\n\t\t\t'Unix should preserve fragment'\n\t\t);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///Users/codey/f%20ile.html')).toString()),\n\t\t\t`https://file%2B.vscode-resource.${webviewResourceBaseHost}/Users/codey/f%20ile.html`,\n\t\t\t'Unix with encoding'\n\t\t);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file://localhost/Users/codey/file.html')).toString()),\n\t\t\t`https://file%2Blocalhost.vscode-resource.${webviewResourceBaseHost}/Users/codey/file.html`,\n\t\t\t'Unix should preserve authority'\n\t\t);\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///c:/codey/file.txt')).toString()),\n\t\t\t`https://file%2B.vscode-resource.${webviewResourceBaseHost}/c%3A/codey/file.txt`,\n\t\t\t'Windows C drive'\n\t\t);\n\t});\n\n\ttest('asWebviewUri for remote file paths', () => {\n\t\tconst webview = createWebview(rpcProtocol, /* remoteAuthority */ 'remote');\n\n\t\tassert.strictEqual(\n\t\t\t(webview.webview.asWebviewUri(URI.parse('file:///Users/codey/file.html')).toString()),\n\t\t\t`https://vscode-remote%2Bremote.vscode-resource.${webviewResourceBaseHost}/Users/codey/file.html`,\n\t\t\t'Unix basic'\n\t\t);\n\t});\n\n\ttest('asWebviewUri for remote with / and + in name', () => {\n\t\tconst webview = createWebview(rpcProtocol, /* remoteAuthority */ 'remote');\n\t\tconst authority = 'ssh-remote+localhost=foo/bar';\n\n\t\tconst sourceUri = URI.from({\n\t\t\tscheme: 'vscode-remote',\n\t\t\tauthority: authority,\n\t\t\tpath: '/Users/cody/x.png'\n\t\t});\n\n\t\tconst webviewUri = webview.webview.asWebviewUri(sourceUri);\n\t\tassert.strictEqual(\n\t\t\twebviewUri.toString(),\n\t\t\t`https://vscode-remote%2Bssh-002dremote-002blocalhost-003dfoo-002fbar.vscode-resource.vscode-cdn.net/Users/cody/x.png`,\n\t\t\t'Check transform');\n\n\t\tassert.strictEqual(\n\t\t\tdecodeAuthority(webviewUri.authority),\n\t\t\t`vscode-remote+${authority}.vscode-resource.vscode-cdn.net`,\n\t\t\t'Check decoded authority'\n\t\t);\n\t});\n\n\ttest('asWebviewUri for remote with port in name', () => {\n\t\tconst webview = createWebview(rpcProtocol, /* remoteAuthority */ 'remote');\n\t\tconst authority = 'localhost:8080';\n\n\t\tconst sourceUri = URI.from({\n\t\t\tscheme: 'vscode-remote',\n\t\t\tauthority: authority,\n\t\t\tpath: '/Users/cody/x.png'\n\t\t});\n\n\t\tconst webviewUri = webview.webview.asWebviewUri(sourceUri);\n\t\tassert.strictEqual(\n\t\t\twebviewUri.toString(),\n\t\t\t`https://vscode-remote%2Blocalhost-003a8080.vscode-resource.vscode-cdn.net/Users/cody/x.png`,\n\t\t\t'Check transform');\n\n\t\tassert.strictEqual(\n\t\t\tdecodeAuthority(webviewUri.authority),\n\t\t\t`vscode-remote+${authority}.vscode-resource.vscode-cdn.net`,\n\t\t\t'Check decoded authority'\n\t\t);\n\t});\n});\n\n\nfunction createNoopMainThreadWebviews() {\n\treturn new class extends mock<MainThreadWebviewManager>() {\n\t\t$disposeWebview() { /* noop */ }\n\t\t$createWebviewPanel() { /* noop */ }\n\t\t$registerSerializer() { /* noop */ }\n\t\t$unregisterSerializer() { /* noop */ }\n\t};\n}\n"]}