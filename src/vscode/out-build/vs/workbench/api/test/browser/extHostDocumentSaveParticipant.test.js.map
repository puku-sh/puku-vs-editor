{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/api/test/browser/extHostDocumentSaveParticipant.test.ts","vs/workbench/api/test/browser/extHostDocumentSaveParticipant.test.ts"],"names":[],"mappings":"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","file":"extHostDocumentSaveParticipant.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport assert from 'assert';\nimport { URI } from '../../../../base/common/uri.js';\nimport { ExtHostDocuments } from '../../common/extHostDocuments.js';\nimport { ExtHostDocumentsAndEditors } from '../../common/extHostDocumentsAndEditors.js';\nimport { TextDocumentSaveReason, TextEdit, Position, EndOfLine } from '../../common/extHostTypes.js';\nimport { MainThreadTextEditorsShape, IWorkspaceEditDto, IWorkspaceTextEditDto, MainThreadBulkEditsShape } from '../../common/extHost.protocol.js';\nimport { ExtHostDocumentSaveParticipant } from '../../common/extHostDocumentSaveParticipant.js';\nimport { SingleProxyRPCProtocol } from '../common/testRPCProtocol.js';\nimport { SaveReason } from '../../../common/editor.js';\nimport type * as vscode from 'vscode';\nimport { mock } from '../../../../base/test/common/mock.js';\nimport { NullLogService } from '../../../../platform/log/common/log.js';\nimport { nullExtensionDescription } from '../../../services/extensions/common/extensions.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { SerializableObjectWithBuffers } from '../../../services/extensions/common/proxyIdentifier.js';\n\nfunction timeout(n: number) {\n\treturn new Promise(resolve => setTimeout(resolve, n));\n}\n\nsuite('ExtHostDocumentSaveParticipant', () => {\n\n\tconst resource = URI.parse('foo:bar');\n\tconst mainThreadBulkEdits = new class extends mock<MainThreadBulkEditsShape>() { };\n\tlet documents: ExtHostDocuments;\n\tconst nullLogService = new NullLogService();\n\n\tsetup(() => {\n\t\tconst documentsAndEditors = new ExtHostDocumentsAndEditors(SingleProxyRPCProtocol(null), new NullLogService());\n\t\tdocumentsAndEditors.$acceptDocumentsAndEditorsDelta({\n\t\t\taddedDocuments: [{\n\t\t\t\tisDirty: false,\n\t\t\t\tlanguageId: 'foo',\n\t\t\t\turi: resource,\n\t\t\t\tversionId: 1,\n\t\t\t\tlines: ['foo'],\n\t\t\t\tEOL: '\\n',\n\t\t\t\tencoding: 'utf8'\n\t\t\t}]\n\t\t});\n\t\tdocuments = new ExtHostDocuments(SingleProxyRPCProtocol(null), documentsAndEditors);\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('no listeners, no problem', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => assert.ok(true));\n\t});\n\n\ttest('event delivery', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tlet event: vscode.TextDocumentWillSaveEvent;\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tevent = e;\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\n\t\t\tassert.ok(event);\n\t\t\tassert.strictEqual(event.reason, TextDocumentSaveReason.Manual);\n\t\t\tassert.strictEqual(typeof event.waitUntil, 'function');\n\t\t});\n\t});\n\n\ttest('event delivery, immutable', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tlet event: vscode.TextDocumentWillSaveEvent;\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tevent = e;\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\n\t\t\tassert.ok(event);\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tassert.throws(() => { (event.document as any) = null!; });\n\t\t});\n\t});\n\n\ttest('event delivery, bad listener', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tthrow new Error('ðŸ’€');\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(values => {\n\t\t\tsub.dispose();\n\n\t\t\tconst [first] = values;\n\t\t\tassert.strictEqual(first, false);\n\t\t});\n\t});\n\n\ttest('event delivery, bad listener doesn\\'t prevent more events', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tthrow new Error('ðŸ’€');\n\t\t});\n\t\tlet event: vscode.TextDocumentWillSaveEvent;\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tevent = e;\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub1.dispose();\n\t\t\tsub2.dispose();\n\n\t\t\tassert.ok(event);\n\t\t});\n\t});\n\n\ttest('event delivery, in subscriber order', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tlet counter = 0;\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tassert.strictEqual(counter++, 0);\n\t\t});\n\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tassert.strictEqual(counter++, 1);\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub1.dispose();\n\t\t\tsub2.dispose();\n\t\t});\n\t});\n\n\ttest('event delivery, ignore bad listeners', async () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits, { timeout: 5, errors: 1 });\n\n\t\tlet callCount = 0;\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tcallCount += 1;\n\t\t\tthrow new Error('boom');\n\t\t});\n\n\t\tawait participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\t\tawait participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\t\tawait participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\t\tawait participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\n\t\tsub.dispose();\n\t\tassert.strictEqual(callCount, 2);\n\t});\n\n\ttest('event delivery, overall timeout', async function () {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits, { timeout: 20, errors: 5 });\n\n\t\t// let callCount = 0;\n\t\tconst calls: number[] = [];\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tcalls.push(1);\n\t\t});\n\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tcalls.push(2);\n\t\t\tevent.waitUntil(timeout(100));\n\t\t});\n\n\t\tconst sub3 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tcalls.push(3);\n\t\t});\n\n\t\tconst values = await participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\t\tsub1.dispose();\n\t\tsub2.dispose();\n\t\tsub3.dispose();\n\t\tassert.deepStrictEqual(calls, [1, 2]);\n\t\tassert.strictEqual(values.length, 2);\n\t});\n\n\ttest('event delivery, waitUntil', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\n\t\t\tevent.waitUntil(timeout(10));\n\t\t\tevent.waitUntil(timeout(10));\n\t\t\tevent.waitUntil(timeout(10));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\t\t});\n\n\t});\n\n\ttest('event delivery, waitUntil must be called sync', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\n\t\t\tevent.waitUntil(new Promise<undefined>((resolve, reject) => {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tassert.throws(() => event.waitUntil(timeout(10)));\n\t\t\t\t\t\tresolve(undefined);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treject(e);\n\t\t\t\t\t}\n\n\t\t\t\t}, 10);\n\t\t\t}));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\t\t});\n\t});\n\n\ttest('event delivery, waitUntil will timeout', function () {\n\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits, { timeout: 5, errors: 3 });\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tevent.waitUntil(timeout(100));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(values => {\n\t\t\tsub.dispose();\n\n\t\t\tconst [first] = values;\n\t\t\tassert.strictEqual(first, false);\n\t\t});\n\t});\n\n\ttest('event delivery, waitUntil failure handling', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\te.waitUntil(Promise.reject(new Error('dddd')));\n\t\t});\n\n\t\tlet event: vscode.TextDocumentWillSaveEvent;\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tevent = e;\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tassert.ok(event);\n\t\t\tsub1.dispose();\n\t\t\tsub2.dispose();\n\t\t});\n\t});\n\n\ttest('event delivery, pushEdits sync', () => {\n\n\t\tlet dto: IWorkspaceEditDto;\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, new class extends mock<MainThreadTextEditorsShape>() {\n\t\t\t$tryApplyWorkspaceEdit(_edits: SerializableObjectWithBuffers<IWorkspaceEditDto>) {\n\t\t\t\tdto = _edits.value;\n\t\t\t\treturn Promise.resolve(true);\n\t\t\t}\n\t\t});\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\te.waitUntil(Promise.resolve([TextEdit.insert(new Position(0, 0), 'bar')]));\n\t\t\te.waitUntil(Promise.resolve([TextEdit.setEndOfLine(EndOfLine.CRLF)]));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\n\t\t\tassert.strictEqual(dto.edits.length, 2);\n\t\t\tassert.ok((<IWorkspaceTextEditDto>dto.edits[0]).textEdit);\n\t\t\tassert.ok((<IWorkspaceTextEditDto>dto.edits[1]).textEdit);\n\t\t});\n\t});\n\n\ttest('event delivery, concurrent change', () => {\n\n\t\tlet edits: IWorkspaceEditDto;\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, new class extends mock<MainThreadTextEditorsShape>() {\n\t\t\t$tryApplyWorkspaceEdit(_edits: SerializableObjectWithBuffers<IWorkspaceEditDto>) {\n\t\t\t\tedits = _edits.value;\n\t\t\t\treturn Promise.resolve(true);\n\t\t\t}\n\t\t});\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\n\t\t\t// concurrent change from somewhere\n\t\t\tdocuments.$acceptModelChanged(resource, {\n\t\t\t\tchanges: [{\n\t\t\t\t\trange: { startLineNumber: 1, startColumn: 1, endLineNumber: 1, endColumn: 1 },\n\t\t\t\t\trangeOffset: undefined!,\n\t\t\t\t\trangeLength: undefined!,\n\t\t\t\t\ttext: 'bar'\n\t\t\t\t}],\n\t\t\t\teol: undefined!,\n\t\t\t\tversionId: 2,\n\t\t\t\tisRedoing: false,\n\t\t\t\tisUndoing: false,\n\t\t\t\tdetailedReason: undefined,\n\t\t\t\tisFlush: false,\n\t\t\t\tisEolChange: false,\n\t\t\t}, true);\n\n\t\t\te.waitUntil(Promise.resolve([TextEdit.insert(new Position(0, 0), 'bar')]));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(values => {\n\t\t\tsub.dispose();\n\n\t\t\tassert.strictEqual(edits, undefined);\n\t\t\tassert.strictEqual(values[0], false);\n\t\t});\n\n\t});\n\n\ttest('event delivery, two listeners -> two document states', () => {\n\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, new class extends mock<MainThreadTextEditorsShape>() {\n\t\t\t$tryApplyWorkspaceEdit(dto: SerializableObjectWithBuffers<IWorkspaceEditDto>) {\n\n\t\t\t\tfor (const edit of dto.value.edits) {\n\n\t\t\t\t\tconst uri = URI.revive((<IWorkspaceTextEditDto>edit).resource);\n\t\t\t\t\tconst { text, range } = (<IWorkspaceTextEditDto>edit).textEdit;\n\t\t\t\t\tdocuments.$acceptModelChanged(uri, {\n\t\t\t\t\t\tchanges: [{\n\t\t\t\t\t\t\trange,\n\t\t\t\t\t\t\ttext,\n\t\t\t\t\t\t\trangeOffset: undefined!,\n\t\t\t\t\t\t\trangeLength: undefined!,\n\t\t\t\t\t\t}],\n\t\t\t\t\t\teol: undefined!,\n\t\t\t\t\t\tversionId: documents.getDocumentData(uri)!.version + 1,\n\t\t\t\t\t\tisRedoing: false,\n\t\t\t\t\t\tisUndoing: false,\n\t\t\t\t\t\tdetailedReason: undefined,\n\t\t\t\t\t\tisFlush: false,\n\t\t\t\t\t\tisEolChange: false,\n\t\t\t\t\t}, true);\n\t\t\t\t\t// }\n\t\t\t\t}\n\n\t\t\t\treturn Promise.resolve(true);\n\t\t\t}\n\t\t});\n\n\t\tconst document = documents.getDocument(resource);\n\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\t// the document state we started with\n\t\t\tassert.strictEqual(document.version, 1);\n\t\t\tassert.strictEqual(document.getText(), 'foo');\n\n\t\t\te.waitUntil(Promise.resolve([TextEdit.insert(new Position(0, 0), 'bar')]));\n\t\t});\n\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\t// the document state AFTER the first listener kicked in\n\t\t\tassert.strictEqual(document.version, 2);\n\t\t\tassert.strictEqual(document.getText(), 'barfoo');\n\n\t\t\te.waitUntil(Promise.resolve([TextEdit.insert(new Position(0, 0), 'bar')]));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(values => {\n\t\t\tsub1.dispose();\n\t\t\tsub2.dispose();\n\n\t\t\t// the document state AFTER eventing is done\n\t\t\tassert.strictEqual(document.version, 3);\n\t\t\tassert.strictEqual(document.getText(), 'barbarfoo');\n\t\t});\n\n\t});\n\n\ttest('Log failing listener', function () {\n\t\tlet didLogSomething = false;\n\t\tconst participant = new ExtHostDocumentSaveParticipant(new class extends NullLogService {\n\t\t\toverride error(message: string | Error, ...args: any[]): void {\n\t\t\t\tdidLogSomething = true;\n\t\t\t}\n\t\t}, documents, mainThreadBulkEdits);\n\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tthrow new Error('boom');\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\t\t\tassert.strictEqual(didLogSomething, true);\n\t\t});\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport assert from 'assert';\nimport { URI } from '../../../../base/common/uri.js';\nimport { ExtHostDocuments } from '../../common/extHostDocuments.js';\nimport { ExtHostDocumentsAndEditors } from '../../common/extHostDocumentsAndEditors.js';\nimport { TextDocumentSaveReason, TextEdit, Position, EndOfLine } from '../../common/extHostTypes.js';\nimport { MainThreadTextEditorsShape, IWorkspaceEditDto, IWorkspaceTextEditDto, MainThreadBulkEditsShape } from '../../common/extHost.protocol.js';\nimport { ExtHostDocumentSaveParticipant } from '../../common/extHostDocumentSaveParticipant.js';\nimport { SingleProxyRPCProtocol } from '../common/testRPCProtocol.js';\nimport { SaveReason } from '../../../common/editor.js';\nimport type * as vscode from 'vscode';\nimport { mock } from '../../../../base/test/common/mock.js';\nimport { NullLogService } from '../../../../platform/log/common/log.js';\nimport { nullExtensionDescription } from '../../../services/extensions/common/extensions.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { SerializableObjectWithBuffers } from '../../../services/extensions/common/proxyIdentifier.js';\n\nfunction timeout(n: number) {\n\treturn new Promise(resolve => setTimeout(resolve, n));\n}\n\nsuite('ExtHostDocumentSaveParticipant', () => {\n\n\tconst resource = URI.parse('foo:bar');\n\tconst mainThreadBulkEdits = new class extends mock<MainThreadBulkEditsShape>() { };\n\tlet documents: ExtHostDocuments;\n\tconst nullLogService = new NullLogService();\n\n\tsetup(() => {\n\t\tconst documentsAndEditors = new ExtHostDocumentsAndEditors(SingleProxyRPCProtocol(null), new NullLogService());\n\t\tdocumentsAndEditors.$acceptDocumentsAndEditorsDelta({\n\t\t\taddedDocuments: [{\n\t\t\t\tisDirty: false,\n\t\t\t\tlanguageId: 'foo',\n\t\t\t\turi: resource,\n\t\t\t\tversionId: 1,\n\t\t\t\tlines: ['foo'],\n\t\t\t\tEOL: '\\n',\n\t\t\t\tencoding: 'utf8'\n\t\t\t}]\n\t\t});\n\t\tdocuments = new ExtHostDocuments(SingleProxyRPCProtocol(null), documentsAndEditors);\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('no listeners, no problem', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => assert.ok(true));\n\t});\n\n\ttest('event delivery', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tlet event: vscode.TextDocumentWillSaveEvent;\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tevent = e;\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\n\t\t\tassert.ok(event);\n\t\t\tassert.strictEqual(event.reason, TextDocumentSaveReason.Manual);\n\t\t\tassert.strictEqual(typeof event.waitUntil, 'function');\n\t\t});\n\t});\n\n\ttest('event delivery, immutable', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tlet event: vscode.TextDocumentWillSaveEvent;\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tevent = e;\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\n\t\t\tassert.ok(event);\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tassert.throws(() => { (event.document as any) = null!; });\n\t\t});\n\t});\n\n\ttest('event delivery, bad listener', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tthrow new Error('ðŸ’€');\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(values => {\n\t\t\tsub.dispose();\n\n\t\t\tconst [first] = values;\n\t\t\tassert.strictEqual(first, false);\n\t\t});\n\t});\n\n\ttest('event delivery, bad listener doesn\\'t prevent more events', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tthrow new Error('ðŸ’€');\n\t\t});\n\t\tlet event: vscode.TextDocumentWillSaveEvent;\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tevent = e;\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub1.dispose();\n\t\t\tsub2.dispose();\n\n\t\t\tassert.ok(event);\n\t\t});\n\t});\n\n\ttest('event delivery, in subscriber order', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tlet counter = 0;\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tassert.strictEqual(counter++, 0);\n\t\t});\n\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tassert.strictEqual(counter++, 1);\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub1.dispose();\n\t\t\tsub2.dispose();\n\t\t});\n\t});\n\n\ttest('event delivery, ignore bad listeners', async () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits, { timeout: 5, errors: 1 });\n\n\t\tlet callCount = 0;\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tcallCount += 1;\n\t\t\tthrow new Error('boom');\n\t\t});\n\n\t\tawait participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\t\tawait participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\t\tawait participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\t\tawait participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\n\t\tsub.dispose();\n\t\tassert.strictEqual(callCount, 2);\n\t});\n\n\ttest('event delivery, overall timeout', async function () {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits, { timeout: 20, errors: 5 });\n\n\t\t// let callCount = 0;\n\t\tconst calls: number[] = [];\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tcalls.push(1);\n\t\t});\n\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tcalls.push(2);\n\t\t\tevent.waitUntil(timeout(100));\n\t\t});\n\n\t\tconst sub3 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tcalls.push(3);\n\t\t});\n\n\t\tconst values = await participant.$participateInSave(resource, SaveReason.EXPLICIT);\n\t\tsub1.dispose();\n\t\tsub2.dispose();\n\t\tsub3.dispose();\n\t\tassert.deepStrictEqual(calls, [1, 2]);\n\t\tassert.strictEqual(values.length, 2);\n\t});\n\n\ttest('event delivery, waitUntil', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\n\t\t\tevent.waitUntil(timeout(10));\n\t\t\tevent.waitUntil(timeout(10));\n\t\t\tevent.waitUntil(timeout(10));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\t\t});\n\n\t});\n\n\ttest('event delivery, waitUntil must be called sync', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\n\t\t\tevent.waitUntil(new Promise<undefined>((resolve, reject) => {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tassert.throws(() => event.waitUntil(timeout(10)));\n\t\t\t\t\t\tresolve(undefined);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\treject(e);\n\t\t\t\t\t}\n\n\t\t\t\t}, 10);\n\t\t\t}));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\t\t});\n\t});\n\n\ttest('event delivery, waitUntil will timeout', function () {\n\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits, { timeout: 5, errors: 3 });\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (event) {\n\t\t\tevent.waitUntil(timeout(100));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(values => {\n\t\t\tsub.dispose();\n\n\t\t\tconst [first] = values;\n\t\t\tassert.strictEqual(first, false);\n\t\t});\n\t});\n\n\ttest('event delivery, waitUntil failure handling', () => {\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, mainThreadBulkEdits);\n\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\te.waitUntil(Promise.reject(new Error('dddd')));\n\t\t});\n\n\t\tlet event: vscode.TextDocumentWillSaveEvent;\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tevent = e;\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tassert.ok(event);\n\t\t\tsub1.dispose();\n\t\t\tsub2.dispose();\n\t\t});\n\t});\n\n\ttest('event delivery, pushEdits sync', () => {\n\n\t\tlet dto: IWorkspaceEditDto;\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, new class extends mock<MainThreadTextEditorsShape>() {\n\t\t\t$tryApplyWorkspaceEdit(_edits: SerializableObjectWithBuffers<IWorkspaceEditDto>) {\n\t\t\t\tdto = _edits.value;\n\t\t\t\treturn Promise.resolve(true);\n\t\t\t}\n\t\t});\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\te.waitUntil(Promise.resolve([TextEdit.insert(new Position(0, 0), 'bar')]));\n\t\t\te.waitUntil(Promise.resolve([TextEdit.setEndOfLine(EndOfLine.CRLF)]));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\n\t\t\tassert.strictEqual(dto.edits.length, 2);\n\t\t\tassert.ok((<IWorkspaceTextEditDto>dto.edits[0]).textEdit);\n\t\t\tassert.ok((<IWorkspaceTextEditDto>dto.edits[1]).textEdit);\n\t\t});\n\t});\n\n\ttest('event delivery, concurrent change', () => {\n\n\t\tlet edits: IWorkspaceEditDto;\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, new class extends mock<MainThreadTextEditorsShape>() {\n\t\t\t$tryApplyWorkspaceEdit(_edits: SerializableObjectWithBuffers<IWorkspaceEditDto>) {\n\t\t\t\tedits = _edits.value;\n\t\t\t\treturn Promise.resolve(true);\n\t\t\t}\n\t\t});\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\n\t\t\t// concurrent change from somewhere\n\t\t\tdocuments.$acceptModelChanged(resource, {\n\t\t\t\tchanges: [{\n\t\t\t\t\trange: { startLineNumber: 1, startColumn: 1, endLineNumber: 1, endColumn: 1 },\n\t\t\t\t\trangeOffset: undefined!,\n\t\t\t\t\trangeLength: undefined!,\n\t\t\t\t\ttext: 'bar'\n\t\t\t\t}],\n\t\t\t\teol: undefined!,\n\t\t\t\tversionId: 2,\n\t\t\t\tisRedoing: false,\n\t\t\t\tisUndoing: false,\n\t\t\t\tdetailedReason: undefined,\n\t\t\t\tisFlush: false,\n\t\t\t\tisEolChange: false,\n\t\t\t}, true);\n\n\t\t\te.waitUntil(Promise.resolve([TextEdit.insert(new Position(0, 0), 'bar')]));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(values => {\n\t\t\tsub.dispose();\n\n\t\t\tassert.strictEqual(edits, undefined);\n\t\t\tassert.strictEqual(values[0], false);\n\t\t});\n\n\t});\n\n\ttest('event delivery, two listeners -> two document states', () => {\n\n\t\tconst participant = new ExtHostDocumentSaveParticipant(nullLogService, documents, new class extends mock<MainThreadTextEditorsShape>() {\n\t\t\t$tryApplyWorkspaceEdit(dto: SerializableObjectWithBuffers<IWorkspaceEditDto>) {\n\n\t\t\t\tfor (const edit of dto.value.edits) {\n\n\t\t\t\t\tconst uri = URI.revive((<IWorkspaceTextEditDto>edit).resource);\n\t\t\t\t\tconst { text, range } = (<IWorkspaceTextEditDto>edit).textEdit;\n\t\t\t\t\tdocuments.$acceptModelChanged(uri, {\n\t\t\t\t\t\tchanges: [{\n\t\t\t\t\t\t\trange,\n\t\t\t\t\t\t\ttext,\n\t\t\t\t\t\t\trangeOffset: undefined!,\n\t\t\t\t\t\t\trangeLength: undefined!,\n\t\t\t\t\t\t}],\n\t\t\t\t\t\teol: undefined!,\n\t\t\t\t\t\tversionId: documents.getDocumentData(uri)!.version + 1,\n\t\t\t\t\t\tisRedoing: false,\n\t\t\t\t\t\tisUndoing: false,\n\t\t\t\t\t\tdetailedReason: undefined,\n\t\t\t\t\t\tisFlush: false,\n\t\t\t\t\t\tisEolChange: false,\n\t\t\t\t\t}, true);\n\t\t\t\t\t// }\n\t\t\t\t}\n\n\t\t\t\treturn Promise.resolve(true);\n\t\t\t}\n\t\t});\n\n\t\tconst document = documents.getDocument(resource);\n\n\t\tconst sub1 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\t// the document state we started with\n\t\t\tassert.strictEqual(document.version, 1);\n\t\t\tassert.strictEqual(document.getText(), 'foo');\n\n\t\t\te.waitUntil(Promise.resolve([TextEdit.insert(new Position(0, 0), 'bar')]));\n\t\t});\n\n\t\tconst sub2 = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\t// the document state AFTER the first listener kicked in\n\t\t\tassert.strictEqual(document.version, 2);\n\t\t\tassert.strictEqual(document.getText(), 'barfoo');\n\n\t\t\te.waitUntil(Promise.resolve([TextEdit.insert(new Position(0, 0), 'bar')]));\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(values => {\n\t\t\tsub1.dispose();\n\t\t\tsub2.dispose();\n\n\t\t\t// the document state AFTER eventing is done\n\t\t\tassert.strictEqual(document.version, 3);\n\t\t\tassert.strictEqual(document.getText(), 'barbarfoo');\n\t\t});\n\n\t});\n\n\ttest('Log failing listener', function () {\n\t\tlet didLogSomething = false;\n\t\tconst participant = new ExtHostDocumentSaveParticipant(new class extends NullLogService {\n\t\t\toverride error(message: string | Error, ...args: any[]): void {\n\t\t\t\tdidLogSomething = true;\n\t\t\t}\n\t\t}, documents, mainThreadBulkEdits);\n\n\n\t\tconst sub = participant.getOnWillSaveTextDocumentEvent(nullExtensionDescription)(function (e) {\n\t\t\tthrow new Error('boom');\n\t\t});\n\n\t\treturn participant.$participateInSave(resource, SaveReason.EXPLICIT).then(() => {\n\t\t\tsub.dispose();\n\t\t\tassert.strictEqual(didLogSomething, true);\n\t\t});\n\t});\n});\n"]}