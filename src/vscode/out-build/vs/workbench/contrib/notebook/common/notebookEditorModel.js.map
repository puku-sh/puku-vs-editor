{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/common/notebookEditorModel.ts","vs/workbench/contrib/notebook/common/notebookEditorModel.ts"],"names":[],"mappings":"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","file":"notebookEditorModel.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBufferReadableStream, streamToBuffer } from '../../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { CancellationError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { IMarkdownString } from '../../../../base/common/htmlContent.js';\nimport { Disposable, DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { assertType, hasKey } from '../../../../base/common/types.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IWriteFileOptions, IFileStatWithMetadata, FileOperationError, FileOperationResult } from '../../../../platform/files/common/files.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IRevertOptions, ISaveOptions, IUntypedEditorInput } from '../../../common/editor.js';\nimport { EditorModel } from '../../../common/editor/editorModel.js';\nimport { NotebookTextModel } from './model/notebookTextModel.js';\nimport { INotebookEditorModel, INotebookLoadOptions, IResolvedNotebookEditorModel, NotebookCellsChangeType, NotebookSetting } from './notebookCommon.js';\nimport { INotebookLoggingService } from './notebookLoggingService.js';\nimport { INotebookSerializer, INotebookService, SimpleNotebookProviderInfo } from './notebookService.js';\nimport { IFilesConfigurationService } from '../../../services/filesConfiguration/common/filesConfigurationService.js';\nimport { IFileWorkingCopyModelConfiguration, SnapshotContext } from '../../../services/workingCopy/common/fileWorkingCopy.js';\nimport { IFileWorkingCopyManager } from '../../../services/workingCopy/common/fileWorkingCopyManager.js';\nimport { IStoredFileWorkingCopy, IStoredFileWorkingCopyModel, IStoredFileWorkingCopyModelContentChangedEvent, IStoredFileWorkingCopyModelFactory, IStoredFileWorkingCopySaveEvent, StoredFileWorkingCopyState } from '../../../services/workingCopy/common/storedFileWorkingCopy.js';\nimport { IUntitledFileWorkingCopy, IUntitledFileWorkingCopyModel, IUntitledFileWorkingCopyModelContentChangedEvent, IUntitledFileWorkingCopyModelFactory } from '../../../services/workingCopy/common/untitledFileWorkingCopy.js';\nimport { WorkingCopyCapabilities } from '../../../services/workingCopy/common/workingCopy.js';\n\n//#region --- simple content provider\n\nexport class SimpleNotebookEditorModel extends EditorModel implements INotebookEditorModel {\n\n\tprivate readonly _onDidChangeDirty = this._register(new Emitter<void>());\n\tprivate readonly _onDidSave = this._register(new Emitter<IStoredFileWorkingCopySaveEvent>());\n\tprivate readonly _onDidChangeOrphaned = this._register(new Emitter<void>());\n\tprivate readonly _onDidChangeReadonly = this._register(new Emitter<void>());\n\tprivate readonly _onDidRevertUntitled = this._register(new Emitter<void>());\n\n\treadonly onDidChangeDirty: Event<void> = this._onDidChangeDirty.event;\n\treadonly onDidSave: Event<IStoredFileWorkingCopySaveEvent> = this._onDidSave.event;\n\treadonly onDidChangeOrphaned: Event<void> = this._onDidChangeOrphaned.event;\n\treadonly onDidChangeReadonly: Event<void> = this._onDidChangeReadonly.event;\n\treadonly onDidRevertUntitled: Event<void> = this._onDidRevertUntitled.event;\n\n\tprivate _workingCopy?: IStoredFileWorkingCopy<NotebookFileWorkingCopyModel> | IUntitledFileWorkingCopy<NotebookFileWorkingCopyModel>;\n\tprivate readonly _workingCopyListeners = this._register(new DisposableStore());\n\tprivate readonly scratchPad: boolean;\n\n\tconstructor(\n\t\treadonly resource: URI,\n\t\tprivate readonly _hasAssociatedFilePath: boolean,\n\t\treadonly viewType: string,\n\t\tprivate readonly _workingCopyManager: IFileWorkingCopyManager<NotebookFileWorkingCopyModel, NotebookFileWorkingCopyModel>,\n\t\tscratchpad: boolean,\n\t\t@IFilesConfigurationService private readonly _filesConfigurationService: IFilesConfigurationService,\n\t) {\n\t\tsuper();\n\n\t\tthis.scratchPad = scratchpad;\n\t}\n\n\toverride dispose(): void {\n\t\tthis._workingCopy?.dispose();\n\t\tsuper.dispose();\n\t}\n\n\tget notebook(): NotebookTextModel | undefined {\n\t\treturn this._workingCopy?.model?.notebookModel;\n\t}\n\n\toverride isResolved(): this is IResolvedNotebookEditorModel {\n\t\treturn Boolean(this._workingCopy?.model?.notebookModel);\n\t}\n\n\tasync canDispose(): Promise<boolean> {\n\t\tif (!this._workingCopy) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (SimpleNotebookEditorModel._isStoredFileWorkingCopy(this._workingCopy)) {\n\t\t\treturn this._workingCopyManager.stored.canDispose(this._workingCopy);\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tisDirty(): boolean {\n\t\treturn this._workingCopy?.isDirty() ?? false;\n\t}\n\n\tisModified(): boolean {\n\t\treturn this._workingCopy?.isModified() ?? false;\n\t}\n\n\tisOrphaned(): boolean {\n\t\treturn SimpleNotebookEditorModel._isStoredFileWorkingCopy(this._workingCopy) && this._workingCopy.hasState(StoredFileWorkingCopyState.ORPHAN);\n\t}\n\n\thasAssociatedFilePath(): boolean {\n\t\treturn !SimpleNotebookEditorModel._isStoredFileWorkingCopy(this._workingCopy) && !!this._workingCopy?.hasAssociatedFilePath;\n\t}\n\n\tisReadonly(): boolean | IMarkdownString {\n\t\tif (SimpleNotebookEditorModel._isStoredFileWorkingCopy(this._workingCopy)) {\n\t\t\treturn this._workingCopy?.isReadonly();\n\t\t} else {\n\t\t\treturn this._filesConfigurationService.isReadonly(this.resource);\n\t\t}\n\t}\n\n\tget hasErrorState(): boolean {\n\t\tif (this._workingCopy && hasKey(this._workingCopy, { hasState: true })) {\n\t\t\treturn this._workingCopy.hasState(StoredFileWorkingCopyState.ERROR);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync revert(options?: IRevertOptions): Promise<void> {\n\t\tassertType(this.isResolved());\n\t\treturn this._workingCopy!.revert(options);\n\t}\n\n\tasync save(options?: ISaveOptions): Promise<boolean> {\n\t\tassertType(this.isResolved());\n\t\treturn this._workingCopy!.save(options);\n\t}\n\n\tasync load(options?: INotebookLoadOptions): Promise<IResolvedNotebookEditorModel> {\n\t\tif (!this._workingCopy || !this._workingCopy.model) {\n\t\t\tif (this.resource.scheme === Schemas.untitled) {\n\t\t\t\tif (this._hasAssociatedFilePath) {\n\t\t\t\t\tthis._workingCopy = await this._workingCopyManager.resolve({ associatedResource: this.resource });\n\t\t\t\t} else {\n\t\t\t\t\tthis._workingCopy = await this._workingCopyManager.resolve({ untitledResource: this.resource, isScratchpad: this.scratchPad });\n\t\t\t\t}\n\t\t\t\tthis._register(this._workingCopy.onDidRevert(() => this._onDidRevertUntitled.fire()));\n\t\t\t} else {\n\t\t\t\tthis._workingCopy = await this._workingCopyManager.resolve(this.resource, {\n\t\t\t\t\tlimits: options?.limits,\n\t\t\t\t\treload: options?.forceReadFromFile ? { async: false, force: true } : undefined\n\t\t\t\t});\n\t\t\t\tthis._workingCopyListeners.add(this._workingCopy.onDidSave(e => this._onDidSave.fire(e)));\n\t\t\t\tthis._workingCopyListeners.add(this._workingCopy.onDidChangeOrphaned(() => this._onDidChangeOrphaned.fire()));\n\t\t\t\tthis._workingCopyListeners.add(this._workingCopy.onDidChangeReadonly(() => this._onDidChangeReadonly.fire()));\n\t\t\t}\n\t\t\tthis._workingCopyListeners.add(this._workingCopy.onDidChangeDirty(() => this._onDidChangeDirty.fire(), undefined));\n\n\t\t\tthis._workingCopyListeners.add(this._workingCopy.onWillDispose(() => {\n\t\t\t\tthis._workingCopyListeners.clear();\n\t\t\t\tthis._workingCopy?.model?.dispose();\n\t\t\t}));\n\t\t} else {\n\t\t\tawait this._workingCopyManager.resolve(this.resource, {\n\t\t\t\treload: {\n\t\t\t\t\tasync: !options?.forceReadFromFile,\n\t\t\t\t\tforce: options?.forceReadFromFile\n\t\t\t\t},\n\t\t\t\tlimits: options?.limits\n\t\t\t});\n\t\t}\n\n\t\tassertType(this.isResolved());\n\t\treturn this;\n\t}\n\n\tasync saveAs(target: URI): Promise<IUntypedEditorInput | undefined> {\n\t\tconst newWorkingCopy = await this._workingCopyManager.saveAs(this.resource, target);\n\t\tif (!newWorkingCopy) {\n\t\t\treturn undefined;\n\t\t}\n\t\t// this is a little hacky because we leave the new working copy alone. BUT\n\t\t// the newly created editor input will pick it up and claim ownership of it.\n\t\treturn { resource: newWorkingCopy.resource };\n\t}\n\n\tprivate static _isStoredFileWorkingCopy(candidate?: IStoredFileWorkingCopy<NotebookFileWorkingCopyModel> | IUntitledFileWorkingCopy<NotebookFileWorkingCopyModel>): candidate is IStoredFileWorkingCopy<NotebookFileWorkingCopyModel> {\n\t\tconst isUntitled = candidate && candidate.capabilities & WorkingCopyCapabilities.Untitled;\n\n\t\treturn !isUntitled;\n\t}\n}\n\nexport class NotebookFileWorkingCopyModel extends Disposable implements IStoredFileWorkingCopyModel, IUntitledFileWorkingCopyModel {\n\n\tprivate readonly _onDidChangeContent = this._register(new Emitter<IStoredFileWorkingCopyModelContentChangedEvent & IUntitledFileWorkingCopyModelContentChangedEvent>());\n\treadonly onDidChangeContent = this._onDidChangeContent.event;\n\n\treadonly onWillDispose: Event<void>;\n\n\treadonly configuration: IFileWorkingCopyModelConfiguration | undefined = undefined;\n\tsave: ((options: IWriteFileOptions, token: CancellationToken) => Promise<IFileStatWithMetadata>) | undefined;\n\n\tconstructor(\n\t\tprivate readonly _notebookModel: NotebookTextModel,\n\t\tprivate readonly _notebookService: INotebookService,\n\t\tprivate readonly _configurationService: IConfigurationService,\n\t\tprivate readonly _telemetryService: ITelemetryService,\n\t\tprivate readonly _notebookLogService: INotebookLoggingService,\n\t) {\n\t\tsuper();\n\n\t\tthis.onWillDispose = _notebookModel.onWillDispose.bind(_notebookModel);\n\n\t\tthis._register(_notebookModel.onDidChangeContent(e => {\n\t\t\tfor (const rawEvent of e.rawEvents) {\n\t\t\t\tif (rawEvent.kind === NotebookCellsChangeType.Initialize) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (rawEvent.transient) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tthis._onDidChangeContent.fire({\n\t\t\t\t\tisRedoing: false, //todo@rebornix forward this information from notebook model\n\t\t\t\t\tisUndoing: false,\n\t\t\t\t\tisInitial: false, //_notebookModel.cells.length === 0 // todo@jrieken non transient metadata?\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}));\n\n\t\tconst saveWithReducedCommunication = this._configurationService.getValue(NotebookSetting.remoteSaving);\n\n\t\tif (saveWithReducedCommunication || _notebookModel.uri.scheme === Schemas.vscodeRemote) {\n\t\t\tthis.configuration = {\n\t\t\t\t// Intentionally pick a larger delay for triggering backups to allow auto-save\n\t\t\t\t// to complete first on the optimized save path\n\t\t\t\tbackupDelay: 10000\n\t\t\t};\n\t\t}\n\n\t\t// Override save behavior to avoid transferring the buffer across the wire 3 times\n\t\tif (saveWithReducedCommunication) {\n\t\t\tthis.setSaveDelegate().catch(error => this._notebookLogService.error('WorkingCopyModel', `Failed to set save delegate: ${error}`));\n\t\t}\n\t}\n\n\tprivate async setSaveDelegate() {\n\t\t// make sure we wait for a serializer to resolve before we try to handle saves in the EH\n\t\tawait this.getNotebookSerializer();\n\n\t\tthis.save = async (options: IWriteFileOptions, token: CancellationToken) => {\n\t\t\ttry {\n\t\t\t\tlet serializer = this._notebookService.tryGetDataProviderSync(this.notebookModel.viewType)?.serializer;\n\n\t\t\t\tif (!serializer) {\n\t\t\t\t\tthis._notebookLogService.info('WorkingCopyModel', 'No serializer found for notebook model, checking if provider still needs to be resolved');\n\t\t\t\t\tserializer = await this.getNotebookSerializer().catch(error => {\n\t\t\t\t\t\tthis._notebookLogService.error('WorkingCopyModel', `Failed to get notebook serializer: ${error}`);\n\t\t\t\t\t\t// The serializer was set initially but somehow is no longer available\n\t\t\t\t\t\tthis.save = undefined;\n\t\t\t\t\t\tthrow new NotebookSaveError('Failed to get notebook serializer');\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\tthrow new CancellationError();\n\t\t\t\t}\n\n\t\t\t\tconst stat = await serializer.save(this._notebookModel.uri, this._notebookModel.versionId, options, token);\n\t\t\t\treturn stat;\n\t\t\t} catch (error) {\n\t\t\t\tif (!token.isCancellationRequested && error.name !== 'Canceled') {\n\t\t\t\t\ttype notebookSaveErrorData = {\n\t\t\t\t\t\tisRemote: boolean;\n\t\t\t\t\t\tisIPyNbWorkerSerializer: boolean;\n\t\t\t\t\t\terror: string;\n\t\t\t\t\t};\n\t\t\t\t\ttype notebookSaveErrorClassification = {\n\t\t\t\t\t\towner: 'amunger';\n\t\t\t\t\t\tcomment: 'Detect if we are having issues saving a notebook on the Extension Host';\n\t\t\t\t\t\tisRemote: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Whether the save is happening on a remote file system' };\n\t\t\t\t\t\tisIPyNbWorkerSerializer: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Whether the IPynb files are serialized in workers' };\n\t\t\t\t\t\terror: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Info about the error that occurred' };\n\t\t\t\t\t};\n\t\t\t\t\tconst isIPynb = this._notebookModel.viewType === 'jupyter-notebook' || this._notebookModel.viewType === 'interactive';\n\t\t\t\t\tconst errorMessage = getSaveErrorMessage(error);\n\t\t\t\t\tthis._telemetryService.publicLogError2<notebookSaveErrorData, notebookSaveErrorClassification>('notebook/SaveError', {\n\t\t\t\t\t\tisRemote: this._notebookModel.uri.scheme === Schemas.vscodeRemote,\n\t\t\t\t\t\tisIPyNbWorkerSerializer: isIPynb && this._configurationService.getValue<boolean>('ipynb.experimental.serialization'),\n\t\t\t\t\t\terror: errorMessage\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t};\n\t}\n\n\toverride dispose(): void {\n\t\tthis._notebookModel.dispose();\n\t\tsuper.dispose();\n\t}\n\n\tget notebookModel() {\n\t\treturn this._notebookModel;\n\t}\n\n\tasync snapshot(context: SnapshotContext, token: CancellationToken): Promise<VSBufferReadableStream> {\n\t\treturn this._notebookService.createNotebookTextDocumentSnapshot(this._notebookModel.uri, context, token);\n\t}\n\n\tasync update(stream: VSBufferReadableStream, token: CancellationToken): Promise<void> {\n\t\tconst serializer = await this.getNotebookSerializer();\n\n\t\tconst bytes = await streamToBuffer(stream);\n\t\tconst data = await serializer.dataToNotebook(bytes);\n\n\t\tif (token.isCancellationRequested) {\n\t\t\tthrow new CancellationError();\n\t\t}\n\n\t\tthis._notebookLogService.info('WorkingCopyModel', 'Notebook content updated from file system - ' + this._notebookModel.uri.toString());\n\t\tthis._notebookModel.reset(data.cells, data.metadata, serializer.options);\n\t}\n\n\tasync getNotebookSerializer(): Promise<INotebookSerializer> {\n\t\tconst info = await this._notebookService.withNotebookDataProvider(this.notebookModel.viewType);\n\t\tif (!(info instanceof SimpleNotebookProviderInfo)) {\n\t\t\tconst message = 'CANNOT open notebook with this provider';\n\t\t\tthrow new NotebookSaveError(message);\n\t\t}\n\n\t\treturn info.serializer;\n\t}\n\n\tget versionId() {\n\t\treturn this._notebookModel.alternativeVersionId;\n\t}\n\n\tpushStackElement(): void {\n\t\tthis._notebookModel.pushStackElement();\n\t}\n}\n\nexport class NotebookFileWorkingCopyModelFactory implements IStoredFileWorkingCopyModelFactory<NotebookFileWorkingCopyModel>, IUntitledFileWorkingCopyModelFactory<NotebookFileWorkingCopyModel> {\n\n\tconstructor(\n\t\tprivate readonly _viewType: string,\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@INotebookLoggingService private readonly _notebookLogService: INotebookLoggingService\n\t) { }\n\n\tasync createModel(resource: URI, stream: VSBufferReadableStream, token: CancellationToken): Promise<NotebookFileWorkingCopyModel> {\n\n\t\tconst notebookModel = this._notebookService.getNotebookTextModel(resource) ??\n\t\t\tawait this._notebookService.createNotebookTextModel(this._viewType, resource, stream);\n\n\t\treturn new NotebookFileWorkingCopyModel(notebookModel, this._notebookService, this._configurationService, this._telemetryService, this._notebookLogService);\n\t}\n}\n\n//#endregion\n\nclass NotebookSaveError extends Error {\n\tconstructor(message: string) {\n\t\tsuper(message);\n\t\tthis.name = 'NotebookSaveError';\n\t}\n}\n\nfunction getSaveErrorMessage(error: Error): string {\n\tif (error.name === 'NotebookSaveError') {\n\t\treturn error.message;\n\t} else if (error instanceof FileOperationError) {\n\t\tswitch (error.fileOperationResult) {\n\t\t\tcase FileOperationResult.FILE_IS_DIRECTORY:\n\t\t\t\treturn 'File is a directory';\n\t\t\tcase FileOperationResult.FILE_NOT_FOUND:\n\t\t\t\treturn 'File not found';\n\t\t\tcase FileOperationResult.FILE_NOT_MODIFIED_SINCE:\n\t\t\t\treturn 'File not modified since';\n\t\t\tcase FileOperationResult.FILE_MODIFIED_SINCE:\n\t\t\t\treturn 'File modified since';\n\t\t\tcase FileOperationResult.FILE_MOVE_CONFLICT:\n\t\t\t\treturn 'File move conflict';\n\t\t\tcase FileOperationResult.FILE_WRITE_LOCKED:\n\t\t\t\treturn 'File write locked';\n\t\t\tcase FileOperationResult.FILE_PERMISSION_DENIED:\n\t\t\t\treturn 'File permission denied';\n\t\t\tcase FileOperationResult.FILE_TOO_LARGE:\n\t\t\t\treturn 'File too large';\n\t\t\tcase FileOperationResult.FILE_INVALID_PATH:\n\t\t\t\treturn 'File invalid path';\n\t\t\tcase FileOperationResult.FILE_NOT_DIRECTORY:\n\t\t\t\treturn 'File not directory';\n\t\t\tcase FileOperationResult.FILE_OTHER_ERROR:\n\t\t\t\treturn 'File other error';\n\t\t}\n\t}\n\treturn 'Unknown error';\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBufferReadableStream, streamToBuffer } from '../../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { CancellationError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { IMarkdownString } from '../../../../base/common/htmlContent.js';\nimport { Disposable, DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { assertType, hasKey } from '../../../../base/common/types.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IWriteFileOptions, IFileStatWithMetadata, FileOperationError, FileOperationResult } from '../../../../platform/files/common/files.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IRevertOptions, ISaveOptions, IUntypedEditorInput } from '../../../common/editor.js';\nimport { EditorModel } from '../../../common/editor/editorModel.js';\nimport { NotebookTextModel } from './model/notebookTextModel.js';\nimport { INotebookEditorModel, INotebookLoadOptions, IResolvedNotebookEditorModel, NotebookCellsChangeType, NotebookSetting } from './notebookCommon.js';\nimport { INotebookLoggingService } from './notebookLoggingService.js';\nimport { INotebookSerializer, INotebookService, SimpleNotebookProviderInfo } from './notebookService.js';\nimport { IFilesConfigurationService } from '../../../services/filesConfiguration/common/filesConfigurationService.js';\nimport { IFileWorkingCopyModelConfiguration, SnapshotContext } from '../../../services/workingCopy/common/fileWorkingCopy.js';\nimport { IFileWorkingCopyManager } from '../../../services/workingCopy/common/fileWorkingCopyManager.js';\nimport { IStoredFileWorkingCopy, IStoredFileWorkingCopyModel, IStoredFileWorkingCopyModelContentChangedEvent, IStoredFileWorkingCopyModelFactory, IStoredFileWorkingCopySaveEvent, StoredFileWorkingCopyState } from '../../../services/workingCopy/common/storedFileWorkingCopy.js';\nimport { IUntitledFileWorkingCopy, IUntitledFileWorkingCopyModel, IUntitledFileWorkingCopyModelContentChangedEvent, IUntitledFileWorkingCopyModelFactory } from '../../../services/workingCopy/common/untitledFileWorkingCopy.js';\nimport { WorkingCopyCapabilities } from '../../../services/workingCopy/common/workingCopy.js';\n\n//#region --- simple content provider\n\nexport class SimpleNotebookEditorModel extends EditorModel implements INotebookEditorModel {\n\n\tprivate readonly _onDidChangeDirty = this._register(new Emitter<void>());\n\tprivate readonly _onDidSave = this._register(new Emitter<IStoredFileWorkingCopySaveEvent>());\n\tprivate readonly _onDidChangeOrphaned = this._register(new Emitter<void>());\n\tprivate readonly _onDidChangeReadonly = this._register(new Emitter<void>());\n\tprivate readonly _onDidRevertUntitled = this._register(new Emitter<void>());\n\n\treadonly onDidChangeDirty: Event<void> = this._onDidChangeDirty.event;\n\treadonly onDidSave: Event<IStoredFileWorkingCopySaveEvent> = this._onDidSave.event;\n\treadonly onDidChangeOrphaned: Event<void> = this._onDidChangeOrphaned.event;\n\treadonly onDidChangeReadonly: Event<void> = this._onDidChangeReadonly.event;\n\treadonly onDidRevertUntitled: Event<void> = this._onDidRevertUntitled.event;\n\n\tprivate _workingCopy?: IStoredFileWorkingCopy<NotebookFileWorkingCopyModel> | IUntitledFileWorkingCopy<NotebookFileWorkingCopyModel>;\n\tprivate readonly _workingCopyListeners = this._register(new DisposableStore());\n\tprivate readonly scratchPad: boolean;\n\n\tconstructor(\n\t\treadonly resource: URI,\n\t\tprivate readonly _hasAssociatedFilePath: boolean,\n\t\treadonly viewType: string,\n\t\tprivate readonly _workingCopyManager: IFileWorkingCopyManager<NotebookFileWorkingCopyModel, NotebookFileWorkingCopyModel>,\n\t\tscratchpad: boolean,\n\t\t@IFilesConfigurationService private readonly _filesConfigurationService: IFilesConfigurationService,\n\t) {\n\t\tsuper();\n\n\t\tthis.scratchPad = scratchpad;\n\t}\n\n\toverride dispose(): void {\n\t\tthis._workingCopy?.dispose();\n\t\tsuper.dispose();\n\t}\n\n\tget notebook(): NotebookTextModel | undefined {\n\t\treturn this._workingCopy?.model?.notebookModel;\n\t}\n\n\toverride isResolved(): this is IResolvedNotebookEditorModel {\n\t\treturn Boolean(this._workingCopy?.model?.notebookModel);\n\t}\n\n\tasync canDispose(): Promise<boolean> {\n\t\tif (!this._workingCopy) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (SimpleNotebookEditorModel._isStoredFileWorkingCopy(this._workingCopy)) {\n\t\t\treturn this._workingCopyManager.stored.canDispose(this._workingCopy);\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tisDirty(): boolean {\n\t\treturn this._workingCopy?.isDirty() ?? false;\n\t}\n\n\tisModified(): boolean {\n\t\treturn this._workingCopy?.isModified() ?? false;\n\t}\n\n\tisOrphaned(): boolean {\n\t\treturn SimpleNotebookEditorModel._isStoredFileWorkingCopy(this._workingCopy) && this._workingCopy.hasState(StoredFileWorkingCopyState.ORPHAN);\n\t}\n\n\thasAssociatedFilePath(): boolean {\n\t\treturn !SimpleNotebookEditorModel._isStoredFileWorkingCopy(this._workingCopy) && !!this._workingCopy?.hasAssociatedFilePath;\n\t}\n\n\tisReadonly(): boolean | IMarkdownString {\n\t\tif (SimpleNotebookEditorModel._isStoredFileWorkingCopy(this._workingCopy)) {\n\t\t\treturn this._workingCopy?.isReadonly();\n\t\t} else {\n\t\t\treturn this._filesConfigurationService.isReadonly(this.resource);\n\t\t}\n\t}\n\n\tget hasErrorState(): boolean {\n\t\tif (this._workingCopy && hasKey(this._workingCopy, { hasState: true })) {\n\t\t\treturn this._workingCopy.hasState(StoredFileWorkingCopyState.ERROR);\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tasync revert(options?: IRevertOptions): Promise<void> {\n\t\tassertType(this.isResolved());\n\t\treturn this._workingCopy!.revert(options);\n\t}\n\n\tasync save(options?: ISaveOptions): Promise<boolean> {\n\t\tassertType(this.isResolved());\n\t\treturn this._workingCopy!.save(options);\n\t}\n\n\tasync load(options?: INotebookLoadOptions): Promise<IResolvedNotebookEditorModel> {\n\t\tif (!this._workingCopy || !this._workingCopy.model) {\n\t\t\tif (this.resource.scheme === Schemas.untitled) {\n\t\t\t\tif (this._hasAssociatedFilePath) {\n\t\t\t\t\tthis._workingCopy = await this._workingCopyManager.resolve({ associatedResource: this.resource });\n\t\t\t\t} else {\n\t\t\t\t\tthis._workingCopy = await this._workingCopyManager.resolve({ untitledResource: this.resource, isScratchpad: this.scratchPad });\n\t\t\t\t}\n\t\t\t\tthis._register(this._workingCopy.onDidRevert(() => this._onDidRevertUntitled.fire()));\n\t\t\t} else {\n\t\t\t\tthis._workingCopy = await this._workingCopyManager.resolve(this.resource, {\n\t\t\t\t\tlimits: options?.limits,\n\t\t\t\t\treload: options?.forceReadFromFile ? { async: false, force: true } : undefined\n\t\t\t\t});\n\t\t\t\tthis._workingCopyListeners.add(this._workingCopy.onDidSave(e => this._onDidSave.fire(e)));\n\t\t\t\tthis._workingCopyListeners.add(this._workingCopy.onDidChangeOrphaned(() => this._onDidChangeOrphaned.fire()));\n\t\t\t\tthis._workingCopyListeners.add(this._workingCopy.onDidChangeReadonly(() => this._onDidChangeReadonly.fire()));\n\t\t\t}\n\t\t\tthis._workingCopyListeners.add(this._workingCopy.onDidChangeDirty(() => this._onDidChangeDirty.fire(), undefined));\n\n\t\t\tthis._workingCopyListeners.add(this._workingCopy.onWillDispose(() => {\n\t\t\t\tthis._workingCopyListeners.clear();\n\t\t\t\tthis._workingCopy?.model?.dispose();\n\t\t\t}));\n\t\t} else {\n\t\t\tawait this._workingCopyManager.resolve(this.resource, {\n\t\t\t\treload: {\n\t\t\t\t\tasync: !options?.forceReadFromFile,\n\t\t\t\t\tforce: options?.forceReadFromFile\n\t\t\t\t},\n\t\t\t\tlimits: options?.limits\n\t\t\t});\n\t\t}\n\n\t\tassertType(this.isResolved());\n\t\treturn this;\n\t}\n\n\tasync saveAs(target: URI): Promise<IUntypedEditorInput | undefined> {\n\t\tconst newWorkingCopy = await this._workingCopyManager.saveAs(this.resource, target);\n\t\tif (!newWorkingCopy) {\n\t\t\treturn undefined;\n\t\t}\n\t\t// this is a little hacky because we leave the new working copy alone. BUT\n\t\t// the newly created editor input will pick it up and claim ownership of it.\n\t\treturn { resource: newWorkingCopy.resource };\n\t}\n\n\tprivate static _isStoredFileWorkingCopy(candidate?: IStoredFileWorkingCopy<NotebookFileWorkingCopyModel> | IUntitledFileWorkingCopy<NotebookFileWorkingCopyModel>): candidate is IStoredFileWorkingCopy<NotebookFileWorkingCopyModel> {\n\t\tconst isUntitled = candidate && candidate.capabilities & WorkingCopyCapabilities.Untitled;\n\n\t\treturn !isUntitled;\n\t}\n}\n\nexport class NotebookFileWorkingCopyModel extends Disposable implements IStoredFileWorkingCopyModel, IUntitledFileWorkingCopyModel {\n\n\tprivate readonly _onDidChangeContent = this._register(new Emitter<IStoredFileWorkingCopyModelContentChangedEvent & IUntitledFileWorkingCopyModelContentChangedEvent>());\n\treadonly onDidChangeContent = this._onDidChangeContent.event;\n\n\treadonly onWillDispose: Event<void>;\n\n\treadonly configuration: IFileWorkingCopyModelConfiguration | undefined = undefined;\n\tsave: ((options: IWriteFileOptions, token: CancellationToken) => Promise<IFileStatWithMetadata>) | undefined;\n\n\tconstructor(\n\t\tprivate readonly _notebookModel: NotebookTextModel,\n\t\tprivate readonly _notebookService: INotebookService,\n\t\tprivate readonly _configurationService: IConfigurationService,\n\t\tprivate readonly _telemetryService: ITelemetryService,\n\t\tprivate readonly _notebookLogService: INotebookLoggingService,\n\t) {\n\t\tsuper();\n\n\t\tthis.onWillDispose = _notebookModel.onWillDispose.bind(_notebookModel);\n\n\t\tthis._register(_notebookModel.onDidChangeContent(e => {\n\t\t\tfor (const rawEvent of e.rawEvents) {\n\t\t\t\tif (rawEvent.kind === NotebookCellsChangeType.Initialize) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (rawEvent.transient) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tthis._onDidChangeContent.fire({\n\t\t\t\t\tisRedoing: false, //todo@rebornix forward this information from notebook model\n\t\t\t\t\tisUndoing: false,\n\t\t\t\t\tisInitial: false, //_notebookModel.cells.length === 0 // todo@jrieken non transient metadata?\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}));\n\n\t\tconst saveWithReducedCommunication = this._configurationService.getValue(NotebookSetting.remoteSaving);\n\n\t\tif (saveWithReducedCommunication || _notebookModel.uri.scheme === Schemas.vscodeRemote) {\n\t\t\tthis.configuration = {\n\t\t\t\t// Intentionally pick a larger delay for triggering backups to allow auto-save\n\t\t\t\t// to complete first on the optimized save path\n\t\t\t\tbackupDelay: 10000\n\t\t\t};\n\t\t}\n\n\t\t// Override save behavior to avoid transferring the buffer across the wire 3 times\n\t\tif (saveWithReducedCommunication) {\n\t\t\tthis.setSaveDelegate().catch(error => this._notebookLogService.error('WorkingCopyModel', `Failed to set save delegate: ${error}`));\n\t\t}\n\t}\n\n\tprivate async setSaveDelegate() {\n\t\t// make sure we wait for a serializer to resolve before we try to handle saves in the EH\n\t\tawait this.getNotebookSerializer();\n\n\t\tthis.save = async (options: IWriteFileOptions, token: CancellationToken) => {\n\t\t\ttry {\n\t\t\t\tlet serializer = this._notebookService.tryGetDataProviderSync(this.notebookModel.viewType)?.serializer;\n\n\t\t\t\tif (!serializer) {\n\t\t\t\t\tthis._notebookLogService.info('WorkingCopyModel', 'No serializer found for notebook model, checking if provider still needs to be resolved');\n\t\t\t\t\tserializer = await this.getNotebookSerializer().catch(error => {\n\t\t\t\t\t\tthis._notebookLogService.error('WorkingCopyModel', `Failed to get notebook serializer: ${error}`);\n\t\t\t\t\t\t// The serializer was set initially but somehow is no longer available\n\t\t\t\t\t\tthis.save = undefined;\n\t\t\t\t\t\tthrow new NotebookSaveError('Failed to get notebook serializer');\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\tthrow new CancellationError();\n\t\t\t\t}\n\n\t\t\t\tconst stat = await serializer.save(this._notebookModel.uri, this._notebookModel.versionId, options, token);\n\t\t\t\treturn stat;\n\t\t\t} catch (error) {\n\t\t\t\tif (!token.isCancellationRequested && error.name !== 'Canceled') {\n\t\t\t\t\ttype notebookSaveErrorData = {\n\t\t\t\t\t\tisRemote: boolean;\n\t\t\t\t\t\tisIPyNbWorkerSerializer: boolean;\n\t\t\t\t\t\terror: string;\n\t\t\t\t\t};\n\t\t\t\t\ttype notebookSaveErrorClassification = {\n\t\t\t\t\t\towner: 'amunger';\n\t\t\t\t\t\tcomment: 'Detect if we are having issues saving a notebook on the Extension Host';\n\t\t\t\t\t\tisRemote: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Whether the save is happening on a remote file system' };\n\t\t\t\t\t\tisIPyNbWorkerSerializer: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Whether the IPynb files are serialized in workers' };\n\t\t\t\t\t\terror: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Info about the error that occurred' };\n\t\t\t\t\t};\n\t\t\t\t\tconst isIPynb = this._notebookModel.viewType === 'jupyter-notebook' || this._notebookModel.viewType === 'interactive';\n\t\t\t\t\tconst errorMessage = getSaveErrorMessage(error);\n\t\t\t\t\tthis._telemetryService.publicLogError2<notebookSaveErrorData, notebookSaveErrorClassification>('notebook/SaveError', {\n\t\t\t\t\t\tisRemote: this._notebookModel.uri.scheme === Schemas.vscodeRemote,\n\t\t\t\t\t\tisIPyNbWorkerSerializer: isIPynb && this._configurationService.getValue<boolean>('ipynb.experimental.serialization'),\n\t\t\t\t\t\terror: errorMessage\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t};\n\t}\n\n\toverride dispose(): void {\n\t\tthis._notebookModel.dispose();\n\t\tsuper.dispose();\n\t}\n\n\tget notebookModel() {\n\t\treturn this._notebookModel;\n\t}\n\n\tasync snapshot(context: SnapshotContext, token: CancellationToken): Promise<VSBufferReadableStream> {\n\t\treturn this._notebookService.createNotebookTextDocumentSnapshot(this._notebookModel.uri, context, token);\n\t}\n\n\tasync update(stream: VSBufferReadableStream, token: CancellationToken): Promise<void> {\n\t\tconst serializer = await this.getNotebookSerializer();\n\n\t\tconst bytes = await streamToBuffer(stream);\n\t\tconst data = await serializer.dataToNotebook(bytes);\n\n\t\tif (token.isCancellationRequested) {\n\t\t\tthrow new CancellationError();\n\t\t}\n\n\t\tthis._notebookLogService.info('WorkingCopyModel', 'Notebook content updated from file system - ' + this._notebookModel.uri.toString());\n\t\tthis._notebookModel.reset(data.cells, data.metadata, serializer.options);\n\t}\n\n\tasync getNotebookSerializer(): Promise<INotebookSerializer> {\n\t\tconst info = await this._notebookService.withNotebookDataProvider(this.notebookModel.viewType);\n\t\tif (!(info instanceof SimpleNotebookProviderInfo)) {\n\t\t\tconst message = 'CANNOT open notebook with this provider';\n\t\t\tthrow new NotebookSaveError(message);\n\t\t}\n\n\t\treturn info.serializer;\n\t}\n\n\tget versionId() {\n\t\treturn this._notebookModel.alternativeVersionId;\n\t}\n\n\tpushStackElement(): void {\n\t\tthis._notebookModel.pushStackElement();\n\t}\n}\n\nexport class NotebookFileWorkingCopyModelFactory implements IStoredFileWorkingCopyModelFactory<NotebookFileWorkingCopyModel>, IUntitledFileWorkingCopyModelFactory<NotebookFileWorkingCopyModel> {\n\n\tconstructor(\n\t\tprivate readonly _viewType: string,\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@INotebookLoggingService private readonly _notebookLogService: INotebookLoggingService\n\t) { }\n\n\tasync createModel(resource: URI, stream: VSBufferReadableStream, token: CancellationToken): Promise<NotebookFileWorkingCopyModel> {\n\n\t\tconst notebookModel = this._notebookService.getNotebookTextModel(resource) ??\n\t\t\tawait this._notebookService.createNotebookTextModel(this._viewType, resource, stream);\n\n\t\treturn new NotebookFileWorkingCopyModel(notebookModel, this._notebookService, this._configurationService, this._telemetryService, this._notebookLogService);\n\t}\n}\n\n//#endregion\n\nclass NotebookSaveError extends Error {\n\tconstructor(message: string) {\n\t\tsuper(message);\n\t\tthis.name = 'NotebookSaveError';\n\t}\n}\n\nfunction getSaveErrorMessage(error: Error): string {\n\tif (error.name === 'NotebookSaveError') {\n\t\treturn error.message;\n\t} else if (error instanceof FileOperationError) {\n\t\tswitch (error.fileOperationResult) {\n\t\t\tcase FileOperationResult.FILE_IS_DIRECTORY:\n\t\t\t\treturn 'File is a directory';\n\t\t\tcase FileOperationResult.FILE_NOT_FOUND:\n\t\t\t\treturn 'File not found';\n\t\t\tcase FileOperationResult.FILE_NOT_MODIFIED_SINCE:\n\t\t\t\treturn 'File not modified since';\n\t\t\tcase FileOperationResult.FILE_MODIFIED_SINCE:\n\t\t\t\treturn 'File modified since';\n\t\t\tcase FileOperationResult.FILE_MOVE_CONFLICT:\n\t\t\t\treturn 'File move conflict';\n\t\t\tcase FileOperationResult.FILE_WRITE_LOCKED:\n\t\t\t\treturn 'File write locked';\n\t\t\tcase FileOperationResult.FILE_PERMISSION_DENIED:\n\t\t\t\treturn 'File permission denied';\n\t\t\tcase FileOperationResult.FILE_TOO_LARGE:\n\t\t\t\treturn 'File too large';\n\t\t\tcase FileOperationResult.FILE_INVALID_PATH:\n\t\t\t\treturn 'File invalid path';\n\t\t\tcase FileOperationResult.FILE_NOT_DIRECTORY:\n\t\t\t\treturn 'File not directory';\n\t\t\tcase FileOperationResult.FILE_OTHER_ERROR:\n\t\t\t\treturn 'File other error';\n\t\t}\n\t}\n\treturn 'Unknown error';\n}\n"]}