{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/common/model/notebookCellTextModel.ts","vs/workbench/contrib/notebook/common/model/notebookCellTextModel.ts"],"names":[],"mappings":"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","file":"notebookCellTextModel.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { hash, StringSHA1 } from '../../../../../base/common/hash.js';\nimport { Disposable, DisposableStore, dispose } from '../../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport * as UUID from '../../../../../base/common/uuid.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport * as model from '../../../../../editor/common/model.js';\nimport { PieceTreeTextBuffer } from '../../../../../editor/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.js';\nimport { createTextBuffer, TextModel } from '../../../../../editor/common/model/textModel.js';\nimport { PLAINTEXT_LANGUAGE_ID } from '../../../../../editor/common/languages/modesRegistry.js';\nimport { ILanguageService } from '../../../../../editor/common/languages/language.js';\nimport { NotebookCellOutputTextModel } from './notebookCellOutputTextModel.js';\nimport { CellInternalMetadataChangedEvent, CellKind, ICell, ICellDto2, ICellOutput, IOutputItemDto, NotebookCellCollapseState, NotebookCellDefaultCollapseConfig, NotebookCellInternalMetadata, NotebookCellMetadata, NotebookCellOutputsSplice, TransientCellMetadata, TransientOptions } from '../notebookCommon.js';\nimport { ThrottledDelayer } from '../../../../../base/common/async.js';\nimport { ILanguageDetectionService } from '../../../../services/languageDetection/common/languageDetectionWorkerService.js';\nimport { toFormattedString } from '../../../../../base/common/jsonFormatter.js';\nimport { IModelContentChangedEvent } from '../../../../../editor/common/textModelEvents.js';\nimport { splitLines } from '../../../../../base/common/strings.js';\nimport { INotebookLoggingService } from '../notebookLoggingService.js';\n\nexport class NotebookCellTextModel extends Disposable implements ICell {\n\tprivate readonly _onDidChangeTextModel = this._register(new Emitter<void>());\n\treadonly onDidChangeTextModel: Event<void> = this._onDidChangeTextModel.event;\n\tprivate readonly _onDidChangeOutputs = this._register(new Emitter<NotebookCellOutputsSplice>());\n\treadonly onDidChangeOutputs: Event<NotebookCellOutputsSplice> = this._onDidChangeOutputs.event;\n\n\tprivate readonly _onDidChangeOutputItems = this._register(new Emitter<void>());\n\treadonly onDidChangeOutputItems: Event<void> = this._onDidChangeOutputItems.event;\n\n\tprivate readonly _onDidChangeContent = this._register(new Emitter<'content' | 'language' | 'mime' | { type: 'model'; event: IModelContentChangedEvent }>());\n\treadonly onDidChangeContent: Event<'content' | 'language' | 'mime' | { type: 'model'; event: IModelContentChangedEvent }> = this._onDidChangeContent.event;\n\n\tprivate readonly _onDidChangeMetadata = this._register(new Emitter<void>());\n\treadonly onDidChangeMetadata: Event<void> = this._onDidChangeMetadata.event;\n\n\tprivate readonly _onDidChangeInternalMetadata = this._register(new Emitter<CellInternalMetadataChangedEvent>());\n\treadonly onDidChangeInternalMetadata: Event<CellInternalMetadataChangedEvent> = this._onDidChangeInternalMetadata.event;\n\n\tprivate readonly _onDidChangeLanguage = this._register(new Emitter<string>());\n\treadonly onDidChangeLanguage: Event<string> = this._onDidChangeLanguage.event;\n\n\tprivate _outputs: NotebookCellOutputTextModel[];\n\n\tget outputs(): ICellOutput[] {\n\t\treturn this._outputs;\n\t}\n\n\tprivate _metadata: NotebookCellMetadata;\n\n\tget metadata() {\n\t\treturn this._metadata;\n\t}\n\n\tset metadata(newMetadata: NotebookCellMetadata) {\n\t\tthis._metadata = newMetadata;\n\t\tthis._hash = null;\n\t\tthis._onDidChangeMetadata.fire();\n\t}\n\n\tprivate _internalMetadata: NotebookCellInternalMetadata;\n\n\tget internalMetadata() {\n\t\treturn this._internalMetadata;\n\t}\n\n\tset internalMetadata(newInternalMetadata: NotebookCellInternalMetadata) {\n\t\tconst lastRunSuccessChanged = this._internalMetadata.lastRunSuccess !== newInternalMetadata.lastRunSuccess;\n\t\tnewInternalMetadata = {\n\t\t\t...newInternalMetadata,\n\t\t\t...{ runStartTimeAdjustment: computeRunStartTimeAdjustment(this._internalMetadata, newInternalMetadata) }\n\t\t};\n\t\tthis._internalMetadata = newInternalMetadata;\n\t\tthis._hash = null;\n\t\tthis._onDidChangeInternalMetadata.fire({ lastRunSuccessChanged });\n\t}\n\n\tget language() {\n\t\treturn this._language;\n\t}\n\n\tset language(newLanguage: string) {\n\t\tif (this._textModel\n\t\t\t// 1. the language update is from workspace edit, checking if it's the same as text model's mode\n\t\t\t&& this._textModel.getLanguageId() === this._languageService.getLanguageIdByLanguageName(newLanguage)\n\t\t\t// 2. the text model's mode might be the same as the `this.language`, even if the language friendly name is not the same, we should not trigger an update\n\t\t\t&& this._textModel.getLanguageId() === this._languageService.getLanguageIdByLanguageName(this.language)) {\n\t\t\treturn;\n\t\t}\n\n\n\t\tthis._hasLanguageSetExplicitly = true;\n\t\tthis._setLanguageInternal(newLanguage);\n\t}\n\n\tpublic get mime(): string | undefined {\n\t\treturn this._mime;\n\t}\n\n\tpublic set mime(newMime: string | undefined) {\n\t\tif (this._mime === newMime) {\n\t\t\treturn;\n\t\t}\n\t\tthis._mime = newMime;\n\t\tthis._hash = null;\n\t\tthis._onDidChangeContent.fire('mime');\n\t}\n\n\tprivate _textBuffer!: model.ITextBuffer;\n\n\tget textBuffer() {\n\t\tif (this._textBuffer) {\n\t\t\treturn this._textBuffer;\n\t\t}\n\n\t\tthis._textBuffer = this._register(createTextBuffer(this._source, this._defaultEOL).textBuffer);\n\n\t\tthis._register(this._textBuffer.onDidChangeContent(() => {\n\t\t\tthis._hash = null;\n\t\t\tif (!this._textModel) {\n\t\t\t\tthis._onDidChangeContent.fire('content');\n\t\t\t}\n\t\t\tthis.autoDetectLanguage();\n\t\t}));\n\n\t\treturn this._textBuffer;\n\t}\n\n\tprivate _textBufferHash: string | null = null;\n\tprivate _hash: number | null = null;\n\n\tprivate _versionId: number = 1;\n\tprivate _alternativeId: number = 1;\n\tget alternativeId(): number {\n\t\treturn this._alternativeId;\n\t}\n\n\tprivate readonly _textModelDisposables = this._register(new DisposableStore());\n\tprivate _textModel: TextModel | undefined = undefined;\n\tget textModel(): TextModel | undefined {\n\t\treturn this._textModel;\n\t}\n\n\tset textModel(m: TextModel | undefined) {\n\t\tif (this._textModel === m) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._textModelDisposables.clear();\n\t\tthis._textModel = m;\n\t\tif (this._textModel) {\n\t\t\tthis.setRegisteredLanguage(this._languageService, this._textModel.getLanguageId(), this.language);\n\n\t\t\t// Listen to language changes on the model\n\t\t\tthis._textModelDisposables.add(this._textModel.onDidChangeLanguage((e) => this.setRegisteredLanguage(this._languageService, e.newLanguage, this.language)));\n\t\t\tthis._textModelDisposables.add(this._textModel.onWillDispose(() => this.textModel = undefined));\n\t\t\tthis._textModelDisposables.add(this._textModel.onDidChangeContent((e) => {\n\t\t\t\tif (this._textModel) {\n\t\t\t\t\tthis._versionId = this._textModel.getVersionId();\n\t\t\t\t\tthis._alternativeId = this._textModel.getAlternativeVersionId();\n\t\t\t\t}\n\t\t\t\tthis._textBufferHash = null;\n\t\t\t\tthis._onDidChangeContent.fire('content');\n\t\t\t\tthis._onDidChangeContent.fire({ type: 'model', event: e });\n\t\t\t}));\n\n\t\t\tthis._textModel._overwriteVersionId(this._versionId);\n\t\t\tthis._textModel._overwriteAlternativeVersionId(this._versionId);\n\t\t\tthis._onDidChangeTextModel.fire();\n\t\t}\n\t}\n\n\tprivate setRegisteredLanguage(languageService: ILanguageService, newLanguage: string, currentLanguage: string) {\n\t\t// The language defined in the cell might not be supported in the editor so the text model might be using the default fallback\n\t\t// If so let's not modify the language\n\t\tconst isFallBackLanguage = (newLanguage === PLAINTEXT_LANGUAGE_ID || newLanguage === 'jupyter');\n\t\tif (!languageService.isRegisteredLanguageId(currentLanguage) && isFallBackLanguage) {\n\t\t\t// notify to display warning, but don't change the language\n\t\t\tthis._onDidChangeLanguage.fire(currentLanguage);\n\t\t} else {\n\t\t\tthis.language = newLanguage;\n\t\t}\n\t}\n\tprivate static readonly AUTO_DETECT_LANGUAGE_THROTTLE_DELAY = 600;\n\tprivate readonly autoDetectLanguageThrottler = this._register(new ThrottledDelayer<void>(NotebookCellTextModel.AUTO_DETECT_LANGUAGE_THROTTLE_DELAY));\n\tprivate _autoLanguageDetectionEnabled: boolean = false;\n\tprivate _hasLanguageSetExplicitly: boolean = false;\n\tget hasLanguageSetExplicitly(): boolean { return this._hasLanguageSetExplicitly; }\n\n\tprivate _source: string;\n\tprivate _language: string;\n\tprivate _mime: string | undefined;\n\tpublic readonly cellKind: CellKind;\n\tpublic readonly collapseState: NotebookCellCollapseState | undefined;\n\n\tconstructor(\n\t\treadonly uri: URI,\n\t\tpublic readonly handle: number,\n\t\tcell: ICellDto2,\n\t\tpublic readonly transientOptions: TransientOptions,\n\t\tprivate readonly _languageService: ILanguageService,\n\t\tprivate readonly _defaultEOL: model.DefaultEndOfLine,\n\t\tdefaultCollapseConfig: NotebookCellDefaultCollapseConfig | undefined,\n\t\tprivate readonly _languageDetectionService: ILanguageDetectionService | undefined = undefined,\n\t\tprivate readonly _notebookLoggingService: INotebookLoggingService\n\t) {\n\t\tsuper();\n\t\tthis._source = cell.source;\n\t\tthis._language = cell.language;\n\t\tthis._mime = cell.mime;\n\t\tthis.cellKind = cell.cellKind;\n\t\t// Compute collapse state: use cell's state if provided, otherwise use default config for this cell kind\n\t\tconst defaultConfig = cell.cellKind === CellKind.Code ? defaultCollapseConfig?.codeCell : defaultCollapseConfig?.markupCell;\n\t\tthis.collapseState = cell.collapseState ?? (defaultConfig ?? undefined);\n\t\tthis._outputs = cell.outputs.map(op => new NotebookCellOutputTextModel(op));\n\t\tthis._metadata = cell.metadata ?? {};\n\t\tthis._internalMetadata = cell.internalMetadata ?? {};\n\t}\n\n\tenableAutoLanguageDetection() {\n\t\tthis._autoLanguageDetectionEnabled = true;\n\t\tthis.autoDetectLanguage();\n\t}\n\n\tasync autoDetectLanguage(): Promise<void> {\n\t\tif (this._autoLanguageDetectionEnabled) {\n\t\t\tthis.autoDetectLanguageThrottler.trigger(() => this._doAutoDetectLanguage());\n\t\t}\n\t}\n\n\tprivate async _doAutoDetectLanguage(): Promise<void> {\n\t\tif (this.hasLanguageSetExplicitly) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst newLanguage = await this._languageDetectionService?.detectLanguage(this.uri);\n\t\tif (!newLanguage) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._textModel\n\t\t\t&& this._textModel.getLanguageId() === this._languageService.getLanguageIdByLanguageName(newLanguage)\n\t\t\t&& this._textModel.getLanguageId() === this._languageService.getLanguageIdByLanguageName(this.language)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._setLanguageInternal(newLanguage);\n\t}\n\n\tprivate _setLanguageInternal(newLanguage: string) {\n\t\tconst newLanguageId = this._languageService.getLanguageIdByLanguageName(newLanguage);\n\n\t\tif (newLanguageId === null) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._textModel) {\n\t\t\tconst languageId = this._languageService.createById(newLanguageId);\n\t\t\tthis._textModel.setLanguage(languageId.languageId);\n\t\t}\n\n\t\tif (this._language === newLanguage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._language = newLanguage;\n\t\tthis._hash = null;\n\t\tthis._onDidChangeLanguage.fire(newLanguage);\n\t\tthis._onDidChangeContent.fire('language');\n\t}\n\n\tresetTextBuffer(textBuffer: model.ITextBuffer) {\n\t\tthis._textBuffer = textBuffer;\n\t}\n\n\tgetValue(): string {\n\t\tconst fullRange = this.getFullModelRange();\n\t\tconst eol = this.textBuffer.getEOL();\n\t\tif (eol === '\\n') {\n\t\t\treturn this.textBuffer.getValueInRange(fullRange, model.EndOfLinePreference.LF);\n\t\t} else {\n\t\t\treturn this.textBuffer.getValueInRange(fullRange, model.EndOfLinePreference.CRLF);\n\t\t}\n\t}\n\n\tgetTextBufferHash() {\n\t\tif (this._textBufferHash !== null) {\n\t\t\treturn this._textBufferHash;\n\t\t}\n\n\t\tconst shaComputer = new StringSHA1();\n\t\tconst snapshot = this.textBuffer.createSnapshot(false);\n\t\tlet text: string | null;\n\t\twhile ((text = snapshot.read())) {\n\t\t\tshaComputer.update(text);\n\t\t}\n\t\tthis._textBufferHash = shaComputer.digest();\n\t\treturn this._textBufferHash;\n\t}\n\n\tgetHashValue(): number {\n\t\tif (this._hash !== null) {\n\t\t\treturn this._hash;\n\t\t}\n\n\t\tthis._hash = hash([hash(this.language), this.getTextBufferHash(), this._getPersisentMetadata(), this.transientOptions.transientOutputs ? [] : this._outputs.map(op => ({\n\t\t\toutputs: op.outputs.map(output => ({\n\t\t\t\tmime: output.mime,\n\t\t\t\tdata: Array.from(output.data.buffer)\n\t\t\t})),\n\t\t\tmetadata: op.metadata\n\t\t}))]);\n\t\treturn this._hash;\n\t}\n\n\tprivate _getPersisentMetadata() {\n\t\treturn getFormattedMetadataJSON(this.transientOptions.transientCellMetadata, this.metadata, this.language);\n\t}\n\n\tgetTextLength(): number {\n\t\treturn this.textBuffer.getLength();\n\t}\n\n\tgetFullModelRange() {\n\t\tconst lineCount = this.textBuffer.getLineCount();\n\t\treturn new Range(1, 1, lineCount, this.textBuffer.getLineLength(lineCount) + 1);\n\t}\n\n\tspliceNotebookCellOutputs(splice: NotebookCellOutputsSplice): void {\n\t\tthis._notebookLoggingService.trace('textModelEdits', `splicing outputs at ${splice.start} length: ${splice.deleteCount} with ${splice.newOutputs.length} new outputs`);\n\t\tif (splice.deleteCount > 0 && splice.newOutputs.length > 0) {\n\t\t\tconst commonLen = Math.min(splice.deleteCount, splice.newOutputs.length);\n\t\t\t// update\n\t\t\tfor (let i = 0; i < commonLen; i++) {\n\t\t\t\tconst currentOutput = this.outputs[splice.start + i];\n\t\t\t\tconst newOutput = splice.newOutputs[i];\n\n\t\t\t\tthis.replaceOutput(currentOutput.outputId, newOutput);\n\t\t\t}\n\n\t\t\tconst removed = this.outputs.splice(splice.start + commonLen, splice.deleteCount - commonLen, ...splice.newOutputs.slice(commonLen));\n\t\t\tremoved.forEach(output => output.dispose());\n\t\t\tthis._onDidChangeOutputs.fire({ start: splice.start + commonLen, deleteCount: splice.deleteCount - commonLen, newOutputs: splice.newOutputs.slice(commonLen) });\n\t\t} else {\n\t\t\tconst removed = this.outputs.splice(splice.start, splice.deleteCount, ...splice.newOutputs);\n\t\t\tremoved.forEach(output => output.dispose());\n\t\t\tthis._onDidChangeOutputs.fire(splice);\n\t\t}\n\t}\n\n\treplaceOutput(outputId: string, newOutputItem: ICellOutput) {\n\t\tconst outputIndex = this.outputs.findIndex(output => output.outputId === outputId);\n\n\t\tif (outputIndex < 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._notebookLoggingService.trace('textModelEdits', `replacing an output item at index ${outputIndex}`);\n\t\tconst output = this.outputs[outputIndex];\n\t\t// convert to dto and dispose the cell output model\n\t\toutput.replaceData({\n\t\t\toutputs: newOutputItem.outputs,\n\t\t\toutputId: newOutputItem.outputId,\n\t\t\tmetadata: newOutputItem.metadata\n\t\t});\n\t\tnewOutputItem.dispose();\n\t\tthis._onDidChangeOutputItems.fire();\n\t\treturn true;\n\t}\n\n\tchangeOutputItems(outputId: string, append: boolean, items: IOutputItemDto[]): boolean {\n\t\tconst outputIndex = this.outputs.findIndex(output => output.outputId === outputId);\n\n\t\tif (outputIndex < 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst output = this.outputs[outputIndex];\n\t\tthis._notebookLoggingService.trace('textModelEdits', `${append ? 'appending' : 'replacing'} ${items.length} output items to for output index ${outputIndex}`);\n\t\tif (append) {\n\t\t\toutput.appendData(items);\n\t\t} else {\n\t\t\toutput.replaceData({ outputId: outputId, outputs: items, metadata: output.metadata });\n\t\t}\n\t\tthis._onDidChangeOutputItems.fire();\n\t\treturn true;\n\t}\n\n\tprivate _outputNotEqualFastCheck(left: ICellOutput[], right: ICellOutput[]) {\n\t\tif (left.length !== right.length) {\n\t\t\treturn false;\n\t\t}\n\n\t\tfor (let i = 0; i < this.outputs.length; i++) {\n\t\t\tconst l = left[i];\n\t\t\tconst r = right[i];\n\n\t\t\tif (l.outputs.length !== r.outputs.length) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tfor (let k = 0; k < l.outputs.length; k++) {\n\t\t\t\tif (l.outputs[k].mime !== r.outputs[k].mime) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (l.outputs[k].data.byteLength !== r.outputs[k].data.byteLength) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tequal(b: NotebookCellTextModel): boolean {\n\t\tif (this.language !== b.language) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.outputs.length !== b.outputs.length) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.getTextLength() !== b.getTextLength()) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this.transientOptions.transientOutputs) {\n\t\t\t// compare outputs\n\n\t\t\tif (!this._outputNotEqualFastCheck(this.outputs, b.outputs)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn this.getHashValue() === b.getHashValue();\n\t}\n\n\t/**\n\t * Only compares\n\t * - language\n\t * - mime\n\t * - cellKind\n\t * - internal metadata (conditionally)\n\t * - source\n\t */\n\tfastEqual(b: ICellDto2, ignoreMetadata: boolean): boolean {\n\t\tif (this.language !== b.language) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mime !== b.mime) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.cellKind !== b.cellKind) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!ignoreMetadata) {\n\t\t\tif (this.internalMetadata?.executionOrder !== b.internalMetadata?.executionOrder\n\t\t\t\t|| this.internalMetadata?.lastRunSuccess !== b.internalMetadata?.lastRunSuccess\n\t\t\t\t|| this.internalMetadata?.runStartTime !== b.internalMetadata?.runStartTime\n\t\t\t\t|| this.internalMetadata?.runStartTimeAdjustment !== b.internalMetadata?.runStartTimeAdjustment\n\t\t\t\t|| this.internalMetadata?.runEndTime !== b.internalMetadata?.runEndTime) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t// Once we attach the cell text buffer to an editor, the source of truth is the text buffer instead of the original source\n\t\tif (this._textBuffer) {\n\t\t\tif (!NotebookCellTextModel.linesAreEqual(this.textBuffer.getLinesContent(), b.source)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else if (this._source !== b.source) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprivate static linesAreEqual(aLines: string[], b: string) {\n\t\tconst bLines = splitLines(b);\n\t\tif (aLines.length !== bLines.length) {\n\t\t\treturn false;\n\t\t}\n\t\tfor (let i = 0; i < aLines.length; i++) {\n\t\t\tif (aLines[i] !== bLines[i]) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\toverride dispose() {\n\t\tdispose(this._outputs);\n\t\t// Manually release reference to previous text buffer to avoid large leaks\n\t\t// in case someone leaks a CellTextModel reference\n\t\tconst emptyDisposedTextBuffer = new PieceTreeTextBuffer([], '', '\\n', false, false, true, true);\n\t\temptyDisposedTextBuffer.dispose();\n\t\tthis._textBuffer = emptyDisposedTextBuffer;\n\t\tsuper.dispose();\n\t}\n}\n\nexport function cloneNotebookCellTextModel(cell: NotebookCellTextModel) {\n\treturn {\n\t\tsource: cell.getValue(),\n\t\tlanguage: cell.language,\n\t\tmime: cell.mime,\n\t\tcellKind: cell.cellKind,\n\t\toutputs: cell.outputs.map(output => ({\n\t\t\toutputs: output.outputs,\n\t\t\t/* paste should generate new outputId */ outputId: UUID.generateUuid()\n\t\t})),\n\t\tmetadata: {}\n\t};\n}\n\nfunction computeRunStartTimeAdjustment(oldMetadata: NotebookCellInternalMetadata, newMetadata: NotebookCellInternalMetadata): number | undefined {\n\tif (oldMetadata.runStartTime !== newMetadata.runStartTime && typeof newMetadata.runStartTime === 'number') {\n\t\tconst offset = Date.now() - newMetadata.runStartTime;\n\t\treturn offset < 0 ? Math.abs(offset) : 0;\n\t} else {\n\t\treturn newMetadata.runStartTimeAdjustment;\n\t}\n}\n\n\nexport function getFormattedMetadataJSON(transientCellMetadata: TransientCellMetadata | undefined, metadata: NotebookCellMetadata, language?: string, sortKeys?: boolean): string {\n\tlet filteredMetadata: { [key: string]: any } = {};\n\n\tif (transientCellMetadata) {\n\t\tconst keys = new Set([...Object.keys(metadata)]);\n\t\tfor (const key of keys) {\n\t\t\tif (!(transientCellMetadata[key as keyof NotebookCellMetadata])\n\t\t\t) {\n\t\t\t\tfilteredMetadata[key] = metadata[key as keyof NotebookCellMetadata];\n\t\t\t}\n\t\t}\n\t} else {\n\t\tfilteredMetadata = metadata;\n\t}\n\n\tconst obj = {\n\t\tlanguage,\n\t\t...filteredMetadata\n\t};\n\t// Give preference to the language we have been given.\n\t// Metadata can contain `language` due to round-tripping of cell metadata.\n\t// I.e. we add it here, and then from SCM when we revert the cell, we get this same metadata back with the `language` property.\n\tif (language) {\n\t\tobj.language = language;\n\t}\n\tconst metadataSource = toFormattedString(sortKeys ? sortObjectPropertiesRecursively(obj) : obj, {});\n\n\treturn metadataSource;\n}\n\n\n/**\n * Sort the JSON to ensure when diffing, the JSON keys are sorted & matched correctly in diff view.\n */\nexport function sortObjectPropertiesRecursively(obj: any): any {\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map(sortObjectPropertiesRecursively);\n\t}\n\tif (obj !== undefined && obj !== null && typeof obj === 'object' && Object.keys(obj).length > 0) {\n\t\treturn (\n\t\t\tObject.keys(obj)\n\t\t\t\t.sort()\n\t\t\t\t.reduce<Record<string, any>>((sortedObj, prop) => {\n\t\t\t\t\tsortedObj[prop] = sortObjectPropertiesRecursively(obj[prop]);\n\t\t\t\t\treturn sortedObj;\n\t\t\t\t}, {})\n\t\t);\n\t}\n\treturn obj;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { hash, StringSHA1 } from '../../../../../base/common/hash.js';\nimport { Disposable, DisposableStore, dispose } from '../../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport * as UUID from '../../../../../base/common/uuid.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport * as model from '../../../../../editor/common/model.js';\nimport { PieceTreeTextBuffer } from '../../../../../editor/common/model/pieceTreeTextBuffer/pieceTreeTextBuffer.js';\nimport { createTextBuffer, TextModel } from '../../../../../editor/common/model/textModel.js';\nimport { PLAINTEXT_LANGUAGE_ID } from '../../../../../editor/common/languages/modesRegistry.js';\nimport { ILanguageService } from '../../../../../editor/common/languages/language.js';\nimport { NotebookCellOutputTextModel } from './notebookCellOutputTextModel.js';\nimport { CellInternalMetadataChangedEvent, CellKind, ICell, ICellDto2, ICellOutput, IOutputItemDto, NotebookCellCollapseState, NotebookCellDefaultCollapseConfig, NotebookCellInternalMetadata, NotebookCellMetadata, NotebookCellOutputsSplice, TransientCellMetadata, TransientOptions } from '../notebookCommon.js';\nimport { ThrottledDelayer } from '../../../../../base/common/async.js';\nimport { ILanguageDetectionService } from '../../../../services/languageDetection/common/languageDetectionWorkerService.js';\nimport { toFormattedString } from '../../../../../base/common/jsonFormatter.js';\nimport { IModelContentChangedEvent } from '../../../../../editor/common/textModelEvents.js';\nimport { splitLines } from '../../../../../base/common/strings.js';\nimport { INotebookLoggingService } from '../notebookLoggingService.js';\n\nexport class NotebookCellTextModel extends Disposable implements ICell {\n\tprivate readonly _onDidChangeTextModel = this._register(new Emitter<void>());\n\treadonly onDidChangeTextModel: Event<void> = this._onDidChangeTextModel.event;\n\tprivate readonly _onDidChangeOutputs = this._register(new Emitter<NotebookCellOutputsSplice>());\n\treadonly onDidChangeOutputs: Event<NotebookCellOutputsSplice> = this._onDidChangeOutputs.event;\n\n\tprivate readonly _onDidChangeOutputItems = this._register(new Emitter<void>());\n\treadonly onDidChangeOutputItems: Event<void> = this._onDidChangeOutputItems.event;\n\n\tprivate readonly _onDidChangeContent = this._register(new Emitter<'content' | 'language' | 'mime' | { type: 'model'; event: IModelContentChangedEvent }>());\n\treadonly onDidChangeContent: Event<'content' | 'language' | 'mime' | { type: 'model'; event: IModelContentChangedEvent }> = this._onDidChangeContent.event;\n\n\tprivate readonly _onDidChangeMetadata = this._register(new Emitter<void>());\n\treadonly onDidChangeMetadata: Event<void> = this._onDidChangeMetadata.event;\n\n\tprivate readonly _onDidChangeInternalMetadata = this._register(new Emitter<CellInternalMetadataChangedEvent>());\n\treadonly onDidChangeInternalMetadata: Event<CellInternalMetadataChangedEvent> = this._onDidChangeInternalMetadata.event;\n\n\tprivate readonly _onDidChangeLanguage = this._register(new Emitter<string>());\n\treadonly onDidChangeLanguage: Event<string> = this._onDidChangeLanguage.event;\n\n\tprivate _outputs: NotebookCellOutputTextModel[];\n\n\tget outputs(): ICellOutput[] {\n\t\treturn this._outputs;\n\t}\n\n\tprivate _metadata: NotebookCellMetadata;\n\n\tget metadata() {\n\t\treturn this._metadata;\n\t}\n\n\tset metadata(newMetadata: NotebookCellMetadata) {\n\t\tthis._metadata = newMetadata;\n\t\tthis._hash = null;\n\t\tthis._onDidChangeMetadata.fire();\n\t}\n\n\tprivate _internalMetadata: NotebookCellInternalMetadata;\n\n\tget internalMetadata() {\n\t\treturn this._internalMetadata;\n\t}\n\n\tset internalMetadata(newInternalMetadata: NotebookCellInternalMetadata) {\n\t\tconst lastRunSuccessChanged = this._internalMetadata.lastRunSuccess !== newInternalMetadata.lastRunSuccess;\n\t\tnewInternalMetadata = {\n\t\t\t...newInternalMetadata,\n\t\t\t...{ runStartTimeAdjustment: computeRunStartTimeAdjustment(this._internalMetadata, newInternalMetadata) }\n\t\t};\n\t\tthis._internalMetadata = newInternalMetadata;\n\t\tthis._hash = null;\n\t\tthis._onDidChangeInternalMetadata.fire({ lastRunSuccessChanged });\n\t}\n\n\tget language() {\n\t\treturn this._language;\n\t}\n\n\tset language(newLanguage: string) {\n\t\tif (this._textModel\n\t\t\t// 1. the language update is from workspace edit, checking if it's the same as text model's mode\n\t\t\t&& this._textModel.getLanguageId() === this._languageService.getLanguageIdByLanguageName(newLanguage)\n\t\t\t// 2. the text model's mode might be the same as the `this.language`, even if the language friendly name is not the same, we should not trigger an update\n\t\t\t&& this._textModel.getLanguageId() === this._languageService.getLanguageIdByLanguageName(this.language)) {\n\t\t\treturn;\n\t\t}\n\n\n\t\tthis._hasLanguageSetExplicitly = true;\n\t\tthis._setLanguageInternal(newLanguage);\n\t}\n\n\tpublic get mime(): string | undefined {\n\t\treturn this._mime;\n\t}\n\n\tpublic set mime(newMime: string | undefined) {\n\t\tif (this._mime === newMime) {\n\t\t\treturn;\n\t\t}\n\t\tthis._mime = newMime;\n\t\tthis._hash = null;\n\t\tthis._onDidChangeContent.fire('mime');\n\t}\n\n\tprivate _textBuffer!: model.ITextBuffer;\n\n\tget textBuffer() {\n\t\tif (this._textBuffer) {\n\t\t\treturn this._textBuffer;\n\t\t}\n\n\t\tthis._textBuffer = this._register(createTextBuffer(this._source, this._defaultEOL).textBuffer);\n\n\t\tthis._register(this._textBuffer.onDidChangeContent(() => {\n\t\t\tthis._hash = null;\n\t\t\tif (!this._textModel) {\n\t\t\t\tthis._onDidChangeContent.fire('content');\n\t\t\t}\n\t\t\tthis.autoDetectLanguage();\n\t\t}));\n\n\t\treturn this._textBuffer;\n\t}\n\n\tprivate _textBufferHash: string | null = null;\n\tprivate _hash: number | null = null;\n\n\tprivate _versionId: number = 1;\n\tprivate _alternativeId: number = 1;\n\tget alternativeId(): number {\n\t\treturn this._alternativeId;\n\t}\n\n\tprivate readonly _textModelDisposables = this._register(new DisposableStore());\n\tprivate _textModel: TextModel | undefined = undefined;\n\tget textModel(): TextModel | undefined {\n\t\treturn this._textModel;\n\t}\n\n\tset textModel(m: TextModel | undefined) {\n\t\tif (this._textModel === m) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._textModelDisposables.clear();\n\t\tthis._textModel = m;\n\t\tif (this._textModel) {\n\t\t\tthis.setRegisteredLanguage(this._languageService, this._textModel.getLanguageId(), this.language);\n\n\t\t\t// Listen to language changes on the model\n\t\t\tthis._textModelDisposables.add(this._textModel.onDidChangeLanguage((e) => this.setRegisteredLanguage(this._languageService, e.newLanguage, this.language)));\n\t\t\tthis._textModelDisposables.add(this._textModel.onWillDispose(() => this.textModel = undefined));\n\t\t\tthis._textModelDisposables.add(this._textModel.onDidChangeContent((e) => {\n\t\t\t\tif (this._textModel) {\n\t\t\t\t\tthis._versionId = this._textModel.getVersionId();\n\t\t\t\t\tthis._alternativeId = this._textModel.getAlternativeVersionId();\n\t\t\t\t}\n\t\t\t\tthis._textBufferHash = null;\n\t\t\t\tthis._onDidChangeContent.fire('content');\n\t\t\t\tthis._onDidChangeContent.fire({ type: 'model', event: e });\n\t\t\t}));\n\n\t\t\tthis._textModel._overwriteVersionId(this._versionId);\n\t\t\tthis._textModel._overwriteAlternativeVersionId(this._versionId);\n\t\t\tthis._onDidChangeTextModel.fire();\n\t\t}\n\t}\n\n\tprivate setRegisteredLanguage(languageService: ILanguageService, newLanguage: string, currentLanguage: string) {\n\t\t// The language defined in the cell might not be supported in the editor so the text model might be using the default fallback\n\t\t// If so let's not modify the language\n\t\tconst isFallBackLanguage = (newLanguage === PLAINTEXT_LANGUAGE_ID || newLanguage === 'jupyter');\n\t\tif (!languageService.isRegisteredLanguageId(currentLanguage) && isFallBackLanguage) {\n\t\t\t// notify to display warning, but don't change the language\n\t\t\tthis._onDidChangeLanguage.fire(currentLanguage);\n\t\t} else {\n\t\t\tthis.language = newLanguage;\n\t\t}\n\t}\n\tprivate static readonly AUTO_DETECT_LANGUAGE_THROTTLE_DELAY = 600;\n\tprivate readonly autoDetectLanguageThrottler = this._register(new ThrottledDelayer<void>(NotebookCellTextModel.AUTO_DETECT_LANGUAGE_THROTTLE_DELAY));\n\tprivate _autoLanguageDetectionEnabled: boolean = false;\n\tprivate _hasLanguageSetExplicitly: boolean = false;\n\tget hasLanguageSetExplicitly(): boolean { return this._hasLanguageSetExplicitly; }\n\n\tprivate _source: string;\n\tprivate _language: string;\n\tprivate _mime: string | undefined;\n\tpublic readonly cellKind: CellKind;\n\tpublic readonly collapseState: NotebookCellCollapseState | undefined;\n\n\tconstructor(\n\t\treadonly uri: URI,\n\t\tpublic readonly handle: number,\n\t\tcell: ICellDto2,\n\t\tpublic readonly transientOptions: TransientOptions,\n\t\tprivate readonly _languageService: ILanguageService,\n\t\tprivate readonly _defaultEOL: model.DefaultEndOfLine,\n\t\tdefaultCollapseConfig: NotebookCellDefaultCollapseConfig | undefined,\n\t\tprivate readonly _languageDetectionService: ILanguageDetectionService | undefined = undefined,\n\t\tprivate readonly _notebookLoggingService: INotebookLoggingService\n\t) {\n\t\tsuper();\n\t\tthis._source = cell.source;\n\t\tthis._language = cell.language;\n\t\tthis._mime = cell.mime;\n\t\tthis.cellKind = cell.cellKind;\n\t\t// Compute collapse state: use cell's state if provided, otherwise use default config for this cell kind\n\t\tconst defaultConfig = cell.cellKind === CellKind.Code ? defaultCollapseConfig?.codeCell : defaultCollapseConfig?.markupCell;\n\t\tthis.collapseState = cell.collapseState ?? (defaultConfig ?? undefined);\n\t\tthis._outputs = cell.outputs.map(op => new NotebookCellOutputTextModel(op));\n\t\tthis._metadata = cell.metadata ?? {};\n\t\tthis._internalMetadata = cell.internalMetadata ?? {};\n\t}\n\n\tenableAutoLanguageDetection() {\n\t\tthis._autoLanguageDetectionEnabled = true;\n\t\tthis.autoDetectLanguage();\n\t}\n\n\tasync autoDetectLanguage(): Promise<void> {\n\t\tif (this._autoLanguageDetectionEnabled) {\n\t\t\tthis.autoDetectLanguageThrottler.trigger(() => this._doAutoDetectLanguage());\n\t\t}\n\t}\n\n\tprivate async _doAutoDetectLanguage(): Promise<void> {\n\t\tif (this.hasLanguageSetExplicitly) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst newLanguage = await this._languageDetectionService?.detectLanguage(this.uri);\n\t\tif (!newLanguage) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._textModel\n\t\t\t&& this._textModel.getLanguageId() === this._languageService.getLanguageIdByLanguageName(newLanguage)\n\t\t\t&& this._textModel.getLanguageId() === this._languageService.getLanguageIdByLanguageName(this.language)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._setLanguageInternal(newLanguage);\n\t}\n\n\tprivate _setLanguageInternal(newLanguage: string) {\n\t\tconst newLanguageId = this._languageService.getLanguageIdByLanguageName(newLanguage);\n\n\t\tif (newLanguageId === null) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._textModel) {\n\t\t\tconst languageId = this._languageService.createById(newLanguageId);\n\t\t\tthis._textModel.setLanguage(languageId.languageId);\n\t\t}\n\n\t\tif (this._language === newLanguage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._language = newLanguage;\n\t\tthis._hash = null;\n\t\tthis._onDidChangeLanguage.fire(newLanguage);\n\t\tthis._onDidChangeContent.fire('language');\n\t}\n\n\tresetTextBuffer(textBuffer: model.ITextBuffer) {\n\t\tthis._textBuffer = textBuffer;\n\t}\n\n\tgetValue(): string {\n\t\tconst fullRange = this.getFullModelRange();\n\t\tconst eol = this.textBuffer.getEOL();\n\t\tif (eol === '\\n') {\n\t\t\treturn this.textBuffer.getValueInRange(fullRange, model.EndOfLinePreference.LF);\n\t\t} else {\n\t\t\treturn this.textBuffer.getValueInRange(fullRange, model.EndOfLinePreference.CRLF);\n\t\t}\n\t}\n\n\tgetTextBufferHash() {\n\t\tif (this._textBufferHash !== null) {\n\t\t\treturn this._textBufferHash;\n\t\t}\n\n\t\tconst shaComputer = new StringSHA1();\n\t\tconst snapshot = this.textBuffer.createSnapshot(false);\n\t\tlet text: string | null;\n\t\twhile ((text = snapshot.read())) {\n\t\t\tshaComputer.update(text);\n\t\t}\n\t\tthis._textBufferHash = shaComputer.digest();\n\t\treturn this._textBufferHash;\n\t}\n\n\tgetHashValue(): number {\n\t\tif (this._hash !== null) {\n\t\t\treturn this._hash;\n\t\t}\n\n\t\tthis._hash = hash([hash(this.language), this.getTextBufferHash(), this._getPersisentMetadata(), this.transientOptions.transientOutputs ? [] : this._outputs.map(op => ({\n\t\t\toutputs: op.outputs.map(output => ({\n\t\t\t\tmime: output.mime,\n\t\t\t\tdata: Array.from(output.data.buffer)\n\t\t\t})),\n\t\t\tmetadata: op.metadata\n\t\t}))]);\n\t\treturn this._hash;\n\t}\n\n\tprivate _getPersisentMetadata() {\n\t\treturn getFormattedMetadataJSON(this.transientOptions.transientCellMetadata, this.metadata, this.language);\n\t}\n\n\tgetTextLength(): number {\n\t\treturn this.textBuffer.getLength();\n\t}\n\n\tgetFullModelRange() {\n\t\tconst lineCount = this.textBuffer.getLineCount();\n\t\treturn new Range(1, 1, lineCount, this.textBuffer.getLineLength(lineCount) + 1);\n\t}\n\n\tspliceNotebookCellOutputs(splice: NotebookCellOutputsSplice): void {\n\t\tthis._notebookLoggingService.trace('textModelEdits', `splicing outputs at ${splice.start} length: ${splice.deleteCount} with ${splice.newOutputs.length} new outputs`);\n\t\tif (splice.deleteCount > 0 && splice.newOutputs.length > 0) {\n\t\t\tconst commonLen = Math.min(splice.deleteCount, splice.newOutputs.length);\n\t\t\t// update\n\t\t\tfor (let i = 0; i < commonLen; i++) {\n\t\t\t\tconst currentOutput = this.outputs[splice.start + i];\n\t\t\t\tconst newOutput = splice.newOutputs[i];\n\n\t\t\t\tthis.replaceOutput(currentOutput.outputId, newOutput);\n\t\t\t}\n\n\t\t\tconst removed = this.outputs.splice(splice.start + commonLen, splice.deleteCount - commonLen, ...splice.newOutputs.slice(commonLen));\n\t\t\tremoved.forEach(output => output.dispose());\n\t\t\tthis._onDidChangeOutputs.fire({ start: splice.start + commonLen, deleteCount: splice.deleteCount - commonLen, newOutputs: splice.newOutputs.slice(commonLen) });\n\t\t} else {\n\t\t\tconst removed = this.outputs.splice(splice.start, splice.deleteCount, ...splice.newOutputs);\n\t\t\tremoved.forEach(output => output.dispose());\n\t\t\tthis._onDidChangeOutputs.fire(splice);\n\t\t}\n\t}\n\n\treplaceOutput(outputId: string, newOutputItem: ICellOutput) {\n\t\tconst outputIndex = this.outputs.findIndex(output => output.outputId === outputId);\n\n\t\tif (outputIndex < 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._notebookLoggingService.trace('textModelEdits', `replacing an output item at index ${outputIndex}`);\n\t\tconst output = this.outputs[outputIndex];\n\t\t// convert to dto and dispose the cell output model\n\t\toutput.replaceData({\n\t\t\toutputs: newOutputItem.outputs,\n\t\t\toutputId: newOutputItem.outputId,\n\t\t\tmetadata: newOutputItem.metadata\n\t\t});\n\t\tnewOutputItem.dispose();\n\t\tthis._onDidChangeOutputItems.fire();\n\t\treturn true;\n\t}\n\n\tchangeOutputItems(outputId: string, append: boolean, items: IOutputItemDto[]): boolean {\n\t\tconst outputIndex = this.outputs.findIndex(output => output.outputId === outputId);\n\n\t\tif (outputIndex < 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst output = this.outputs[outputIndex];\n\t\tthis._notebookLoggingService.trace('textModelEdits', `${append ? 'appending' : 'replacing'} ${items.length} output items to for output index ${outputIndex}`);\n\t\tif (append) {\n\t\t\toutput.appendData(items);\n\t\t} else {\n\t\t\toutput.replaceData({ outputId: outputId, outputs: items, metadata: output.metadata });\n\t\t}\n\t\tthis._onDidChangeOutputItems.fire();\n\t\treturn true;\n\t}\n\n\tprivate _outputNotEqualFastCheck(left: ICellOutput[], right: ICellOutput[]) {\n\t\tif (left.length !== right.length) {\n\t\t\treturn false;\n\t\t}\n\n\t\tfor (let i = 0; i < this.outputs.length; i++) {\n\t\t\tconst l = left[i];\n\t\t\tconst r = right[i];\n\n\t\t\tif (l.outputs.length !== r.outputs.length) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tfor (let k = 0; k < l.outputs.length; k++) {\n\t\t\t\tif (l.outputs[k].mime !== r.outputs[k].mime) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (l.outputs[k].data.byteLength !== r.outputs[k].data.byteLength) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tequal(b: NotebookCellTextModel): boolean {\n\t\tif (this.language !== b.language) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.outputs.length !== b.outputs.length) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.getTextLength() !== b.getTextLength()) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this.transientOptions.transientOutputs) {\n\t\t\t// compare outputs\n\n\t\t\tif (!this._outputNotEqualFastCheck(this.outputs, b.outputs)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn this.getHashValue() === b.getHashValue();\n\t}\n\n\t/**\n\t * Only compares\n\t * - language\n\t * - mime\n\t * - cellKind\n\t * - internal metadata (conditionally)\n\t * - source\n\t */\n\tfastEqual(b: ICellDto2, ignoreMetadata: boolean): boolean {\n\t\tif (this.language !== b.language) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.mime !== b.mime) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.cellKind !== b.cellKind) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!ignoreMetadata) {\n\t\t\tif (this.internalMetadata?.executionOrder !== b.internalMetadata?.executionOrder\n\t\t\t\t|| this.internalMetadata?.lastRunSuccess !== b.internalMetadata?.lastRunSuccess\n\t\t\t\t|| this.internalMetadata?.runStartTime !== b.internalMetadata?.runStartTime\n\t\t\t\t|| this.internalMetadata?.runStartTimeAdjustment !== b.internalMetadata?.runStartTimeAdjustment\n\t\t\t\t|| this.internalMetadata?.runEndTime !== b.internalMetadata?.runEndTime) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t// Once we attach the cell text buffer to an editor, the source of truth is the text buffer instead of the original source\n\t\tif (this._textBuffer) {\n\t\t\tif (!NotebookCellTextModel.linesAreEqual(this.textBuffer.getLinesContent(), b.source)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else if (this._source !== b.source) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprivate static linesAreEqual(aLines: string[], b: string) {\n\t\tconst bLines = splitLines(b);\n\t\tif (aLines.length !== bLines.length) {\n\t\t\treturn false;\n\t\t}\n\t\tfor (let i = 0; i < aLines.length; i++) {\n\t\t\tif (aLines[i] !== bLines[i]) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\toverride dispose() {\n\t\tdispose(this._outputs);\n\t\t// Manually release reference to previous text buffer to avoid large leaks\n\t\t// in case someone leaks a CellTextModel reference\n\t\tconst emptyDisposedTextBuffer = new PieceTreeTextBuffer([], '', '\\n', false, false, true, true);\n\t\temptyDisposedTextBuffer.dispose();\n\t\tthis._textBuffer = emptyDisposedTextBuffer;\n\t\tsuper.dispose();\n\t}\n}\n\nexport function cloneNotebookCellTextModel(cell: NotebookCellTextModel) {\n\treturn {\n\t\tsource: cell.getValue(),\n\t\tlanguage: cell.language,\n\t\tmime: cell.mime,\n\t\tcellKind: cell.cellKind,\n\t\toutputs: cell.outputs.map(output => ({\n\t\t\toutputs: output.outputs,\n\t\t\t/* paste should generate new outputId */ outputId: UUID.generateUuid()\n\t\t})),\n\t\tmetadata: {}\n\t};\n}\n\nfunction computeRunStartTimeAdjustment(oldMetadata: NotebookCellInternalMetadata, newMetadata: NotebookCellInternalMetadata): number | undefined {\n\tif (oldMetadata.runStartTime !== newMetadata.runStartTime && typeof newMetadata.runStartTime === 'number') {\n\t\tconst offset = Date.now() - newMetadata.runStartTime;\n\t\treturn offset < 0 ? Math.abs(offset) : 0;\n\t} else {\n\t\treturn newMetadata.runStartTimeAdjustment;\n\t}\n}\n\n\nexport function getFormattedMetadataJSON(transientCellMetadata: TransientCellMetadata | undefined, metadata: NotebookCellMetadata, language?: string, sortKeys?: boolean): string {\n\tlet filteredMetadata: { [key: string]: any } = {};\n\n\tif (transientCellMetadata) {\n\t\tconst keys = new Set([...Object.keys(metadata)]);\n\t\tfor (const key of keys) {\n\t\t\tif (!(transientCellMetadata[key as keyof NotebookCellMetadata])\n\t\t\t) {\n\t\t\t\tfilteredMetadata[key] = metadata[key as keyof NotebookCellMetadata];\n\t\t\t}\n\t\t}\n\t} else {\n\t\tfilteredMetadata = metadata;\n\t}\n\n\tconst obj = {\n\t\tlanguage,\n\t\t...filteredMetadata\n\t};\n\t// Give preference to the language we have been given.\n\t// Metadata can contain `language` due to round-tripping of cell metadata.\n\t// I.e. we add it here, and then from SCM when we revert the cell, we get this same metadata back with the `language` property.\n\tif (language) {\n\t\tobj.language = language;\n\t}\n\tconst metadataSource = toFormattedString(sortKeys ? sortObjectPropertiesRecursively(obj) : obj, {});\n\n\treturn metadataSource;\n}\n\n\n/**\n * Sort the JSON to ensure when diffing, the JSON keys are sorted & matched correctly in diff view.\n */\nexport function sortObjectPropertiesRecursively(obj: any): any {\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map(sortObjectPropertiesRecursively);\n\t}\n\tif (obj !== undefined && obj !== null && typeof obj === 'object' && Object.keys(obj).length > 0) {\n\t\treturn (\n\t\t\tObject.keys(obj)\n\t\t\t\t.sort()\n\t\t\t\t.reduce<Record<string, any>>((sortedObj, prop) => {\n\t\t\t\t\tsortedObj[prop] = sortObjectPropertiesRecursively(obj[prop]);\n\t\t\t\t\treturn sortedObj;\n\t\t\t\t}, {})\n\t\t);\n\t}\n\treturn obj;\n}\n"]}