{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/browser/view/cellParts/cellComments.ts","vs/workbench/contrib/notebook/browser/view/cellParts/cellComments.ts"],"names":[],"mappings":"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","file":"cellComments.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from '../../../../../../base/common/arrays.js';\nimport { DisposableMap, DisposableStore } from '../../../../../../base/common/lifecycle.js';\nimport * as languages from '../../../../../../editor/common/languages.js';\nimport { IContextKeyService } from '../../../../../../platform/contextkey/common/contextkey.js';\nimport { IInstantiationService } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { IThemeService } from '../../../../../../platform/theme/common/themeService.js';\nimport { ICommentService, INotebookCommentInfo } from '../../../../comments/browser/commentService.js';\nimport { CommentThreadWidget } from '../../../../comments/browser/commentThreadWidget.js';\nimport { ICellViewModel, INotebookEditorDelegate } from '../../notebookBrowser.js';\nimport { CellContentPart } from '../cellPart.js';\nimport { ICellRange } from '../../../common/notebookRange.js';\n\nexport class CellComments extends CellContentPart {\n\t// keyed by threadId\n\tprivate readonly _commentThreadWidgets: DisposableMap<string, { widget: CommentThreadWidget<ICellRange>; dispose: () => void }>;\n\tprivate currentElement: ICellViewModel | undefined;\n\n\tconstructor(\n\t\tprivate readonly notebookEditor: INotebookEditorDelegate,\n\t\tprivate readonly container: HTMLElement,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService,\n\t\t@IThemeService private readonly themeService: IThemeService,\n\t\t@ICommentService private readonly commentService: ICommentService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis.container.classList.add('review-widget');\n\n\t\tthis._register(this._commentThreadWidgets = new DisposableMap<string, { widget: CommentThreadWidget<ICellRange>; dispose: () => void }>());\n\n\t\tthis._register(this.themeService.onDidColorThemeChange(this._applyTheme, this));\n\t\t// TODO @rebornix onDidChangeLayout (font change)\n\t\t// this._register(this.notebookEditor.onDidchangeLa)\n\t\tthis._applyTheme();\n\t}\n\n\tprivate async initialize(element: ICellViewModel) {\n\t\tif (this.currentElement === element) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.currentElement = element;\n\t\tawait this._updateThread();\n\t}\n\n\tprivate async _createCommentTheadWidget(owner: string, commentThread: languages.CommentThread<ICellRange>) {\n\t\tconst widgetDisposables = new DisposableStore();\n\t\tconst widget = this.instantiationService.createInstance(\n\t\t\tCommentThreadWidget,\n\t\t\tthis.container,\n\t\t\tthis.notebookEditor,\n\t\t\towner,\n\t\t\tthis.notebookEditor.textModel!.uri,\n\t\t\tthis.contextKeyService,\n\t\t\tthis.instantiationService,\n\t\t\tcommentThread,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\t{},\n\t\t\tundefined,\n\t\t\t{\n\t\t\t\tactionRunner: () => {\n\t\t\t\t},\n\t\t\t\tcollapse: async () => { return true; }\n\t\t\t}\n\t\t) as unknown as CommentThreadWidget<ICellRange>;\n\t\twidgetDisposables.add(widget);\n\t\tthis._commentThreadWidgets.set(commentThread.threadId, { widget, dispose: () => widgetDisposables.dispose() });\n\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tawait widget.display(layoutInfo.fontInfo.lineHeight, true);\n\t\tthis._applyTheme();\n\n\t\twidgetDisposables.add(widget.onDidResize(() => {\n\t\t\tif (this.currentElement) {\n\t\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(widget.getDimensions().height);\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate _bindListeners() {\n\t\tthis.cellDisposables.add(this.commentService.onDidUpdateCommentThreads(async () => this._updateThread()));\n\t}\n\n\tprivate async _updateThread() {\n\t\tif (!this.currentElement) {\n\t\t\treturn;\n\t\t}\n\t\tconst infos = await this._getCommentThreadsForCell(this.currentElement);\n\t\tconst widgetsToDelete = new Set(this._commentThreadWidgets.keys());\n\t\tconst layoutInfo = this.currentElement.layoutInfo;\n\t\tthis.container.style.top = `${layoutInfo.commentOffset}px`;\n\t\tfor (const info of infos) {\n\t\t\tif (!info) { continue; }\n\t\t\tfor (const thread of info.threads) {\n\t\t\t\twidgetsToDelete.delete(thread.threadId);\n\t\t\t\tconst widget = this._commentThreadWidgets.get(thread.threadId)?.widget;\n\t\t\t\tif (widget) {\n\t\t\t\t\tawait widget.updateCommentThread(thread);\n\t\t\t\t} else {\n\t\t\t\t\tawait this._createCommentTheadWidget(info.uniqueOwner, thread);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor (const threadId of widgetsToDelete) {\n\t\t\tthis._commentThreadWidgets.deleteAndDispose(threadId);\n\t\t}\n\t\tthis._updateHeight();\n\n\t}\n\n\tprivate _calculateCommentThreadHeight(bodyHeight: number) {\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tconst headHeight = Math.ceil(layoutInfo.fontInfo.lineHeight * 1.2);\n\t\tconst lineHeight = layoutInfo.fontInfo.lineHeight;\n\t\tconst arrowHeight = Math.round(lineHeight / 3);\n\t\tconst frameThickness = Math.round(lineHeight / 9) * 2;\n\n\t\tconst computedHeight = headHeight + bodyHeight + arrowHeight + frameThickness + 8 /** margin bottom to avoid margin collapse */;\n\t\treturn computedHeight;\n\t}\n\n\tprivate _updateHeight() {\n\t\tif (!this.currentElement) {\n\t\t\treturn;\n\t\t}\n\t\tlet height = 0;\n\t\tfor (const { widget } of this._commentThreadWidgets.values()) {\n\t\t\theight += this._calculateCommentThreadHeight(widget.getDimensions().height);\n\t\t}\n\t\tthis.currentElement.commentHeight = height;\n\t}\n\n\tprivate async _getCommentThreadsForCell(element: ICellViewModel): Promise<(INotebookCommentInfo | null)[]> {\n\t\tif (this.notebookEditor.hasModel()) {\n\t\t\treturn coalesce(await this.commentService.getNotebookComments(element.uri));\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tprivate _applyTheme() {\n\t\tconst fontInfo = this.notebookEditor.getLayoutInfo().fontInfo;\n\t\tfor (const { widget } of this._commentThreadWidgets.values()) {\n\t\t\twidget.applyTheme(fontInfo);\n\t\t}\n\t}\n\n\toverride didRenderCell(element: ICellViewModel): void {\n\t\tthis.initialize(element);\n\t\tthis._bindListeners();\n\t}\n\n\toverride prepareLayout(): void {\n\t\tthis._updateHeight();\n\t}\n\n\toverride updateInternalLayoutNow(element: ICellViewModel): void {\n\t\tif (this.currentElement) {\n\t\t\tthis.container.style.top = `${element.layoutInfo.commentOffset}px`;\n\t\t}\n\t}\n}\n\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from '../../../../../../base/common/arrays.js';\nimport { DisposableMap, DisposableStore } from '../../../../../../base/common/lifecycle.js';\nimport * as languages from '../../../../../../editor/common/languages.js';\nimport { IContextKeyService } from '../../../../../../platform/contextkey/common/contextkey.js';\nimport { IInstantiationService } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { IThemeService } from '../../../../../../platform/theme/common/themeService.js';\nimport { ICommentService, INotebookCommentInfo } from '../../../../comments/browser/commentService.js';\nimport { CommentThreadWidget } from '../../../../comments/browser/commentThreadWidget.js';\nimport { ICellViewModel, INotebookEditorDelegate } from '../../notebookBrowser.js';\nimport { CellContentPart } from '../cellPart.js';\nimport { ICellRange } from '../../../common/notebookRange.js';\n\nexport class CellComments extends CellContentPart {\n\t// keyed by threadId\n\tprivate readonly _commentThreadWidgets: DisposableMap<string, { widget: CommentThreadWidget<ICellRange>; dispose: () => void }>;\n\tprivate currentElement: ICellViewModel | undefined;\n\n\tconstructor(\n\t\tprivate readonly notebookEditor: INotebookEditorDelegate,\n\t\tprivate readonly container: HTMLElement,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService,\n\t\t@IThemeService private readonly themeService: IThemeService,\n\t\t@ICommentService private readonly commentService: ICommentService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis.container.classList.add('review-widget');\n\n\t\tthis._register(this._commentThreadWidgets = new DisposableMap<string, { widget: CommentThreadWidget<ICellRange>; dispose: () => void }>());\n\n\t\tthis._register(this.themeService.onDidColorThemeChange(this._applyTheme, this));\n\t\t// TODO @rebornix onDidChangeLayout (font change)\n\t\t// this._register(this.notebookEditor.onDidchangeLa)\n\t\tthis._applyTheme();\n\t}\n\n\tprivate async initialize(element: ICellViewModel) {\n\t\tif (this.currentElement === element) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.currentElement = element;\n\t\tawait this._updateThread();\n\t}\n\n\tprivate async _createCommentTheadWidget(owner: string, commentThread: languages.CommentThread<ICellRange>) {\n\t\tconst widgetDisposables = new DisposableStore();\n\t\tconst widget = this.instantiationService.createInstance(\n\t\t\tCommentThreadWidget,\n\t\t\tthis.container,\n\t\t\tthis.notebookEditor,\n\t\t\towner,\n\t\t\tthis.notebookEditor.textModel!.uri,\n\t\t\tthis.contextKeyService,\n\t\t\tthis.instantiationService,\n\t\t\tcommentThread,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\t{},\n\t\t\tundefined,\n\t\t\t{\n\t\t\t\tactionRunner: () => {\n\t\t\t\t},\n\t\t\t\tcollapse: async () => { return true; }\n\t\t\t}\n\t\t) as unknown as CommentThreadWidget<ICellRange>;\n\t\twidgetDisposables.add(widget);\n\t\tthis._commentThreadWidgets.set(commentThread.threadId, { widget, dispose: () => widgetDisposables.dispose() });\n\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tawait widget.display(layoutInfo.fontInfo.lineHeight, true);\n\t\tthis._applyTheme();\n\n\t\twidgetDisposables.add(widget.onDidResize(() => {\n\t\t\tif (this.currentElement) {\n\t\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(widget.getDimensions().height);\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate _bindListeners() {\n\t\tthis.cellDisposables.add(this.commentService.onDidUpdateCommentThreads(async () => this._updateThread()));\n\t}\n\n\tprivate async _updateThread() {\n\t\tif (!this.currentElement) {\n\t\t\treturn;\n\t\t}\n\t\tconst infos = await this._getCommentThreadsForCell(this.currentElement);\n\t\tconst widgetsToDelete = new Set(this._commentThreadWidgets.keys());\n\t\tconst layoutInfo = this.currentElement.layoutInfo;\n\t\tthis.container.style.top = `${layoutInfo.commentOffset}px`;\n\t\tfor (const info of infos) {\n\t\t\tif (!info) { continue; }\n\t\t\tfor (const thread of info.threads) {\n\t\t\t\twidgetsToDelete.delete(thread.threadId);\n\t\t\t\tconst widget = this._commentThreadWidgets.get(thread.threadId)?.widget;\n\t\t\t\tif (widget) {\n\t\t\t\t\tawait widget.updateCommentThread(thread);\n\t\t\t\t} else {\n\t\t\t\t\tawait this._createCommentTheadWidget(info.uniqueOwner, thread);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor (const threadId of widgetsToDelete) {\n\t\t\tthis._commentThreadWidgets.deleteAndDispose(threadId);\n\t\t}\n\t\tthis._updateHeight();\n\n\t}\n\n\tprivate _calculateCommentThreadHeight(bodyHeight: number) {\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tconst headHeight = Math.ceil(layoutInfo.fontInfo.lineHeight * 1.2);\n\t\tconst lineHeight = layoutInfo.fontInfo.lineHeight;\n\t\tconst arrowHeight = Math.round(lineHeight / 3);\n\t\tconst frameThickness = Math.round(lineHeight / 9) * 2;\n\n\t\tconst computedHeight = headHeight + bodyHeight + arrowHeight + frameThickness + 8 /** margin bottom to avoid margin collapse */;\n\t\treturn computedHeight;\n\t}\n\n\tprivate _updateHeight() {\n\t\tif (!this.currentElement) {\n\t\t\treturn;\n\t\t}\n\t\tlet height = 0;\n\t\tfor (const { widget } of this._commentThreadWidgets.values()) {\n\t\t\theight += this._calculateCommentThreadHeight(widget.getDimensions().height);\n\t\t}\n\t\tthis.currentElement.commentHeight = height;\n\t}\n\n\tprivate async _getCommentThreadsForCell(element: ICellViewModel): Promise<(INotebookCommentInfo | null)[]> {\n\t\tif (this.notebookEditor.hasModel()) {\n\t\t\treturn coalesce(await this.commentService.getNotebookComments(element.uri));\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tprivate _applyTheme() {\n\t\tconst fontInfo = this.notebookEditor.getLayoutInfo().fontInfo;\n\t\tfor (const { widget } of this._commentThreadWidgets.values()) {\n\t\t\twidget.applyTheme(fontInfo);\n\t\t}\n\t}\n\n\toverride didRenderCell(element: ICellViewModel): void {\n\t\tthis.initialize(element);\n\t\tthis._bindListeners();\n\t}\n\n\toverride prepareLayout(): void {\n\t\tthis._updateHeight();\n\t}\n\n\toverride updateInternalLayoutNow(element: ICellViewModel): void {\n\t\tif (this.currentElement) {\n\t\t\tthis.container.style.top = `${element.layoutInfo.commentOffset}px`;\n\t\t}\n\t}\n}\n\n"]}