{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/browser/view/notebookCellList.ts","vs/workbench/contrib/notebook/browser/view/notebookCellList.ts"],"names":[],"mappings":"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","file":"notebookCellList.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as DOM from '../../../../../base/browser/dom.js';\nimport * as domStylesheetsJs from '../../../../../base/browser/domStylesheets.js';\nimport { IMouseWheelEvent } from '../../../../../base/browser/mouseEvent.js';\nimport { IListRenderer, IListVirtualDelegate, ListError } from '../../../../../base/browser/ui/list/list.js';\nimport { IListStyles, IStyleController } from '../../../../../base/browser/ui/list/listWidget.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable, MutableDisposable } from '../../../../../base/common/lifecycle.js';\nimport { isMacintosh } from '../../../../../base/common/platform.js';\nimport { ScrollEvent } from '../../../../../base/common/scrollable.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { Selection } from '../../../../../editor/common/core/selection.js';\nimport { TrackedRangeStickiness } from '../../../../../editor/common/model.js';\nimport { PrefixSumComputer } from '../../../../../editor/common/model/prefixSumComputer.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IListService, IWorkbenchListOptions, WorkbenchList } from '../../../../../platform/list/browser/listService.js';\nimport { CursorAtBoundary, ICellViewModel, CellEditState, ICellOutputViewModel, CellRevealType, CellRevealRangeType, CursorAtLineBoundary, INotebookViewZoneChangeAccessor, INotebookCellOverlayChangeAccessor } from '../notebookBrowser.js';\nimport { CellViewModel, NotebookViewModel } from '../viewModel/notebookViewModelImpl.js';\nimport { diff, NOTEBOOK_EDITOR_CURSOR_BOUNDARY, CellKind, SelectionStateType, NOTEBOOK_EDITOR_CURSOR_LINE_BOUNDARY } from '../../common/notebookCommon.js';\nimport { ICellRange, cellRangesToIndexes, reduceCellRanges, cellRangesEqual } from '../../common/notebookRange.js';\nimport { NOTEBOOK_CELL_LIST_FOCUSED } from '../../common/notebookContextKeys.js';\nimport { clamp } from '../../../../../base/common/numbers.js';\nimport { ISplice } from '../../../../../base/common/sequence.js';\nimport { BaseCellRenderTemplate, INotebookCellList } from './notebookRenderingCommon.js';\nimport { FastDomNode } from '../../../../../base/browser/fastDomNode.js';\nimport { MarkupCellViewModel } from '../viewModel/markupCellViewModel.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IListViewOptions, IListView } from '../../../../../base/browser/ui/list/listView.js';\nimport { NotebookCellListView } from './notebookCellListView.js';\nimport { NotebookOptions } from '../notebookOptions.js';\nimport { INotebookExecutionStateService } from '../../common/notebookExecutionStateService.js';\nimport { NotebookCellAnchor } from './notebookCellAnchor.js';\nimport { NotebookViewZones } from '../viewParts/notebookViewZones.js';\nimport { NotebookCellOverlays } from '../viewParts/notebookCellOverlays.js';\n\nconst enum CellRevealPosition {\n\tTop,\n\tCenter,\n\tBottom,\n\tNearTop\n}\n\nfunction getVisibleCells(cells: CellViewModel[], hiddenRanges: ICellRange[]) {\n\tif (!hiddenRanges.length) {\n\t\treturn cells;\n\t}\n\n\tlet start = 0;\n\tlet hiddenRangeIndex = 0;\n\tconst result: CellViewModel[] = [];\n\n\twhile (start < cells.length && hiddenRangeIndex < hiddenRanges.length) {\n\t\tif (start < hiddenRanges[hiddenRangeIndex].start) {\n\t\t\tresult.push(...cells.slice(start, hiddenRanges[hiddenRangeIndex].start));\n\t\t}\n\n\t\tstart = hiddenRanges[hiddenRangeIndex].end + 1;\n\t\thiddenRangeIndex++;\n\t}\n\n\tif (start < cells.length) {\n\t\tresult.push(...cells.slice(start));\n\t}\n\n\treturn result;\n}\n\nexport const NOTEBOOK_WEBVIEW_BOUNDARY = 5000;\n\nfunction validateWebviewBoundary(element: HTMLElement) {\n\tconst webviewTop = 0 - (parseInt(element.style.top, 10) || 0);\n\treturn webviewTop >= 0 && webviewTop <= NOTEBOOK_WEBVIEW_BOUNDARY * 2;\n}\n\nexport class NotebookCellList extends WorkbenchList<CellViewModel> implements IDisposable, IStyleController, INotebookCellList {\n\tdeclare protected readonly view: NotebookCellListView<CellViewModel>;\n\tprivate viewZones!: NotebookViewZones;\n\tprivate cellOverlays!: NotebookCellOverlays;\n\tget onWillScroll(): Event<ScrollEvent> { return this.view.onWillScroll; }\n\n\tget rowsContainer(): HTMLElement {\n\t\treturn this.view.containerDomNode;\n\t}\n\n\tget scrollableElement(): HTMLElement {\n\t\treturn this.view.scrollableElementDomNode;\n\t}\n\tprivate _previousFocusedElements: readonly CellViewModel[] = [];\n\tprivate readonly _localDisposableStore = new DisposableStore();\n\tprivate readonly _viewModelStore = new DisposableStore();\n\tprivate styleElement?: HTMLStyleElement;\n\tprivate _notebookCellAnchor: NotebookCellAnchor;\n\n\tprivate readonly _onDidRemoveOutputs = this._localDisposableStore.add(new Emitter<readonly ICellOutputViewModel[]>());\n\treadonly onDidRemoveOutputs = this._onDidRemoveOutputs.event;\n\n\tprivate readonly _onDidHideOutputs = this._localDisposableStore.add(new Emitter<readonly ICellOutputViewModel[]>());\n\treadonly onDidHideOutputs = this._onDidHideOutputs.event;\n\n\tprivate readonly _onDidRemoveCellsFromView = this._localDisposableStore.add(new Emitter<readonly ICellViewModel[]>());\n\treadonly onDidRemoveCellsFromView = this._onDidRemoveCellsFromView.event;\n\n\tprivate _viewModel: NotebookViewModel | null = null;\n\tget viewModel(): NotebookViewModel | null {\n\t\treturn this._viewModel;\n\t}\n\tprivate _hiddenRangeIds: string[] = [];\n\tprivate hiddenRangesPrefixSum: PrefixSumComputer | null = null;\n\n\tprivate readonly _onDidChangeVisibleRanges = this._localDisposableStore.add(new Emitter<void>());\n\n\treadonly onDidChangeVisibleRanges: Event<void> = this._onDidChangeVisibleRanges.event;\n\tprivate _visibleRanges: ICellRange[] = [];\n\n\tget visibleRanges() {\n\t\treturn this._visibleRanges;\n\t}\n\n\tset visibleRanges(ranges: ICellRange[]) {\n\t\tif (cellRangesEqual(this._visibleRanges, ranges)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._visibleRanges = ranges;\n\t\tthis._onDidChangeVisibleRanges.fire();\n\t}\n\n\tprivate _isDisposed = false;\n\n\tget isDisposed() {\n\t\treturn this._isDisposed;\n\t}\n\n\tprivate _isInLayout: boolean = false;\n\n\tprivate _webviewElement: FastDomNode<HTMLElement> | null = null;\n\n\tget webviewElement() {\n\t\treturn this._webviewElement;\n\t}\n\n\tget inRenderingTransaction() {\n\t\treturn this.view.inRenderingTransaction;\n\t}\n\n\tconstructor(\n\t\tprivate listUser: string,\n\t\tcontainer: HTMLElement,\n\t\tprivate readonly notebookOptions: NotebookOptions,\n\t\tdelegate: IListVirtualDelegate<CellViewModel>,\n\t\trenderers: IListRenderer<CellViewModel, BaseCellRenderTemplate>[],\n\t\tcontextKeyService: IContextKeyService,\n\t\toptions: IWorkbenchListOptions<CellViewModel>,\n\t\t@IListService listService: IListService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@INotebookExecutionStateService notebookExecutionStateService: INotebookExecutionStateService,\n\t) {\n\t\tsuper(listUser, container, delegate, renderers, options, contextKeyService, listService, configurationService, instantiationService);\n\t\tNOTEBOOK_CELL_LIST_FOCUSED.bindTo(this.contextKeyService).set(true);\n\t\tthis._previousFocusedElements = this.getFocusedElements();\n\t\tthis._localDisposableStore.add(this.onDidChangeFocus((e) => {\n\t\t\tthis._previousFocusedElements.forEach(element => {\n\t\t\t\tif (e.elements.indexOf(element) < 0) {\n\t\t\t\t\telement.onDeselect();\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis._previousFocusedElements = e.elements;\n\t\t}));\n\n\t\tconst notebookEditorCursorAtBoundaryContext = NOTEBOOK_EDITOR_CURSOR_BOUNDARY.bindTo(contextKeyService);\n\t\tnotebookEditorCursorAtBoundaryContext.set('none');\n\n\t\tconst notebookEditorCursorAtLineBoundaryContext = NOTEBOOK_EDITOR_CURSOR_LINE_BOUNDARY.bindTo(contextKeyService);\n\t\tnotebookEditorCursorAtLineBoundaryContext.set('none');\n\n\t\tconst cursorSelectionListener = this._localDisposableStore.add(new MutableDisposable());\n\t\tconst textEditorAttachListener = this._localDisposableStore.add(new MutableDisposable());\n\n\t\tthis._notebookCellAnchor = new NotebookCellAnchor(notebookExecutionStateService, configurationService, this.onDidScroll);\n\n\t\tconst recomputeContext = (element: CellViewModel) => {\n\t\t\tswitch (element.cursorAtBoundary()) {\n\t\t\t\tcase CursorAtBoundary.Both:\n\t\t\t\t\tnotebookEditorCursorAtBoundaryContext.set('both');\n\t\t\t\t\tbreak;\n\t\t\t\tcase CursorAtBoundary.Top:\n\t\t\t\t\tnotebookEditorCursorAtBoundaryContext.set('top');\n\t\t\t\t\tbreak;\n\t\t\t\tcase CursorAtBoundary.Bottom:\n\t\t\t\t\tnotebookEditorCursorAtBoundaryContext.set('bottom');\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tnotebookEditorCursorAtBoundaryContext.set('none');\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tswitch (element.cursorAtLineBoundary()) {\n\t\t\t\tcase CursorAtLineBoundary.Both:\n\t\t\t\t\tnotebookEditorCursorAtLineBoundaryContext.set('both');\n\t\t\t\t\tbreak;\n\t\t\t\tcase CursorAtLineBoundary.Start:\n\t\t\t\t\tnotebookEditorCursorAtLineBoundaryContext.set('start');\n\t\t\t\t\tbreak;\n\t\t\t\tcase CursorAtLineBoundary.End:\n\t\t\t\t\tnotebookEditorCursorAtLineBoundaryContext.set('end');\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tnotebookEditorCursorAtLineBoundaryContext.set('none');\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\treturn;\n\t\t};\n\n\t\t// Cursor Boundary context\n\t\tthis._localDisposableStore.add(this.onDidChangeFocus((e) => {\n\t\t\tif (e.elements.length) {\n\t\t\t\t// we only validate the first focused element\n\t\t\t\tconst focusedElement = e.elements[0];\n\n\t\t\t\tcursorSelectionListener.value = focusedElement.onDidChangeState((e) => {\n\t\t\t\t\tif (e.selectionChanged) {\n\t\t\t\t\t\trecomputeContext(focusedElement);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\ttextEditorAttachListener.value = focusedElement.onDidChangeEditorAttachState(() => {\n\t\t\t\t\tif (focusedElement.editorAttached) {\n\t\t\t\t\t\trecomputeContext(focusedElement);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\trecomputeContext(focusedElement);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// reset context\n\t\t\tnotebookEditorCursorAtBoundaryContext.set('none');\n\t\t}));\n\n\t\t// update visibleRanges\n\t\tconst updateVisibleRanges = () => {\n\t\t\tif (!this.view.length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst top = this.getViewScrollTop();\n\t\t\tconst bottom = this.getViewScrollBottom();\n\t\t\tif (top >= bottom) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst topViewIndex = clamp(this.view.indexAt(top), 0, this.view.length - 1);\n\t\t\tconst topElement = this.view.element(topViewIndex);\n\t\t\tconst topModelIndex = this._viewModel!.getCellIndex(topElement);\n\t\t\tconst bottomViewIndex = clamp(this.view.indexAt(bottom), 0, this.view.length - 1);\n\t\t\tconst bottomElement = this.view.element(bottomViewIndex);\n\t\t\tconst bottomModelIndex = this._viewModel!.getCellIndex(bottomElement);\n\n\t\t\tif (bottomModelIndex - topModelIndex === bottomViewIndex - topViewIndex) {\n\t\t\t\tthis.visibleRanges = [{ start: topModelIndex, end: bottomModelIndex + 1 }];\n\t\t\t} else {\n\t\t\t\tthis.visibleRanges = this._getVisibleRangesFromIndex(topViewIndex, topModelIndex, bottomViewIndex, bottomModelIndex);\n\t\t\t}\n\t\t};\n\n\t\tthis._localDisposableStore.add(this.view.onDidChangeContentHeight(() => {\n\t\t\tif (this._isInLayout) {\n\t\t\t\tDOM.scheduleAtNextAnimationFrame(DOM.getWindow(container), () => {\n\t\t\t\t\tupdateVisibleRanges();\n\t\t\t\t});\n\t\t\t}\n\t\t\tupdateVisibleRanges();\n\t\t}));\n\t\tthis._localDisposableStore.add(this.view.onDidScroll(() => {\n\t\t\tif (this._isInLayout) {\n\t\t\t\tDOM.scheduleAtNextAnimationFrame(DOM.getWindow(container), () => {\n\t\t\t\t\tupdateVisibleRanges();\n\t\t\t\t});\n\t\t\t}\n\t\t\tupdateVisibleRanges();\n\t\t}));\n\t}\n\n\tprotected override createListView(container: HTMLElement, virtualDelegate: IListVirtualDelegate<CellViewModel>, renderers: IListRenderer<any, any>[], viewOptions: IListViewOptions<CellViewModel>): IListView<CellViewModel> {\n\t\tconst listView = new NotebookCellListView(container, virtualDelegate, renderers, viewOptions);\n\t\tthis.viewZones = new NotebookViewZones(listView, this);\n\t\tthis.cellOverlays = new NotebookCellOverlays(listView);\n\t\treturn listView;\n\t}\n\n\t/**\n\t * Test Only\n\t */\n\t_getView() {\n\t\treturn this.view;\n\t}\n\n\tattachWebview(element: HTMLElement) {\n\t\telement.style.top = `-${NOTEBOOK_WEBVIEW_BOUNDARY}px`;\n\t\tthis.rowsContainer.insertAdjacentElement('afterbegin', element);\n\t\tthis._webviewElement = new FastDomNode<HTMLElement>(element);\n\t}\n\n\telementAt(position: number): ICellViewModel | undefined {\n\t\tif (!this.view.length) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst idx = this.view.indexAt(position);\n\t\tconst clamped = clamp(idx, 0, this.view.length - 1);\n\t\treturn this.element(clamped);\n\t}\n\n\telementHeight(element: ICellViewModel): number {\n\t\tconst index = this._getViewIndexUpperBound(element);\n\t\tif (index === undefined || index < 0 || index >= this.length) {\n\t\t\tthis._getViewIndexUpperBound(element);\n\t\t\tthrow new ListError(this.listUser, `Invalid index ${index}`);\n\t\t}\n\n\t\treturn this.view.elementHeight(index);\n\t}\n\n\tdetachViewModel() {\n\t\tthis._viewModelStore.clear();\n\t\tthis._viewModel = null;\n\t\tthis.hiddenRangesPrefixSum = null;\n\t}\n\n\tattachViewModel(model: NotebookViewModel) {\n\t\tthis._viewModel = model;\n\t\tthis._viewModelStore.add(model.onDidChangeViewCells((e) => {\n\t\t\tif (this._isDisposed) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// update whitespaces which are anchored to the model indexes\n\t\t\tthis.viewZones.onCellsChanged(e);\n\t\t\tthis.cellOverlays.onCellsChanged(e);\n\n\t\t\tconst currentRanges = this._hiddenRangeIds.map(id => this._viewModel!.getTrackedRange(id)).filter(range => range !== null) as ICellRange[];\n\t\t\tconst newVisibleViewCells: CellViewModel[] = getVisibleCells(this._viewModel!.viewCells as CellViewModel[], currentRanges);\n\n\t\t\tconst oldVisibleViewCells: CellViewModel[] = [];\n\t\t\tconst oldViewCellMapping = new Set<string>();\n\t\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\t\toldVisibleViewCells.push(this.element(i));\n\t\t\t\toldViewCellMapping.add(this.element(i).uri.toString());\n\t\t\t}\n\n\t\t\tconst viewDiffs = diff<CellViewModel>(oldVisibleViewCells, newVisibleViewCells, a => {\n\t\t\t\treturn oldViewCellMapping.has(a.uri.toString());\n\t\t\t});\n\n\t\t\tif (e.synchronous) {\n\t\t\t\tthis._updateElementsInWebview(viewDiffs);\n\t\t\t} else {\n\t\t\t\tthis._viewModelStore.add(DOM.scheduleAtNextAnimationFrame(DOM.getWindow(this.rowsContainer), () => {\n\t\t\t\t\tif (this._isDisposed) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._updateElementsInWebview(viewDiffs);\n\t\t\t\t}));\n\t\t\t}\n\t\t}));\n\n\t\tthis._viewModelStore.add(model.onDidChangeSelection((e) => {\n\t\t\tif (e === 'view') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// convert model selections to view selections\n\t\t\tconst viewSelections = cellRangesToIndexes(model.getSelections()).map(index => model.cellAt(index)).filter(cell => !!cell).map(cell => this._getViewIndexUpperBound(cell!));\n\t\t\tthis.setSelection(viewSelections, undefined, true);\n\t\t\tconst primary = cellRangesToIndexes([model.getFocus()]).map(index => model.cellAt(index)).filter(cell => !!cell).map(cell => this._getViewIndexUpperBound(cell!));\n\n\t\t\tif (primary.length) {\n\t\t\t\tthis.setFocus(primary, undefined, true);\n\t\t\t}\n\t\t}));\n\n\t\tconst hiddenRanges = model.getHiddenRanges();\n\t\tthis.setHiddenAreas(hiddenRanges, false);\n\t\tconst newRanges = reduceCellRanges(hiddenRanges);\n\t\tconst viewCells = model.viewCells.slice(0) as CellViewModel[];\n\t\tnewRanges.reverse().forEach(range => {\n\t\t\tconst removedCells = viewCells.splice(range.start, range.end - range.start + 1);\n\t\t\tthis._onDidRemoveCellsFromView.fire(removedCells);\n\t\t});\n\n\t\tthis.splice2(0, 0, viewCells);\n\t}\n\n\tprivate _updateElementsInWebview(viewDiffs: ISplice<CellViewModel>[]) {\n\t\tviewDiffs.reverse().forEach((diff) => {\n\t\t\tconst hiddenOutputs: ICellOutputViewModel[] = [];\n\t\t\tconst deletedOutputs: ICellOutputViewModel[] = [];\n\t\t\tconst removedMarkdownCells: ICellViewModel[] = [];\n\n\t\t\tfor (let i = diff.start; i < diff.start + diff.deleteCount; i++) {\n\t\t\t\tconst cell = this.element(i);\n\t\t\t\tif (cell.cellKind === CellKind.Code) {\n\t\t\t\t\tif (this._viewModel!.hasCell(cell)) {\n\t\t\t\t\t\thiddenOutputs.push(...cell?.outputsViewModels);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdeletedOutputs.push(...cell?.outputsViewModels);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tremovedMarkdownCells.push(cell);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.splice2(diff.start, diff.deleteCount, diff.toInsert);\n\n\t\t\tthis._onDidHideOutputs.fire(hiddenOutputs);\n\t\t\tthis._onDidRemoveOutputs.fire(deletedOutputs);\n\t\t\tthis._onDidRemoveCellsFromView.fire(removedMarkdownCells);\n\t\t});\n\t}\n\n\tclear() {\n\t\tsuper.splice(0, this.length);\n\t}\n\n\tsetHiddenAreas(_ranges: ICellRange[], triggerViewUpdate: boolean): boolean {\n\t\tif (!this._viewModel) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst newRanges = reduceCellRanges(_ranges);\n\t\t// delete old tracking ranges\n\t\tconst oldRanges = this._hiddenRangeIds.map(id => this._viewModel!.getTrackedRange(id)).filter(range => range !== null) as ICellRange[];\n\t\tif (newRanges.length === oldRanges.length) {\n\t\t\tlet hasDifference = false;\n\t\t\tfor (let i = 0; i < newRanges.length; i++) {\n\t\t\t\tif (!(newRanges[i].start === oldRanges[i].start && newRanges[i].end === oldRanges[i].end)) {\n\t\t\t\t\thasDifference = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!hasDifference) {\n\t\t\t\t// they call 'setHiddenAreas' for a reason, even if the ranges are still the same, it's possible that the hiddenRangeSum is not update to date\n\t\t\t\tthis._updateHiddenRangePrefixSum(newRanges);\n\t\t\t\tthis.viewZones.onHiddenRangesChange();\n\t\t\t\tthis.viewZones.layout();\n\t\t\t\tthis.cellOverlays.onHiddenRangesChange();\n\t\t\t\tthis.cellOverlays.layout();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tthis._hiddenRangeIds.forEach(id => this._viewModel!.setTrackedRange(id, null, TrackedRangeStickiness.GrowsOnlyWhenTypingAfter));\n\t\tconst hiddenAreaIds = newRanges.map(range => this._viewModel!.setTrackedRange(null, range, TrackedRangeStickiness.GrowsOnlyWhenTypingAfter)).filter(id => id !== null) as string[];\n\n\t\tthis._hiddenRangeIds = hiddenAreaIds;\n\n\t\t// set hidden ranges prefix sum\n\t\tthis._updateHiddenRangePrefixSum(newRanges);\n\t\t// Update view zone positions after hidden ranges change\n\t\tthis.viewZones.onHiddenRangesChange();\n\t\tthis.cellOverlays.onHiddenRangesChange();\n\n\t\tif (triggerViewUpdate) {\n\t\t\tthis.updateHiddenAreasInView(oldRanges, newRanges);\n\t\t}\n\n\t\tthis.viewZones.layout();\n\t\tthis.cellOverlays.layout();\n\t\treturn true;\n\t}\n\n\tprivate _updateHiddenRangePrefixSum(newRanges: ICellRange[]) {\n\t\tlet start = 0;\n\t\tlet index = 0;\n\t\tconst ret: number[] = [];\n\n\t\twhile (index < newRanges.length) {\n\t\t\tfor (let j = start; j < newRanges[index].start - 1; j++) {\n\t\t\t\tret.push(1);\n\t\t\t}\n\n\t\t\tret.push(newRanges[index].end - newRanges[index].start + 1 + 1);\n\t\t\tstart = newRanges[index].end + 1;\n\t\t\tindex++;\n\t\t}\n\n\t\tfor (let i = start; i < this._viewModel!.length; i++) {\n\t\t\tret.push(1);\n\t\t}\n\n\t\tconst values = new Uint32Array(ret.length);\n\t\tfor (let i = 0; i < ret.length; i++) {\n\t\t\tvalues[i] = ret[i];\n\t\t}\n\n\t\tthis.hiddenRangesPrefixSum = new PrefixSumComputer(values);\n\t}\n\n\t/**\n\t * oldRanges and newRanges are all reduced and sorted.\n\t */\n\tupdateHiddenAreasInView(oldRanges: ICellRange[], newRanges: ICellRange[]) {\n\t\tconst oldViewCellEntries: CellViewModel[] = getVisibleCells(this._viewModel!.viewCells as CellViewModel[], oldRanges);\n\t\tconst oldViewCellMapping = new Set<string>();\n\t\toldViewCellEntries.forEach(cell => {\n\t\t\toldViewCellMapping.add(cell.uri.toString());\n\t\t});\n\n\t\tconst newViewCellEntries: CellViewModel[] = getVisibleCells(this._viewModel!.viewCells as CellViewModel[], newRanges);\n\n\t\tconst viewDiffs = diff<CellViewModel>(oldViewCellEntries, newViewCellEntries, a => {\n\t\t\treturn oldViewCellMapping.has(a.uri.toString());\n\t\t});\n\n\t\tthis._updateElementsInWebview(viewDiffs);\n\t}\n\n\tsplice2(start: number, deleteCount: number, elements: readonly CellViewModel[] = []): void {\n\t\t// we need to convert start and delete count based on hidden ranges\n\t\tif (start < 0 || start > this.view.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst focusInside = DOM.isAncestorOfActiveElement(this.rowsContainer);\n\t\tsuper.splice(start, deleteCount, elements);\n\t\tif (focusInside) {\n\t\t\tthis.domFocus();\n\t\t}\n\n\t\tconst selectionsLeft = [];\n\t\tthis.getSelectedElements().forEach(el => {\n\t\t\tif (this._viewModel!.hasCell(el)) {\n\t\t\t\tselectionsLeft.push(el.handle);\n\t\t\t}\n\t\t});\n\n\t\tif (!selectionsLeft.length && this._viewModel!.viewCells.length) {\n\t\t\t// after splice, the selected cells are deleted\n\t\t\tthis._viewModel!.updateSelectionsState({ kind: SelectionStateType.Index, focus: { start: 0, end: 1 }, selections: [{ start: 0, end: 1 }] });\n\t\t}\n\n\t\tthis.viewZones.layout();\n\t\tthis.cellOverlays.layout();\n\t}\n\n\tgetModelIndex(cell: CellViewModel): number | undefined {\n\t\tconst viewIndex = this.indexOf(cell);\n\t\treturn this.getModelIndex2(viewIndex);\n\t}\n\n\tgetModelIndex2(viewIndex: number): number | undefined {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn viewIndex;\n\t\t}\n\n\t\tconst modelIndex = this.hiddenRangesPrefixSum.getPrefixSum(viewIndex - 1);\n\t\treturn modelIndex;\n\t}\n\n\tgetViewIndex(cell: ICellViewModel) {\n\t\tconst modelIndex = this._viewModel!.getCellIndex(cell);\n\t\treturn this.getViewIndex2(modelIndex);\n\t}\n\n\tgetViewIndex2(modelIndex: number): number | undefined {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn modelIndex;\n\t\t}\n\n\t\tconst viewIndexInfo = this.hiddenRangesPrefixSum.getIndexOf(modelIndex);\n\n\t\tif (viewIndexInfo.remainder !== 0) {\n\t\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t\t// it's already after the last hidden range\n\t\t\t\treturn modelIndex - (this.hiddenRangesPrefixSum.getTotalSum() - this.hiddenRangesPrefixSum.getCount());\n\t\t\t}\n\t\t\treturn undefined;\n\t\t} else {\n\t\t\treturn viewIndexInfo.index;\n\t\t}\n\t}\n\n\tconvertModelIndexToViewIndex(modelIndex: number): number {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn modelIndex;\n\t\t}\n\n\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t// it's already after the last hidden range\n\t\t\treturn Math.min(this.length, this.hiddenRangesPrefixSum.getTotalSum());\n\t\t}\n\n\t\treturn this.hiddenRangesPrefixSum.getIndexOf(modelIndex).index;\n\t}\n\n\tmodelIndexIsVisible(modelIndex: number): boolean {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst viewIndexInfo = this.hiddenRangesPrefixSum.getIndexOf(modelIndex);\n\t\tif (viewIndexInfo.remainder !== 0) {\n\t\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t\t// it's already after the last hidden range\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tprivate _getVisibleRangesFromIndex(topViewIndex: number, topModelIndex: number, bottomViewIndex: number, bottomModelIndex: number) {\n\t\tconst stack: number[] = [];\n\t\tconst ranges: ICellRange[] = [];\n\t\t// there are hidden ranges\n\t\tlet index = topViewIndex;\n\t\tlet modelIndex = topModelIndex;\n\n\t\twhile (index <= bottomViewIndex) {\n\t\t\tconst accu = this.hiddenRangesPrefixSum!.getPrefixSum(index);\n\t\t\tif (accu === modelIndex + 1) {\n\t\t\t\t// no hidden area after it\n\t\t\t\tif (stack.length) {\n\t\t\t\t\tif (stack[stack.length - 1] === modelIndex - 1) {\n\t\t\t\t\t\tranges.push({ start: stack[stack.length - 1], end: modelIndex + 1 });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tranges.push({ start: stack[stack.length - 1], end: stack[stack.length - 1] + 1 });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tstack.push(modelIndex);\n\t\t\t\tindex++;\n\t\t\t\tmodelIndex++;\n\t\t\t} else {\n\t\t\t\t// there are hidden ranges after it\n\t\t\t\tif (stack.length) {\n\t\t\t\t\tif (stack[stack.length - 1] === modelIndex - 1) {\n\t\t\t\t\t\tranges.push({ start: stack[stack.length - 1], end: modelIndex + 1 });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tranges.push({ start: stack[stack.length - 1], end: stack[stack.length - 1] + 1 });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tstack.push(modelIndex);\n\t\t\t\tindex++;\n\t\t\t\tmodelIndex = accu;\n\t\t\t}\n\t\t}\n\n\t\tif (stack.length) {\n\t\t\tranges.push({ start: stack[stack.length - 1], end: stack[stack.length - 1] + 1 });\n\t\t}\n\n\t\treturn reduceCellRanges(ranges);\n\t}\n\n\tgetVisibleRangesPlusViewportAboveAndBelow() {\n\t\tif (this.view.length <= 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst top = Math.max(this.getViewScrollTop() - this.renderHeight, 0);\n\t\tconst topViewIndex = this.view.indexAt(top);\n\t\tconst topElement = this.view.element(topViewIndex);\n\t\tconst topModelIndex = this._viewModel!.getCellIndex(topElement);\n\t\tconst bottom = clamp(this.getViewScrollBottom() + this.renderHeight, 0, this.scrollHeight);\n\t\tconst bottomViewIndex = clamp(this.view.indexAt(bottom), 0, this.view.length - 1);\n\t\tconst bottomElement = this.view.element(bottomViewIndex);\n\t\tconst bottomModelIndex = this._viewModel!.getCellIndex(bottomElement);\n\n\t\tif (bottomModelIndex - topModelIndex === bottomViewIndex - topViewIndex) {\n\t\t\treturn [{ start: topModelIndex, end: bottomModelIndex }];\n\t\t} else {\n\t\t\treturn this._getVisibleRangesFromIndex(topViewIndex, topModelIndex, bottomViewIndex, bottomModelIndex);\n\t\t}\n\t}\n\n\tprivate _getViewIndexUpperBound(cell: ICellViewModel): number {\n\t\tif (!this._viewModel) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tconst modelIndex = this._viewModel.getCellIndex(cell);\n\t\tif (modelIndex === -1) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn modelIndex;\n\t\t}\n\n\t\tconst viewIndexInfo = this.hiddenRangesPrefixSum.getIndexOf(modelIndex);\n\n\t\tif (viewIndexInfo.remainder !== 0) {\n\t\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t\treturn modelIndex - (this.hiddenRangesPrefixSum.getTotalSum() - this.hiddenRangesPrefixSum.getCount());\n\t\t\t}\n\t\t}\n\n\t\treturn viewIndexInfo.index;\n\t}\n\n\tprivate _getViewIndexUpperBound2(modelIndex: number) {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn modelIndex;\n\t\t}\n\n\t\tconst viewIndexInfo = this.hiddenRangesPrefixSum.getIndexOf(modelIndex);\n\n\t\tif (viewIndexInfo.remainder !== 0) {\n\t\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t\treturn modelIndex - (this.hiddenRangesPrefixSum.getTotalSum() - this.hiddenRangesPrefixSum.getCount());\n\t\t\t}\n\t\t}\n\n\t\treturn viewIndexInfo.index;\n\t}\n\n\tfocusElement(cell: ICellViewModel) {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\n\t\tif (index >= 0 && this._viewModel) {\n\t\t\t// update view model first, which will update both `focus` and `selection` in a single transaction\n\t\t\tconst focusedElementHandle = this.element(index).handle;\n\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\tprimary: focusedElementHandle,\n\t\t\t\tselections: [focusedElementHandle]\n\t\t\t}, 'view');\n\n\t\t\t// update the view as previous model update will not trigger event\n\t\t\tthis.setFocus([index], undefined, false);\n\t\t}\n\t}\n\n\tselectElements(elements: ICellViewModel[]) {\n\t\tconst indices = elements.map(cell => this._getViewIndexUpperBound(cell)).filter(index => index >= 0);\n\t\tthis.setSelection(indices);\n\t}\n\n\tgetCellViewScrollTop(cell: ICellViewModel) {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\t\tif (index === undefined || index < 0 || index >= this.length) {\n\t\t\tthrow new ListError(this.listUser, `Invalid index ${index}`);\n\t\t}\n\n\t\treturn this.view.elementTop(index);\n\t}\n\n\tgetCellViewScrollBottom(cell: ICellViewModel) {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\t\tif (index === undefined || index < 0 || index >= this.length) {\n\t\t\tthrow new ListError(this.listUser, `Invalid index ${index}`);\n\t\t}\n\n\t\tconst top = this.view.elementTop(index);\n\t\tconst height = this.view.elementHeight(index);\n\t\treturn top + height;\n\t}\n\n\toverride setFocus(indexes: number[], browserEvent?: UIEvent, ignoreTextModelUpdate?: boolean): void {\n\t\tif (ignoreTextModelUpdate) {\n\t\t\tsuper.setFocus(indexes, browserEvent);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!indexes.length) {\n\t\t\tif (this._viewModel) {\n\t\t\t\tif (this.length) {\n\t\t\t\t\t// Don't allow clearing focus, #121129\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\t\tprimary: null,\n\t\t\t\t\tselections: []\n\t\t\t\t}, 'view');\n\t\t\t}\n\t\t} else {\n\t\t\tif (this._viewModel) {\n\t\t\t\tconst focusedElementHandle = this.element(indexes[0]).handle;\n\t\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\t\tprimary: focusedElementHandle,\n\t\t\t\t\tselections: this.getSelection().map(selection => this.element(selection).handle)\n\t\t\t\t}, 'view');\n\t\t\t}\n\t\t}\n\n\t\tsuper.setFocus(indexes, browserEvent);\n\t}\n\n\toverride setSelection(indexes: number[], browserEvent?: UIEvent | undefined, ignoreTextModelUpdate?: boolean) {\n\t\tif (ignoreTextModelUpdate) {\n\t\t\tsuper.setSelection(indexes, browserEvent);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!indexes.length) {\n\t\t\tif (this._viewModel) {\n\t\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\t\tprimary: this.getFocusedElements()[0]?.handle ?? null,\n\t\t\t\t\tselections: []\n\t\t\t\t}, 'view');\n\t\t\t}\n\t\t} else {\n\t\t\tif (this._viewModel) {\n\t\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\t\tprimary: this.getFocusedElements()[0]?.handle ?? null,\n\t\t\t\t\tselections: indexes.map(index => this.element(index)).map(cell => cell.handle)\n\t\t\t\t}, 'view');\n\t\t\t}\n\t\t}\n\n\t\tsuper.setSelection(indexes, browserEvent);\n\t}\n\n\t/**\n\t * The range will be revealed with as little scrolling as possible.\n\t */\n\trevealCells(range: ICellRange) {\n\t\tconst startIndex = this._getViewIndexUpperBound2(range.start);\n\n\t\tif (startIndex < 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst endIndex = this._getViewIndexUpperBound2(range.end - 1);\n\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst elementTop = this.view.elementTop(startIndex);\n\t\tif (elementTop >= scrollTop\n\t\t\t&& elementTop < wrapperBottom) {\n\t\t\t// start element is visible\n\t\t\t// check end\n\n\t\t\tconst endElementTop = this.view.elementTop(endIndex);\n\t\t\tconst endElementHeight = this.view.elementHeight(endIndex);\n\n\t\t\tif (endElementTop + endElementHeight <= wrapperBottom) {\n\t\t\t\t// fully visible\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (endElementTop >= wrapperBottom) {\n\t\t\t\treturn this._revealInternal(endIndex, false, CellRevealPosition.Bottom);\n\t\t\t}\n\n\t\t\tif (endElementTop < wrapperBottom) {\n\t\t\t\t// end element partially visible\n\t\t\t\tif (endElementTop + endElementHeight - wrapperBottom < elementTop - scrollTop) {\n\t\t\t\t\t// there is enough space to just scroll up a little bit to make the end element visible\n\t\t\t\t\treturn this.view.setScrollTop(scrollTop + endElementTop + endElementHeight - wrapperBottom);\n\t\t\t\t} else {\n\t\t\t\t\t// don't even try it\n\t\t\t\t\treturn this._revealInternal(startIndex, false, CellRevealPosition.Top);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._revealInViewWithMinimalScrolling(startIndex);\n\t}\n\n\tprivate _revealInViewWithMinimalScrolling(viewIndex: number, firstLine?: boolean) {\n\t\tconst firstIndex = this.view.firstMostlyVisibleIndex;\n\t\tconst elementHeight = this.view.elementHeight(viewIndex);\n\n\t\tif (viewIndex <= firstIndex || (!firstLine && elementHeight >= this.view.renderHeight)) {\n\t\t\tthis._revealInternal(viewIndex, true, CellRevealPosition.Top);\n\t\t} else {\n\t\t\tthis._revealInternal(viewIndex, true, CellRevealPosition.Bottom, firstLine);\n\t\t}\n\t}\n\n\tscrollToBottom() {\n\t\tconst scrollHeight = this.view.scrollHeight;\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\n\t\tthis.view.setScrollTop(scrollHeight - (wrapperBottom - scrollTop));\n\t}\n\n\t/**\n\t * Reveals the given cell in the notebook cell list. The cell will come into view syncronously\n\t * but the cell's editor will be attached asyncronously if it was previously out of view.\n\t * @returns The promise to await for the cell editor to be attached\n\t */\n\tasync revealCell(cell: ICellViewModel, revealType: CellRevealType): Promise<void> {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\n\t\tif (index < 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (revealType) {\n\t\t\tcase CellRevealType.Top:\n\t\t\t\tthis._revealInternal(index, false, CellRevealPosition.Top);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.Center:\n\t\t\t\tthis._revealInternal(index, false, CellRevealPosition.Center);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.CenterIfOutsideViewport:\n\t\t\t\tthis._revealInternal(index, true, CellRevealPosition.Center);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.NearTopIfOutsideViewport:\n\t\t\t\tthis._revealInternal(index, true, CellRevealPosition.NearTop);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.FirstLineIfOutsideViewport:\n\t\t\t\tthis._revealInViewWithMinimalScrolling(index, true);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.Default:\n\t\t\t\tthis._revealInViewWithMinimalScrolling(index);\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif ((\n\t\t\t// wait for the editor to be created if the cell is in editing mode\n\t\t\tcell.getEditState() === CellEditState.Editing\n\t\t\t// wait for the editor to be created if we are revealing the first line of the cell\n\t\t\t|| (revealType === CellRevealType.FirstLineIfOutsideViewport && cell.cellKind === CellKind.Code)\n\t\t) && !cell.editorAttached) {\n\t\t\treturn getEditorAttachedPromise(cell);\n\t\t}\n\n\t\treturn;\n\t}\n\n\tprivate _revealInternal(viewIndex: number, ignoreIfInsideViewport: boolean, revealPosition: CellRevealPosition, firstLine?: boolean) {\n\t\tif (viewIndex >= this.view.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst elementBottom = this.view.elementHeight(viewIndex) + elementTop;\n\n\t\tif (ignoreIfInsideViewport) {\n\t\t\tif (elementTop >= scrollTop && elementBottom < wrapperBottom) {\n\t\t\t\t// element is already fully visible\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tswitch (revealPosition) {\n\t\t\tcase CellRevealPosition.Top:\n\t\t\t\tthis.view.setScrollTop(elementTop);\n\t\t\t\tthis.view.setScrollTop(this.view.elementTop(viewIndex));\n\t\t\t\tbreak;\n\t\t\tcase CellRevealPosition.Center:\n\t\t\tcase CellRevealPosition.NearTop:\n\t\t\t\t{\n\t\t\t\t\t// reveal the cell top in the viewport center initially\n\t\t\t\t\tthis.view.setScrollTop(elementTop - this.view.renderHeight / 2);\n\t\t\t\t\t// cell rendered already, we now have a more accurate cell height\n\t\t\t\t\tconst newElementTop = this.view.elementTop(viewIndex);\n\t\t\t\t\tconst newElementHeight = this.view.elementHeight(viewIndex);\n\t\t\t\t\tconst renderHeight = this.getViewScrollBottom() - this.getViewScrollTop();\n\t\t\t\t\tif (newElementHeight >= renderHeight) {\n\t\t\t\t\t\t// cell is larger than viewport, reveal top\n\t\t\t\t\t\tthis.view.setScrollTop(newElementTop);\n\t\t\t\t\t} else if (revealPosition === CellRevealPosition.Center) {\n\t\t\t\t\t\tthis.view.setScrollTop(newElementTop + (newElementHeight / 2) - (renderHeight / 2));\n\t\t\t\t\t} else if (revealPosition === CellRevealPosition.NearTop) {\n\t\t\t\t\t\tthis.view.setScrollTop(newElementTop - (renderHeight / 5));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase CellRevealPosition.Bottom:\n\t\t\t\tif (firstLine) {\n\t\t\t\t\tconst lineHeight = this.viewModel?.layoutInfo?.fontInfo.lineHeight ?? 15;\n\t\t\t\t\tconst padding = this.notebookOptions.getLayoutConfiguration().cellTopMargin + this.notebookOptions.getLayoutConfiguration().editorTopPadding;\n\t\t\t\t\tconst firstLineLocation = elementTop + lineHeight + padding;\n\t\t\t\t\tif (firstLineLocation < wrapperBottom) {\n\t\t\t\t\t\t// first line is already visible\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.view.setScrollTop(this.scrollTop + (firstLineLocation - wrapperBottom));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tthis.view.setScrollTop(this.scrollTop + (elementBottom - wrapperBottom));\n\t\t\t\tthis.view.setScrollTop(this.scrollTop + (this.view.elementTop(viewIndex) + this.view.elementHeight(viewIndex) - this.getViewScrollBottom()));\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\t//#region Reveal Cell Editor Range asynchronously\n\tasync revealRangeInCell(cell: ICellViewModel, range: Selection | Range, revealType: CellRevealRangeType): Promise<void> {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\n\t\tif (index < 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (revealType) {\n\t\t\tcase CellRevealRangeType.Default:\n\t\t\t\treturn this._revealRangeInternalAsync(index, range);\n\t\t\tcase CellRevealRangeType.Center:\n\t\t\t\treturn this._revealRangeInCenterInternalAsync(index, range);\n\t\t\tcase CellRevealRangeType.CenterIfOutsideViewport:\n\t\t\t\treturn this._revealRangeInCenterIfOutsideViewportInternalAsync(index, range);\n\t\t}\n\t}\n\n\t// List items have real dynamic heights, which means after we set `scrollTop` based on the `elementTop(index)`, the element at `index` might still be removed from the view once all relayouting tasks are done.\n\t// For example, we scroll item 10 into the view upwards, in the first round, items 7, 8, 9, 10 are all in the viewport. Then item 7 and 8 resize themselves to be larger and finally item 10 is removed from the view.\n\t// To ensure that item 10 is always there, we need to scroll item 10 to the top edge of the viewport.\n\tprivate async _revealRangeInternalAsync(viewIndex: number, range: Selection | Range): Promise<void> {\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst element = this.view.element(viewIndex);\n\n\t\tif (element.editorAttached) {\n\t\t\tthis._revealRangeCommon(viewIndex, range);\n\t\t} else {\n\t\t\tconst elementHeight = this.view.elementHeight(viewIndex);\n\t\t\tlet alignHint: 'top' | 'bottom' | undefined = undefined;\n\n\t\t\tif (elementTop + elementHeight <= scrollTop) {\n\t\t\t\t// scroll up\n\t\t\t\tthis.view.setScrollTop(elementTop);\n\t\t\t\talignHint = 'top';\n\t\t\t} else if (elementTop >= wrapperBottom) {\n\t\t\t\t// scroll down\n\t\t\t\tthis.view.setScrollTop(elementTop - this.view.renderHeight / 2);\n\t\t\t\talignHint = 'bottom';\n\t\t\t}\n\n\t\t\tconst editorAttachedPromise = new Promise<void>((resolve, reject) => {\n\t\t\t\tEvent.once(element.onDidChangeEditorAttachState)(() => {\n\t\t\t\t\telement.editorAttached ? resolve() : reject();\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn editorAttachedPromise.then(() => {\n\t\t\t\tthis._revealRangeCommon(viewIndex, range, alignHint);\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate async _revealRangeInCenterInternalAsync(viewIndex: number, range: Selection | Range): Promise<void> {\n\t\tconst reveal = (viewIndex: number, range: Range) => {\n\t\t\tconst element = this.view.element(viewIndex);\n\t\t\tconst positionOffset = element.getPositionScrollTopOffset(range);\n\t\t\tconst positionOffsetInView = this.view.elementTop(viewIndex) + positionOffset;\n\t\t\tthis.view.setScrollTop(positionOffsetInView - this.view.renderHeight / 2);\n\t\t\telement.revealRangeInCenter(range);\n\t\t};\n\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst viewItemOffset = elementTop;\n\t\tthis.view.setScrollTop(viewItemOffset - this.view.renderHeight / 2);\n\t\tconst element = this.view.element(viewIndex);\n\n\t\tif (!element.editorAttached) {\n\t\t\treturn getEditorAttachedPromise(element).then(() => reveal(viewIndex, range));\n\t\t} else {\n\t\t\treveal(viewIndex, range);\n\t\t}\n\t}\n\n\tprivate async _revealRangeInCenterIfOutsideViewportInternalAsync(viewIndex: number, range: Selection | Range): Promise<void> {\n\t\tconst reveal = (viewIndex: number, range: Range) => {\n\t\t\tconst element = this.view.element(viewIndex);\n\t\t\tconst positionOffset = element.getPositionScrollTopOffset(range);\n\t\t\tconst positionOffsetInView = this.view.elementTop(viewIndex) + positionOffset;\n\t\t\tthis.view.setScrollTop(positionOffsetInView - this.view.renderHeight / 2);\n\n\t\t\telement.revealRangeInCenter(range);\n\t\t};\n\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst viewItemOffset = elementTop;\n\t\tconst element = this.view.element(viewIndex);\n\t\tconst positionOffset = viewItemOffset + element.getPositionScrollTopOffset(range);\n\n\t\tif (positionOffset < scrollTop || positionOffset > wrapperBottom) {\n\t\t\t// let it render\n\t\t\tthis.view.setScrollTop(positionOffset - this.view.renderHeight / 2);\n\n\t\t\t// after rendering, it might be pushed down due to markdown cell dynamic height\n\t\t\tconst newPositionOffset = this.view.elementTop(viewIndex) + element.getPositionScrollTopOffset(range);\n\t\t\tthis.view.setScrollTop(newPositionOffset - this.view.renderHeight / 2);\n\n\t\t\t// reveal editor\n\t\t\tif (!element.editorAttached) {\n\t\t\t\treturn getEditorAttachedPromise(element).then(() => reveal(viewIndex, range));\n\t\t\t} else {\n\t\t\t\t// for example markdown\n\t\t\t}\n\t\t} else {\n\t\t\tif (element.editorAttached) {\n\t\t\t\telement.revealRangeInCenter(range);\n\t\t\t} else {\n\t\t\t\t// for example, markdown cell in preview mode\n\t\t\t\treturn getEditorAttachedPromise(element).then(() => reveal(viewIndex, range));\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _revealRangeCommon(viewIndex: number, range: Selection | Range, alignHint?: 'top' | 'bottom' | undefined) {\n\t\tconst element = this.view.element(viewIndex);\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst positionOffset = element.getPositionScrollTopOffset(range);\n\t\tconst elementOriginalHeight = this.view.elementHeight(viewIndex);\n\t\tif (positionOffset >= elementOriginalHeight) {\n\t\t\t// we are revealing a range that is beyond current element height\n\t\t\t// if we don't update the element height now, and directly `setTop` to reveal the range\n\t\t\t// the element might be scrolled out of view\n\t\t\t// next frame, when we update the element height, the element will never be scrolled back into view\n\t\t\tconst newTotalHeight = element.layoutInfo.totalHeight;\n\t\t\tthis.updateElementHeight(viewIndex, newTotalHeight);\n\t\t}\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst positionTop = elementTop + positionOffset;\n\n\t\t// TODO@rebornix 30 ---> line height * 1.5\n\t\tif (positionTop < scrollTop) {\n\t\t\tthis.view.setScrollTop(positionTop - 30);\n\t\t} else if (positionTop > wrapperBottom) {\n\t\t\tthis.view.setScrollTop(scrollTop + positionTop - wrapperBottom + 30);\n\t\t} else if (alignHint === 'bottom') {\n\t\t\t// Scrolled into view from below\n\t\t\tthis.view.setScrollTop(scrollTop + positionTop - wrapperBottom + 30);\n\t\t} else if (alignHint === 'top') {\n\t\t\t// Scrolled into view from above\n\t\t\tthis.view.setScrollTop(positionTop - 30);\n\t\t}\n\t}\n\t//#endregion\n\n\n\n\t/**\n\t * Reveals the specified offset of the given cell in the center of the viewport.\n\t * This enables revealing locations in the output as well as the input.\n\t */\n\trevealCellOffsetInCenter(cell: ICellViewModel, offset: number) {\n\t\tconst viewIndex = this._getViewIndexUpperBound(cell);\n\n\t\tif (viewIndex >= 0) {\n\t\t\tconst element = this.view.element(viewIndex);\n\t\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\t\tif (element instanceof MarkupCellViewModel) {\n\t\t\t\treturn this._revealInCenterIfOutsideViewport(viewIndex);\n\t\t\t} else {\n\t\t\t\tconst rangeOffset = element.layoutInfo.outputContainerOffset + Math.min(offset, element.layoutInfo.outputTotalHeight);\n\t\t\t\tthis.view.setScrollTop(elementTop - this.view.renderHeight / 2);\n\t\t\t\tthis.view.setScrollTop(elementTop + rangeOffset - this.view.renderHeight / 2);\n\t\t\t}\n\t\t}\n\t}\n\n\trevealOffsetInCenterIfOutsideViewport(offset: number) {\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\n\t\tif (offset < scrollTop || offset > wrapperBottom) {\n\t\t\tconst newTop = Math.max(0, offset - this.view.renderHeight / 2);\n\t\t\tthis.view.setScrollTop(newTop);\n\t\t}\n\t}\n\n\tprivate _revealInCenterIfOutsideViewport(viewIndex: number) {\n\t\tthis._revealInternal(viewIndex, true, CellRevealPosition.Center);\n\t}\n\n\tdomElementOfElement(element: ICellViewModel): HTMLElement | null {\n\t\tconst index = this._getViewIndexUpperBound(element);\n\t\tif (index >= 0 && index < this.length) {\n\t\t\treturn this.view.domElement(index);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tfocusView() {\n\t\tthis.view.domNode.focus();\n\t}\n\n\ttriggerScrollFromMouseWheelEvent(browserEvent: IMouseWheelEvent) {\n\t\tthis.view.delegateScrollFromMouseWheelEvent(browserEvent);\n\t}\n\n\tdelegateVerticalScrollbarPointerDown(browserEvent: PointerEvent) {\n\t\tthis.view.delegateVerticalScrollbarPointerDown(browserEvent);\n\t}\n\n\tprivate isElementAboveViewport(index: number) {\n\t\tconst elementTop = this.view.elementTop(index);\n\t\tconst elementBottom = elementTop + this.view.elementHeight(index);\n\n\t\treturn elementBottom < this.scrollTop;\n\t}\n\n\tupdateElementHeight2(element: ICellViewModel, size: number, anchorElementIndex: number | null = null): void {\n\t\tconst index = this._getViewIndexUpperBound(element);\n\t\tif (index === undefined || index < 0 || index >= this.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isElementAboveViewport(index)) {\n\t\t\t// update element above viewport\n\t\t\tconst oldHeight = this.elementHeight(element);\n\t\t\tconst delta = oldHeight - size;\n\t\t\tif (this._webviewElement) {\n\t\t\t\tEvent.once(this.view.onWillScroll)(() => {\n\t\t\t\t\tconst webviewTop = parseInt(this._webviewElement!.domNode.style.top, 10);\n\t\t\t\t\tif (validateWebviewBoundary(this._webviewElement!.domNode)) {\n\t\t\t\t\t\tthis._webviewElement!.setTop(webviewTop - delta);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// When the webview top boundary is below the list view scrollable element top boundary, then we can't insert a markdown cell at the top\n\t\t\t\t\t\t// or when its bottom boundary is above the list view bottom boundary, then we can't insert a markdown cell at the end\n\t\t\t\t\t\t// thus we have to revert the webview element position to initial state `-NOTEBOOK_WEBVIEW_BOUNDARY`.\n\t\t\t\t\t\t// this will trigger one visual flicker (as we need to update element offsets in the webview)\n\t\t\t\t\t\t// but as long as NOTEBOOK_WEBVIEW_BOUNDARY is large enough, it will happen less often\n\t\t\t\t\t\tthis._webviewElement!.setTop(-NOTEBOOK_WEBVIEW_BOUNDARY);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.view.updateElementHeight(index, size, anchorElementIndex);\n\t\t\tthis.viewZones.layout();\n\t\t\tthis.cellOverlays.layout();\n\t\t\treturn;\n\t\t}\n\n\t\tif (anchorElementIndex !== null) {\n\t\t\tthis.view.updateElementHeight(index, size, anchorElementIndex);\n\t\t\tthis.viewZones.layout();\n\t\t\tthis.cellOverlays.layout();\n\t\t\treturn;\n\t\t}\n\n\t\tconst focused = this.getFocus();\n\t\tconst focus = focused.length ? focused[0] : null;\n\n\t\tif (focus) {\n\t\t\t// If the cell is growing, we should favor anchoring to the focused cell\n\t\t\tconst heightDelta = size - this.view.elementHeight(index);\n\n\t\t\tif (this._notebookCellAnchor.shouldAnchor(this.view, focus, heightDelta, this.element(index))) {\n\t\t\t\tthis.view.updateElementHeight(index, size, focus);\n\t\t\t\tthis.viewZones.layout();\n\t\t\t\tthis.cellOverlays.layout();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.view.updateElementHeight(index, size, null);\n\t\tthis.viewZones.layout();\n\t\tthis.cellOverlays.layout();\n\t\treturn;\n\t}\n\n\tchangeViewZones(callback: (accessor: INotebookViewZoneChangeAccessor) => void): void {\n\t\tif (this.viewZones.changeViewZones(callback)) {\n\t\t\tthis.viewZones.layout();\n\t\t}\n\t}\n\n\tchangeCellOverlays(callback: (accessor: INotebookCellOverlayChangeAccessor) => void): void {\n\t\tif (this.cellOverlays.changeCellOverlays(callback)) {\n\t\t\tthis.cellOverlays.layout();\n\t\t}\n\t}\n\n\tgetViewZoneLayoutInfo(viewZoneId: string): { height: number; top: number } | null {\n\t\treturn this.viewZones.getViewZoneLayoutInfo(viewZoneId);\n\t}\n\n\t// override\n\toverride domFocus() {\n\t\tconst focused = this.getFocusedElements()[0];\n\t\tconst focusedDomElement = focused && this.domElementOfElement(focused);\n\n\t\tif (this.view.domNode.ownerDocument.activeElement && focusedDomElement && focusedDomElement.contains(this.view.domNode.ownerDocument.activeElement)) {\n\t\t\t// for example, when focus goes into monaco editor, if we refocus the list view, the editor will lose focus.\n\t\t\treturn;\n\t\t}\n\n\t\tif (!isMacintosh && this.view.domNode.ownerDocument.activeElement && !!DOM.findParentWithClass(<HTMLElement>this.view.domNode.ownerDocument.activeElement, 'context-view')) {\n\t\t\treturn;\n\t\t}\n\n\t\tsuper.domFocus();\n\t}\n\n\tfocusContainer(clearSelection: boolean) {\n\t\tif (clearSelection) {\n\t\t\t// allow focus to be between cells\n\t\t\tthis._viewModel?.updateSelectionsState({\n\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\tprimary: null,\n\t\t\t\tselections: []\n\t\t\t}, 'view');\n\t\t\tthis.setFocus([], undefined, true);\n\t\t\tthis.setSelection([], undefined, true);\n\t\t}\n\n\t\tsuper.domFocus();\n\t}\n\n\tgetViewScrollTop() {\n\t\treturn this.view.getScrollTop();\n\t}\n\n\tgetViewScrollBottom() {\n\t\treturn this.getViewScrollTop() + this.view.renderHeight;\n\t}\n\n\tsetCellEditorSelection(cell: ICellViewModel, range: Range) {\n\t\tconst element = cell as CellViewModel;\n\t\tif (element.editorAttached) {\n\t\t\telement.setSelection(range);\n\t\t} else {\n\t\t\tgetEditorAttachedPromise(element).then(() => { element.setSelection(range); });\n\t\t}\n\t}\n\n\toverride style(styles: IListStyles) {\n\t\tconst selectorSuffix = this.view.domId;\n\t\tif (!this.styleElement) {\n\t\t\tthis.styleElement = domStylesheetsJs.createStyleSheet(this.view.domNode);\n\t\t}\n\t\tconst suffix = selectorSuffix && `.${selectorSuffix}`;\n\t\tconst content: string[] = [];\n\n\t\tif (styles.listBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows { background: ${styles.listBackground}; }`);\n\t\t}\n\n\t\tif (styles.listFocusBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { background-color: ${styles.listFocusBackground}; }`);\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused:hover { background-color: ${styles.listFocusBackground}; }`); // overwrite :hover style in this case!\n\t\t}\n\n\t\tif (styles.listFocusForeground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { color: ${styles.listFocusForeground}; }`);\n\t\t}\n\n\t\tif (styles.listActiveSelectionBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { background-color: ${styles.listActiveSelectionBackground}; }`);\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected:hover { background-color: ${styles.listActiveSelectionBackground}; }`); // overwrite :hover style in this case!\n\t\t}\n\n\t\tif (styles.listActiveSelectionForeground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { color: ${styles.listActiveSelectionForeground}; }`);\n\t\t}\n\n\t\tif (styles.listFocusAndSelectionBackground) {\n\t\t\tcontent.push(`\n\t\t\t\t.monaco-drag-image${suffix},\n\t\t\t\t.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected.focused { background-color: ${styles.listFocusAndSelectionBackground}; }\n\t\t\t`);\n\t\t}\n\n\t\tif (styles.listFocusAndSelectionForeground) {\n\t\t\tcontent.push(`\n\t\t\t\t.monaco-drag-image${suffix},\n\t\t\t\t.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected.focused { color: ${styles.listFocusAndSelectionForeground}; }\n\t\t\t`);\n\t\t}\n\n\t\tif (styles.listInactiveFocusBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { background-color:  ${styles.listInactiveFocusBackground}; }`);\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused:hover { background-color:  ${styles.listInactiveFocusBackground}; }`); // overwrite :hover style in this case!\n\t\t}\n\n\t\tif (styles.listInactiveSelectionBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { background-color:  ${styles.listInactiveSelectionBackground}; }`);\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected:hover { background-color:  ${styles.listInactiveSelectionBackground}; }`); // overwrite :hover style in this case!\n\t\t}\n\n\t\tif (styles.listInactiveSelectionForeground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { color: ${styles.listInactiveSelectionForeground}; }`);\n\t\t}\n\n\t\tif (styles.listHoverBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:not(.drop-target) > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row:hover:not(.selected):not(.focused) { background-color:  ${styles.listHoverBackground}; }`);\n\t\t}\n\n\t\tif (styles.listHoverForeground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row:hover:not(.selected):not(.focused) { color:  ${styles.listHoverForeground}; }`);\n\t\t}\n\n\t\tif (styles.listSelectionOutline) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { outline: 1px dotted ${styles.listSelectionOutline}; outline-offset: -1px; }`);\n\t\t}\n\n\t\tif (styles.listFocusOutline) {\n\t\t\tcontent.push(`\n\t\t\t\t.monaco-drag-image${suffix},\n\t\t\t\t.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { outline: 1px solid ${styles.listFocusOutline}; outline-offset: -1px; }\n\t\t\t`);\n\t\t}\n\n\t\tif (styles.listInactiveFocusOutline) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { outline: 1px dotted ${styles.listInactiveFocusOutline}; outline-offset: -1px; }`);\n\t\t}\n\n\t\tif (styles.listHoverOutline) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row:hover { outline: 1px dashed ${styles.listHoverOutline}; outline-offset: -1px; }`);\n\t\t}\n\n\t\tif (styles.listDropOverBackground) {\n\t\t\tcontent.push(`\n\t\t\t\t.monaco-list${suffix}.drop-target,\n\t\t\t\t.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows.drop-target,\n\t\t\t\t.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-row.drop-target { background-color: ${styles.listDropOverBackground} !important; color: inherit !important; }\n\t\t\t`);\n\t\t}\n\n\t\tconst newStyles = content.join('\\n');\n\t\tif (newStyles !== this.styleElement.textContent) {\n\t\t\tthis.styleElement.textContent = newStyles;\n\t\t}\n\t}\n\n\tgetRenderHeight() {\n\t\treturn this.view.renderHeight;\n\t}\n\n\tgetScrollHeight() {\n\t\treturn this.view.scrollHeight;\n\t}\n\n\toverride layout(height?: number, width?: number): void {\n\t\tthis._isInLayout = true;\n\t\tsuper.layout(height, width);\n\t\tif (this.renderHeight === 0) {\n\t\t\tthis.view.domNode.style.visibility = 'hidden';\n\t\t} else {\n\t\t\tthis.view.domNode.style.visibility = 'initial';\n\t\t}\n\t\tthis._isInLayout = false;\n\t}\n\n\toverride dispose() {\n\t\tthis._isDisposed = true;\n\t\tthis._viewModelStore.dispose();\n\t\tthis._localDisposableStore.dispose();\n\t\tthis._notebookCellAnchor.dispose();\n\t\tthis.viewZones.dispose();\n\t\tthis.cellOverlays.dispose();\n\t\tsuper.dispose();\n\n\t\t// un-ref\n\t\tthis._previousFocusedElements = [];\n\t\tthis._viewModel = null;\n\t\tthis._hiddenRangeIds = [];\n\t\tthis.hiddenRangesPrefixSum = null;\n\t\tthis._visibleRanges = [];\n\t}\n}\n\n\nexport class ListViewInfoAccessor extends Disposable {\n\tconstructor(\n\t\treadonly list: INotebookCellList\n\t) {\n\t\tsuper();\n\t}\n\n\tgetViewIndex(cell: ICellViewModel): number {\n\t\treturn this.list.getViewIndex(cell) ?? -1;\n\t}\n\n\tgetViewHeight(cell: ICellViewModel): number {\n\t\tif (!this.list.viewModel) {\n\t\t\treturn -1;\n\t\t}\n\n\t\treturn this.list.elementHeight(cell);\n\t}\n\n\tgetCellRangeFromViewRange(startIndex: number, endIndex: number): ICellRange | undefined {\n\t\tif (!this.list.viewModel) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst modelIndex = this.list.getModelIndex2(startIndex);\n\t\tif (modelIndex === undefined) {\n\t\t\tthrow new Error(`startIndex ${startIndex} out of boundary`);\n\t\t}\n\n\t\tif (endIndex >= this.list.length) {\n\t\t\t// it's the end\n\t\t\tconst endModelIndex = this.list.viewModel.length;\n\t\t\treturn { start: modelIndex, end: endModelIndex };\n\t\t} else {\n\t\t\tconst endModelIndex = this.list.getModelIndex2(endIndex);\n\t\t\tif (endModelIndex === undefined) {\n\t\t\t\tthrow new Error(`endIndex ${endIndex} out of boundary`);\n\t\t\t}\n\t\t\treturn { start: modelIndex, end: endModelIndex };\n\t\t}\n\t}\n\n\tgetCellsFromViewRange(startIndex: number, endIndex: number): ReadonlyArray<ICellViewModel> {\n\t\tif (!this.list.viewModel) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst range = this.getCellRangeFromViewRange(startIndex, endIndex);\n\t\tif (!range) {\n\t\t\treturn [];\n\t\t}\n\n\t\treturn this.list.viewModel.getCellsInRange(range);\n\t}\n\n\tgetCellsInRange(range?: ICellRange): ReadonlyArray<ICellViewModel> {\n\t\treturn this.list.viewModel?.getCellsInRange(range) ?? [];\n\t}\n\n\tgetVisibleRangesPlusViewportAboveAndBelow(): ICellRange[] {\n\t\treturn this.list?.getVisibleRangesPlusViewportAboveAndBelow() ?? [];\n\t}\n}\n\nfunction getEditorAttachedPromise(element: ICellViewModel) {\n\treturn new Promise<void>((resolve, reject) => {\n\t\tEvent.once(element.onDidChangeEditorAttachState)(() => element.editorAttached ? resolve() : reject());\n\t});\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as DOM from '../../../../../base/browser/dom.js';\nimport * as domStylesheetsJs from '../../../../../base/browser/domStylesheets.js';\nimport { IMouseWheelEvent } from '../../../../../base/browser/mouseEvent.js';\nimport { IListRenderer, IListVirtualDelegate, ListError } from '../../../../../base/browser/ui/list/list.js';\nimport { IListStyles, IStyleController } from '../../../../../base/browser/ui/list/listWidget.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable, MutableDisposable } from '../../../../../base/common/lifecycle.js';\nimport { isMacintosh } from '../../../../../base/common/platform.js';\nimport { ScrollEvent } from '../../../../../base/common/scrollable.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { Selection } from '../../../../../editor/common/core/selection.js';\nimport { TrackedRangeStickiness } from '../../../../../editor/common/model.js';\nimport { PrefixSumComputer } from '../../../../../editor/common/model/prefixSumComputer.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IListService, IWorkbenchListOptions, WorkbenchList } from '../../../../../platform/list/browser/listService.js';\nimport { CursorAtBoundary, ICellViewModel, CellEditState, ICellOutputViewModel, CellRevealType, CellRevealRangeType, CursorAtLineBoundary, INotebookViewZoneChangeAccessor, INotebookCellOverlayChangeAccessor } from '../notebookBrowser.js';\nimport { CellViewModel, NotebookViewModel } from '../viewModel/notebookViewModelImpl.js';\nimport { diff, NOTEBOOK_EDITOR_CURSOR_BOUNDARY, CellKind, SelectionStateType, NOTEBOOK_EDITOR_CURSOR_LINE_BOUNDARY } from '../../common/notebookCommon.js';\nimport { ICellRange, cellRangesToIndexes, reduceCellRanges, cellRangesEqual } from '../../common/notebookRange.js';\nimport { NOTEBOOK_CELL_LIST_FOCUSED } from '../../common/notebookContextKeys.js';\nimport { clamp } from '../../../../../base/common/numbers.js';\nimport { ISplice } from '../../../../../base/common/sequence.js';\nimport { BaseCellRenderTemplate, INotebookCellList } from './notebookRenderingCommon.js';\nimport { FastDomNode } from '../../../../../base/browser/fastDomNode.js';\nimport { MarkupCellViewModel } from '../viewModel/markupCellViewModel.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IListViewOptions, IListView } from '../../../../../base/browser/ui/list/listView.js';\nimport { NotebookCellListView } from './notebookCellListView.js';\nimport { NotebookOptions } from '../notebookOptions.js';\nimport { INotebookExecutionStateService } from '../../common/notebookExecutionStateService.js';\nimport { NotebookCellAnchor } from './notebookCellAnchor.js';\nimport { NotebookViewZones } from '../viewParts/notebookViewZones.js';\nimport { NotebookCellOverlays } from '../viewParts/notebookCellOverlays.js';\n\nconst enum CellRevealPosition {\n\tTop,\n\tCenter,\n\tBottom,\n\tNearTop\n}\n\nfunction getVisibleCells(cells: CellViewModel[], hiddenRanges: ICellRange[]) {\n\tif (!hiddenRanges.length) {\n\t\treturn cells;\n\t}\n\n\tlet start = 0;\n\tlet hiddenRangeIndex = 0;\n\tconst result: CellViewModel[] = [];\n\n\twhile (start < cells.length && hiddenRangeIndex < hiddenRanges.length) {\n\t\tif (start < hiddenRanges[hiddenRangeIndex].start) {\n\t\t\tresult.push(...cells.slice(start, hiddenRanges[hiddenRangeIndex].start));\n\t\t}\n\n\t\tstart = hiddenRanges[hiddenRangeIndex].end + 1;\n\t\thiddenRangeIndex++;\n\t}\n\n\tif (start < cells.length) {\n\t\tresult.push(...cells.slice(start));\n\t}\n\n\treturn result;\n}\n\nexport const NOTEBOOK_WEBVIEW_BOUNDARY = 5000;\n\nfunction validateWebviewBoundary(element: HTMLElement) {\n\tconst webviewTop = 0 - (parseInt(element.style.top, 10) || 0);\n\treturn webviewTop >= 0 && webviewTop <= NOTEBOOK_WEBVIEW_BOUNDARY * 2;\n}\n\nexport class NotebookCellList extends WorkbenchList<CellViewModel> implements IDisposable, IStyleController, INotebookCellList {\n\tdeclare protected readonly view: NotebookCellListView<CellViewModel>;\n\tprivate viewZones!: NotebookViewZones;\n\tprivate cellOverlays!: NotebookCellOverlays;\n\tget onWillScroll(): Event<ScrollEvent> { return this.view.onWillScroll; }\n\n\tget rowsContainer(): HTMLElement {\n\t\treturn this.view.containerDomNode;\n\t}\n\n\tget scrollableElement(): HTMLElement {\n\t\treturn this.view.scrollableElementDomNode;\n\t}\n\tprivate _previousFocusedElements: readonly CellViewModel[] = [];\n\tprivate readonly _localDisposableStore = new DisposableStore();\n\tprivate readonly _viewModelStore = new DisposableStore();\n\tprivate styleElement?: HTMLStyleElement;\n\tprivate _notebookCellAnchor: NotebookCellAnchor;\n\n\tprivate readonly _onDidRemoveOutputs = this._localDisposableStore.add(new Emitter<readonly ICellOutputViewModel[]>());\n\treadonly onDidRemoveOutputs = this._onDidRemoveOutputs.event;\n\n\tprivate readonly _onDidHideOutputs = this._localDisposableStore.add(new Emitter<readonly ICellOutputViewModel[]>());\n\treadonly onDidHideOutputs = this._onDidHideOutputs.event;\n\n\tprivate readonly _onDidRemoveCellsFromView = this._localDisposableStore.add(new Emitter<readonly ICellViewModel[]>());\n\treadonly onDidRemoveCellsFromView = this._onDidRemoveCellsFromView.event;\n\n\tprivate _viewModel: NotebookViewModel | null = null;\n\tget viewModel(): NotebookViewModel | null {\n\t\treturn this._viewModel;\n\t}\n\tprivate _hiddenRangeIds: string[] = [];\n\tprivate hiddenRangesPrefixSum: PrefixSumComputer | null = null;\n\n\tprivate readonly _onDidChangeVisibleRanges = this._localDisposableStore.add(new Emitter<void>());\n\n\treadonly onDidChangeVisibleRanges: Event<void> = this._onDidChangeVisibleRanges.event;\n\tprivate _visibleRanges: ICellRange[] = [];\n\n\tget visibleRanges() {\n\t\treturn this._visibleRanges;\n\t}\n\n\tset visibleRanges(ranges: ICellRange[]) {\n\t\tif (cellRangesEqual(this._visibleRanges, ranges)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._visibleRanges = ranges;\n\t\tthis._onDidChangeVisibleRanges.fire();\n\t}\n\n\tprivate _isDisposed = false;\n\n\tget isDisposed() {\n\t\treturn this._isDisposed;\n\t}\n\n\tprivate _isInLayout: boolean = false;\n\n\tprivate _webviewElement: FastDomNode<HTMLElement> | null = null;\n\n\tget webviewElement() {\n\t\treturn this._webviewElement;\n\t}\n\n\tget inRenderingTransaction() {\n\t\treturn this.view.inRenderingTransaction;\n\t}\n\n\tconstructor(\n\t\tprivate listUser: string,\n\t\tcontainer: HTMLElement,\n\t\tprivate readonly notebookOptions: NotebookOptions,\n\t\tdelegate: IListVirtualDelegate<CellViewModel>,\n\t\trenderers: IListRenderer<CellViewModel, BaseCellRenderTemplate>[],\n\t\tcontextKeyService: IContextKeyService,\n\t\toptions: IWorkbenchListOptions<CellViewModel>,\n\t\t@IListService listService: IListService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@INotebookExecutionStateService notebookExecutionStateService: INotebookExecutionStateService,\n\t) {\n\t\tsuper(listUser, container, delegate, renderers, options, contextKeyService, listService, configurationService, instantiationService);\n\t\tNOTEBOOK_CELL_LIST_FOCUSED.bindTo(this.contextKeyService).set(true);\n\t\tthis._previousFocusedElements = this.getFocusedElements();\n\t\tthis._localDisposableStore.add(this.onDidChangeFocus((e) => {\n\t\t\tthis._previousFocusedElements.forEach(element => {\n\t\t\t\tif (e.elements.indexOf(element) < 0) {\n\t\t\t\t\telement.onDeselect();\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis._previousFocusedElements = e.elements;\n\t\t}));\n\n\t\tconst notebookEditorCursorAtBoundaryContext = NOTEBOOK_EDITOR_CURSOR_BOUNDARY.bindTo(contextKeyService);\n\t\tnotebookEditorCursorAtBoundaryContext.set('none');\n\n\t\tconst notebookEditorCursorAtLineBoundaryContext = NOTEBOOK_EDITOR_CURSOR_LINE_BOUNDARY.bindTo(contextKeyService);\n\t\tnotebookEditorCursorAtLineBoundaryContext.set('none');\n\n\t\tconst cursorSelectionListener = this._localDisposableStore.add(new MutableDisposable());\n\t\tconst textEditorAttachListener = this._localDisposableStore.add(new MutableDisposable());\n\n\t\tthis._notebookCellAnchor = new NotebookCellAnchor(notebookExecutionStateService, configurationService, this.onDidScroll);\n\n\t\tconst recomputeContext = (element: CellViewModel) => {\n\t\t\tswitch (element.cursorAtBoundary()) {\n\t\t\t\tcase CursorAtBoundary.Both:\n\t\t\t\t\tnotebookEditorCursorAtBoundaryContext.set('both');\n\t\t\t\t\tbreak;\n\t\t\t\tcase CursorAtBoundary.Top:\n\t\t\t\t\tnotebookEditorCursorAtBoundaryContext.set('top');\n\t\t\t\t\tbreak;\n\t\t\t\tcase CursorAtBoundary.Bottom:\n\t\t\t\t\tnotebookEditorCursorAtBoundaryContext.set('bottom');\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tnotebookEditorCursorAtBoundaryContext.set('none');\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tswitch (element.cursorAtLineBoundary()) {\n\t\t\t\tcase CursorAtLineBoundary.Both:\n\t\t\t\t\tnotebookEditorCursorAtLineBoundaryContext.set('both');\n\t\t\t\t\tbreak;\n\t\t\t\tcase CursorAtLineBoundary.Start:\n\t\t\t\t\tnotebookEditorCursorAtLineBoundaryContext.set('start');\n\t\t\t\t\tbreak;\n\t\t\t\tcase CursorAtLineBoundary.End:\n\t\t\t\t\tnotebookEditorCursorAtLineBoundaryContext.set('end');\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tnotebookEditorCursorAtLineBoundaryContext.set('none');\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\treturn;\n\t\t};\n\n\t\t// Cursor Boundary context\n\t\tthis._localDisposableStore.add(this.onDidChangeFocus((e) => {\n\t\t\tif (e.elements.length) {\n\t\t\t\t// we only validate the first focused element\n\t\t\t\tconst focusedElement = e.elements[0];\n\n\t\t\t\tcursorSelectionListener.value = focusedElement.onDidChangeState((e) => {\n\t\t\t\t\tif (e.selectionChanged) {\n\t\t\t\t\t\trecomputeContext(focusedElement);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\ttextEditorAttachListener.value = focusedElement.onDidChangeEditorAttachState(() => {\n\t\t\t\t\tif (focusedElement.editorAttached) {\n\t\t\t\t\t\trecomputeContext(focusedElement);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\trecomputeContext(focusedElement);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// reset context\n\t\t\tnotebookEditorCursorAtBoundaryContext.set('none');\n\t\t}));\n\n\t\t// update visibleRanges\n\t\tconst updateVisibleRanges = () => {\n\t\t\tif (!this.view.length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst top = this.getViewScrollTop();\n\t\t\tconst bottom = this.getViewScrollBottom();\n\t\t\tif (top >= bottom) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst topViewIndex = clamp(this.view.indexAt(top), 0, this.view.length - 1);\n\t\t\tconst topElement = this.view.element(topViewIndex);\n\t\t\tconst topModelIndex = this._viewModel!.getCellIndex(topElement);\n\t\t\tconst bottomViewIndex = clamp(this.view.indexAt(bottom), 0, this.view.length - 1);\n\t\t\tconst bottomElement = this.view.element(bottomViewIndex);\n\t\t\tconst bottomModelIndex = this._viewModel!.getCellIndex(bottomElement);\n\n\t\t\tif (bottomModelIndex - topModelIndex === bottomViewIndex - topViewIndex) {\n\t\t\t\tthis.visibleRanges = [{ start: topModelIndex, end: bottomModelIndex + 1 }];\n\t\t\t} else {\n\t\t\t\tthis.visibleRanges = this._getVisibleRangesFromIndex(topViewIndex, topModelIndex, bottomViewIndex, bottomModelIndex);\n\t\t\t}\n\t\t};\n\n\t\tthis._localDisposableStore.add(this.view.onDidChangeContentHeight(() => {\n\t\t\tif (this._isInLayout) {\n\t\t\t\tDOM.scheduleAtNextAnimationFrame(DOM.getWindow(container), () => {\n\t\t\t\t\tupdateVisibleRanges();\n\t\t\t\t});\n\t\t\t}\n\t\t\tupdateVisibleRanges();\n\t\t}));\n\t\tthis._localDisposableStore.add(this.view.onDidScroll(() => {\n\t\t\tif (this._isInLayout) {\n\t\t\t\tDOM.scheduleAtNextAnimationFrame(DOM.getWindow(container), () => {\n\t\t\t\t\tupdateVisibleRanges();\n\t\t\t\t});\n\t\t\t}\n\t\t\tupdateVisibleRanges();\n\t\t}));\n\t}\n\n\tprotected override createListView(container: HTMLElement, virtualDelegate: IListVirtualDelegate<CellViewModel>, renderers: IListRenderer<any, any>[], viewOptions: IListViewOptions<CellViewModel>): IListView<CellViewModel> {\n\t\tconst listView = new NotebookCellListView(container, virtualDelegate, renderers, viewOptions);\n\t\tthis.viewZones = new NotebookViewZones(listView, this);\n\t\tthis.cellOverlays = new NotebookCellOverlays(listView);\n\t\treturn listView;\n\t}\n\n\t/**\n\t * Test Only\n\t */\n\t_getView() {\n\t\treturn this.view;\n\t}\n\n\tattachWebview(element: HTMLElement) {\n\t\telement.style.top = `-${NOTEBOOK_WEBVIEW_BOUNDARY}px`;\n\t\tthis.rowsContainer.insertAdjacentElement('afterbegin', element);\n\t\tthis._webviewElement = new FastDomNode<HTMLElement>(element);\n\t}\n\n\telementAt(position: number): ICellViewModel | undefined {\n\t\tif (!this.view.length) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst idx = this.view.indexAt(position);\n\t\tconst clamped = clamp(idx, 0, this.view.length - 1);\n\t\treturn this.element(clamped);\n\t}\n\n\telementHeight(element: ICellViewModel): number {\n\t\tconst index = this._getViewIndexUpperBound(element);\n\t\tif (index === undefined || index < 0 || index >= this.length) {\n\t\t\tthis._getViewIndexUpperBound(element);\n\t\t\tthrow new ListError(this.listUser, `Invalid index ${index}`);\n\t\t}\n\n\t\treturn this.view.elementHeight(index);\n\t}\n\n\tdetachViewModel() {\n\t\tthis._viewModelStore.clear();\n\t\tthis._viewModel = null;\n\t\tthis.hiddenRangesPrefixSum = null;\n\t}\n\n\tattachViewModel(model: NotebookViewModel) {\n\t\tthis._viewModel = model;\n\t\tthis._viewModelStore.add(model.onDidChangeViewCells((e) => {\n\t\t\tif (this._isDisposed) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// update whitespaces which are anchored to the model indexes\n\t\t\tthis.viewZones.onCellsChanged(e);\n\t\t\tthis.cellOverlays.onCellsChanged(e);\n\n\t\t\tconst currentRanges = this._hiddenRangeIds.map(id => this._viewModel!.getTrackedRange(id)).filter(range => range !== null) as ICellRange[];\n\t\t\tconst newVisibleViewCells: CellViewModel[] = getVisibleCells(this._viewModel!.viewCells as CellViewModel[], currentRanges);\n\n\t\t\tconst oldVisibleViewCells: CellViewModel[] = [];\n\t\t\tconst oldViewCellMapping = new Set<string>();\n\t\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\t\toldVisibleViewCells.push(this.element(i));\n\t\t\t\toldViewCellMapping.add(this.element(i).uri.toString());\n\t\t\t}\n\n\t\t\tconst viewDiffs = diff<CellViewModel>(oldVisibleViewCells, newVisibleViewCells, a => {\n\t\t\t\treturn oldViewCellMapping.has(a.uri.toString());\n\t\t\t});\n\n\t\t\tif (e.synchronous) {\n\t\t\t\tthis._updateElementsInWebview(viewDiffs);\n\t\t\t} else {\n\t\t\t\tthis._viewModelStore.add(DOM.scheduleAtNextAnimationFrame(DOM.getWindow(this.rowsContainer), () => {\n\t\t\t\t\tif (this._isDisposed) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._updateElementsInWebview(viewDiffs);\n\t\t\t\t}));\n\t\t\t}\n\t\t}));\n\n\t\tthis._viewModelStore.add(model.onDidChangeSelection((e) => {\n\t\t\tif (e === 'view') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// convert model selections to view selections\n\t\t\tconst viewSelections = cellRangesToIndexes(model.getSelections()).map(index => model.cellAt(index)).filter(cell => !!cell).map(cell => this._getViewIndexUpperBound(cell!));\n\t\t\tthis.setSelection(viewSelections, undefined, true);\n\t\t\tconst primary = cellRangesToIndexes([model.getFocus()]).map(index => model.cellAt(index)).filter(cell => !!cell).map(cell => this._getViewIndexUpperBound(cell!));\n\n\t\t\tif (primary.length) {\n\t\t\t\tthis.setFocus(primary, undefined, true);\n\t\t\t}\n\t\t}));\n\n\t\tconst hiddenRanges = model.getHiddenRanges();\n\t\tthis.setHiddenAreas(hiddenRanges, false);\n\t\tconst newRanges = reduceCellRanges(hiddenRanges);\n\t\tconst viewCells = model.viewCells.slice(0) as CellViewModel[];\n\t\tnewRanges.reverse().forEach(range => {\n\t\t\tconst removedCells = viewCells.splice(range.start, range.end - range.start + 1);\n\t\t\tthis._onDidRemoveCellsFromView.fire(removedCells);\n\t\t});\n\n\t\tthis.splice2(0, 0, viewCells);\n\t}\n\n\tprivate _updateElementsInWebview(viewDiffs: ISplice<CellViewModel>[]) {\n\t\tviewDiffs.reverse().forEach((diff) => {\n\t\t\tconst hiddenOutputs: ICellOutputViewModel[] = [];\n\t\t\tconst deletedOutputs: ICellOutputViewModel[] = [];\n\t\t\tconst removedMarkdownCells: ICellViewModel[] = [];\n\n\t\t\tfor (let i = diff.start; i < diff.start + diff.deleteCount; i++) {\n\t\t\t\tconst cell = this.element(i);\n\t\t\t\tif (cell.cellKind === CellKind.Code) {\n\t\t\t\t\tif (this._viewModel!.hasCell(cell)) {\n\t\t\t\t\t\thiddenOutputs.push(...cell?.outputsViewModels);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdeletedOutputs.push(...cell?.outputsViewModels);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tremovedMarkdownCells.push(cell);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.splice2(diff.start, diff.deleteCount, diff.toInsert);\n\n\t\t\tthis._onDidHideOutputs.fire(hiddenOutputs);\n\t\t\tthis._onDidRemoveOutputs.fire(deletedOutputs);\n\t\t\tthis._onDidRemoveCellsFromView.fire(removedMarkdownCells);\n\t\t});\n\t}\n\n\tclear() {\n\t\tsuper.splice(0, this.length);\n\t}\n\n\tsetHiddenAreas(_ranges: ICellRange[], triggerViewUpdate: boolean): boolean {\n\t\tif (!this._viewModel) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst newRanges = reduceCellRanges(_ranges);\n\t\t// delete old tracking ranges\n\t\tconst oldRanges = this._hiddenRangeIds.map(id => this._viewModel!.getTrackedRange(id)).filter(range => range !== null) as ICellRange[];\n\t\tif (newRanges.length === oldRanges.length) {\n\t\t\tlet hasDifference = false;\n\t\t\tfor (let i = 0; i < newRanges.length; i++) {\n\t\t\t\tif (!(newRanges[i].start === oldRanges[i].start && newRanges[i].end === oldRanges[i].end)) {\n\t\t\t\t\thasDifference = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!hasDifference) {\n\t\t\t\t// they call 'setHiddenAreas' for a reason, even if the ranges are still the same, it's possible that the hiddenRangeSum is not update to date\n\t\t\t\tthis._updateHiddenRangePrefixSum(newRanges);\n\t\t\t\tthis.viewZones.onHiddenRangesChange();\n\t\t\t\tthis.viewZones.layout();\n\t\t\t\tthis.cellOverlays.onHiddenRangesChange();\n\t\t\t\tthis.cellOverlays.layout();\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tthis._hiddenRangeIds.forEach(id => this._viewModel!.setTrackedRange(id, null, TrackedRangeStickiness.GrowsOnlyWhenTypingAfter));\n\t\tconst hiddenAreaIds = newRanges.map(range => this._viewModel!.setTrackedRange(null, range, TrackedRangeStickiness.GrowsOnlyWhenTypingAfter)).filter(id => id !== null) as string[];\n\n\t\tthis._hiddenRangeIds = hiddenAreaIds;\n\n\t\t// set hidden ranges prefix sum\n\t\tthis._updateHiddenRangePrefixSum(newRanges);\n\t\t// Update view zone positions after hidden ranges change\n\t\tthis.viewZones.onHiddenRangesChange();\n\t\tthis.cellOverlays.onHiddenRangesChange();\n\n\t\tif (triggerViewUpdate) {\n\t\t\tthis.updateHiddenAreasInView(oldRanges, newRanges);\n\t\t}\n\n\t\tthis.viewZones.layout();\n\t\tthis.cellOverlays.layout();\n\t\treturn true;\n\t}\n\n\tprivate _updateHiddenRangePrefixSum(newRanges: ICellRange[]) {\n\t\tlet start = 0;\n\t\tlet index = 0;\n\t\tconst ret: number[] = [];\n\n\t\twhile (index < newRanges.length) {\n\t\t\tfor (let j = start; j < newRanges[index].start - 1; j++) {\n\t\t\t\tret.push(1);\n\t\t\t}\n\n\t\t\tret.push(newRanges[index].end - newRanges[index].start + 1 + 1);\n\t\t\tstart = newRanges[index].end + 1;\n\t\t\tindex++;\n\t\t}\n\n\t\tfor (let i = start; i < this._viewModel!.length; i++) {\n\t\t\tret.push(1);\n\t\t}\n\n\t\tconst values = new Uint32Array(ret.length);\n\t\tfor (let i = 0; i < ret.length; i++) {\n\t\t\tvalues[i] = ret[i];\n\t\t}\n\n\t\tthis.hiddenRangesPrefixSum = new PrefixSumComputer(values);\n\t}\n\n\t/**\n\t * oldRanges and newRanges are all reduced and sorted.\n\t */\n\tupdateHiddenAreasInView(oldRanges: ICellRange[], newRanges: ICellRange[]) {\n\t\tconst oldViewCellEntries: CellViewModel[] = getVisibleCells(this._viewModel!.viewCells as CellViewModel[], oldRanges);\n\t\tconst oldViewCellMapping = new Set<string>();\n\t\toldViewCellEntries.forEach(cell => {\n\t\t\toldViewCellMapping.add(cell.uri.toString());\n\t\t});\n\n\t\tconst newViewCellEntries: CellViewModel[] = getVisibleCells(this._viewModel!.viewCells as CellViewModel[], newRanges);\n\n\t\tconst viewDiffs = diff<CellViewModel>(oldViewCellEntries, newViewCellEntries, a => {\n\t\t\treturn oldViewCellMapping.has(a.uri.toString());\n\t\t});\n\n\t\tthis._updateElementsInWebview(viewDiffs);\n\t}\n\n\tsplice2(start: number, deleteCount: number, elements: readonly CellViewModel[] = []): void {\n\t\t// we need to convert start and delete count based on hidden ranges\n\t\tif (start < 0 || start > this.view.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst focusInside = DOM.isAncestorOfActiveElement(this.rowsContainer);\n\t\tsuper.splice(start, deleteCount, elements);\n\t\tif (focusInside) {\n\t\t\tthis.domFocus();\n\t\t}\n\n\t\tconst selectionsLeft = [];\n\t\tthis.getSelectedElements().forEach(el => {\n\t\t\tif (this._viewModel!.hasCell(el)) {\n\t\t\t\tselectionsLeft.push(el.handle);\n\t\t\t}\n\t\t});\n\n\t\tif (!selectionsLeft.length && this._viewModel!.viewCells.length) {\n\t\t\t// after splice, the selected cells are deleted\n\t\t\tthis._viewModel!.updateSelectionsState({ kind: SelectionStateType.Index, focus: { start: 0, end: 1 }, selections: [{ start: 0, end: 1 }] });\n\t\t}\n\n\t\tthis.viewZones.layout();\n\t\tthis.cellOverlays.layout();\n\t}\n\n\tgetModelIndex(cell: CellViewModel): number | undefined {\n\t\tconst viewIndex = this.indexOf(cell);\n\t\treturn this.getModelIndex2(viewIndex);\n\t}\n\n\tgetModelIndex2(viewIndex: number): number | undefined {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn viewIndex;\n\t\t}\n\n\t\tconst modelIndex = this.hiddenRangesPrefixSum.getPrefixSum(viewIndex - 1);\n\t\treturn modelIndex;\n\t}\n\n\tgetViewIndex(cell: ICellViewModel) {\n\t\tconst modelIndex = this._viewModel!.getCellIndex(cell);\n\t\treturn this.getViewIndex2(modelIndex);\n\t}\n\n\tgetViewIndex2(modelIndex: number): number | undefined {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn modelIndex;\n\t\t}\n\n\t\tconst viewIndexInfo = this.hiddenRangesPrefixSum.getIndexOf(modelIndex);\n\n\t\tif (viewIndexInfo.remainder !== 0) {\n\t\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t\t// it's already after the last hidden range\n\t\t\t\treturn modelIndex - (this.hiddenRangesPrefixSum.getTotalSum() - this.hiddenRangesPrefixSum.getCount());\n\t\t\t}\n\t\t\treturn undefined;\n\t\t} else {\n\t\t\treturn viewIndexInfo.index;\n\t\t}\n\t}\n\n\tconvertModelIndexToViewIndex(modelIndex: number): number {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn modelIndex;\n\t\t}\n\n\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t// it's already after the last hidden range\n\t\t\treturn Math.min(this.length, this.hiddenRangesPrefixSum.getTotalSum());\n\t\t}\n\n\t\treturn this.hiddenRangesPrefixSum.getIndexOf(modelIndex).index;\n\t}\n\n\tmodelIndexIsVisible(modelIndex: number): boolean {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst viewIndexInfo = this.hiddenRangesPrefixSum.getIndexOf(modelIndex);\n\t\tif (viewIndexInfo.remainder !== 0) {\n\t\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t\t// it's already after the last hidden range\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn false;\n\t\t} else {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tprivate _getVisibleRangesFromIndex(topViewIndex: number, topModelIndex: number, bottomViewIndex: number, bottomModelIndex: number) {\n\t\tconst stack: number[] = [];\n\t\tconst ranges: ICellRange[] = [];\n\t\t// there are hidden ranges\n\t\tlet index = topViewIndex;\n\t\tlet modelIndex = topModelIndex;\n\n\t\twhile (index <= bottomViewIndex) {\n\t\t\tconst accu = this.hiddenRangesPrefixSum!.getPrefixSum(index);\n\t\t\tif (accu === modelIndex + 1) {\n\t\t\t\t// no hidden area after it\n\t\t\t\tif (stack.length) {\n\t\t\t\t\tif (stack[stack.length - 1] === modelIndex - 1) {\n\t\t\t\t\t\tranges.push({ start: stack[stack.length - 1], end: modelIndex + 1 });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tranges.push({ start: stack[stack.length - 1], end: stack[stack.length - 1] + 1 });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tstack.push(modelIndex);\n\t\t\t\tindex++;\n\t\t\t\tmodelIndex++;\n\t\t\t} else {\n\t\t\t\t// there are hidden ranges after it\n\t\t\t\tif (stack.length) {\n\t\t\t\t\tif (stack[stack.length - 1] === modelIndex - 1) {\n\t\t\t\t\t\tranges.push({ start: stack[stack.length - 1], end: modelIndex + 1 });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tranges.push({ start: stack[stack.length - 1], end: stack[stack.length - 1] + 1 });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tstack.push(modelIndex);\n\t\t\t\tindex++;\n\t\t\t\tmodelIndex = accu;\n\t\t\t}\n\t\t}\n\n\t\tif (stack.length) {\n\t\t\tranges.push({ start: stack[stack.length - 1], end: stack[stack.length - 1] + 1 });\n\t\t}\n\n\t\treturn reduceCellRanges(ranges);\n\t}\n\n\tgetVisibleRangesPlusViewportAboveAndBelow() {\n\t\tif (this.view.length <= 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst top = Math.max(this.getViewScrollTop() - this.renderHeight, 0);\n\t\tconst topViewIndex = this.view.indexAt(top);\n\t\tconst topElement = this.view.element(topViewIndex);\n\t\tconst topModelIndex = this._viewModel!.getCellIndex(topElement);\n\t\tconst bottom = clamp(this.getViewScrollBottom() + this.renderHeight, 0, this.scrollHeight);\n\t\tconst bottomViewIndex = clamp(this.view.indexAt(bottom), 0, this.view.length - 1);\n\t\tconst bottomElement = this.view.element(bottomViewIndex);\n\t\tconst bottomModelIndex = this._viewModel!.getCellIndex(bottomElement);\n\n\t\tif (bottomModelIndex - topModelIndex === bottomViewIndex - topViewIndex) {\n\t\t\treturn [{ start: topModelIndex, end: bottomModelIndex }];\n\t\t} else {\n\t\t\treturn this._getVisibleRangesFromIndex(topViewIndex, topModelIndex, bottomViewIndex, bottomModelIndex);\n\t\t}\n\t}\n\n\tprivate _getViewIndexUpperBound(cell: ICellViewModel): number {\n\t\tif (!this._viewModel) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tconst modelIndex = this._viewModel.getCellIndex(cell);\n\t\tif (modelIndex === -1) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn modelIndex;\n\t\t}\n\n\t\tconst viewIndexInfo = this.hiddenRangesPrefixSum.getIndexOf(modelIndex);\n\n\t\tif (viewIndexInfo.remainder !== 0) {\n\t\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t\treturn modelIndex - (this.hiddenRangesPrefixSum.getTotalSum() - this.hiddenRangesPrefixSum.getCount());\n\t\t\t}\n\t\t}\n\n\t\treturn viewIndexInfo.index;\n\t}\n\n\tprivate _getViewIndexUpperBound2(modelIndex: number) {\n\t\tif (!this.hiddenRangesPrefixSum) {\n\t\t\treturn modelIndex;\n\t\t}\n\n\t\tconst viewIndexInfo = this.hiddenRangesPrefixSum.getIndexOf(modelIndex);\n\n\t\tif (viewIndexInfo.remainder !== 0) {\n\t\t\tif (modelIndex >= this.hiddenRangesPrefixSum.getTotalSum()) {\n\t\t\t\treturn modelIndex - (this.hiddenRangesPrefixSum.getTotalSum() - this.hiddenRangesPrefixSum.getCount());\n\t\t\t}\n\t\t}\n\n\t\treturn viewIndexInfo.index;\n\t}\n\n\tfocusElement(cell: ICellViewModel) {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\n\t\tif (index >= 0 && this._viewModel) {\n\t\t\t// update view model first, which will update both `focus` and `selection` in a single transaction\n\t\t\tconst focusedElementHandle = this.element(index).handle;\n\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\tprimary: focusedElementHandle,\n\t\t\t\tselections: [focusedElementHandle]\n\t\t\t}, 'view');\n\n\t\t\t// update the view as previous model update will not trigger event\n\t\t\tthis.setFocus([index], undefined, false);\n\t\t}\n\t}\n\n\tselectElements(elements: ICellViewModel[]) {\n\t\tconst indices = elements.map(cell => this._getViewIndexUpperBound(cell)).filter(index => index >= 0);\n\t\tthis.setSelection(indices);\n\t}\n\n\tgetCellViewScrollTop(cell: ICellViewModel) {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\t\tif (index === undefined || index < 0 || index >= this.length) {\n\t\t\tthrow new ListError(this.listUser, `Invalid index ${index}`);\n\t\t}\n\n\t\treturn this.view.elementTop(index);\n\t}\n\n\tgetCellViewScrollBottom(cell: ICellViewModel) {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\t\tif (index === undefined || index < 0 || index >= this.length) {\n\t\t\tthrow new ListError(this.listUser, `Invalid index ${index}`);\n\t\t}\n\n\t\tconst top = this.view.elementTop(index);\n\t\tconst height = this.view.elementHeight(index);\n\t\treturn top + height;\n\t}\n\n\toverride setFocus(indexes: number[], browserEvent?: UIEvent, ignoreTextModelUpdate?: boolean): void {\n\t\tif (ignoreTextModelUpdate) {\n\t\t\tsuper.setFocus(indexes, browserEvent);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!indexes.length) {\n\t\t\tif (this._viewModel) {\n\t\t\t\tif (this.length) {\n\t\t\t\t\t// Don't allow clearing focus, #121129\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\t\tprimary: null,\n\t\t\t\t\tselections: []\n\t\t\t\t}, 'view');\n\t\t\t}\n\t\t} else {\n\t\t\tif (this._viewModel) {\n\t\t\t\tconst focusedElementHandle = this.element(indexes[0]).handle;\n\t\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\t\tprimary: focusedElementHandle,\n\t\t\t\t\tselections: this.getSelection().map(selection => this.element(selection).handle)\n\t\t\t\t}, 'view');\n\t\t\t}\n\t\t}\n\n\t\tsuper.setFocus(indexes, browserEvent);\n\t}\n\n\toverride setSelection(indexes: number[], browserEvent?: UIEvent | undefined, ignoreTextModelUpdate?: boolean) {\n\t\tif (ignoreTextModelUpdate) {\n\t\t\tsuper.setSelection(indexes, browserEvent);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!indexes.length) {\n\t\t\tif (this._viewModel) {\n\t\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\t\tprimary: this.getFocusedElements()[0]?.handle ?? null,\n\t\t\t\t\tselections: []\n\t\t\t\t}, 'view');\n\t\t\t}\n\t\t} else {\n\t\t\tif (this._viewModel) {\n\t\t\t\tthis._viewModel.updateSelectionsState({\n\t\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\t\tprimary: this.getFocusedElements()[0]?.handle ?? null,\n\t\t\t\t\tselections: indexes.map(index => this.element(index)).map(cell => cell.handle)\n\t\t\t\t}, 'view');\n\t\t\t}\n\t\t}\n\n\t\tsuper.setSelection(indexes, browserEvent);\n\t}\n\n\t/**\n\t * The range will be revealed with as little scrolling as possible.\n\t */\n\trevealCells(range: ICellRange) {\n\t\tconst startIndex = this._getViewIndexUpperBound2(range.start);\n\n\t\tif (startIndex < 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst endIndex = this._getViewIndexUpperBound2(range.end - 1);\n\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst elementTop = this.view.elementTop(startIndex);\n\t\tif (elementTop >= scrollTop\n\t\t\t&& elementTop < wrapperBottom) {\n\t\t\t// start element is visible\n\t\t\t// check end\n\n\t\t\tconst endElementTop = this.view.elementTop(endIndex);\n\t\t\tconst endElementHeight = this.view.elementHeight(endIndex);\n\n\t\t\tif (endElementTop + endElementHeight <= wrapperBottom) {\n\t\t\t\t// fully visible\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (endElementTop >= wrapperBottom) {\n\t\t\t\treturn this._revealInternal(endIndex, false, CellRevealPosition.Bottom);\n\t\t\t}\n\n\t\t\tif (endElementTop < wrapperBottom) {\n\t\t\t\t// end element partially visible\n\t\t\t\tif (endElementTop + endElementHeight - wrapperBottom < elementTop - scrollTop) {\n\t\t\t\t\t// there is enough space to just scroll up a little bit to make the end element visible\n\t\t\t\t\treturn this.view.setScrollTop(scrollTop + endElementTop + endElementHeight - wrapperBottom);\n\t\t\t\t} else {\n\t\t\t\t\t// don't even try it\n\t\t\t\t\treturn this._revealInternal(startIndex, false, CellRevealPosition.Top);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._revealInViewWithMinimalScrolling(startIndex);\n\t}\n\n\tprivate _revealInViewWithMinimalScrolling(viewIndex: number, firstLine?: boolean) {\n\t\tconst firstIndex = this.view.firstMostlyVisibleIndex;\n\t\tconst elementHeight = this.view.elementHeight(viewIndex);\n\n\t\tif (viewIndex <= firstIndex || (!firstLine && elementHeight >= this.view.renderHeight)) {\n\t\t\tthis._revealInternal(viewIndex, true, CellRevealPosition.Top);\n\t\t} else {\n\t\t\tthis._revealInternal(viewIndex, true, CellRevealPosition.Bottom, firstLine);\n\t\t}\n\t}\n\n\tscrollToBottom() {\n\t\tconst scrollHeight = this.view.scrollHeight;\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\n\t\tthis.view.setScrollTop(scrollHeight - (wrapperBottom - scrollTop));\n\t}\n\n\t/**\n\t * Reveals the given cell in the notebook cell list. The cell will come into view syncronously\n\t * but the cell's editor will be attached asyncronously if it was previously out of view.\n\t * @returns The promise to await for the cell editor to be attached\n\t */\n\tasync revealCell(cell: ICellViewModel, revealType: CellRevealType): Promise<void> {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\n\t\tif (index < 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (revealType) {\n\t\t\tcase CellRevealType.Top:\n\t\t\t\tthis._revealInternal(index, false, CellRevealPosition.Top);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.Center:\n\t\t\t\tthis._revealInternal(index, false, CellRevealPosition.Center);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.CenterIfOutsideViewport:\n\t\t\t\tthis._revealInternal(index, true, CellRevealPosition.Center);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.NearTopIfOutsideViewport:\n\t\t\t\tthis._revealInternal(index, true, CellRevealPosition.NearTop);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.FirstLineIfOutsideViewport:\n\t\t\t\tthis._revealInViewWithMinimalScrolling(index, true);\n\t\t\t\tbreak;\n\t\t\tcase CellRevealType.Default:\n\t\t\t\tthis._revealInViewWithMinimalScrolling(index);\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif ((\n\t\t\t// wait for the editor to be created if the cell is in editing mode\n\t\t\tcell.getEditState() === CellEditState.Editing\n\t\t\t// wait for the editor to be created if we are revealing the first line of the cell\n\t\t\t|| (revealType === CellRevealType.FirstLineIfOutsideViewport && cell.cellKind === CellKind.Code)\n\t\t) && !cell.editorAttached) {\n\t\t\treturn getEditorAttachedPromise(cell);\n\t\t}\n\n\t\treturn;\n\t}\n\n\tprivate _revealInternal(viewIndex: number, ignoreIfInsideViewport: boolean, revealPosition: CellRevealPosition, firstLine?: boolean) {\n\t\tif (viewIndex >= this.view.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst elementBottom = this.view.elementHeight(viewIndex) + elementTop;\n\n\t\tif (ignoreIfInsideViewport) {\n\t\t\tif (elementTop >= scrollTop && elementBottom < wrapperBottom) {\n\t\t\t\t// element is already fully visible\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tswitch (revealPosition) {\n\t\t\tcase CellRevealPosition.Top:\n\t\t\t\tthis.view.setScrollTop(elementTop);\n\t\t\t\tthis.view.setScrollTop(this.view.elementTop(viewIndex));\n\t\t\t\tbreak;\n\t\t\tcase CellRevealPosition.Center:\n\t\t\tcase CellRevealPosition.NearTop:\n\t\t\t\t{\n\t\t\t\t\t// reveal the cell top in the viewport center initially\n\t\t\t\t\tthis.view.setScrollTop(elementTop - this.view.renderHeight / 2);\n\t\t\t\t\t// cell rendered already, we now have a more accurate cell height\n\t\t\t\t\tconst newElementTop = this.view.elementTop(viewIndex);\n\t\t\t\t\tconst newElementHeight = this.view.elementHeight(viewIndex);\n\t\t\t\t\tconst renderHeight = this.getViewScrollBottom() - this.getViewScrollTop();\n\t\t\t\t\tif (newElementHeight >= renderHeight) {\n\t\t\t\t\t\t// cell is larger than viewport, reveal top\n\t\t\t\t\t\tthis.view.setScrollTop(newElementTop);\n\t\t\t\t\t} else if (revealPosition === CellRevealPosition.Center) {\n\t\t\t\t\t\tthis.view.setScrollTop(newElementTop + (newElementHeight / 2) - (renderHeight / 2));\n\t\t\t\t\t} else if (revealPosition === CellRevealPosition.NearTop) {\n\t\t\t\t\t\tthis.view.setScrollTop(newElementTop - (renderHeight / 5));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase CellRevealPosition.Bottom:\n\t\t\t\tif (firstLine) {\n\t\t\t\t\tconst lineHeight = this.viewModel?.layoutInfo?.fontInfo.lineHeight ?? 15;\n\t\t\t\t\tconst padding = this.notebookOptions.getLayoutConfiguration().cellTopMargin + this.notebookOptions.getLayoutConfiguration().editorTopPadding;\n\t\t\t\t\tconst firstLineLocation = elementTop + lineHeight + padding;\n\t\t\t\t\tif (firstLineLocation < wrapperBottom) {\n\t\t\t\t\t\t// first line is already visible\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.view.setScrollTop(this.scrollTop + (firstLineLocation - wrapperBottom));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tthis.view.setScrollTop(this.scrollTop + (elementBottom - wrapperBottom));\n\t\t\t\tthis.view.setScrollTop(this.scrollTop + (this.view.elementTop(viewIndex) + this.view.elementHeight(viewIndex) - this.getViewScrollBottom()));\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\t//#region Reveal Cell Editor Range asynchronously\n\tasync revealRangeInCell(cell: ICellViewModel, range: Selection | Range, revealType: CellRevealRangeType): Promise<void> {\n\t\tconst index = this._getViewIndexUpperBound(cell);\n\n\t\tif (index < 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (revealType) {\n\t\t\tcase CellRevealRangeType.Default:\n\t\t\t\treturn this._revealRangeInternalAsync(index, range);\n\t\t\tcase CellRevealRangeType.Center:\n\t\t\t\treturn this._revealRangeInCenterInternalAsync(index, range);\n\t\t\tcase CellRevealRangeType.CenterIfOutsideViewport:\n\t\t\t\treturn this._revealRangeInCenterIfOutsideViewportInternalAsync(index, range);\n\t\t}\n\t}\n\n\t// List items have real dynamic heights, which means after we set `scrollTop` based on the `elementTop(index)`, the element at `index` might still be removed from the view once all relayouting tasks are done.\n\t// For example, we scroll item 10 into the view upwards, in the first round, items 7, 8, 9, 10 are all in the viewport. Then item 7 and 8 resize themselves to be larger and finally item 10 is removed from the view.\n\t// To ensure that item 10 is always there, we need to scroll item 10 to the top edge of the viewport.\n\tprivate async _revealRangeInternalAsync(viewIndex: number, range: Selection | Range): Promise<void> {\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst element = this.view.element(viewIndex);\n\n\t\tif (element.editorAttached) {\n\t\t\tthis._revealRangeCommon(viewIndex, range);\n\t\t} else {\n\t\t\tconst elementHeight = this.view.elementHeight(viewIndex);\n\t\t\tlet alignHint: 'top' | 'bottom' | undefined = undefined;\n\n\t\t\tif (elementTop + elementHeight <= scrollTop) {\n\t\t\t\t// scroll up\n\t\t\t\tthis.view.setScrollTop(elementTop);\n\t\t\t\talignHint = 'top';\n\t\t\t} else if (elementTop >= wrapperBottom) {\n\t\t\t\t// scroll down\n\t\t\t\tthis.view.setScrollTop(elementTop - this.view.renderHeight / 2);\n\t\t\t\talignHint = 'bottom';\n\t\t\t}\n\n\t\t\tconst editorAttachedPromise = new Promise<void>((resolve, reject) => {\n\t\t\t\tEvent.once(element.onDidChangeEditorAttachState)(() => {\n\t\t\t\t\telement.editorAttached ? resolve() : reject();\n\t\t\t\t});\n\t\t\t});\n\n\t\t\treturn editorAttachedPromise.then(() => {\n\t\t\t\tthis._revealRangeCommon(viewIndex, range, alignHint);\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate async _revealRangeInCenterInternalAsync(viewIndex: number, range: Selection | Range): Promise<void> {\n\t\tconst reveal = (viewIndex: number, range: Range) => {\n\t\t\tconst element = this.view.element(viewIndex);\n\t\t\tconst positionOffset = element.getPositionScrollTopOffset(range);\n\t\t\tconst positionOffsetInView = this.view.elementTop(viewIndex) + positionOffset;\n\t\t\tthis.view.setScrollTop(positionOffsetInView - this.view.renderHeight / 2);\n\t\t\telement.revealRangeInCenter(range);\n\t\t};\n\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst viewItemOffset = elementTop;\n\t\tthis.view.setScrollTop(viewItemOffset - this.view.renderHeight / 2);\n\t\tconst element = this.view.element(viewIndex);\n\n\t\tif (!element.editorAttached) {\n\t\t\treturn getEditorAttachedPromise(element).then(() => reveal(viewIndex, range));\n\t\t} else {\n\t\t\treveal(viewIndex, range);\n\t\t}\n\t}\n\n\tprivate async _revealRangeInCenterIfOutsideViewportInternalAsync(viewIndex: number, range: Selection | Range): Promise<void> {\n\t\tconst reveal = (viewIndex: number, range: Range) => {\n\t\t\tconst element = this.view.element(viewIndex);\n\t\t\tconst positionOffset = element.getPositionScrollTopOffset(range);\n\t\t\tconst positionOffsetInView = this.view.elementTop(viewIndex) + positionOffset;\n\t\t\tthis.view.setScrollTop(positionOffsetInView - this.view.renderHeight / 2);\n\n\t\t\telement.revealRangeInCenter(range);\n\t\t};\n\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst viewItemOffset = elementTop;\n\t\tconst element = this.view.element(viewIndex);\n\t\tconst positionOffset = viewItemOffset + element.getPositionScrollTopOffset(range);\n\n\t\tif (positionOffset < scrollTop || positionOffset > wrapperBottom) {\n\t\t\t// let it render\n\t\t\tthis.view.setScrollTop(positionOffset - this.view.renderHeight / 2);\n\n\t\t\t// after rendering, it might be pushed down due to markdown cell dynamic height\n\t\t\tconst newPositionOffset = this.view.elementTop(viewIndex) + element.getPositionScrollTopOffset(range);\n\t\t\tthis.view.setScrollTop(newPositionOffset - this.view.renderHeight / 2);\n\n\t\t\t// reveal editor\n\t\t\tif (!element.editorAttached) {\n\t\t\t\treturn getEditorAttachedPromise(element).then(() => reveal(viewIndex, range));\n\t\t\t} else {\n\t\t\t\t// for example markdown\n\t\t\t}\n\t\t} else {\n\t\t\tif (element.editorAttached) {\n\t\t\t\telement.revealRangeInCenter(range);\n\t\t\t} else {\n\t\t\t\t// for example, markdown cell in preview mode\n\t\t\t\treturn getEditorAttachedPromise(element).then(() => reveal(viewIndex, range));\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _revealRangeCommon(viewIndex: number, range: Selection | Range, alignHint?: 'top' | 'bottom' | undefined) {\n\t\tconst element = this.view.element(viewIndex);\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\t\tconst positionOffset = element.getPositionScrollTopOffset(range);\n\t\tconst elementOriginalHeight = this.view.elementHeight(viewIndex);\n\t\tif (positionOffset >= elementOriginalHeight) {\n\t\t\t// we are revealing a range that is beyond current element height\n\t\t\t// if we don't update the element height now, and directly `setTop` to reveal the range\n\t\t\t// the element might be scrolled out of view\n\t\t\t// next frame, when we update the element height, the element will never be scrolled back into view\n\t\t\tconst newTotalHeight = element.layoutInfo.totalHeight;\n\t\t\tthis.updateElementHeight(viewIndex, newTotalHeight);\n\t\t}\n\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\tconst positionTop = elementTop + positionOffset;\n\n\t\t// TODO@rebornix 30 ---> line height * 1.5\n\t\tif (positionTop < scrollTop) {\n\t\t\tthis.view.setScrollTop(positionTop - 30);\n\t\t} else if (positionTop > wrapperBottom) {\n\t\t\tthis.view.setScrollTop(scrollTop + positionTop - wrapperBottom + 30);\n\t\t} else if (alignHint === 'bottom') {\n\t\t\t// Scrolled into view from below\n\t\t\tthis.view.setScrollTop(scrollTop + positionTop - wrapperBottom + 30);\n\t\t} else if (alignHint === 'top') {\n\t\t\t// Scrolled into view from above\n\t\t\tthis.view.setScrollTop(positionTop - 30);\n\t\t}\n\t}\n\t//#endregion\n\n\n\n\t/**\n\t * Reveals the specified offset of the given cell in the center of the viewport.\n\t * This enables revealing locations in the output as well as the input.\n\t */\n\trevealCellOffsetInCenter(cell: ICellViewModel, offset: number) {\n\t\tconst viewIndex = this._getViewIndexUpperBound(cell);\n\n\t\tif (viewIndex >= 0) {\n\t\t\tconst element = this.view.element(viewIndex);\n\t\t\tconst elementTop = this.view.elementTop(viewIndex);\n\t\t\tif (element instanceof MarkupCellViewModel) {\n\t\t\t\treturn this._revealInCenterIfOutsideViewport(viewIndex);\n\t\t\t} else {\n\t\t\t\tconst rangeOffset = element.layoutInfo.outputContainerOffset + Math.min(offset, element.layoutInfo.outputTotalHeight);\n\t\t\t\tthis.view.setScrollTop(elementTop - this.view.renderHeight / 2);\n\t\t\t\tthis.view.setScrollTop(elementTop + rangeOffset - this.view.renderHeight / 2);\n\t\t\t}\n\t\t}\n\t}\n\n\trevealOffsetInCenterIfOutsideViewport(offset: number) {\n\t\tconst scrollTop = this.getViewScrollTop();\n\t\tconst wrapperBottom = this.getViewScrollBottom();\n\n\t\tif (offset < scrollTop || offset > wrapperBottom) {\n\t\t\tconst newTop = Math.max(0, offset - this.view.renderHeight / 2);\n\t\t\tthis.view.setScrollTop(newTop);\n\t\t}\n\t}\n\n\tprivate _revealInCenterIfOutsideViewport(viewIndex: number) {\n\t\tthis._revealInternal(viewIndex, true, CellRevealPosition.Center);\n\t}\n\n\tdomElementOfElement(element: ICellViewModel): HTMLElement | null {\n\t\tconst index = this._getViewIndexUpperBound(element);\n\t\tif (index >= 0 && index < this.length) {\n\t\t\treturn this.view.domElement(index);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tfocusView() {\n\t\tthis.view.domNode.focus();\n\t}\n\n\ttriggerScrollFromMouseWheelEvent(browserEvent: IMouseWheelEvent) {\n\t\tthis.view.delegateScrollFromMouseWheelEvent(browserEvent);\n\t}\n\n\tdelegateVerticalScrollbarPointerDown(browserEvent: PointerEvent) {\n\t\tthis.view.delegateVerticalScrollbarPointerDown(browserEvent);\n\t}\n\n\tprivate isElementAboveViewport(index: number) {\n\t\tconst elementTop = this.view.elementTop(index);\n\t\tconst elementBottom = elementTop + this.view.elementHeight(index);\n\n\t\treturn elementBottom < this.scrollTop;\n\t}\n\n\tupdateElementHeight2(element: ICellViewModel, size: number, anchorElementIndex: number | null = null): void {\n\t\tconst index = this._getViewIndexUpperBound(element);\n\t\tif (index === undefined || index < 0 || index >= this.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isElementAboveViewport(index)) {\n\t\t\t// update element above viewport\n\t\t\tconst oldHeight = this.elementHeight(element);\n\t\t\tconst delta = oldHeight - size;\n\t\t\tif (this._webviewElement) {\n\t\t\t\tEvent.once(this.view.onWillScroll)(() => {\n\t\t\t\t\tconst webviewTop = parseInt(this._webviewElement!.domNode.style.top, 10);\n\t\t\t\t\tif (validateWebviewBoundary(this._webviewElement!.domNode)) {\n\t\t\t\t\t\tthis._webviewElement!.setTop(webviewTop - delta);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// When the webview top boundary is below the list view scrollable element top boundary, then we can't insert a markdown cell at the top\n\t\t\t\t\t\t// or when its bottom boundary is above the list view bottom boundary, then we can't insert a markdown cell at the end\n\t\t\t\t\t\t// thus we have to revert the webview element position to initial state `-NOTEBOOK_WEBVIEW_BOUNDARY`.\n\t\t\t\t\t\t// this will trigger one visual flicker (as we need to update element offsets in the webview)\n\t\t\t\t\t\t// but as long as NOTEBOOK_WEBVIEW_BOUNDARY is large enough, it will happen less often\n\t\t\t\t\t\tthis._webviewElement!.setTop(-NOTEBOOK_WEBVIEW_BOUNDARY);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.view.updateElementHeight(index, size, anchorElementIndex);\n\t\t\tthis.viewZones.layout();\n\t\t\tthis.cellOverlays.layout();\n\t\t\treturn;\n\t\t}\n\n\t\tif (anchorElementIndex !== null) {\n\t\t\tthis.view.updateElementHeight(index, size, anchorElementIndex);\n\t\t\tthis.viewZones.layout();\n\t\t\tthis.cellOverlays.layout();\n\t\t\treturn;\n\t\t}\n\n\t\tconst focused = this.getFocus();\n\t\tconst focus = focused.length ? focused[0] : null;\n\n\t\tif (focus) {\n\t\t\t// If the cell is growing, we should favor anchoring to the focused cell\n\t\t\tconst heightDelta = size - this.view.elementHeight(index);\n\n\t\t\tif (this._notebookCellAnchor.shouldAnchor(this.view, focus, heightDelta, this.element(index))) {\n\t\t\t\tthis.view.updateElementHeight(index, size, focus);\n\t\t\t\tthis.viewZones.layout();\n\t\t\t\tthis.cellOverlays.layout();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.view.updateElementHeight(index, size, null);\n\t\tthis.viewZones.layout();\n\t\tthis.cellOverlays.layout();\n\t\treturn;\n\t}\n\n\tchangeViewZones(callback: (accessor: INotebookViewZoneChangeAccessor) => void): void {\n\t\tif (this.viewZones.changeViewZones(callback)) {\n\t\t\tthis.viewZones.layout();\n\t\t}\n\t}\n\n\tchangeCellOverlays(callback: (accessor: INotebookCellOverlayChangeAccessor) => void): void {\n\t\tif (this.cellOverlays.changeCellOverlays(callback)) {\n\t\t\tthis.cellOverlays.layout();\n\t\t}\n\t}\n\n\tgetViewZoneLayoutInfo(viewZoneId: string): { height: number; top: number } | null {\n\t\treturn this.viewZones.getViewZoneLayoutInfo(viewZoneId);\n\t}\n\n\t// override\n\toverride domFocus() {\n\t\tconst focused = this.getFocusedElements()[0];\n\t\tconst focusedDomElement = focused && this.domElementOfElement(focused);\n\n\t\tif (this.view.domNode.ownerDocument.activeElement && focusedDomElement && focusedDomElement.contains(this.view.domNode.ownerDocument.activeElement)) {\n\t\t\t// for example, when focus goes into monaco editor, if we refocus the list view, the editor will lose focus.\n\t\t\treturn;\n\t\t}\n\n\t\tif (!isMacintosh && this.view.domNode.ownerDocument.activeElement && !!DOM.findParentWithClass(<HTMLElement>this.view.domNode.ownerDocument.activeElement, 'context-view')) {\n\t\t\treturn;\n\t\t}\n\n\t\tsuper.domFocus();\n\t}\n\n\tfocusContainer(clearSelection: boolean) {\n\t\tif (clearSelection) {\n\t\t\t// allow focus to be between cells\n\t\t\tthis._viewModel?.updateSelectionsState({\n\t\t\t\tkind: SelectionStateType.Handle,\n\t\t\t\tprimary: null,\n\t\t\t\tselections: []\n\t\t\t}, 'view');\n\t\t\tthis.setFocus([], undefined, true);\n\t\t\tthis.setSelection([], undefined, true);\n\t\t}\n\n\t\tsuper.domFocus();\n\t}\n\n\tgetViewScrollTop() {\n\t\treturn this.view.getScrollTop();\n\t}\n\n\tgetViewScrollBottom() {\n\t\treturn this.getViewScrollTop() + this.view.renderHeight;\n\t}\n\n\tsetCellEditorSelection(cell: ICellViewModel, range: Range) {\n\t\tconst element = cell as CellViewModel;\n\t\tif (element.editorAttached) {\n\t\t\telement.setSelection(range);\n\t\t} else {\n\t\t\tgetEditorAttachedPromise(element).then(() => { element.setSelection(range); });\n\t\t}\n\t}\n\n\toverride style(styles: IListStyles) {\n\t\tconst selectorSuffix = this.view.domId;\n\t\tif (!this.styleElement) {\n\t\t\tthis.styleElement = domStylesheetsJs.createStyleSheet(this.view.domNode);\n\t\t}\n\t\tconst suffix = selectorSuffix && `.${selectorSuffix}`;\n\t\tconst content: string[] = [];\n\n\t\tif (styles.listBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows { background: ${styles.listBackground}; }`);\n\t\t}\n\n\t\tif (styles.listFocusBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { background-color: ${styles.listFocusBackground}; }`);\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused:hover { background-color: ${styles.listFocusBackground}; }`); // overwrite :hover style in this case!\n\t\t}\n\n\t\tif (styles.listFocusForeground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { color: ${styles.listFocusForeground}; }`);\n\t\t}\n\n\t\tif (styles.listActiveSelectionBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { background-color: ${styles.listActiveSelectionBackground}; }`);\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected:hover { background-color: ${styles.listActiveSelectionBackground}; }`); // overwrite :hover style in this case!\n\t\t}\n\n\t\tif (styles.listActiveSelectionForeground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { color: ${styles.listActiveSelectionForeground}; }`);\n\t\t}\n\n\t\tif (styles.listFocusAndSelectionBackground) {\n\t\t\tcontent.push(`\n\t\t\t\t.monaco-drag-image${suffix},\n\t\t\t\t.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected.focused { background-color: ${styles.listFocusAndSelectionBackground}; }\n\t\t\t`);\n\t\t}\n\n\t\tif (styles.listFocusAndSelectionForeground) {\n\t\t\tcontent.push(`\n\t\t\t\t.monaco-drag-image${suffix},\n\t\t\t\t.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected.focused { color: ${styles.listFocusAndSelectionForeground}; }\n\t\t\t`);\n\t\t}\n\n\t\tif (styles.listInactiveFocusBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { background-color:  ${styles.listInactiveFocusBackground}; }`);\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused:hover { background-color:  ${styles.listInactiveFocusBackground}; }`); // overwrite :hover style in this case!\n\t\t}\n\n\t\tif (styles.listInactiveSelectionBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { background-color:  ${styles.listInactiveSelectionBackground}; }`);\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected:hover { background-color:  ${styles.listInactiveSelectionBackground}; }`); // overwrite :hover style in this case!\n\t\t}\n\n\t\tif (styles.listInactiveSelectionForeground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { color: ${styles.listInactiveSelectionForeground}; }`);\n\t\t}\n\n\t\tif (styles.listHoverBackground) {\n\t\t\tcontent.push(`.monaco-list${suffix}:not(.drop-target) > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row:hover:not(.selected):not(.focused) { background-color:  ${styles.listHoverBackground}; }`);\n\t\t}\n\n\t\tif (styles.listHoverForeground) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row:hover:not(.selected):not(.focused) { color:  ${styles.listHoverForeground}; }`);\n\t\t}\n\n\t\tif (styles.listSelectionOutline) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.selected { outline: 1px dotted ${styles.listSelectionOutline}; outline-offset: -1px; }`);\n\t\t}\n\n\t\tif (styles.listFocusOutline) {\n\t\t\tcontent.push(`\n\t\t\t\t.monaco-drag-image${suffix},\n\t\t\t\t.monaco-list${suffix}:focus > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { outline: 1px solid ${styles.listFocusOutline}; outline-offset: -1px; }\n\t\t\t`);\n\t\t}\n\n\t\tif (styles.listInactiveFocusOutline) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row.focused { outline: 1px dotted ${styles.listInactiveFocusOutline}; outline-offset: -1px; }`);\n\t\t}\n\n\t\tif (styles.listHoverOutline) {\n\t\t\tcontent.push(`.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows > .monaco-list-row:hover { outline: 1px dashed ${styles.listHoverOutline}; outline-offset: -1px; }`);\n\t\t}\n\n\t\tif (styles.listDropOverBackground) {\n\t\t\tcontent.push(`\n\t\t\t\t.monaco-list${suffix}.drop-target,\n\t\t\t\t.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-rows.drop-target,\n\t\t\t\t.monaco-list${suffix} > div.monaco-scrollable-element > .monaco-list-row.drop-target { background-color: ${styles.listDropOverBackground} !important; color: inherit !important; }\n\t\t\t`);\n\t\t}\n\n\t\tconst newStyles = content.join('\\n');\n\t\tif (newStyles !== this.styleElement.textContent) {\n\t\t\tthis.styleElement.textContent = newStyles;\n\t\t}\n\t}\n\n\tgetRenderHeight() {\n\t\treturn this.view.renderHeight;\n\t}\n\n\tgetScrollHeight() {\n\t\treturn this.view.scrollHeight;\n\t}\n\n\toverride layout(height?: number, width?: number): void {\n\t\tthis._isInLayout = true;\n\t\tsuper.layout(height, width);\n\t\tif (this.renderHeight === 0) {\n\t\t\tthis.view.domNode.style.visibility = 'hidden';\n\t\t} else {\n\t\t\tthis.view.domNode.style.visibility = 'initial';\n\t\t}\n\t\tthis._isInLayout = false;\n\t}\n\n\toverride dispose() {\n\t\tthis._isDisposed = true;\n\t\tthis._viewModelStore.dispose();\n\t\tthis._localDisposableStore.dispose();\n\t\tthis._notebookCellAnchor.dispose();\n\t\tthis.viewZones.dispose();\n\t\tthis.cellOverlays.dispose();\n\t\tsuper.dispose();\n\n\t\t// un-ref\n\t\tthis._previousFocusedElements = [];\n\t\tthis._viewModel = null;\n\t\tthis._hiddenRangeIds = [];\n\t\tthis.hiddenRangesPrefixSum = null;\n\t\tthis._visibleRanges = [];\n\t}\n}\n\n\nexport class ListViewInfoAccessor extends Disposable {\n\tconstructor(\n\t\treadonly list: INotebookCellList\n\t) {\n\t\tsuper();\n\t}\n\n\tgetViewIndex(cell: ICellViewModel): number {\n\t\treturn this.list.getViewIndex(cell) ?? -1;\n\t}\n\n\tgetViewHeight(cell: ICellViewModel): number {\n\t\tif (!this.list.viewModel) {\n\t\t\treturn -1;\n\t\t}\n\n\t\treturn this.list.elementHeight(cell);\n\t}\n\n\tgetCellRangeFromViewRange(startIndex: number, endIndex: number): ICellRange | undefined {\n\t\tif (!this.list.viewModel) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst modelIndex = this.list.getModelIndex2(startIndex);\n\t\tif (modelIndex === undefined) {\n\t\t\tthrow new Error(`startIndex ${startIndex} out of boundary`);\n\t\t}\n\n\t\tif (endIndex >= this.list.length) {\n\t\t\t// it's the end\n\t\t\tconst endModelIndex = this.list.viewModel.length;\n\t\t\treturn { start: modelIndex, end: endModelIndex };\n\t\t} else {\n\t\t\tconst endModelIndex = this.list.getModelIndex2(endIndex);\n\t\t\tif (endModelIndex === undefined) {\n\t\t\t\tthrow new Error(`endIndex ${endIndex} out of boundary`);\n\t\t\t}\n\t\t\treturn { start: modelIndex, end: endModelIndex };\n\t\t}\n\t}\n\n\tgetCellsFromViewRange(startIndex: number, endIndex: number): ReadonlyArray<ICellViewModel> {\n\t\tif (!this.list.viewModel) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst range = this.getCellRangeFromViewRange(startIndex, endIndex);\n\t\tif (!range) {\n\t\t\treturn [];\n\t\t}\n\n\t\treturn this.list.viewModel.getCellsInRange(range);\n\t}\n\n\tgetCellsInRange(range?: ICellRange): ReadonlyArray<ICellViewModel> {\n\t\treturn this.list.viewModel?.getCellsInRange(range) ?? [];\n\t}\n\n\tgetVisibleRangesPlusViewportAboveAndBelow(): ICellRange[] {\n\t\treturn this.list?.getVisibleRangesPlusViewportAboveAndBelow() ?? [];\n\t}\n}\n\nfunction getEditorAttachedPromise(element: ICellViewModel) {\n\treturn new Promise<void>((resolve, reject) => {\n\t\tEvent.once(element.onDidChangeEditorAttachState)(() => element.editorAttached ? resolve() : reject());\n\t});\n}\n"]}