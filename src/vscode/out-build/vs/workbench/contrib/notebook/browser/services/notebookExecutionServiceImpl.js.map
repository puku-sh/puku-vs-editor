{"version":3,"sources":["vs/workbench/contrib/notebook/browser/services/notebookExecutionServiceImpl.ts"],"names":[],"mappings":"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","file":"notebookExecutionServiceImpl.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationTokenSource } from '../../../../../base/common/cancellation.js';\nimport { IDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport * as nls from '../../../../../nls.js';\nimport { ICommandService } from '../../../../../platform/commands/common/commands.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IWorkspaceTrustRequestService } from '../../../../../platform/workspace/common/workspaceTrust.js';\nimport { KernelPickerMRUStrategy } from '../viewParts/notebookKernelQuickPickStrategy.js';\nimport { NotebookCellTextModel } from '../../common/model/notebookCellTextModel.js';\nimport { CellKind, INotebookTextModel, NotebookCellExecutionState } from '../../common/notebookCommon.js';\nimport { INotebookExecutionService, ICellExecutionParticipant } from '../../common/notebookExecutionService.js';\nimport { INotebookCellExecution, INotebookExecutionStateService } from '../../common/notebookExecutionStateService.js';\nimport { INotebookKernelHistoryService, INotebookKernelService } from '../../common/notebookKernelService.js';\nimport { INotebookLoggingService } from '../../common/notebookLoggingService.js';\n\n\nexport class NotebookExecutionService implements INotebookExecutionService, IDisposable {\n\tdeclare _serviceBrand: undefined;\n\tprivate _activeProxyKernelExecutionToken: CancellationTokenSource | undefined;\n\n\tconstructor(\n\t\t@ICommandService private readonly _commandService: ICommandService,\n\t\t@INotebookKernelService private readonly _notebookKernelService: INotebookKernelService,\n\t\t@INotebookKernelHistoryService private readonly _notebookKernelHistoryService: INotebookKernelHistoryService,\n\t\t@IWorkspaceTrustRequestService private readonly _workspaceTrustRequestService: IWorkspaceTrustRequestService,\n\t\t@INotebookLoggingService private readonly _logService: INotebookLoggingService,\n\t\t@INotebookExecutionStateService private readonly _notebookExecutionStateService: INotebookExecutionStateService,\n\t) {\n\t}\n\n\tasync executeNotebookCells(notebook: INotebookTextModel, cells: Iterable<NotebookCellTextModel>, contextKeyService: IContextKeyService): Promise<void> {\n\t\tconst cellsArr = Array.from(cells)\n\t\t\t.filter(c => c.cellKind === CellKind.Code);\n\t\tif (!cellsArr.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._logService.debug(`Execution`, `${JSON.stringify(cellsArr.map(c => c.handle))}`);\n\t\tconst message = nls.localize('notebookRunTrust', \"Executing a notebook cell will run code from this workspace.\");\n\t\tconst trust = await this._workspaceTrustRequestService.requestWorkspaceTrust({ message });\n\t\tif (!trust) {\n\t\t\treturn;\n\t\t}\n\n\t\t// create cell executions\n\t\tconst cellExecutions: [NotebookCellTextModel, INotebookCellExecution][] = [];\n\t\tfor (const cell of cellsArr) {\n\t\t\tconst cellExe = this._notebookExecutionStateService.getCellExecution(cell.uri);\n\t\t\tif (!!cellExe) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tcellExecutions.push([cell, this._notebookExecutionStateService.createCellExecution(notebook.uri, cell.handle)]);\n\t\t}\n\n\t\tconst kernel = await KernelPickerMRUStrategy.resolveKernel(notebook, this._notebookKernelService, this._notebookKernelHistoryService, this._commandService);\n\n\t\tif (!kernel) {\n\t\t\t// clear all pending cell executions\n\t\t\tcellExecutions.forEach(cellExe => cellExe[1].complete({}));\n\t\t\treturn;\n\t\t}\n\n\t\tthis._notebookKernelHistoryService.addMostRecentKernel(kernel);\n\n\t\t// filter cell executions based on selected kernel\n\t\tconst validCellExecutions: INotebookCellExecution[] = [];\n\t\tfor (const [cell, cellExecution] of cellExecutions) {\n\t\t\tif (!kernel.supportedLanguages.includes(cell.language)) {\n\t\t\t\tcellExecution.complete({});\n\t\t\t} else {\n\t\t\t\tvalidCellExecutions.push(cellExecution);\n\t\t\t}\n\t\t}\n\n\t\t// request execution\n\t\tif (validCellExecutions.length > 0) {\n\t\t\tawait this.runExecutionParticipants(validCellExecutions);\n\n\t\t\tthis._notebookKernelService.selectKernelForNotebook(kernel, notebook);\n\t\t\tawait kernel.executeNotebookCellsRequest(notebook.uri, validCellExecutions.map(c => c.cellHandle));\n\t\t\t// the connecting state can change before the kernel resolves executeNotebookCellsRequest\n\t\t\tconst unconfirmed = validCellExecutions.filter(exe => exe.state === NotebookCellExecutionState.Unconfirmed);\n\t\t\tif (unconfirmed.length) {\n\t\t\t\tthis._logService.debug(`Execution`, `Completing unconfirmed executions ${JSON.stringify(unconfirmed.map(exe => exe.cellHandle))}`);\n\t\t\t\tunconfirmed.forEach(exe => exe.complete({}));\n\t\t\t}\n\t\t\tthis._logService.debug(`Execution`, `Completed executions ${JSON.stringify(validCellExecutions.map(exe => exe.cellHandle))}`);\n\t\t}\n\t}\n\n\tasync cancelNotebookCellHandles(notebook: INotebookTextModel, cells: Iterable<number>): Promise<void> {\n\t\tconst cellsArr = Array.from(cells);\n\t\tthis._logService.debug(`Execution`, `CancelNotebookCellHandles ${JSON.stringify(cellsArr)}`);\n\t\tconst kernel = this._notebookKernelService.getSelectedOrSuggestedKernel(notebook);\n\t\tif (kernel) {\n\t\t\tawait kernel.cancelNotebookCellExecution(notebook.uri, cellsArr);\n\n\t\t}\n\t}\n\n\tasync cancelNotebookCells(notebook: INotebookTextModel, cells: Iterable<NotebookCellTextModel>): Promise<void> {\n\t\tthis.cancelNotebookCellHandles(notebook, Array.from(cells, cell => cell.handle));\n\t}\n\n\tprivate readonly cellExecutionParticipants = new Set<ICellExecutionParticipant>;\n\n\tregisterExecutionParticipant(participant: ICellExecutionParticipant) {\n\t\tthis.cellExecutionParticipants.add(participant);\n\t\treturn toDisposable(() => this.cellExecutionParticipants.delete(participant));\n\t}\n\n\tprivate async runExecutionParticipants(executions: INotebookCellExecution[]): Promise<void> {\n\t\tfor (const participant of this.cellExecutionParticipants) {\n\t\t\tawait participant.onWillExecuteCell(executions);\n\t\t}\n\t\treturn;\n\t}\n\n\tdispose() {\n\t\tthis._activeProxyKernelExecutionToken?.dispose(true);\n\t}\n}\n"]}