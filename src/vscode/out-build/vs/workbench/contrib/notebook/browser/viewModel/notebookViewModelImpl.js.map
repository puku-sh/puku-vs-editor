{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/browser/viewModel/notebookViewModelImpl.ts","vs/workbench/contrib/notebook/browser/viewModel/notebookViewModelImpl.ts"],"names":[],"mappings":"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","file":"notebookViewModelImpl.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { groupBy } from '../../../../../base/common/collections.js';\nimport { onUnexpectedError } from '../../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable, DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { clamp } from '../../../../../base/common/numbers.js';\nimport * as strings from '../../../../../base/common/strings.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { IBulkEditService, ResourceTextEdit } from '../../../../../editor/browser/services/bulkEditService.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport * as editorCommon from '../../../../../editor/common/editorCommon.js';\nimport { IWorkspaceTextEdit } from '../../../../../editor/common/languages.js';\nimport { FindMatch, IModelDecorationOptions, IModelDeltaDecoration, TrackedRangeStickiness } from '../../../../../editor/common/model.js';\nimport { MultiModelEditStackElement, SingleModelEditStackElement } from '../../../../../editor/common/model/editStack.js';\nimport { IntervalNode, IntervalTree } from '../../../../../editor/common/model/intervalTree.js';\nimport { ModelDecorationOptions } from '../../../../../editor/common/model/textModel.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { FoldingRegions } from '../../../../../editor/contrib/folding/browser/foldingRanges.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IUndoRedoService } from '../../../../../platform/undoRedo/common/undoRedo.js';\nimport { CellFindMatchModel } from '../contrib/find/findModel.js';\nimport { CellEditState, CellFindMatchWithIndex, CellFoldingState, EditorFoldingStateDelegate, ICellModelDecorations, ICellModelDeltaDecorations, ICellViewModel, IModelDecorationsChangeAccessor, INotebookDeltaCellStatusBarItems, INotebookEditorViewState, INotebookViewCellsUpdateEvent, INotebookViewModel, INotebookDeltaDecoration, isNotebookCellDecoration, INotebookDeltaViewZoneDecoration } from '../notebookBrowser.js';\nimport { NotebookLayoutInfo, NotebookMetadataChangedEvent } from '../notebookViewEvents.js';\nimport { NotebookCellSelectionCollection } from './cellSelectionCollection.js';\nimport { CodeCellViewModel } from './codeCellViewModel.js';\nimport { MarkupCellViewModel } from './markupCellViewModel.js';\nimport { ViewContext } from './viewContext.js';\nimport { NotebookCellTextModel } from '../../common/model/notebookCellTextModel.js';\nimport { NotebookTextModel } from '../../common/model/notebookTextModel.js';\nimport { CellKind, ICell, INotebookFindOptions, ISelectionState, NotebookCellsChangeType, NotebookCellTextModelSplice, NotebookFindScopeType, SelectionStateType } from '../../common/notebookCommon.js';\nimport { INotebookExecutionStateService, NotebookExecutionType } from '../../common/notebookExecutionStateService.js';\nimport { cellIndexesToRanges, cellRangesToIndexes, ICellRange, reduceCellRanges } from '../../common/notebookRange.js';\n\nconst invalidFunc = () => { throw new Error(`Invalid change accessor`); };\n\nclass DecorationsTree {\n\tprivate readonly _decorationsTree: IntervalTree;\n\n\tconstructor() {\n\t\tthis._decorationsTree = new IntervalTree();\n\t}\n\n\tpublic intervalSearch(start: number, end: number, filterOwnerId: number, filterOutValidation: boolean, filterFontDecorations: boolean, cachedVersionId: number, onlyMarginDecorations: boolean = false): IntervalNode[] {\n\t\tconst r1 = this._decorationsTree.intervalSearch(start, end, filterOwnerId, filterOutValidation, filterFontDecorations, cachedVersionId, onlyMarginDecorations);\n\t\treturn r1;\n\t}\n\n\tpublic search(filterOwnerId: number, filterOutValidation: boolean, filterFontDecorations: boolean, overviewRulerOnly: boolean, cachedVersionId: number, onlyMarginDecorations: boolean): IntervalNode[] {\n\t\treturn this._decorationsTree.search(filterOwnerId, filterOutValidation, filterFontDecorations, cachedVersionId, onlyMarginDecorations);\n\n\t}\n\n\tpublic collectNodesFromOwner(ownerId: number): IntervalNode[] {\n\t\tconst r1 = this._decorationsTree.collectNodesFromOwner(ownerId);\n\t\treturn r1;\n\t}\n\n\tpublic collectNodesPostOrder(): IntervalNode[] {\n\t\tconst r1 = this._decorationsTree.collectNodesPostOrder();\n\t\treturn r1;\n\t}\n\n\tpublic insert(node: IntervalNode): void {\n\t\tthis._decorationsTree.insert(node);\n\t}\n\n\tpublic delete(node: IntervalNode): void {\n\t\tthis._decorationsTree.delete(node);\n\t}\n\n\tpublic resolveNode(node: IntervalNode, cachedVersionId: number): void {\n\t\tthis._decorationsTree.resolveNode(node, cachedVersionId);\n\t}\n\n\tpublic acceptReplace(offset: number, length: number, textLength: number, forceMoveMarkers: boolean): void {\n\t\tthis._decorationsTree.acceptReplace(offset, length, textLength, forceMoveMarkers);\n\t}\n}\n\nconst TRACKED_RANGE_OPTIONS = [\n\tModelDecorationOptions.register({ description: 'notebook-view-model-tracked-range-always-grows-when-typing-at-edges', stickiness: TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges }),\n\tModelDecorationOptions.register({ description: 'notebook-view-model-tracked-range-never-grows-when-typing-at-edges', stickiness: TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges }),\n\tModelDecorationOptions.register({ description: 'notebook-view-model-tracked-range-grows-only-when-typing-before', stickiness: TrackedRangeStickiness.GrowsOnlyWhenTypingBefore }),\n\tModelDecorationOptions.register({ description: 'notebook-view-model-tracked-range-grows-only-when-typing-after', stickiness: TrackedRangeStickiness.GrowsOnlyWhenTypingAfter }),\n];\n\nfunction _normalizeOptions(options: IModelDecorationOptions): ModelDecorationOptions {\n\tif (options instanceof ModelDecorationOptions) {\n\t\treturn options;\n\t}\n\treturn ModelDecorationOptions.createDynamic(options);\n}\n\nlet MODEL_ID = 0;\n\nexport interface NotebookViewModelOptions {\n\tisReadOnly: boolean;\n}\n\nexport class NotebookViewModel extends Disposable implements EditorFoldingStateDelegate, INotebookViewModel {\n\tprivate readonly _localStore = this._register(new DisposableStore());\n\tprivate _handleToViewCellMapping = new Map<number, CellViewModel>();\n\tget options(): NotebookViewModelOptions { return this._options; }\n\tprivate readonly _onDidChangeOptions = this._register(new Emitter<void>());\n\tget onDidChangeOptions(): Event<void> { return this._onDidChangeOptions.event; }\n\tprivate _viewCells: CellViewModel[] = [];\n\n\tget viewCells(): ICellViewModel[] {\n\t\treturn this._viewCells;\n\t}\n\n\tget length(): number {\n\t\treturn this._viewCells.length;\n\t}\n\n\tget notebookDocument() {\n\t\treturn this._notebook;\n\t}\n\n\tget uri() {\n\t\treturn this._notebook.uri;\n\t}\n\n\tget metadata() {\n\t\treturn this._notebook.metadata;\n\t}\n\n\tprivate get isRepl() {\n\t\treturn this.viewType === 'repl';\n\t}\n\n\tprivate readonly _onDidChangeViewCells = this._register(new Emitter<INotebookViewCellsUpdateEvent>());\n\tget onDidChangeViewCells(): Event<INotebookViewCellsUpdateEvent> { return this._onDidChangeViewCells.event; }\n\n\tprivate _lastNotebookEditResource: URI[] = [];\n\n\tget lastNotebookEditResource(): URI | null {\n\t\tif (this._lastNotebookEditResource.length) {\n\t\t\treturn this._lastNotebookEditResource[this._lastNotebookEditResource.length - 1];\n\t\t}\n\t\treturn null;\n\t}\n\n\tget layoutInfo(): NotebookLayoutInfo | null {\n\t\treturn this._layoutInfo;\n\t}\n\n\tprivate readonly _onDidChangeSelection = this._register(new Emitter<string>());\n\tget onDidChangeSelection(): Event<string> { return this._onDidChangeSelection.event; }\n\n\tprivate _selectionCollection = this._register(new NotebookCellSelectionCollection());\n\n\tprivate get selectionHandles() {\n\t\tconst handlesSet = new Set<number>();\n\t\tconst handles: number[] = [];\n\t\tcellRangesToIndexes(this._selectionCollection.selections).map(index => index < this.length ? this.cellAt(index) : undefined).forEach(cell => {\n\t\t\tif (cell && !handlesSet.has(cell.handle)) {\n\t\t\t\thandles.push(cell.handle);\n\t\t\t}\n\t\t});\n\n\t\treturn handles;\n\t}\n\n\tprivate set selectionHandles(selectionHandles: number[]) {\n\t\tconst indexes = selectionHandles.map(handle => this._viewCells.findIndex(cell => cell.handle === handle));\n\t\tthis._selectionCollection.setSelections(cellIndexesToRanges(indexes), true, 'model');\n\t}\n\n\tprivate _decorationsTree = new DecorationsTree();\n\tprivate _decorations: { [decorationId: string]: IntervalNode } = Object.create(null);\n\tprivate _lastDecorationId: number = 0;\n\tprivate readonly _instanceId: string;\n\tpublic readonly id: string;\n\tprivate _foldingRanges: FoldingRegions | null = null;\n\tprivate _onDidFoldingStateChanged = new Emitter<void>();\n\treadonly onDidFoldingStateChanged: Event<void> = this._onDidFoldingStateChanged.event;\n\tprivate _hiddenRanges: ICellRange[] = [];\n\tprivate _focused: boolean = true;\n\n\tget focused() {\n\t\treturn this._focused;\n\t}\n\n\tprivate _decorationIdToCellMap = new Map<string, number>();\n\tprivate _statusBarItemIdToCellMap = new Map<string, number>();\n\n\tprivate _lastOverviewRulerDecorationId: number = 0;\n\tprivate _overviewRulerDecorations = new Map<string, INotebookDeltaViewZoneDecoration>();\n\n\tconstructor(\n\t\tpublic viewType: string,\n\t\tprivate _notebook: NotebookTextModel,\n\t\tprivate _viewContext: ViewContext,\n\t\tprivate _layoutInfo: NotebookLayoutInfo | null,\n\t\tprivate _options: NotebookViewModelOptions,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IBulkEditService private readonly _bulkEditService: IBulkEditService,\n\t\t@IUndoRedoService private readonly _undoService: IUndoRedoService,\n\t\t@ITextModelService private readonly _textModelService: ITextModelService,\n\t\t@INotebookExecutionStateService private readonly notebookExecutionStateService: INotebookExecutionStateService,\n\t) {\n\t\tsuper();\n\n\t\tMODEL_ID++;\n\t\tthis.id = '$notebookViewModel' + MODEL_ID;\n\t\tthis._instanceId = strings.singleLetterHash(MODEL_ID);\n\n\t\tconst compute = (changes: NotebookCellTextModelSplice<ICell>[], synchronous: boolean) => {\n\t\t\tconst diffs = changes.map(splice => {\n\t\t\t\treturn [splice[0], splice[1], splice[2].map(cell => {\n\t\t\t\t\treturn createCellViewModel(this._instantiationService, this, cell as NotebookCellTextModel, this._viewContext);\n\t\t\t\t})] as [number, number, CellViewModel[]];\n\t\t\t});\n\n\t\t\tdiffs.reverse().forEach(diff => {\n\t\t\t\tconst deletedCells = this._viewCells.splice(diff[0], diff[1], ...diff[2]);\n\n\t\t\t\tthis._decorationsTree.acceptReplace(diff[0], diff[1], diff[2].length, true);\n\t\t\t\tdeletedCells.forEach(cell => {\n\t\t\t\t\tthis._handleToViewCellMapping.delete(cell.handle);\n\t\t\t\t\t// dispose the cell to release ref to the cell text document\n\t\t\t\t\tcell.dispose();\n\t\t\t\t});\n\n\t\t\t\tdiff[2].forEach(cell => {\n\t\t\t\t\tthis._handleToViewCellMapping.set(cell.handle, cell);\n\t\t\t\t\tthis._localStore.add(cell);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tconst selectionHandles = this.selectionHandles;\n\n\t\t\tthis._onDidChangeViewCells.fire({\n\t\t\t\tsynchronous: synchronous,\n\t\t\t\tsplices: diffs\n\t\t\t});\n\n\t\t\tlet endSelectionHandles: number[] = [];\n\t\t\tif (selectionHandles.length) {\n\t\t\t\tconst primaryHandle = selectionHandles[0];\n\t\t\t\tconst primarySelectionIndex = this._viewCells.indexOf(this.getCellByHandle(primaryHandle)!);\n\t\t\t\tendSelectionHandles = [primaryHandle];\n\t\t\t\tlet delta = 0;\n\n\t\t\t\tfor (let i = 0; i < diffs.length; i++) {\n\t\t\t\t\tconst diff = diffs[0];\n\t\t\t\t\tif (diff[0] + diff[1] <= primarySelectionIndex) {\n\t\t\t\t\t\tdelta += diff[2].length - diff[1];\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (diff[0] > primarySelectionIndex) {\n\t\t\t\t\t\tendSelectionHandles = [primaryHandle];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (diff[0] + diff[1] > primarySelectionIndex) {\n\t\t\t\t\t\tendSelectionHandles = [this._viewCells[diff[0] + delta].handle];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// TODO@rebornix\n\t\t\tconst selectionIndexes = endSelectionHandles.map(handle => this._viewCells.findIndex(cell => cell.handle === handle));\n\t\t\tthis._selectionCollection.setState(cellIndexesToRanges([selectionIndexes[0]])[0], cellIndexesToRanges(selectionIndexes), true, 'model');\n\t\t};\n\n\t\tthis._register(this._notebook.onDidChangeContent(e => {\n\t\t\tfor (let i = 0; i < e.rawEvents.length; i++) {\n\t\t\t\tconst change = e.rawEvents[i];\n\t\t\t\tlet changes: NotebookCellTextModelSplice<ICell>[] = [];\n\t\t\t\tconst synchronous = e.synchronous ?? true;\n\n\t\t\t\tif (change.kind === NotebookCellsChangeType.ModelChange || change.kind === NotebookCellsChangeType.Initialize) {\n\t\t\t\t\tchanges = change.changes;\n\t\t\t\t\tcompute(changes, synchronous);\n\t\t\t\t\tcontinue;\n\t\t\t\t} else if (change.kind === NotebookCellsChangeType.Move) {\n\t\t\t\t\tcompute([[change.index, change.length, []]], synchronous);\n\t\t\t\t\tcompute([[change.newIdx, 0, change.cells]], synchronous);\n\t\t\t\t} else {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._notebook.onDidChangeContent(contentChanges => {\n\t\t\tcontentChanges.rawEvents.forEach(e => {\n\t\t\t\tif (e.kind === NotebookCellsChangeType.ChangeDocumentMetadata) {\n\t\t\t\t\tthis._viewContext.eventDispatcher.emit([new NotebookMetadataChangedEvent(this._notebook.metadata)]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (contentChanges.endSelectionState) {\n\t\t\t\tthis.updateSelectionsState(contentChanges.endSelectionState);\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._viewContext.eventDispatcher.onDidChangeLayout((e) => {\n\t\t\tthis._layoutInfo = e.value;\n\n\t\t\tthis._viewCells.forEach(cell => {\n\t\t\t\tif (cell.cellKind === CellKind.Markup) {\n\t\t\t\t\tif (e.source.width || e.source.fontInfo) {\n\t\t\t\t\t\tcell.layoutChange({ outerWidth: e.value.width, font: e.value.fontInfo });\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (e.source.width !== undefined) {\n\t\t\t\t\t\tcell.layoutChange({ outerWidth: e.value.width, font: e.value.fontInfo });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}));\n\n\t\tthis._register(this._viewContext.notebookOptions.onDidChangeOptions(e => {\n\t\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\t\tconst cell = this._viewCells[i];\n\t\t\t\tcell.updateOptions(e);\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(notebookExecutionStateService.onDidChangeExecution(e => {\n\t\t\tif (e.type !== NotebookExecutionType.cell) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst cell = this.getCellByHandle(e.cellHandle);\n\n\t\t\tif (cell instanceof CodeCellViewModel) {\n\t\t\t\tcell.updateExecutionState(e);\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._selectionCollection.onDidChangeSelection(e => {\n\t\t\tthis._onDidChangeSelection.fire(e);\n\t\t}));\n\n\n\t\tconst viewCellCount = this.isRepl ? this._notebook.cells.length - 1 : this._notebook.cells.length;\n\t\tfor (let i = 0; i < viewCellCount; i++) {\n\t\t\tthis._viewCells.push(createCellViewModel(this._instantiationService, this, this._notebook.cells[i], this._viewContext));\n\t\t}\n\n\n\t\tthis._viewCells.forEach(cell => {\n\t\t\tthis._handleToViewCellMapping.set(cell.handle, cell);\n\t\t});\n\t}\n\n\tupdateOptions(newOptions: Partial<NotebookViewModelOptions>) {\n\t\tthis._options = { ...this._options, ...newOptions };\n\t\tthis._viewCells.forEach(cell => cell.updateOptions({ readonly: this._options.isReadOnly }));\n\t\tthis._onDidChangeOptions.fire();\n\t}\n\n\tgetFocus() {\n\t\treturn this._selectionCollection.focus;\n\t}\n\n\tgetSelections() {\n\t\treturn this._selectionCollection.selections;\n\t}\n\n\tgetMostRecentlyExecutedCell(): ICellViewModel | undefined {\n\t\tconst handle = this.notebookExecutionStateService.getLastCompletedCellForNotebook(this._notebook.uri);\n\t\treturn handle !== undefined ? this.getCellByHandle(handle) : undefined;\n\t}\n\n\tsetEditorFocus(focused: boolean) {\n\t\tthis._focused = focused;\n\t}\n\n\tvalidateRange(cellRange: ICellRange | null | undefined): ICellRange | null {\n\t\tif (!cellRange) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst start = clamp(cellRange.start, 0, this.length);\n\t\tconst end = clamp(cellRange.end, 0, this.length);\n\n\t\tif (start <= end) {\n\t\t\treturn { start, end };\n\t\t} else {\n\t\t\treturn { start: end, end: start };\n\t\t}\n\t}\n\n\t// selection change from list view's `setFocus` and `setSelection` should always use `source: view` to prevent events breaking the list view focus/selection change transaction\n\tupdateSelectionsState(state: ISelectionState, source: 'view' | 'model' = 'model') {\n\t\tif (this._focused || source === 'model') {\n\t\t\tif (state.kind === SelectionStateType.Handle) {\n\t\t\t\tconst primaryIndex = state.primary !== null ? this.getCellIndexByHandle(state.primary) : null;\n\t\t\t\tconst primarySelection = primaryIndex !== null ? this.validateRange({ start: primaryIndex, end: primaryIndex + 1 }) : null;\n\t\t\t\tconst selections = cellIndexesToRanges(state.selections.map(sel => this.getCellIndexByHandle(sel)))\n\t\t\t\t\t.map(range => this.validateRange(range))\n\t\t\t\t\t.filter(range => range !== null) as ICellRange[];\n\t\t\t\tthis._selectionCollection.setState(primarySelection, reduceCellRanges(selections), true, source);\n\t\t\t} else {\n\t\t\t\tconst primarySelection = this.validateRange(state.focus);\n\t\t\t\tconst selections = state.selections\n\t\t\t\t\t.map(range => this.validateRange(range))\n\t\t\t\t\t.filter(range => range !== null) as ICellRange[];\n\t\t\t\tthis._selectionCollection.setState(primarySelection, reduceCellRanges(selections), true, source);\n\t\t\t}\n\t\t}\n\t}\n\n\tgetFoldingStartIndex(index: number): number {\n\t\tif (!this._foldingRanges) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tconst range = this._foldingRanges.findRange(index + 1);\n\t\tconst startIndex = this._foldingRanges.getStartLineNumber(range) - 1;\n\t\treturn startIndex;\n\t}\n\n\tgetFoldingState(index: number): CellFoldingState {\n\t\tif (!this._foldingRanges) {\n\t\t\treturn CellFoldingState.None;\n\t\t}\n\n\t\tconst range = this._foldingRanges.findRange(index + 1);\n\t\tconst startIndex = this._foldingRanges.getStartLineNumber(range) - 1;\n\n\t\tif (startIndex !== index) {\n\t\t\treturn CellFoldingState.None;\n\t\t}\n\n\t\treturn this._foldingRanges.isCollapsed(range) ? CellFoldingState.Collapsed : CellFoldingState.Expanded;\n\t}\n\n\tgetFoldedLength(index: number): number {\n\t\tif (!this._foldingRanges) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst range = this._foldingRanges.findRange(index + 1);\n\t\tconst startIndex = this._foldingRanges.getStartLineNumber(range) - 1;\n\t\tconst endIndex = this._foldingRanges.getEndLineNumber(range) - 1;\n\n\t\treturn endIndex - startIndex;\n\t}\n\n\tupdateFoldingRanges(ranges: FoldingRegions) {\n\t\tthis._foldingRanges = ranges;\n\t\tlet updateHiddenAreas = false;\n\t\tconst newHiddenAreas: ICellRange[] = [];\n\n\t\tlet i = 0; // index into hidden\n\t\tlet k = 0;\n\n\t\tlet lastCollapsedStart = Number.MAX_VALUE;\n\t\tlet lastCollapsedEnd = -1;\n\n\t\tfor (; i < ranges.length; i++) {\n\t\t\tif (!ranges.isCollapsed(i)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst startLineNumber = ranges.getStartLineNumber(i) + 1; // the first line is not hidden\n\t\t\tconst endLineNumber = ranges.getEndLineNumber(i);\n\t\t\tif (lastCollapsedStart <= startLineNumber && endLineNumber <= lastCollapsedEnd) {\n\t\t\t\t// ignore ranges contained in collapsed regions\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (!updateHiddenAreas && k < this._hiddenRanges.length && this._hiddenRanges[k].start + 1 === startLineNumber && (this._hiddenRanges[k].end + 1) === endLineNumber) {\n\t\t\t\t// reuse the old ranges\n\t\t\t\tnewHiddenAreas.push(this._hiddenRanges[k]);\n\t\t\t\tk++;\n\t\t\t} else {\n\t\t\t\tupdateHiddenAreas = true;\n\t\t\t\tnewHiddenAreas.push({ start: startLineNumber - 1, end: endLineNumber - 1 });\n\t\t\t}\n\t\t\tlastCollapsedStart = startLineNumber;\n\t\t\tlastCollapsedEnd = endLineNumber;\n\t\t}\n\n\t\tif (updateHiddenAreas || k < this._hiddenRanges.length) {\n\t\t\tthis._hiddenRanges = newHiddenAreas;\n\t\t\tthis._onDidFoldingStateChanged.fire();\n\t\t}\n\n\t\tthis._viewCells.forEach(cell => {\n\t\t\tif (cell.cellKind === CellKind.Markup) {\n\t\t\t\tcell.triggerFoldingStateChange();\n\t\t\t}\n\t\t});\n\t}\n\n\tgetHiddenRanges() {\n\t\treturn this._hiddenRanges;\n\t}\n\n\tgetOverviewRulerDecorations(): INotebookDeltaViewZoneDecoration[] {\n\t\treturn Array.from(this._overviewRulerDecorations.values());\n\t}\n\n\tgetCellByHandle(handle: number) {\n\t\treturn this._handleToViewCellMapping.get(handle);\n\t}\n\n\tgetCellIndexByHandle(handle: number): number {\n\t\treturn this._viewCells.findIndex(cell => cell.handle === handle);\n\t}\n\n\tgetCellIndex(cell: ICellViewModel) {\n\t\treturn this._viewCells.indexOf(cell as CellViewModel);\n\t}\n\n\tcellAt(index: number): CellViewModel | undefined {\n\t\t// if (index < 0 || index >= this.length) {\n\t\t// \tthrow new Error(`Invalid index ${index}`);\n\t\t// }\n\n\t\treturn this._viewCells[index];\n\t}\n\n\tgetCellsInRange(range?: ICellRange): ReadonlyArray<ICellViewModel> {\n\t\tif (!range) {\n\t\t\treturn this._viewCells.slice(0);\n\t\t}\n\n\t\tconst validatedRange = this.validateRange(range);\n\n\t\tif (validatedRange) {\n\t\t\tconst result: ICellViewModel[] = [];\n\n\t\t\tfor (let i = validatedRange.start; i < validatedRange.end; i++) {\n\t\t\t\tresult.push(this._viewCells[i]);\n\t\t\t}\n\n\t\t\treturn result;\n\t\t}\n\n\t\treturn [];\n\t}\n\n\t/**\n\t * If this._viewCells[index] is visible then return index\n\t */\n\tgetNearestVisibleCellIndexUpwards(index: number) {\n\t\tfor (let i = this._hiddenRanges.length - 1; i >= 0; i--) {\n\t\t\tconst cellRange = this._hiddenRanges[i];\n\t\t\tconst foldStart = cellRange.start - 1;\n\t\t\tconst foldEnd = cellRange.end;\n\n\t\t\tif (foldStart > index) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (foldStart <= index && foldEnd >= index) {\n\t\t\t\treturn index;\n\t\t\t}\n\n\t\t\t// foldStart <= index, foldEnd < index\n\t\t\tbreak;\n\t\t}\n\n\t\treturn index;\n\t}\n\n\tgetNextVisibleCellIndex(index: number) {\n\t\tfor (let i = 0; i < this._hiddenRanges.length; i++) {\n\t\t\tconst cellRange = this._hiddenRanges[i];\n\t\t\tconst foldStart = cellRange.start - 1;\n\t\t\tconst foldEnd = cellRange.end;\n\n\t\t\tif (foldEnd < index) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// foldEnd >= index\n\t\t\tif (foldStart <= index) {\n\t\t\t\treturn foldEnd + 1;\n\t\t\t}\n\n\t\t\tbreak;\n\t\t}\n\n\t\treturn index + 1;\n\t}\n\n\tgetPreviousVisibleCellIndex(index: number) {\n\t\tfor (let i = this._hiddenRanges.length - 1; i >= 0; i--) {\n\t\t\tconst cellRange = this._hiddenRanges[i];\n\t\t\tconst foldStart = cellRange.start - 1;\n\t\t\tconst foldEnd = cellRange.end;\n\n\t\t\tif (foldEnd < index) {\n\t\t\t\treturn index;\n\t\t\t}\n\n\t\t\tif (foldStart <= index) {\n\t\t\t\treturn foldStart;\n\t\t\t}\n\t\t}\n\n\t\treturn index;\n\t}\n\n\thasCell(cell: ICellViewModel) {\n\t\treturn this._handleToViewCellMapping.has(cell.handle);\n\t}\n\n\tgetVersionId() {\n\t\treturn this._notebook.versionId;\n\t}\n\n\tgetAlternativeId() {\n\t\treturn this._notebook.alternativeVersionId;\n\t}\n\n\tgetTrackedRange(id: string): ICellRange | null {\n\t\treturn this._getDecorationRange(id);\n\t}\n\n\tprivate _getDecorationRange(decorationId: string): ICellRange | null {\n\t\tconst node = this._decorations[decorationId];\n\t\tif (!node) {\n\t\t\treturn null;\n\t\t}\n\t\tconst versionId = this.getVersionId();\n\t\tif (node.cachedVersionId !== versionId) {\n\t\t\tthis._decorationsTree.resolveNode(node, versionId);\n\t\t}\n\t\tif (node.range === null) {\n\t\t\treturn { start: node.cachedAbsoluteStart - 1, end: node.cachedAbsoluteEnd - 1 };\n\t\t}\n\n\t\treturn { start: node.range.startLineNumber - 1, end: node.range.endLineNumber - 1 };\n\t}\n\n\tsetTrackedRange(id: string | null, newRange: ICellRange | null, newStickiness: TrackedRangeStickiness): string | null {\n\t\tconst node = (id ? this._decorations[id] : null);\n\n\t\tif (!node) {\n\t\t\tif (!newRange) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn this._deltaCellDecorationsImpl(0, [], [{ range: new Range(newRange.start + 1, 1, newRange.end + 1, 1), options: TRACKED_RANGE_OPTIONS[newStickiness] }])[0];\n\t\t}\n\n\t\tif (!newRange) {\n\t\t\t// node exists, the request is to delete => delete node\n\t\t\tthis._decorationsTree.delete(node);\n\t\t\tdelete this._decorations[node.id];\n\t\t\treturn null;\n\t\t}\n\n\t\tthis._decorationsTree.delete(node);\n\t\tnode.reset(this.getVersionId(), newRange.start, newRange.end + 1, new Range(newRange.start + 1, 1, newRange.end + 1, 1));\n\t\tnode.setOptions(TRACKED_RANGE_OPTIONS[newStickiness]);\n\t\tthis._decorationsTree.insert(node);\n\t\treturn node.id;\n\t}\n\n\tprivate _deltaCellDecorationsImpl(ownerId: number, oldDecorationsIds: string[], newDecorations: IModelDeltaDecoration[]): string[] {\n\t\tconst versionId = this.getVersionId();\n\n\t\tconst oldDecorationsLen = oldDecorationsIds.length;\n\t\tlet oldDecorationIndex = 0;\n\n\t\tconst newDecorationsLen = newDecorations.length;\n\t\tlet newDecorationIndex = 0;\n\n\t\tconst result = new Array<string>(newDecorationsLen);\n\t\twhile (oldDecorationIndex < oldDecorationsLen || newDecorationIndex < newDecorationsLen) {\n\n\t\t\tlet node: IntervalNode | null = null;\n\n\t\t\tif (oldDecorationIndex < oldDecorationsLen) {\n\t\t\t\t// (1) get ourselves an old node\n\t\t\t\tdo {\n\t\t\t\t\tnode = this._decorations[oldDecorationsIds[oldDecorationIndex++]];\n\t\t\t\t} while (!node && oldDecorationIndex < oldDecorationsLen);\n\n\t\t\t\t// (2) remove the node from the tree (if it exists)\n\t\t\t\tif (node) {\n\t\t\t\t\tthis._decorationsTree.delete(node);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (newDecorationIndex < newDecorationsLen) {\n\t\t\t\t// (3) create a new node if necessary\n\t\t\t\tif (!node) {\n\t\t\t\t\tconst internalDecorationId = (++this._lastDecorationId);\n\t\t\t\t\tconst decorationId = `${this._instanceId};${internalDecorationId}`;\n\t\t\t\t\tnode = new IntervalNode(decorationId, 0, 0);\n\t\t\t\t\tthis._decorations[decorationId] = node;\n\t\t\t\t}\n\n\t\t\t\t// (4) initialize node\n\t\t\t\tconst newDecoration = newDecorations[newDecorationIndex];\n\t\t\t\tconst range = newDecoration.range;\n\t\t\t\tconst options = _normalizeOptions(newDecoration.options);\n\n\t\t\t\tnode.ownerId = ownerId;\n\t\t\t\tnode.reset(versionId, range.startLineNumber, range.endLineNumber, Range.lift(range));\n\t\t\t\tnode.setOptions(options);\n\n\t\t\t\tthis._decorationsTree.insert(node);\n\n\t\t\t\tresult[newDecorationIndex] = node.id;\n\n\t\t\t\tnewDecorationIndex++;\n\t\t\t} else {\n\t\t\t\tif (node) {\n\t\t\t\t\tdelete this._decorations[node.id];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tdeltaCellDecorations(oldDecorations: string[], newDecorations: INotebookDeltaDecoration[]): string[] {\n\t\toldDecorations.forEach(id => {\n\t\t\tconst handle = this._decorationIdToCellMap.get(id);\n\n\t\t\tif (handle !== undefined) {\n\t\t\t\tconst cell = this.getCellByHandle(handle);\n\t\t\t\tcell?.deltaCellDecorations([id], []);\n\t\t\t\tthis._decorationIdToCellMap.delete(id);\n\t\t\t}\n\n\t\t\tif (this._overviewRulerDecorations.has(id)) {\n\t\t\t\tthis._overviewRulerDecorations.delete(id);\n\t\t\t}\n\t\t});\n\n\t\tconst result: string[] = [];\n\n\t\tnewDecorations.forEach(decoration => {\n\t\t\tif (isNotebookCellDecoration(decoration)) {\n\t\t\t\tconst cell = this.getCellByHandle(decoration.handle);\n\t\t\t\tconst ret = cell?.deltaCellDecorations([], [decoration.options]) || [];\n\t\t\t\tret.forEach(id => {\n\t\t\t\t\tthis._decorationIdToCellMap.set(id, decoration.handle);\n\t\t\t\t});\n\t\t\t\tresult.push(...ret);\n\t\t\t} else {\n\t\t\t\tconst id = ++this._lastOverviewRulerDecorationId;\n\t\t\t\tconst decorationId = `_overview_${this.id};${id}`;\n\t\t\t\tthis._overviewRulerDecorations.set(decorationId, decoration);\n\t\t\t\tresult.push(decorationId);\n\t\t\t}\n\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tdeltaCellStatusBarItems(oldItems: string[], newItems: INotebookDeltaCellStatusBarItems[]): string[] {\n\t\tconst deletesByHandle = groupBy(oldItems, id => this._statusBarItemIdToCellMap.get(id) ?? -1);\n\n\t\tconst result: string[] = [];\n\t\tnewItems.forEach(itemDelta => {\n\t\t\tconst cell = this.getCellByHandle(itemDelta.handle);\n\t\t\tconst deleted = deletesByHandle[itemDelta.handle] ?? [];\n\t\t\tdelete deletesByHandle[itemDelta.handle];\n\t\t\tdeleted.forEach(id => this._statusBarItemIdToCellMap.delete(id));\n\n\t\t\tconst ret = cell?.deltaCellStatusBarItems(deleted, itemDelta.items) || [];\n\t\t\tret.forEach(id => {\n\t\t\t\tthis._statusBarItemIdToCellMap.set(id, itemDelta.handle);\n\t\t\t});\n\n\t\t\tresult.push(...ret);\n\t\t});\n\n\t\tfor (const _handle in deletesByHandle) {\n\t\t\tconst handle = parseInt(_handle);\n\t\t\tconst ids = deletesByHandle[handle]!;\n\t\t\tconst cell = this.getCellByHandle(handle);\n\t\t\tcell?.deltaCellStatusBarItems(ids, []);\n\t\t\tids.forEach(id => this._statusBarItemIdToCellMap.delete(id));\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tnearestCodeCellIndex(index: number /* exclusive */) {\n\t\tconst nearest = this.viewCells.slice(0, index).reverse().findIndex(cell => cell.cellKind === CellKind.Code);\n\t\tif (nearest > -1) {\n\t\t\treturn index - nearest - 1;\n\t\t} else {\n\t\t\tconst nearestCellTheOtherDirection = this.viewCells.slice(index + 1).findIndex(cell => cell.cellKind === CellKind.Code);\n\t\t\tif (nearestCellTheOtherDirection > -1) {\n\t\t\t\treturn index + 1 + nearestCellTheOtherDirection;\n\t\t\t}\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\tgetEditorViewState(): INotebookEditorViewState {\n\t\tconst editingCells: { [key: number]: boolean } = {};\n\t\tconst collapsedInputCells: { [key: number]: boolean } = {};\n\t\tconst collapsedOutputCells: { [key: number]: boolean } = {};\n\t\tconst cellLineNumberStates: { [key: number]: 'on' | 'off' } = {};\n\n\t\tthis._viewCells.forEach((cell, i) => {\n\t\t\tif (cell.getEditState() === CellEditState.Editing) {\n\t\t\t\teditingCells[i] = true;\n\t\t\t}\n\n\t\t\tif (cell.isInputCollapsed) {\n\t\t\t\tcollapsedInputCells[i] = true;\n\t\t\t}\n\n\t\t\tif (cell instanceof CodeCellViewModel && cell.isOutputCollapsed) {\n\t\t\t\tcollapsedOutputCells[i] = true;\n\t\t\t}\n\n\t\t\tif (cell.lineNumbers !== 'inherit') {\n\t\t\t\tcellLineNumberStates[i] = cell.lineNumbers;\n\t\t\t}\n\t\t});\n\t\tconst editorViewStates: { [key: number]: editorCommon.ICodeEditorViewState } = {};\n\t\tthis._viewCells.map(cell => ({ handle: cell.model.handle, state: cell.saveEditorViewState() })).forEach((viewState, i) => {\n\t\t\tif (viewState.state) {\n\t\t\t\teditorViewStates[i] = viewState.state;\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\teditingCells,\n\t\t\teditorViewStates,\n\t\t\tcellLineNumberStates,\n\t\t\tcollapsedInputCells,\n\t\t\tcollapsedOutputCells\n\t\t};\n\t}\n\n\trestoreEditorViewState(viewState: INotebookEditorViewState | undefined): void {\n\t\tif (!viewState) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._viewCells.forEach((cell, index) => {\n\t\t\tconst isEditing = viewState.editingCells && viewState.editingCells[index];\n\t\t\tconst editorViewState = viewState.editorViewStates && viewState.editorViewStates[index];\n\n\t\t\tcell.updateEditState(isEditing ? CellEditState.Editing : CellEditState.Preview, 'viewState');\n\t\t\tconst cellHeight = viewState.cellTotalHeights ? viewState.cellTotalHeights[index] : undefined;\n\t\t\tcell.restoreEditorViewState(editorViewState, cellHeight);\n\t\t\tif (viewState.collapsedInputCells && viewState.collapsedInputCells[index]) {\n\t\t\t\tcell.isInputCollapsed = true;\n\t\t\t}\n\t\t\tif (viewState.collapsedOutputCells && viewState.collapsedOutputCells[index] && cell instanceof CodeCellViewModel) {\n\t\t\t\tcell.isOutputCollapsed = true;\n\t\t\t}\n\t\t\tif (viewState.cellLineNumberStates && viewState.cellLineNumberStates[index]) {\n\t\t\t\tcell.lineNumbers = viewState.cellLineNumberStates[index];\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Editor decorations across cells. For example, find decorations for multiple code cells\n\t * The reason that we can't completely delegate this to CodeEditorWidget is most of the time, the editors for cells are not created yet but we already have decorations for them.\n\t */\n\tchangeModelDecorations<T>(callback: (changeAccessor: IModelDecorationsChangeAccessor) => T): T | null {\n\t\tconst changeAccessor: IModelDecorationsChangeAccessor = {\n\t\t\tdeltaDecorations: (oldDecorations: ICellModelDecorations[], newDecorations: ICellModelDeltaDecorations[]): ICellModelDecorations[] => {\n\t\t\t\treturn this._deltaModelDecorationsImpl(oldDecorations, newDecorations);\n\t\t\t}\n\t\t};\n\n\t\tlet result: T | null = null;\n\t\ttry {\n\t\t\tresult = callback(changeAccessor);\n\t\t} catch (e) {\n\t\t\tonUnexpectedError(e);\n\t\t}\n\n\t\tchangeAccessor.deltaDecorations = invalidFunc;\n\n\t\treturn result;\n\t}\n\n\tprivate _deltaModelDecorationsImpl(oldDecorations: ICellModelDecorations[], newDecorations: ICellModelDeltaDecorations[]): ICellModelDecorations[] {\n\n\t\tconst mapping = new Map<number, { cell: CellViewModel; oldDecorations: readonly string[]; newDecorations: readonly IModelDeltaDecoration[] }>();\n\t\toldDecorations.forEach(oldDecoration => {\n\t\t\tconst ownerId = oldDecoration.ownerId;\n\n\t\t\tif (!mapping.has(ownerId)) {\n\t\t\t\tconst cell = this._viewCells.find(cell => cell.handle === ownerId);\n\t\t\t\tif (cell) {\n\t\t\t\t\tmapping.set(ownerId, { cell: cell, oldDecorations: [], newDecorations: [] });\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst data = mapping.get(ownerId)!;\n\t\t\tif (data) {\n\t\t\t\tdata.oldDecorations = oldDecoration.decorations;\n\t\t\t}\n\t\t});\n\n\t\tnewDecorations.forEach(newDecoration => {\n\t\t\tconst ownerId = newDecoration.ownerId;\n\n\t\t\tif (!mapping.has(ownerId)) {\n\t\t\t\tconst cell = this._viewCells.find(cell => cell.handle === ownerId);\n\n\t\t\t\tif (cell) {\n\t\t\t\t\tmapping.set(ownerId, { cell: cell, oldDecorations: [], newDecorations: [] });\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst data = mapping.get(ownerId)!;\n\t\t\tif (data) {\n\t\t\t\tdata.newDecorations = newDecoration.decorations;\n\t\t\t}\n\t\t});\n\n\t\tconst ret: ICellModelDecorations[] = [];\n\t\tmapping.forEach((value, ownerId) => {\n\t\t\tconst cellRet = value.cell.deltaModelDecorations(value.oldDecorations, value.newDecorations);\n\t\t\tret.push({\n\t\t\t\townerId: ownerId,\n\t\t\t\tdecorations: cellRet\n\t\t\t});\n\t\t});\n\n\t\treturn ret;\n\t}\n\n\t//#region Find\n\tfind(value: string, options: INotebookFindOptions): CellFindMatchWithIndex[] {\n\t\tconst matches: CellFindMatchWithIndex[] = [];\n\t\tlet findCells: CellViewModel[] = [];\n\n\t\tif (options.findScope && (options.findScope.findScopeType === NotebookFindScopeType.Cells || options.findScope.findScopeType === NotebookFindScopeType.Text)) {\n\t\t\tconst selectedRanges = options.findScope.selectedCellRanges?.map(range => this.validateRange(range)).filter(range => !!range) ?? [];\n\t\t\tconst selectedIndexes = cellRangesToIndexes(selectedRanges);\n\t\t\tfindCells = selectedIndexes.map(index => this._viewCells[index]);\n\t\t} else {\n\t\t\tfindCells = this._viewCells;\n\t\t}\n\n\t\tfindCells.forEach((cell, index) => {\n\t\t\tconst cellMatches = cell.startFind(value, options);\n\t\t\tif (cellMatches) {\n\t\t\t\tmatches.push(new CellFindMatchModel(\n\t\t\t\t\tcellMatches.cell,\n\t\t\t\t\tindex,\n\t\t\t\t\tcellMatches.contentMatches,\n\t\t\t\t\t[]\n\t\t\t\t));\n\t\t\t}\n\t\t});\n\n\t\t// filter based on options and editing state\n\n\t\treturn matches.filter(match => {\n\t\t\tif (match.cell.cellKind === CellKind.Code) {\n\t\t\t\t// code cell, we only include its match if include input is enabled\n\t\t\t\treturn options.includeCodeInput;\n\t\t\t}\n\n\t\t\t// markup cell, it depends on the editing state\n\t\t\tif (match.cell.getEditState() === CellEditState.Editing) {\n\t\t\t\t// editing, even if we includeMarkupPreview\n\t\t\t\treturn options.includeMarkupInput;\n\t\t\t} else {\n\t\t\t\t// cell in preview mode, we should only include it if includeMarkupPreview is false but includeMarkupInput is true\n\t\t\t\t// if includeMarkupPreview is true, then we should include the webview match result other than this\n\t\t\t\treturn !options.includeMarkupPreview && options.includeMarkupInput;\n\t\t\t}\n\t\t}\n\t\t);\n\t}\n\n\treplaceOne(cell: ICellViewModel, range: Range, text: string): Promise<void> {\n\t\tconst viewCell = cell as CellViewModel;\n\t\tthis._lastNotebookEditResource.push(viewCell.uri);\n\t\treturn viewCell.resolveTextModel().then(() => {\n\t\t\tthis._bulkEditService.apply(\n\t\t\t\t[new ResourceTextEdit(cell.uri, { range, text })],\n\t\t\t\t{ quotableLabel: 'Notebook Replace' }\n\t\t\t);\n\t\t});\n\t}\n\n\tasync replaceAll(matches: CellFindMatchWithIndex[], texts: string[]): Promise<void> {\n\t\tif (!matches.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst textEdits: IWorkspaceTextEdit[] = [];\n\t\tthis._lastNotebookEditResource.push(matches[0].cell.uri);\n\n\t\tmatches.forEach(match => {\n\t\t\tmatch.contentMatches.forEach((singleMatch, index) => {\n\t\t\t\ttextEdits.push({\n\t\t\t\t\tversionId: undefined,\n\t\t\t\t\ttextEdit: { range: (singleMatch as FindMatch).range, text: texts[index] },\n\t\t\t\t\tresource: match.cell.uri\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\treturn Promise.all(matches.map(match => {\n\t\t\treturn match.cell.resolveTextModel();\n\t\t})).then(async () => {\n\t\t\tthis._bulkEditService.apply({ edits: textEdits }, { quotableLabel: 'Notebook Replace All' });\n\t\t\treturn;\n\t\t});\n\t}\n\n\t//#endregion\n\n\t//#region Undo/Redo\n\n\tprivate async _withElement(element: SingleModelEditStackElement | MultiModelEditStackElement, callback: () => Promise<void>) {\n\t\tconst viewCells = this._viewCells.filter(cell => element.matchesResource(cell.uri));\n\t\tconst refs = await Promise.all(viewCells.map(cell => this._textModelService.createModelReference(cell.uri)));\n\t\tawait callback();\n\t\trefs.forEach(ref => ref.dispose());\n\t}\n\n\tasync undo() {\n\n\t\tconst editStack = this._undoService.getElements(this.uri);\n\t\tconst element = editStack.past.length ? editStack.past[editStack.past.length - 1] : undefined;\n\n\t\tif (element && element instanceof SingleModelEditStackElement || element instanceof MultiModelEditStackElement) {\n\t\t\tawait this._withElement(element, async () => {\n\t\t\t\tawait this._undoService.undo(this.uri);\n\t\t\t});\n\n\t\t\treturn (element instanceof SingleModelEditStackElement) ? [element.resource] : element.resources;\n\t\t}\n\n\t\tawait this._undoService.undo(this.uri);\n\t\treturn [];\n\t}\n\n\tasync redo() {\n\n\t\tconst editStack = this._undoService.getElements(this.uri);\n\t\tconst element = editStack.future[0];\n\n\t\tif (element && element instanceof SingleModelEditStackElement || element instanceof MultiModelEditStackElement) {\n\t\t\tawait this._withElement(element, async () => {\n\t\t\t\tawait this._undoService.redo(this.uri);\n\t\t\t});\n\n\t\t\treturn (element instanceof SingleModelEditStackElement) ? [element.resource] : element.resources;\n\t\t}\n\n\t\tawait this._undoService.redo(this.uri);\n\n\t\treturn [];\n\t}\n\n\t//#endregion\n\n\tequal(notebook: NotebookTextModel) {\n\t\treturn this._notebook === notebook;\n\t}\n\n\toverride dispose() {\n\t\tthis._localStore.clear();\n\t\tthis._viewCells.forEach(cell => {\n\t\t\tcell.dispose();\n\t\t});\n\n\t\tsuper.dispose();\n\t}\n}\n\nexport type CellViewModel = (CodeCellViewModel | MarkupCellViewModel) & ICellViewModel;\n\nexport function createCellViewModel(instantiationService: IInstantiationService, notebookViewModel: NotebookViewModel, cell: NotebookCellTextModel, viewContext: ViewContext) {\n\tif (cell.cellKind === CellKind.Code) {\n\t\treturn instantiationService.createInstance(CodeCellViewModel, notebookViewModel.viewType, cell, notebookViewModel.layoutInfo, viewContext);\n\t} else {\n\t\treturn instantiationService.createInstance(MarkupCellViewModel, notebookViewModel.viewType, cell, notebookViewModel.layoutInfo, notebookViewModel, viewContext);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { groupBy } from '../../../../../base/common/collections.js';\nimport { onUnexpectedError } from '../../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable, DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { clamp } from '../../../../../base/common/numbers.js';\nimport * as strings from '../../../../../base/common/strings.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { IBulkEditService, ResourceTextEdit } from '../../../../../editor/browser/services/bulkEditService.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport * as editorCommon from '../../../../../editor/common/editorCommon.js';\nimport { IWorkspaceTextEdit } from '../../../../../editor/common/languages.js';\nimport { FindMatch, IModelDecorationOptions, IModelDeltaDecoration, TrackedRangeStickiness } from '../../../../../editor/common/model.js';\nimport { MultiModelEditStackElement, SingleModelEditStackElement } from '../../../../../editor/common/model/editStack.js';\nimport { IntervalNode, IntervalTree } from '../../../../../editor/common/model/intervalTree.js';\nimport { ModelDecorationOptions } from '../../../../../editor/common/model/textModel.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { FoldingRegions } from '../../../../../editor/contrib/folding/browser/foldingRanges.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IUndoRedoService } from '../../../../../platform/undoRedo/common/undoRedo.js';\nimport { CellFindMatchModel } from '../contrib/find/findModel.js';\nimport { CellEditState, CellFindMatchWithIndex, CellFoldingState, EditorFoldingStateDelegate, ICellModelDecorations, ICellModelDeltaDecorations, ICellViewModel, IModelDecorationsChangeAccessor, INotebookDeltaCellStatusBarItems, INotebookEditorViewState, INotebookViewCellsUpdateEvent, INotebookViewModel, INotebookDeltaDecoration, isNotebookCellDecoration, INotebookDeltaViewZoneDecoration } from '../notebookBrowser.js';\nimport { NotebookLayoutInfo, NotebookMetadataChangedEvent } from '../notebookViewEvents.js';\nimport { NotebookCellSelectionCollection } from './cellSelectionCollection.js';\nimport { CodeCellViewModel } from './codeCellViewModel.js';\nimport { MarkupCellViewModel } from './markupCellViewModel.js';\nimport { ViewContext } from './viewContext.js';\nimport { NotebookCellTextModel } from '../../common/model/notebookCellTextModel.js';\nimport { NotebookTextModel } from '../../common/model/notebookTextModel.js';\nimport { CellKind, ICell, INotebookFindOptions, ISelectionState, NotebookCellsChangeType, NotebookCellTextModelSplice, NotebookFindScopeType, SelectionStateType } from '../../common/notebookCommon.js';\nimport { INotebookExecutionStateService, NotebookExecutionType } from '../../common/notebookExecutionStateService.js';\nimport { cellIndexesToRanges, cellRangesToIndexes, ICellRange, reduceCellRanges } from '../../common/notebookRange.js';\n\nconst invalidFunc = () => { throw new Error(`Invalid change accessor`); };\n\nclass DecorationsTree {\n\tprivate readonly _decorationsTree: IntervalTree;\n\n\tconstructor() {\n\t\tthis._decorationsTree = new IntervalTree();\n\t}\n\n\tpublic intervalSearch(start: number, end: number, filterOwnerId: number, filterOutValidation: boolean, filterFontDecorations: boolean, cachedVersionId: number, onlyMarginDecorations: boolean = false): IntervalNode[] {\n\t\tconst r1 = this._decorationsTree.intervalSearch(start, end, filterOwnerId, filterOutValidation, filterFontDecorations, cachedVersionId, onlyMarginDecorations);\n\t\treturn r1;\n\t}\n\n\tpublic search(filterOwnerId: number, filterOutValidation: boolean, filterFontDecorations: boolean, overviewRulerOnly: boolean, cachedVersionId: number, onlyMarginDecorations: boolean): IntervalNode[] {\n\t\treturn this._decorationsTree.search(filterOwnerId, filterOutValidation, filterFontDecorations, cachedVersionId, onlyMarginDecorations);\n\n\t}\n\n\tpublic collectNodesFromOwner(ownerId: number): IntervalNode[] {\n\t\tconst r1 = this._decorationsTree.collectNodesFromOwner(ownerId);\n\t\treturn r1;\n\t}\n\n\tpublic collectNodesPostOrder(): IntervalNode[] {\n\t\tconst r1 = this._decorationsTree.collectNodesPostOrder();\n\t\treturn r1;\n\t}\n\n\tpublic insert(node: IntervalNode): void {\n\t\tthis._decorationsTree.insert(node);\n\t}\n\n\tpublic delete(node: IntervalNode): void {\n\t\tthis._decorationsTree.delete(node);\n\t}\n\n\tpublic resolveNode(node: IntervalNode, cachedVersionId: number): void {\n\t\tthis._decorationsTree.resolveNode(node, cachedVersionId);\n\t}\n\n\tpublic acceptReplace(offset: number, length: number, textLength: number, forceMoveMarkers: boolean): void {\n\t\tthis._decorationsTree.acceptReplace(offset, length, textLength, forceMoveMarkers);\n\t}\n}\n\nconst TRACKED_RANGE_OPTIONS = [\n\tModelDecorationOptions.register({ description: 'notebook-view-model-tracked-range-always-grows-when-typing-at-edges', stickiness: TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges }),\n\tModelDecorationOptions.register({ description: 'notebook-view-model-tracked-range-never-grows-when-typing-at-edges', stickiness: TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges }),\n\tModelDecorationOptions.register({ description: 'notebook-view-model-tracked-range-grows-only-when-typing-before', stickiness: TrackedRangeStickiness.GrowsOnlyWhenTypingBefore }),\n\tModelDecorationOptions.register({ description: 'notebook-view-model-tracked-range-grows-only-when-typing-after', stickiness: TrackedRangeStickiness.GrowsOnlyWhenTypingAfter }),\n];\n\nfunction _normalizeOptions(options: IModelDecorationOptions): ModelDecorationOptions {\n\tif (options instanceof ModelDecorationOptions) {\n\t\treturn options;\n\t}\n\treturn ModelDecorationOptions.createDynamic(options);\n}\n\nlet MODEL_ID = 0;\n\nexport interface NotebookViewModelOptions {\n\tisReadOnly: boolean;\n}\n\nexport class NotebookViewModel extends Disposable implements EditorFoldingStateDelegate, INotebookViewModel {\n\tprivate readonly _localStore = this._register(new DisposableStore());\n\tprivate _handleToViewCellMapping = new Map<number, CellViewModel>();\n\tget options(): NotebookViewModelOptions { return this._options; }\n\tprivate readonly _onDidChangeOptions = this._register(new Emitter<void>());\n\tget onDidChangeOptions(): Event<void> { return this._onDidChangeOptions.event; }\n\tprivate _viewCells: CellViewModel[] = [];\n\n\tget viewCells(): ICellViewModel[] {\n\t\treturn this._viewCells;\n\t}\n\n\tget length(): number {\n\t\treturn this._viewCells.length;\n\t}\n\n\tget notebookDocument() {\n\t\treturn this._notebook;\n\t}\n\n\tget uri() {\n\t\treturn this._notebook.uri;\n\t}\n\n\tget metadata() {\n\t\treturn this._notebook.metadata;\n\t}\n\n\tprivate get isRepl() {\n\t\treturn this.viewType === 'repl';\n\t}\n\n\tprivate readonly _onDidChangeViewCells = this._register(new Emitter<INotebookViewCellsUpdateEvent>());\n\tget onDidChangeViewCells(): Event<INotebookViewCellsUpdateEvent> { return this._onDidChangeViewCells.event; }\n\n\tprivate _lastNotebookEditResource: URI[] = [];\n\n\tget lastNotebookEditResource(): URI | null {\n\t\tif (this._lastNotebookEditResource.length) {\n\t\t\treturn this._lastNotebookEditResource[this._lastNotebookEditResource.length - 1];\n\t\t}\n\t\treturn null;\n\t}\n\n\tget layoutInfo(): NotebookLayoutInfo | null {\n\t\treturn this._layoutInfo;\n\t}\n\n\tprivate readonly _onDidChangeSelection = this._register(new Emitter<string>());\n\tget onDidChangeSelection(): Event<string> { return this._onDidChangeSelection.event; }\n\n\tprivate _selectionCollection = this._register(new NotebookCellSelectionCollection());\n\n\tprivate get selectionHandles() {\n\t\tconst handlesSet = new Set<number>();\n\t\tconst handles: number[] = [];\n\t\tcellRangesToIndexes(this._selectionCollection.selections).map(index => index < this.length ? this.cellAt(index) : undefined).forEach(cell => {\n\t\t\tif (cell && !handlesSet.has(cell.handle)) {\n\t\t\t\thandles.push(cell.handle);\n\t\t\t}\n\t\t});\n\n\t\treturn handles;\n\t}\n\n\tprivate set selectionHandles(selectionHandles: number[]) {\n\t\tconst indexes = selectionHandles.map(handle => this._viewCells.findIndex(cell => cell.handle === handle));\n\t\tthis._selectionCollection.setSelections(cellIndexesToRanges(indexes), true, 'model');\n\t}\n\n\tprivate _decorationsTree = new DecorationsTree();\n\tprivate _decorations: { [decorationId: string]: IntervalNode } = Object.create(null);\n\tprivate _lastDecorationId: number = 0;\n\tprivate readonly _instanceId: string;\n\tpublic readonly id: string;\n\tprivate _foldingRanges: FoldingRegions | null = null;\n\tprivate _onDidFoldingStateChanged = new Emitter<void>();\n\treadonly onDidFoldingStateChanged: Event<void> = this._onDidFoldingStateChanged.event;\n\tprivate _hiddenRanges: ICellRange[] = [];\n\tprivate _focused: boolean = true;\n\n\tget focused() {\n\t\treturn this._focused;\n\t}\n\n\tprivate _decorationIdToCellMap = new Map<string, number>();\n\tprivate _statusBarItemIdToCellMap = new Map<string, number>();\n\n\tprivate _lastOverviewRulerDecorationId: number = 0;\n\tprivate _overviewRulerDecorations = new Map<string, INotebookDeltaViewZoneDecoration>();\n\n\tconstructor(\n\t\tpublic viewType: string,\n\t\tprivate _notebook: NotebookTextModel,\n\t\tprivate _viewContext: ViewContext,\n\t\tprivate _layoutInfo: NotebookLayoutInfo | null,\n\t\tprivate _options: NotebookViewModelOptions,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IBulkEditService private readonly _bulkEditService: IBulkEditService,\n\t\t@IUndoRedoService private readonly _undoService: IUndoRedoService,\n\t\t@ITextModelService private readonly _textModelService: ITextModelService,\n\t\t@INotebookExecutionStateService private readonly notebookExecutionStateService: INotebookExecutionStateService,\n\t) {\n\t\tsuper();\n\n\t\tMODEL_ID++;\n\t\tthis.id = '$notebookViewModel' + MODEL_ID;\n\t\tthis._instanceId = strings.singleLetterHash(MODEL_ID);\n\n\t\tconst compute = (changes: NotebookCellTextModelSplice<ICell>[], synchronous: boolean) => {\n\t\t\tconst diffs = changes.map(splice => {\n\t\t\t\treturn [splice[0], splice[1], splice[2].map(cell => {\n\t\t\t\t\treturn createCellViewModel(this._instantiationService, this, cell as NotebookCellTextModel, this._viewContext);\n\t\t\t\t})] as [number, number, CellViewModel[]];\n\t\t\t});\n\n\t\t\tdiffs.reverse().forEach(diff => {\n\t\t\t\tconst deletedCells = this._viewCells.splice(diff[0], diff[1], ...diff[2]);\n\n\t\t\t\tthis._decorationsTree.acceptReplace(diff[0], diff[1], diff[2].length, true);\n\t\t\t\tdeletedCells.forEach(cell => {\n\t\t\t\t\tthis._handleToViewCellMapping.delete(cell.handle);\n\t\t\t\t\t// dispose the cell to release ref to the cell text document\n\t\t\t\t\tcell.dispose();\n\t\t\t\t});\n\n\t\t\t\tdiff[2].forEach(cell => {\n\t\t\t\t\tthis._handleToViewCellMapping.set(cell.handle, cell);\n\t\t\t\t\tthis._localStore.add(cell);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tconst selectionHandles = this.selectionHandles;\n\n\t\t\tthis._onDidChangeViewCells.fire({\n\t\t\t\tsynchronous: synchronous,\n\t\t\t\tsplices: diffs\n\t\t\t});\n\n\t\t\tlet endSelectionHandles: number[] = [];\n\t\t\tif (selectionHandles.length) {\n\t\t\t\tconst primaryHandle = selectionHandles[0];\n\t\t\t\tconst primarySelectionIndex = this._viewCells.indexOf(this.getCellByHandle(primaryHandle)!);\n\t\t\t\tendSelectionHandles = [primaryHandle];\n\t\t\t\tlet delta = 0;\n\n\t\t\t\tfor (let i = 0; i < diffs.length; i++) {\n\t\t\t\t\tconst diff = diffs[0];\n\t\t\t\t\tif (diff[0] + diff[1] <= primarySelectionIndex) {\n\t\t\t\t\t\tdelta += diff[2].length - diff[1];\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (diff[0] > primarySelectionIndex) {\n\t\t\t\t\t\tendSelectionHandles = [primaryHandle];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (diff[0] + diff[1] > primarySelectionIndex) {\n\t\t\t\t\t\tendSelectionHandles = [this._viewCells[diff[0] + delta].handle];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// TODO@rebornix\n\t\t\tconst selectionIndexes = endSelectionHandles.map(handle => this._viewCells.findIndex(cell => cell.handle === handle));\n\t\t\tthis._selectionCollection.setState(cellIndexesToRanges([selectionIndexes[0]])[0], cellIndexesToRanges(selectionIndexes), true, 'model');\n\t\t};\n\n\t\tthis._register(this._notebook.onDidChangeContent(e => {\n\t\t\tfor (let i = 0; i < e.rawEvents.length; i++) {\n\t\t\t\tconst change = e.rawEvents[i];\n\t\t\t\tlet changes: NotebookCellTextModelSplice<ICell>[] = [];\n\t\t\t\tconst synchronous = e.synchronous ?? true;\n\n\t\t\t\tif (change.kind === NotebookCellsChangeType.ModelChange || change.kind === NotebookCellsChangeType.Initialize) {\n\t\t\t\t\tchanges = change.changes;\n\t\t\t\t\tcompute(changes, synchronous);\n\t\t\t\t\tcontinue;\n\t\t\t\t} else if (change.kind === NotebookCellsChangeType.Move) {\n\t\t\t\t\tcompute([[change.index, change.length, []]], synchronous);\n\t\t\t\t\tcompute([[change.newIdx, 0, change.cells]], synchronous);\n\t\t\t\t} else {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._notebook.onDidChangeContent(contentChanges => {\n\t\t\tcontentChanges.rawEvents.forEach(e => {\n\t\t\t\tif (e.kind === NotebookCellsChangeType.ChangeDocumentMetadata) {\n\t\t\t\t\tthis._viewContext.eventDispatcher.emit([new NotebookMetadataChangedEvent(this._notebook.metadata)]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (contentChanges.endSelectionState) {\n\t\t\t\tthis.updateSelectionsState(contentChanges.endSelectionState);\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._viewContext.eventDispatcher.onDidChangeLayout((e) => {\n\t\t\tthis._layoutInfo = e.value;\n\n\t\t\tthis._viewCells.forEach(cell => {\n\t\t\t\tif (cell.cellKind === CellKind.Markup) {\n\t\t\t\t\tif (e.source.width || e.source.fontInfo) {\n\t\t\t\t\t\tcell.layoutChange({ outerWidth: e.value.width, font: e.value.fontInfo });\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (e.source.width !== undefined) {\n\t\t\t\t\t\tcell.layoutChange({ outerWidth: e.value.width, font: e.value.fontInfo });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}));\n\n\t\tthis._register(this._viewContext.notebookOptions.onDidChangeOptions(e => {\n\t\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\t\tconst cell = this._viewCells[i];\n\t\t\t\tcell.updateOptions(e);\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(notebookExecutionStateService.onDidChangeExecution(e => {\n\t\t\tif (e.type !== NotebookExecutionType.cell) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst cell = this.getCellByHandle(e.cellHandle);\n\n\t\t\tif (cell instanceof CodeCellViewModel) {\n\t\t\t\tcell.updateExecutionState(e);\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._selectionCollection.onDidChangeSelection(e => {\n\t\t\tthis._onDidChangeSelection.fire(e);\n\t\t}));\n\n\n\t\tconst viewCellCount = this.isRepl ? this._notebook.cells.length - 1 : this._notebook.cells.length;\n\t\tfor (let i = 0; i < viewCellCount; i++) {\n\t\t\tthis._viewCells.push(createCellViewModel(this._instantiationService, this, this._notebook.cells[i], this._viewContext));\n\t\t}\n\n\n\t\tthis._viewCells.forEach(cell => {\n\t\t\tthis._handleToViewCellMapping.set(cell.handle, cell);\n\t\t});\n\t}\n\n\tupdateOptions(newOptions: Partial<NotebookViewModelOptions>) {\n\t\tthis._options = { ...this._options, ...newOptions };\n\t\tthis._viewCells.forEach(cell => cell.updateOptions({ readonly: this._options.isReadOnly }));\n\t\tthis._onDidChangeOptions.fire();\n\t}\n\n\tgetFocus() {\n\t\treturn this._selectionCollection.focus;\n\t}\n\n\tgetSelections() {\n\t\treturn this._selectionCollection.selections;\n\t}\n\n\tgetMostRecentlyExecutedCell(): ICellViewModel | undefined {\n\t\tconst handle = this.notebookExecutionStateService.getLastCompletedCellForNotebook(this._notebook.uri);\n\t\treturn handle !== undefined ? this.getCellByHandle(handle) : undefined;\n\t}\n\n\tsetEditorFocus(focused: boolean) {\n\t\tthis._focused = focused;\n\t}\n\n\tvalidateRange(cellRange: ICellRange | null | undefined): ICellRange | null {\n\t\tif (!cellRange) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst start = clamp(cellRange.start, 0, this.length);\n\t\tconst end = clamp(cellRange.end, 0, this.length);\n\n\t\tif (start <= end) {\n\t\t\treturn { start, end };\n\t\t} else {\n\t\t\treturn { start: end, end: start };\n\t\t}\n\t}\n\n\t// selection change from list view's `setFocus` and `setSelection` should always use `source: view` to prevent events breaking the list view focus/selection change transaction\n\tupdateSelectionsState(state: ISelectionState, source: 'view' | 'model' = 'model') {\n\t\tif (this._focused || source === 'model') {\n\t\t\tif (state.kind === SelectionStateType.Handle) {\n\t\t\t\tconst primaryIndex = state.primary !== null ? this.getCellIndexByHandle(state.primary) : null;\n\t\t\t\tconst primarySelection = primaryIndex !== null ? this.validateRange({ start: primaryIndex, end: primaryIndex + 1 }) : null;\n\t\t\t\tconst selections = cellIndexesToRanges(state.selections.map(sel => this.getCellIndexByHandle(sel)))\n\t\t\t\t\t.map(range => this.validateRange(range))\n\t\t\t\t\t.filter(range => range !== null) as ICellRange[];\n\t\t\t\tthis._selectionCollection.setState(primarySelection, reduceCellRanges(selections), true, source);\n\t\t\t} else {\n\t\t\t\tconst primarySelection = this.validateRange(state.focus);\n\t\t\t\tconst selections = state.selections\n\t\t\t\t\t.map(range => this.validateRange(range))\n\t\t\t\t\t.filter(range => range !== null) as ICellRange[];\n\t\t\t\tthis._selectionCollection.setState(primarySelection, reduceCellRanges(selections), true, source);\n\t\t\t}\n\t\t}\n\t}\n\n\tgetFoldingStartIndex(index: number): number {\n\t\tif (!this._foldingRanges) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tconst range = this._foldingRanges.findRange(index + 1);\n\t\tconst startIndex = this._foldingRanges.getStartLineNumber(range) - 1;\n\t\treturn startIndex;\n\t}\n\n\tgetFoldingState(index: number): CellFoldingState {\n\t\tif (!this._foldingRanges) {\n\t\t\treturn CellFoldingState.None;\n\t\t}\n\n\t\tconst range = this._foldingRanges.findRange(index + 1);\n\t\tconst startIndex = this._foldingRanges.getStartLineNumber(range) - 1;\n\n\t\tif (startIndex !== index) {\n\t\t\treturn CellFoldingState.None;\n\t\t}\n\n\t\treturn this._foldingRanges.isCollapsed(range) ? CellFoldingState.Collapsed : CellFoldingState.Expanded;\n\t}\n\n\tgetFoldedLength(index: number): number {\n\t\tif (!this._foldingRanges) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst range = this._foldingRanges.findRange(index + 1);\n\t\tconst startIndex = this._foldingRanges.getStartLineNumber(range) - 1;\n\t\tconst endIndex = this._foldingRanges.getEndLineNumber(range) - 1;\n\n\t\treturn endIndex - startIndex;\n\t}\n\n\tupdateFoldingRanges(ranges: FoldingRegions) {\n\t\tthis._foldingRanges = ranges;\n\t\tlet updateHiddenAreas = false;\n\t\tconst newHiddenAreas: ICellRange[] = [];\n\n\t\tlet i = 0; // index into hidden\n\t\tlet k = 0;\n\n\t\tlet lastCollapsedStart = Number.MAX_VALUE;\n\t\tlet lastCollapsedEnd = -1;\n\n\t\tfor (; i < ranges.length; i++) {\n\t\t\tif (!ranges.isCollapsed(i)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst startLineNumber = ranges.getStartLineNumber(i) + 1; // the first line is not hidden\n\t\t\tconst endLineNumber = ranges.getEndLineNumber(i);\n\t\t\tif (lastCollapsedStart <= startLineNumber && endLineNumber <= lastCollapsedEnd) {\n\t\t\t\t// ignore ranges contained in collapsed regions\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (!updateHiddenAreas && k < this._hiddenRanges.length && this._hiddenRanges[k].start + 1 === startLineNumber && (this._hiddenRanges[k].end + 1) === endLineNumber) {\n\t\t\t\t// reuse the old ranges\n\t\t\t\tnewHiddenAreas.push(this._hiddenRanges[k]);\n\t\t\t\tk++;\n\t\t\t} else {\n\t\t\t\tupdateHiddenAreas = true;\n\t\t\t\tnewHiddenAreas.push({ start: startLineNumber - 1, end: endLineNumber - 1 });\n\t\t\t}\n\t\t\tlastCollapsedStart = startLineNumber;\n\t\t\tlastCollapsedEnd = endLineNumber;\n\t\t}\n\n\t\tif (updateHiddenAreas || k < this._hiddenRanges.length) {\n\t\t\tthis._hiddenRanges = newHiddenAreas;\n\t\t\tthis._onDidFoldingStateChanged.fire();\n\t\t}\n\n\t\tthis._viewCells.forEach(cell => {\n\t\t\tif (cell.cellKind === CellKind.Markup) {\n\t\t\t\tcell.triggerFoldingStateChange();\n\t\t\t}\n\t\t});\n\t}\n\n\tgetHiddenRanges() {\n\t\treturn this._hiddenRanges;\n\t}\n\n\tgetOverviewRulerDecorations(): INotebookDeltaViewZoneDecoration[] {\n\t\treturn Array.from(this._overviewRulerDecorations.values());\n\t}\n\n\tgetCellByHandle(handle: number) {\n\t\treturn this._handleToViewCellMapping.get(handle);\n\t}\n\n\tgetCellIndexByHandle(handle: number): number {\n\t\treturn this._viewCells.findIndex(cell => cell.handle === handle);\n\t}\n\n\tgetCellIndex(cell: ICellViewModel) {\n\t\treturn this._viewCells.indexOf(cell as CellViewModel);\n\t}\n\n\tcellAt(index: number): CellViewModel | undefined {\n\t\t// if (index < 0 || index >= this.length) {\n\t\t// \tthrow new Error(`Invalid index ${index}`);\n\t\t// }\n\n\t\treturn this._viewCells[index];\n\t}\n\n\tgetCellsInRange(range?: ICellRange): ReadonlyArray<ICellViewModel> {\n\t\tif (!range) {\n\t\t\treturn this._viewCells.slice(0);\n\t\t}\n\n\t\tconst validatedRange = this.validateRange(range);\n\n\t\tif (validatedRange) {\n\t\t\tconst result: ICellViewModel[] = [];\n\n\t\t\tfor (let i = validatedRange.start; i < validatedRange.end; i++) {\n\t\t\t\tresult.push(this._viewCells[i]);\n\t\t\t}\n\n\t\t\treturn result;\n\t\t}\n\n\t\treturn [];\n\t}\n\n\t/**\n\t * If this._viewCells[index] is visible then return index\n\t */\n\tgetNearestVisibleCellIndexUpwards(index: number) {\n\t\tfor (let i = this._hiddenRanges.length - 1; i >= 0; i--) {\n\t\t\tconst cellRange = this._hiddenRanges[i];\n\t\t\tconst foldStart = cellRange.start - 1;\n\t\t\tconst foldEnd = cellRange.end;\n\n\t\t\tif (foldStart > index) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (foldStart <= index && foldEnd >= index) {\n\t\t\t\treturn index;\n\t\t\t}\n\n\t\t\t// foldStart <= index, foldEnd < index\n\t\t\tbreak;\n\t\t}\n\n\t\treturn index;\n\t}\n\n\tgetNextVisibleCellIndex(index: number) {\n\t\tfor (let i = 0; i < this._hiddenRanges.length; i++) {\n\t\t\tconst cellRange = this._hiddenRanges[i];\n\t\t\tconst foldStart = cellRange.start - 1;\n\t\t\tconst foldEnd = cellRange.end;\n\n\t\t\tif (foldEnd < index) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// foldEnd >= index\n\t\t\tif (foldStart <= index) {\n\t\t\t\treturn foldEnd + 1;\n\t\t\t}\n\n\t\t\tbreak;\n\t\t}\n\n\t\treturn index + 1;\n\t}\n\n\tgetPreviousVisibleCellIndex(index: number) {\n\t\tfor (let i = this._hiddenRanges.length - 1; i >= 0; i--) {\n\t\t\tconst cellRange = this._hiddenRanges[i];\n\t\t\tconst foldStart = cellRange.start - 1;\n\t\t\tconst foldEnd = cellRange.end;\n\n\t\t\tif (foldEnd < index) {\n\t\t\t\treturn index;\n\t\t\t}\n\n\t\t\tif (foldStart <= index) {\n\t\t\t\treturn foldStart;\n\t\t\t}\n\t\t}\n\n\t\treturn index;\n\t}\n\n\thasCell(cell: ICellViewModel) {\n\t\treturn this._handleToViewCellMapping.has(cell.handle);\n\t}\n\n\tgetVersionId() {\n\t\treturn this._notebook.versionId;\n\t}\n\n\tgetAlternativeId() {\n\t\treturn this._notebook.alternativeVersionId;\n\t}\n\n\tgetTrackedRange(id: string): ICellRange | null {\n\t\treturn this._getDecorationRange(id);\n\t}\n\n\tprivate _getDecorationRange(decorationId: string): ICellRange | null {\n\t\tconst node = this._decorations[decorationId];\n\t\tif (!node) {\n\t\t\treturn null;\n\t\t}\n\t\tconst versionId = this.getVersionId();\n\t\tif (node.cachedVersionId !== versionId) {\n\t\t\tthis._decorationsTree.resolveNode(node, versionId);\n\t\t}\n\t\tif (node.range === null) {\n\t\t\treturn { start: node.cachedAbsoluteStart - 1, end: node.cachedAbsoluteEnd - 1 };\n\t\t}\n\n\t\treturn { start: node.range.startLineNumber - 1, end: node.range.endLineNumber - 1 };\n\t}\n\n\tsetTrackedRange(id: string | null, newRange: ICellRange | null, newStickiness: TrackedRangeStickiness): string | null {\n\t\tconst node = (id ? this._decorations[id] : null);\n\n\t\tif (!node) {\n\t\t\tif (!newRange) {\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn this._deltaCellDecorationsImpl(0, [], [{ range: new Range(newRange.start + 1, 1, newRange.end + 1, 1), options: TRACKED_RANGE_OPTIONS[newStickiness] }])[0];\n\t\t}\n\n\t\tif (!newRange) {\n\t\t\t// node exists, the request is to delete => delete node\n\t\t\tthis._decorationsTree.delete(node);\n\t\t\tdelete this._decorations[node.id];\n\t\t\treturn null;\n\t\t}\n\n\t\tthis._decorationsTree.delete(node);\n\t\tnode.reset(this.getVersionId(), newRange.start, newRange.end + 1, new Range(newRange.start + 1, 1, newRange.end + 1, 1));\n\t\tnode.setOptions(TRACKED_RANGE_OPTIONS[newStickiness]);\n\t\tthis._decorationsTree.insert(node);\n\t\treturn node.id;\n\t}\n\n\tprivate _deltaCellDecorationsImpl(ownerId: number, oldDecorationsIds: string[], newDecorations: IModelDeltaDecoration[]): string[] {\n\t\tconst versionId = this.getVersionId();\n\n\t\tconst oldDecorationsLen = oldDecorationsIds.length;\n\t\tlet oldDecorationIndex = 0;\n\n\t\tconst newDecorationsLen = newDecorations.length;\n\t\tlet newDecorationIndex = 0;\n\n\t\tconst result = new Array<string>(newDecorationsLen);\n\t\twhile (oldDecorationIndex < oldDecorationsLen || newDecorationIndex < newDecorationsLen) {\n\n\t\t\tlet node: IntervalNode | null = null;\n\n\t\t\tif (oldDecorationIndex < oldDecorationsLen) {\n\t\t\t\t// (1) get ourselves an old node\n\t\t\t\tdo {\n\t\t\t\t\tnode = this._decorations[oldDecorationsIds[oldDecorationIndex++]];\n\t\t\t\t} while (!node && oldDecorationIndex < oldDecorationsLen);\n\n\t\t\t\t// (2) remove the node from the tree (if it exists)\n\t\t\t\tif (node) {\n\t\t\t\t\tthis._decorationsTree.delete(node);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (newDecorationIndex < newDecorationsLen) {\n\t\t\t\t// (3) create a new node if necessary\n\t\t\t\tif (!node) {\n\t\t\t\t\tconst internalDecorationId = (++this._lastDecorationId);\n\t\t\t\t\tconst decorationId = `${this._instanceId};${internalDecorationId}`;\n\t\t\t\t\tnode = new IntervalNode(decorationId, 0, 0);\n\t\t\t\t\tthis._decorations[decorationId] = node;\n\t\t\t\t}\n\n\t\t\t\t// (4) initialize node\n\t\t\t\tconst newDecoration = newDecorations[newDecorationIndex];\n\t\t\t\tconst range = newDecoration.range;\n\t\t\t\tconst options = _normalizeOptions(newDecoration.options);\n\n\t\t\t\tnode.ownerId = ownerId;\n\t\t\t\tnode.reset(versionId, range.startLineNumber, range.endLineNumber, Range.lift(range));\n\t\t\t\tnode.setOptions(options);\n\n\t\t\t\tthis._decorationsTree.insert(node);\n\n\t\t\t\tresult[newDecorationIndex] = node.id;\n\n\t\t\t\tnewDecorationIndex++;\n\t\t\t} else {\n\t\t\t\tif (node) {\n\t\t\t\t\tdelete this._decorations[node.id];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tdeltaCellDecorations(oldDecorations: string[], newDecorations: INotebookDeltaDecoration[]): string[] {\n\t\toldDecorations.forEach(id => {\n\t\t\tconst handle = this._decorationIdToCellMap.get(id);\n\n\t\t\tif (handle !== undefined) {\n\t\t\t\tconst cell = this.getCellByHandle(handle);\n\t\t\t\tcell?.deltaCellDecorations([id], []);\n\t\t\t\tthis._decorationIdToCellMap.delete(id);\n\t\t\t}\n\n\t\t\tif (this._overviewRulerDecorations.has(id)) {\n\t\t\t\tthis._overviewRulerDecorations.delete(id);\n\t\t\t}\n\t\t});\n\n\t\tconst result: string[] = [];\n\n\t\tnewDecorations.forEach(decoration => {\n\t\t\tif (isNotebookCellDecoration(decoration)) {\n\t\t\t\tconst cell = this.getCellByHandle(decoration.handle);\n\t\t\t\tconst ret = cell?.deltaCellDecorations([], [decoration.options]) || [];\n\t\t\t\tret.forEach(id => {\n\t\t\t\t\tthis._decorationIdToCellMap.set(id, decoration.handle);\n\t\t\t\t});\n\t\t\t\tresult.push(...ret);\n\t\t\t} else {\n\t\t\t\tconst id = ++this._lastOverviewRulerDecorationId;\n\t\t\t\tconst decorationId = `_overview_${this.id};${id}`;\n\t\t\t\tthis._overviewRulerDecorations.set(decorationId, decoration);\n\t\t\t\tresult.push(decorationId);\n\t\t\t}\n\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tdeltaCellStatusBarItems(oldItems: string[], newItems: INotebookDeltaCellStatusBarItems[]): string[] {\n\t\tconst deletesByHandle = groupBy(oldItems, id => this._statusBarItemIdToCellMap.get(id) ?? -1);\n\n\t\tconst result: string[] = [];\n\t\tnewItems.forEach(itemDelta => {\n\t\t\tconst cell = this.getCellByHandle(itemDelta.handle);\n\t\t\tconst deleted = deletesByHandle[itemDelta.handle] ?? [];\n\t\t\tdelete deletesByHandle[itemDelta.handle];\n\t\t\tdeleted.forEach(id => this._statusBarItemIdToCellMap.delete(id));\n\n\t\t\tconst ret = cell?.deltaCellStatusBarItems(deleted, itemDelta.items) || [];\n\t\t\tret.forEach(id => {\n\t\t\t\tthis._statusBarItemIdToCellMap.set(id, itemDelta.handle);\n\t\t\t});\n\n\t\t\tresult.push(...ret);\n\t\t});\n\n\t\tfor (const _handle in deletesByHandle) {\n\t\t\tconst handle = parseInt(_handle);\n\t\t\tconst ids = deletesByHandle[handle]!;\n\t\t\tconst cell = this.getCellByHandle(handle);\n\t\t\tcell?.deltaCellStatusBarItems(ids, []);\n\t\t\tids.forEach(id => this._statusBarItemIdToCellMap.delete(id));\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tnearestCodeCellIndex(index: number /* exclusive */) {\n\t\tconst nearest = this.viewCells.slice(0, index).reverse().findIndex(cell => cell.cellKind === CellKind.Code);\n\t\tif (nearest > -1) {\n\t\t\treturn index - nearest - 1;\n\t\t} else {\n\t\t\tconst nearestCellTheOtherDirection = this.viewCells.slice(index + 1).findIndex(cell => cell.cellKind === CellKind.Code);\n\t\t\tif (nearestCellTheOtherDirection > -1) {\n\t\t\t\treturn index + 1 + nearestCellTheOtherDirection;\n\t\t\t}\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\tgetEditorViewState(): INotebookEditorViewState {\n\t\tconst editingCells: { [key: number]: boolean } = {};\n\t\tconst collapsedInputCells: { [key: number]: boolean } = {};\n\t\tconst collapsedOutputCells: { [key: number]: boolean } = {};\n\t\tconst cellLineNumberStates: { [key: number]: 'on' | 'off' } = {};\n\n\t\tthis._viewCells.forEach((cell, i) => {\n\t\t\tif (cell.getEditState() === CellEditState.Editing) {\n\t\t\t\teditingCells[i] = true;\n\t\t\t}\n\n\t\t\tif (cell.isInputCollapsed) {\n\t\t\t\tcollapsedInputCells[i] = true;\n\t\t\t}\n\n\t\t\tif (cell instanceof CodeCellViewModel && cell.isOutputCollapsed) {\n\t\t\t\tcollapsedOutputCells[i] = true;\n\t\t\t}\n\n\t\t\tif (cell.lineNumbers !== 'inherit') {\n\t\t\t\tcellLineNumberStates[i] = cell.lineNumbers;\n\t\t\t}\n\t\t});\n\t\tconst editorViewStates: { [key: number]: editorCommon.ICodeEditorViewState } = {};\n\t\tthis._viewCells.map(cell => ({ handle: cell.model.handle, state: cell.saveEditorViewState() })).forEach((viewState, i) => {\n\t\t\tif (viewState.state) {\n\t\t\t\teditorViewStates[i] = viewState.state;\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\teditingCells,\n\t\t\teditorViewStates,\n\t\t\tcellLineNumberStates,\n\t\t\tcollapsedInputCells,\n\t\t\tcollapsedOutputCells\n\t\t};\n\t}\n\n\trestoreEditorViewState(viewState: INotebookEditorViewState | undefined): void {\n\t\tif (!viewState) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._viewCells.forEach((cell, index) => {\n\t\t\tconst isEditing = viewState.editingCells && viewState.editingCells[index];\n\t\t\tconst editorViewState = viewState.editorViewStates && viewState.editorViewStates[index];\n\n\t\t\tcell.updateEditState(isEditing ? CellEditState.Editing : CellEditState.Preview, 'viewState');\n\t\t\tconst cellHeight = viewState.cellTotalHeights ? viewState.cellTotalHeights[index] : undefined;\n\t\t\tcell.restoreEditorViewState(editorViewState, cellHeight);\n\t\t\tif (viewState.collapsedInputCells && viewState.collapsedInputCells[index]) {\n\t\t\t\tcell.isInputCollapsed = true;\n\t\t\t}\n\t\t\tif (viewState.collapsedOutputCells && viewState.collapsedOutputCells[index] && cell instanceof CodeCellViewModel) {\n\t\t\t\tcell.isOutputCollapsed = true;\n\t\t\t}\n\t\t\tif (viewState.cellLineNumberStates && viewState.cellLineNumberStates[index]) {\n\t\t\t\tcell.lineNumbers = viewState.cellLineNumberStates[index];\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Editor decorations across cells. For example, find decorations for multiple code cells\n\t * The reason that we can't completely delegate this to CodeEditorWidget is most of the time, the editors for cells are not created yet but we already have decorations for them.\n\t */\n\tchangeModelDecorations<T>(callback: (changeAccessor: IModelDecorationsChangeAccessor) => T): T | null {\n\t\tconst changeAccessor: IModelDecorationsChangeAccessor = {\n\t\t\tdeltaDecorations: (oldDecorations: ICellModelDecorations[], newDecorations: ICellModelDeltaDecorations[]): ICellModelDecorations[] => {\n\t\t\t\treturn this._deltaModelDecorationsImpl(oldDecorations, newDecorations);\n\t\t\t}\n\t\t};\n\n\t\tlet result: T | null = null;\n\t\ttry {\n\t\t\tresult = callback(changeAccessor);\n\t\t} catch (e) {\n\t\t\tonUnexpectedError(e);\n\t\t}\n\n\t\tchangeAccessor.deltaDecorations = invalidFunc;\n\n\t\treturn result;\n\t}\n\n\tprivate _deltaModelDecorationsImpl(oldDecorations: ICellModelDecorations[], newDecorations: ICellModelDeltaDecorations[]): ICellModelDecorations[] {\n\n\t\tconst mapping = new Map<number, { cell: CellViewModel; oldDecorations: readonly string[]; newDecorations: readonly IModelDeltaDecoration[] }>();\n\t\toldDecorations.forEach(oldDecoration => {\n\t\t\tconst ownerId = oldDecoration.ownerId;\n\n\t\t\tif (!mapping.has(ownerId)) {\n\t\t\t\tconst cell = this._viewCells.find(cell => cell.handle === ownerId);\n\t\t\t\tif (cell) {\n\t\t\t\t\tmapping.set(ownerId, { cell: cell, oldDecorations: [], newDecorations: [] });\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst data = mapping.get(ownerId)!;\n\t\t\tif (data) {\n\t\t\t\tdata.oldDecorations = oldDecoration.decorations;\n\t\t\t}\n\t\t});\n\n\t\tnewDecorations.forEach(newDecoration => {\n\t\t\tconst ownerId = newDecoration.ownerId;\n\n\t\t\tif (!mapping.has(ownerId)) {\n\t\t\t\tconst cell = this._viewCells.find(cell => cell.handle === ownerId);\n\n\t\t\t\tif (cell) {\n\t\t\t\t\tmapping.set(ownerId, { cell: cell, oldDecorations: [], newDecorations: [] });\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst data = mapping.get(ownerId)!;\n\t\t\tif (data) {\n\t\t\t\tdata.newDecorations = newDecoration.decorations;\n\t\t\t}\n\t\t});\n\n\t\tconst ret: ICellModelDecorations[] = [];\n\t\tmapping.forEach((value, ownerId) => {\n\t\t\tconst cellRet = value.cell.deltaModelDecorations(value.oldDecorations, value.newDecorations);\n\t\t\tret.push({\n\t\t\t\townerId: ownerId,\n\t\t\t\tdecorations: cellRet\n\t\t\t});\n\t\t});\n\n\t\treturn ret;\n\t}\n\n\t//#region Find\n\tfind(value: string, options: INotebookFindOptions): CellFindMatchWithIndex[] {\n\t\tconst matches: CellFindMatchWithIndex[] = [];\n\t\tlet findCells: CellViewModel[] = [];\n\n\t\tif (options.findScope && (options.findScope.findScopeType === NotebookFindScopeType.Cells || options.findScope.findScopeType === NotebookFindScopeType.Text)) {\n\t\t\tconst selectedRanges = options.findScope.selectedCellRanges?.map(range => this.validateRange(range)).filter(range => !!range) ?? [];\n\t\t\tconst selectedIndexes = cellRangesToIndexes(selectedRanges);\n\t\t\tfindCells = selectedIndexes.map(index => this._viewCells[index]);\n\t\t} else {\n\t\t\tfindCells = this._viewCells;\n\t\t}\n\n\t\tfindCells.forEach((cell, index) => {\n\t\t\tconst cellMatches = cell.startFind(value, options);\n\t\t\tif (cellMatches) {\n\t\t\t\tmatches.push(new CellFindMatchModel(\n\t\t\t\t\tcellMatches.cell,\n\t\t\t\t\tindex,\n\t\t\t\t\tcellMatches.contentMatches,\n\t\t\t\t\t[]\n\t\t\t\t));\n\t\t\t}\n\t\t});\n\n\t\t// filter based on options and editing state\n\n\t\treturn matches.filter(match => {\n\t\t\tif (match.cell.cellKind === CellKind.Code) {\n\t\t\t\t// code cell, we only include its match if include input is enabled\n\t\t\t\treturn options.includeCodeInput;\n\t\t\t}\n\n\t\t\t// markup cell, it depends on the editing state\n\t\t\tif (match.cell.getEditState() === CellEditState.Editing) {\n\t\t\t\t// editing, even if we includeMarkupPreview\n\t\t\t\treturn options.includeMarkupInput;\n\t\t\t} else {\n\t\t\t\t// cell in preview mode, we should only include it if includeMarkupPreview is false but includeMarkupInput is true\n\t\t\t\t// if includeMarkupPreview is true, then we should include the webview match result other than this\n\t\t\t\treturn !options.includeMarkupPreview && options.includeMarkupInput;\n\t\t\t}\n\t\t}\n\t\t);\n\t}\n\n\treplaceOne(cell: ICellViewModel, range: Range, text: string): Promise<void> {\n\t\tconst viewCell = cell as CellViewModel;\n\t\tthis._lastNotebookEditResource.push(viewCell.uri);\n\t\treturn viewCell.resolveTextModel().then(() => {\n\t\t\tthis._bulkEditService.apply(\n\t\t\t\t[new ResourceTextEdit(cell.uri, { range, text })],\n\t\t\t\t{ quotableLabel: 'Notebook Replace' }\n\t\t\t);\n\t\t});\n\t}\n\n\tasync replaceAll(matches: CellFindMatchWithIndex[], texts: string[]): Promise<void> {\n\t\tif (!matches.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst textEdits: IWorkspaceTextEdit[] = [];\n\t\tthis._lastNotebookEditResource.push(matches[0].cell.uri);\n\n\t\tmatches.forEach(match => {\n\t\t\tmatch.contentMatches.forEach((singleMatch, index) => {\n\t\t\t\ttextEdits.push({\n\t\t\t\t\tversionId: undefined,\n\t\t\t\t\ttextEdit: { range: (singleMatch as FindMatch).range, text: texts[index] },\n\t\t\t\t\tresource: match.cell.uri\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\treturn Promise.all(matches.map(match => {\n\t\t\treturn match.cell.resolveTextModel();\n\t\t})).then(async () => {\n\t\t\tthis._bulkEditService.apply({ edits: textEdits }, { quotableLabel: 'Notebook Replace All' });\n\t\t\treturn;\n\t\t});\n\t}\n\n\t//#endregion\n\n\t//#region Undo/Redo\n\n\tprivate async _withElement(element: SingleModelEditStackElement | MultiModelEditStackElement, callback: () => Promise<void>) {\n\t\tconst viewCells = this._viewCells.filter(cell => element.matchesResource(cell.uri));\n\t\tconst refs = await Promise.all(viewCells.map(cell => this._textModelService.createModelReference(cell.uri)));\n\t\tawait callback();\n\t\trefs.forEach(ref => ref.dispose());\n\t}\n\n\tasync undo() {\n\n\t\tconst editStack = this._undoService.getElements(this.uri);\n\t\tconst element = editStack.past.length ? editStack.past[editStack.past.length - 1] : undefined;\n\n\t\tif (element && element instanceof SingleModelEditStackElement || element instanceof MultiModelEditStackElement) {\n\t\t\tawait this._withElement(element, async () => {\n\t\t\t\tawait this._undoService.undo(this.uri);\n\t\t\t});\n\n\t\t\treturn (element instanceof SingleModelEditStackElement) ? [element.resource] : element.resources;\n\t\t}\n\n\t\tawait this._undoService.undo(this.uri);\n\t\treturn [];\n\t}\n\n\tasync redo() {\n\n\t\tconst editStack = this._undoService.getElements(this.uri);\n\t\tconst element = editStack.future[0];\n\n\t\tif (element && element instanceof SingleModelEditStackElement || element instanceof MultiModelEditStackElement) {\n\t\t\tawait this._withElement(element, async () => {\n\t\t\t\tawait this._undoService.redo(this.uri);\n\t\t\t});\n\n\t\t\treturn (element instanceof SingleModelEditStackElement) ? [element.resource] : element.resources;\n\t\t}\n\n\t\tawait this._undoService.redo(this.uri);\n\n\t\treturn [];\n\t}\n\n\t//#endregion\n\n\tequal(notebook: NotebookTextModel) {\n\t\treturn this._notebook === notebook;\n\t}\n\n\toverride dispose() {\n\t\tthis._localStore.clear();\n\t\tthis._viewCells.forEach(cell => {\n\t\t\tcell.dispose();\n\t\t});\n\n\t\tsuper.dispose();\n\t}\n}\n\nexport type CellViewModel = (CodeCellViewModel | MarkupCellViewModel) & ICellViewModel;\n\nexport function createCellViewModel(instantiationService: IInstantiationService, notebookViewModel: NotebookViewModel, cell: NotebookCellTextModel, viewContext: ViewContext) {\n\tif (cell.cellKind === CellKind.Code) {\n\t\treturn instantiationService.createInstance(CodeCellViewModel, notebookViewModel.viewType, cell, notebookViewModel.layoutInfo, viewContext);\n\t} else {\n\t\treturn instantiationService.createInstance(MarkupCellViewModel, notebookViewModel.viewType, cell, notebookViewModel.layoutInfo, notebookViewModel, viewContext);\n\t}\n}\n"]}