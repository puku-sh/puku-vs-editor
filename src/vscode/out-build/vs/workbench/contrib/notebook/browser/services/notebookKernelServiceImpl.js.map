{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/browser/services/notebookKernelServiceImpl.ts","vs/workbench/contrib/notebook/browser/services/notebookKernelServiceImpl.ts"],"names":[],"mappings":"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","file":"notebookKernelServiceImpl.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event, Emitter } from '../../../../../base/common/event.js';\nimport { Disposable, IDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { INotebookKernelSourceAction, INotebookTextModel } from '../../common/notebookCommon.js';\nimport { INotebookKernel, ISelectedNotebooksChangeEvent, INotebookKernelMatchResult, INotebookKernelService, INotebookTextModelLike, ISourceAction, INotebookSourceActionChangeEvent, INotebookKernelDetectionTask, IKernelSourceActionProvider } from '../../common/notebookKernelService.js';\nimport { LRUCache, ResourceMap } from '../../../../../base/common/map.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../platform/storage/common/storage.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { INotebookService } from '../../common/notebookService.js';\nimport { IMenu, IMenuService, MenuId } from '../../../../../platform/actions/common/actions.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IAction } from '../../../../../base/common/actions.js';\nimport { MarshalledId } from '../../../../../base/common/marshallingIds.js';\nimport { Schemas } from '../../../../../base/common/network.js';\nimport { getActiveWindow, runWhenWindowIdle } from '../../../../../base/browser/dom.js';\n\nclass KernelInfo {\n\n\tprivate static _logicClock = 0;\n\n\treadonly kernel: INotebookKernel;\n\tpublic score: number;\n\treadonly time: number;\n\n\treadonly notebookPriorities = new ResourceMap<number>();\n\n\tconstructor(kernel: INotebookKernel) {\n\t\tthis.kernel = kernel;\n\t\tthis.score = -1;\n\t\tthis.time = KernelInfo._logicClock++;\n\t}\n}\n\nclass NotebookTextModelLikeId {\n\tstatic str(k: INotebookTextModelLike): string {\n\t\treturn `${k.notebookType}/${k.uri.toString()}`;\n\t}\n\tstatic obj(s: string): INotebookTextModelLike {\n\t\tconst idx = s.indexOf('/');\n\t\treturn {\n\t\t\tnotebookType: s.substring(0, idx),\n\t\t\turi: URI.parse(s.substring(idx + 1))\n\t\t};\n\t}\n}\n\nclass SourceAction extends Disposable implements ISourceAction {\n\texecution: Promise<void> | undefined;\n\tprivate readonly _onDidChangeState = this._register(new Emitter<void>());\n\treadonly onDidChangeState = this._onDidChangeState.event;\n\n\tconstructor(\n\t\treadonly action: IAction,\n\t\treadonly model: INotebookTextModelLike,\n\t\treadonly isPrimary: boolean\n\t) {\n\t\tsuper();\n\t}\n\n\tasync runAction() {\n\t\tif (this.execution) {\n\t\t\treturn this.execution;\n\t\t}\n\n\t\tthis.execution = this._runAction();\n\t\tthis._onDidChangeState.fire();\n\t\tawait this.execution;\n\t\tthis.execution = undefined;\n\t\tthis._onDidChangeState.fire();\n\t}\n\n\tprivate async _runAction(): Promise<void> {\n\t\ttry {\n\t\t\tawait this.action.run({\n\t\t\t\turi: this.model.uri,\n\t\t\t\t$mid: MarshalledId.NotebookActionContext\n\t\t\t});\n\n\t\t} catch (error) {\n\t\t\tconsole.warn(`Kernel source command failed: ${error}`);\n\t\t}\n\t}\n}\n\ninterface IKernelInfoCache {\n\tmenu: IMenu;\n\tactions: [ISourceAction, IDisposable][];\n\n}\n\nexport class NotebookKernelService extends Disposable implements INotebookKernelService {\n\n\tdeclare _serviceBrand: undefined;\n\n\tprivate readonly _kernels = new Map<string, KernelInfo>();\n\n\tprivate readonly _notebookBindings = new LRUCache<string, string>(1000, 0.7);\n\n\tprivate readonly _onDidChangeNotebookKernelBinding = this._register(new Emitter<ISelectedNotebooksChangeEvent>());\n\tprivate readonly _onDidAddKernel = this._register(new Emitter<INotebookKernel>());\n\tprivate readonly _onDidRemoveKernel = this._register(new Emitter<INotebookKernel>());\n\tprivate readonly _onDidChangeNotebookAffinity = this._register(new Emitter<void>());\n\tprivate readonly _onDidChangeSourceActions = this._register(new Emitter<INotebookSourceActionChangeEvent>());\n\tprivate readonly _onDidNotebookVariablesChange = this._register(new Emitter<URI>());\n\tprivate readonly _kernelSources = new Map<string, IKernelInfoCache>();\n\tprivate readonly _kernelSourceActionsUpdates = new Map<string, IDisposable>();\n\tprivate readonly _kernelDetectionTasks = new Map<string, INotebookKernelDetectionTask[]>();\n\tprivate readonly _onDidChangeKernelDetectionTasks = this._register(new Emitter<string>());\n\tprivate readonly _kernelSourceActionProviders = new Map<string, IKernelSourceActionProvider[]>();\n\n\treadonly onDidChangeSelectedNotebooks: Event<ISelectedNotebooksChangeEvent> = this._onDidChangeNotebookKernelBinding.event;\n\treadonly onDidAddKernel: Event<INotebookKernel> = this._onDidAddKernel.event;\n\treadonly onDidRemoveKernel: Event<INotebookKernel> = this._onDidRemoveKernel.event;\n\treadonly onDidChangeNotebookAffinity: Event<void> = this._onDidChangeNotebookAffinity.event;\n\treadonly onDidChangeSourceActions: Event<INotebookSourceActionChangeEvent> = this._onDidChangeSourceActions.event;\n\treadonly onDidChangeKernelDetectionTasks: Event<string> = this._onDidChangeKernelDetectionTasks.event;\n\treadonly onDidNotebookVariablesUpdate: Event<URI> = this._onDidNotebookVariablesChange.event;\n\n\tprivate static _storageNotebookBinding = 'notebook.controller2NotebookBindings';\n\n\n\tconstructor(\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IMenuService private readonly _menuService: IMenuService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService\n\t) {\n\t\tsuper();\n\n\t\t// auto associate kernels to new notebook documents, also emit event when\n\t\t// a notebook has been closed (but don't update the memento)\n\t\tthis._register(_notebookService.onDidAddNotebookDocument(this._tryAutoBindNotebook, this));\n\t\tthis._register(_notebookService.onWillRemoveNotebookDocument(notebook => {\n\t\t\tconst id = NotebookTextModelLikeId.str(notebook);\n\t\t\tconst kernelId = this._notebookBindings.get(id);\n\t\t\tif (kernelId && notebook.uri.scheme === Schemas.untitled) {\n\t\t\t\tthis.selectKernelForNotebook(undefined, notebook);\n\t\t\t}\n\t\t\tthis._kernelSourceActionsUpdates.get(id)?.dispose();\n\t\t\tthis._kernelSourceActionsUpdates.delete(id);\n\t\t}));\n\n\t\t// restore from storage\n\t\ttry {\n\t\t\tconst data = JSON.parse(this._storageService.get(NotebookKernelService._storageNotebookBinding, StorageScope.WORKSPACE, '[]'));\n\t\t\tthis._notebookBindings.fromJSON(data);\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t}\n\n\toverride dispose() {\n\t\tthis._kernels.clear();\n\t\tthis._kernelSources.forEach(v => {\n\t\t\tv.menu.dispose();\n\t\t\tv.actions.forEach(a => a[1].dispose());\n\t\t});\n\t\tthis._kernelSourceActionsUpdates.forEach(v => {\n\t\t\tv.dispose();\n\t\t});\n\t\tthis._kernelSourceActionsUpdates.clear();\n\t\tsuper.dispose();\n\t}\n\n\tprivate _persistSoonHandle?: IDisposable;\n\n\tprivate _persistMementos(): void {\n\t\tthis._persistSoonHandle?.dispose();\n\t\tthis._persistSoonHandle = runWhenWindowIdle(getActiveWindow(), () => {\n\t\t\tthis._storageService.store(NotebookKernelService._storageNotebookBinding, JSON.stringify(this._notebookBindings), StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\t}, 100);\n\t}\n\n\tprivate static _score(kernel: INotebookKernel, notebook: INotebookTextModelLike): number {\n\t\tif (kernel.viewType === '*') {\n\t\t\treturn 5;\n\t\t} else if (kernel.viewType === notebook.notebookType) {\n\t\t\treturn 10;\n\t\t} else {\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tprivate _tryAutoBindNotebook(notebook: INotebookTextModel, onlyThisKernel?: INotebookKernel): void {\n\n\t\tconst id = this._notebookBindings.get(NotebookTextModelLikeId.str(notebook));\n\t\tif (!id) {\n\t\t\t// no kernel associated\n\t\t\treturn;\n\t\t}\n\t\tconst existingKernel = this._kernels.get(id);\n\t\tif (!existingKernel || !NotebookKernelService._score(existingKernel.kernel, notebook)) {\n\t\t\t// associated kernel not known, not matching\n\t\t\treturn;\n\t\t}\n\t\tif (!onlyThisKernel || existingKernel.kernel === onlyThisKernel) {\n\t\t\tthis._onDidChangeNotebookKernelBinding.fire({ notebook: notebook.uri, oldKernel: undefined, newKernel: existingKernel.kernel.id });\n\t\t}\n\t}\n\n\tnotifyVariablesChange(notebookUri: URI): void {\n\t\tthis._onDidNotebookVariablesChange.fire(notebookUri);\n\t}\n\n\tregisterKernel(kernel: INotebookKernel): IDisposable {\n\t\tif (this._kernels.has(kernel.id)) {\n\t\t\tthrow new Error(`NOTEBOOK CONTROLLER with id '${kernel.id}' already exists`);\n\t\t}\n\n\t\tthis._kernels.set(kernel.id, new KernelInfo(kernel));\n\t\tthis._onDidAddKernel.fire(kernel);\n\n\t\t// auto associate the new kernel to existing notebooks it was\n\t\t// associated to in the past.\n\t\tfor (const notebook of this._notebookService.getNotebookTextModels()) {\n\t\t\tthis._tryAutoBindNotebook(notebook, kernel);\n\t\t}\n\n\t\treturn toDisposable(() => {\n\t\t\tif (this._kernels.delete(kernel.id)) {\n\t\t\t\tthis._onDidRemoveKernel.fire(kernel);\n\t\t\t}\n\t\t\tfor (const [key, candidate] of Array.from(this._notebookBindings)) {\n\t\t\t\tif (candidate === kernel.id) {\n\t\t\t\t\tthis._onDidChangeNotebookKernelBinding.fire({ notebook: NotebookTextModelLikeId.obj(key).uri, oldKernel: kernel.id, newKernel: undefined });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tgetMatchingKernel(notebook: INotebookTextModelLike): INotebookKernelMatchResult {\n\n\t\t// all applicable kernels\n\t\tconst kernels: { kernel: INotebookKernel; instanceAffinity: number; score: number }[] = [];\n\t\tfor (const info of this._kernels.values()) {\n\t\t\tconst score = NotebookKernelService._score(info.kernel, notebook);\n\t\t\tif (score) {\n\t\t\t\tkernels.push({\n\t\t\t\t\tscore,\n\t\t\t\t\tkernel: info.kernel,\n\t\t\t\t\tinstanceAffinity: info.notebookPriorities.get(notebook.uri) ?? 1 /* vscode.NotebookControllerPriority.Default */,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tkernels\n\t\t\t.sort((a, b) => b.instanceAffinity - a.instanceAffinity || a.score - b.score || a.kernel.label.localeCompare(b.kernel.label));\n\t\tconst all = kernels.map(obj => obj.kernel);\n\n\t\t// bound kernel\n\t\tconst selectedId = this._notebookBindings.get(NotebookTextModelLikeId.str(notebook));\n\t\tconst selected = selectedId ? this._kernels.get(selectedId)?.kernel : undefined;\n\t\tconst suggestions = kernels.filter(item => item.instanceAffinity > 1).map(item => item.kernel);\n\t\tconst hidden = kernels.filter(item => item.instanceAffinity < 0).map(item => item.kernel);\n\t\treturn { all, selected, suggestions, hidden };\n\t}\n\n\tgetSelectedOrSuggestedKernel(notebook: INotebookTextModel): INotebookKernel | undefined {\n\t\tconst info = this.getMatchingKernel(notebook);\n\t\tif (info.selected) {\n\t\t\treturn info.selected;\n\t\t}\n\n\t\tconst preferred = info.all.filter(kernel => this._kernels.get(kernel.id)?.notebookPriorities.get(notebook.uri) === 2 /* vscode.NotebookControllerPriority.Preferred */);\n\t\tif (preferred.length === 1) {\n\t\t\treturn preferred[0];\n\t\t}\n\n\t\treturn info.all.length === 1 ? info.all[0] : undefined;\n\t}\n\n\t// a notebook has one kernel, a kernel has N notebooks\n\t// notebook <-1----N-> kernel\n\tselectKernelForNotebook(kernel: INotebookKernel | undefined, notebook: INotebookTextModelLike): void {\n\t\tconst key = NotebookTextModelLikeId.str(notebook);\n\t\tconst oldKernel = this._notebookBindings.get(key);\n\t\tif (oldKernel !== kernel?.id) {\n\t\t\tif (kernel) {\n\t\t\t\tthis._notebookBindings.set(key, kernel.id);\n\t\t\t} else {\n\t\t\t\tthis._notebookBindings.delete(key);\n\t\t\t}\n\t\t\tthis._onDidChangeNotebookKernelBinding.fire({ notebook: notebook.uri, oldKernel, newKernel: kernel?.id });\n\t\t\tthis._persistMementos();\n\t\t}\n\t}\n\n\tpreselectKernelForNotebook(kernel: INotebookKernel, notebook: INotebookTextModelLike): void {\n\t\tconst key = NotebookTextModelLikeId.str(notebook);\n\t\tconst oldKernel = this._notebookBindings.get(key);\n\t\tif (oldKernel !== kernel?.id) {\n\t\t\tthis._notebookBindings.set(key, kernel.id);\n\t\t\tthis._persistMementos();\n\t\t}\n\t}\n\n\tupdateKernelNotebookAffinity(kernel: INotebookKernel, notebook: URI, preference: number | undefined): void {\n\t\tconst info = this._kernels.get(kernel.id);\n\t\tif (!info) {\n\t\t\tthrow new Error(`UNKNOWN kernel '${kernel.id}'`);\n\t\t}\n\t\tif (preference === undefined) {\n\t\t\tinfo.notebookPriorities.delete(notebook);\n\t\t} else {\n\t\t\tinfo.notebookPriorities.set(notebook, preference);\n\t\t}\n\t\tthis._onDidChangeNotebookAffinity.fire();\n\t}\n\n\tgetRunningSourceActions(notebook: INotebookTextModelLike) {\n\t\tconst id = NotebookTextModelLikeId.str(notebook);\n\t\tconst existingInfo = this._kernelSources.get(id);\n\t\tif (existingInfo) {\n\t\t\treturn existingInfo.actions.filter(action => action[0].execution).map(action => action[0]);\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tgetSourceActions(notebook: INotebookTextModelLike, contextKeyService: IContextKeyService | undefined): ISourceAction[] {\n\t\tcontextKeyService = contextKeyService ?? this._contextKeyService;\n\t\tconst id = NotebookTextModelLikeId.str(notebook);\n\t\tconst existingInfo = this._kernelSources.get(id);\n\n\t\tif (existingInfo) {\n\t\t\treturn existingInfo.actions.map(a => a[0]);\n\t\t}\n\n\t\tconst sourceMenu = this._register(this._menuService.createMenu(MenuId.NotebookKernelSource, contextKeyService));\n\t\tconst info: IKernelInfoCache = { menu: sourceMenu, actions: [] };\n\n\t\tconst loadActionsFromMenu = (menu: IMenu, document: INotebookTextModelLike) => {\n\t\t\tconst groups = menu.getActions({ shouldForwardArgs: true });\n\t\t\tconst sourceActions: [ISourceAction, IDisposable][] = [];\n\t\t\tgroups.forEach(group => {\n\t\t\t\tconst isPrimary = /^primary/.test(group[0]);\n\t\t\t\tgroup[1].forEach(action => {\n\t\t\t\t\tconst sourceAction = new SourceAction(action, document, isPrimary);\n\t\t\t\t\tconst stateChangeListener = sourceAction.onDidChangeState(() => {\n\t\t\t\t\t\tthis._onDidChangeSourceActions.fire({\n\t\t\t\t\t\t\tnotebook: document.uri,\n\t\t\t\t\t\t\tviewType: document.notebookType,\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tsourceActions.push([sourceAction, stateChangeListener]);\n\t\t\t\t});\n\t\t\t});\n\t\t\tinfo.actions = sourceActions;\n\t\t\tthis._kernelSources.set(id, info);\n\t\t\tthis._onDidChangeSourceActions.fire({ notebook: document.uri, viewType: document.notebookType });\n\t\t};\n\n\t\tthis._kernelSourceActionsUpdates.get(id)?.dispose();\n\t\tthis._kernelSourceActionsUpdates.set(id, sourceMenu.onDidChange(() => {\n\t\t\tloadActionsFromMenu(sourceMenu, notebook);\n\t\t}));\n\n\t\tloadActionsFromMenu(sourceMenu, notebook);\n\n\t\treturn info.actions.map(a => a[0]);\n\t}\n\n\tregisterNotebookKernelDetectionTask(task: INotebookKernelDetectionTask): IDisposable {\n\t\tconst notebookType = task.notebookType;\n\t\tconst all = this._kernelDetectionTasks.get(notebookType) ?? [];\n\t\tall.push(task);\n\t\tthis._kernelDetectionTasks.set(notebookType, all);\n\t\tthis._onDidChangeKernelDetectionTasks.fire(notebookType);\n\t\treturn toDisposable(() => {\n\t\t\tconst all = this._kernelDetectionTasks.get(notebookType) ?? [];\n\t\t\tconst idx = all.indexOf(task);\n\t\t\tif (idx >= 0) {\n\t\t\t\tall.splice(idx, 1);\n\t\t\t\tthis._kernelDetectionTasks.set(notebookType, all);\n\t\t\t\tthis._onDidChangeKernelDetectionTasks.fire(notebookType);\n\t\t\t}\n\t\t});\n\t}\n\n\tgetKernelDetectionTasks(notebook: INotebookTextModelLike): INotebookKernelDetectionTask[] {\n\t\treturn this._kernelDetectionTasks.get(notebook.notebookType) ?? [];\n\t}\n\n\tregisterKernelSourceActionProvider(viewType: string, provider: IKernelSourceActionProvider): IDisposable {\n\t\tconst providers = this._kernelSourceActionProviders.get(viewType) ?? [];\n\t\tproviders.push(provider);\n\t\tthis._kernelSourceActionProviders.set(viewType, providers);\n\t\tthis._onDidChangeSourceActions.fire({ viewType: viewType });\n\n\t\tconst eventEmitterDisposable = provider.onDidChangeSourceActions?.(() => {\n\t\t\tthis._onDidChangeSourceActions.fire({ viewType: viewType });\n\t\t});\n\n\t\treturn toDisposable(() => {\n\t\t\tconst providers = this._kernelSourceActionProviders.get(viewType) ?? [];\n\t\t\tconst idx = providers.indexOf(provider);\n\t\t\tif (idx >= 0) {\n\t\t\t\tproviders.splice(idx, 1);\n\t\t\t\tthis._kernelSourceActionProviders.set(viewType, providers);\n\t\t\t}\n\n\t\t\teventEmitterDisposable?.dispose();\n\t\t});\n\t}\n\n\t/**\n\t * Get kernel source actions from providers\n\t */\n\tgetKernelSourceActions2(notebook: INotebookTextModelLike): Promise<INotebookKernelSourceAction[]> {\n\t\tconst viewType = notebook.notebookType;\n\t\tconst providers = this._kernelSourceActionProviders.get(viewType) ?? [];\n\t\tconst promises = providers.map(provider => provider.provideKernelSourceActions());\n\t\treturn Promise.all(promises).then(actions => {\n\t\t\treturn actions.reduce((a, b) => a.concat(b), []);\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event, Emitter } from '../../../../../base/common/event.js';\nimport { Disposable, IDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { INotebookKernelSourceAction, INotebookTextModel } from '../../common/notebookCommon.js';\nimport { INotebookKernel, ISelectedNotebooksChangeEvent, INotebookKernelMatchResult, INotebookKernelService, INotebookTextModelLike, ISourceAction, INotebookSourceActionChangeEvent, INotebookKernelDetectionTask, IKernelSourceActionProvider } from '../../common/notebookKernelService.js';\nimport { LRUCache, ResourceMap } from '../../../../../base/common/map.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../platform/storage/common/storage.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { INotebookService } from '../../common/notebookService.js';\nimport { IMenu, IMenuService, MenuId } from '../../../../../platform/actions/common/actions.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IAction } from '../../../../../base/common/actions.js';\nimport { MarshalledId } from '../../../../../base/common/marshallingIds.js';\nimport { Schemas } from '../../../../../base/common/network.js';\nimport { getActiveWindow, runWhenWindowIdle } from '../../../../../base/browser/dom.js';\n\nclass KernelInfo {\n\n\tprivate static _logicClock = 0;\n\n\treadonly kernel: INotebookKernel;\n\tpublic score: number;\n\treadonly time: number;\n\n\treadonly notebookPriorities = new ResourceMap<number>();\n\n\tconstructor(kernel: INotebookKernel) {\n\t\tthis.kernel = kernel;\n\t\tthis.score = -1;\n\t\tthis.time = KernelInfo._logicClock++;\n\t}\n}\n\nclass NotebookTextModelLikeId {\n\tstatic str(k: INotebookTextModelLike): string {\n\t\treturn `${k.notebookType}/${k.uri.toString()}`;\n\t}\n\tstatic obj(s: string): INotebookTextModelLike {\n\t\tconst idx = s.indexOf('/');\n\t\treturn {\n\t\t\tnotebookType: s.substring(0, idx),\n\t\t\turi: URI.parse(s.substring(idx + 1))\n\t\t};\n\t}\n}\n\nclass SourceAction extends Disposable implements ISourceAction {\n\texecution: Promise<void> | undefined;\n\tprivate readonly _onDidChangeState = this._register(new Emitter<void>());\n\treadonly onDidChangeState = this._onDidChangeState.event;\n\n\tconstructor(\n\t\treadonly action: IAction,\n\t\treadonly model: INotebookTextModelLike,\n\t\treadonly isPrimary: boolean\n\t) {\n\t\tsuper();\n\t}\n\n\tasync runAction() {\n\t\tif (this.execution) {\n\t\t\treturn this.execution;\n\t\t}\n\n\t\tthis.execution = this._runAction();\n\t\tthis._onDidChangeState.fire();\n\t\tawait this.execution;\n\t\tthis.execution = undefined;\n\t\tthis._onDidChangeState.fire();\n\t}\n\n\tprivate async _runAction(): Promise<void> {\n\t\ttry {\n\t\t\tawait this.action.run({\n\t\t\t\turi: this.model.uri,\n\t\t\t\t$mid: MarshalledId.NotebookActionContext\n\t\t\t});\n\n\t\t} catch (error) {\n\t\t\tconsole.warn(`Kernel source command failed: ${error}`);\n\t\t}\n\t}\n}\n\ninterface IKernelInfoCache {\n\tmenu: IMenu;\n\tactions: [ISourceAction, IDisposable][];\n\n}\n\nexport class NotebookKernelService extends Disposable implements INotebookKernelService {\n\n\tdeclare _serviceBrand: undefined;\n\n\tprivate readonly _kernels = new Map<string, KernelInfo>();\n\n\tprivate readonly _notebookBindings = new LRUCache<string, string>(1000, 0.7);\n\n\tprivate readonly _onDidChangeNotebookKernelBinding = this._register(new Emitter<ISelectedNotebooksChangeEvent>());\n\tprivate readonly _onDidAddKernel = this._register(new Emitter<INotebookKernel>());\n\tprivate readonly _onDidRemoveKernel = this._register(new Emitter<INotebookKernel>());\n\tprivate readonly _onDidChangeNotebookAffinity = this._register(new Emitter<void>());\n\tprivate readonly _onDidChangeSourceActions = this._register(new Emitter<INotebookSourceActionChangeEvent>());\n\tprivate readonly _onDidNotebookVariablesChange = this._register(new Emitter<URI>());\n\tprivate readonly _kernelSources = new Map<string, IKernelInfoCache>();\n\tprivate readonly _kernelSourceActionsUpdates = new Map<string, IDisposable>();\n\tprivate readonly _kernelDetectionTasks = new Map<string, INotebookKernelDetectionTask[]>();\n\tprivate readonly _onDidChangeKernelDetectionTasks = this._register(new Emitter<string>());\n\tprivate readonly _kernelSourceActionProviders = new Map<string, IKernelSourceActionProvider[]>();\n\n\treadonly onDidChangeSelectedNotebooks: Event<ISelectedNotebooksChangeEvent> = this._onDidChangeNotebookKernelBinding.event;\n\treadonly onDidAddKernel: Event<INotebookKernel> = this._onDidAddKernel.event;\n\treadonly onDidRemoveKernel: Event<INotebookKernel> = this._onDidRemoveKernel.event;\n\treadonly onDidChangeNotebookAffinity: Event<void> = this._onDidChangeNotebookAffinity.event;\n\treadonly onDidChangeSourceActions: Event<INotebookSourceActionChangeEvent> = this._onDidChangeSourceActions.event;\n\treadonly onDidChangeKernelDetectionTasks: Event<string> = this._onDidChangeKernelDetectionTasks.event;\n\treadonly onDidNotebookVariablesUpdate: Event<URI> = this._onDidNotebookVariablesChange.event;\n\n\tprivate static _storageNotebookBinding = 'notebook.controller2NotebookBindings';\n\n\n\tconstructor(\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IMenuService private readonly _menuService: IMenuService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService\n\t) {\n\t\tsuper();\n\n\t\t// auto associate kernels to new notebook documents, also emit event when\n\t\t// a notebook has been closed (but don't update the memento)\n\t\tthis._register(_notebookService.onDidAddNotebookDocument(this._tryAutoBindNotebook, this));\n\t\tthis._register(_notebookService.onWillRemoveNotebookDocument(notebook => {\n\t\t\tconst id = NotebookTextModelLikeId.str(notebook);\n\t\t\tconst kernelId = this._notebookBindings.get(id);\n\t\t\tif (kernelId && notebook.uri.scheme === Schemas.untitled) {\n\t\t\t\tthis.selectKernelForNotebook(undefined, notebook);\n\t\t\t}\n\t\t\tthis._kernelSourceActionsUpdates.get(id)?.dispose();\n\t\t\tthis._kernelSourceActionsUpdates.delete(id);\n\t\t}));\n\n\t\t// restore from storage\n\t\ttry {\n\t\t\tconst data = JSON.parse(this._storageService.get(NotebookKernelService._storageNotebookBinding, StorageScope.WORKSPACE, '[]'));\n\t\t\tthis._notebookBindings.fromJSON(data);\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t}\n\n\toverride dispose() {\n\t\tthis._kernels.clear();\n\t\tthis._kernelSources.forEach(v => {\n\t\t\tv.menu.dispose();\n\t\t\tv.actions.forEach(a => a[1].dispose());\n\t\t});\n\t\tthis._kernelSourceActionsUpdates.forEach(v => {\n\t\t\tv.dispose();\n\t\t});\n\t\tthis._kernelSourceActionsUpdates.clear();\n\t\tsuper.dispose();\n\t}\n\n\tprivate _persistSoonHandle?: IDisposable;\n\n\tprivate _persistMementos(): void {\n\t\tthis._persistSoonHandle?.dispose();\n\t\tthis._persistSoonHandle = runWhenWindowIdle(getActiveWindow(), () => {\n\t\t\tthis._storageService.store(NotebookKernelService._storageNotebookBinding, JSON.stringify(this._notebookBindings), StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\t}, 100);\n\t}\n\n\tprivate static _score(kernel: INotebookKernel, notebook: INotebookTextModelLike): number {\n\t\tif (kernel.viewType === '*') {\n\t\t\treturn 5;\n\t\t} else if (kernel.viewType === notebook.notebookType) {\n\t\t\treturn 10;\n\t\t} else {\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tprivate _tryAutoBindNotebook(notebook: INotebookTextModel, onlyThisKernel?: INotebookKernel): void {\n\n\t\tconst id = this._notebookBindings.get(NotebookTextModelLikeId.str(notebook));\n\t\tif (!id) {\n\t\t\t// no kernel associated\n\t\t\treturn;\n\t\t}\n\t\tconst existingKernel = this._kernels.get(id);\n\t\tif (!existingKernel || !NotebookKernelService._score(existingKernel.kernel, notebook)) {\n\t\t\t// associated kernel not known, not matching\n\t\t\treturn;\n\t\t}\n\t\tif (!onlyThisKernel || existingKernel.kernel === onlyThisKernel) {\n\t\t\tthis._onDidChangeNotebookKernelBinding.fire({ notebook: notebook.uri, oldKernel: undefined, newKernel: existingKernel.kernel.id });\n\t\t}\n\t}\n\n\tnotifyVariablesChange(notebookUri: URI): void {\n\t\tthis._onDidNotebookVariablesChange.fire(notebookUri);\n\t}\n\n\tregisterKernel(kernel: INotebookKernel): IDisposable {\n\t\tif (this._kernels.has(kernel.id)) {\n\t\t\tthrow new Error(`NOTEBOOK CONTROLLER with id '${kernel.id}' already exists`);\n\t\t}\n\n\t\tthis._kernels.set(kernel.id, new KernelInfo(kernel));\n\t\tthis._onDidAddKernel.fire(kernel);\n\n\t\t// auto associate the new kernel to existing notebooks it was\n\t\t// associated to in the past.\n\t\tfor (const notebook of this._notebookService.getNotebookTextModels()) {\n\t\t\tthis._tryAutoBindNotebook(notebook, kernel);\n\t\t}\n\n\t\treturn toDisposable(() => {\n\t\t\tif (this._kernels.delete(kernel.id)) {\n\t\t\t\tthis._onDidRemoveKernel.fire(kernel);\n\t\t\t}\n\t\t\tfor (const [key, candidate] of Array.from(this._notebookBindings)) {\n\t\t\t\tif (candidate === kernel.id) {\n\t\t\t\t\tthis._onDidChangeNotebookKernelBinding.fire({ notebook: NotebookTextModelLikeId.obj(key).uri, oldKernel: kernel.id, newKernel: undefined });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tgetMatchingKernel(notebook: INotebookTextModelLike): INotebookKernelMatchResult {\n\n\t\t// all applicable kernels\n\t\tconst kernels: { kernel: INotebookKernel; instanceAffinity: number; score: number }[] = [];\n\t\tfor (const info of this._kernels.values()) {\n\t\t\tconst score = NotebookKernelService._score(info.kernel, notebook);\n\t\t\tif (score) {\n\t\t\t\tkernels.push({\n\t\t\t\t\tscore,\n\t\t\t\t\tkernel: info.kernel,\n\t\t\t\t\tinstanceAffinity: info.notebookPriorities.get(notebook.uri) ?? 1 /* vscode.NotebookControllerPriority.Default */,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tkernels\n\t\t\t.sort((a, b) => b.instanceAffinity - a.instanceAffinity || a.score - b.score || a.kernel.label.localeCompare(b.kernel.label));\n\t\tconst all = kernels.map(obj => obj.kernel);\n\n\t\t// bound kernel\n\t\tconst selectedId = this._notebookBindings.get(NotebookTextModelLikeId.str(notebook));\n\t\tconst selected = selectedId ? this._kernels.get(selectedId)?.kernel : undefined;\n\t\tconst suggestions = kernels.filter(item => item.instanceAffinity > 1).map(item => item.kernel);\n\t\tconst hidden = kernels.filter(item => item.instanceAffinity < 0).map(item => item.kernel);\n\t\treturn { all, selected, suggestions, hidden };\n\t}\n\n\tgetSelectedOrSuggestedKernel(notebook: INotebookTextModel): INotebookKernel | undefined {\n\t\tconst info = this.getMatchingKernel(notebook);\n\t\tif (info.selected) {\n\t\t\treturn info.selected;\n\t\t}\n\n\t\tconst preferred = info.all.filter(kernel => this._kernels.get(kernel.id)?.notebookPriorities.get(notebook.uri) === 2 /* vscode.NotebookControllerPriority.Preferred */);\n\t\tif (preferred.length === 1) {\n\t\t\treturn preferred[0];\n\t\t}\n\n\t\treturn info.all.length === 1 ? info.all[0] : undefined;\n\t}\n\n\t// a notebook has one kernel, a kernel has N notebooks\n\t// notebook <-1----N-> kernel\n\tselectKernelForNotebook(kernel: INotebookKernel | undefined, notebook: INotebookTextModelLike): void {\n\t\tconst key = NotebookTextModelLikeId.str(notebook);\n\t\tconst oldKernel = this._notebookBindings.get(key);\n\t\tif (oldKernel !== kernel?.id) {\n\t\t\tif (kernel) {\n\t\t\t\tthis._notebookBindings.set(key, kernel.id);\n\t\t\t} else {\n\t\t\t\tthis._notebookBindings.delete(key);\n\t\t\t}\n\t\t\tthis._onDidChangeNotebookKernelBinding.fire({ notebook: notebook.uri, oldKernel, newKernel: kernel?.id });\n\t\t\tthis._persistMementos();\n\t\t}\n\t}\n\n\tpreselectKernelForNotebook(kernel: INotebookKernel, notebook: INotebookTextModelLike): void {\n\t\tconst key = NotebookTextModelLikeId.str(notebook);\n\t\tconst oldKernel = this._notebookBindings.get(key);\n\t\tif (oldKernel !== kernel?.id) {\n\t\t\tthis._notebookBindings.set(key, kernel.id);\n\t\t\tthis._persistMementos();\n\t\t}\n\t}\n\n\tupdateKernelNotebookAffinity(kernel: INotebookKernel, notebook: URI, preference: number | undefined): void {\n\t\tconst info = this._kernels.get(kernel.id);\n\t\tif (!info) {\n\t\t\tthrow new Error(`UNKNOWN kernel '${kernel.id}'`);\n\t\t}\n\t\tif (preference === undefined) {\n\t\t\tinfo.notebookPriorities.delete(notebook);\n\t\t} else {\n\t\t\tinfo.notebookPriorities.set(notebook, preference);\n\t\t}\n\t\tthis._onDidChangeNotebookAffinity.fire();\n\t}\n\n\tgetRunningSourceActions(notebook: INotebookTextModelLike) {\n\t\tconst id = NotebookTextModelLikeId.str(notebook);\n\t\tconst existingInfo = this._kernelSources.get(id);\n\t\tif (existingInfo) {\n\t\t\treturn existingInfo.actions.filter(action => action[0].execution).map(action => action[0]);\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tgetSourceActions(notebook: INotebookTextModelLike, contextKeyService: IContextKeyService | undefined): ISourceAction[] {\n\t\tcontextKeyService = contextKeyService ?? this._contextKeyService;\n\t\tconst id = NotebookTextModelLikeId.str(notebook);\n\t\tconst existingInfo = this._kernelSources.get(id);\n\n\t\tif (existingInfo) {\n\t\t\treturn existingInfo.actions.map(a => a[0]);\n\t\t}\n\n\t\tconst sourceMenu = this._register(this._menuService.createMenu(MenuId.NotebookKernelSource, contextKeyService));\n\t\tconst info: IKernelInfoCache = { menu: sourceMenu, actions: [] };\n\n\t\tconst loadActionsFromMenu = (menu: IMenu, document: INotebookTextModelLike) => {\n\t\t\tconst groups = menu.getActions({ shouldForwardArgs: true });\n\t\t\tconst sourceActions: [ISourceAction, IDisposable][] = [];\n\t\t\tgroups.forEach(group => {\n\t\t\t\tconst isPrimary = /^primary/.test(group[0]);\n\t\t\t\tgroup[1].forEach(action => {\n\t\t\t\t\tconst sourceAction = new SourceAction(action, document, isPrimary);\n\t\t\t\t\tconst stateChangeListener = sourceAction.onDidChangeState(() => {\n\t\t\t\t\t\tthis._onDidChangeSourceActions.fire({\n\t\t\t\t\t\t\tnotebook: document.uri,\n\t\t\t\t\t\t\tviewType: document.notebookType,\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tsourceActions.push([sourceAction, stateChangeListener]);\n\t\t\t\t});\n\t\t\t});\n\t\t\tinfo.actions = sourceActions;\n\t\t\tthis._kernelSources.set(id, info);\n\t\t\tthis._onDidChangeSourceActions.fire({ notebook: document.uri, viewType: document.notebookType });\n\t\t};\n\n\t\tthis._kernelSourceActionsUpdates.get(id)?.dispose();\n\t\tthis._kernelSourceActionsUpdates.set(id, sourceMenu.onDidChange(() => {\n\t\t\tloadActionsFromMenu(sourceMenu, notebook);\n\t\t}));\n\n\t\tloadActionsFromMenu(sourceMenu, notebook);\n\n\t\treturn info.actions.map(a => a[0]);\n\t}\n\n\tregisterNotebookKernelDetectionTask(task: INotebookKernelDetectionTask): IDisposable {\n\t\tconst notebookType = task.notebookType;\n\t\tconst all = this._kernelDetectionTasks.get(notebookType) ?? [];\n\t\tall.push(task);\n\t\tthis._kernelDetectionTasks.set(notebookType, all);\n\t\tthis._onDidChangeKernelDetectionTasks.fire(notebookType);\n\t\treturn toDisposable(() => {\n\t\t\tconst all = this._kernelDetectionTasks.get(notebookType) ?? [];\n\t\t\tconst idx = all.indexOf(task);\n\t\t\tif (idx >= 0) {\n\t\t\t\tall.splice(idx, 1);\n\t\t\t\tthis._kernelDetectionTasks.set(notebookType, all);\n\t\t\t\tthis._onDidChangeKernelDetectionTasks.fire(notebookType);\n\t\t\t}\n\t\t});\n\t}\n\n\tgetKernelDetectionTasks(notebook: INotebookTextModelLike): INotebookKernelDetectionTask[] {\n\t\treturn this._kernelDetectionTasks.get(notebook.notebookType) ?? [];\n\t}\n\n\tregisterKernelSourceActionProvider(viewType: string, provider: IKernelSourceActionProvider): IDisposable {\n\t\tconst providers = this._kernelSourceActionProviders.get(viewType) ?? [];\n\t\tproviders.push(provider);\n\t\tthis._kernelSourceActionProviders.set(viewType, providers);\n\t\tthis._onDidChangeSourceActions.fire({ viewType: viewType });\n\n\t\tconst eventEmitterDisposable = provider.onDidChangeSourceActions?.(() => {\n\t\t\tthis._onDidChangeSourceActions.fire({ viewType: viewType });\n\t\t});\n\n\t\treturn toDisposable(() => {\n\t\t\tconst providers = this._kernelSourceActionProviders.get(viewType) ?? [];\n\t\t\tconst idx = providers.indexOf(provider);\n\t\t\tif (idx >= 0) {\n\t\t\t\tproviders.splice(idx, 1);\n\t\t\t\tthis._kernelSourceActionProviders.set(viewType, providers);\n\t\t\t}\n\n\t\t\teventEmitterDisposable?.dispose();\n\t\t});\n\t}\n\n\t/**\n\t * Get kernel source actions from providers\n\t */\n\tgetKernelSourceActions2(notebook: INotebookTextModelLike): Promise<INotebookKernelSourceAction[]> {\n\t\tconst viewType = notebook.notebookType;\n\t\tconst providers = this._kernelSourceActionProviders.get(viewType) ?? [];\n\t\tconst promises = providers.map(provider => provider.provideKernelSourceActions());\n\t\treturn Promise.all(promises).then(actions => {\n\t\t\treturn actions.reduce((a, b) => a.concat(b), []);\n\t\t});\n\t}\n}\n"]}