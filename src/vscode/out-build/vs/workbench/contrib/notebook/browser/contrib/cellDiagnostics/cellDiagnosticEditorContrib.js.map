{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/browser/contrib/cellDiagnostics/cellDiagnosticEditorContrib.ts","vs/workbench/contrib/notebook/browser/contrib/cellDiagnostics/cellDiagnosticEditorContrib.ts"],"names":[],"mappings":"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","file":"cellDiagnosticEditorContrib.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable, IDisposable, toDisposable } from '../../../../../../base/common/lifecycle.js';\nimport { IMarkerData, IMarkerService } from '../../../../../../platform/markers/common/markers.js';\nimport { IRange } from '../../../../../../editor/common/core/range.js';\nimport { ICellExecutionStateChangedEvent, IExecutionStateChangedEvent, INotebookExecutionStateService, NotebookExecutionType } from '../../../common/notebookExecutionStateService.js';\nimport { IConfigurationService } from '../../../../../../platform/configuration/common/configuration.js';\nimport { CellKind, NotebookSetting } from '../../../common/notebookCommon.js';\nimport { INotebookEditor, INotebookEditorContribution } from '../../notebookBrowser.js';\nimport { registerNotebookContribution } from '../../notebookEditorExtensions.js';\nimport { CodeCellViewModel } from '../../viewModel/codeCellViewModel.js';\nimport { Event } from '../../../../../../base/common/event.js';\nimport { IChatAgentService } from '../../../../chat/common/chatAgents.js';\nimport { ChatAgentLocation } from '../../../../chat/common/constants.js';\nimport { autorun } from '../../../../../../base/common/observable.js';\n\nexport class CellDiagnostics extends Disposable implements INotebookEditorContribution {\n\n\tstatic ID: string = 'workbench.notebook.cellDiagnostics';\n\n\tprivate enabled = false;\n\tprivate listening = false;\n\tprivate diagnosticsByHandle: Map<number, IDisposable[]> = new Map();\n\n\tconstructor(\n\t\tprivate readonly notebookEditor: INotebookEditor,\n\t\t@INotebookExecutionStateService private readonly notebookExecutionStateService: INotebookExecutionStateService,\n\t\t@IMarkerService private readonly markerService: IMarkerService,\n\t\t@IChatAgentService private readonly chatAgentService: IChatAgentService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService\n\t) {\n\t\tsuper();\n\n\t\tthis.updateEnabled();\n\n\t\tthis._register(chatAgentService.onDidChangeAgents(() => this.updateEnabled()));\n\t\tthis._register(configurationService.onDidChangeConfiguration((e) => {\n\t\t\tif (e.affectsConfiguration(NotebookSetting.cellFailureDiagnostics)) {\n\t\t\t\tthis.updateEnabled();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate hasNotebookAgent(): boolean {\n\t\tconst agents = this.chatAgentService.getAgents();\n\t\treturn !!agents.find(agent => agent.locations.includes(ChatAgentLocation.Notebook));\n\t}\n\n\tprivate updateEnabled() {\n\t\tconst settingEnabled = this.configurationService.getValue(NotebookSetting.cellFailureDiagnostics);\n\t\tif (this.enabled && (!settingEnabled || !this.hasNotebookAgent())) {\n\t\t\tthis.enabled = false;\n\t\t\tthis.clearAll();\n\t\t} else if (!this.enabled && settingEnabled && this.hasNotebookAgent()) {\n\t\t\tthis.enabled = true;\n\t\t\tif (!this.listening) {\n\t\t\t\tthis.listening = true;\n\t\t\t\tthis._register(Event.accumulate<ICellExecutionStateChangedEvent | IExecutionStateChangedEvent>(\n\t\t\t\t\tthis.notebookExecutionStateService.onDidChangeExecution, 200\n\t\t\t\t)((e) => this.handleChangeExecutionState(e)));\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate handleChangeExecutionState(changes: (ICellExecutionStateChangedEvent | IExecutionStateChangedEvent)[]) {\n\t\tif (!this.enabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handled = new Set<number>();\n\t\tfor (const e of changes.reverse()) {\n\n\t\t\tconst notebookUri = this.notebookEditor.textModel?.uri;\n\t\t\tif (e.type === NotebookExecutionType.cell && notebookUri && e.affectsNotebook(notebookUri) && !handled.has(e.cellHandle)) {\n\t\t\t\thandled.add(e.cellHandle);\n\t\t\t\tif (!!e.changed) {\n\t\t\t\t\t// cell is running\n\t\t\t\t\tthis.clear(e.cellHandle);\n\t\t\t\t} else {\n\t\t\t\t\tthis.setDiagnostics(e.cellHandle);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate clearAll() {\n\t\tfor (const handle of this.diagnosticsByHandle.keys()) {\n\t\t\tthis.clear(handle);\n\t\t}\n\t}\n\n\tpublic clear(cellHandle: number) {\n\t\tconst disposables = this.diagnosticsByHandle.get(cellHandle);\n\t\tif (disposables) {\n\t\t\tfor (const disposable of disposables) {\n\t\t\t\tdisposable.dispose();\n\t\t\t}\n\t\t\tthis.diagnosticsByHandle.delete(cellHandle);\n\t\t}\n\t}\n\n\tprivate setDiagnostics(cellHandle: number) {\n\t\tif (this.diagnosticsByHandle.has(cellHandle)) {\n\t\t\t// multiple diagnostics per cell not supported for now\n\t\t\treturn;\n\t\t}\n\n\t\tconst cell = this.notebookEditor.getCellByHandle(cellHandle);\n\t\tif (!cell || cell.cellKind !== CellKind.Code) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst metadata = cell.model.internalMetadata;\n\t\tif (cell instanceof CodeCellViewModel && !metadata.lastRunSuccess && metadata?.error?.location) {\n\t\t\tconst disposables: IDisposable[] = [];\n\t\t\tconst errorLabel = metadata.error.name ? `${metadata.error.name}: ${metadata.error.message}` : metadata.error.message;\n\t\t\tconst marker = this.createMarkerData(errorLabel, metadata.error.location);\n\t\t\tthis.markerService.changeOne(CellDiagnostics.ID, cell.uri, [marker]);\n\t\t\tdisposables.push(toDisposable(() => this.markerService.changeOne(CellDiagnostics.ID, cell.uri, [])));\n\t\t\tcell.executionErrorDiagnostic.set(metadata.error, undefined);\n\t\t\tdisposables.push(toDisposable(() => cell.executionErrorDiagnostic.set(undefined, undefined)));\n\t\t\tdisposables.push(autorun((r) => {\n\t\t\t\tif (!cell.executionErrorDiagnostic.read(r)) {\n\t\t\t\t\tthis.clear(cellHandle);\n\t\t\t\t}\n\t\t\t}));\n\t\t\tdisposables.push(cell.model.onDidChangeOutputs(() => {\n\t\t\t\tif (cell.model.outputs.length === 0) {\n\t\t\t\t\tthis.clear(cellHandle);\n\t\t\t\t}\n\t\t\t}));\n\t\t\tdisposables.push(cell.model.onDidChangeContent(() => {\n\t\t\t\tthis.clear(cellHandle);\n\t\t\t}));\n\t\t\tthis.diagnosticsByHandle.set(cellHandle, disposables);\n\t\t}\n\t}\n\n\tprivate createMarkerData(message: string, location: IRange): IMarkerData {\n\t\treturn {\n\t\t\tseverity: 8,\n\t\t\tmessage: message,\n\t\t\tstartLineNumber: location.startLineNumber + 1,\n\t\t\tstartColumn: location.startColumn + 1,\n\t\t\tendLineNumber: location.endLineNumber + 1,\n\t\t\tendColumn: location.endColumn + 1,\n\t\t\tsource: 'Cell Execution Error'\n\t\t};\n\t}\n\n\toverride dispose() {\n\t\tsuper.dispose();\n\t\tthis.clearAll();\n\t}\n\n}\n\nregisterNotebookContribution(CellDiagnostics.ID, CellDiagnostics);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable, IDisposable, toDisposable } from '../../../../../../base/common/lifecycle.js';\nimport { IMarkerData, IMarkerService } from '../../../../../../platform/markers/common/markers.js';\nimport { IRange } from '../../../../../../editor/common/core/range.js';\nimport { ICellExecutionStateChangedEvent, IExecutionStateChangedEvent, INotebookExecutionStateService, NotebookExecutionType } from '../../../common/notebookExecutionStateService.js';\nimport { IConfigurationService } from '../../../../../../platform/configuration/common/configuration.js';\nimport { CellKind, NotebookSetting } from '../../../common/notebookCommon.js';\nimport { INotebookEditor, INotebookEditorContribution } from '../../notebookBrowser.js';\nimport { registerNotebookContribution } from '../../notebookEditorExtensions.js';\nimport { CodeCellViewModel } from '../../viewModel/codeCellViewModel.js';\nimport { Event } from '../../../../../../base/common/event.js';\nimport { IChatAgentService } from '../../../../chat/common/chatAgents.js';\nimport { ChatAgentLocation } from '../../../../chat/common/constants.js';\nimport { autorun } from '../../../../../../base/common/observable.js';\n\nexport class CellDiagnostics extends Disposable implements INotebookEditorContribution {\n\n\tstatic ID: string = 'workbench.notebook.cellDiagnostics';\n\n\tprivate enabled = false;\n\tprivate listening = false;\n\tprivate diagnosticsByHandle: Map<number, IDisposable[]> = new Map();\n\n\tconstructor(\n\t\tprivate readonly notebookEditor: INotebookEditor,\n\t\t@INotebookExecutionStateService private readonly notebookExecutionStateService: INotebookExecutionStateService,\n\t\t@IMarkerService private readonly markerService: IMarkerService,\n\t\t@IChatAgentService private readonly chatAgentService: IChatAgentService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService\n\t) {\n\t\tsuper();\n\n\t\tthis.updateEnabled();\n\n\t\tthis._register(chatAgentService.onDidChangeAgents(() => this.updateEnabled()));\n\t\tthis._register(configurationService.onDidChangeConfiguration((e) => {\n\t\t\tif (e.affectsConfiguration(NotebookSetting.cellFailureDiagnostics)) {\n\t\t\t\tthis.updateEnabled();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate hasNotebookAgent(): boolean {\n\t\tconst agents = this.chatAgentService.getAgents();\n\t\treturn !!agents.find(agent => agent.locations.includes(ChatAgentLocation.Notebook));\n\t}\n\n\tprivate updateEnabled() {\n\t\tconst settingEnabled = this.configurationService.getValue(NotebookSetting.cellFailureDiagnostics);\n\t\tif (this.enabled && (!settingEnabled || !this.hasNotebookAgent())) {\n\t\t\tthis.enabled = false;\n\t\t\tthis.clearAll();\n\t\t} else if (!this.enabled && settingEnabled && this.hasNotebookAgent()) {\n\t\t\tthis.enabled = true;\n\t\t\tif (!this.listening) {\n\t\t\t\tthis.listening = true;\n\t\t\t\tthis._register(Event.accumulate<ICellExecutionStateChangedEvent | IExecutionStateChangedEvent>(\n\t\t\t\t\tthis.notebookExecutionStateService.onDidChangeExecution, 200\n\t\t\t\t)((e) => this.handleChangeExecutionState(e)));\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate handleChangeExecutionState(changes: (ICellExecutionStateChangedEvent | IExecutionStateChangedEvent)[]) {\n\t\tif (!this.enabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handled = new Set<number>();\n\t\tfor (const e of changes.reverse()) {\n\n\t\t\tconst notebookUri = this.notebookEditor.textModel?.uri;\n\t\t\tif (e.type === NotebookExecutionType.cell && notebookUri && e.affectsNotebook(notebookUri) && !handled.has(e.cellHandle)) {\n\t\t\t\thandled.add(e.cellHandle);\n\t\t\t\tif (!!e.changed) {\n\t\t\t\t\t// cell is running\n\t\t\t\t\tthis.clear(e.cellHandle);\n\t\t\t\t} else {\n\t\t\t\t\tthis.setDiagnostics(e.cellHandle);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate clearAll() {\n\t\tfor (const handle of this.diagnosticsByHandle.keys()) {\n\t\t\tthis.clear(handle);\n\t\t}\n\t}\n\n\tpublic clear(cellHandle: number) {\n\t\tconst disposables = this.diagnosticsByHandle.get(cellHandle);\n\t\tif (disposables) {\n\t\t\tfor (const disposable of disposables) {\n\t\t\t\tdisposable.dispose();\n\t\t\t}\n\t\t\tthis.diagnosticsByHandle.delete(cellHandle);\n\t\t}\n\t}\n\n\tprivate setDiagnostics(cellHandle: number) {\n\t\tif (this.diagnosticsByHandle.has(cellHandle)) {\n\t\t\t// multiple diagnostics per cell not supported for now\n\t\t\treturn;\n\t\t}\n\n\t\tconst cell = this.notebookEditor.getCellByHandle(cellHandle);\n\t\tif (!cell || cell.cellKind !== CellKind.Code) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst metadata = cell.model.internalMetadata;\n\t\tif (cell instanceof CodeCellViewModel && !metadata.lastRunSuccess && metadata?.error?.location) {\n\t\t\tconst disposables: IDisposable[] = [];\n\t\t\tconst errorLabel = metadata.error.name ? `${metadata.error.name}: ${metadata.error.message}` : metadata.error.message;\n\t\t\tconst marker = this.createMarkerData(errorLabel, metadata.error.location);\n\t\t\tthis.markerService.changeOne(CellDiagnostics.ID, cell.uri, [marker]);\n\t\t\tdisposables.push(toDisposable(() => this.markerService.changeOne(CellDiagnostics.ID, cell.uri, [])));\n\t\t\tcell.executionErrorDiagnostic.set(metadata.error, undefined);\n\t\t\tdisposables.push(toDisposable(() => cell.executionErrorDiagnostic.set(undefined, undefined)));\n\t\t\tdisposables.push(autorun((r) => {\n\t\t\t\tif (!cell.executionErrorDiagnostic.read(r)) {\n\t\t\t\t\tthis.clear(cellHandle);\n\t\t\t\t}\n\t\t\t}));\n\t\t\tdisposables.push(cell.model.onDidChangeOutputs(() => {\n\t\t\t\tif (cell.model.outputs.length === 0) {\n\t\t\t\t\tthis.clear(cellHandle);\n\t\t\t\t}\n\t\t\t}));\n\t\t\tdisposables.push(cell.model.onDidChangeContent(() => {\n\t\t\t\tthis.clear(cellHandle);\n\t\t\t}));\n\t\t\tthis.diagnosticsByHandle.set(cellHandle, disposables);\n\t\t}\n\t}\n\n\tprivate createMarkerData(message: string, location: IRange): IMarkerData {\n\t\treturn {\n\t\t\tseverity: 8,\n\t\t\tmessage: message,\n\t\t\tstartLineNumber: location.startLineNumber + 1,\n\t\t\tstartColumn: location.startColumn + 1,\n\t\t\tendLineNumber: location.endLineNumber + 1,\n\t\t\tendColumn: location.endColumn + 1,\n\t\t\tsource: 'Cell Execution Error'\n\t\t};\n\t}\n\n\toverride dispose() {\n\t\tsuper.dispose();\n\t\tthis.clearAll();\n\t}\n\n}\n\nregisterNotebookContribution(CellDiagnostics.ID, CellDiagnostics);\n"]}