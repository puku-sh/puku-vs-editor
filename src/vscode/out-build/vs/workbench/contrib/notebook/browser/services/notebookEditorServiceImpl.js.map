{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/browser/services/notebookEditorServiceImpl.ts","vs/workbench/contrib/notebook/browser/services/notebookEditorServiceImpl.ts"],"names":[],"mappings":"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","file":"notebookEditorServiceImpl.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CodeWindow } from '../../../../../base/browser/window.js';\nimport { ResourceMap } from '../../../../../base/common/map.js';\nimport { getDefaultNotebookCreationOptions, NotebookEditorWidget } from '../notebookEditorWidget.js';\nimport { DisposableStore, IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { IEditorGroupsService, IEditorGroup } from '../../../../services/editor/common/editorGroupsService.js';\nimport { IInstantiationService, ServicesAccessor } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { isCompositeNotebookEditorInput, isNotebookEditorInput, NotebookEditorInput } from '../../common/notebookEditorInput.js';\nimport { IBorrowValue, INotebookEditorService } from './notebookEditorService.js';\nimport { INotebookEditor, INotebookEditorCreationOptions } from '../notebookBrowser.js';\nimport { Emitter } from '../../../../../base/common/event.js';\nimport { GroupIdentifier, GroupModelChangeKind } from '../../../../common/editor.js';\nimport { Dimension } from '../../../../../base/browser/dom.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { IEditorService } from '../../../../services/editor/common/editorService.js';\nimport { IContextKey, IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { InteractiveWindowOpen, MOST_RECENT_REPL_EDITOR } from '../../common/notebookContextKeys.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { IEditorProgressService } from '../../../../../platform/progress/common/progress.js';\nimport { NotebookDiffEditorInput } from '../../common/notebookDiffEditorInput.js';\nimport { ICodeEditor } from '../../../../../editor/browser/editorBrowser.js';\n\nexport class NotebookEditorWidgetService implements INotebookEditorService {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate _tokenPool = 1;\n\n\tprivate readonly _disposables = new DisposableStore();\n\tprivate readonly _notebookEditors = new Map<string, INotebookEditor>();\n\n\tprivate readonly groupListener = new Map<number, IDisposable[]>();\n\n\tprivate readonly _onNotebookEditorAdd = new Emitter<INotebookEditor>();\n\tprivate readonly _onNotebookEditorsRemove = new Emitter<INotebookEditor>();\n\treadonly onDidAddNotebookEditor = this._onNotebookEditorAdd.event;\n\treadonly onDidRemoveNotebookEditor = this._onNotebookEditorsRemove.event;\n\n\tprivate readonly _mostRecentRepl: IContextKey<string | undefined>;\n\n\tprivate readonly _borrowableEditors = new Map<number, ResourceMap<{ widget: NotebookEditorWidget; editorType: string; token: number | undefined; disposableStore: DisposableStore }[]>>();\n\n\tconstructor(\n\t\t@IEditorGroupsService private readonly editorGroupService: IEditorGroupsService,\n\t\t@IEditorService editorService: IEditorService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tconst onNewGroup = (group: IEditorGroup) => {\n\t\t\tconst { id } = group;\n\t\t\tconst listeners: IDisposable[] = [];\n\t\t\tlisteners.push(group.onDidCloseEditor(e => {\n\t\t\t\tconst widgetMap = this._borrowableEditors.get(group.id);\n\t\t\t\tif (!widgetMap) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst inputs = e.editor instanceof NotebookEditorInput || e.editor instanceof NotebookDiffEditorInput\n\t\t\t\t\t? [e.editor]\n\t\t\t\t\t: (isCompositeNotebookEditorInput(e.editor) ? e.editor.editorInputs : []);\n\t\t\t\tinputs.forEach(input => {\n\t\t\t\t\tconst widgets = widgetMap.get(input.resource);\n\t\t\t\t\tconst index = widgets?.findIndex(widget => widget.editorType === input.typeId);\n\t\t\t\t\tif (!widgets || index === undefined || index === -1) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst value = widgets.splice(index, 1)[0];\n\t\t\t\t\tvalue.token = undefined;\n\t\t\t\t\tthis._disposeWidget(value.widget);\n\t\t\t\t\tvalue.disposableStore.dispose();\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\tvalue.widget = (<any>undefined); // unset the widget so that others that still hold a reference don't harm us\n\t\t\t\t});\n\t\t\t}));\n\t\t\tlisteners.push(group.onWillMoveEditor(e => {\n\t\t\t\tif (isNotebookEditorInput(e.editor)) {\n\t\t\t\t\tthis._allowWidgetMove(e.editor, e.groupId, e.target);\n\t\t\t\t}\n\n\t\t\t\tif (isCompositeNotebookEditorInput(e.editor)) {\n\t\t\t\t\te.editor.editorInputs.forEach(input => {\n\t\t\t\t\t\tthis._allowWidgetMove(input, e.groupId, e.target);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}));\n\t\t\tthis.groupListener.set(id, listeners);\n\t\t};\n\t\tthis._disposables.add(editorGroupService.onDidAddGroup(onNewGroup));\n\t\teditorGroupService.whenReady.then(() => editorGroupService.groups.forEach(onNewGroup));\n\n\t\t// group removed -> clean up listeners, clean up widgets\n\t\tthis._disposables.add(editorGroupService.onDidRemoveGroup(group => {\n\t\t\tconst listeners = this.groupListener.get(group.id);\n\t\t\tif (listeners) {\n\t\t\t\tlisteners.forEach(listener => listener.dispose());\n\t\t\t\tthis.groupListener.delete(group.id);\n\t\t\t}\n\t\t\tconst widgets = this._borrowableEditors.get(group.id);\n\t\t\tthis._borrowableEditors.delete(group.id);\n\t\t\tif (widgets) {\n\t\t\t\tfor (const values of widgets.values()) {\n\t\t\t\t\tfor (const value of values) {\n\t\t\t\t\t\tvalue.token = undefined;\n\t\t\t\t\t\tthis._disposeWidget(value.widget);\n\t\t\t\t\t\tvalue.disposableStore.dispose();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._mostRecentRepl = MOST_RECENT_REPL_EDITOR.bindTo(contextKeyService);\n\t\tconst interactiveWindowOpen = InteractiveWindowOpen.bindTo(contextKeyService);\n\t\tthis._disposables.add(editorService.onDidEditorsChange(e => {\n\t\t\tif (e.event.kind === GroupModelChangeKind.EDITOR_OPEN && !interactiveWindowOpen.get()) {\n\t\t\t\tif (editorService.editors.find(editor => isCompositeNotebookEditorInput(editor))) {\n\t\t\t\t\tinteractiveWindowOpen.set(true);\n\t\t\t\t}\n\t\t\t} else if (e.event.kind === GroupModelChangeKind.EDITOR_CLOSE && interactiveWindowOpen.get()) {\n\t\t\t\tif (!editorService.editors.find(editor => isCompositeNotebookEditorInput(editor))) {\n\t\t\t\t\tinteractiveWindowOpen.set(false);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tdispose() {\n\t\tthis._disposables.dispose();\n\t\tthis._onNotebookEditorAdd.dispose();\n\t\tthis._onNotebookEditorsRemove.dispose();\n\t\tthis.groupListener.forEach((listeners) => {\n\t\t\tlisteners.forEach(listener => listener.dispose());\n\t\t});\n\t\tthis.groupListener.clear();\n\t\tthis._borrowableEditors.forEach(widgetMap => {\n\t\t\twidgetMap.forEach(widgets => {\n\t\t\t\twidgets.forEach(widget => widget.disposableStore.dispose());\n\t\t\t});\n\t\t});\n\t}\n\n\t// --- group-based editor borrowing...\n\n\tprivate _disposeWidget(widget: NotebookEditorWidget): void {\n\t\twidget.onWillHide();\n\t\tconst domNode = widget.getDomNode();\n\t\twidget.dispose();\n\t\tdomNode.remove();\n\t}\n\n\tprivate _allowWidgetMove(input: NotebookEditorInput, sourceID: GroupIdentifier, targetID: GroupIdentifier): void {\n\t\tconst sourcePart = this.editorGroupService.getPart(sourceID);\n\t\tconst targetPart = this.editorGroupService.getPart(targetID);\n\n\t\tif (sourcePart.windowId !== targetPart.windowId) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst target = this._borrowableEditors.get(targetID)?.get(input.resource)?.findIndex(widget => widget.editorType === input.typeId);\n\t\tif (target !== undefined && target !== -1) {\n\t\t\t// not needed, a separate widget is already there\n\t\t\treturn;\n\t\t}\n\n\t\tconst widget = this._borrowableEditors.get(sourceID)?.get(input.resource)?.find(widget => widget.editorType === input.typeId);\n\t\tif (!widget) {\n\t\t\tthrow new Error('no widget at source group');\n\t\t}\n\n\t\t// don't allow the widget to be retrieved at its previous location any more\n\t\tconst sourceWidgets = this._borrowableEditors.get(sourceID)?.get(input.resource);\n\t\tif (sourceWidgets) {\n\t\t\tconst indexToRemove = sourceWidgets.findIndex(widget => widget.editorType === input.typeId);\n\t\t\tif (indexToRemove !== -1) {\n\t\t\t\tsourceWidgets.splice(indexToRemove, 1);\n\t\t\t}\n\t\t}\n\n\t\t// allow the widget to be retrieved at its new location\n\t\tlet targetMap = this._borrowableEditors.get(targetID);\n\t\tif (!targetMap) {\n\t\t\ttargetMap = new ResourceMap();\n\t\t\tthis._borrowableEditors.set(targetID, targetMap);\n\t\t}\n\t\tconst widgetsAtTarget = targetMap.get(input.resource) ?? [];\n\t\twidgetsAtTarget?.push(widget);\n\t\ttargetMap.set(input.resource, widgetsAtTarget);\n\t}\n\n\tretrieveExistingWidgetFromURI(resource: URI): IBorrowValue<NotebookEditorWidget> | undefined {\n\t\tfor (const widgetInfo of this._borrowableEditors.values()) {\n\t\t\tconst widgets = widgetInfo.get(resource);\n\t\t\tif (widgets && widgets.length > 0) {\n\t\t\t\treturn this._createBorrowValue(widgets[0].token!, widgets[0]);\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tretrieveAllExistingWidgets(): IBorrowValue<NotebookEditorWidget>[] {\n\t\tconst ret: IBorrowValue<NotebookEditorWidget>[] = [];\n\t\tfor (const widgetInfo of this._borrowableEditors.values()) {\n\t\t\tfor (const widgets of widgetInfo.values()) {\n\t\t\t\tfor (const widget of widgets) {\n\t\t\t\t\tret.push(this._createBorrowValue(widget.token!, widget));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn ret;\n\t}\n\n\tretrieveWidget(accessor: ServicesAccessor, groupId: number, input: { resource: URI; typeId: string }, creationOptions?: INotebookEditorCreationOptions, initialDimension?: Dimension, codeWindow?: CodeWindow): IBorrowValue<NotebookEditorWidget> {\n\n\t\tlet value = this._borrowableEditors.get(groupId)?.get(input.resource)?.find(widget => widget.editorType === input.typeId);\n\n\t\tif (!value) {\n\t\t\t// NEW widget\n\t\t\tconst editorGroupContextKeyService = accessor.get(IContextKeyService);\n\t\t\tconst editorGroupEditorProgressService = accessor.get(IEditorProgressService);\n\t\t\tconst widgetDisposeStore = new DisposableStore();\n\t\t\tconst widget = this.createWidget(editorGroupContextKeyService, widgetDisposeStore, editorGroupEditorProgressService, creationOptions, codeWindow, initialDimension);\n\t\t\tconst token = this._tokenPool++;\n\t\t\tvalue = { widget, editorType: input.typeId, token, disposableStore: widgetDisposeStore };\n\n\t\t\tlet map = this._borrowableEditors.get(groupId);\n\t\t\tif (!map) {\n\t\t\t\tmap = new ResourceMap();\n\t\t\t\tthis._borrowableEditors.set(groupId, map);\n\t\t\t}\n\t\t\tconst values = map.get(input.resource) ?? [];\n\t\t\tvalues.push(value);\n\t\t\tmap.set(input.resource, values);\n\t\t} else {\n\t\t\t// reuse a widget which was either free'ed before or which\n\t\t\t// is simply being reused...\n\t\t\tvalue.token = this._tokenPool++;\n\t\t}\n\n\t\treturn this._createBorrowValue(value.token!, value);\n\t}\n\n\t// protected for unit testing overrides\n\tprotected createWidget(editorGroupContextKeyService: IContextKeyService, widgetDisposeStore: DisposableStore, editorGroupEditorProgressService: IEditorProgressService, creationOptions?: INotebookEditorCreationOptions, codeWindow?: CodeWindow, initialDimension?: Dimension) {\n\t\tconst notebookInstantiationService = widgetDisposeStore.add(this.instantiationService.createChild(new ServiceCollection(\n\t\t\t[IContextKeyService, editorGroupContextKeyService],\n\t\t\t[IEditorProgressService, editorGroupEditorProgressService])));\n\t\tconst ctorOptions = creationOptions ?? getDefaultNotebookCreationOptions();\n\t\tconst widget = notebookInstantiationService.createInstance(NotebookEditorWidget, {\n\t\t\t...ctorOptions,\n\t\t\tcodeWindow: codeWindow ?? ctorOptions.codeWindow,\n\t\t}, initialDimension);\n\t\treturn widget;\n\t}\n\n\tprivate _createBorrowValue(myToken: number, widget: { widget: NotebookEditorWidget; token: number | undefined }): IBorrowValue<NotebookEditorWidget> {\n\t\treturn {\n\t\t\tget value() {\n\t\t\t\treturn widget.token === myToken ? widget.widget : undefined;\n\t\t\t}\n\t\t};\n\t}\n\n\t// --- editor management\n\n\taddNotebookEditor(editor: INotebookEditor): void {\n\t\tthis._notebookEditors.set(editor.getId(), editor);\n\t\tthis._onNotebookEditorAdd.fire(editor);\n\t}\n\n\tremoveNotebookEditor(editor: INotebookEditor): void {\n\t\tconst notebookUri = editor.getViewModel()?.notebookDocument.uri;\n\t\tif (this._notebookEditors.has(editor.getId())) {\n\t\t\tthis._notebookEditors.delete(editor.getId());\n\t\t\tthis._onNotebookEditorsRemove.fire(editor);\n\t\t}\n\t\tif (this._mostRecentRepl.get() === notebookUri?.toString()) {\n\t\t\tthis._mostRecentRepl.reset();\n\t\t}\n\t}\n\n\tgetNotebookEditor(editorId: string): INotebookEditor | undefined {\n\t\treturn this._notebookEditors.get(editorId);\n\t}\n\n\tlistNotebookEditors(): readonly INotebookEditor[] {\n\t\treturn [...this._notebookEditors].map(e => e[1]);\n\t}\n\n\tgetNotebookForPossibleCell(candidate: ICodeEditor): INotebookEditor | undefined {\n\t\tfor (const editor of this._notebookEditors.values()) {\n\t\t\tfor (const [, codeEditor] of editor.codeEditors) {\n\t\t\t\tif (codeEditor === candidate) {\n\t\t\t\t\treturn editor;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tupdateReplContextKey(uri: string): void {\n\t\tthis._mostRecentRepl.set(uri);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CodeWindow } from '../../../../../base/browser/window.js';\nimport { ResourceMap } from '../../../../../base/common/map.js';\nimport { getDefaultNotebookCreationOptions, NotebookEditorWidget } from '../notebookEditorWidget.js';\nimport { DisposableStore, IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { IEditorGroupsService, IEditorGroup } from '../../../../services/editor/common/editorGroupsService.js';\nimport { IInstantiationService, ServicesAccessor } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { isCompositeNotebookEditorInput, isNotebookEditorInput, NotebookEditorInput } from '../../common/notebookEditorInput.js';\nimport { IBorrowValue, INotebookEditorService } from './notebookEditorService.js';\nimport { INotebookEditor, INotebookEditorCreationOptions } from '../notebookBrowser.js';\nimport { Emitter } from '../../../../../base/common/event.js';\nimport { GroupIdentifier, GroupModelChangeKind } from '../../../../common/editor.js';\nimport { Dimension } from '../../../../../base/browser/dom.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { IEditorService } from '../../../../services/editor/common/editorService.js';\nimport { IContextKey, IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { InteractiveWindowOpen, MOST_RECENT_REPL_EDITOR } from '../../common/notebookContextKeys.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { IEditorProgressService } from '../../../../../platform/progress/common/progress.js';\nimport { NotebookDiffEditorInput } from '../../common/notebookDiffEditorInput.js';\nimport { ICodeEditor } from '../../../../../editor/browser/editorBrowser.js';\n\nexport class NotebookEditorWidgetService implements INotebookEditorService {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate _tokenPool = 1;\n\n\tprivate readonly _disposables = new DisposableStore();\n\tprivate readonly _notebookEditors = new Map<string, INotebookEditor>();\n\n\tprivate readonly groupListener = new Map<number, IDisposable[]>();\n\n\tprivate readonly _onNotebookEditorAdd = new Emitter<INotebookEditor>();\n\tprivate readonly _onNotebookEditorsRemove = new Emitter<INotebookEditor>();\n\treadonly onDidAddNotebookEditor = this._onNotebookEditorAdd.event;\n\treadonly onDidRemoveNotebookEditor = this._onNotebookEditorsRemove.event;\n\n\tprivate readonly _mostRecentRepl: IContextKey<string | undefined>;\n\n\tprivate readonly _borrowableEditors = new Map<number, ResourceMap<{ widget: NotebookEditorWidget; editorType: string; token: number | undefined; disposableStore: DisposableStore }[]>>();\n\n\tconstructor(\n\t\t@IEditorGroupsService private readonly editorGroupService: IEditorGroupsService,\n\t\t@IEditorService editorService: IEditorService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tconst onNewGroup = (group: IEditorGroup) => {\n\t\t\tconst { id } = group;\n\t\t\tconst listeners: IDisposable[] = [];\n\t\t\tlisteners.push(group.onDidCloseEditor(e => {\n\t\t\t\tconst widgetMap = this._borrowableEditors.get(group.id);\n\t\t\t\tif (!widgetMap) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst inputs = e.editor instanceof NotebookEditorInput || e.editor instanceof NotebookDiffEditorInput\n\t\t\t\t\t? [e.editor]\n\t\t\t\t\t: (isCompositeNotebookEditorInput(e.editor) ? e.editor.editorInputs : []);\n\t\t\t\tinputs.forEach(input => {\n\t\t\t\t\tconst widgets = widgetMap.get(input.resource);\n\t\t\t\t\tconst index = widgets?.findIndex(widget => widget.editorType === input.typeId);\n\t\t\t\t\tif (!widgets || index === undefined || index === -1) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst value = widgets.splice(index, 1)[0];\n\t\t\t\t\tvalue.token = undefined;\n\t\t\t\t\tthis._disposeWidget(value.widget);\n\t\t\t\t\tvalue.disposableStore.dispose();\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\tvalue.widget = (<any>undefined); // unset the widget so that others that still hold a reference don't harm us\n\t\t\t\t});\n\t\t\t}));\n\t\t\tlisteners.push(group.onWillMoveEditor(e => {\n\t\t\t\tif (isNotebookEditorInput(e.editor)) {\n\t\t\t\t\tthis._allowWidgetMove(e.editor, e.groupId, e.target);\n\t\t\t\t}\n\n\t\t\t\tif (isCompositeNotebookEditorInput(e.editor)) {\n\t\t\t\t\te.editor.editorInputs.forEach(input => {\n\t\t\t\t\t\tthis._allowWidgetMove(input, e.groupId, e.target);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}));\n\t\t\tthis.groupListener.set(id, listeners);\n\t\t};\n\t\tthis._disposables.add(editorGroupService.onDidAddGroup(onNewGroup));\n\t\teditorGroupService.whenReady.then(() => editorGroupService.groups.forEach(onNewGroup));\n\n\t\t// group removed -> clean up listeners, clean up widgets\n\t\tthis._disposables.add(editorGroupService.onDidRemoveGroup(group => {\n\t\t\tconst listeners = this.groupListener.get(group.id);\n\t\t\tif (listeners) {\n\t\t\t\tlisteners.forEach(listener => listener.dispose());\n\t\t\t\tthis.groupListener.delete(group.id);\n\t\t\t}\n\t\t\tconst widgets = this._borrowableEditors.get(group.id);\n\t\t\tthis._borrowableEditors.delete(group.id);\n\t\t\tif (widgets) {\n\t\t\t\tfor (const values of widgets.values()) {\n\t\t\t\t\tfor (const value of values) {\n\t\t\t\t\t\tvalue.token = undefined;\n\t\t\t\t\t\tthis._disposeWidget(value.widget);\n\t\t\t\t\t\tvalue.disposableStore.dispose();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._mostRecentRepl = MOST_RECENT_REPL_EDITOR.bindTo(contextKeyService);\n\t\tconst interactiveWindowOpen = InteractiveWindowOpen.bindTo(contextKeyService);\n\t\tthis._disposables.add(editorService.onDidEditorsChange(e => {\n\t\t\tif (e.event.kind === GroupModelChangeKind.EDITOR_OPEN && !interactiveWindowOpen.get()) {\n\t\t\t\tif (editorService.editors.find(editor => isCompositeNotebookEditorInput(editor))) {\n\t\t\t\t\tinteractiveWindowOpen.set(true);\n\t\t\t\t}\n\t\t\t} else if (e.event.kind === GroupModelChangeKind.EDITOR_CLOSE && interactiveWindowOpen.get()) {\n\t\t\t\tif (!editorService.editors.find(editor => isCompositeNotebookEditorInput(editor))) {\n\t\t\t\t\tinteractiveWindowOpen.set(false);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tdispose() {\n\t\tthis._disposables.dispose();\n\t\tthis._onNotebookEditorAdd.dispose();\n\t\tthis._onNotebookEditorsRemove.dispose();\n\t\tthis.groupListener.forEach((listeners) => {\n\t\t\tlisteners.forEach(listener => listener.dispose());\n\t\t});\n\t\tthis.groupListener.clear();\n\t\tthis._borrowableEditors.forEach(widgetMap => {\n\t\t\twidgetMap.forEach(widgets => {\n\t\t\t\twidgets.forEach(widget => widget.disposableStore.dispose());\n\t\t\t});\n\t\t});\n\t}\n\n\t// --- group-based editor borrowing...\n\n\tprivate _disposeWidget(widget: NotebookEditorWidget): void {\n\t\twidget.onWillHide();\n\t\tconst domNode = widget.getDomNode();\n\t\twidget.dispose();\n\t\tdomNode.remove();\n\t}\n\n\tprivate _allowWidgetMove(input: NotebookEditorInput, sourceID: GroupIdentifier, targetID: GroupIdentifier): void {\n\t\tconst sourcePart = this.editorGroupService.getPart(sourceID);\n\t\tconst targetPart = this.editorGroupService.getPart(targetID);\n\n\t\tif (sourcePart.windowId !== targetPart.windowId) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst target = this._borrowableEditors.get(targetID)?.get(input.resource)?.findIndex(widget => widget.editorType === input.typeId);\n\t\tif (target !== undefined && target !== -1) {\n\t\t\t// not needed, a separate widget is already there\n\t\t\treturn;\n\t\t}\n\n\t\tconst widget = this._borrowableEditors.get(sourceID)?.get(input.resource)?.find(widget => widget.editorType === input.typeId);\n\t\tif (!widget) {\n\t\t\tthrow new Error('no widget at source group');\n\t\t}\n\n\t\t// don't allow the widget to be retrieved at its previous location any more\n\t\tconst sourceWidgets = this._borrowableEditors.get(sourceID)?.get(input.resource);\n\t\tif (sourceWidgets) {\n\t\t\tconst indexToRemove = sourceWidgets.findIndex(widget => widget.editorType === input.typeId);\n\t\t\tif (indexToRemove !== -1) {\n\t\t\t\tsourceWidgets.splice(indexToRemove, 1);\n\t\t\t}\n\t\t}\n\n\t\t// allow the widget to be retrieved at its new location\n\t\tlet targetMap = this._borrowableEditors.get(targetID);\n\t\tif (!targetMap) {\n\t\t\ttargetMap = new ResourceMap();\n\t\t\tthis._borrowableEditors.set(targetID, targetMap);\n\t\t}\n\t\tconst widgetsAtTarget = targetMap.get(input.resource) ?? [];\n\t\twidgetsAtTarget?.push(widget);\n\t\ttargetMap.set(input.resource, widgetsAtTarget);\n\t}\n\n\tretrieveExistingWidgetFromURI(resource: URI): IBorrowValue<NotebookEditorWidget> | undefined {\n\t\tfor (const widgetInfo of this._borrowableEditors.values()) {\n\t\t\tconst widgets = widgetInfo.get(resource);\n\t\t\tif (widgets && widgets.length > 0) {\n\t\t\t\treturn this._createBorrowValue(widgets[0].token!, widgets[0]);\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tretrieveAllExistingWidgets(): IBorrowValue<NotebookEditorWidget>[] {\n\t\tconst ret: IBorrowValue<NotebookEditorWidget>[] = [];\n\t\tfor (const widgetInfo of this._borrowableEditors.values()) {\n\t\t\tfor (const widgets of widgetInfo.values()) {\n\t\t\t\tfor (const widget of widgets) {\n\t\t\t\t\tret.push(this._createBorrowValue(widget.token!, widget));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn ret;\n\t}\n\n\tretrieveWidget(accessor: ServicesAccessor, groupId: number, input: { resource: URI; typeId: string }, creationOptions?: INotebookEditorCreationOptions, initialDimension?: Dimension, codeWindow?: CodeWindow): IBorrowValue<NotebookEditorWidget> {\n\n\t\tlet value = this._borrowableEditors.get(groupId)?.get(input.resource)?.find(widget => widget.editorType === input.typeId);\n\n\t\tif (!value) {\n\t\t\t// NEW widget\n\t\t\tconst editorGroupContextKeyService = accessor.get(IContextKeyService);\n\t\t\tconst editorGroupEditorProgressService = accessor.get(IEditorProgressService);\n\t\t\tconst widgetDisposeStore = new DisposableStore();\n\t\t\tconst widget = this.createWidget(editorGroupContextKeyService, widgetDisposeStore, editorGroupEditorProgressService, creationOptions, codeWindow, initialDimension);\n\t\t\tconst token = this._tokenPool++;\n\t\t\tvalue = { widget, editorType: input.typeId, token, disposableStore: widgetDisposeStore };\n\n\t\t\tlet map = this._borrowableEditors.get(groupId);\n\t\t\tif (!map) {\n\t\t\t\tmap = new ResourceMap();\n\t\t\t\tthis._borrowableEditors.set(groupId, map);\n\t\t\t}\n\t\t\tconst values = map.get(input.resource) ?? [];\n\t\t\tvalues.push(value);\n\t\t\tmap.set(input.resource, values);\n\t\t} else {\n\t\t\t// reuse a widget which was either free'ed before or which\n\t\t\t// is simply being reused...\n\t\t\tvalue.token = this._tokenPool++;\n\t\t}\n\n\t\treturn this._createBorrowValue(value.token!, value);\n\t}\n\n\t// protected for unit testing overrides\n\tprotected createWidget(editorGroupContextKeyService: IContextKeyService, widgetDisposeStore: DisposableStore, editorGroupEditorProgressService: IEditorProgressService, creationOptions?: INotebookEditorCreationOptions, codeWindow?: CodeWindow, initialDimension?: Dimension) {\n\t\tconst notebookInstantiationService = widgetDisposeStore.add(this.instantiationService.createChild(new ServiceCollection(\n\t\t\t[IContextKeyService, editorGroupContextKeyService],\n\t\t\t[IEditorProgressService, editorGroupEditorProgressService])));\n\t\tconst ctorOptions = creationOptions ?? getDefaultNotebookCreationOptions();\n\t\tconst widget = notebookInstantiationService.createInstance(NotebookEditorWidget, {\n\t\t\t...ctorOptions,\n\t\t\tcodeWindow: codeWindow ?? ctorOptions.codeWindow,\n\t\t}, initialDimension);\n\t\treturn widget;\n\t}\n\n\tprivate _createBorrowValue(myToken: number, widget: { widget: NotebookEditorWidget; token: number | undefined }): IBorrowValue<NotebookEditorWidget> {\n\t\treturn {\n\t\t\tget value() {\n\t\t\t\treturn widget.token === myToken ? widget.widget : undefined;\n\t\t\t}\n\t\t};\n\t}\n\n\t// --- editor management\n\n\taddNotebookEditor(editor: INotebookEditor): void {\n\t\tthis._notebookEditors.set(editor.getId(), editor);\n\t\tthis._onNotebookEditorAdd.fire(editor);\n\t}\n\n\tremoveNotebookEditor(editor: INotebookEditor): void {\n\t\tconst notebookUri = editor.getViewModel()?.notebookDocument.uri;\n\t\tif (this._notebookEditors.has(editor.getId())) {\n\t\t\tthis._notebookEditors.delete(editor.getId());\n\t\t\tthis._onNotebookEditorsRemove.fire(editor);\n\t\t}\n\t\tif (this._mostRecentRepl.get() === notebookUri?.toString()) {\n\t\t\tthis._mostRecentRepl.reset();\n\t\t}\n\t}\n\n\tgetNotebookEditor(editorId: string): INotebookEditor | undefined {\n\t\treturn this._notebookEditors.get(editorId);\n\t}\n\n\tlistNotebookEditors(): readonly INotebookEditor[] {\n\t\treturn [...this._notebookEditors].map(e => e[1]);\n\t}\n\n\tgetNotebookForPossibleCell(candidate: ICodeEditor): INotebookEditor | undefined {\n\t\tfor (const editor of this._notebookEditors.values()) {\n\t\t\tfor (const [, codeEditor] of editor.codeEditors) {\n\t\t\t\tif (codeEditor === candidate) {\n\t\t\t\t\treturn editor;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tupdateReplContextKey(uri: string): void {\n\t\tthis._mostRecentRepl.set(uri);\n\t}\n}\n"]}