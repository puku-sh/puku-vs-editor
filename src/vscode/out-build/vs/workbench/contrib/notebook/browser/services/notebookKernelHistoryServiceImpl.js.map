{"version":3,"sources":["vs/workbench/contrib/notebook/browser/services/notebookKernelHistoryServiceImpl.ts"],"names":[],"mappings":"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","file":"notebookKernelHistoryServiceImpl.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { LinkedMap, Touch } from '../../../../../base/common/map.js';\nimport { localize2 } from '../../../../../nls.js';\nimport { Categories } from '../../../../../platform/action/common/actionCommonCategories.js';\nimport { Action2, registerAction2 } from '../../../../../platform/actions/common/actions.js';\nimport { ServicesAccessor } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../platform/storage/common/storage.js';\nimport { INotebookKernel, INotebookKernelHistoryService, INotebookKernelService, INotebookTextModelLike } from '../../common/notebookKernelService.js';\nimport { INotebookLoggingService } from '../../common/notebookLoggingService.js';\n\ninterface ISerializedKernelsListPerType {\n\tentries: string[];\n}\n\ninterface ISerializedKernelsList {\n\t[viewType: string]: ISerializedKernelsListPerType;\n}\n\nconst MAX_KERNELS_IN_HISTORY = 5;\n\nexport class NotebookKernelHistoryService extends Disposable implements INotebookKernelHistoryService {\n\tdeclare _serviceBrand: undefined;\n\n\tprivate static STORAGE_KEY = 'notebook.kernelHistory';\n\tprivate _mostRecentKernelsMap: { [key: string]: LinkedMap<string, string> } = {};\n\n\tconstructor(@IStorageService private readonly _storageService: IStorageService,\n\t\t@INotebookKernelService private readonly _notebookKernelService: INotebookKernelService,\n\t\t@INotebookLoggingService private readonly _notebookLoggingService: INotebookLoggingService) {\n\t\tsuper();\n\n\t\tthis._loadState();\n\t\tthis._register(this._storageService.onWillSaveState(() => this._saveState()));\n\t\tthis._register(this._storageService.onDidChangeValue(StorageScope.WORKSPACE, NotebookKernelHistoryService.STORAGE_KEY, this._store)(() => {\n\t\t\tthis._loadState();\n\t\t}));\n\t}\n\n\tgetKernels(notebook: INotebookTextModelLike): { selected: INotebookKernel | undefined; all: INotebookKernel[] } {\n\t\tconst allAvailableKernels = this._notebookKernelService.getMatchingKernel(notebook);\n\t\tconst allKernels = allAvailableKernels.all;\n\t\tconst selectedKernel = allAvailableKernels.selected;\n\t\t// We will suggest the only kernel\n\t\tconst suggested = allAvailableKernels.all.length === 1 ? allAvailableKernels.all[0] : undefined;\n\t\tthis._notebookLoggingService.debug('History', `getMatchingKernels: ${allAvailableKernels.all.length} kernels available for ${notebook.uri.path}. Selected: ${allAvailableKernels.selected?.label}. Suggested: ${suggested?.label}`);\n\t\tconst mostRecentKernelIds = this._mostRecentKernelsMap[notebook.notebookType] ? [...this._mostRecentKernelsMap[notebook.notebookType].values()] : [];\n\t\tconst all = mostRecentKernelIds.map(kernelId => allKernels.find(kernel => kernel.id === kernelId)).filter(kernel => !!kernel) as INotebookKernel[];\n\t\tthis._notebookLoggingService.debug('History', `mru: ${mostRecentKernelIds.length} kernels in history, ${all.length} registered already.`);\n\n\t\treturn {\n\t\t\tselected: selectedKernel ?? suggested,\n\t\t\tall\n\t\t};\n\t}\n\n\taddMostRecentKernel(kernel: INotebookKernel): void {\n\t\tconst key = kernel.id;\n\t\tconst viewType = kernel.viewType;\n\t\tconst recentKeynels = this._mostRecentKernelsMap[viewType] ?? new LinkedMap<string, string>();\n\n\t\trecentKeynels.set(key, key, Touch.AsOld);\n\n\n\t\tif (recentKeynels.size > MAX_KERNELS_IN_HISTORY) {\n\t\t\tconst reserved = [...recentKeynels.entries()].slice(0, MAX_KERNELS_IN_HISTORY);\n\t\t\trecentKeynels.fromJSON(reserved);\n\t\t}\n\n\t\tthis._mostRecentKernelsMap[viewType] = recentKeynels;\n\t}\n\n\tprivate _saveState(): void {\n\t\tlet notEmpty = false;\n\t\tfor (const [_, kernels] of Object.entries(this._mostRecentKernelsMap)) {\n\t\t\tnotEmpty = notEmpty || kernels.size > 0;\n\t\t}\n\n\t\tif (notEmpty) {\n\t\t\tconst serialized = this._serialize();\n\t\t\tthis._storageService.store(NotebookKernelHistoryService.STORAGE_KEY, JSON.stringify(serialized), StorageScope.WORKSPACE, StorageTarget.USER);\n\t\t} else {\n\t\t\tthis._storageService.remove(NotebookKernelHistoryService.STORAGE_KEY, StorageScope.WORKSPACE);\n\t\t}\n\t}\n\n\tprivate _loadState(): void {\n\t\tconst serialized = this._storageService.get(NotebookKernelHistoryService.STORAGE_KEY, StorageScope.WORKSPACE);\n\t\tif (serialized) {\n\t\t\ttry {\n\t\t\t\tthis._deserialize(JSON.parse(serialized));\n\t\t\t} catch (e) {\n\t\t\t\tthis._mostRecentKernelsMap = {};\n\t\t\t}\n\t\t} else {\n\t\t\tthis._mostRecentKernelsMap = {};\n\t\t}\n\t}\n\n\tprivate _serialize(): ISerializedKernelsList {\n\t\tconst result: ISerializedKernelsList = Object.create(null);\n\n\t\tfor (const [viewType, kernels] of Object.entries(this._mostRecentKernelsMap)) {\n\t\t\tresult[viewType] = {\n\t\t\t\tentries: [...kernels.values()]\n\t\t\t};\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate _deserialize(serialized: ISerializedKernelsList): void {\n\t\tthis._mostRecentKernelsMap = {};\n\n\t\tfor (const [viewType, kernels] of Object.entries(serialized)) {\n\t\t\tconst linkedMap = new LinkedMap<string, string>();\n\t\t\tconst mapValues: [string, string][] = [];\n\n\t\t\tfor (const entry of kernels.entries) {\n\t\t\t\tmapValues.push([entry, entry]);\n\t\t\t}\n\n\t\t\tlinkedMap.fromJSON(mapValues);\n\t\t\tthis._mostRecentKernelsMap[viewType] = linkedMap;\n\t\t}\n\t}\n\n\t_clear(): void {\n\t\tthis._mostRecentKernelsMap = {};\n\t\tthis._saveState();\n\t}\n}\n\nregisterAction2(class extends Action2 {\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: 'notebook.clearNotebookKernelsMRUCache',\n\t\t\ttitle: localize2('workbench.notebook.clearNotebookKernelsMRUCache', \"Clear Notebook Kernels MRU Cache\"),\n\t\t\tcategory: Categories.Developer,\n\t\t\tf1: true\n\t\t});\n\t}\n\n\tasync run(accessor: ServicesAccessor): Promise<void> {\n\t\tconst historyService = accessor.get(INotebookKernelHistoryService) as NotebookKernelHistoryService;\n\t\thistoryService._clear();\n\t}\n});\n"]}