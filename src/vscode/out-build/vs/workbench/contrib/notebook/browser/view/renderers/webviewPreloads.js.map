{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/browser/view/renderers/webviewPreloads.ts","vs/workbench/contrib/notebook/browser/view/renderers/webviewPreloads.ts"],"names":[],"mappings":"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","file":"webviewPreloads.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { Event } from '../../../../../../base/common/event.js';\nimport type { IDisposable } from '../../../../../../base/common/lifecycle.js';\nimport type * as webviewMessages from './webviewMessages.js';\nimport type { NotebookCellMetadata } from '../../../common/notebookCommon.js';\nimport type * as rendererApi from 'vscode-notebook-renderer';\nimport type { NotebookCellOutputTransferData } from '../../../../../../platform/dnd/browser/dnd.js';\n\n// !! IMPORTANT !! ----------------------------------------------------------------------------------\n// import { RenderOutputType } from 'vs/workbench/contrib/notebook/browser/notebookBrowser';\n// We can ONLY IMPORT as type in this module. This also applies to const enums that would evaporate\n// in normal compiles but remain a dependency in transpile-only compiles\n// !! IMPORTANT !! ----------------------------------------------------------------------------------\n\n// !! IMPORTANT !! everything must be in-line within the webviewPreloads\n// function. Imports are not allowed. This is stringified and injected into\n// the webview.\n\ndeclare module globalThis {\n\tconst acquireVsCodeApi: () => ({\n\t\tgetState(): { [key: string]: unknown };\n\t\tsetState(data: { [key: string]: unknown }): void;\n\t\tpostMessage: (msg: unknown) => void;\n\t});\n}\n\ndeclare class ResizeObserver {\n\tconstructor(onChange: (entries: { target: HTMLElement; contentRect?: ClientRect }[]) => void);\n\tobserve(element: Element): void;\n\tdisconnect(): void;\n}\n\ndeclare class Highlight {\n\tconstructor();\n\tadd(range: AbstractRange): void;\n\tclear(): void;\n\tpriority: number;\n}\n\ninterface CSSHighlights {\n\tset(rule: string, highlight: Highlight): void;\n}\ndeclare namespace CSS {\n\tlet highlights: CSSHighlights | undefined;\n}\n\n\ntype Listener<T> = { fn: (evt: T) => void; thisArg: unknown };\n\ninterface EmitterLike<T> {\n\tfire(data: T): void;\n\treadonly event: Event<T>;\n}\n\ninterface PreloadStyles {\n\treadonly outputNodePadding: number;\n\treadonly outputNodeLeftPadding: number;\n\treadonly tokenizationCss: string;\n}\n\nexport interface PreloadOptions {\n\tdragAndDropEnabled: boolean;\n}\n\nexport interface RenderOptions {\n\treadonly lineLimit: number;\n\treadonly outputScrolling: boolean;\n\treadonly outputWordWrap: boolean;\n\treadonly linkifyFilePaths: boolean;\n\treadonly minimalError: boolean;\n}\n\ninterface PreloadContext {\n\treadonly nonce: string;\n\treadonly style: PreloadStyles;\n\treadonly options: PreloadOptions;\n\treadonly renderOptions: RenderOptions;\n\treadonly rendererData: readonly webviewMessages.RendererMetadata[];\n\treadonly staticPreloadsData: readonly webviewMessages.StaticPreloadMetadata[];\n\treadonly isWorkspaceTrusted: boolean;\n}\n\ndeclare function requestIdleCallback(callback: (args: IdleDeadline) => void, options?: { timeout: number }): number;\ndeclare function cancelIdleCallback(handle: number): void;\n\ndeclare function __import(path: string): Promise<any>;\n\nasync function webviewPreloads(ctx: PreloadContext) {\n\n\t/* eslint-disable no-restricted-globals, no-restricted-syntax */\n\n\t// The use of global `window` should be fine in this context, even\n\t// with aux windows. This code is running from within an `iframe`\n\t// where there is only one `window` object anyway.\n\n\tconst userAgent = navigator.userAgent;\n\tconst isChrome = (userAgent.indexOf('Chrome') >= 0);\n\tconst textEncoder = new TextEncoder();\n\tconst textDecoder = new TextDecoder();\n\n\tfunction promiseWithResolvers<T>(): { promise: Promise<T>; resolve: (value: T | PromiseLike<T>) => void; reject: (err?: any) => void } {\n\t\tlet resolve: (value: T | PromiseLike<T>) => void;\n\t\tlet reject: (reason?: any) => void;\n\t\tconst promise = new Promise<T>((res, rej) => {\n\t\t\tresolve = res;\n\t\t\treject = rej;\n\t\t});\n\t\treturn { promise, resolve: resolve!, reject: reject! };\n\t}\n\n\tlet currentOptions = ctx.options;\n\tconst isWorkspaceTrusted = ctx.isWorkspaceTrusted;\n\tlet currentRenderOptions = ctx.renderOptions;\n\tconst settingChange: EmitterLike<RenderOptions> = createEmitter<RenderOptions>();\n\n\tconst acquireVsCodeApi = globalThis.acquireVsCodeApi;\n\tconst vscode = acquireVsCodeApi();\n\tdelete (globalThis as { acquireVsCodeApi: unknown }).acquireVsCodeApi;\n\n\tconst tokenizationStyle = new CSSStyleSheet();\n\ttokenizationStyle.replaceSync(ctx.style.tokenizationCss);\n\n\tconst runWhenIdle: (callback: (idle: IdleDeadline) => void, timeout?: number) => IDisposable = (typeof requestIdleCallback !== 'function' || typeof cancelIdleCallback !== 'function')\n\t\t? (runner) => {\n\t\t\tsetTimeout(() => {\n\t\t\t\tif (disposed) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst end = Date.now() + 15; // one frame at 64fps\n\t\t\t\trunner(Object.freeze({\n\t\t\t\t\tdidTimeout: true,\n\t\t\t\t\ttimeRemaining() {\n\t\t\t\t\t\treturn Math.max(0, end - Date.now());\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t});\n\t\t\tlet disposed = false;\n\t\t\treturn {\n\t\t\t\tdispose() {\n\t\t\t\t\tif (disposed) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tdisposed = true;\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\t: (runner, timeout?) => {\n\t\t\tconst handle: number = requestIdleCallback(runner, typeof timeout === 'number' ? { timeout } : undefined);\n\t\t\tlet disposed = false;\n\t\t\treturn {\n\t\t\t\tdispose() {\n\t\t\t\t\tif (disposed) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tdisposed = true;\n\t\t\t\t\tcancelIdleCallback(handle);\n\t\t\t\t}\n\t\t\t};\n\t\t};\n\tfunction getOutputContainer(event: FocusEvent | MouseEvent) {\n\t\tfor (const node of event.composedPath()) {\n\t\t\tif (node instanceof HTMLElement && node.classList.contains('output')) {\n\t\t\t\treturn {\n\t\t\t\t\tid: node.id\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\tlet lastFocusedOutput: { id: string } | undefined = undefined;\n\tconst handleOutputFocusOut = (event: FocusEvent) => {\n\t\tconst outputFocus = event && getOutputContainer(event);\n\t\tif (!outputFocus) {\n\t\t\treturn;\n\t\t}\n\t\t// Possible we're tabbing through the elements of the same output.\n\t\t// Lets see if focus is set back to the same output.\n\t\tlastFocusedOutput = undefined;\n\t\tsetTimeout(() => {\n\t\t\tif (lastFocusedOutput?.id === outputFocus.id) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpostNotebookMessage<webviewMessages.IOutputBlurMessage>('outputBlur', outputFocus);\n\t\t}, 0);\n\t};\n\n\tconst hasActiveEditableElement = (\n\t\tparent: Node | DocumentFragment,\n\t\troot: ShadowRoot | Document = document\n\t): boolean => {\n\t\tconst element = root.activeElement;\n\t\treturn !!(element && parent.contains(element)\n\t\t\t&& (element.matches(':read-write') || element.tagName.toLowerCase() === 'select'\n\t\t\t\t|| (element.shadowRoot && hasActiveEditableElement(element.shadowRoot, element.shadowRoot)))\n\t\t);\n\t};\n\n\t// check if an input element is focused within the output element\n\tconst checkOutputInputFocus = (e: FocusEvent) => {\n\t\tlastFocusedOutput = getOutputContainer(e);\n\t\tconst activeElement = window.document.activeElement;\n\t\tif (!activeElement) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst id = lastFocusedOutput?.id;\n\t\tif (id && (hasActiveEditableElement(activeElement, window.document))) {\n\t\t\tpostNotebookMessage<webviewMessages.IOutputInputFocusMessage>('outputInputFocus', { inputFocused: true, id });\n\n\t\t\tactiveElement.addEventListener('blur', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IOutputInputFocusMessage>('outputInputFocus', { inputFocused: false, id });\n\t\t\t}, { once: true });\n\t\t}\n\t};\n\n\tconst handleInnerClick = (event: MouseEvent) => {\n\t\tif (!event || !event.view || !event.view.document) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst outputFocus = lastFocusedOutput = getOutputContainer(event);\n\t\tfor (const node of event.composedPath()) {\n\t\t\tif (node instanceof HTMLAnchorElement && node.href) {\n\t\t\t\tif (node.href.startsWith('blob:')) {\n\t\t\t\t\tif (outputFocus) {\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', outputFocus);\n\t\t\t\t\t}\n\n\t\t\t\t\thandleBlobUrlClick(node.href, node.download);\n\t\t\t\t} else if (node.href.startsWith('data:')) {\n\t\t\t\t\tif (outputFocus) {\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', outputFocus);\n\t\t\t\t\t}\n\t\t\t\t\thandleDataUrl(node.href, node.download);\n\t\t\t\t} else if (node.getAttribute('href')?.trim().startsWith('#')) {\n\t\t\t\t\t// Scrolling to location within current doc\n\n\t\t\t\t\tif (!node.hash) {\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IScrollToRevealMessage>('scroll-to-reveal', { scrollTop: 0 });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst targetId = node.hash.substring(1);\n\n\t\t\t\t\t// Check outer document first\n\t\t\t\t\tlet scrollTarget: Element | null | undefined = event.view.document.getElementById(targetId);\n\n\t\t\t\t\tif (!scrollTarget) {\n\t\t\t\t\t\t// Fallback to checking preview shadow doms\n\t\t\t\t\t\tfor (const preview of event.view.document.querySelectorAll('.preview')) {\n\t\t\t\t\t\t\tscrollTarget = preview.shadowRoot?.getElementById(targetId);\n\t\t\t\t\t\t\tif (scrollTarget) {\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (scrollTarget) {\n\t\t\t\t\t\tconst scrollTop = scrollTarget.getBoundingClientRect().top + event.view.scrollY;\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IScrollToRevealMessage>('scroll-to-reveal', { scrollTop });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconst href = node.getAttribute('href');\n\t\t\t\t\tif (href) {\n\t\t\t\t\t\tif (href.startsWith('command:') && outputFocus) {\n\t\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', outputFocus);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IClickedLinkMessage>('clicked-link', { href });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tevent.preventDefault();\n\t\t\t\tevent.stopPropagation();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (outputFocus) {\n\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', outputFocus);\n\t\t}\n\t};\n\n\tconst blurOutput = () => {\n\t\tconst selection = window.getSelection();\n\t\tif (!selection) {\n\t\t\treturn;\n\t\t}\n\t\tselection.removeAllRanges();\n\t};\n\n\tconst selectOutputContents = (cellOrOutputId: string) => {\n\t\tconst selection = window.getSelection();\n\t\tif (!selection) {\n\t\t\treturn;\n\t\t}\n\t\tconst cellOutputContainer = window.document.getElementById(cellOrOutputId);\n\t\tif (!cellOutputContainer) {\n\t\t\treturn;\n\t\t}\n\t\tselection.removeAllRanges();\n\t\tconst range = document.createRange();\n\t\trange.selectNode(cellOutputContainer);\n\t\tselection.addRange(range);\n\n\t};\n\n\tconst selectInputContents = (cellOrOutputId: string) => {\n\t\tconst cellOutputContainer = window.document.getElementById(cellOrOutputId);\n\t\tif (!cellOutputContainer) {\n\t\t\treturn;\n\t\t}\n\t\tconst activeElement = window.document.activeElement;\n\t\tif (activeElement && hasActiveEditableElement(activeElement, window.document)) {\n\t\t\t(activeElement as HTMLInputElement).select();\n\t\t}\n\t};\n\n\tconst onPageUpDownSelectionHandler = (e: KeyboardEvent) => {\n\t\tif (!lastFocusedOutput?.id || !e.shiftKey) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If we're pressing `Shift+Up/Down` then we want to select a line at a time.\n\t\tif (e.shiftKey && (e.code === 'ArrowUp' || e.code === 'ArrowDown')) {\n\t\t\te.stopPropagation(); // We don't want the notebook to handle this, default behavior is what we need.\n\t\t\treturn;\n\t\t}\n\n\t\t// We want to handle just `Shift + PageUp/PageDown` & `Shift + Cmd + ArrowUp/ArrowDown` (for mac)\n\t\tif (!(e.code === 'PageUp' || e.code === 'PageDown') && !(e.metaKey && (e.code === 'ArrowDown' || e.code === 'ArrowUp'))) {\n\t\t\treturn;\n\t\t}\n\t\tconst outputContainer = window.document.getElementById(lastFocusedOutput.id);\n\t\tconst selection = window.getSelection();\n\t\tif (!outputContainer || !selection?.anchorNode) {\n\t\t\treturn;\n\t\t}\n\t\tconst activeElement = window.document.activeElement;\n\t\tif (activeElement && hasActiveEditableElement(activeElement, window.document)) {\n\t\t\t// Leave for default behavior.\n\t\t\treturn;\n\t\t}\n\n\t\t// These should change the scroll position, not adjust the selected cell in the notebook\n\t\te.stopPropagation(); // We don't want the notebook to handle this.\n\t\te.preventDefault(); // We will handle selection.\n\n\t\tconst { anchorNode, anchorOffset } = selection;\n\t\tconst range = document.createRange();\n\t\tif (e.code === 'PageDown' || e.code === 'ArrowDown') {\n\t\t\trange.setStart(anchorNode, anchorOffset);\n\t\t\trange.setEnd(outputContainer, 1);\n\t\t}\n\t\telse {\n\t\t\trange.setStart(outputContainer, 0);\n\t\t\trange.setEnd(anchorNode, anchorOffset);\n\t\t}\n\t\tselection.removeAllRanges();\n\t\tselection.addRange(range);\n\t};\n\n\tconst disableNativeSelectAll = (e: KeyboardEvent) => {\n\t\tif (!lastFocusedOutput?.id) {\n\t\t\treturn;\n\t\t}\n\t\tconst activeElement = window.document.activeElement;\n\t\tif (activeElement && hasActiveEditableElement(activeElement, window.document)) {\n\t\t\t// The input element will handle this.\n\t\t\treturn;\n\t\t}\n\n\t\tif ((e.key === 'a' && e.ctrlKey) || (e.metaKey && e.key === 'a')) {\n\t\t\te.preventDefault(); // We will handle selection in editor code.\n\t\t\treturn;\n\t\t}\n\t};\n\n\tconst handleDataUrl = async (data: string | ArrayBuffer | null, downloadName: string) => {\n\t\tpostNotebookMessage<webviewMessages.IClickedDataUrlMessage>('clicked-data-url', {\n\t\t\tdata,\n\t\t\tdownloadName\n\t\t});\n\t};\n\n\tconst handleBlobUrlClick = async (url: string, downloadName: string) => {\n\t\ttry {\n\t\t\tconst response = await fetch(url);\n\t\t\tconst blob = await response.blob();\n\t\t\tconst reader = new FileReader();\n\t\t\treader.addEventListener('load', () => {\n\t\t\t\thandleDataUrl(reader.result, downloadName);\n\t\t\t});\n\t\t\treader.readAsDataURL(blob);\n\t\t} catch (e) {\n\t\t\tconsole.error(e.message);\n\t\t}\n\t};\n\n\twindow.document.body.addEventListener('click', handleInnerClick);\n\twindow.document.body.addEventListener('focusin', checkOutputInputFocus);\n\twindow.document.body.addEventListener('focusout', handleOutputFocusOut);\n\twindow.document.body.addEventListener('keydown', onPageUpDownSelectionHandler);\n\twindow.document.body.addEventListener('keydown', disableNativeSelectAll);\n\n\tinterface RendererContext extends rendererApi.RendererContext<unknown> {\n\t\treadonly onDidChangeSettings: Event<RenderOptions>;\n\t\treadonly settings: RenderOptions;\n\t}\n\n\tinterface RendererModule {\n\t\treadonly activate: rendererApi.ActivationFunction;\n\t}\n\n\tinterface KernelPreloadContext {\n\t\treadonly onDidReceiveKernelMessage: Event<unknown>;\n\t\tpostKernelMessage(data: unknown): void;\n\t}\n\n\tinterface KernelPreloadModule {\n\t\tactivate(ctx: KernelPreloadContext): Promise<void> | void;\n\t}\n\n\tinterface IObservedElement {\n\t\tid: string;\n\t\toutput: boolean;\n\t\tlastKnownPadding: number;\n\t\tlastKnownHeight: number;\n\t\tcellId: string;\n\t}\n\n\tfunction createKernelContext(): KernelPreloadContext {\n\t\treturn Object.freeze({\n\t\t\tonDidReceiveKernelMessage: onDidReceiveKernelMessage.event,\n\t\t\tpostKernelMessage: (data: unknown) => postNotebookMessage('customKernelMessage', { message: data }),\n\t\t});\n\t}\n\n\tasync function runKernelPreload(url: string): Promise<void> {\n\t\ttry {\n\t\t\treturn await activateModuleKernelPreload(url);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tasync function activateModuleKernelPreload(url: string) {\n\t\tconst module: KernelPreloadModule = await __import(url);\n\t\tif (!module.activate) {\n\t\t\tconsole.error(`Notebook preload '${url}' was expected to be a module but it does not export an 'activate' function`);\n\t\t\treturn;\n\t\t}\n\t\treturn module.activate(createKernelContext());\n\t}\n\n\tconst dimensionUpdater = new class {\n\t\tprivate readonly pending = new Map<string, webviewMessages.DimensionUpdate>();\n\n\t\tupdateHeight(id: string, height: number, options: { init?: boolean; isOutput?: boolean }) {\n\t\t\tif (!this.pending.size) {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tthis.updateImmediately();\n\t\t\t\t}, 0);\n\t\t\t}\n\t\t\tconst update = this.pending.get(id);\n\t\t\tif (update && update.isOutput) {\n\t\t\t\tthis.pending.set(id, {\n\t\t\t\t\tid,\n\t\t\t\t\theight,\n\t\t\t\t\tinit: update.init,\n\t\t\t\t\tisOutput: update.isOutput\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.pending.set(id, {\n\t\t\t\t\tid,\n\t\t\t\t\theight,\n\t\t\t\t\t...options,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tupdateImmediately() {\n\t\t\tif (!this.pending.size) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tpostNotebookMessage<webviewMessages.IDimensionMessage>('dimension', {\n\t\t\t\tupdates: Array.from(this.pending.values())\n\t\t\t});\n\t\t\tthis.pending.clear();\n\t\t}\n\t};\n\n\tfunction elementHasContent(height: number) {\n\t\t// we need to account for a potential 1px top and bottom border on a child within the output container\n\t\treturn height > 2.1;\n\t}\n\n\tconst resizeObserver = new class {\n\n\t\tprivate readonly _observer: ResizeObserver;\n\n\t\tprivate readonly _observedElements = new WeakMap<Element, IObservedElement>();\n\t\tprivate _outputResizeTimer: Timeout | undefined;\n\n\t\tconstructor() {\n\t\t\tthis._observer = new ResizeObserver(entries => {\n\t\t\t\tfor (const entry of entries) {\n\t\t\t\t\tif (!window.document.body.contains(entry.target)) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst observedElementInfo = this._observedElements.get(entry.target);\n\t\t\t\t\tif (!observedElementInfo) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.postResizeMessage(observedElementInfo.cellId);\n\n\t\t\t\t\tif (entry.target.id !== observedElementInfo.id) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!entry.contentRect) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!observedElementInfo.output) {\n\t\t\t\t\t\t// markup, update directly\n\t\t\t\t\t\tthis.updateHeight(observedElementInfo, entry.target.offsetHeight);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst hasContent = elementHasContent(entry.contentRect.height);\n\t\t\t\t\tconst shouldUpdatePadding =\n\t\t\t\t\t\t(hasContent && observedElementInfo.lastKnownPadding === 0) ||\n\t\t\t\t\t\t(!hasContent && observedElementInfo.lastKnownPadding !== 0);\n\n\t\t\t\t\tif (shouldUpdatePadding) {\n\t\t\t\t\t\t// Do not update dimension in resize observer\n\t\t\t\t\t\twindow.requestAnimationFrame(() => {\n\t\t\t\t\t\t\tif (hasContent) {\n\t\t\t\t\t\t\t\tentry.target.style.padding = `${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodeLeftPadding}px`;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tentry.target.style.padding = `0px`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis.updateHeight(observedElementInfo, hasContent ? entry.target.offsetHeight : 0);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.updateHeight(observedElementInfo, hasContent ? entry.target.offsetHeight : 0);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tprivate updateHeight(observedElementInfo: IObservedElement, offsetHeight: number) {\n\t\t\tif (observedElementInfo.lastKnownHeight !== offsetHeight) {\n\t\t\t\tobservedElementInfo.lastKnownHeight = offsetHeight;\n\t\t\t\tdimensionUpdater.updateHeight(observedElementInfo.id, offsetHeight, {\n\t\t\t\t\tisOutput: observedElementInfo.output\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tpublic observe(container: Element, id: string, output: boolean, cellId: string) {\n\t\t\tif (this._observedElements.has(container)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._observedElements.set(container, { id, output, lastKnownPadding: ctx.style.outputNodePadding, lastKnownHeight: -1, cellId });\n\t\t\tthis._observer.observe(container);\n\t\t}\n\n\t\tprivate postResizeMessage(cellId: string) {\n\t\t\t// Debounce this callback to only happen after\n\t\t\t// 250 ms. Don't need resize events that often.\n\t\t\tclearTimeout(this._outputResizeTimer);\n\t\t\tthis._outputResizeTimer = setTimeout(() => {\n\t\t\t\tpostNotebookMessage('outputResized', {\n\t\t\t\t\tcellId\n\t\t\t\t});\n\t\t\t}, 250);\n\n\t\t}\n\t};\n\n\tlet previousDelta: number | undefined;\n\tlet scrollTimeout: Timeout | undefined;\n\tlet scrolledElement: Element | undefined;\n\tlet lastTimeScrolled: number | undefined;\n\tfunction flagRecentlyScrolled(node: Element, deltaY?: number) {\n\t\tscrolledElement = node;\n\t\tif (deltaY === undefined) {\n\t\t\tlastTimeScrolled = Date.now();\n\t\t\tpreviousDelta = undefined;\n\t\t\tnode.setAttribute('recentlyScrolled', 'true');\n\t\t\tclearTimeout(scrollTimeout);\n\t\t\tscrollTimeout = setTimeout(() => { scrolledElement?.removeAttribute('recentlyScrolled'); }, 300);\n\t\t\treturn true;\n\t\t}\n\n\t\tif (node.hasAttribute('recentlyScrolled')) {\n\t\t\tif (lastTimeScrolled && Date.now() - lastTimeScrolled > 400) {\n\t\t\t\t// it has been a while since we actually scrolled\n\t\t\t\t// if scroll velocity increases significantly, it's likely a new scroll event\n\t\t\t\tif (!!previousDelta && deltaY < 0 && deltaY < previousDelta - 8) {\n\t\t\t\t\tclearTimeout(scrollTimeout);\n\t\t\t\t\tscrolledElement?.removeAttribute('recentlyScrolled');\n\t\t\t\t\treturn false;\n\t\t\t\t} else if (!!previousDelta && deltaY > 0 && deltaY > previousDelta + 8) {\n\t\t\t\t\tclearTimeout(scrollTimeout);\n\t\t\t\t\tscrolledElement?.removeAttribute('recentlyScrolled');\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\t// the tail end of a smooth scrolling event (from a trackpad) can go on for a while\n\t\t\t\t// so keep swallowing it, but we can shorten the timeout since the events occur rapidly\n\t\t\t\tclearTimeout(scrollTimeout);\n\t\t\t\tscrollTimeout = setTimeout(() => { scrolledElement?.removeAttribute('recentlyScrolled'); }, 50);\n\t\t\t} else {\n\t\t\t\tclearTimeout(scrollTimeout);\n\t\t\t\tscrollTimeout = setTimeout(() => { scrolledElement?.removeAttribute('recentlyScrolled'); }, 300);\n\t\t\t}\n\n\t\t\tpreviousDelta = deltaY;\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tfunction eventTargetShouldHandleScroll(event: WheelEvent) {\n\t\tfor (let node = event.target as Node | null; node; node = node.parentNode) {\n\t\t\tif (!(node instanceof Element) || node.id === 'container' || node.classList.contains('cell_container') || node.classList.contains('markup') || node.classList.contains('output_container')) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// scroll up\n\t\t\tif (event.deltaY < 0 && node.scrollTop > 0) {\n\t\t\t\t// there is still some content to scroll\n\t\t\t\tflagRecentlyScrolled(node);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\t// scroll down\n\t\t\tif (event.deltaY > 0 && node.scrollTop + node.clientHeight < node.scrollHeight) {\n\t\t\t\t// per https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollHeight\n\t\t\t\t// scrollTop is not rounded but scrollHeight and clientHeight are\n\t\t\t\t// so we need to check if the difference is less than some threshold\n\t\t\t\tif (node.scrollHeight - node.scrollTop - node.clientHeight < 2) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// if the node is not scrollable, we can continue. We don't check the computed style always as it's expensive\n\t\t\t\tif (window.getComputedStyle(node).overflowY === 'hidden' || window.getComputedStyle(node).overflowY === 'visible') {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tflagRecentlyScrolled(node);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (flagRecentlyScrolled(node, event.deltaY)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tconst handleWheel = (event: WheelEvent & { wheelDeltaX?: number; wheelDeltaY?: number; wheelDelta?: number }) => {\n\t\tif (event.defaultPrevented || eventTargetShouldHandleScroll(event)) {\n\t\t\treturn;\n\t\t}\n\t\tpostNotebookMessage<webviewMessages.IWheelMessage>('did-scroll-wheel', {\n\t\t\tpayload: {\n\t\t\t\tdeltaMode: event.deltaMode,\n\t\t\t\tdeltaX: event.deltaX,\n\t\t\t\tdeltaY: event.deltaY,\n\t\t\t\tdeltaZ: event.deltaZ,\n\t\t\t\t// Refs https://github.com/microsoft/vscode/issues/146403#issuecomment-1854538928\n\t\t\t\twheelDelta: event.wheelDelta && isChrome ? (event.wheelDelta / window.devicePixelRatio) : event.wheelDelta,\n\t\t\t\twheelDeltaX: event.wheelDeltaX && isChrome ? (event.wheelDeltaX / window.devicePixelRatio) : event.wheelDeltaX,\n\t\t\t\twheelDeltaY: event.wheelDeltaY && isChrome ? (event.wheelDeltaY / window.devicePixelRatio) : event.wheelDeltaY,\n\t\t\t\tdetail: event.detail,\n\t\t\t\tshiftKey: event.shiftKey,\n\t\t\t\ttype: event.type\n\t\t\t}\n\t\t});\n\t};\n\n\tfunction focusFirstFocusableOrContainerInOutput(cellOrOutputId: string, alternateId?: string) {\n\t\tconst cellOutputContainer = window.document.getElementById(cellOrOutputId) ??\n\t\t\t(alternateId ? window.document.getElementById(alternateId) : undefined);\n\t\tif (cellOutputContainer) {\n\t\t\tif (cellOutputContainer.contains(window.document.activeElement)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst id = cellOutputContainer.id;\n\t\t\tlet focusableElement = cellOutputContainer.querySelector('[tabindex=\"0\"], [href], button, input, option, select, textarea') as HTMLElement | null;\n\t\t\tif (!focusableElement) {\n\t\t\t\tfocusableElement = cellOutputContainer;\n\t\t\t\tfocusableElement.tabIndex = -1;\n\t\t\t\tpostNotebookMessage<webviewMessages.IOutputInputFocusMessage>('outputInputFocus', { inputFocused: false, id });\n\t\t\t} else {\n\t\t\t\tconst inputFocused = hasActiveEditableElement(focusableElement, focusableElement.ownerDocument);\n\t\t\t\tpostNotebookMessage<webviewMessages.IOutputInputFocusMessage>('outputInputFocus', { inputFocused, id });\n\t\t\t}\n\n\t\t\tlastFocusedOutput = cellOutputContainer;\n\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', { id: cellOutputContainer.id });\n\t\t\tfocusableElement.focus();\n\t\t}\n\t}\n\n\tfunction createFocusSink(cellId: string, focusNext?: boolean) {\n\t\tconst element = document.createElement('div');\n\t\telement.id = `focus-sink-${cellId}`;\n\t\telement.tabIndex = 0;\n\t\telement.addEventListener('focus', () => {\n\t\t\tpostNotebookMessage<webviewMessages.IFocusEditorMessage>('focus-editor', {\n\t\t\t\tcellId: cellId,\n\t\t\t\tfocusNext\n\t\t\t});\n\t\t});\n\n\t\treturn element;\n\t}\n\n\tfunction _internalHighlightRange(range: Range, tagName = 'mark', attributes = {}) {\n\t\t// derived from https://github.com/Treora/dom-highlight-range/blob/master/highlight-range.js\n\n\t\t// Return an array of the text nodes in the range. Split the start and end nodes if required.\n\t\tfunction _textNodesInRange(range: Range): Text[] {\n\t\t\tif (!range.startContainer.ownerDocument) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\t// If the start or end node is a text node and only partly in the range, split it.\n\t\t\tif (range.startContainer.nodeType === Node.TEXT_NODE && range.startOffset > 0) {\n\t\t\t\tconst startContainer = range.startContainer as Text;\n\t\t\t\tconst endOffset = range.endOffset; // (this may get lost when the splitting the node)\n\t\t\t\tconst createdNode = startContainer.splitText(range.startOffset);\n\t\t\t\tif (range.endContainer === startContainer) {\n\t\t\t\t\t// If the end was in the same container, it will now be in the newly created node.\n\t\t\t\t\trange.setEnd(createdNode, endOffset - range.startOffset);\n\t\t\t\t}\n\n\t\t\t\trange.setStart(createdNode, 0);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\trange.endContainer.nodeType === Node.TEXT_NODE\n\t\t\t\t&& range.endOffset < (range.endContainer as Text).length\n\t\t\t) {\n\t\t\t\t(range.endContainer as Text).splitText(range.endOffset);\n\t\t\t}\n\n\t\t\t// Collect the text nodes.\n\t\t\tconst walker = range.startContainer.ownerDocument.createTreeWalker(\n\t\t\t\trange.commonAncestorContainer,\n\t\t\t\tNodeFilter.SHOW_TEXT,\n\t\t\t\tnode => range.intersectsNode(node) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT,\n\t\t\t);\n\n\t\t\twalker.currentNode = range.startContainer;\n\n\t\t\t// // Optimise by skipping nodes that are explicitly outside the range.\n\t\t\t// const NodeTypesWithCharacterOffset = [\n\t\t\t//  Node.TEXT_NODE,\n\t\t\t//  Node.PROCESSING_INSTRUCTION_NODE,\n\t\t\t//  Node.COMMENT_NODE,\n\t\t\t// ];\n\t\t\t// if (!NodeTypesWithCharacterOffset.includes(range.startContainer.nodeType)) {\n\t\t\t//   if (range.startOffset < range.startContainer.childNodes.length) {\n\t\t\t//     walker.currentNode = range.startContainer.childNodes[range.startOffset];\n\t\t\t//   } else {\n\t\t\t//     walker.nextSibling(); // TODO verify this is correct.\n\t\t\t//   }\n\t\t\t// }\n\n\t\t\tconst nodes: Text[] = [];\n\t\t\tif (walker.currentNode.nodeType === Node.TEXT_NODE) {\n\t\t\t\tnodes.push(walker.currentNode as Text);\n\t\t\t}\n\n\t\t\twhile (walker.nextNode() && range.comparePoint(walker.currentNode, 0) !== 1) {\n\t\t\t\tif (walker.currentNode.nodeType === Node.TEXT_NODE) {\n\t\t\t\t\tnodes.push(walker.currentNode as Text);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn nodes;\n\t\t}\n\n\t\t// Replace [node] with <tagName ...attributes>[node]</tagName>\n\t\tfunction wrapNodeInHighlight(node: Text, tagName: string, attributes: any) {\n\t\t\tconst highlightElement = node.ownerDocument.createElement(tagName);\n\t\t\tObject.keys(attributes).forEach(key => {\n\t\t\t\thighlightElement.setAttribute(key, attributes[key]);\n\t\t\t});\n\t\t\tconst tempRange = node.ownerDocument.createRange();\n\t\t\ttempRange.selectNode(node);\n\t\t\ttempRange.surroundContents(highlightElement);\n\t\t\treturn highlightElement;\n\t\t}\n\n\t\tif (range.collapsed) {\n\t\t\treturn {\n\t\t\t\tremove: () => { },\n\t\t\t\tupdate: () => { }\n\t\t\t};\n\t\t}\n\n\t\t// First put all nodes in an array (splits start and end nodes if needed)\n\t\tconst nodes = _textNodesInRange(range);\n\n\t\t// Highlight each node\n\t\tconst highlightElements: Element[] = [];\n\t\tfor (const nodeIdx in nodes) {\n\t\t\tconst highlightElement = wrapNodeInHighlight(nodes[nodeIdx], tagName, attributes);\n\t\t\thighlightElements.push(highlightElement);\n\t\t}\n\n\t\t// Remove a highlight element created with wrapNodeInHighlight.\n\t\tfunction _removeHighlight(highlightElement: Element) {\n\t\t\tif (highlightElement.childNodes.length === 1) {\n\t\t\t\thighlightElement.replaceWith(highlightElement.firstChild!);\n\t\t\t} else {\n\t\t\t\t// If the highlight somehow contains multiple nodes now, move them all.\n\t\t\t\twhile (highlightElement.firstChild) {\n\t\t\t\t\thighlightElement.parentNode?.insertBefore(highlightElement.firstChild, highlightElement);\n\t\t\t\t}\n\t\t\t\thighlightElement.remove();\n\t\t\t}\n\t\t}\n\n\t\t// Return a function that cleans up the highlightElements.\n\t\tfunction _removeHighlights() {\n\t\t\t// Remove each of the created highlightElements.\n\t\t\tfor (const highlightIdx in highlightElements) {\n\t\t\t\t_removeHighlight(highlightElements[highlightIdx]);\n\t\t\t}\n\t\t}\n\n\t\tfunction _updateHighlight(highlightElement: Element, attributes: any = {}) {\n\t\t\tObject.keys(attributes).forEach(key => {\n\t\t\t\thighlightElement.setAttribute(key, attributes[key]);\n\t\t\t});\n\t\t}\n\n\t\tfunction updateHighlights(attributes: any) {\n\t\t\tfor (const highlightIdx in highlightElements) {\n\t\t\t\t_updateHighlight(highlightElements[highlightIdx], attributes);\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tremove: _removeHighlights,\n\t\t\tupdate: updateHighlights\n\t\t};\n\t}\n\n\tinterface ICommonRange {\n\t\tcollapsed: boolean;\n\t\tcommonAncestorContainer: Node;\n\t\tendContainer: Node;\n\t\tendOffset: number;\n\t\tstartContainer: Node;\n\t\tstartOffset: number;\n\n\t}\n\n\tinterface IHighlightResult {\n\t\trange: ICommonRange;\n\t\tdispose: () => void;\n\t\tupdate: (color: string | undefined, className: string | undefined) => void;\n\t}\n\n\tfunction selectRange(_range: ICommonRange) {\n\t\tconst sel = window.getSelection();\n\t\tif (sel) {\n\t\t\ttry {\n\t\t\t\tsel.removeAllRanges();\n\t\t\t\tconst r = document.createRange();\n\t\t\t\tr.setStart(_range.startContainer, _range.startOffset);\n\t\t\t\tr.setEnd(_range.endContainer, _range.endOffset);\n\t\t\t\tsel.addRange(r);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.log(e);\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction highlightRange(range: Range, useCustom: boolean, tagName = 'mark', attributes = {}): IHighlightResult {\n\t\tif (useCustom) {\n\t\t\tconst ret = _internalHighlightRange(range, tagName, attributes);\n\t\t\treturn {\n\t\t\t\trange: range,\n\t\t\t\tdispose: ret.remove,\n\t\t\t\tupdate: (color: string | undefined, className: string | undefined) => {\n\t\t\t\t\tif (className === undefined) {\n\t\t\t\t\t\tret.update({\n\t\t\t\t\t\t\t'style': `background-color: ${color}`\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tret.update({\n\t\t\t\t\t\t\t'class': className\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t} else {\n\t\t\twindow.document.execCommand('hiliteColor', false, matchColor);\n\t\t\tconst cloneRange = window.getSelection()!.getRangeAt(0).cloneRange();\n\t\t\tconst _range = {\n\t\t\t\tcollapsed: cloneRange.collapsed,\n\t\t\t\tcommonAncestorContainer: cloneRange.commonAncestorContainer,\n\t\t\t\tendContainer: cloneRange.endContainer,\n\t\t\t\tendOffset: cloneRange.endOffset,\n\t\t\t\tstartContainer: cloneRange.startContainer,\n\t\t\t\tstartOffset: cloneRange.startOffset\n\t\t\t};\n\t\t\treturn {\n\t\t\t\trange: _range,\n\t\t\t\tdispose: () => {\n\t\t\t\t\tselectRange(_range);\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdocument.designMode = 'On';\n\t\t\t\t\t\twindow.document.execCommand('removeFormat', false, undefined);\n\t\t\t\t\t\tdocument.designMode = 'Off';\n\t\t\t\t\t\twindow.getSelection()?.removeAllRanges();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tconsole.log(e);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tupdate: (color: string | undefined, className: string | undefined) => {\n\t\t\t\t\tselectRange(_range);\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdocument.designMode = 'On';\n\t\t\t\t\t\twindow.document.execCommand('removeFormat', false, undefined);\n\t\t\t\t\t\twindow.document.execCommand('hiliteColor', false, color);\n\t\t\t\t\t\tdocument.designMode = 'Off';\n\t\t\t\t\t\twindow.getSelection()?.removeAllRanges();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tconsole.log(e);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n\n\tfunction createEmitter<T>(listenerChange: (listeners: Set<Listener<T>>) => void = () => undefined): EmitterLike<T> {\n\t\tconst listeners = new Set<Listener<T>>();\n\t\treturn {\n\t\t\tfire(data) {\n\t\t\t\tfor (const listener of [...listeners]) {\n\t\t\t\t\tlistener.fn.call(listener.thisArg, data);\n\t\t\t\t}\n\t\t\t},\n\t\t\tevent(fn, thisArg, disposables) {\n\t\t\t\tconst listenerObj = { fn, thisArg };\n\t\t\t\tconst disposable: IDisposable = {\n\t\t\t\t\tdispose: () => {\n\t\t\t\t\t\tlisteners.delete(listenerObj);\n\t\t\t\t\t\tlistenerChange(listeners);\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\tlisteners.add(listenerObj);\n\t\t\t\tlistenerChange(listeners);\n\n\t\t\t\tif (disposables instanceof Array) {\n\t\t\t\t\tdisposables.push(disposable);\n\t\t\t\t} else if (disposables) {\n\t\t\t\t\tdisposables.add(disposable);\n\t\t\t\t}\n\n\t\t\t\treturn disposable;\n\t\t\t},\n\t\t};\n\t}\n\n\tfunction showRenderError(errorText: string, outputNode: HTMLElement, errors: readonly Error[]) {\n\t\toutputNode.innerText = errorText;\n\t\tconst errList = document.createElement('ul');\n\t\tfor (const result of errors) {\n\t\t\tconsole.error(result);\n\t\t\tconst item = document.createElement('li');\n\t\t\titem.innerText = result.message;\n\t\t\terrList.appendChild(item);\n\t\t}\n\t\toutputNode.appendChild(errList);\n\t}\n\n\tconst outputItemRequests = new class {\n\t\tprivate _requestPool = 0;\n\t\tprivate readonly _requests = new Map</*requestId*/number, { resolve: (x: webviewMessages.OutputItemEntry | undefined) => void }>();\n\n\t\tgetOutputItem(outputId: string, mime: string) {\n\t\t\tconst requestId = this._requestPool++;\n\n\t\t\tconst { promise, resolve } = promiseWithResolvers<webviewMessages.OutputItemEntry | undefined>();\n\t\t\tthis._requests.set(requestId, { resolve });\n\n\t\t\tpostNotebookMessage<webviewMessages.IGetOutputItemMessage>('getOutputItem', { requestId, outputId, mime });\n\t\t\treturn promise;\n\t\t}\n\n\t\tresolveOutputItem(requestId: number, output: webviewMessages.OutputItemEntry | undefined) {\n\t\t\tconst request = this._requests.get(requestId);\n\t\t\tif (!request) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._requests.delete(requestId);\n\t\t\trequest.resolve(output);\n\t\t}\n\t};\n\n\tinterface AdditionalOutputItemInfo {\n\t\treadonly mime: string;\n\t\tgetItem(): Promise<rendererApi.OutputItem | undefined>;\n\t}\n\n\tinterface ExtendedOutputItem extends rendererApi.OutputItem {\n\t\treadonly _allOutputItems: ReadonlyArray<AdditionalOutputItemInfo>;\n\t\tappendedText?(): string | undefined;\n\t}\n\n\tlet hasWarnedAboutAllOutputItemsProposal = false;\n\n\tfunction createOutputItem(\n\t\tid: string,\n\t\tmime: string,\n\t\tmetadata: unknown,\n\t\tvalueBytes: Uint8Array,\n\t\tallOutputItemData: ReadonlyArray<{ readonly mime: string }>,\n\t\tappended?: { valueBytes: Uint8Array; previousVersion: number }\n\t): ExtendedOutputItem {\n\n\t\tfunction create(\n\t\t\tid: string,\n\t\t\tmime: string,\n\t\t\tmetadata: unknown,\n\t\t\tvalueBytes: Uint8Array,\n\t\t\tappended?: { valueBytes: Uint8Array; previousVersion: number }\n\t\t): ExtendedOutputItem {\n\t\t\treturn Object.freeze<ExtendedOutputItem>({\n\t\t\t\tid,\n\t\t\t\tmime,\n\t\t\t\tmetadata,\n\n\t\t\t\tappendedText(): string | undefined {\n\t\t\t\t\tif (appended) {\n\t\t\t\t\t\treturn textDecoder.decode(appended.valueBytes);\n\t\t\t\t\t}\n\t\t\t\t\treturn undefined;\n\t\t\t\t},\n\n\t\t\t\tdata(): Uint8Array {\n\t\t\t\t\treturn valueBytes;\n\t\t\t\t},\n\n\t\t\t\ttext(): string {\n\t\t\t\t\treturn textDecoder.decode(valueBytes);\n\t\t\t\t},\n\n\t\t\t\tjson() {\n\t\t\t\t\treturn JSON.parse(this.text());\n\t\t\t\t},\n\n\t\t\t\tblob(): Blob {\n\t\t\t\t\treturn new Blob([valueBytes as Uint8Array<ArrayBuffer>], { type: this.mime });\n\t\t\t\t},\n\n\t\t\t\tget _allOutputItems() {\n\t\t\t\t\tif (!hasWarnedAboutAllOutputItemsProposal) {\n\t\t\t\t\t\thasWarnedAboutAllOutputItemsProposal = true;\n\t\t\t\t\t\tconsole.warn(`'_allOutputItems' is proposed API. DO NOT ship an extension that depends on it!`);\n\t\t\t\t\t}\n\t\t\t\t\treturn allOutputItemList;\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\tconst allOutputItemCache = new Map</*mime*/string, Promise<(rendererApi.OutputItem & ExtendedOutputItem) | undefined>>();\n\t\tconst allOutputItemList = Object.freeze(allOutputItemData.map(outputItem => {\n\t\t\tconst mime = outputItem.mime;\n\t\t\treturn Object.freeze({\n\t\t\t\tmime,\n\t\t\t\tgetItem() {\n\t\t\t\t\tconst existingTask = allOutputItemCache.get(mime);\n\t\t\t\t\tif (existingTask) {\n\t\t\t\t\t\treturn existingTask;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst task = outputItemRequests.getOutputItem(id, mime).then(item => {\n\t\t\t\t\t\treturn item ? create(id, item.mime, metadata, item.valueBytes) : undefined;\n\t\t\t\t\t});\n\t\t\t\t\tallOutputItemCache.set(mime, task);\n\n\t\t\t\t\treturn task;\n\t\t\t\t}\n\t\t\t});\n\t\t}));\n\n\t\tconst item = create(id, mime, metadata, valueBytes, appended);\n\t\tallOutputItemCache.set(mime, Promise.resolve(item));\n\t\treturn item;\n\t}\n\n\tconst onDidReceiveKernelMessage = createEmitter<unknown>();\n\n\tconst ttPolicy = window.trustedTypes?.createPolicy('notebookRenderer', {\n\t\tcreateHTML: value => value, // CodeQL [SM03712] The rendered content is provided by renderer extensions, which are responsible for sanitizing their content themselves. The notebook webview is also sandboxed.\n\t\tcreateScript: value => value, // CodeQL [SM03712] The rendered content is provided by renderer extensions, which are responsible for sanitizing their content themselves. The notebook webview is also sandboxed.\n\t});\n\n\twindow.addEventListener('wheel', handleWheel);\n\n\tinterface IFindMatch {\n\t\ttype: 'preview' | 'output';\n\t\tid: string;\n\t\tcellId: string;\n\t\tcontainer: Node;\n\t\toriginalRange: Range;\n\t\tisShadow: boolean;\n\t\tsearchPreviewInfo?: ISearchPreviewInfo;\n\t\thighlightResult?: IHighlightResult;\n\t}\n\n\tinterface ISearchPreviewInfo {\n\t\tline: string;\n\t\trange: {\n\t\t\tstart: number;\n\t\t\tend: number;\n\t\t};\n\t}\n\n\tinterface IHighlighter {\n\t\taddHighlights(matches: IFindMatch[], ownerID: string): void;\n\t\tremoveHighlights(ownerID: string): void;\n\t\thighlightCurrentMatch(index: number, ownerID: string): void;\n\t\tunHighlightCurrentMatch(index: number, ownerID: string): void;\n\t\tdispose(): void;\n\t}\n\n\tinterface IHighlightInfo {\n\t\tmatches: IFindMatch[];\n\t\tcurrentMatchIndex: number;\n\t}\n\n\tconst matchColor = window.getComputedStyle(window.document.getElementById('_defaultColorPalatte')!).color;\n\tconst currentMatchColor = window.getComputedStyle(window.document.getElementById('_defaultColorPalatte')!).backgroundColor;\n\n\tclass JSHighlighter implements IHighlighter {\n\t\tprivate _activeHighlightInfo: Map<string, IHighlightInfo>;\n\n\t\tconstructor(\n\t\t) {\n\t\t\tthis._activeHighlightInfo = new Map();\n\t\t}\n\n\t\taddHighlights(matches: IFindMatch[], ownerID: string): void {\n\t\t\tfor (let i = matches.length - 1; i >= 0; i--) {\n\t\t\t\tconst match = matches[i];\n\t\t\t\tconst ret = highlightRange(match.originalRange, true, 'mark', match.isShadow ? {\n\t\t\t\t\t'style': 'background-color: ' + matchColor + ';',\n\t\t\t\t} : {\n\t\t\t\t\t'class': 'find-match'\n\t\t\t\t});\n\t\t\t\tmatch.highlightResult = ret;\n\t\t\t}\n\n\t\t\tconst highlightInfo: IHighlightInfo = {\n\t\t\t\tmatches,\n\t\t\t\tcurrentMatchIndex: -1\n\t\t\t};\n\t\t\tthis._activeHighlightInfo.set(ownerID, highlightInfo);\n\t\t}\n\n\t\tremoveHighlights(ownerID: string): void {\n\t\t\tthis._activeHighlightInfo.get(ownerID)?.matches.forEach(match => {\n\t\t\t\tmatch.highlightResult?.dispose();\n\t\t\t});\n\t\t\tthis._activeHighlightInfo.delete(ownerID);\n\t\t}\n\n\t\thighlightCurrentMatch(index: number, ownerID: string) {\n\t\t\tconst highlightInfo = this._activeHighlightInfo.get(ownerID);\n\t\t\tif (!highlightInfo) {\n\t\t\t\tconsole.error('Modified current highlight match before adding highlight list.');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst oldMatch = highlightInfo.matches[highlightInfo.currentMatchIndex];\n\t\t\toldMatch?.highlightResult?.update(matchColor, oldMatch.isShadow ? undefined : 'find-match');\n\n\t\t\tconst match = highlightInfo.matches[index];\n\t\t\thighlightInfo.currentMatchIndex = index;\n\t\t\tconst sel = window.getSelection();\n\t\t\tif (!!match && !!sel && match.highlightResult) {\n\t\t\t\tlet offset = 0;\n\t\t\t\ttry {\n\t\t\t\t\tconst outputOffset = window.document.getElementById(match.id)!.getBoundingClientRect().top;\n\t\t\t\t\tconst tempRange = document.createRange();\n\t\t\t\t\ttempRange.selectNode(match.highlightResult.range.startContainer);\n\n\t\t\t\t\tmatch.highlightResult.range.startContainer.parentElement?.scrollIntoView({ behavior: 'auto', block: 'end', inline: 'nearest' });\n\n\t\t\t\t\tconst rangeOffset = tempRange.getBoundingClientRect().top;\n\t\t\t\t\ttempRange.detach();\n\n\t\t\t\t\toffset = rangeOffset - outputOffset;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t}\n\n\t\t\t\tmatch.highlightResult?.update(currentMatchColor, match.isShadow ? undefined : 'current-find-match');\n\n\t\t\t\twindow.document.getSelection()?.removeAllRanges();\n\t\t\t\tpostNotebookMessage('didFindHighlightCurrent', {\n\t\t\t\t\toffset\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tunHighlightCurrentMatch(index: number, ownerID: string) {\n\t\t\tconst highlightInfo = this._activeHighlightInfo.get(ownerID);\n\t\t\tif (!highlightInfo) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst oldMatch = highlightInfo.matches[index];\n\t\t\tif (oldMatch && oldMatch.highlightResult) {\n\t\t\t\toldMatch.highlightResult.update(matchColor, oldMatch.isShadow ? undefined : 'find-match');\n\t\t\t}\n\t\t}\n\n\t\tdispose() {\n\t\t\twindow.document.getSelection()?.removeAllRanges();\n\t\t\tthis._activeHighlightInfo.forEach(highlightInfo => {\n\t\t\t\thighlightInfo.matches.forEach(match => {\n\t\t\t\t\tmatch.highlightResult?.dispose();\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tclass CSSHighlighter implements IHighlighter {\n\t\tprivate _activeHighlightInfo: Map<string, IHighlightInfo>;\n\t\tprivate _matchesHighlight: Highlight;\n\t\tprivate _currentMatchesHighlight: Highlight;\n\n\t\tconstructor() {\n\t\t\tthis._activeHighlightInfo = new Map();\n\t\t\tthis._matchesHighlight = new Highlight();\n\t\t\tthis._matchesHighlight.priority = 1;\n\t\t\tthis._currentMatchesHighlight = new Highlight();\n\t\t\tthis._currentMatchesHighlight.priority = 2;\n\t\t\tCSS.highlights?.set(`find-highlight`, this._matchesHighlight);\n\t\t\tCSS.highlights?.set(`current-find-highlight`, this._currentMatchesHighlight);\n\t\t}\n\n\t\t_refreshRegistry(updateMatchesHighlight = true) {\n\t\t\t// for performance reasons, only update the full list of highlights when we need to\n\t\t\tif (updateMatchesHighlight) {\n\t\t\t\tthis._matchesHighlight.clear();\n\t\t\t}\n\n\t\t\tthis._currentMatchesHighlight.clear();\n\n\t\t\tthis._activeHighlightInfo.forEach((highlightInfo) => {\n\n\t\t\t\tif (updateMatchesHighlight) {\n\t\t\t\t\tfor (let i = 0; i < highlightInfo.matches.length; i++) {\n\t\t\t\t\t\tthis._matchesHighlight.add(highlightInfo.matches[i].originalRange);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (highlightInfo.currentMatchIndex < highlightInfo.matches.length && highlightInfo.currentMatchIndex >= 0) {\n\t\t\t\t\tthis._currentMatchesHighlight.add(highlightInfo.matches[highlightInfo.currentMatchIndex].originalRange);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\taddHighlights(\n\t\t\tmatches: IFindMatch[],\n\t\t\townerID: string\n\t\t) {\n\n\t\t\tfor (let i = 0; i < matches.length; i++) {\n\t\t\t\tthis._matchesHighlight.add(matches[i].originalRange);\n\t\t\t}\n\n\t\t\tconst newEntry: IHighlightInfo = {\n\t\t\t\tmatches,\n\t\t\t\tcurrentMatchIndex: -1,\n\t\t\t};\n\n\t\t\tthis._activeHighlightInfo.set(ownerID, newEntry);\n\t\t}\n\n\t\thighlightCurrentMatch(index: number, ownerID: string): void {\n\t\t\tconst highlightInfo = this._activeHighlightInfo.get(ownerID);\n\t\t\tif (!highlightInfo) {\n\t\t\t\tconsole.error('Modified current highlight match before adding highlight list.');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\thighlightInfo.currentMatchIndex = index;\n\t\t\tconst match = highlightInfo.matches[index];\n\n\t\t\tif (match) {\n\t\t\t\tlet offset = 0;\n\t\t\t\ttry {\n\t\t\t\t\tconst outputOffset = window.document.getElementById(match.id)!.getBoundingClientRect().top;\n\t\t\t\t\tmatch.originalRange.startContainer.parentElement?.scrollIntoView({ behavior: 'auto', block: 'end', inline: 'nearest' });\n\t\t\t\t\tconst rangeOffset = match.originalRange.getBoundingClientRect().top;\n\t\t\t\t\toffset = rangeOffset - outputOffset;\n\t\t\t\t\tpostNotebookMessage('didFindHighlightCurrent', {\n\t\t\t\t\t\toffset\n\t\t\t\t\t});\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._refreshRegistry(false);\n\t\t}\n\n\t\tunHighlightCurrentMatch(index: number, ownerID: string): void {\n\t\t\tconst highlightInfo = this._activeHighlightInfo.get(ownerID);\n\t\t\tif (!highlightInfo) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\thighlightInfo.currentMatchIndex = -1;\n\t\t}\n\n\t\tremoveHighlights(ownerID: string) {\n\t\t\tthis._activeHighlightInfo.delete(ownerID);\n\t\t\tthis._refreshRegistry();\n\t\t}\n\n\t\tdispose(): void {\n\t\t\twindow.document.getSelection()?.removeAllRanges();\n\t\t\tthis._currentMatchesHighlight.clear();\n\t\t\tthis._matchesHighlight.clear();\n\t\t}\n\t}\n\n\tconst _highlighter = (CSS.highlights) ? new CSSHighlighter() : new JSHighlighter();\n\n\tfunction extractSelectionLine(selection: Selection): ISearchPreviewInfo {\n\t\tconst range = selection.getRangeAt(0);\n\n\t\t// we need to keep a reference to the old selection range to re-apply later\n\t\tconst oldRange = range.cloneRange();\n\t\tconst captureLength = selection.toString().length;\n\n\t\t// use selection API to modify selection to get entire line (the first line if multi-select)\n\n\t\t// collapse selection to start so that the cursor position is at beginning of match\n\t\tselection.collapseToStart();\n\n\t\t// extend selection in both directions to select the line\n\t\tselection.modify('move', 'backward', 'lineboundary');\n\t\tselection.modify('extend', 'forward', 'lineboundary');\n\n\t\tconst line = selection.toString();\n\n\t\t// using the original range and the new range, we can find the offset of the match from the line start.\n\t\tconst rangeStart = getStartOffset(selection.getRangeAt(0), oldRange);\n\n\t\t// line range for match\n\t\tconst lineRange = {\n\t\t\tstart: rangeStart,\n\t\t\tend: rangeStart + captureLength,\n\t\t};\n\n\t\t// re-add the old range so that the selection is restored\n\t\tselection.removeAllRanges();\n\t\tselection.addRange(oldRange);\n\n\t\treturn { line, range: lineRange };\n\t}\n\n\tfunction getStartOffset(lineRange: Range, originalRange: Range) {\n\t\t// sometimes, the old and new range are in different DOM elements (ie: when the match is inside of <b></b>)\n\t\t// so we need to find the first common ancestor DOM element and find the positions of the old and new range relative to that.\n\t\tconst firstCommonAncestor = findFirstCommonAncestor(lineRange.startContainer, originalRange.startContainer);\n\n\t\tconst selectionOffset = getSelectionOffsetRelativeTo(firstCommonAncestor, lineRange.startContainer) + lineRange.startOffset;\n\t\tconst textOffset = getSelectionOffsetRelativeTo(firstCommonAncestor, originalRange.startContainer) + originalRange.startOffset;\n\t\treturn textOffset - selectionOffset;\n\t}\n\n\t// modified from https://stackoverflow.com/a/68583466/16253823\n\tfunction findFirstCommonAncestor(nodeA: Node, nodeB: Node) {\n\t\tconst range = new Range();\n\t\trange.setStart(nodeA, 0);\n\t\trange.setEnd(nodeB, 0);\n\t\treturn range.commonAncestorContainer;\n\t}\n\n\tfunction getTextContentLength(node: Node): number {\n\t\tlet length = 0;\n\n\t\tif (node.nodeType === Node.TEXT_NODE) {\n\t\t\tlength += node.textContent?.length || 0;\n\t\t} else {\n\t\t\tfor (const childNode of node.childNodes) {\n\t\t\t\tlength += getTextContentLength(childNode);\n\t\t\t}\n\t\t}\n\n\t\treturn length;\n\t}\n\n\t// modified from https://stackoverflow.com/a/48812529/16253823\n\tfunction getSelectionOffsetRelativeTo(parentElement: Node, currentNode: Node | null): number {\n\t\tif (!currentNode) {\n\t\t\treturn 0;\n\t\t}\n\t\tlet offset = 0;\n\n\t\tif (currentNode === parentElement || !parentElement.contains(currentNode)) {\n\t\t\treturn offset;\n\t\t}\n\n\n\t\t// count the number of chars before the current dom elem and the start of the dom\n\t\tlet prevSibling = currentNode.previousSibling;\n\t\twhile (prevSibling) {\n\t\t\toffset += getTextContentLength(prevSibling);\n\t\t\tprevSibling = prevSibling.previousSibling;\n\t\t}\n\n\t\treturn offset + getSelectionOffsetRelativeTo(parentElement, currentNode.parentNode);\n\t}\n\n\tconst find = (query: string, options: { wholeWord?: boolean; caseSensitive?: boolean; includeMarkup: boolean; includeOutput: boolean; shouldGetSearchPreviewInfo: boolean; ownerID: string; findIds: string[] }) => {\n\t\tlet find = true;\n\t\tlet matches: IFindMatch[] = [];\n\n\t\tconst range = document.createRange();\n\t\trange.selectNodeContents(window.document.getElementById('findStart')!);\n\t\tconst sel = window.getSelection();\n\t\tsel?.removeAllRanges();\n\t\tsel?.addRange(range);\n\n\t\tviewModel.toggleDragDropEnabled(false);\n\n\t\ttry {\n\t\t\tdocument.designMode = 'On';\n\n\t\t\twhile (find && matches.length < 500) {\n\t\t\t\tfind = (window as unknown as { find: (query: string, caseSensitive: boolean, backwards: boolean, wrapAround: boolean, wholeWord: boolean, searchInFrames: boolean, includeMarkup: boolean) => boolean }).find(query, /* caseSensitive*/ !!options.caseSensitive,\n\t\t\t\t/* backwards*/ false,\n\t\t\t\t/* wrapAround*/ false,\n\t\t\t\t/* wholeWord */ !!options.wholeWord,\n\t\t\t\t/* searchInFrames*/ true,\n\t\t\t\t\tfalse);\n\n\t\t\t\tif (find) {\n\t\t\t\t\tconst selection = window.getSelection();\n\t\t\t\t\tif (!selection) {\n\t\t\t\t\t\tconsole.log('no selection');\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Markdown preview are rendered in a shadow DOM.\n\t\t\t\t\tif (options.includeMarkup && selection.rangeCount > 0 && selection.getRangeAt(0).startContainer.nodeType === 1\n\t\t\t\t\t\t&& (selection.getRangeAt(0).startContainer as Element).classList.contains('markup')) {\n\t\t\t\t\t\t// markdown preview container\n\t\t\t\t\t\tconst preview = (selection.anchorNode?.firstChild as Element);\n\t\t\t\t\t\tconst root = preview.shadowRoot as ShadowRoot & { getSelection: () => Selection };\n\t\t\t\t\t\tconst shadowSelection = root?.getSelection ? root?.getSelection() : null;\n\t\t\t\t\t\t// find the match in the shadow dom by checking the selection inside the shadow dom\n\t\t\t\t\t\tif (shadowSelection && shadowSelection.anchorNode) {\n\t\t\t\t\t\t\tmatches.push({\n\t\t\t\t\t\t\t\ttype: 'preview',\n\t\t\t\t\t\t\t\tid: preview.id,\n\t\t\t\t\t\t\t\tcellId: preview.id,\n\t\t\t\t\t\t\t\tcontainer: preview,\n\t\t\t\t\t\t\t\tisShadow: true,\n\t\t\t\t\t\t\t\toriginalRange: shadowSelection.getRangeAt(0),\n\t\t\t\t\t\t\t\tsearchPreviewInfo: options.shouldGetSearchPreviewInfo ? extractSelectionLine(shadowSelection) : undefined,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Outputs might be rendered inside a shadow DOM.\n\t\t\t\t\tif (options.includeOutput && selection.rangeCount > 0 && selection.getRangeAt(0).startContainer.nodeType === 1\n\t\t\t\t\t\t&& (selection.getRangeAt(0).startContainer as Element).classList.contains('output_container')) {\n\t\t\t\t\t\t// output container\n\t\t\t\t\t\tconst cellId = selection.getRangeAt(0).startContainer.parentElement!.id;\n\t\t\t\t\t\tconst outputNode = (selection.anchorNode?.firstChild as Element);\n\t\t\t\t\t\tconst root = outputNode.shadowRoot as ShadowRoot & { getSelection: () => Selection };\n\t\t\t\t\t\tconst shadowSelection = root?.getSelection ? root?.getSelection() : null;\n\t\t\t\t\t\tif (shadowSelection && shadowSelection.anchorNode) {\n\t\t\t\t\t\t\tmatches.push({\n\t\t\t\t\t\t\t\ttype: 'output',\n\t\t\t\t\t\t\t\tid: outputNode.id,\n\t\t\t\t\t\t\t\tcellId: cellId,\n\t\t\t\t\t\t\t\tcontainer: outputNode,\n\t\t\t\t\t\t\t\tisShadow: true,\n\t\t\t\t\t\t\t\toriginalRange: shadowSelection.getRangeAt(0),\n\t\t\t\t\t\t\t\tsearchPreviewInfo: options.shouldGetSearchPreviewInfo ? extractSelectionLine(shadowSelection) : undefined,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst anchorNode = selection.anchorNode?.parentElement;\n\n\t\t\t\t\tif (anchorNode) {\n\t\t\t\t\t\tconst lastEl: any = matches.length ? matches[matches.length - 1] : null;\n\n\t\t\t\t\t\t// Optimization: avoid searching for the output container\n\t\t\t\t\t\tif (lastEl && lastEl.container.contains(anchorNode) && options.includeOutput) {\n\t\t\t\t\t\t\tmatches.push({\n\t\t\t\t\t\t\t\ttype: lastEl.type,\n\t\t\t\t\t\t\t\tid: lastEl.id,\n\t\t\t\t\t\t\t\tcellId: lastEl.cellId,\n\t\t\t\t\t\t\t\tcontainer: lastEl.container,\n\t\t\t\t\t\t\t\tisShadow: false,\n\t\t\t\t\t\t\t\toriginalRange: selection.getRangeAt(0),\n\t\t\t\t\t\t\t\tsearchPreviewInfo: options.shouldGetSearchPreviewInfo ? extractSelectionLine(selection) : undefined,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Traverse up the DOM to find the container\n\t\t\t\t\t\t\tfor (let node = anchorNode as Element | null; node; node = node.parentElement) {\n\t\t\t\t\t\t\t\tif (!(node instanceof Element)) {\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (node.classList.contains('output') && options.includeOutput) {\n\t\t\t\t\t\t\t\t\t// inside output\n\t\t\t\t\t\t\t\t\tconst cellId = node.parentElement?.parentElement?.id;\n\t\t\t\t\t\t\t\t\tif (cellId) {\n\t\t\t\t\t\t\t\t\t\tmatches.push({\n\t\t\t\t\t\t\t\t\t\t\ttype: 'output',\n\t\t\t\t\t\t\t\t\t\t\tid: node.id,\n\t\t\t\t\t\t\t\t\t\t\tcellId: cellId,\n\t\t\t\t\t\t\t\t\t\t\tcontainer: node,\n\t\t\t\t\t\t\t\t\t\t\tisShadow: false,\n\t\t\t\t\t\t\t\t\t\t\toriginalRange: selection.getRangeAt(0),\n\t\t\t\t\t\t\t\t\t\t\tsearchPreviewInfo: options.shouldGetSearchPreviewInfo ? extractSelectionLine(selection) : undefined,\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (node.id === 'container' || node === window.document.body) {\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t} else {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.log(e);\n\t\t}\n\n\n\t\tmatches = matches.filter(match => options.findIds.length ? options.findIds.includes(match.cellId) : true);\n\t\t_highlighter.addHighlights(matches, options.ownerID);\n\t\twindow.document.getSelection()?.removeAllRanges();\n\n\t\tviewModel.toggleDragDropEnabled(currentOptions.dragAndDropEnabled);\n\n\t\tdocument.designMode = 'Off';\n\n\t\tpostNotebookMessage('didFind', {\n\t\t\tmatches: matches.map((match, index) => ({\n\t\t\t\ttype: match.type,\n\t\t\t\tid: match.id,\n\t\t\t\tcellId: match.cellId,\n\t\t\t\tindex,\n\t\t\t\tsearchPreviewInfo: match.searchPreviewInfo,\n\t\t\t}))\n\t\t});\n\t};\n\n\tconst copyOutputImage = async (outputId: string, altOutputId: string, textAlternates?: { mimeType: string; content: string }[], retries = 5) => {\n\t\tif (!window.document.hasFocus() && retries > 0) {\n\t\t\t// copyImage can be called from outside of the webview, which means this function may be running whilst the webview is gaining focus.\n\t\t\t// Since navigator.clipboard.write requires the document to be focused, we need to wait for focus.\n\t\t\t// We cannot use a listener, as there is a high chance the focus is gained during the setup of the listener resulting in us missing it.\n\t\t\tsetTimeout(() => { copyOutputImage(outputId, altOutputId, textAlternates, retries - 1); }, 50);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst outputElement = window.document.getElementById(outputId)\n\t\t\t\t?? window.document.getElementById(altOutputId);\n\n\t\t\tlet image = outputElement?.querySelector('img');\n\n\t\t\tif (!image) {\n\t\t\t\tconst svgImage = outputElement?.querySelector('svg.output-image') ??\n\t\t\t\t\toutputElement?.querySelector('div.svgContainerStyle > svg');\n\n\t\t\t\tif (svgImage) {\n\t\t\t\t\timage = new Image();\n\t\t\t\t\timage.src = 'data:image/svg+xml,' + encodeURIComponent(svgImage.outerHTML);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (image) {\n\t\t\t\tconst ensureImageLoaded = (img: HTMLImageElement): Promise<HTMLImageElement> => {\n\t\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\t\tif (img.complete && img.naturalWidth > 0) {\n\t\t\t\t\t\t\tresolve(img);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\timg.onload = () => resolve(img);\n\t\t\t\t\t\t\timg.onerror = () => reject(new Error('Failed to load image'));\n\t\t\t\t\t\t\tsetTimeout(() => reject(new Error('Image load timeout')), 5000);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t\tconst imageToCopy = await ensureImageLoaded(image);\n\n\t\t\t\t// Build clipboard data with both image and text formats\n\t\t\t\tconst clipboardData: Record<string, any> = {\n\t\t\t\t\t'image/png': new Promise((resolve) => {\n\t\t\t\t\t\tconst canvas = document.createElement('canvas');\n\t\t\t\t\t\tcanvas.width = imageToCopy.naturalWidth;\n\t\t\t\t\t\tcanvas.height = imageToCopy.naturalHeight;\n\t\t\t\t\t\tconst context = canvas.getContext('2d');\n\t\t\t\t\t\tcontext!.drawImage(imageToCopy, 0, 0);\n\n\t\t\t\t\t\tcanvas.toBlob((blob) => {\n\t\t\t\t\t\t\tif (blob) {\n\t\t\t\t\t\t\t\tresolve(blob);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconsole.error('No blob data to write to clipboard');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcanvas.remove();\n\t\t\t\t\t\t}, 'image/png');\n\t\t\t\t\t})\n\t\t\t\t};\n\n\t\t\t\t// Add text alternates if provided\n\t\t\t\tif (textAlternates) {\n\t\t\t\t\tfor (const alternate of textAlternates) {\n\t\t\t\t\t\tclipboardData[alternate.mimeType] = alternate.content;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tawait navigator.clipboard.write([new ClipboardItem(clipboardData)]);\n\t\t\t} else {\n\t\t\t\tconsole.error('Could not find image element to copy for output with id', outputId);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error('Could not copy image:', e);\n\t\t}\n\t};\n\n\twindow.addEventListener('message', async rawEvent => {\n\t\tconst event = rawEvent as ({ data: webviewMessages.ToWebviewMessage });\n\n\t\tswitch (event.data.type) {\n\t\t\tcase 'initializeMarkup': {\n\t\t\t\ttry {\n\t\t\t\t\tawait Promise.all(event.data.cells.map(info => viewModel.ensureMarkupCell(info)));\n\t\t\t\t} finally {\n\t\t\t\t\tdimensionUpdater.updateImmediately();\n\t\t\t\t\tpostNotebookMessage('initializedMarkup', { requestId: event.data.requestId });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'createMarkupCell':\n\t\t\t\tviewModel.ensureMarkupCell(event.data.cell);\n\t\t\t\tbreak;\n\n\t\t\tcase 'showMarkupCell':\n\t\t\t\tviewModel.showMarkupCell(event.data.id, event.data.top, event.data.content, event.data.metadata);\n\t\t\t\tbreak;\n\n\t\t\tcase 'hideMarkupCells':\n\t\t\t\tfor (const id of event.data.ids) {\n\t\t\t\t\tviewModel.hideMarkupCell(id);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'unhideMarkupCells':\n\t\t\t\tfor (const id of event.data.ids) {\n\t\t\t\t\tviewModel.unhideMarkupCell(id);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'deleteMarkupCell':\n\t\t\t\tfor (const id of event.data.ids) {\n\t\t\t\t\tviewModel.deleteMarkupCell(id);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'updateSelectedMarkupCells':\n\t\t\t\tviewModel.updateSelectedCells(event.data.selectedCellIds);\n\t\t\t\tbreak;\n\n\t\t\tcase 'html': {\n\t\t\t\tconst data = event.data;\n\t\t\t\tif (data.createOnIdle) {\n\t\t\t\t\toutputRunner.enqueueIdle(data.outputId, signal => {\n\t\t\t\t\t\t// cancel the idle callback if it exists\n\t\t\t\t\t\treturn viewModel.renderOutputCell(data, signal);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\toutputRunner.enqueue(data.outputId, signal => {\n\t\t\t\t\t\t// cancel the idle callback if it exists\n\t\t\t\t\t\treturn viewModel.renderOutputCell(data, signal);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'view-scroll':\n\t\t\t\t{\n\t\t\t\t\t// const date = new Date();\n\t\t\t\t\t// console.log('----- will scroll ----  ', date.getMinutes() + ':' + date.getSeconds() + ':' + date.getMilliseconds());\n\n\t\t\t\t\tevent.data.widgets.forEach(widget => {\n\t\t\t\t\t\toutputRunner.enqueue(widget.outputId, () => {\n\t\t\t\t\t\t\tviewModel.updateOutputsScroll([widget]);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tviewModel.updateMarkupScrolls(event.data.markupCells);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\tcase 'clear':\n\t\t\t\trenderers.clearAll();\n\t\t\t\tviewModel.clearAll();\n\t\t\t\twindow.document.getElementById('container')!.innerText = '';\n\t\t\t\tbreak;\n\n\t\t\tcase 'clearOutput': {\n\t\t\t\tconst { cellId, rendererId, outputId } = event.data;\n\t\t\t\toutputRunner.cancelOutput(outputId);\n\t\t\t\tviewModel.clearOutput(cellId, outputId, rendererId);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'hideOutput': {\n\t\t\t\tconst { cellId, outputId } = event.data;\n\t\t\t\toutputRunner.enqueue(outputId, () => {\n\t\t\t\t\tviewModel.hideOutput(cellId);\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'showOutput': {\n\t\t\t\tconst { outputId, cellTop, cellId, content } = event.data;\n\t\t\t\toutputRunner.enqueue(outputId, () => {\n\t\t\t\t\tviewModel.showOutput(cellId, outputId, cellTop);\n\t\t\t\t\tif (content) {\n\t\t\t\t\t\tviewModel.updateAndRerender(cellId, outputId, content);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'copyImage': {\n\t\t\t\tawait copyOutputImage(event.data.outputId, event.data.altOutputId, event.data.textAlternates);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'ack-dimension': {\n\t\t\t\tfor (const { cellId, outputId, height } of event.data.updates) {\n\t\t\t\t\tviewModel.updateOutputHeight(cellId, outputId, height);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'preload': {\n\t\t\t\tconst resources = event.data.resources;\n\t\t\t\tfor (const { uri } of resources) {\n\t\t\t\t\tkernelPreloads.load(uri);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'updateRenderers': {\n\t\t\t\tconst { rendererData } = event.data;\n\t\t\t\trenderers.updateRendererData(rendererData);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'focus-output':\n\t\t\t\tfocusFirstFocusableOrContainerInOutput(event.data.cellOrOutputId, event.data.alternateId);\n\t\t\t\tbreak;\n\t\t\tcase 'blur-output':\n\t\t\t\tblurOutput();\n\t\t\t\tbreak;\n\t\t\tcase 'select-output-contents':\n\t\t\t\tselectOutputContents(event.data.cellOrOutputId);\n\t\t\t\tbreak;\n\t\t\tcase 'select-input-contents':\n\t\t\t\tselectInputContents(event.data.cellOrOutputId);\n\t\t\t\tbreak;\n\t\t\tcase 'decorations': {\n\t\t\t\tlet outputContainer = window.document.getElementById(event.data.cellId);\n\t\t\t\tif (!outputContainer) {\n\t\t\t\t\tviewModel.ensureOutputCell(event.data.cellId, -100000, true);\n\t\t\t\t\toutputContainer = window.document.getElementById(event.data.cellId);\n\t\t\t\t}\n\t\t\t\toutputContainer?.classList.add(...event.data.addedClassNames);\n\t\t\t\toutputContainer?.classList.remove(...event.data.removedClassNames);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'markupDecorations': {\n\t\t\t\tconst markupCell = window.document.getElementById(event.data.cellId);\n\t\t\t\t// The cell may not have been added yet if it is out of view.\n\t\t\t\t// Decorations will be added when the cell is shown.\n\t\t\t\tif (markupCell) {\n\t\t\t\t\tmarkupCell?.classList.add(...event.data.addedClassNames);\n\t\t\t\t\tmarkupCell?.classList.remove(...event.data.removedClassNames);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'customKernelMessage':\n\t\t\t\tonDidReceiveKernelMessage.fire(event.data.message);\n\t\t\t\tbreak;\n\t\t\tcase 'customRendererMessage':\n\t\t\t\trenderers.getRenderer(event.data.rendererId)?.receiveMessage(event.data.message);\n\t\t\t\tbreak;\n\t\t\tcase 'notebookStyles': {\n\t\t\t\tconst documentStyle = window.document.documentElement.style;\n\n\t\t\t\tfor (let i = documentStyle.length - 1; i >= 0; i--) {\n\t\t\t\t\tconst property = documentStyle[i];\n\n\t\t\t\t\t// Don't remove properties that the webview might have added separately\n\t\t\t\t\tif (property && property.startsWith('--notebook-')) {\n\t\t\t\t\t\tdocumentStyle.removeProperty(property);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Re-add new properties\n\t\t\t\tfor (const [name, value] of Object.entries(event.data.styles)) {\n\t\t\t\t\tdocumentStyle.setProperty(`--${name}`, value);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'notebookOptions':\n\t\t\t\tcurrentOptions = event.data.options;\n\t\t\t\tviewModel.toggleDragDropEnabled(currentOptions.dragAndDropEnabled);\n\t\t\t\tcurrentRenderOptions = event.data.renderOptions;\n\t\t\t\tsettingChange.fire(currentRenderOptions);\n\t\t\t\tbreak;\n\t\t\tcase 'tokenizedCodeBlock': {\n\t\t\t\tconst { codeBlockId, html } = event.data;\n\t\t\t\tMarkdownCodeBlock.highlightCodeBlock(codeBlockId, html);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'tokenizedStylesChanged': {\n\t\t\t\ttokenizationStyle.replaceSync(event.data.css);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'find': {\n\t\t\t\t_highlighter.removeHighlights(event.data.options.ownerID);\n\t\t\t\tfind(event.data.query, event.data.options);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'findHighlightCurrent': {\n\t\t\t\t_highlighter?.highlightCurrentMatch(event.data.index, event.data.ownerID);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'findUnHighlightCurrent': {\n\t\t\t\t_highlighter?.unHighlightCurrentMatch(event.data.index, event.data.ownerID);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'findStop': {\n\t\t\t\t_highlighter.removeHighlights(event.data.ownerID);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'returnOutputItem': {\n\t\t\t\toutputItemRequests.resolveOutputItem(event.data.requestId, event.data.output);\n\t\t\t}\n\t\t}\n\t});\n\n\tconst renderFallbackErrorName = 'vscode.fallbackToNextRenderer';\n\n\tclass Renderer {\n\n\t\tprivate _onMessageEvent = createEmitter();\n\t\tprivate _loadPromise?: Promise<rendererApi.RendererApi | undefined>;\n\t\tprivate _api: rendererApi.RendererApi | undefined;\n\n\t\tconstructor(\n\t\t\tpublic readonly data: webviewMessages.RendererMetadata,\n\t\t) { }\n\n\t\tpublic receiveMessage(message: unknown) {\n\t\t\tthis._onMessageEvent.fire(message);\n\t\t}\n\n\t\tpublic async renderOutputItem(item: rendererApi.OutputItem, element: HTMLElement, signal: AbortSignal): Promise<void> {\n\t\t\ttry {\n\t\t\t\tawait this.load();\n\t\t\t} catch (e) {\n\t\t\t\tif (!signal.aborted) {\n\t\t\t\t\tshowRenderError(`Error loading renderer '${this.data.id}'`, element, e instanceof Error ? [e] : []);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this._api) {\n\t\t\t\tif (!signal.aborted) {\n\t\t\t\t\tshowRenderError(`Renderer '${this.data.id}' does not implement renderOutputItem`, element, []);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst renderStart = performance.now();\n\t\t\t\tawait this._api.renderOutputItem(item, element, signal);\n\t\t\t\tthis.postDebugMessage('Rendered output item', { id: item.id, duration: `${performance.now() - renderStart}ms` });\n\n\t\t\t} catch (e) {\n\t\t\t\tif (signal.aborted) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (e instanceof Error && e.name === renderFallbackErrorName) {\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\n\t\t\t\tshowRenderError(`Error rendering output item using '${this.data.id}'`, element, e instanceof Error ? [e] : []);\n\t\t\t\tthis.postDebugMessage('Rendering output item failed', { id: item.id, error: e + '' });\n\t\t\t}\n\t\t}\n\n\t\tpublic disposeOutputItem(id?: string): void {\n\t\t\tthis._api?.disposeOutputItem?.(id);\n\t\t}\n\n\t\tprivate createRendererContext(): RendererContext {\n\t\t\tconst { id, messaging } = this.data;\n\t\t\tconst context: RendererContext = {\n\t\t\t\tsetState: newState => vscode.setState({ ...vscode.getState(), [id]: newState }),\n\t\t\t\tgetState: <T>() => {\n\t\t\t\t\tconst state = vscode.getState();\n\t\t\t\t\treturn typeof state === 'object' && state ? state[id] as T : undefined;\n\t\t\t\t},\n\t\t\t\tgetRenderer: async (id: string) => {\n\t\t\t\t\tconst renderer = renderers.getRenderer(id);\n\t\t\t\t\tif (!renderer) {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t\tif (renderer._api) {\n\t\t\t\t\t\treturn renderer._api;\n\t\t\t\t\t}\n\t\t\t\t\treturn renderer.load();\n\t\t\t\t},\n\t\t\t\tworkspace: {\n\t\t\t\t\tget isTrusted() { return isWorkspaceTrusted; }\n\t\t\t\t},\n\t\t\t\tsettings: {\n\t\t\t\t\tget lineLimit() { return currentRenderOptions.lineLimit; },\n\t\t\t\t\tget outputScrolling() { return currentRenderOptions.outputScrolling; },\n\t\t\t\t\tget outputWordWrap() { return currentRenderOptions.outputWordWrap; },\n\t\t\t\t\tget linkifyFilePaths() { return currentRenderOptions.linkifyFilePaths; },\n\t\t\t\t\tget minimalError() { return currentRenderOptions.minimalError; },\n\t\t\t\t},\n\t\t\t\tget onDidChangeSettings() { return settingChange.event; }\n\t\t\t};\n\n\t\t\tif (messaging) {\n\t\t\t\tcontext.onDidReceiveMessage = this._onMessageEvent.event;\n\t\t\t\tcontext.postMessage = message => postNotebookMessage('customRendererMessage', { rendererId: id, message });\n\t\t\t}\n\n\t\t\treturn Object.freeze(context);\n\t\t}\n\n\t\tprivate load(): Promise<rendererApi.RendererApi | undefined> {\n\t\t\tthis._loadPromise ??= this._load();\n\t\t\treturn this._loadPromise;\n\t\t}\n\n\t\t/** Inner function cached in the _loadPromise(). */\n\t\tprivate async _load(): Promise<rendererApi.RendererApi | undefined> {\n\t\t\tthis.postDebugMessage('Start loading renderer');\n\n\t\t\ttry {\n\t\t\t\t// Preloads need to be loaded before loading renderers.\n\t\t\t\tawait kernelPreloads.waitForAllCurrent();\n\n\t\t\t\tconst importStart = performance.now();\n\t\t\t\tconst module: RendererModule = await __import(this.data.entrypoint.path);\n\t\t\t\tthis.postDebugMessage('Imported renderer', { duration: `${performance.now() - importStart}ms` });\n\n\t\t\t\tif (!module) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis._api = await module.activate(this.createRendererContext());\n\t\t\t\tthis.postDebugMessage('Activated renderer', { duration: `${performance.now() - importStart}ms` });\n\n\t\t\t\tconst dependantRenderers = ctx.rendererData\n\t\t\t\t\t.filter(d => d.entrypoint.extends === this.data.id);\n\n\t\t\t\tif (dependantRenderers.length) {\n\t\t\t\t\tthis.postDebugMessage('Activating dependant renderers', { dependents: dependantRenderers.map(x => x.id).join(', ') });\n\t\t\t\t}\n\n\t\t\t\t// Load all renderers that extend this renderer\n\t\t\t\tawait Promise.all(dependantRenderers.map(async d => {\n\t\t\t\t\tconst renderer = renderers.getRenderer(d.id);\n\t\t\t\t\tif (!renderer) {\n\t\t\t\t\t\tthrow new Error(`Could not find extending renderer: ${d.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn await renderer.load();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t// Squash any errors extends errors. They won't prevent the renderer\n\t\t\t\t\t\t// itself from working, so just log them.\n\t\t\t\t\t\tconsole.error(e);\n\t\t\t\t\t\tthis.postDebugMessage('Activating dependant renderer failed', { dependent: d.id, error: e + '' });\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t}));\n\n\t\t\t\treturn this._api;\n\t\t\t} catch (e) {\n\t\t\t\tthis.postDebugMessage('Loading renderer failed');\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\n\t\tprivate postDebugMessage(msg: string, data?: Record<string, string>) {\n\t\t\tpostNotebookMessage<webviewMessages.ILogRendererDebugMessage>('logRendererDebugMessage', {\n\t\t\t\tmessage: `[renderer ${this.data.id}] - ${msg}`,\n\t\t\t\tdata\n\t\t\t});\n\t\t}\n\t}\n\n\tconst kernelPreloads = new class {\n\t\tprivate readonly preloads = new Map<string /* uri */, Promise<unknown>>();\n\n\t\t/**\n\t\t * Returns a promise that resolves when the given preload is activated.\n\t\t */\n\t\tpublic waitFor(uri: string) {\n\t\t\treturn this.preloads.get(uri) || Promise.resolve(new Error(`Preload not ready: ${uri}`));\n\t\t}\n\n\t\t/**\n\t\t * Loads a preload.\n\t\t * @param uri URI to load from\n\t\t * @param originalUri URI to show in an error message if the preload is invalid.\n\t\t */\n\t\tpublic load(uri: string) {\n\t\t\tconst promise = Promise.all([\n\t\t\t\trunKernelPreload(uri),\n\t\t\t\tthis.waitForAllCurrent(),\n\t\t\t]);\n\n\t\t\tthis.preloads.set(uri, promise);\n\t\t\treturn promise;\n\t\t}\n\n\t\t/**\n\t\t * Returns a promise that waits for all currently-registered preloads to\n\t\t * activate before resolving.\n\t\t */\n\t\tpublic waitForAllCurrent() {\n\t\t\treturn Promise.all([...this.preloads.values()].map(p => p.catch(err => err)));\n\t\t}\n\t};\n\n\tconst outputRunner = new class {\n\t\tprivate readonly outputs = new Map<string, { abort: AbortController; queue: Promise<unknown> }>();\n\n\t\t/**\n\t\t * Pushes the action onto the list of actions for the given output ID,\n\t\t * ensuring that it's run in-order.\n\t\t */\n\t\tpublic enqueue(outputId: string, action: (cancelSignal: AbortSignal) => unknown) {\n\t\t\tthis.pendingOutputCreationRequest.get(outputId)?.dispose();\n\t\t\tthis.pendingOutputCreationRequest.delete(outputId);\n\n\t\t\tconst record = this.outputs.get(outputId);\n\t\t\tif (!record) {\n\t\t\t\tconst controller = new AbortController();\n\t\t\t\tthis.outputs.set(outputId, { abort: controller, queue: new Promise(r => r(action(controller.signal))) });\n\t\t\t} else {\n\t\t\t\trecord.queue = record.queue.then(async r => {\n\t\t\t\t\tif (!record.abort.signal.aborted) {\n\t\t\t\t\t\tawait action(record.abort.signal);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tprivate pendingOutputCreationRequest: Map<string, IDisposable> = new Map();\n\n\t\tpublic enqueueIdle(outputId: string, action: (cancelSignal: AbortSignal) => unknown) {\n\t\t\tthis.pendingOutputCreationRequest.get(outputId)?.dispose();\n\t\t\toutputRunner.pendingOutputCreationRequest.set(outputId, runWhenIdle(() => {\n\t\t\t\toutputRunner.enqueue(outputId, action);\n\t\t\t\toutputRunner.pendingOutputCreationRequest.delete(outputId);\n\t\t\t}));\n\t\t}\n\n\t\t/**\n\t\t * Cancels the rendering of all outputs.\n\t\t */\n\t\tpublic cancelAll() {\n\t\t\t// Delete all pending idle requests\n\t\t\tthis.pendingOutputCreationRequest.forEach(r => r.dispose());\n\t\t\tthis.pendingOutputCreationRequest.clear();\n\n\t\t\tfor (const { abort } of this.outputs.values()) {\n\t\t\t\tabort.abort();\n\t\t\t}\n\t\t\tthis.outputs.clear();\n\t\t}\n\n\t\t/**\n\t\t * Cancels any ongoing rendering out an output.\n\t\t */\n\t\tpublic cancelOutput(outputId: string) {\n\t\t\t// Delete the pending idle request if it exists\n\t\t\tthis.pendingOutputCreationRequest.get(outputId)?.dispose();\n\t\t\tthis.pendingOutputCreationRequest.delete(outputId);\n\n\t\t\tconst output = this.outputs.get(outputId);\n\t\t\tif (output) {\n\t\t\t\toutput.abort.abort();\n\t\t\t\tthis.outputs.delete(outputId);\n\t\t\t}\n\t\t}\n\t};\n\n\tconst renderers = new class {\n\t\tprivate readonly _renderers = new Map</* id */ string, Renderer>();\n\n\t\tconstructor() {\n\t\t\tfor (const renderer of ctx.rendererData) {\n\t\t\t\tthis.addRenderer(renderer);\n\t\t\t}\n\t\t}\n\n\t\tpublic getRenderer(id: string): Renderer | undefined {\n\t\t\treturn this._renderers.get(id);\n\t\t}\n\n\t\tprivate rendererEqual(a: webviewMessages.RendererMetadata, b: webviewMessages.RendererMetadata) {\n\t\t\tif (a.id !== b.id || a.entrypoint.path !== b.entrypoint.path || a.entrypoint.extends !== b.entrypoint.extends || a.messaging !== b.messaging) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (a.mimeTypes.length !== b.mimeTypes.length) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tfor (let i = 0; i < a.mimeTypes.length; i++) {\n\t\t\t\tif (a.mimeTypes[i] !== b.mimeTypes[i]) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\n\t\tpublic updateRendererData(rendererData: readonly webviewMessages.RendererMetadata[]) {\n\t\t\tconst oldKeys = new Set(this._renderers.keys());\n\t\t\tconst newKeys = new Set(rendererData.map(d => d.id));\n\n\t\t\tfor (const renderer of rendererData) {\n\t\t\t\tconst existing = this._renderers.get(renderer.id);\n\t\t\t\tif (existing && this.rendererEqual(existing.data, renderer)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.addRenderer(renderer);\n\t\t\t}\n\n\t\t\tfor (const key of oldKeys) {\n\t\t\t\tif (!newKeys.has(key)) {\n\t\t\t\t\tthis._renderers.delete(key);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tprivate addRenderer(renderer: webviewMessages.RendererMetadata) {\n\t\t\tthis._renderers.set(renderer.id, new Renderer(renderer));\n\t\t}\n\n\t\tpublic clearAll() {\n\t\t\toutputRunner.cancelAll();\n\t\t\tfor (const renderer of this._renderers.values()) {\n\t\t\t\trenderer.disposeOutputItem();\n\t\t\t}\n\t\t}\n\n\t\tpublic clearOutput(rendererId: string, outputId: string) {\n\t\t\toutputRunner.cancelOutput(outputId);\n\t\t\tthis._renderers.get(rendererId)?.disposeOutputItem(outputId);\n\t\t}\n\n\t\tpublic async render(item: ExtendedOutputItem, preferredRendererId: string | undefined, element: HTMLElement, signal: AbortSignal): Promise<void> {\n\t\t\tconst primaryRenderer = this.findRenderer(preferredRendererId, item);\n\t\t\tif (!primaryRenderer) {\n\t\t\t\tconst errorMessage = (window.document.documentElement.style.getPropertyValue('--notebook-cell-renderer-not-found-error') || '').replace('$0', () => item.mime);\n\t\t\t\tthis.showRenderError(item, element, errorMessage);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Try primary renderer first\n\t\t\tif (!(await this._doRender(item, element, primaryRenderer, signal)).continue) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Primary renderer failed in an expected way. Fallback to render the next mime types\n\t\t\tfor (const additionalItemData of item._allOutputItems) {\n\t\t\t\tif (additionalItemData.mime === item.mime) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst additionalItem = await additionalItemData.getItem();\n\t\t\t\tif (signal.aborted) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (additionalItem) {\n\t\t\t\t\tconst renderer = this.findRenderer(undefined, additionalItem);\n\t\t\t\t\tif (renderer) {\n\t\t\t\t\t\tif (!(await this._doRender(additionalItem, element, renderer, signal)).continue) {\n\t\t\t\t\t\t\treturn; // We rendered successfully\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// All renderers have failed and there is nothing left to fallback to\n\t\t\tconst errorMessage = (window.document.documentElement.style.getPropertyValue('--notebook-cell-renderer-fallbacks-exhausted') || '').replace('$0', () => item.mime);\n\t\t\tthis.showRenderError(item, element, errorMessage);\n\t\t}\n\n\t\tprivate async _doRender(item: rendererApi.OutputItem, element: HTMLElement, renderer: Renderer, signal: AbortSignal): Promise<{ continue: boolean }> {\n\t\t\ttry {\n\t\t\t\tawait renderer.renderOutputItem(item, element, signal);\n\t\t\t\treturn { continue: false }; // We rendered successfully\n\t\t\t} catch (e) {\n\t\t\t\tif (signal.aborted) {\n\t\t\t\t\treturn { continue: false };\n\t\t\t\t}\n\n\t\t\t\tif (e instanceof Error && e.name === renderFallbackErrorName) {\n\t\t\t\t\treturn { continue: true };\n\t\t\t\t} else {\n\t\t\t\t\tthrow e; // Bail and let callers handle unknown errors\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tprivate findRenderer(preferredRendererId: string | undefined, info: rendererApi.OutputItem) {\n\t\t\tlet renderer: Renderer | undefined;\n\n\t\t\tif (typeof preferredRendererId === 'string') {\n\t\t\t\trenderer = Array.from(this._renderers.values())\n\t\t\t\t\t.find((renderer) => renderer.data.id === preferredRendererId);\n\t\t\t} else {\n\t\t\t\tconst renderers = Array.from(this._renderers.values())\n\t\t\t\t\t.filter((renderer) => renderer.data.mimeTypes.includes(info.mime) && !renderer.data.entrypoint.extends);\n\n\t\t\t\tif (renderers.length) {\n\t\t\t\t\t// De-prioritize built-in renderers\n\t\t\t\t\trenderers.sort((a, b) => +a.data.isBuiltin - +b.data.isBuiltin);\n\n\t\t\t\t\t// Use first renderer we find in sorted list\n\t\t\t\t\trenderer = renderers[0];\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn renderer;\n\t\t}\n\n\t\tprivate showRenderError(info: rendererApi.OutputItem, element: HTMLElement, errorMessage: string) {\n\t\t\tconst errorContainer = document.createElement('div');\n\n\t\t\tconst error = document.createElement('div');\n\t\t\terror.className = 'no-renderer-error';\n\t\t\terror.innerText = errorMessage;\n\n\t\t\tconst cellText = document.createElement('div');\n\t\t\tcellText.innerText = info.text();\n\n\t\t\terrorContainer.appendChild(error);\n\t\t\terrorContainer.appendChild(cellText);\n\n\t\t\telement.innerText = '';\n\t\t\telement.appendChild(errorContainer);\n\t\t}\n\t}();\n\n\tconst viewModel = new class ViewModel {\n\n\t\tprivate readonly _markupCells = new Map<string, MarkupCell>();\n\t\tprivate readonly _outputCells = new Map<string, OutputCell>();\n\n\t\tpublic clearAll() {\n\t\t\tfor (const cell of this._markupCells.values()) {\n\t\t\t\tcell.dispose();\n\t\t\t}\n\t\t\tthis._markupCells.clear();\n\n\t\t\tfor (const output of this._outputCells.values()) {\n\t\t\t\toutput.dispose();\n\t\t\t}\n\t\t\tthis._outputCells.clear();\n\t\t}\n\n\t\tprivate async createMarkupCell(init: webviewMessages.IMarkupCellInitialization, top: number, visible: boolean): Promise<MarkupCell> {\n\t\t\tconst existing = this._markupCells.get(init.cellId);\n\t\t\tif (existing) {\n\t\t\t\tconsole.error(`Trying to create markup that already exists: ${init.cellId}`);\n\t\t\t\treturn existing;\n\t\t\t}\n\n\t\t\tconst cell = new MarkupCell(init.cellId, init.mime, init.content, top, init.metadata);\n\t\t\tcell.element.style.visibility = visible ? '' : 'hidden';\n\t\t\tthis._markupCells.set(init.cellId, cell);\n\n\t\t\tawait cell.ready;\n\t\t\treturn cell;\n\t\t}\n\n\t\tpublic async ensureMarkupCell(info: webviewMessages.IMarkupCellInitialization): Promise<void> {\n\t\t\tlet cell = this._markupCells.get(info.cellId);\n\t\t\tif (cell) {\n\t\t\t\tcell.element.style.visibility = info.visible ? '' : 'hidden';\n\t\t\t\tawait cell.updateContentAndRender(info.content, info.metadata);\n\t\t\t} else {\n\t\t\t\tcell = await this.createMarkupCell(info, info.offset, info.visible);\n\t\t\t}\n\t\t}\n\n\t\tpublic deleteMarkupCell(id: string) {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tif (cell) {\n\t\t\t\tcell.remove();\n\t\t\t\tcell.dispose();\n\t\t\t\tthis._markupCells.delete(id);\n\t\t\t}\n\t\t}\n\n\t\tpublic async updateMarkupContent(id: string, newContent: string, metadata: NotebookCellMetadata): Promise<void> {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tawait cell?.updateContentAndRender(newContent, metadata);\n\t\t}\n\n\t\tpublic showMarkupCell(id: string, top: number, newContent: string | undefined, metadata: NotebookCellMetadata | undefined): void {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tcell?.show(top, newContent, metadata);\n\t\t}\n\n\t\tpublic hideMarkupCell(id: string): void {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tcell?.hide();\n\t\t}\n\n\t\tpublic unhideMarkupCell(id: string): void {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tcell?.unhide();\n\t\t}\n\n\t\tprivate getExpectedMarkupCell(id: string): MarkupCell | undefined {\n\t\t\tconst cell = this._markupCells.get(id);\n\t\t\tif (!cell) {\n\t\t\t\tconsole.log(`Could not find markup cell '${id}'`);\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\treturn cell;\n\t\t}\n\n\t\tpublic updateSelectedCells(selectedCellIds: readonly string[]) {\n\t\t\tconst selectedCellSet = new Set<string>(selectedCellIds);\n\t\t\tfor (const cell of this._markupCells.values()) {\n\t\t\t\tcell.setSelected(selectedCellSet.has(cell.id));\n\t\t\t}\n\t\t}\n\n\t\tpublic toggleDragDropEnabled(dragAndDropEnabled: boolean) {\n\t\t\tfor (const cell of this._markupCells.values()) {\n\t\t\t\tcell.toggleDragDropEnabled(dragAndDropEnabled);\n\t\t\t}\n\t\t}\n\n\t\tpublic updateMarkupScrolls(markupCells: readonly webviewMessages.IMarkupCellScrollTops[]) {\n\t\t\tfor (const { id, top } of markupCells) {\n\t\t\t\tconst cell = this._markupCells.get(id);\n\t\t\t\tif (cell) {\n\t\t\t\t\tcell.element.style.top = `${top}px`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpublic async renderOutputCell(data: webviewMessages.ICreationRequestMessage, signal: AbortSignal): Promise<void> {\n\t\t\tconst preloadErrors = await Promise.all<undefined | Error>(\n\t\t\t\tdata.requiredPreloads.map(p => kernelPreloads.waitFor(p.uri).then(() => undefined, err => err))\n\t\t\t);\n\t\t\tif (signal.aborted) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst cellOutput = this.ensureOutputCell(data.cellId, data.cellTop, false);\n\t\t\treturn cellOutput.renderOutputElement(data, preloadErrors, signal);\n\t\t}\n\n\t\tpublic ensureOutputCell(cellId: string, cellTop: number, skipCellTopUpdateIfExist: boolean): OutputCell {\n\t\t\tlet cell = this._outputCells.get(cellId);\n\t\t\tconst existed = !!cell;\n\t\t\tif (!cell) {\n\t\t\t\tcell = new OutputCell(cellId);\n\t\t\t\tthis._outputCells.set(cellId, cell);\n\t\t\t}\n\n\t\t\tif (existed && skipCellTopUpdateIfExist) {\n\t\t\t\treturn cell;\n\t\t\t}\n\n\t\t\tcell.element.style.top = cellTop + 'px';\n\t\t\treturn cell;\n\t\t}\n\n\t\tpublic clearOutput(cellId: string, outputId: string, rendererId: string | undefined) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.clearOutput(outputId, rendererId);\n\t\t}\n\n\t\tpublic showOutput(cellId: string, outputId: string, top: number) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.show(outputId, top);\n\t\t}\n\n\t\tpublic updateAndRerender(cellId: string, outputId: string, content: webviewMessages.ICreationContent) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.updateContentAndRerender(outputId, content);\n\t\t}\n\n\t\tpublic hideOutput(cellId: string) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.hide();\n\t\t}\n\n\t\tpublic updateOutputHeight(cellId: string, outputId: string, height: number) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.updateOutputHeight(outputId, height);\n\t\t}\n\n\t\tpublic updateOutputsScroll(updates: webviewMessages.IContentWidgetTopRequest[]) {\n\t\t\tfor (const request of updates) {\n\t\t\t\tconst cell = this._outputCells.get(request.cellId);\n\t\t\t\tcell?.updateScroll(request);\n\t\t\t}\n\t\t}\n\t}();\n\n\tclass MarkdownCodeBlock {\n\t\tprivate static pendingCodeBlocksToHighlight = new Map<string, HTMLElement>();\n\n\t\tpublic static highlightCodeBlock(id: string, html: string) {\n\t\t\tconst el = MarkdownCodeBlock.pendingCodeBlocksToHighlight.get(id);\n\t\t\tif (!el) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst trustedHtml = ttPolicy?.createHTML(html) ?? html;\n\t\t\tel.innerHTML = trustedHtml as string; // CodeQL [SM03712] The rendered content comes from VS Code's tokenizer and is considered safe\n\t\t\tconst root = el.getRootNode();\n\t\t\tif (root instanceof ShadowRoot) {\n\t\t\t\tif (!root.adoptedStyleSheets.includes(tokenizationStyle)) {\n\t\t\t\t\troot.adoptedStyleSheets.push(tokenizationStyle);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpublic static requestHighlightCodeBlock(root: HTMLElement | ShadowRoot) {\n\t\t\tconst codeBlocks: Array<{ value: string; lang: string; id: string }> = [];\n\t\t\tlet i = 0;\n\t\t\tfor (const el of root.querySelectorAll('.vscode-code-block')) {\n\t\t\t\tconst lang = el.getAttribute('data-vscode-code-block-lang');\n\t\t\t\tif (el.textContent && lang) {\n\t\t\t\t\tconst id = `${Date.now()}-${i++}`;\n\t\t\t\t\tcodeBlocks.push({ value: el.textContent, lang: lang, id });\n\t\t\t\t\tMarkdownCodeBlock.pendingCodeBlocksToHighlight.set(id, el as HTMLElement);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn codeBlocks;\n\t\t}\n\t}\n\n\tclass MarkupCell {\n\n\t\tpublic readonly ready: Promise<void>;\n\n\t\tpublic readonly id: string;\n\t\tpublic readonly element: HTMLElement;\n\n\t\tprivate readonly outputItem: ExtendedOutputItem;\n\n\t\t/// Internal field that holds text content\n\t\tprivate _content: { readonly value: string; readonly version: number; readonly metadata: NotebookCellMetadata };\n\n\t\tprivate _isDisposed = false;\n\t\tprivate renderTaskAbort?: AbortController;\n\n\t\tconstructor(id: string, mime: string, content: string, top: number, metadata: NotebookCellMetadata) {\n\t\t\tconst self = this;\n\t\t\tthis.id = id;\n\t\t\tthis._content = { value: content, version: 0, metadata: metadata };\n\n\t\t\tconst { promise, resolve, reject } = promiseWithResolvers<void>();\n\t\t\tthis.ready = promise;\n\n\t\t\tlet cachedData: { readonly version: number; readonly value: Uint8Array } | undefined;\n\t\t\tthis.outputItem = Object.freeze<ExtendedOutputItem>({\n\t\t\t\tid,\n\t\t\t\tmime,\n\n\t\t\t\tget metadata(): NotebookCellMetadata {\n\t\t\t\t\treturn self._content.metadata;\n\t\t\t\t},\n\n\t\t\t\ttext: (): string => {\n\t\t\t\t\treturn this._content.value;\n\t\t\t\t},\n\n\t\t\t\tjson: () => {\n\t\t\t\t\treturn undefined;\n\t\t\t\t},\n\n\t\t\t\tdata: (): Uint8Array => {\n\t\t\t\t\tif (cachedData?.version === this._content.version) {\n\t\t\t\t\t\treturn cachedData.value;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst data = textEncoder.encode(this._content.value);\n\t\t\t\t\tcachedData = { version: this._content.version, value: data };\n\t\t\t\t\treturn data;\n\t\t\t\t},\n\n\t\t\t\tblob(): Blob {\n\t\t\t\t\treturn new Blob([this.data() as Uint8Array<ArrayBuffer>], { type: this.mime });\n\t\t\t\t},\n\n\t\t\t\t_allOutputItems: [{\n\t\t\t\t\tmime,\n\t\t\t\t\tgetItem: async () => this.outputItem,\n\t\t\t\t}]\n\t\t\t});\n\n\t\t\tconst root = window.document.getElementById('container')!;\n\t\t\tconst markupCell = document.createElement('div');\n\t\t\tmarkupCell.className = 'markup';\n\t\t\tmarkupCell.style.position = 'absolute';\n\t\t\tmarkupCell.style.width = '100%';\n\n\t\t\tthis.element = document.createElement('div');\n\t\t\tthis.element.id = this.id;\n\t\t\tthis.element.classList.add('preview');\n\t\t\tthis.element.style.position = 'absolute';\n\t\t\tthis.element.style.top = top + 'px';\n\t\t\tthis.toggleDragDropEnabled(currentOptions.dragAndDropEnabled);\n\t\t\tmarkupCell.appendChild(this.element);\n\t\t\troot.appendChild(markupCell);\n\n\t\t\tthis.addEventListeners();\n\n\t\t\tthis.updateContentAndRender(this._content.value, this._content.metadata).then(() => {\n\t\t\t\tif (!this._isDisposed) {\n\t\t\t\t\tresizeObserver.observe(this.element, this.id, false, this.id);\n\t\t\t\t}\n\t\t\t\tresolve();\n\t\t\t}, () => reject());\n\t\t}\n\n\t\tpublic dispose() {\n\t\t\tthis._isDisposed = true;\n\t\t\tthis.renderTaskAbort?.abort();\n\t\t\tthis.renderTaskAbort = undefined;\n\t\t}\n\n\t\tprivate addEventListeners() {\n\t\t\tthis.element.addEventListener('dblclick', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IToggleMarkupPreviewMessage>('toggleMarkupPreview', { cellId: this.id });\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('click', e => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IClickMarkupCellMessage>('clickMarkupCell', {\n\t\t\t\t\tcellId: this.id,\n\t\t\t\t\taltKey: e.altKey,\n\t\t\t\t\tctrlKey: e.ctrlKey,\n\t\t\t\t\tmetaKey: e.metaKey,\n\t\t\t\t\tshiftKey: e.shiftKey,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('contextmenu', e => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IContextMenuMarkupCellMessage>('contextMenuMarkupCell', {\n\t\t\t\t\tcellId: this.id,\n\t\t\t\t\tclientX: e.clientX,\n\t\t\t\t\tclientY: e.clientY,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('mouseenter', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IMouseEnterMarkupCellMessage>('mouseEnterMarkupCell', { cellId: this.id });\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('mouseleave', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IMouseLeaveMarkupCellMessage>('mouseLeaveMarkupCell', { cellId: this.id });\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('dragstart', e => {\n\t\t\t\tmarkupCellDragManager.startDrag(e, this.id);\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('drag', e => {\n\t\t\t\tmarkupCellDragManager.updateDrag(e, this.id);\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('dragend', e => {\n\t\t\t\tmarkupCellDragManager.endDrag(e, this.id);\n\t\t\t});\n\t\t}\n\n\t\tpublic async updateContentAndRender(newContent: string, metadata: NotebookCellMetadata): Promise<void> {\n\t\t\tthis._content = { value: newContent, version: this._content.version + 1, metadata };\n\n\t\t\tthis.renderTaskAbort?.abort();\n\n\t\t\tconst controller = new AbortController();\n\t\t\tthis.renderTaskAbort = controller;\n\t\t\ttry {\n\t\t\t\tawait renderers.render(this.outputItem, undefined, this.element, this.renderTaskAbort.signal);\n\t\t\t} finally {\n\t\t\t\tif (this.renderTaskAbort === controller) {\n\t\t\t\t\tthis.renderTaskAbort = undefined;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst root = (this.element.shadowRoot ?? this.element);\n\t\t\tconst html = [];\n\t\t\tfor (const child of root.children) {\n\t\t\t\tswitch (child.tagName) {\n\t\t\t\t\tcase 'LINK':\n\t\t\t\t\tcase 'SCRIPT':\n\t\t\t\t\tcase 'STYLE':\n\t\t\t\t\t\t// not worth sending over since it will be stripped before rendering\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\thtml.push(child.outerHTML);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst codeBlocks: Array<{ value: string; lang: string; id: string }> = MarkdownCodeBlock.requestHighlightCodeBlock(root);\n\n\t\t\tpostNotebookMessage<webviewMessages.IRenderedMarkupMessage>('renderedMarkup', {\n\t\t\t\tcellId: this.id,\n\t\t\t\thtml: html.join(''),\n\t\t\t\tcodeBlocks\n\t\t\t});\n\n\t\t\tdimensionUpdater.updateHeight(this.id, this.element.offsetHeight, {\n\t\t\t\tisOutput: false\n\t\t\t});\n\t\t}\n\n\t\tpublic show(top: number, newContent: string | undefined, metadata: NotebookCellMetadata | undefined): void {\n\t\t\tthis.element.style.visibility = '';\n\t\t\tthis.element.style.top = `${top}px`;\n\t\t\tif (typeof newContent === 'string' || metadata) {\n\t\t\t\tthis.updateContentAndRender(newContent ?? this._content.value, metadata ?? this._content.metadata);\n\t\t\t} else {\n\t\t\t\tthis.updateMarkupDimensions();\n\t\t\t}\n\t\t}\n\n\t\tpublic hide() {\n\t\t\tthis.element.style.visibility = 'hidden';\n\t\t}\n\n\t\tpublic unhide() {\n\t\t\tthis.element.style.visibility = '';\n\t\t\tthis.updateMarkupDimensions();\n\t\t}\n\n\t\tpublic remove() {\n\t\t\tthis.element.remove();\n\t\t}\n\n\t\tprivate async updateMarkupDimensions() {\n\t\t\tdimensionUpdater.updateHeight(this.id, this.element.offsetHeight, {\n\t\t\t\tisOutput: false\n\t\t\t});\n\t\t}\n\n\t\tpublic setSelected(selected: boolean) {\n\t\t\tthis.element.classList.toggle('selected', selected);\n\t\t}\n\n\t\tpublic toggleDragDropEnabled(enabled: boolean) {\n\t\t\tif (enabled) {\n\t\t\t\tthis.element.classList.add('draggable');\n\t\t\t\tthis.element.setAttribute('draggable', 'true');\n\t\t\t} else {\n\t\t\t\tthis.element.classList.remove('draggable');\n\t\t\t\tthis.element.removeAttribute('draggable');\n\t\t\t}\n\t\t}\n\t}\n\n\tclass OutputCell {\n\t\tpublic readonly element: HTMLElement;\n\t\tprivate readonly outputElements = new Map</*outputId*/ string, OutputContainer>();\n\n\t\tconstructor(cellId: string) {\n\t\t\tconst container = window.document.getElementById('container')!;\n\n\t\t\tconst upperWrapperElement = createFocusSink(cellId);\n\t\t\tcontainer.appendChild(upperWrapperElement);\n\n\t\t\tthis.element = document.createElement('div');\n\t\t\tthis.element.style.position = 'absolute';\n\t\t\tthis.element.style.outline = '0';\n\n\t\t\tthis.element.id = cellId;\n\t\t\tthis.element.classList.add('cell_container');\n\n\t\t\tcontainer.appendChild(this.element);\n\t\t\tthis.element = this.element;\n\n\t\t\tconst lowerWrapperElement = createFocusSink(cellId, true);\n\t\t\tcontainer.appendChild(lowerWrapperElement);\n\t\t}\n\n\t\tpublic dispose() {\n\t\t\tfor (const output of this.outputElements.values()) {\n\t\t\t\toutput.dispose();\n\t\t\t}\n\t\t\tthis.outputElements.clear();\n\t\t}\n\n\t\tprivate createOutputElement(data: webviewMessages.ICreationRequestMessage): OutputElement {\n\t\t\tlet outputContainer = this.outputElements.get(data.outputId);\n\t\t\tif (!outputContainer) {\n\t\t\t\toutputContainer = new OutputContainer(data.outputId);\n\t\t\t\tthis.element.appendChild(outputContainer.element);\n\t\t\t\tthis.outputElements.set(data.outputId, outputContainer);\n\t\t\t}\n\n\t\t\treturn outputContainer.createOutputElement(data.outputId, data.outputOffset, data.left, data.cellId);\n\t\t}\n\n\t\tpublic async renderOutputElement(data: webviewMessages.ICreationRequestMessage, preloadErrors: ReadonlyArray<Error | undefined>, signal: AbortSignal) {\n\t\t\tconst startTime = Date.now();\n\t\t\tconst outputElement /** outputNode */ = this.createOutputElement(data);\n\t\t\tawait outputElement.render(data.content, data.rendererId, preloadErrors, signal);\n\n\t\t\t// don't hide until after this step so that the height is right\n\t\t\toutputElement/** outputNode */.element.style.visibility = data.initiallyHidden ? 'hidden' : '';\n\n\t\t\tif (!!data.executionId && !!data.rendererId) {\n\t\t\t\tlet outputSize: number | undefined = undefined;\n\t\t\t\tif (data.content.type === 1 /* extension */) {\n\t\t\t\t\toutputSize = data.content.output.valueBytes.length;\n\t\t\t\t}\n\n\t\t\t\t// Only send performance messages for non-empty outputs up to a certain size\n\t\t\t\tif (outputSize !== undefined && outputSize > 0 && outputSize < 100 * 1024) {\n\t\t\t\t\tpostNotebookMessage<webviewMessages.IPerformanceMessage>('notebookPerformanceMessage', {\n\t\t\t\t\t\tcellId: data.cellId,\n\t\t\t\t\t\texecutionId: data.executionId,\n\t\t\t\t\t\tduration: Date.now() - startTime,\n\t\t\t\t\t\trendererId: data.rendererId,\n\t\t\t\t\t\toutputSize\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpublic clearOutput(outputId: string, rendererId: string | undefined) {\n\t\t\tconst output = this.outputElements.get(outputId);\n\t\t\toutput?.clear(rendererId);\n\t\t\toutput?.dispose();\n\t\t\tthis.outputElements.delete(outputId);\n\t\t}\n\n\t\tpublic show(outputId: string, top: number) {\n\t\t\tconst outputContainer = this.outputElements.get(outputId);\n\t\t\tif (!outputContainer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.element.style.visibility = '';\n\t\t\tthis.element.style.top = `${top}px`;\n\t\t}\n\n\t\tpublic hide() {\n\t\t\tthis.element.style.visibility = 'hidden';\n\t\t}\n\n\t\tpublic updateContentAndRerender(outputId: string, content: webviewMessages.ICreationContent) {\n\t\t\tthis.outputElements.get(outputId)?.updateContentAndRender(content);\n\t\t}\n\n\t\tpublic updateOutputHeight(outputId: string, height: number) {\n\t\t\tthis.outputElements.get(outputId)?.updateHeight(height);\n\t\t}\n\n\t\tpublic updateScroll(request: webviewMessages.IContentWidgetTopRequest) {\n\t\t\tthis.element.style.top = `${request.cellTop}px`;\n\n\t\t\tconst outputElement = this.outputElements.get(request.outputId);\n\t\t\tif (outputElement) {\n\t\t\t\toutputElement.updateScroll(request.outputOffset);\n\n\t\t\t\tif (request.forceDisplay && outputElement.outputNode) {\n\t\t\t\t\t// TODO @rebornix @mjbvz, there is a misalignment here.\n\t\t\t\t\t// We set output visibility on cell container, other than output container or output node itself.\n\t\t\t\t\toutputElement.outputNode.element.style.visibility = '';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (request.forceDisplay) {\n\t\t\t\tthis.element.style.visibility = '';\n\t\t\t}\n\t\t}\n\t}\n\n\tclass OutputContainer {\n\n\t\tpublic readonly element: HTMLElement;\n\n\t\tprivate _outputNode?: OutputElement;\n\n\t\tget outputNode() {\n\t\t\treturn this._outputNode;\n\t\t}\n\n\t\tconstructor(\n\t\t\tprivate readonly outputId: string,\n\t\t) {\n\t\t\tthis.element = document.createElement('div');\n\t\t\tthis.element.classList.add('output_container');\n\t\t\tthis.element.setAttribute('data-vscode-context', JSON.stringify({ 'preventDefaultContextMenuItems': true }));\n\t\t\tthis.element.style.position = 'absolute';\n\t\t\tthis.element.style.overflow = 'hidden';\n\t\t}\n\n\t\tpublic dispose() {\n\t\t\tthis._outputNode?.dispose();\n\t\t}\n\n\t\tpublic clear(rendererId: string | undefined) {\n\t\t\tif (rendererId) {\n\t\t\t\trenderers.clearOutput(rendererId, this.outputId);\n\t\t\t}\n\t\t\tthis.element.remove();\n\t\t}\n\n\t\tpublic updateHeight(height: number) {\n\t\t\tthis.element.style.maxHeight = `${height}px`;\n\t\t\tthis.element.style.height = `${height}px`;\n\t\t}\n\n\t\tpublic updateScroll(outputOffset: number) {\n\t\t\tthis.element.style.top = `${outputOffset}px`;\n\t\t}\n\n\t\tpublic createOutputElement(outputId: string, outputOffset: number, left: number, cellId: string): OutputElement {\n\t\t\tthis.element.innerText = '';\n\t\t\tthis.element.style.maxHeight = '0px';\n\t\t\tthis.element.style.top = `${outputOffset}px`;\n\n\t\t\tthis._outputNode?.dispose();\n\t\t\tthis._outputNode = new OutputElement(outputId, left, cellId);\n\t\t\tthis.element.appendChild(this._outputNode.element);\n\t\t\treturn this._outputNode;\n\t\t}\n\n\t\tpublic updateContentAndRender(content: webviewMessages.ICreationContent) {\n\t\t\tthis._outputNode?.updateAndRerender(content);\n\t\t}\n\t}\n\n\tvscode.postMessage({\n\t\t__vscode_notebook_message: true,\n\t\ttype: 'initialized'\n\t});\n\n\tfor (const preload of ctx.staticPreloadsData) {\n\t\tkernelPreloads.load(preload.entrypoint);\n\t}\n\n\tfunction postNotebookMessage<T extends webviewMessages.FromWebviewMessage>(\n\t\ttype: T['type'],\n\t\tproperties: Omit<T, '__vscode_notebook_message' | 'type'>\n\t) {\n\t\tvscode.postMessage({\n\t\t\t__vscode_notebook_message: true,\n\t\t\ttype,\n\t\t\t...properties\n\t\t});\n\t}\n\n\tclass OutputElement {\n\t\tpublic readonly element: HTMLElement;\n\t\tprivate _content?: {\n\t\t\treadonly preferredRendererId: string | undefined;\n\t\t\treadonly preloadErrors: ReadonlyArray<Error | undefined>;\n\t\t};\n\t\tprivate hasResizeObserver = false;\n\n\t\tprivate renderTaskAbort?: AbortController;\n\t\tprivate isImageOutput = false;\n\n\t\tconstructor(\n\t\t\tprivate readonly outputId: string,\n\t\t\tleft: number,\n\t\t\tpublic readonly cellId: string\n\t\t) {\n\t\t\tthis.element = document.createElement('div');\n\t\t\tthis.element.id = outputId;\n\t\t\tthis.element.classList.add('output');\n\t\t\tthis.element.style.position = 'absolute';\n\t\t\tthis.element.style.top = `0px`;\n\t\t\tthis.element.style.left = left + 'px';\n\t\t\tthis.element.style.padding = `${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodeLeftPadding}`;\n\n\t\t\tthis.element.addEventListener('mouseenter', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IMouseEnterMessage>('mouseenter', { id: outputId });\n\t\t\t});\n\t\t\tthis.element.addEventListener('mouseleave', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IMouseLeaveMessage>('mouseleave', { id: outputId });\n\t\t\t});\n\n\t\t\t// Add drag handler\n\t\t\tthis.element.addEventListener('dragstart', (e: DragEvent) => {\n\t\t\t\tif (!e.dataTransfer) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst outputData: NotebookCellOutputTransferData = {\n\t\t\t\t\toutputId: this.outputId,\n\t\t\t\t};\n\n\t\t\t\te.dataTransfer.setData('notebook-cell-output', JSON.stringify(outputData));\n\t\t\t});\n\n\t\t\t// Add alt key handlers\n\t\t\twindow.addEventListener('keydown', (e) => {\n\t\t\t\tif (e.altKey) {\n\t\t\t\t\tthis.element.draggable = true;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\twindow.addEventListener('keyup', (e) => {\n\t\t\t\tif (!e.altKey) {\n\t\t\t\t\tthis.element.draggable = this.isImageOutput;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Handle window blur to reset draggable state\n\t\t\twindow.addEventListener('blur', () => {\n\t\t\t\tthis.element.draggable = this.isImageOutput;\n\t\t\t});\n\t\t}\n\n\t\tpublic dispose() {\n\t\t\tthis.renderTaskAbort?.abort();\n\t\t\tthis.renderTaskAbort = undefined;\n\t\t}\n\n\t\tpublic async render(content: webviewMessages.ICreationContent, preferredRendererId: string | undefined, preloadErrors: ReadonlyArray<Error | undefined>, signal?: AbortSignal) {\n\t\t\tthis.renderTaskAbort?.abort();\n\t\t\tthis.renderTaskAbort = undefined;\n\n\t\t\tthis._content = { preferredRendererId, preloadErrors };\n\t\t\tif (content.type === 0 /* RenderOutputType.Html */) {\n\t\t\t\tconst trustedHtml = ttPolicy?.createHTML(content.htmlContent) ?? content.htmlContent;\n\t\t\t\tthis.element.innerHTML = trustedHtml as string;  // CodeQL [SM03712] The content comes from renderer extensions, not from direct user input.\n\t\t\t} else if (preloadErrors.some(e => e instanceof Error)) {\n\t\t\t\tconst errors = preloadErrors.filter((e): e is Error => e instanceof Error);\n\t\t\t\tshowRenderError(`Error loading preloads`, this.element, errors);\n\t\t\t} else {\n\n\t\t\t\tconst imageMimeTypes = ['image/png', 'image/jpeg', 'image/svg'];\n\t\t\t\tthis.isImageOutput = imageMimeTypes.includes(content.output.mime);\n\t\t\t\tthis.element.draggable = this.isImageOutput;\n\n\t\t\t\tconst item = createOutputItem(this.outputId, content.output.mime, content.metadata, content.output.valueBytes, content.allOutputs, content.output.appended);\n\n\t\t\t\tconst controller = new AbortController();\n\t\t\t\tthis.renderTaskAbort = controller;\n\n\t\t\t\t// Abort rendering if caller aborts\n\t\t\t\tsignal?.addEventListener('abort', () => controller.abort());\n\n\t\t\t\ttry {\n\t\t\t\t\tawait renderers.render(item, preferredRendererId, this.element, controller.signal);\n\t\t\t\t} finally {\n\t\t\t\t\tif (this.renderTaskAbort === controller) {\n\t\t\t\t\t\tthis.renderTaskAbort = undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!this.hasResizeObserver) {\n\t\t\t\tthis.hasResizeObserver = true;\n\t\t\t\tresizeObserver.observe(this.element, this.outputId, true, this.cellId);\n\t\t\t}\n\n\t\t\tconst offsetHeight = this.element.offsetHeight;\n\t\t\tconst cps = document.defaultView!.getComputedStyle(this.element);\n\t\t\tconst verticalPadding = parseFloat(cps.paddingTop) + parseFloat(cps.paddingBottom);\n\t\t\tconst contentHeight = offsetHeight - verticalPadding;\n\t\t\tif (elementHasContent(contentHeight) && cps.padding === '0px') {\n\t\t\t\t// we set padding to zero if the output has no content (then we can have a zero-height output DOM node)\n\t\t\t\t// thus we need to ensure the padding is accounted when updating the init height of the output\n\t\t\t\tdimensionUpdater.updateHeight(this.outputId, offsetHeight + ctx.style.outputNodePadding * 2, {\n\t\t\t\t\tisOutput: true,\n\t\t\t\t\tinit: true\n\t\t\t\t});\n\n\t\t\t\tthis.element.style.padding = `${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodeLeftPadding}`;\n\t\t\t} else if (elementHasContent(contentHeight)) {\n\t\t\t\tdimensionUpdater.updateHeight(this.outputId, this.element.offsetHeight, {\n\t\t\t\t\tisOutput: true,\n\t\t\t\t\tinit: true\n\t\t\t\t});\n\t\t\t\tthis.element.style.padding = `0 ${ctx.style.outputNodePadding}px 0 ${ctx.style.outputNodeLeftPadding}`;\n\t\t\t} else {\n\t\t\t\t// we have a zero-height output DOM node\n\t\t\t\tdimensionUpdater.updateHeight(this.outputId, 0, {\n\t\t\t\t\tisOutput: true,\n\t\t\t\t\tinit: true,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst root = this.element.shadowRoot ?? this.element;\n\t\t\tconst codeBlocks: Array<{ value: string; lang: string; id: string }> = MarkdownCodeBlock.requestHighlightCodeBlock(root);\n\n\t\t\tif (codeBlocks.length > 0) {\n\t\t\t\tpostNotebookMessage<webviewMessages.IRenderedCellOutputMessage>('renderedCellOutput', {\n\t\t\t\t\tcodeBlocks\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tpublic updateAndRerender(content: webviewMessages.ICreationContent) {\n\t\t\tif (this._content) {\n\t\t\t\tthis.render(content, this._content.preferredRendererId, this._content.preloadErrors);\n\t\t\t}\n\t\t}\n\t}\n\n\tconst markupCellDragManager = new class MarkupCellDragManager {\n\n\t\tprivate currentDrag: { cellId: string; clientY: number } | undefined;\n\n\t\t// Transparent overlay that prevents elements from inside the webview from eating\n\t\t// drag events.\n\t\tprivate dragOverlay?: HTMLElement;\n\n\t\tconstructor() {\n\t\t\twindow.document.addEventListener('dragover', e => {\n\t\t\t\t// Allow dropping dragged markup cells\n\t\t\t\te.preventDefault();\n\t\t\t});\n\n\t\t\twindow.document.addEventListener('drop', e => {\n\t\t\t\te.preventDefault();\n\n\t\t\t\tconst drag = this.currentDrag;\n\t\t\t\tif (!drag) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.currentDrag = undefined;\n\t\t\t\tpostNotebookMessage<webviewMessages.ICellDropMessage>('cell-drop', {\n\t\t\t\t\tcellId: drag.cellId,\n\t\t\t\t\tctrlKey: e.ctrlKey,\n\t\t\t\t\taltKey: e.altKey,\n\t\t\t\t\tdragOffsetY: e.clientY,\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tstartDrag(e: DragEvent, cellId: string) {\n\t\t\tif (!e.dataTransfer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!currentOptions.dragAndDropEnabled) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.currentDrag = { cellId, clientY: e.clientY };\n\n\t\t\tconst overlayZIndex = 9999;\n\t\t\tif (!this.dragOverlay) {\n\t\t\t\tthis.dragOverlay = document.createElement('div');\n\t\t\t\tthis.dragOverlay.style.position = 'absolute';\n\t\t\t\tthis.dragOverlay.style.top = '0';\n\t\t\t\tthis.dragOverlay.style.left = '0';\n\t\t\t\tthis.dragOverlay.style.zIndex = `${overlayZIndex}`;\n\t\t\t\tthis.dragOverlay.style.width = '100%';\n\t\t\t\tthis.dragOverlay.style.height = '100%';\n\t\t\t\tthis.dragOverlay.style.background = 'transparent';\n\t\t\t\twindow.document.body.appendChild(this.dragOverlay);\n\t\t\t}\n\t\t\t(e.target as HTMLElement).style.zIndex = `${overlayZIndex + 1}`;\n\t\t\t(e.target as HTMLElement).classList.add('dragging');\n\n\t\t\tpostNotebookMessage<webviewMessages.ICellDragStartMessage>('cell-drag-start', {\n\t\t\t\tcellId: cellId,\n\t\t\t\tdragOffsetY: e.clientY,\n\t\t\t});\n\n\t\t\t// Continuously send updates while dragging instead of relying on `updateDrag`.\n\t\t\t// This lets us scroll the list based on drag position.\n\t\t\tconst trySendDragUpdate = () => {\n\t\t\t\tif (this.currentDrag?.cellId !== cellId) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tpostNotebookMessage<webviewMessages.ICellDragMessage>('cell-drag', {\n\t\t\t\t\tcellId: cellId,\n\t\t\t\t\tdragOffsetY: this.currentDrag.clientY,\n\t\t\t\t});\n\t\t\t\twindow.requestAnimationFrame(trySendDragUpdate);\n\t\t\t};\n\t\t\twindow.requestAnimationFrame(trySendDragUpdate);\n\t\t}\n\n\t\tupdateDrag(e: DragEvent, cellId: string) {\n\t\t\tif (cellId !== this.currentDrag?.cellId) {\n\t\t\t\tthis.currentDrag = undefined;\n\t\t\t} else {\n\t\t\t\tthis.currentDrag = { cellId, clientY: e.clientY };\n\t\t\t}\n\t\t}\n\n\t\tendDrag(e: DragEvent, cellId: string) {\n\t\t\tthis.currentDrag = undefined;\n\t\t\t(e.target as HTMLElement).classList.remove('dragging');\n\t\t\tpostNotebookMessage<webviewMessages.ICellDragEndMessage>('cell-drag-end', {\n\t\t\t\tcellId: cellId\n\t\t\t});\n\n\t\t\tif (this.dragOverlay) {\n\t\t\t\tthis.dragOverlay.remove();\n\t\t\t\tthis.dragOverlay = undefined;\n\t\t\t}\n\n\t\t\t(e.target as HTMLElement).style.zIndex = '';\n\t\t}\n\t}();\n}\n\nexport function preloadsScriptStr(styleValues: PreloadStyles, options: PreloadOptions, renderOptions: RenderOptions, renderers: readonly webviewMessages.RendererMetadata[], preloads: readonly webviewMessages.StaticPreloadMetadata[], isWorkspaceTrusted: boolean, nonce: string) {\n\tconst ctx: PreloadContext = {\n\t\tstyle: styleValues,\n\t\toptions,\n\t\trenderOptions,\n\t\trendererData: renderers,\n\t\tstaticPreloadsData: preloads,\n\t\tisWorkspaceTrusted,\n\t\tnonce,\n\t};\n\t// TS will try compiling `import()` in webviewPreloads, so use a helper function instead\n\t// of using `import(...)` directly\n\treturn `\n\t\tconst __import = (x) => import(x);\n\t\t(${webviewPreloads})(\n\t\t\tJSON.parse(decodeURIComponent(\"${encodeURIComponent(JSON.stringify(ctx))}\"))\n\t\t)\\n//# sourceURL=notebookWebviewPreloads.js\\n`;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { Event } from '../../../../../../base/common/event.js';\nimport type { IDisposable } from '../../../../../../base/common/lifecycle.js';\nimport type * as webviewMessages from './webviewMessages.js';\nimport type { NotebookCellMetadata } from '../../../common/notebookCommon.js';\nimport type * as rendererApi from 'vscode-notebook-renderer';\nimport type { NotebookCellOutputTransferData } from '../../../../../../platform/dnd/browser/dnd.js';\n\n// !! IMPORTANT !! ----------------------------------------------------------------------------------\n// import { RenderOutputType } from 'vs/workbench/contrib/notebook/browser/notebookBrowser';\n// We can ONLY IMPORT as type in this module. This also applies to const enums that would evaporate\n// in normal compiles but remain a dependency in transpile-only compiles\n// !! IMPORTANT !! ----------------------------------------------------------------------------------\n\n// !! IMPORTANT !! everything must be in-line within the webviewPreloads\n// function. Imports are not allowed. This is stringified and injected into\n// the webview.\n\ndeclare module globalThis {\n\tconst acquireVsCodeApi: () => ({\n\t\tgetState(): { [key: string]: unknown };\n\t\tsetState(data: { [key: string]: unknown }): void;\n\t\tpostMessage: (msg: unknown) => void;\n\t});\n}\n\ndeclare class ResizeObserver {\n\tconstructor(onChange: (entries: { target: HTMLElement; contentRect?: ClientRect }[]) => void);\n\tobserve(element: Element): void;\n\tdisconnect(): void;\n}\n\ndeclare class Highlight {\n\tconstructor();\n\tadd(range: AbstractRange): void;\n\tclear(): void;\n\tpriority: number;\n}\n\ninterface CSSHighlights {\n\tset(rule: string, highlight: Highlight): void;\n}\ndeclare namespace CSS {\n\tlet highlights: CSSHighlights | undefined;\n}\n\n\ntype Listener<T> = { fn: (evt: T) => void; thisArg: unknown };\n\ninterface EmitterLike<T> {\n\tfire(data: T): void;\n\treadonly event: Event<T>;\n}\n\ninterface PreloadStyles {\n\treadonly outputNodePadding: number;\n\treadonly outputNodeLeftPadding: number;\n\treadonly tokenizationCss: string;\n}\n\nexport interface PreloadOptions {\n\tdragAndDropEnabled: boolean;\n}\n\nexport interface RenderOptions {\n\treadonly lineLimit: number;\n\treadonly outputScrolling: boolean;\n\treadonly outputWordWrap: boolean;\n\treadonly linkifyFilePaths: boolean;\n\treadonly minimalError: boolean;\n}\n\ninterface PreloadContext {\n\treadonly nonce: string;\n\treadonly style: PreloadStyles;\n\treadonly options: PreloadOptions;\n\treadonly renderOptions: RenderOptions;\n\treadonly rendererData: readonly webviewMessages.RendererMetadata[];\n\treadonly staticPreloadsData: readonly webviewMessages.StaticPreloadMetadata[];\n\treadonly isWorkspaceTrusted: boolean;\n}\n\ndeclare function requestIdleCallback(callback: (args: IdleDeadline) => void, options?: { timeout: number }): number;\ndeclare function cancelIdleCallback(handle: number): void;\n\ndeclare function __import(path: string): Promise<any>;\n\nasync function webviewPreloads(ctx: PreloadContext) {\n\n\t/* eslint-disable no-restricted-globals, no-restricted-syntax */\n\n\t// The use of global `window` should be fine in this context, even\n\t// with aux windows. This code is running from within an `iframe`\n\t// where there is only one `window` object anyway.\n\n\tconst userAgent = navigator.userAgent;\n\tconst isChrome = (userAgent.indexOf('Chrome') >= 0);\n\tconst textEncoder = new TextEncoder();\n\tconst textDecoder = new TextDecoder();\n\n\tfunction promiseWithResolvers<T>(): { promise: Promise<T>; resolve: (value: T | PromiseLike<T>) => void; reject: (err?: any) => void } {\n\t\tlet resolve: (value: T | PromiseLike<T>) => void;\n\t\tlet reject: (reason?: any) => void;\n\t\tconst promise = new Promise<T>((res, rej) => {\n\t\t\tresolve = res;\n\t\t\treject = rej;\n\t\t});\n\t\treturn { promise, resolve: resolve!, reject: reject! };\n\t}\n\n\tlet currentOptions = ctx.options;\n\tconst isWorkspaceTrusted = ctx.isWorkspaceTrusted;\n\tlet currentRenderOptions = ctx.renderOptions;\n\tconst settingChange: EmitterLike<RenderOptions> = createEmitter<RenderOptions>();\n\n\tconst acquireVsCodeApi = globalThis.acquireVsCodeApi;\n\tconst vscode = acquireVsCodeApi();\n\tdelete (globalThis as { acquireVsCodeApi: unknown }).acquireVsCodeApi;\n\n\tconst tokenizationStyle = new CSSStyleSheet();\n\ttokenizationStyle.replaceSync(ctx.style.tokenizationCss);\n\n\tconst runWhenIdle: (callback: (idle: IdleDeadline) => void, timeout?: number) => IDisposable = (typeof requestIdleCallback !== 'function' || typeof cancelIdleCallback !== 'function')\n\t\t? (runner) => {\n\t\t\tsetTimeout(() => {\n\t\t\t\tif (disposed) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst end = Date.now() + 15; // one frame at 64fps\n\t\t\t\trunner(Object.freeze({\n\t\t\t\t\tdidTimeout: true,\n\t\t\t\t\ttimeRemaining() {\n\t\t\t\t\t\treturn Math.max(0, end - Date.now());\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t});\n\t\t\tlet disposed = false;\n\t\t\treturn {\n\t\t\t\tdispose() {\n\t\t\t\t\tif (disposed) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tdisposed = true;\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t\t: (runner, timeout?) => {\n\t\t\tconst handle: number = requestIdleCallback(runner, typeof timeout === 'number' ? { timeout } : undefined);\n\t\t\tlet disposed = false;\n\t\t\treturn {\n\t\t\t\tdispose() {\n\t\t\t\t\tif (disposed) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tdisposed = true;\n\t\t\t\t\tcancelIdleCallback(handle);\n\t\t\t\t}\n\t\t\t};\n\t\t};\n\tfunction getOutputContainer(event: FocusEvent | MouseEvent) {\n\t\tfor (const node of event.composedPath()) {\n\t\t\tif (node instanceof HTMLElement && node.classList.contains('output')) {\n\t\t\t\treturn {\n\t\t\t\t\tid: node.id\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\tlet lastFocusedOutput: { id: string } | undefined = undefined;\n\tconst handleOutputFocusOut = (event: FocusEvent) => {\n\t\tconst outputFocus = event && getOutputContainer(event);\n\t\tif (!outputFocus) {\n\t\t\treturn;\n\t\t}\n\t\t// Possible we're tabbing through the elements of the same output.\n\t\t// Lets see if focus is set back to the same output.\n\t\tlastFocusedOutput = undefined;\n\t\tsetTimeout(() => {\n\t\t\tif (lastFocusedOutput?.id === outputFocus.id) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tpostNotebookMessage<webviewMessages.IOutputBlurMessage>('outputBlur', outputFocus);\n\t\t}, 0);\n\t};\n\n\tconst hasActiveEditableElement = (\n\t\tparent: Node | DocumentFragment,\n\t\troot: ShadowRoot | Document = document\n\t): boolean => {\n\t\tconst element = root.activeElement;\n\t\treturn !!(element && parent.contains(element)\n\t\t\t&& (element.matches(':read-write') || element.tagName.toLowerCase() === 'select'\n\t\t\t\t|| (element.shadowRoot && hasActiveEditableElement(element.shadowRoot, element.shadowRoot)))\n\t\t);\n\t};\n\n\t// check if an input element is focused within the output element\n\tconst checkOutputInputFocus = (e: FocusEvent) => {\n\t\tlastFocusedOutput = getOutputContainer(e);\n\t\tconst activeElement = window.document.activeElement;\n\t\tif (!activeElement) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst id = lastFocusedOutput?.id;\n\t\tif (id && (hasActiveEditableElement(activeElement, window.document))) {\n\t\t\tpostNotebookMessage<webviewMessages.IOutputInputFocusMessage>('outputInputFocus', { inputFocused: true, id });\n\n\t\t\tactiveElement.addEventListener('blur', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IOutputInputFocusMessage>('outputInputFocus', { inputFocused: false, id });\n\t\t\t}, { once: true });\n\t\t}\n\t};\n\n\tconst handleInnerClick = (event: MouseEvent) => {\n\t\tif (!event || !event.view || !event.view.document) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst outputFocus = lastFocusedOutput = getOutputContainer(event);\n\t\tfor (const node of event.composedPath()) {\n\t\t\tif (node instanceof HTMLAnchorElement && node.href) {\n\t\t\t\tif (node.href.startsWith('blob:')) {\n\t\t\t\t\tif (outputFocus) {\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', outputFocus);\n\t\t\t\t\t}\n\n\t\t\t\t\thandleBlobUrlClick(node.href, node.download);\n\t\t\t\t} else if (node.href.startsWith('data:')) {\n\t\t\t\t\tif (outputFocus) {\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', outputFocus);\n\t\t\t\t\t}\n\t\t\t\t\thandleDataUrl(node.href, node.download);\n\t\t\t\t} else if (node.getAttribute('href')?.trim().startsWith('#')) {\n\t\t\t\t\t// Scrolling to location within current doc\n\n\t\t\t\t\tif (!node.hash) {\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IScrollToRevealMessage>('scroll-to-reveal', { scrollTop: 0 });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst targetId = node.hash.substring(1);\n\n\t\t\t\t\t// Check outer document first\n\t\t\t\t\tlet scrollTarget: Element | null | undefined = event.view.document.getElementById(targetId);\n\n\t\t\t\t\tif (!scrollTarget) {\n\t\t\t\t\t\t// Fallback to checking preview shadow doms\n\t\t\t\t\t\tfor (const preview of event.view.document.querySelectorAll('.preview')) {\n\t\t\t\t\t\t\tscrollTarget = preview.shadowRoot?.getElementById(targetId);\n\t\t\t\t\t\t\tif (scrollTarget) {\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (scrollTarget) {\n\t\t\t\t\t\tconst scrollTop = scrollTarget.getBoundingClientRect().top + event.view.scrollY;\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IScrollToRevealMessage>('scroll-to-reveal', { scrollTop });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconst href = node.getAttribute('href');\n\t\t\t\t\tif (href) {\n\t\t\t\t\t\tif (href.startsWith('command:') && outputFocus) {\n\t\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', outputFocus);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpostNotebookMessage<webviewMessages.IClickedLinkMessage>('clicked-link', { href });\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tevent.preventDefault();\n\t\t\t\tevent.stopPropagation();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (outputFocus) {\n\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', outputFocus);\n\t\t}\n\t};\n\n\tconst blurOutput = () => {\n\t\tconst selection = window.getSelection();\n\t\tif (!selection) {\n\t\t\treturn;\n\t\t}\n\t\tselection.removeAllRanges();\n\t};\n\n\tconst selectOutputContents = (cellOrOutputId: string) => {\n\t\tconst selection = window.getSelection();\n\t\tif (!selection) {\n\t\t\treturn;\n\t\t}\n\t\tconst cellOutputContainer = window.document.getElementById(cellOrOutputId);\n\t\tif (!cellOutputContainer) {\n\t\t\treturn;\n\t\t}\n\t\tselection.removeAllRanges();\n\t\tconst range = document.createRange();\n\t\trange.selectNode(cellOutputContainer);\n\t\tselection.addRange(range);\n\n\t};\n\n\tconst selectInputContents = (cellOrOutputId: string) => {\n\t\tconst cellOutputContainer = window.document.getElementById(cellOrOutputId);\n\t\tif (!cellOutputContainer) {\n\t\t\treturn;\n\t\t}\n\t\tconst activeElement = window.document.activeElement;\n\t\tif (activeElement && hasActiveEditableElement(activeElement, window.document)) {\n\t\t\t(activeElement as HTMLInputElement).select();\n\t\t}\n\t};\n\n\tconst onPageUpDownSelectionHandler = (e: KeyboardEvent) => {\n\t\tif (!lastFocusedOutput?.id || !e.shiftKey) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If we're pressing `Shift+Up/Down` then we want to select a line at a time.\n\t\tif (e.shiftKey && (e.code === 'ArrowUp' || e.code === 'ArrowDown')) {\n\t\t\te.stopPropagation(); // We don't want the notebook to handle this, default behavior is what we need.\n\t\t\treturn;\n\t\t}\n\n\t\t// We want to handle just `Shift + PageUp/PageDown` & `Shift + Cmd + ArrowUp/ArrowDown` (for mac)\n\t\tif (!(e.code === 'PageUp' || e.code === 'PageDown') && !(e.metaKey && (e.code === 'ArrowDown' || e.code === 'ArrowUp'))) {\n\t\t\treturn;\n\t\t}\n\t\tconst outputContainer = window.document.getElementById(lastFocusedOutput.id);\n\t\tconst selection = window.getSelection();\n\t\tif (!outputContainer || !selection?.anchorNode) {\n\t\t\treturn;\n\t\t}\n\t\tconst activeElement = window.document.activeElement;\n\t\tif (activeElement && hasActiveEditableElement(activeElement, window.document)) {\n\t\t\t// Leave for default behavior.\n\t\t\treturn;\n\t\t}\n\n\t\t// These should change the scroll position, not adjust the selected cell in the notebook\n\t\te.stopPropagation(); // We don't want the notebook to handle this.\n\t\te.preventDefault(); // We will handle selection.\n\n\t\tconst { anchorNode, anchorOffset } = selection;\n\t\tconst range = document.createRange();\n\t\tif (e.code === 'PageDown' || e.code === 'ArrowDown') {\n\t\t\trange.setStart(anchorNode, anchorOffset);\n\t\t\trange.setEnd(outputContainer, 1);\n\t\t}\n\t\telse {\n\t\t\trange.setStart(outputContainer, 0);\n\t\t\trange.setEnd(anchorNode, anchorOffset);\n\t\t}\n\t\tselection.removeAllRanges();\n\t\tselection.addRange(range);\n\t};\n\n\tconst disableNativeSelectAll = (e: KeyboardEvent) => {\n\t\tif (!lastFocusedOutput?.id) {\n\t\t\treturn;\n\t\t}\n\t\tconst activeElement = window.document.activeElement;\n\t\tif (activeElement && hasActiveEditableElement(activeElement, window.document)) {\n\t\t\t// The input element will handle this.\n\t\t\treturn;\n\t\t}\n\n\t\tif ((e.key === 'a' && e.ctrlKey) || (e.metaKey && e.key === 'a')) {\n\t\t\te.preventDefault(); // We will handle selection in editor code.\n\t\t\treturn;\n\t\t}\n\t};\n\n\tconst handleDataUrl = async (data: string | ArrayBuffer | null, downloadName: string) => {\n\t\tpostNotebookMessage<webviewMessages.IClickedDataUrlMessage>('clicked-data-url', {\n\t\t\tdata,\n\t\t\tdownloadName\n\t\t});\n\t};\n\n\tconst handleBlobUrlClick = async (url: string, downloadName: string) => {\n\t\ttry {\n\t\t\tconst response = await fetch(url);\n\t\t\tconst blob = await response.blob();\n\t\t\tconst reader = new FileReader();\n\t\t\treader.addEventListener('load', () => {\n\t\t\t\thandleDataUrl(reader.result, downloadName);\n\t\t\t});\n\t\t\treader.readAsDataURL(blob);\n\t\t} catch (e) {\n\t\t\tconsole.error(e.message);\n\t\t}\n\t};\n\n\twindow.document.body.addEventListener('click', handleInnerClick);\n\twindow.document.body.addEventListener('focusin', checkOutputInputFocus);\n\twindow.document.body.addEventListener('focusout', handleOutputFocusOut);\n\twindow.document.body.addEventListener('keydown', onPageUpDownSelectionHandler);\n\twindow.document.body.addEventListener('keydown', disableNativeSelectAll);\n\n\tinterface RendererContext extends rendererApi.RendererContext<unknown> {\n\t\treadonly onDidChangeSettings: Event<RenderOptions>;\n\t\treadonly settings: RenderOptions;\n\t}\n\n\tinterface RendererModule {\n\t\treadonly activate: rendererApi.ActivationFunction;\n\t}\n\n\tinterface KernelPreloadContext {\n\t\treadonly onDidReceiveKernelMessage: Event<unknown>;\n\t\tpostKernelMessage(data: unknown): void;\n\t}\n\n\tinterface KernelPreloadModule {\n\t\tactivate(ctx: KernelPreloadContext): Promise<void> | void;\n\t}\n\n\tinterface IObservedElement {\n\t\tid: string;\n\t\toutput: boolean;\n\t\tlastKnownPadding: number;\n\t\tlastKnownHeight: number;\n\t\tcellId: string;\n\t}\n\n\tfunction createKernelContext(): KernelPreloadContext {\n\t\treturn Object.freeze({\n\t\t\tonDidReceiveKernelMessage: onDidReceiveKernelMessage.event,\n\t\t\tpostKernelMessage: (data: unknown) => postNotebookMessage('customKernelMessage', { message: data }),\n\t\t});\n\t}\n\n\tasync function runKernelPreload(url: string): Promise<void> {\n\t\ttry {\n\t\t\treturn await activateModuleKernelPreload(url);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tasync function activateModuleKernelPreload(url: string) {\n\t\tconst module: KernelPreloadModule = await __import(url);\n\t\tif (!module.activate) {\n\t\t\tconsole.error(`Notebook preload '${url}' was expected to be a module but it does not export an 'activate' function`);\n\t\t\treturn;\n\t\t}\n\t\treturn module.activate(createKernelContext());\n\t}\n\n\tconst dimensionUpdater = new class {\n\t\tprivate readonly pending = new Map<string, webviewMessages.DimensionUpdate>();\n\n\t\tupdateHeight(id: string, height: number, options: { init?: boolean; isOutput?: boolean }) {\n\t\t\tif (!this.pending.size) {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tthis.updateImmediately();\n\t\t\t\t}, 0);\n\t\t\t}\n\t\t\tconst update = this.pending.get(id);\n\t\t\tif (update && update.isOutput) {\n\t\t\t\tthis.pending.set(id, {\n\t\t\t\t\tid,\n\t\t\t\t\theight,\n\t\t\t\t\tinit: update.init,\n\t\t\t\t\tisOutput: update.isOutput\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.pending.set(id, {\n\t\t\t\t\tid,\n\t\t\t\t\theight,\n\t\t\t\t\t...options,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tupdateImmediately() {\n\t\t\tif (!this.pending.size) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tpostNotebookMessage<webviewMessages.IDimensionMessage>('dimension', {\n\t\t\t\tupdates: Array.from(this.pending.values())\n\t\t\t});\n\t\t\tthis.pending.clear();\n\t\t}\n\t};\n\n\tfunction elementHasContent(height: number) {\n\t\t// we need to account for a potential 1px top and bottom border on a child within the output container\n\t\treturn height > 2.1;\n\t}\n\n\tconst resizeObserver = new class {\n\n\t\tprivate readonly _observer: ResizeObserver;\n\n\t\tprivate readonly _observedElements = new WeakMap<Element, IObservedElement>();\n\t\tprivate _outputResizeTimer: Timeout | undefined;\n\n\t\tconstructor() {\n\t\t\tthis._observer = new ResizeObserver(entries => {\n\t\t\t\tfor (const entry of entries) {\n\t\t\t\t\tif (!window.document.body.contains(entry.target)) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst observedElementInfo = this._observedElements.get(entry.target);\n\t\t\t\t\tif (!observedElementInfo) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.postResizeMessage(observedElementInfo.cellId);\n\n\t\t\t\t\tif (entry.target.id !== observedElementInfo.id) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!entry.contentRect) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!observedElementInfo.output) {\n\t\t\t\t\t\t// markup, update directly\n\t\t\t\t\t\tthis.updateHeight(observedElementInfo, entry.target.offsetHeight);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst hasContent = elementHasContent(entry.contentRect.height);\n\t\t\t\t\tconst shouldUpdatePadding =\n\t\t\t\t\t\t(hasContent && observedElementInfo.lastKnownPadding === 0) ||\n\t\t\t\t\t\t(!hasContent && observedElementInfo.lastKnownPadding !== 0);\n\n\t\t\t\t\tif (shouldUpdatePadding) {\n\t\t\t\t\t\t// Do not update dimension in resize observer\n\t\t\t\t\t\twindow.requestAnimationFrame(() => {\n\t\t\t\t\t\t\tif (hasContent) {\n\t\t\t\t\t\t\t\tentry.target.style.padding = `${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodeLeftPadding}px`;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tentry.target.style.padding = `0px`;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis.updateHeight(observedElementInfo, hasContent ? entry.target.offsetHeight : 0);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.updateHeight(observedElementInfo, hasContent ? entry.target.offsetHeight : 0);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tprivate updateHeight(observedElementInfo: IObservedElement, offsetHeight: number) {\n\t\t\tif (observedElementInfo.lastKnownHeight !== offsetHeight) {\n\t\t\t\tobservedElementInfo.lastKnownHeight = offsetHeight;\n\t\t\t\tdimensionUpdater.updateHeight(observedElementInfo.id, offsetHeight, {\n\t\t\t\t\tisOutput: observedElementInfo.output\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tpublic observe(container: Element, id: string, output: boolean, cellId: string) {\n\t\t\tif (this._observedElements.has(container)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._observedElements.set(container, { id, output, lastKnownPadding: ctx.style.outputNodePadding, lastKnownHeight: -1, cellId });\n\t\t\tthis._observer.observe(container);\n\t\t}\n\n\t\tprivate postResizeMessage(cellId: string) {\n\t\t\t// Debounce this callback to only happen after\n\t\t\t// 250 ms. Don't need resize events that often.\n\t\t\tclearTimeout(this._outputResizeTimer);\n\t\t\tthis._outputResizeTimer = setTimeout(() => {\n\t\t\t\tpostNotebookMessage('outputResized', {\n\t\t\t\t\tcellId\n\t\t\t\t});\n\t\t\t}, 250);\n\n\t\t}\n\t};\n\n\tlet previousDelta: number | undefined;\n\tlet scrollTimeout: Timeout | undefined;\n\tlet scrolledElement: Element | undefined;\n\tlet lastTimeScrolled: number | undefined;\n\tfunction flagRecentlyScrolled(node: Element, deltaY?: number) {\n\t\tscrolledElement = node;\n\t\tif (deltaY === undefined) {\n\t\t\tlastTimeScrolled = Date.now();\n\t\t\tpreviousDelta = undefined;\n\t\t\tnode.setAttribute('recentlyScrolled', 'true');\n\t\t\tclearTimeout(scrollTimeout);\n\t\t\tscrollTimeout = setTimeout(() => { scrolledElement?.removeAttribute('recentlyScrolled'); }, 300);\n\t\t\treturn true;\n\t\t}\n\n\t\tif (node.hasAttribute('recentlyScrolled')) {\n\t\t\tif (lastTimeScrolled && Date.now() - lastTimeScrolled > 400) {\n\t\t\t\t// it has been a while since we actually scrolled\n\t\t\t\t// if scroll velocity increases significantly, it's likely a new scroll event\n\t\t\t\tif (!!previousDelta && deltaY < 0 && deltaY < previousDelta - 8) {\n\t\t\t\t\tclearTimeout(scrollTimeout);\n\t\t\t\t\tscrolledElement?.removeAttribute('recentlyScrolled');\n\t\t\t\t\treturn false;\n\t\t\t\t} else if (!!previousDelta && deltaY > 0 && deltaY > previousDelta + 8) {\n\t\t\t\t\tclearTimeout(scrollTimeout);\n\t\t\t\t\tscrolledElement?.removeAttribute('recentlyScrolled');\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\t// the tail end of a smooth scrolling event (from a trackpad) can go on for a while\n\t\t\t\t// so keep swallowing it, but we can shorten the timeout since the events occur rapidly\n\t\t\t\tclearTimeout(scrollTimeout);\n\t\t\t\tscrollTimeout = setTimeout(() => { scrolledElement?.removeAttribute('recentlyScrolled'); }, 50);\n\t\t\t} else {\n\t\t\t\tclearTimeout(scrollTimeout);\n\t\t\t\tscrollTimeout = setTimeout(() => { scrolledElement?.removeAttribute('recentlyScrolled'); }, 300);\n\t\t\t}\n\n\t\t\tpreviousDelta = deltaY;\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tfunction eventTargetShouldHandleScroll(event: WheelEvent) {\n\t\tfor (let node = event.target as Node | null; node; node = node.parentNode) {\n\t\t\tif (!(node instanceof Element) || node.id === 'container' || node.classList.contains('cell_container') || node.classList.contains('markup') || node.classList.contains('output_container')) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// scroll up\n\t\t\tif (event.deltaY < 0 && node.scrollTop > 0) {\n\t\t\t\t// there is still some content to scroll\n\t\t\t\tflagRecentlyScrolled(node);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\t// scroll down\n\t\t\tif (event.deltaY > 0 && node.scrollTop + node.clientHeight < node.scrollHeight) {\n\t\t\t\t// per https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollHeight\n\t\t\t\t// scrollTop is not rounded but scrollHeight and clientHeight are\n\t\t\t\t// so we need to check if the difference is less than some threshold\n\t\t\t\tif (node.scrollHeight - node.scrollTop - node.clientHeight < 2) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// if the node is not scrollable, we can continue. We don't check the computed style always as it's expensive\n\t\t\t\tif (window.getComputedStyle(node).overflowY === 'hidden' || window.getComputedStyle(node).overflowY === 'visible') {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tflagRecentlyScrolled(node);\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (flagRecentlyScrolled(node, event.deltaY)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tconst handleWheel = (event: WheelEvent & { wheelDeltaX?: number; wheelDeltaY?: number; wheelDelta?: number }) => {\n\t\tif (event.defaultPrevented || eventTargetShouldHandleScroll(event)) {\n\t\t\treturn;\n\t\t}\n\t\tpostNotebookMessage<webviewMessages.IWheelMessage>('did-scroll-wheel', {\n\t\t\tpayload: {\n\t\t\t\tdeltaMode: event.deltaMode,\n\t\t\t\tdeltaX: event.deltaX,\n\t\t\t\tdeltaY: event.deltaY,\n\t\t\t\tdeltaZ: event.deltaZ,\n\t\t\t\t// Refs https://github.com/microsoft/vscode/issues/146403#issuecomment-1854538928\n\t\t\t\twheelDelta: event.wheelDelta && isChrome ? (event.wheelDelta / window.devicePixelRatio) : event.wheelDelta,\n\t\t\t\twheelDeltaX: event.wheelDeltaX && isChrome ? (event.wheelDeltaX / window.devicePixelRatio) : event.wheelDeltaX,\n\t\t\t\twheelDeltaY: event.wheelDeltaY && isChrome ? (event.wheelDeltaY / window.devicePixelRatio) : event.wheelDeltaY,\n\t\t\t\tdetail: event.detail,\n\t\t\t\tshiftKey: event.shiftKey,\n\t\t\t\ttype: event.type\n\t\t\t}\n\t\t});\n\t};\n\n\tfunction focusFirstFocusableOrContainerInOutput(cellOrOutputId: string, alternateId?: string) {\n\t\tconst cellOutputContainer = window.document.getElementById(cellOrOutputId) ??\n\t\t\t(alternateId ? window.document.getElementById(alternateId) : undefined);\n\t\tif (cellOutputContainer) {\n\t\t\tif (cellOutputContainer.contains(window.document.activeElement)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst id = cellOutputContainer.id;\n\t\t\tlet focusableElement = cellOutputContainer.querySelector('[tabindex=\"0\"], [href], button, input, option, select, textarea') as HTMLElement | null;\n\t\t\tif (!focusableElement) {\n\t\t\t\tfocusableElement = cellOutputContainer;\n\t\t\t\tfocusableElement.tabIndex = -1;\n\t\t\t\tpostNotebookMessage<webviewMessages.IOutputInputFocusMessage>('outputInputFocus', { inputFocused: false, id });\n\t\t\t} else {\n\t\t\t\tconst inputFocused = hasActiveEditableElement(focusableElement, focusableElement.ownerDocument);\n\t\t\t\tpostNotebookMessage<webviewMessages.IOutputInputFocusMessage>('outputInputFocus', { inputFocused, id });\n\t\t\t}\n\n\t\t\tlastFocusedOutput = cellOutputContainer;\n\t\t\tpostNotebookMessage<webviewMessages.IOutputFocusMessage>('outputFocus', { id: cellOutputContainer.id });\n\t\t\tfocusableElement.focus();\n\t\t}\n\t}\n\n\tfunction createFocusSink(cellId: string, focusNext?: boolean) {\n\t\tconst element = document.createElement('div');\n\t\telement.id = `focus-sink-${cellId}`;\n\t\telement.tabIndex = 0;\n\t\telement.addEventListener('focus', () => {\n\t\t\tpostNotebookMessage<webviewMessages.IFocusEditorMessage>('focus-editor', {\n\t\t\t\tcellId: cellId,\n\t\t\t\tfocusNext\n\t\t\t});\n\t\t});\n\n\t\treturn element;\n\t}\n\n\tfunction _internalHighlightRange(range: Range, tagName = 'mark', attributes = {}) {\n\t\t// derived from https://github.com/Treora/dom-highlight-range/blob/master/highlight-range.js\n\n\t\t// Return an array of the text nodes in the range. Split the start and end nodes if required.\n\t\tfunction _textNodesInRange(range: Range): Text[] {\n\t\t\tif (!range.startContainer.ownerDocument) {\n\t\t\t\treturn [];\n\t\t\t}\n\n\t\t\t// If the start or end node is a text node and only partly in the range, split it.\n\t\t\tif (range.startContainer.nodeType === Node.TEXT_NODE && range.startOffset > 0) {\n\t\t\t\tconst startContainer = range.startContainer as Text;\n\t\t\t\tconst endOffset = range.endOffset; // (this may get lost when the splitting the node)\n\t\t\t\tconst createdNode = startContainer.splitText(range.startOffset);\n\t\t\t\tif (range.endContainer === startContainer) {\n\t\t\t\t\t// If the end was in the same container, it will now be in the newly created node.\n\t\t\t\t\trange.setEnd(createdNode, endOffset - range.startOffset);\n\t\t\t\t}\n\n\t\t\t\trange.setStart(createdNode, 0);\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\trange.endContainer.nodeType === Node.TEXT_NODE\n\t\t\t\t&& range.endOffset < (range.endContainer as Text).length\n\t\t\t) {\n\t\t\t\t(range.endContainer as Text).splitText(range.endOffset);\n\t\t\t}\n\n\t\t\t// Collect the text nodes.\n\t\t\tconst walker = range.startContainer.ownerDocument.createTreeWalker(\n\t\t\t\trange.commonAncestorContainer,\n\t\t\t\tNodeFilter.SHOW_TEXT,\n\t\t\t\tnode => range.intersectsNode(node) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT,\n\t\t\t);\n\n\t\t\twalker.currentNode = range.startContainer;\n\n\t\t\t// // Optimise by skipping nodes that are explicitly outside the range.\n\t\t\t// const NodeTypesWithCharacterOffset = [\n\t\t\t//  Node.TEXT_NODE,\n\t\t\t//  Node.PROCESSING_INSTRUCTION_NODE,\n\t\t\t//  Node.COMMENT_NODE,\n\t\t\t// ];\n\t\t\t// if (!NodeTypesWithCharacterOffset.includes(range.startContainer.nodeType)) {\n\t\t\t//   if (range.startOffset < range.startContainer.childNodes.length) {\n\t\t\t//     walker.currentNode = range.startContainer.childNodes[range.startOffset];\n\t\t\t//   } else {\n\t\t\t//     walker.nextSibling(); // TODO verify this is correct.\n\t\t\t//   }\n\t\t\t// }\n\n\t\t\tconst nodes: Text[] = [];\n\t\t\tif (walker.currentNode.nodeType === Node.TEXT_NODE) {\n\t\t\t\tnodes.push(walker.currentNode as Text);\n\t\t\t}\n\n\t\t\twhile (walker.nextNode() && range.comparePoint(walker.currentNode, 0) !== 1) {\n\t\t\t\tif (walker.currentNode.nodeType === Node.TEXT_NODE) {\n\t\t\t\t\tnodes.push(walker.currentNode as Text);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn nodes;\n\t\t}\n\n\t\t// Replace [node] with <tagName ...attributes>[node]</tagName>\n\t\tfunction wrapNodeInHighlight(node: Text, tagName: string, attributes: any) {\n\t\t\tconst highlightElement = node.ownerDocument.createElement(tagName);\n\t\t\tObject.keys(attributes).forEach(key => {\n\t\t\t\thighlightElement.setAttribute(key, attributes[key]);\n\t\t\t});\n\t\t\tconst tempRange = node.ownerDocument.createRange();\n\t\t\ttempRange.selectNode(node);\n\t\t\ttempRange.surroundContents(highlightElement);\n\t\t\treturn highlightElement;\n\t\t}\n\n\t\tif (range.collapsed) {\n\t\t\treturn {\n\t\t\t\tremove: () => { },\n\t\t\t\tupdate: () => { }\n\t\t\t};\n\t\t}\n\n\t\t// First put all nodes in an array (splits start and end nodes if needed)\n\t\tconst nodes = _textNodesInRange(range);\n\n\t\t// Highlight each node\n\t\tconst highlightElements: Element[] = [];\n\t\tfor (const nodeIdx in nodes) {\n\t\t\tconst highlightElement = wrapNodeInHighlight(nodes[nodeIdx], tagName, attributes);\n\t\t\thighlightElements.push(highlightElement);\n\t\t}\n\n\t\t// Remove a highlight element created with wrapNodeInHighlight.\n\t\tfunction _removeHighlight(highlightElement: Element) {\n\t\t\tif (highlightElement.childNodes.length === 1) {\n\t\t\t\thighlightElement.replaceWith(highlightElement.firstChild!);\n\t\t\t} else {\n\t\t\t\t// If the highlight somehow contains multiple nodes now, move them all.\n\t\t\t\twhile (highlightElement.firstChild) {\n\t\t\t\t\thighlightElement.parentNode?.insertBefore(highlightElement.firstChild, highlightElement);\n\t\t\t\t}\n\t\t\t\thighlightElement.remove();\n\t\t\t}\n\t\t}\n\n\t\t// Return a function that cleans up the highlightElements.\n\t\tfunction _removeHighlights() {\n\t\t\t// Remove each of the created highlightElements.\n\t\t\tfor (const highlightIdx in highlightElements) {\n\t\t\t\t_removeHighlight(highlightElements[highlightIdx]);\n\t\t\t}\n\t\t}\n\n\t\tfunction _updateHighlight(highlightElement: Element, attributes: any = {}) {\n\t\t\tObject.keys(attributes).forEach(key => {\n\t\t\t\thighlightElement.setAttribute(key, attributes[key]);\n\t\t\t});\n\t\t}\n\n\t\tfunction updateHighlights(attributes: any) {\n\t\t\tfor (const highlightIdx in highlightElements) {\n\t\t\t\t_updateHighlight(highlightElements[highlightIdx], attributes);\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tremove: _removeHighlights,\n\t\t\tupdate: updateHighlights\n\t\t};\n\t}\n\n\tinterface ICommonRange {\n\t\tcollapsed: boolean;\n\t\tcommonAncestorContainer: Node;\n\t\tendContainer: Node;\n\t\tendOffset: number;\n\t\tstartContainer: Node;\n\t\tstartOffset: number;\n\n\t}\n\n\tinterface IHighlightResult {\n\t\trange: ICommonRange;\n\t\tdispose: () => void;\n\t\tupdate: (color: string | undefined, className: string | undefined) => void;\n\t}\n\n\tfunction selectRange(_range: ICommonRange) {\n\t\tconst sel = window.getSelection();\n\t\tif (sel) {\n\t\t\ttry {\n\t\t\t\tsel.removeAllRanges();\n\t\t\t\tconst r = document.createRange();\n\t\t\t\tr.setStart(_range.startContainer, _range.startOffset);\n\t\t\t\tr.setEnd(_range.endContainer, _range.endOffset);\n\t\t\t\tsel.addRange(r);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.log(e);\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction highlightRange(range: Range, useCustom: boolean, tagName = 'mark', attributes = {}): IHighlightResult {\n\t\tif (useCustom) {\n\t\t\tconst ret = _internalHighlightRange(range, tagName, attributes);\n\t\t\treturn {\n\t\t\t\trange: range,\n\t\t\t\tdispose: ret.remove,\n\t\t\t\tupdate: (color: string | undefined, className: string | undefined) => {\n\t\t\t\t\tif (className === undefined) {\n\t\t\t\t\t\tret.update({\n\t\t\t\t\t\t\t'style': `background-color: ${color}`\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tret.update({\n\t\t\t\t\t\t\t'class': className\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t} else {\n\t\t\twindow.document.execCommand('hiliteColor', false, matchColor);\n\t\t\tconst cloneRange = window.getSelection()!.getRangeAt(0).cloneRange();\n\t\t\tconst _range = {\n\t\t\t\tcollapsed: cloneRange.collapsed,\n\t\t\t\tcommonAncestorContainer: cloneRange.commonAncestorContainer,\n\t\t\t\tendContainer: cloneRange.endContainer,\n\t\t\t\tendOffset: cloneRange.endOffset,\n\t\t\t\tstartContainer: cloneRange.startContainer,\n\t\t\t\tstartOffset: cloneRange.startOffset\n\t\t\t};\n\t\t\treturn {\n\t\t\t\trange: _range,\n\t\t\t\tdispose: () => {\n\t\t\t\t\tselectRange(_range);\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdocument.designMode = 'On';\n\t\t\t\t\t\twindow.document.execCommand('removeFormat', false, undefined);\n\t\t\t\t\t\tdocument.designMode = 'Off';\n\t\t\t\t\t\twindow.getSelection()?.removeAllRanges();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tconsole.log(e);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tupdate: (color: string | undefined, className: string | undefined) => {\n\t\t\t\t\tselectRange(_range);\n\t\t\t\t\ttry {\n\t\t\t\t\t\tdocument.designMode = 'On';\n\t\t\t\t\t\twindow.document.execCommand('removeFormat', false, undefined);\n\t\t\t\t\t\twindow.document.execCommand('hiliteColor', false, color);\n\t\t\t\t\t\tdocument.designMode = 'Off';\n\t\t\t\t\t\twindow.getSelection()?.removeAllRanges();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tconsole.log(e);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n\n\tfunction createEmitter<T>(listenerChange: (listeners: Set<Listener<T>>) => void = () => undefined): EmitterLike<T> {\n\t\tconst listeners = new Set<Listener<T>>();\n\t\treturn {\n\t\t\tfire(data) {\n\t\t\t\tfor (const listener of [...listeners]) {\n\t\t\t\t\tlistener.fn.call(listener.thisArg, data);\n\t\t\t\t}\n\t\t\t},\n\t\t\tevent(fn, thisArg, disposables) {\n\t\t\t\tconst listenerObj = { fn, thisArg };\n\t\t\t\tconst disposable: IDisposable = {\n\t\t\t\t\tdispose: () => {\n\t\t\t\t\t\tlisteners.delete(listenerObj);\n\t\t\t\t\t\tlistenerChange(listeners);\n\t\t\t\t\t},\n\t\t\t\t};\n\n\t\t\t\tlisteners.add(listenerObj);\n\t\t\t\tlistenerChange(listeners);\n\n\t\t\t\tif (disposables instanceof Array) {\n\t\t\t\t\tdisposables.push(disposable);\n\t\t\t\t} else if (disposables) {\n\t\t\t\t\tdisposables.add(disposable);\n\t\t\t\t}\n\n\t\t\t\treturn disposable;\n\t\t\t},\n\t\t};\n\t}\n\n\tfunction showRenderError(errorText: string, outputNode: HTMLElement, errors: readonly Error[]) {\n\t\toutputNode.innerText = errorText;\n\t\tconst errList = document.createElement('ul');\n\t\tfor (const result of errors) {\n\t\t\tconsole.error(result);\n\t\t\tconst item = document.createElement('li');\n\t\t\titem.innerText = result.message;\n\t\t\terrList.appendChild(item);\n\t\t}\n\t\toutputNode.appendChild(errList);\n\t}\n\n\tconst outputItemRequests = new class {\n\t\tprivate _requestPool = 0;\n\t\tprivate readonly _requests = new Map</*requestId*/number, { resolve: (x: webviewMessages.OutputItemEntry | undefined) => void }>();\n\n\t\tgetOutputItem(outputId: string, mime: string) {\n\t\t\tconst requestId = this._requestPool++;\n\n\t\t\tconst { promise, resolve } = promiseWithResolvers<webviewMessages.OutputItemEntry | undefined>();\n\t\t\tthis._requests.set(requestId, { resolve });\n\n\t\t\tpostNotebookMessage<webviewMessages.IGetOutputItemMessage>('getOutputItem', { requestId, outputId, mime });\n\t\t\treturn promise;\n\t\t}\n\n\t\tresolveOutputItem(requestId: number, output: webviewMessages.OutputItemEntry | undefined) {\n\t\t\tconst request = this._requests.get(requestId);\n\t\t\tif (!request) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._requests.delete(requestId);\n\t\t\trequest.resolve(output);\n\t\t}\n\t};\n\n\tinterface AdditionalOutputItemInfo {\n\t\treadonly mime: string;\n\t\tgetItem(): Promise<rendererApi.OutputItem | undefined>;\n\t}\n\n\tinterface ExtendedOutputItem extends rendererApi.OutputItem {\n\t\treadonly _allOutputItems: ReadonlyArray<AdditionalOutputItemInfo>;\n\t\tappendedText?(): string | undefined;\n\t}\n\n\tlet hasWarnedAboutAllOutputItemsProposal = false;\n\n\tfunction createOutputItem(\n\t\tid: string,\n\t\tmime: string,\n\t\tmetadata: unknown,\n\t\tvalueBytes: Uint8Array,\n\t\tallOutputItemData: ReadonlyArray<{ readonly mime: string }>,\n\t\tappended?: { valueBytes: Uint8Array; previousVersion: number }\n\t): ExtendedOutputItem {\n\n\t\tfunction create(\n\t\t\tid: string,\n\t\t\tmime: string,\n\t\t\tmetadata: unknown,\n\t\t\tvalueBytes: Uint8Array,\n\t\t\tappended?: { valueBytes: Uint8Array; previousVersion: number }\n\t\t): ExtendedOutputItem {\n\t\t\treturn Object.freeze<ExtendedOutputItem>({\n\t\t\t\tid,\n\t\t\t\tmime,\n\t\t\t\tmetadata,\n\n\t\t\t\tappendedText(): string | undefined {\n\t\t\t\t\tif (appended) {\n\t\t\t\t\t\treturn textDecoder.decode(appended.valueBytes);\n\t\t\t\t\t}\n\t\t\t\t\treturn undefined;\n\t\t\t\t},\n\n\t\t\t\tdata(): Uint8Array {\n\t\t\t\t\treturn valueBytes;\n\t\t\t\t},\n\n\t\t\t\ttext(): string {\n\t\t\t\t\treturn textDecoder.decode(valueBytes);\n\t\t\t\t},\n\n\t\t\t\tjson() {\n\t\t\t\t\treturn JSON.parse(this.text());\n\t\t\t\t},\n\n\t\t\t\tblob(): Blob {\n\t\t\t\t\treturn new Blob([valueBytes as Uint8Array<ArrayBuffer>], { type: this.mime });\n\t\t\t\t},\n\n\t\t\t\tget _allOutputItems() {\n\t\t\t\t\tif (!hasWarnedAboutAllOutputItemsProposal) {\n\t\t\t\t\t\thasWarnedAboutAllOutputItemsProposal = true;\n\t\t\t\t\t\tconsole.warn(`'_allOutputItems' is proposed API. DO NOT ship an extension that depends on it!`);\n\t\t\t\t\t}\n\t\t\t\t\treturn allOutputItemList;\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\n\t\tconst allOutputItemCache = new Map</*mime*/string, Promise<(rendererApi.OutputItem & ExtendedOutputItem) | undefined>>();\n\t\tconst allOutputItemList = Object.freeze(allOutputItemData.map(outputItem => {\n\t\t\tconst mime = outputItem.mime;\n\t\t\treturn Object.freeze({\n\t\t\t\tmime,\n\t\t\t\tgetItem() {\n\t\t\t\t\tconst existingTask = allOutputItemCache.get(mime);\n\t\t\t\t\tif (existingTask) {\n\t\t\t\t\t\treturn existingTask;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst task = outputItemRequests.getOutputItem(id, mime).then(item => {\n\t\t\t\t\t\treturn item ? create(id, item.mime, metadata, item.valueBytes) : undefined;\n\t\t\t\t\t});\n\t\t\t\t\tallOutputItemCache.set(mime, task);\n\n\t\t\t\t\treturn task;\n\t\t\t\t}\n\t\t\t});\n\t\t}));\n\n\t\tconst item = create(id, mime, metadata, valueBytes, appended);\n\t\tallOutputItemCache.set(mime, Promise.resolve(item));\n\t\treturn item;\n\t}\n\n\tconst onDidReceiveKernelMessage = createEmitter<unknown>();\n\n\tconst ttPolicy = window.trustedTypes?.createPolicy('notebookRenderer', {\n\t\tcreateHTML: value => value, // CodeQL [SM03712] The rendered content is provided by renderer extensions, which are responsible for sanitizing their content themselves. The notebook webview is also sandboxed.\n\t\tcreateScript: value => value, // CodeQL [SM03712] The rendered content is provided by renderer extensions, which are responsible for sanitizing their content themselves. The notebook webview is also sandboxed.\n\t});\n\n\twindow.addEventListener('wheel', handleWheel);\n\n\tinterface IFindMatch {\n\t\ttype: 'preview' | 'output';\n\t\tid: string;\n\t\tcellId: string;\n\t\tcontainer: Node;\n\t\toriginalRange: Range;\n\t\tisShadow: boolean;\n\t\tsearchPreviewInfo?: ISearchPreviewInfo;\n\t\thighlightResult?: IHighlightResult;\n\t}\n\n\tinterface ISearchPreviewInfo {\n\t\tline: string;\n\t\trange: {\n\t\t\tstart: number;\n\t\t\tend: number;\n\t\t};\n\t}\n\n\tinterface IHighlighter {\n\t\taddHighlights(matches: IFindMatch[], ownerID: string): void;\n\t\tremoveHighlights(ownerID: string): void;\n\t\thighlightCurrentMatch(index: number, ownerID: string): void;\n\t\tunHighlightCurrentMatch(index: number, ownerID: string): void;\n\t\tdispose(): void;\n\t}\n\n\tinterface IHighlightInfo {\n\t\tmatches: IFindMatch[];\n\t\tcurrentMatchIndex: number;\n\t}\n\n\tconst matchColor = window.getComputedStyle(window.document.getElementById('_defaultColorPalatte')!).color;\n\tconst currentMatchColor = window.getComputedStyle(window.document.getElementById('_defaultColorPalatte')!).backgroundColor;\n\n\tclass JSHighlighter implements IHighlighter {\n\t\tprivate _activeHighlightInfo: Map<string, IHighlightInfo>;\n\n\t\tconstructor(\n\t\t) {\n\t\t\tthis._activeHighlightInfo = new Map();\n\t\t}\n\n\t\taddHighlights(matches: IFindMatch[], ownerID: string): void {\n\t\t\tfor (let i = matches.length - 1; i >= 0; i--) {\n\t\t\t\tconst match = matches[i];\n\t\t\t\tconst ret = highlightRange(match.originalRange, true, 'mark', match.isShadow ? {\n\t\t\t\t\t'style': 'background-color: ' + matchColor + ';',\n\t\t\t\t} : {\n\t\t\t\t\t'class': 'find-match'\n\t\t\t\t});\n\t\t\t\tmatch.highlightResult = ret;\n\t\t\t}\n\n\t\t\tconst highlightInfo: IHighlightInfo = {\n\t\t\t\tmatches,\n\t\t\t\tcurrentMatchIndex: -1\n\t\t\t};\n\t\t\tthis._activeHighlightInfo.set(ownerID, highlightInfo);\n\t\t}\n\n\t\tremoveHighlights(ownerID: string): void {\n\t\t\tthis._activeHighlightInfo.get(ownerID)?.matches.forEach(match => {\n\t\t\t\tmatch.highlightResult?.dispose();\n\t\t\t});\n\t\t\tthis._activeHighlightInfo.delete(ownerID);\n\t\t}\n\n\t\thighlightCurrentMatch(index: number, ownerID: string) {\n\t\t\tconst highlightInfo = this._activeHighlightInfo.get(ownerID);\n\t\t\tif (!highlightInfo) {\n\t\t\t\tconsole.error('Modified current highlight match before adding highlight list.');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst oldMatch = highlightInfo.matches[highlightInfo.currentMatchIndex];\n\t\t\toldMatch?.highlightResult?.update(matchColor, oldMatch.isShadow ? undefined : 'find-match');\n\n\t\t\tconst match = highlightInfo.matches[index];\n\t\t\thighlightInfo.currentMatchIndex = index;\n\t\t\tconst sel = window.getSelection();\n\t\t\tif (!!match && !!sel && match.highlightResult) {\n\t\t\t\tlet offset = 0;\n\t\t\t\ttry {\n\t\t\t\t\tconst outputOffset = window.document.getElementById(match.id)!.getBoundingClientRect().top;\n\t\t\t\t\tconst tempRange = document.createRange();\n\t\t\t\t\ttempRange.selectNode(match.highlightResult.range.startContainer);\n\n\t\t\t\t\tmatch.highlightResult.range.startContainer.parentElement?.scrollIntoView({ behavior: 'auto', block: 'end', inline: 'nearest' });\n\n\t\t\t\t\tconst rangeOffset = tempRange.getBoundingClientRect().top;\n\t\t\t\t\ttempRange.detach();\n\n\t\t\t\t\toffset = rangeOffset - outputOffset;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t}\n\n\t\t\t\tmatch.highlightResult?.update(currentMatchColor, match.isShadow ? undefined : 'current-find-match');\n\n\t\t\t\twindow.document.getSelection()?.removeAllRanges();\n\t\t\t\tpostNotebookMessage('didFindHighlightCurrent', {\n\t\t\t\t\toffset\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tunHighlightCurrentMatch(index: number, ownerID: string) {\n\t\t\tconst highlightInfo = this._activeHighlightInfo.get(ownerID);\n\t\t\tif (!highlightInfo) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst oldMatch = highlightInfo.matches[index];\n\t\t\tif (oldMatch && oldMatch.highlightResult) {\n\t\t\t\toldMatch.highlightResult.update(matchColor, oldMatch.isShadow ? undefined : 'find-match');\n\t\t\t}\n\t\t}\n\n\t\tdispose() {\n\t\t\twindow.document.getSelection()?.removeAllRanges();\n\t\t\tthis._activeHighlightInfo.forEach(highlightInfo => {\n\t\t\t\thighlightInfo.matches.forEach(match => {\n\t\t\t\t\tmatch.highlightResult?.dispose();\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tclass CSSHighlighter implements IHighlighter {\n\t\tprivate _activeHighlightInfo: Map<string, IHighlightInfo>;\n\t\tprivate _matchesHighlight: Highlight;\n\t\tprivate _currentMatchesHighlight: Highlight;\n\n\t\tconstructor() {\n\t\t\tthis._activeHighlightInfo = new Map();\n\t\t\tthis._matchesHighlight = new Highlight();\n\t\t\tthis._matchesHighlight.priority = 1;\n\t\t\tthis._currentMatchesHighlight = new Highlight();\n\t\t\tthis._currentMatchesHighlight.priority = 2;\n\t\t\tCSS.highlights?.set(`find-highlight`, this._matchesHighlight);\n\t\t\tCSS.highlights?.set(`current-find-highlight`, this._currentMatchesHighlight);\n\t\t}\n\n\t\t_refreshRegistry(updateMatchesHighlight = true) {\n\t\t\t// for performance reasons, only update the full list of highlights when we need to\n\t\t\tif (updateMatchesHighlight) {\n\t\t\t\tthis._matchesHighlight.clear();\n\t\t\t}\n\n\t\t\tthis._currentMatchesHighlight.clear();\n\n\t\t\tthis._activeHighlightInfo.forEach((highlightInfo) => {\n\n\t\t\t\tif (updateMatchesHighlight) {\n\t\t\t\t\tfor (let i = 0; i < highlightInfo.matches.length; i++) {\n\t\t\t\t\t\tthis._matchesHighlight.add(highlightInfo.matches[i].originalRange);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (highlightInfo.currentMatchIndex < highlightInfo.matches.length && highlightInfo.currentMatchIndex >= 0) {\n\t\t\t\t\tthis._currentMatchesHighlight.add(highlightInfo.matches[highlightInfo.currentMatchIndex].originalRange);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\taddHighlights(\n\t\t\tmatches: IFindMatch[],\n\t\t\townerID: string\n\t\t) {\n\n\t\t\tfor (let i = 0; i < matches.length; i++) {\n\t\t\t\tthis._matchesHighlight.add(matches[i].originalRange);\n\t\t\t}\n\n\t\t\tconst newEntry: IHighlightInfo = {\n\t\t\t\tmatches,\n\t\t\t\tcurrentMatchIndex: -1,\n\t\t\t};\n\n\t\t\tthis._activeHighlightInfo.set(ownerID, newEntry);\n\t\t}\n\n\t\thighlightCurrentMatch(index: number, ownerID: string): void {\n\t\t\tconst highlightInfo = this._activeHighlightInfo.get(ownerID);\n\t\t\tif (!highlightInfo) {\n\t\t\t\tconsole.error('Modified current highlight match before adding highlight list.');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\thighlightInfo.currentMatchIndex = index;\n\t\t\tconst match = highlightInfo.matches[index];\n\n\t\t\tif (match) {\n\t\t\t\tlet offset = 0;\n\t\t\t\ttry {\n\t\t\t\t\tconst outputOffset = window.document.getElementById(match.id)!.getBoundingClientRect().top;\n\t\t\t\t\tmatch.originalRange.startContainer.parentElement?.scrollIntoView({ behavior: 'auto', block: 'end', inline: 'nearest' });\n\t\t\t\t\tconst rangeOffset = match.originalRange.getBoundingClientRect().top;\n\t\t\t\t\toffset = rangeOffset - outputOffset;\n\t\t\t\t\tpostNotebookMessage('didFindHighlightCurrent', {\n\t\t\t\t\t\toffset\n\t\t\t\t\t});\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(e);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._refreshRegistry(false);\n\t\t}\n\n\t\tunHighlightCurrentMatch(index: number, ownerID: string): void {\n\t\t\tconst highlightInfo = this._activeHighlightInfo.get(ownerID);\n\t\t\tif (!highlightInfo) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\thighlightInfo.currentMatchIndex = -1;\n\t\t}\n\n\t\tremoveHighlights(ownerID: string) {\n\t\t\tthis._activeHighlightInfo.delete(ownerID);\n\t\t\tthis._refreshRegistry();\n\t\t}\n\n\t\tdispose(): void {\n\t\t\twindow.document.getSelection()?.removeAllRanges();\n\t\t\tthis._currentMatchesHighlight.clear();\n\t\t\tthis._matchesHighlight.clear();\n\t\t}\n\t}\n\n\tconst _highlighter = (CSS.highlights) ? new CSSHighlighter() : new JSHighlighter();\n\n\tfunction extractSelectionLine(selection: Selection): ISearchPreviewInfo {\n\t\tconst range = selection.getRangeAt(0);\n\n\t\t// we need to keep a reference to the old selection range to re-apply later\n\t\tconst oldRange = range.cloneRange();\n\t\tconst captureLength = selection.toString().length;\n\n\t\t// use selection API to modify selection to get entire line (the first line if multi-select)\n\n\t\t// collapse selection to start so that the cursor position is at beginning of match\n\t\tselection.collapseToStart();\n\n\t\t// extend selection in both directions to select the line\n\t\tselection.modify('move', 'backward', 'lineboundary');\n\t\tselection.modify('extend', 'forward', 'lineboundary');\n\n\t\tconst line = selection.toString();\n\n\t\t// using the original range and the new range, we can find the offset of the match from the line start.\n\t\tconst rangeStart = getStartOffset(selection.getRangeAt(0), oldRange);\n\n\t\t// line range for match\n\t\tconst lineRange = {\n\t\t\tstart: rangeStart,\n\t\t\tend: rangeStart + captureLength,\n\t\t};\n\n\t\t// re-add the old range so that the selection is restored\n\t\tselection.removeAllRanges();\n\t\tselection.addRange(oldRange);\n\n\t\treturn { line, range: lineRange };\n\t}\n\n\tfunction getStartOffset(lineRange: Range, originalRange: Range) {\n\t\t// sometimes, the old and new range are in different DOM elements (ie: when the match is inside of <b></b>)\n\t\t// so we need to find the first common ancestor DOM element and find the positions of the old and new range relative to that.\n\t\tconst firstCommonAncestor = findFirstCommonAncestor(lineRange.startContainer, originalRange.startContainer);\n\n\t\tconst selectionOffset = getSelectionOffsetRelativeTo(firstCommonAncestor, lineRange.startContainer) + lineRange.startOffset;\n\t\tconst textOffset = getSelectionOffsetRelativeTo(firstCommonAncestor, originalRange.startContainer) + originalRange.startOffset;\n\t\treturn textOffset - selectionOffset;\n\t}\n\n\t// modified from https://stackoverflow.com/a/68583466/16253823\n\tfunction findFirstCommonAncestor(nodeA: Node, nodeB: Node) {\n\t\tconst range = new Range();\n\t\trange.setStart(nodeA, 0);\n\t\trange.setEnd(nodeB, 0);\n\t\treturn range.commonAncestorContainer;\n\t}\n\n\tfunction getTextContentLength(node: Node): number {\n\t\tlet length = 0;\n\n\t\tif (node.nodeType === Node.TEXT_NODE) {\n\t\t\tlength += node.textContent?.length || 0;\n\t\t} else {\n\t\t\tfor (const childNode of node.childNodes) {\n\t\t\t\tlength += getTextContentLength(childNode);\n\t\t\t}\n\t\t}\n\n\t\treturn length;\n\t}\n\n\t// modified from https://stackoverflow.com/a/48812529/16253823\n\tfunction getSelectionOffsetRelativeTo(parentElement: Node, currentNode: Node | null): number {\n\t\tif (!currentNode) {\n\t\t\treturn 0;\n\t\t}\n\t\tlet offset = 0;\n\n\t\tif (currentNode === parentElement || !parentElement.contains(currentNode)) {\n\t\t\treturn offset;\n\t\t}\n\n\n\t\t// count the number of chars before the current dom elem and the start of the dom\n\t\tlet prevSibling = currentNode.previousSibling;\n\t\twhile (prevSibling) {\n\t\t\toffset += getTextContentLength(prevSibling);\n\t\t\tprevSibling = prevSibling.previousSibling;\n\t\t}\n\n\t\treturn offset + getSelectionOffsetRelativeTo(parentElement, currentNode.parentNode);\n\t}\n\n\tconst find = (query: string, options: { wholeWord?: boolean; caseSensitive?: boolean; includeMarkup: boolean; includeOutput: boolean; shouldGetSearchPreviewInfo: boolean; ownerID: string; findIds: string[] }) => {\n\t\tlet find = true;\n\t\tlet matches: IFindMatch[] = [];\n\n\t\tconst range = document.createRange();\n\t\trange.selectNodeContents(window.document.getElementById('findStart')!);\n\t\tconst sel = window.getSelection();\n\t\tsel?.removeAllRanges();\n\t\tsel?.addRange(range);\n\n\t\tviewModel.toggleDragDropEnabled(false);\n\n\t\ttry {\n\t\t\tdocument.designMode = 'On';\n\n\t\t\twhile (find && matches.length < 500) {\n\t\t\t\tfind = (window as unknown as { find: (query: string, caseSensitive: boolean, backwards: boolean, wrapAround: boolean, wholeWord: boolean, searchInFrames: boolean, includeMarkup: boolean) => boolean }).find(query, /* caseSensitive*/ !!options.caseSensitive,\n\t\t\t\t/* backwards*/ false,\n\t\t\t\t/* wrapAround*/ false,\n\t\t\t\t/* wholeWord */ !!options.wholeWord,\n\t\t\t\t/* searchInFrames*/ true,\n\t\t\t\t\tfalse);\n\n\t\t\t\tif (find) {\n\t\t\t\t\tconst selection = window.getSelection();\n\t\t\t\t\tif (!selection) {\n\t\t\t\t\t\tconsole.log('no selection');\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Markdown preview are rendered in a shadow DOM.\n\t\t\t\t\tif (options.includeMarkup && selection.rangeCount > 0 && selection.getRangeAt(0).startContainer.nodeType === 1\n\t\t\t\t\t\t&& (selection.getRangeAt(0).startContainer as Element).classList.contains('markup')) {\n\t\t\t\t\t\t// markdown preview container\n\t\t\t\t\t\tconst preview = (selection.anchorNode?.firstChild as Element);\n\t\t\t\t\t\tconst root = preview.shadowRoot as ShadowRoot & { getSelection: () => Selection };\n\t\t\t\t\t\tconst shadowSelection = root?.getSelection ? root?.getSelection() : null;\n\t\t\t\t\t\t// find the match in the shadow dom by checking the selection inside the shadow dom\n\t\t\t\t\t\tif (shadowSelection && shadowSelection.anchorNode) {\n\t\t\t\t\t\t\tmatches.push({\n\t\t\t\t\t\t\t\ttype: 'preview',\n\t\t\t\t\t\t\t\tid: preview.id,\n\t\t\t\t\t\t\t\tcellId: preview.id,\n\t\t\t\t\t\t\t\tcontainer: preview,\n\t\t\t\t\t\t\t\tisShadow: true,\n\t\t\t\t\t\t\t\toriginalRange: shadowSelection.getRangeAt(0),\n\t\t\t\t\t\t\t\tsearchPreviewInfo: options.shouldGetSearchPreviewInfo ? extractSelectionLine(shadowSelection) : undefined,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Outputs might be rendered inside a shadow DOM.\n\t\t\t\t\tif (options.includeOutput && selection.rangeCount > 0 && selection.getRangeAt(0).startContainer.nodeType === 1\n\t\t\t\t\t\t&& (selection.getRangeAt(0).startContainer as Element).classList.contains('output_container')) {\n\t\t\t\t\t\t// output container\n\t\t\t\t\t\tconst cellId = selection.getRangeAt(0).startContainer.parentElement!.id;\n\t\t\t\t\t\tconst outputNode = (selection.anchorNode?.firstChild as Element);\n\t\t\t\t\t\tconst root = outputNode.shadowRoot as ShadowRoot & { getSelection: () => Selection };\n\t\t\t\t\t\tconst shadowSelection = root?.getSelection ? root?.getSelection() : null;\n\t\t\t\t\t\tif (shadowSelection && shadowSelection.anchorNode) {\n\t\t\t\t\t\t\tmatches.push({\n\t\t\t\t\t\t\t\ttype: 'output',\n\t\t\t\t\t\t\t\tid: outputNode.id,\n\t\t\t\t\t\t\t\tcellId: cellId,\n\t\t\t\t\t\t\t\tcontainer: outputNode,\n\t\t\t\t\t\t\t\tisShadow: true,\n\t\t\t\t\t\t\t\toriginalRange: shadowSelection.getRangeAt(0),\n\t\t\t\t\t\t\t\tsearchPreviewInfo: options.shouldGetSearchPreviewInfo ? extractSelectionLine(shadowSelection) : undefined,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst anchorNode = selection.anchorNode?.parentElement;\n\n\t\t\t\t\tif (anchorNode) {\n\t\t\t\t\t\tconst lastEl: any = matches.length ? matches[matches.length - 1] : null;\n\n\t\t\t\t\t\t// Optimization: avoid searching for the output container\n\t\t\t\t\t\tif (lastEl && lastEl.container.contains(anchorNode) && options.includeOutput) {\n\t\t\t\t\t\t\tmatches.push({\n\t\t\t\t\t\t\t\ttype: lastEl.type,\n\t\t\t\t\t\t\t\tid: lastEl.id,\n\t\t\t\t\t\t\t\tcellId: lastEl.cellId,\n\t\t\t\t\t\t\t\tcontainer: lastEl.container,\n\t\t\t\t\t\t\t\tisShadow: false,\n\t\t\t\t\t\t\t\toriginalRange: selection.getRangeAt(0),\n\t\t\t\t\t\t\t\tsearchPreviewInfo: options.shouldGetSearchPreviewInfo ? extractSelectionLine(selection) : undefined,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Traverse up the DOM to find the container\n\t\t\t\t\t\t\tfor (let node = anchorNode as Element | null; node; node = node.parentElement) {\n\t\t\t\t\t\t\t\tif (!(node instanceof Element)) {\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (node.classList.contains('output') && options.includeOutput) {\n\t\t\t\t\t\t\t\t\t// inside output\n\t\t\t\t\t\t\t\t\tconst cellId = node.parentElement?.parentElement?.id;\n\t\t\t\t\t\t\t\t\tif (cellId) {\n\t\t\t\t\t\t\t\t\t\tmatches.push({\n\t\t\t\t\t\t\t\t\t\t\ttype: 'output',\n\t\t\t\t\t\t\t\t\t\t\tid: node.id,\n\t\t\t\t\t\t\t\t\t\t\tcellId: cellId,\n\t\t\t\t\t\t\t\t\t\t\tcontainer: node,\n\t\t\t\t\t\t\t\t\t\t\tisShadow: false,\n\t\t\t\t\t\t\t\t\t\t\toriginalRange: selection.getRangeAt(0),\n\t\t\t\t\t\t\t\t\t\t\tsearchPreviewInfo: options.shouldGetSearchPreviewInfo ? extractSelectionLine(selection) : undefined,\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (node.id === 'container' || node === window.document.body) {\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t} else {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.log(e);\n\t\t}\n\n\n\t\tmatches = matches.filter(match => options.findIds.length ? options.findIds.includes(match.cellId) : true);\n\t\t_highlighter.addHighlights(matches, options.ownerID);\n\t\twindow.document.getSelection()?.removeAllRanges();\n\n\t\tviewModel.toggleDragDropEnabled(currentOptions.dragAndDropEnabled);\n\n\t\tdocument.designMode = 'Off';\n\n\t\tpostNotebookMessage('didFind', {\n\t\t\tmatches: matches.map((match, index) => ({\n\t\t\t\ttype: match.type,\n\t\t\t\tid: match.id,\n\t\t\t\tcellId: match.cellId,\n\t\t\t\tindex,\n\t\t\t\tsearchPreviewInfo: match.searchPreviewInfo,\n\t\t\t}))\n\t\t});\n\t};\n\n\tconst copyOutputImage = async (outputId: string, altOutputId: string, textAlternates?: { mimeType: string; content: string }[], retries = 5) => {\n\t\tif (!window.document.hasFocus() && retries > 0) {\n\t\t\t// copyImage can be called from outside of the webview, which means this function may be running whilst the webview is gaining focus.\n\t\t\t// Since navigator.clipboard.write requires the document to be focused, we need to wait for focus.\n\t\t\t// We cannot use a listener, as there is a high chance the focus is gained during the setup of the listener resulting in us missing it.\n\t\t\tsetTimeout(() => { copyOutputImage(outputId, altOutputId, textAlternates, retries - 1); }, 50);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst outputElement = window.document.getElementById(outputId)\n\t\t\t\t?? window.document.getElementById(altOutputId);\n\n\t\t\tlet image = outputElement?.querySelector('img');\n\n\t\t\tif (!image) {\n\t\t\t\tconst svgImage = outputElement?.querySelector('svg.output-image') ??\n\t\t\t\t\toutputElement?.querySelector('div.svgContainerStyle > svg');\n\n\t\t\t\tif (svgImage) {\n\t\t\t\t\timage = new Image();\n\t\t\t\t\timage.src = 'data:image/svg+xml,' + encodeURIComponent(svgImage.outerHTML);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (image) {\n\t\t\t\tconst ensureImageLoaded = (img: HTMLImageElement): Promise<HTMLImageElement> => {\n\t\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\t\tif (img.complete && img.naturalWidth > 0) {\n\t\t\t\t\t\t\tresolve(img);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\timg.onload = () => resolve(img);\n\t\t\t\t\t\t\timg.onerror = () => reject(new Error('Failed to load image'));\n\t\t\t\t\t\t\tsetTimeout(() => reject(new Error('Image load timeout')), 5000);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t};\n\t\t\t\tconst imageToCopy = await ensureImageLoaded(image);\n\n\t\t\t\t// Build clipboard data with both image and text formats\n\t\t\t\tconst clipboardData: Record<string, any> = {\n\t\t\t\t\t'image/png': new Promise((resolve) => {\n\t\t\t\t\t\tconst canvas = document.createElement('canvas');\n\t\t\t\t\t\tcanvas.width = imageToCopy.naturalWidth;\n\t\t\t\t\t\tcanvas.height = imageToCopy.naturalHeight;\n\t\t\t\t\t\tconst context = canvas.getContext('2d');\n\t\t\t\t\t\tcontext!.drawImage(imageToCopy, 0, 0);\n\n\t\t\t\t\t\tcanvas.toBlob((blob) => {\n\t\t\t\t\t\t\tif (blob) {\n\t\t\t\t\t\t\t\tresolve(blob);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconsole.error('No blob data to write to clipboard');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcanvas.remove();\n\t\t\t\t\t\t}, 'image/png');\n\t\t\t\t\t})\n\t\t\t\t};\n\n\t\t\t\t// Add text alternates if provided\n\t\t\t\tif (textAlternates) {\n\t\t\t\t\tfor (const alternate of textAlternates) {\n\t\t\t\t\t\tclipboardData[alternate.mimeType] = alternate.content;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tawait navigator.clipboard.write([new ClipboardItem(clipboardData)]);\n\t\t\t} else {\n\t\t\t\tconsole.error('Could not find image element to copy for output with id', outputId);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error('Could not copy image:', e);\n\t\t}\n\t};\n\n\twindow.addEventListener('message', async rawEvent => {\n\t\tconst event = rawEvent as ({ data: webviewMessages.ToWebviewMessage });\n\n\t\tswitch (event.data.type) {\n\t\t\tcase 'initializeMarkup': {\n\t\t\t\ttry {\n\t\t\t\t\tawait Promise.all(event.data.cells.map(info => viewModel.ensureMarkupCell(info)));\n\t\t\t\t} finally {\n\t\t\t\t\tdimensionUpdater.updateImmediately();\n\t\t\t\t\tpostNotebookMessage('initializedMarkup', { requestId: event.data.requestId });\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'createMarkupCell':\n\t\t\t\tviewModel.ensureMarkupCell(event.data.cell);\n\t\t\t\tbreak;\n\n\t\t\tcase 'showMarkupCell':\n\t\t\t\tviewModel.showMarkupCell(event.data.id, event.data.top, event.data.content, event.data.metadata);\n\t\t\t\tbreak;\n\n\t\t\tcase 'hideMarkupCells':\n\t\t\t\tfor (const id of event.data.ids) {\n\t\t\t\t\tviewModel.hideMarkupCell(id);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'unhideMarkupCells':\n\t\t\t\tfor (const id of event.data.ids) {\n\t\t\t\t\tviewModel.unhideMarkupCell(id);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'deleteMarkupCell':\n\t\t\t\tfor (const id of event.data.ids) {\n\t\t\t\t\tviewModel.deleteMarkupCell(id);\n\t\t\t\t}\n\t\t\t\tbreak;\n\n\t\t\tcase 'updateSelectedMarkupCells':\n\t\t\t\tviewModel.updateSelectedCells(event.data.selectedCellIds);\n\t\t\t\tbreak;\n\n\t\t\tcase 'html': {\n\t\t\t\tconst data = event.data;\n\t\t\t\tif (data.createOnIdle) {\n\t\t\t\t\toutputRunner.enqueueIdle(data.outputId, signal => {\n\t\t\t\t\t\t// cancel the idle callback if it exists\n\t\t\t\t\t\treturn viewModel.renderOutputCell(data, signal);\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\toutputRunner.enqueue(data.outputId, signal => {\n\t\t\t\t\t\t// cancel the idle callback if it exists\n\t\t\t\t\t\treturn viewModel.renderOutputCell(data, signal);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'view-scroll':\n\t\t\t\t{\n\t\t\t\t\t// const date = new Date();\n\t\t\t\t\t// console.log('----- will scroll ----  ', date.getMinutes() + ':' + date.getSeconds() + ':' + date.getMilliseconds());\n\n\t\t\t\t\tevent.data.widgets.forEach(widget => {\n\t\t\t\t\t\toutputRunner.enqueue(widget.outputId, () => {\n\t\t\t\t\t\t\tviewModel.updateOutputsScroll([widget]);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tviewModel.updateMarkupScrolls(event.data.markupCells);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\tcase 'clear':\n\t\t\t\trenderers.clearAll();\n\t\t\t\tviewModel.clearAll();\n\t\t\t\twindow.document.getElementById('container')!.innerText = '';\n\t\t\t\tbreak;\n\n\t\t\tcase 'clearOutput': {\n\t\t\t\tconst { cellId, rendererId, outputId } = event.data;\n\t\t\t\toutputRunner.cancelOutput(outputId);\n\t\t\t\tviewModel.clearOutput(cellId, outputId, rendererId);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'hideOutput': {\n\t\t\t\tconst { cellId, outputId } = event.data;\n\t\t\t\toutputRunner.enqueue(outputId, () => {\n\t\t\t\t\tviewModel.hideOutput(cellId);\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'showOutput': {\n\t\t\t\tconst { outputId, cellTop, cellId, content } = event.data;\n\t\t\t\toutputRunner.enqueue(outputId, () => {\n\t\t\t\t\tviewModel.showOutput(cellId, outputId, cellTop);\n\t\t\t\t\tif (content) {\n\t\t\t\t\t\tviewModel.updateAndRerender(cellId, outputId, content);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'copyImage': {\n\t\t\t\tawait copyOutputImage(event.data.outputId, event.data.altOutputId, event.data.textAlternates);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'ack-dimension': {\n\t\t\t\tfor (const { cellId, outputId, height } of event.data.updates) {\n\t\t\t\t\tviewModel.updateOutputHeight(cellId, outputId, height);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'preload': {\n\t\t\t\tconst resources = event.data.resources;\n\t\t\t\tfor (const { uri } of resources) {\n\t\t\t\t\tkernelPreloads.load(uri);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'updateRenderers': {\n\t\t\t\tconst { rendererData } = event.data;\n\t\t\t\trenderers.updateRendererData(rendererData);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'focus-output':\n\t\t\t\tfocusFirstFocusableOrContainerInOutput(event.data.cellOrOutputId, event.data.alternateId);\n\t\t\t\tbreak;\n\t\t\tcase 'blur-output':\n\t\t\t\tblurOutput();\n\t\t\t\tbreak;\n\t\t\tcase 'select-output-contents':\n\t\t\t\tselectOutputContents(event.data.cellOrOutputId);\n\t\t\t\tbreak;\n\t\t\tcase 'select-input-contents':\n\t\t\t\tselectInputContents(event.data.cellOrOutputId);\n\t\t\t\tbreak;\n\t\t\tcase 'decorations': {\n\t\t\t\tlet outputContainer = window.document.getElementById(event.data.cellId);\n\t\t\t\tif (!outputContainer) {\n\t\t\t\t\tviewModel.ensureOutputCell(event.data.cellId, -100000, true);\n\t\t\t\t\toutputContainer = window.document.getElementById(event.data.cellId);\n\t\t\t\t}\n\t\t\t\toutputContainer?.classList.add(...event.data.addedClassNames);\n\t\t\t\toutputContainer?.classList.remove(...event.data.removedClassNames);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'markupDecorations': {\n\t\t\t\tconst markupCell = window.document.getElementById(event.data.cellId);\n\t\t\t\t// The cell may not have been added yet if it is out of view.\n\t\t\t\t// Decorations will be added when the cell is shown.\n\t\t\t\tif (markupCell) {\n\t\t\t\t\tmarkupCell?.classList.add(...event.data.addedClassNames);\n\t\t\t\t\tmarkupCell?.classList.remove(...event.data.removedClassNames);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'customKernelMessage':\n\t\t\t\tonDidReceiveKernelMessage.fire(event.data.message);\n\t\t\t\tbreak;\n\t\t\tcase 'customRendererMessage':\n\t\t\t\trenderers.getRenderer(event.data.rendererId)?.receiveMessage(event.data.message);\n\t\t\t\tbreak;\n\t\t\tcase 'notebookStyles': {\n\t\t\t\tconst documentStyle = window.document.documentElement.style;\n\n\t\t\t\tfor (let i = documentStyle.length - 1; i >= 0; i--) {\n\t\t\t\t\tconst property = documentStyle[i];\n\n\t\t\t\t\t// Don't remove properties that the webview might have added separately\n\t\t\t\t\tif (property && property.startsWith('--notebook-')) {\n\t\t\t\t\t\tdocumentStyle.removeProperty(property);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Re-add new properties\n\t\t\t\tfor (const [name, value] of Object.entries(event.data.styles)) {\n\t\t\t\t\tdocumentStyle.setProperty(`--${name}`, value);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'notebookOptions':\n\t\t\t\tcurrentOptions = event.data.options;\n\t\t\t\tviewModel.toggleDragDropEnabled(currentOptions.dragAndDropEnabled);\n\t\t\t\tcurrentRenderOptions = event.data.renderOptions;\n\t\t\t\tsettingChange.fire(currentRenderOptions);\n\t\t\t\tbreak;\n\t\t\tcase 'tokenizedCodeBlock': {\n\t\t\t\tconst { codeBlockId, html } = event.data;\n\t\t\t\tMarkdownCodeBlock.highlightCodeBlock(codeBlockId, html);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'tokenizedStylesChanged': {\n\t\t\t\ttokenizationStyle.replaceSync(event.data.css);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'find': {\n\t\t\t\t_highlighter.removeHighlights(event.data.options.ownerID);\n\t\t\t\tfind(event.data.query, event.data.options);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'findHighlightCurrent': {\n\t\t\t\t_highlighter?.highlightCurrentMatch(event.data.index, event.data.ownerID);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'findUnHighlightCurrent': {\n\t\t\t\t_highlighter?.unHighlightCurrentMatch(event.data.index, event.data.ownerID);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'findStop': {\n\t\t\t\t_highlighter.removeHighlights(event.data.ownerID);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 'returnOutputItem': {\n\t\t\t\toutputItemRequests.resolveOutputItem(event.data.requestId, event.data.output);\n\t\t\t}\n\t\t}\n\t});\n\n\tconst renderFallbackErrorName = 'vscode.fallbackToNextRenderer';\n\n\tclass Renderer {\n\n\t\tprivate _onMessageEvent = createEmitter();\n\t\tprivate _loadPromise?: Promise<rendererApi.RendererApi | undefined>;\n\t\tprivate _api: rendererApi.RendererApi | undefined;\n\n\t\tconstructor(\n\t\t\tpublic readonly data: webviewMessages.RendererMetadata,\n\t\t) { }\n\n\t\tpublic receiveMessage(message: unknown) {\n\t\t\tthis._onMessageEvent.fire(message);\n\t\t}\n\n\t\tpublic async renderOutputItem(item: rendererApi.OutputItem, element: HTMLElement, signal: AbortSignal): Promise<void> {\n\t\t\ttry {\n\t\t\t\tawait this.load();\n\t\t\t} catch (e) {\n\t\t\t\tif (!signal.aborted) {\n\t\t\t\t\tshowRenderError(`Error loading renderer '${this.data.id}'`, element, e instanceof Error ? [e] : []);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this._api) {\n\t\t\t\tif (!signal.aborted) {\n\t\t\t\t\tshowRenderError(`Renderer '${this.data.id}' does not implement renderOutputItem`, element, []);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst renderStart = performance.now();\n\t\t\t\tawait this._api.renderOutputItem(item, element, signal);\n\t\t\t\tthis.postDebugMessage('Rendered output item', { id: item.id, duration: `${performance.now() - renderStart}ms` });\n\n\t\t\t} catch (e) {\n\t\t\t\tif (signal.aborted) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (e instanceof Error && e.name === renderFallbackErrorName) {\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\n\t\t\t\tshowRenderError(`Error rendering output item using '${this.data.id}'`, element, e instanceof Error ? [e] : []);\n\t\t\t\tthis.postDebugMessage('Rendering output item failed', { id: item.id, error: e + '' });\n\t\t\t}\n\t\t}\n\n\t\tpublic disposeOutputItem(id?: string): void {\n\t\t\tthis._api?.disposeOutputItem?.(id);\n\t\t}\n\n\t\tprivate createRendererContext(): RendererContext {\n\t\t\tconst { id, messaging } = this.data;\n\t\t\tconst context: RendererContext = {\n\t\t\t\tsetState: newState => vscode.setState({ ...vscode.getState(), [id]: newState }),\n\t\t\t\tgetState: <T>() => {\n\t\t\t\t\tconst state = vscode.getState();\n\t\t\t\t\treturn typeof state === 'object' && state ? state[id] as T : undefined;\n\t\t\t\t},\n\t\t\t\tgetRenderer: async (id: string) => {\n\t\t\t\t\tconst renderer = renderers.getRenderer(id);\n\t\t\t\t\tif (!renderer) {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t\tif (renderer._api) {\n\t\t\t\t\t\treturn renderer._api;\n\t\t\t\t\t}\n\t\t\t\t\treturn renderer.load();\n\t\t\t\t},\n\t\t\t\tworkspace: {\n\t\t\t\t\tget isTrusted() { return isWorkspaceTrusted; }\n\t\t\t\t},\n\t\t\t\tsettings: {\n\t\t\t\t\tget lineLimit() { return currentRenderOptions.lineLimit; },\n\t\t\t\t\tget outputScrolling() { return currentRenderOptions.outputScrolling; },\n\t\t\t\t\tget outputWordWrap() { return currentRenderOptions.outputWordWrap; },\n\t\t\t\t\tget linkifyFilePaths() { return currentRenderOptions.linkifyFilePaths; },\n\t\t\t\t\tget minimalError() { return currentRenderOptions.minimalError; },\n\t\t\t\t},\n\t\t\t\tget onDidChangeSettings() { return settingChange.event; }\n\t\t\t};\n\n\t\t\tif (messaging) {\n\t\t\t\tcontext.onDidReceiveMessage = this._onMessageEvent.event;\n\t\t\t\tcontext.postMessage = message => postNotebookMessage('customRendererMessage', { rendererId: id, message });\n\t\t\t}\n\n\t\t\treturn Object.freeze(context);\n\t\t}\n\n\t\tprivate load(): Promise<rendererApi.RendererApi | undefined> {\n\t\t\tthis._loadPromise ??= this._load();\n\t\t\treturn this._loadPromise;\n\t\t}\n\n\t\t/** Inner function cached in the _loadPromise(). */\n\t\tprivate async _load(): Promise<rendererApi.RendererApi | undefined> {\n\t\t\tthis.postDebugMessage('Start loading renderer');\n\n\t\t\ttry {\n\t\t\t\t// Preloads need to be loaded before loading renderers.\n\t\t\t\tawait kernelPreloads.waitForAllCurrent();\n\n\t\t\t\tconst importStart = performance.now();\n\t\t\t\tconst module: RendererModule = await __import(this.data.entrypoint.path);\n\t\t\t\tthis.postDebugMessage('Imported renderer', { duration: `${performance.now() - importStart}ms` });\n\n\t\t\t\tif (!module) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis._api = await module.activate(this.createRendererContext());\n\t\t\t\tthis.postDebugMessage('Activated renderer', { duration: `${performance.now() - importStart}ms` });\n\n\t\t\t\tconst dependantRenderers = ctx.rendererData\n\t\t\t\t\t.filter(d => d.entrypoint.extends === this.data.id);\n\n\t\t\t\tif (dependantRenderers.length) {\n\t\t\t\t\tthis.postDebugMessage('Activating dependant renderers', { dependents: dependantRenderers.map(x => x.id).join(', ') });\n\t\t\t\t}\n\n\t\t\t\t// Load all renderers that extend this renderer\n\t\t\t\tawait Promise.all(dependantRenderers.map(async d => {\n\t\t\t\t\tconst renderer = renderers.getRenderer(d.id);\n\t\t\t\t\tif (!renderer) {\n\t\t\t\t\t\tthrow new Error(`Could not find extending renderer: ${d.id}`);\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn await renderer.load();\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t// Squash any errors extends errors. They won't prevent the renderer\n\t\t\t\t\t\t// itself from working, so just log them.\n\t\t\t\t\t\tconsole.error(e);\n\t\t\t\t\t\tthis.postDebugMessage('Activating dependant renderer failed', { dependent: d.id, error: e + '' });\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t}));\n\n\t\t\t\treturn this._api;\n\t\t\t} catch (e) {\n\t\t\t\tthis.postDebugMessage('Loading renderer failed');\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\n\t\tprivate postDebugMessage(msg: string, data?: Record<string, string>) {\n\t\t\tpostNotebookMessage<webviewMessages.ILogRendererDebugMessage>('logRendererDebugMessage', {\n\t\t\t\tmessage: `[renderer ${this.data.id}] - ${msg}`,\n\t\t\t\tdata\n\t\t\t});\n\t\t}\n\t}\n\n\tconst kernelPreloads = new class {\n\t\tprivate readonly preloads = new Map<string /* uri */, Promise<unknown>>();\n\n\t\t/**\n\t\t * Returns a promise that resolves when the given preload is activated.\n\t\t */\n\t\tpublic waitFor(uri: string) {\n\t\t\treturn this.preloads.get(uri) || Promise.resolve(new Error(`Preload not ready: ${uri}`));\n\t\t}\n\n\t\t/**\n\t\t * Loads a preload.\n\t\t * @param uri URI to load from\n\t\t * @param originalUri URI to show in an error message if the preload is invalid.\n\t\t */\n\t\tpublic load(uri: string) {\n\t\t\tconst promise = Promise.all([\n\t\t\t\trunKernelPreload(uri),\n\t\t\t\tthis.waitForAllCurrent(),\n\t\t\t]);\n\n\t\t\tthis.preloads.set(uri, promise);\n\t\t\treturn promise;\n\t\t}\n\n\t\t/**\n\t\t * Returns a promise that waits for all currently-registered preloads to\n\t\t * activate before resolving.\n\t\t */\n\t\tpublic waitForAllCurrent() {\n\t\t\treturn Promise.all([...this.preloads.values()].map(p => p.catch(err => err)));\n\t\t}\n\t};\n\n\tconst outputRunner = new class {\n\t\tprivate readonly outputs = new Map<string, { abort: AbortController; queue: Promise<unknown> }>();\n\n\t\t/**\n\t\t * Pushes the action onto the list of actions for the given output ID,\n\t\t * ensuring that it's run in-order.\n\t\t */\n\t\tpublic enqueue(outputId: string, action: (cancelSignal: AbortSignal) => unknown) {\n\t\t\tthis.pendingOutputCreationRequest.get(outputId)?.dispose();\n\t\t\tthis.pendingOutputCreationRequest.delete(outputId);\n\n\t\t\tconst record = this.outputs.get(outputId);\n\t\t\tif (!record) {\n\t\t\t\tconst controller = new AbortController();\n\t\t\t\tthis.outputs.set(outputId, { abort: controller, queue: new Promise(r => r(action(controller.signal))) });\n\t\t\t} else {\n\t\t\t\trecord.queue = record.queue.then(async r => {\n\t\t\t\t\tif (!record.abort.signal.aborted) {\n\t\t\t\t\t\tawait action(record.abort.signal);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tprivate pendingOutputCreationRequest: Map<string, IDisposable> = new Map();\n\n\t\tpublic enqueueIdle(outputId: string, action: (cancelSignal: AbortSignal) => unknown) {\n\t\t\tthis.pendingOutputCreationRequest.get(outputId)?.dispose();\n\t\t\toutputRunner.pendingOutputCreationRequest.set(outputId, runWhenIdle(() => {\n\t\t\t\toutputRunner.enqueue(outputId, action);\n\t\t\t\toutputRunner.pendingOutputCreationRequest.delete(outputId);\n\t\t\t}));\n\t\t}\n\n\t\t/**\n\t\t * Cancels the rendering of all outputs.\n\t\t */\n\t\tpublic cancelAll() {\n\t\t\t// Delete all pending idle requests\n\t\t\tthis.pendingOutputCreationRequest.forEach(r => r.dispose());\n\t\t\tthis.pendingOutputCreationRequest.clear();\n\n\t\t\tfor (const { abort } of this.outputs.values()) {\n\t\t\t\tabort.abort();\n\t\t\t}\n\t\t\tthis.outputs.clear();\n\t\t}\n\n\t\t/**\n\t\t * Cancels any ongoing rendering out an output.\n\t\t */\n\t\tpublic cancelOutput(outputId: string) {\n\t\t\t// Delete the pending idle request if it exists\n\t\t\tthis.pendingOutputCreationRequest.get(outputId)?.dispose();\n\t\t\tthis.pendingOutputCreationRequest.delete(outputId);\n\n\t\t\tconst output = this.outputs.get(outputId);\n\t\t\tif (output) {\n\t\t\t\toutput.abort.abort();\n\t\t\t\tthis.outputs.delete(outputId);\n\t\t\t}\n\t\t}\n\t};\n\n\tconst renderers = new class {\n\t\tprivate readonly _renderers = new Map</* id */ string, Renderer>();\n\n\t\tconstructor() {\n\t\t\tfor (const renderer of ctx.rendererData) {\n\t\t\t\tthis.addRenderer(renderer);\n\t\t\t}\n\t\t}\n\n\t\tpublic getRenderer(id: string): Renderer | undefined {\n\t\t\treturn this._renderers.get(id);\n\t\t}\n\n\t\tprivate rendererEqual(a: webviewMessages.RendererMetadata, b: webviewMessages.RendererMetadata) {\n\t\t\tif (a.id !== b.id || a.entrypoint.path !== b.entrypoint.path || a.entrypoint.extends !== b.entrypoint.extends || a.messaging !== b.messaging) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (a.mimeTypes.length !== b.mimeTypes.length) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tfor (let i = 0; i < a.mimeTypes.length; i++) {\n\t\t\t\tif (a.mimeTypes[i] !== b.mimeTypes[i]) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn true;\n\t\t}\n\n\t\tpublic updateRendererData(rendererData: readonly webviewMessages.RendererMetadata[]) {\n\t\t\tconst oldKeys = new Set(this._renderers.keys());\n\t\t\tconst newKeys = new Set(rendererData.map(d => d.id));\n\n\t\t\tfor (const renderer of rendererData) {\n\t\t\t\tconst existing = this._renderers.get(renderer.id);\n\t\t\t\tif (existing && this.rendererEqual(existing.data, renderer)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.addRenderer(renderer);\n\t\t\t}\n\n\t\t\tfor (const key of oldKeys) {\n\t\t\t\tif (!newKeys.has(key)) {\n\t\t\t\t\tthis._renderers.delete(key);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tprivate addRenderer(renderer: webviewMessages.RendererMetadata) {\n\t\t\tthis._renderers.set(renderer.id, new Renderer(renderer));\n\t\t}\n\n\t\tpublic clearAll() {\n\t\t\toutputRunner.cancelAll();\n\t\t\tfor (const renderer of this._renderers.values()) {\n\t\t\t\trenderer.disposeOutputItem();\n\t\t\t}\n\t\t}\n\n\t\tpublic clearOutput(rendererId: string, outputId: string) {\n\t\t\toutputRunner.cancelOutput(outputId);\n\t\t\tthis._renderers.get(rendererId)?.disposeOutputItem(outputId);\n\t\t}\n\n\t\tpublic async render(item: ExtendedOutputItem, preferredRendererId: string | undefined, element: HTMLElement, signal: AbortSignal): Promise<void> {\n\t\t\tconst primaryRenderer = this.findRenderer(preferredRendererId, item);\n\t\t\tif (!primaryRenderer) {\n\t\t\t\tconst errorMessage = (window.document.documentElement.style.getPropertyValue('--notebook-cell-renderer-not-found-error') || '').replace('$0', () => item.mime);\n\t\t\t\tthis.showRenderError(item, element, errorMessage);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Try primary renderer first\n\t\t\tif (!(await this._doRender(item, element, primaryRenderer, signal)).continue) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Primary renderer failed in an expected way. Fallback to render the next mime types\n\t\t\tfor (const additionalItemData of item._allOutputItems) {\n\t\t\t\tif (additionalItemData.mime === item.mime) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst additionalItem = await additionalItemData.getItem();\n\t\t\t\tif (signal.aborted) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (additionalItem) {\n\t\t\t\t\tconst renderer = this.findRenderer(undefined, additionalItem);\n\t\t\t\t\tif (renderer) {\n\t\t\t\t\t\tif (!(await this._doRender(additionalItem, element, renderer, signal)).continue) {\n\t\t\t\t\t\t\treturn; // We rendered successfully\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// All renderers have failed and there is nothing left to fallback to\n\t\t\tconst errorMessage = (window.document.documentElement.style.getPropertyValue('--notebook-cell-renderer-fallbacks-exhausted') || '').replace('$0', () => item.mime);\n\t\t\tthis.showRenderError(item, element, errorMessage);\n\t\t}\n\n\t\tprivate async _doRender(item: rendererApi.OutputItem, element: HTMLElement, renderer: Renderer, signal: AbortSignal): Promise<{ continue: boolean }> {\n\t\t\ttry {\n\t\t\t\tawait renderer.renderOutputItem(item, element, signal);\n\t\t\t\treturn { continue: false }; // We rendered successfully\n\t\t\t} catch (e) {\n\t\t\t\tif (signal.aborted) {\n\t\t\t\t\treturn { continue: false };\n\t\t\t\t}\n\n\t\t\t\tif (e instanceof Error && e.name === renderFallbackErrorName) {\n\t\t\t\t\treturn { continue: true };\n\t\t\t\t} else {\n\t\t\t\t\tthrow e; // Bail and let callers handle unknown errors\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tprivate findRenderer(preferredRendererId: string | undefined, info: rendererApi.OutputItem) {\n\t\t\tlet renderer: Renderer | undefined;\n\n\t\t\tif (typeof preferredRendererId === 'string') {\n\t\t\t\trenderer = Array.from(this._renderers.values())\n\t\t\t\t\t.find((renderer) => renderer.data.id === preferredRendererId);\n\t\t\t} else {\n\t\t\t\tconst renderers = Array.from(this._renderers.values())\n\t\t\t\t\t.filter((renderer) => renderer.data.mimeTypes.includes(info.mime) && !renderer.data.entrypoint.extends);\n\n\t\t\t\tif (renderers.length) {\n\t\t\t\t\t// De-prioritize built-in renderers\n\t\t\t\t\trenderers.sort((a, b) => +a.data.isBuiltin - +b.data.isBuiltin);\n\n\t\t\t\t\t// Use first renderer we find in sorted list\n\t\t\t\t\trenderer = renderers[0];\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn renderer;\n\t\t}\n\n\t\tprivate showRenderError(info: rendererApi.OutputItem, element: HTMLElement, errorMessage: string) {\n\t\t\tconst errorContainer = document.createElement('div');\n\n\t\t\tconst error = document.createElement('div');\n\t\t\terror.className = 'no-renderer-error';\n\t\t\terror.innerText = errorMessage;\n\n\t\t\tconst cellText = document.createElement('div');\n\t\t\tcellText.innerText = info.text();\n\n\t\t\terrorContainer.appendChild(error);\n\t\t\terrorContainer.appendChild(cellText);\n\n\t\t\telement.innerText = '';\n\t\t\telement.appendChild(errorContainer);\n\t\t}\n\t}();\n\n\tconst viewModel = new class ViewModel {\n\n\t\tprivate readonly _markupCells = new Map<string, MarkupCell>();\n\t\tprivate readonly _outputCells = new Map<string, OutputCell>();\n\n\t\tpublic clearAll() {\n\t\t\tfor (const cell of this._markupCells.values()) {\n\t\t\t\tcell.dispose();\n\t\t\t}\n\t\t\tthis._markupCells.clear();\n\n\t\t\tfor (const output of this._outputCells.values()) {\n\t\t\t\toutput.dispose();\n\t\t\t}\n\t\t\tthis._outputCells.clear();\n\t\t}\n\n\t\tprivate async createMarkupCell(init: webviewMessages.IMarkupCellInitialization, top: number, visible: boolean): Promise<MarkupCell> {\n\t\t\tconst existing = this._markupCells.get(init.cellId);\n\t\t\tif (existing) {\n\t\t\t\tconsole.error(`Trying to create markup that already exists: ${init.cellId}`);\n\t\t\t\treturn existing;\n\t\t\t}\n\n\t\t\tconst cell = new MarkupCell(init.cellId, init.mime, init.content, top, init.metadata);\n\t\t\tcell.element.style.visibility = visible ? '' : 'hidden';\n\t\t\tthis._markupCells.set(init.cellId, cell);\n\n\t\t\tawait cell.ready;\n\t\t\treturn cell;\n\t\t}\n\n\t\tpublic async ensureMarkupCell(info: webviewMessages.IMarkupCellInitialization): Promise<void> {\n\t\t\tlet cell = this._markupCells.get(info.cellId);\n\t\t\tif (cell) {\n\t\t\t\tcell.element.style.visibility = info.visible ? '' : 'hidden';\n\t\t\t\tawait cell.updateContentAndRender(info.content, info.metadata);\n\t\t\t} else {\n\t\t\t\tcell = await this.createMarkupCell(info, info.offset, info.visible);\n\t\t\t}\n\t\t}\n\n\t\tpublic deleteMarkupCell(id: string) {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tif (cell) {\n\t\t\t\tcell.remove();\n\t\t\t\tcell.dispose();\n\t\t\t\tthis._markupCells.delete(id);\n\t\t\t}\n\t\t}\n\n\t\tpublic async updateMarkupContent(id: string, newContent: string, metadata: NotebookCellMetadata): Promise<void> {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tawait cell?.updateContentAndRender(newContent, metadata);\n\t\t}\n\n\t\tpublic showMarkupCell(id: string, top: number, newContent: string | undefined, metadata: NotebookCellMetadata | undefined): void {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tcell?.show(top, newContent, metadata);\n\t\t}\n\n\t\tpublic hideMarkupCell(id: string): void {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tcell?.hide();\n\t\t}\n\n\t\tpublic unhideMarkupCell(id: string): void {\n\t\t\tconst cell = this.getExpectedMarkupCell(id);\n\t\t\tcell?.unhide();\n\t\t}\n\n\t\tprivate getExpectedMarkupCell(id: string): MarkupCell | undefined {\n\t\t\tconst cell = this._markupCells.get(id);\n\t\t\tif (!cell) {\n\t\t\t\tconsole.log(`Could not find markup cell '${id}'`);\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\treturn cell;\n\t\t}\n\n\t\tpublic updateSelectedCells(selectedCellIds: readonly string[]) {\n\t\t\tconst selectedCellSet = new Set<string>(selectedCellIds);\n\t\t\tfor (const cell of this._markupCells.values()) {\n\t\t\t\tcell.setSelected(selectedCellSet.has(cell.id));\n\t\t\t}\n\t\t}\n\n\t\tpublic toggleDragDropEnabled(dragAndDropEnabled: boolean) {\n\t\t\tfor (const cell of this._markupCells.values()) {\n\t\t\t\tcell.toggleDragDropEnabled(dragAndDropEnabled);\n\t\t\t}\n\t\t}\n\n\t\tpublic updateMarkupScrolls(markupCells: readonly webviewMessages.IMarkupCellScrollTops[]) {\n\t\t\tfor (const { id, top } of markupCells) {\n\t\t\t\tconst cell = this._markupCells.get(id);\n\t\t\t\tif (cell) {\n\t\t\t\t\tcell.element.style.top = `${top}px`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpublic async renderOutputCell(data: webviewMessages.ICreationRequestMessage, signal: AbortSignal): Promise<void> {\n\t\t\tconst preloadErrors = await Promise.all<undefined | Error>(\n\t\t\t\tdata.requiredPreloads.map(p => kernelPreloads.waitFor(p.uri).then(() => undefined, err => err))\n\t\t\t);\n\t\t\tif (signal.aborted) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst cellOutput = this.ensureOutputCell(data.cellId, data.cellTop, false);\n\t\t\treturn cellOutput.renderOutputElement(data, preloadErrors, signal);\n\t\t}\n\n\t\tpublic ensureOutputCell(cellId: string, cellTop: number, skipCellTopUpdateIfExist: boolean): OutputCell {\n\t\t\tlet cell = this._outputCells.get(cellId);\n\t\t\tconst existed = !!cell;\n\t\t\tif (!cell) {\n\t\t\t\tcell = new OutputCell(cellId);\n\t\t\t\tthis._outputCells.set(cellId, cell);\n\t\t\t}\n\n\t\t\tif (existed && skipCellTopUpdateIfExist) {\n\t\t\t\treturn cell;\n\t\t\t}\n\n\t\t\tcell.element.style.top = cellTop + 'px';\n\t\t\treturn cell;\n\t\t}\n\n\t\tpublic clearOutput(cellId: string, outputId: string, rendererId: string | undefined) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.clearOutput(outputId, rendererId);\n\t\t}\n\n\t\tpublic showOutput(cellId: string, outputId: string, top: number) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.show(outputId, top);\n\t\t}\n\n\t\tpublic updateAndRerender(cellId: string, outputId: string, content: webviewMessages.ICreationContent) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.updateContentAndRerender(outputId, content);\n\t\t}\n\n\t\tpublic hideOutput(cellId: string) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.hide();\n\t\t}\n\n\t\tpublic updateOutputHeight(cellId: string, outputId: string, height: number) {\n\t\t\tconst cell = this._outputCells.get(cellId);\n\t\t\tcell?.updateOutputHeight(outputId, height);\n\t\t}\n\n\t\tpublic updateOutputsScroll(updates: webviewMessages.IContentWidgetTopRequest[]) {\n\t\t\tfor (const request of updates) {\n\t\t\t\tconst cell = this._outputCells.get(request.cellId);\n\t\t\t\tcell?.updateScroll(request);\n\t\t\t}\n\t\t}\n\t}();\n\n\tclass MarkdownCodeBlock {\n\t\tprivate static pendingCodeBlocksToHighlight = new Map<string, HTMLElement>();\n\n\t\tpublic static highlightCodeBlock(id: string, html: string) {\n\t\t\tconst el = MarkdownCodeBlock.pendingCodeBlocksToHighlight.get(id);\n\t\t\tif (!el) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst trustedHtml = ttPolicy?.createHTML(html) ?? html;\n\t\t\tel.innerHTML = trustedHtml as string; // CodeQL [SM03712] The rendered content comes from VS Code's tokenizer and is considered safe\n\t\t\tconst root = el.getRootNode();\n\t\t\tif (root instanceof ShadowRoot) {\n\t\t\t\tif (!root.adoptedStyleSheets.includes(tokenizationStyle)) {\n\t\t\t\t\troot.adoptedStyleSheets.push(tokenizationStyle);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpublic static requestHighlightCodeBlock(root: HTMLElement | ShadowRoot) {\n\t\t\tconst codeBlocks: Array<{ value: string; lang: string; id: string }> = [];\n\t\t\tlet i = 0;\n\t\t\tfor (const el of root.querySelectorAll('.vscode-code-block')) {\n\t\t\t\tconst lang = el.getAttribute('data-vscode-code-block-lang');\n\t\t\t\tif (el.textContent && lang) {\n\t\t\t\t\tconst id = `${Date.now()}-${i++}`;\n\t\t\t\t\tcodeBlocks.push({ value: el.textContent, lang: lang, id });\n\t\t\t\t\tMarkdownCodeBlock.pendingCodeBlocksToHighlight.set(id, el as HTMLElement);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn codeBlocks;\n\t\t}\n\t}\n\n\tclass MarkupCell {\n\n\t\tpublic readonly ready: Promise<void>;\n\n\t\tpublic readonly id: string;\n\t\tpublic readonly element: HTMLElement;\n\n\t\tprivate readonly outputItem: ExtendedOutputItem;\n\n\t\t/// Internal field that holds text content\n\t\tprivate _content: { readonly value: string; readonly version: number; readonly metadata: NotebookCellMetadata };\n\n\t\tprivate _isDisposed = false;\n\t\tprivate renderTaskAbort?: AbortController;\n\n\t\tconstructor(id: string, mime: string, content: string, top: number, metadata: NotebookCellMetadata) {\n\t\t\tconst self = this;\n\t\t\tthis.id = id;\n\t\t\tthis._content = { value: content, version: 0, metadata: metadata };\n\n\t\t\tconst { promise, resolve, reject } = promiseWithResolvers<void>();\n\t\t\tthis.ready = promise;\n\n\t\t\tlet cachedData: { readonly version: number; readonly value: Uint8Array } | undefined;\n\t\t\tthis.outputItem = Object.freeze<ExtendedOutputItem>({\n\t\t\t\tid,\n\t\t\t\tmime,\n\n\t\t\t\tget metadata(): NotebookCellMetadata {\n\t\t\t\t\treturn self._content.metadata;\n\t\t\t\t},\n\n\t\t\t\ttext: (): string => {\n\t\t\t\t\treturn this._content.value;\n\t\t\t\t},\n\n\t\t\t\tjson: () => {\n\t\t\t\t\treturn undefined;\n\t\t\t\t},\n\n\t\t\t\tdata: (): Uint8Array => {\n\t\t\t\t\tif (cachedData?.version === this._content.version) {\n\t\t\t\t\t\treturn cachedData.value;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst data = textEncoder.encode(this._content.value);\n\t\t\t\t\tcachedData = { version: this._content.version, value: data };\n\t\t\t\t\treturn data;\n\t\t\t\t},\n\n\t\t\t\tblob(): Blob {\n\t\t\t\t\treturn new Blob([this.data() as Uint8Array<ArrayBuffer>], { type: this.mime });\n\t\t\t\t},\n\n\t\t\t\t_allOutputItems: [{\n\t\t\t\t\tmime,\n\t\t\t\t\tgetItem: async () => this.outputItem,\n\t\t\t\t}]\n\t\t\t});\n\n\t\t\tconst root = window.document.getElementById('container')!;\n\t\t\tconst markupCell = document.createElement('div');\n\t\t\tmarkupCell.className = 'markup';\n\t\t\tmarkupCell.style.position = 'absolute';\n\t\t\tmarkupCell.style.width = '100%';\n\n\t\t\tthis.element = document.createElement('div');\n\t\t\tthis.element.id = this.id;\n\t\t\tthis.element.classList.add('preview');\n\t\t\tthis.element.style.position = 'absolute';\n\t\t\tthis.element.style.top = top + 'px';\n\t\t\tthis.toggleDragDropEnabled(currentOptions.dragAndDropEnabled);\n\t\t\tmarkupCell.appendChild(this.element);\n\t\t\troot.appendChild(markupCell);\n\n\t\t\tthis.addEventListeners();\n\n\t\t\tthis.updateContentAndRender(this._content.value, this._content.metadata).then(() => {\n\t\t\t\tif (!this._isDisposed) {\n\t\t\t\t\tresizeObserver.observe(this.element, this.id, false, this.id);\n\t\t\t\t}\n\t\t\t\tresolve();\n\t\t\t}, () => reject());\n\t\t}\n\n\t\tpublic dispose() {\n\t\t\tthis._isDisposed = true;\n\t\t\tthis.renderTaskAbort?.abort();\n\t\t\tthis.renderTaskAbort = undefined;\n\t\t}\n\n\t\tprivate addEventListeners() {\n\t\t\tthis.element.addEventListener('dblclick', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IToggleMarkupPreviewMessage>('toggleMarkupPreview', { cellId: this.id });\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('click', e => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IClickMarkupCellMessage>('clickMarkupCell', {\n\t\t\t\t\tcellId: this.id,\n\t\t\t\t\taltKey: e.altKey,\n\t\t\t\t\tctrlKey: e.ctrlKey,\n\t\t\t\t\tmetaKey: e.metaKey,\n\t\t\t\t\tshiftKey: e.shiftKey,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('contextmenu', e => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IContextMenuMarkupCellMessage>('contextMenuMarkupCell', {\n\t\t\t\t\tcellId: this.id,\n\t\t\t\t\tclientX: e.clientX,\n\t\t\t\t\tclientY: e.clientY,\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('mouseenter', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IMouseEnterMarkupCellMessage>('mouseEnterMarkupCell', { cellId: this.id });\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('mouseleave', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IMouseLeaveMarkupCellMessage>('mouseLeaveMarkupCell', { cellId: this.id });\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('dragstart', e => {\n\t\t\t\tmarkupCellDragManager.startDrag(e, this.id);\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('drag', e => {\n\t\t\t\tmarkupCellDragManager.updateDrag(e, this.id);\n\t\t\t});\n\n\t\t\tthis.element.addEventListener('dragend', e => {\n\t\t\t\tmarkupCellDragManager.endDrag(e, this.id);\n\t\t\t});\n\t\t}\n\n\t\tpublic async updateContentAndRender(newContent: string, metadata: NotebookCellMetadata): Promise<void> {\n\t\t\tthis._content = { value: newContent, version: this._content.version + 1, metadata };\n\n\t\t\tthis.renderTaskAbort?.abort();\n\n\t\t\tconst controller = new AbortController();\n\t\t\tthis.renderTaskAbort = controller;\n\t\t\ttry {\n\t\t\t\tawait renderers.render(this.outputItem, undefined, this.element, this.renderTaskAbort.signal);\n\t\t\t} finally {\n\t\t\t\tif (this.renderTaskAbort === controller) {\n\t\t\t\t\tthis.renderTaskAbort = undefined;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst root = (this.element.shadowRoot ?? this.element);\n\t\t\tconst html = [];\n\t\t\tfor (const child of root.children) {\n\t\t\t\tswitch (child.tagName) {\n\t\t\t\t\tcase 'LINK':\n\t\t\t\t\tcase 'SCRIPT':\n\t\t\t\t\tcase 'STYLE':\n\t\t\t\t\t\t// not worth sending over since it will be stripped before rendering\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\thtml.push(child.outerHTML);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst codeBlocks: Array<{ value: string; lang: string; id: string }> = MarkdownCodeBlock.requestHighlightCodeBlock(root);\n\n\t\t\tpostNotebookMessage<webviewMessages.IRenderedMarkupMessage>('renderedMarkup', {\n\t\t\t\tcellId: this.id,\n\t\t\t\thtml: html.join(''),\n\t\t\t\tcodeBlocks\n\t\t\t});\n\n\t\t\tdimensionUpdater.updateHeight(this.id, this.element.offsetHeight, {\n\t\t\t\tisOutput: false\n\t\t\t});\n\t\t}\n\n\t\tpublic show(top: number, newContent: string | undefined, metadata: NotebookCellMetadata | undefined): void {\n\t\t\tthis.element.style.visibility = '';\n\t\t\tthis.element.style.top = `${top}px`;\n\t\t\tif (typeof newContent === 'string' || metadata) {\n\t\t\t\tthis.updateContentAndRender(newContent ?? this._content.value, metadata ?? this._content.metadata);\n\t\t\t} else {\n\t\t\t\tthis.updateMarkupDimensions();\n\t\t\t}\n\t\t}\n\n\t\tpublic hide() {\n\t\t\tthis.element.style.visibility = 'hidden';\n\t\t}\n\n\t\tpublic unhide() {\n\t\t\tthis.element.style.visibility = '';\n\t\t\tthis.updateMarkupDimensions();\n\t\t}\n\n\t\tpublic remove() {\n\t\t\tthis.element.remove();\n\t\t}\n\n\t\tprivate async updateMarkupDimensions() {\n\t\t\tdimensionUpdater.updateHeight(this.id, this.element.offsetHeight, {\n\t\t\t\tisOutput: false\n\t\t\t});\n\t\t}\n\n\t\tpublic setSelected(selected: boolean) {\n\t\t\tthis.element.classList.toggle('selected', selected);\n\t\t}\n\n\t\tpublic toggleDragDropEnabled(enabled: boolean) {\n\t\t\tif (enabled) {\n\t\t\t\tthis.element.classList.add('draggable');\n\t\t\t\tthis.element.setAttribute('draggable', 'true');\n\t\t\t} else {\n\t\t\t\tthis.element.classList.remove('draggable');\n\t\t\t\tthis.element.removeAttribute('draggable');\n\t\t\t}\n\t\t}\n\t}\n\n\tclass OutputCell {\n\t\tpublic readonly element: HTMLElement;\n\t\tprivate readonly outputElements = new Map</*outputId*/ string, OutputContainer>();\n\n\t\tconstructor(cellId: string) {\n\t\t\tconst container = window.document.getElementById('container')!;\n\n\t\t\tconst upperWrapperElement = createFocusSink(cellId);\n\t\t\tcontainer.appendChild(upperWrapperElement);\n\n\t\t\tthis.element = document.createElement('div');\n\t\t\tthis.element.style.position = 'absolute';\n\t\t\tthis.element.style.outline = '0';\n\n\t\t\tthis.element.id = cellId;\n\t\t\tthis.element.classList.add('cell_container');\n\n\t\t\tcontainer.appendChild(this.element);\n\t\t\tthis.element = this.element;\n\n\t\t\tconst lowerWrapperElement = createFocusSink(cellId, true);\n\t\t\tcontainer.appendChild(lowerWrapperElement);\n\t\t}\n\n\t\tpublic dispose() {\n\t\t\tfor (const output of this.outputElements.values()) {\n\t\t\t\toutput.dispose();\n\t\t\t}\n\t\t\tthis.outputElements.clear();\n\t\t}\n\n\t\tprivate createOutputElement(data: webviewMessages.ICreationRequestMessage): OutputElement {\n\t\t\tlet outputContainer = this.outputElements.get(data.outputId);\n\t\t\tif (!outputContainer) {\n\t\t\t\toutputContainer = new OutputContainer(data.outputId);\n\t\t\t\tthis.element.appendChild(outputContainer.element);\n\t\t\t\tthis.outputElements.set(data.outputId, outputContainer);\n\t\t\t}\n\n\t\t\treturn outputContainer.createOutputElement(data.outputId, data.outputOffset, data.left, data.cellId);\n\t\t}\n\n\t\tpublic async renderOutputElement(data: webviewMessages.ICreationRequestMessage, preloadErrors: ReadonlyArray<Error | undefined>, signal: AbortSignal) {\n\t\t\tconst startTime = Date.now();\n\t\t\tconst outputElement /** outputNode */ = this.createOutputElement(data);\n\t\t\tawait outputElement.render(data.content, data.rendererId, preloadErrors, signal);\n\n\t\t\t// don't hide until after this step so that the height is right\n\t\t\toutputElement/** outputNode */.element.style.visibility = data.initiallyHidden ? 'hidden' : '';\n\n\t\t\tif (!!data.executionId && !!data.rendererId) {\n\t\t\t\tlet outputSize: number | undefined = undefined;\n\t\t\t\tif (data.content.type === 1 /* extension */) {\n\t\t\t\t\toutputSize = data.content.output.valueBytes.length;\n\t\t\t\t}\n\n\t\t\t\t// Only send performance messages for non-empty outputs up to a certain size\n\t\t\t\tif (outputSize !== undefined && outputSize > 0 && outputSize < 100 * 1024) {\n\t\t\t\t\tpostNotebookMessage<webviewMessages.IPerformanceMessage>('notebookPerformanceMessage', {\n\t\t\t\t\t\tcellId: data.cellId,\n\t\t\t\t\t\texecutionId: data.executionId,\n\t\t\t\t\t\tduration: Date.now() - startTime,\n\t\t\t\t\t\trendererId: data.rendererId,\n\t\t\t\t\t\toutputSize\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tpublic clearOutput(outputId: string, rendererId: string | undefined) {\n\t\t\tconst output = this.outputElements.get(outputId);\n\t\t\toutput?.clear(rendererId);\n\t\t\toutput?.dispose();\n\t\t\tthis.outputElements.delete(outputId);\n\t\t}\n\n\t\tpublic show(outputId: string, top: number) {\n\t\t\tconst outputContainer = this.outputElements.get(outputId);\n\t\t\tif (!outputContainer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.element.style.visibility = '';\n\t\t\tthis.element.style.top = `${top}px`;\n\t\t}\n\n\t\tpublic hide() {\n\t\t\tthis.element.style.visibility = 'hidden';\n\t\t}\n\n\t\tpublic updateContentAndRerender(outputId: string, content: webviewMessages.ICreationContent) {\n\t\t\tthis.outputElements.get(outputId)?.updateContentAndRender(content);\n\t\t}\n\n\t\tpublic updateOutputHeight(outputId: string, height: number) {\n\t\t\tthis.outputElements.get(outputId)?.updateHeight(height);\n\t\t}\n\n\t\tpublic updateScroll(request: webviewMessages.IContentWidgetTopRequest) {\n\t\t\tthis.element.style.top = `${request.cellTop}px`;\n\n\t\t\tconst outputElement = this.outputElements.get(request.outputId);\n\t\t\tif (outputElement) {\n\t\t\t\toutputElement.updateScroll(request.outputOffset);\n\n\t\t\t\tif (request.forceDisplay && outputElement.outputNode) {\n\t\t\t\t\t// TODO @rebornix @mjbvz, there is a misalignment here.\n\t\t\t\t\t// We set output visibility on cell container, other than output container or output node itself.\n\t\t\t\t\toutputElement.outputNode.element.style.visibility = '';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (request.forceDisplay) {\n\t\t\t\tthis.element.style.visibility = '';\n\t\t\t}\n\t\t}\n\t}\n\n\tclass OutputContainer {\n\n\t\tpublic readonly element: HTMLElement;\n\n\t\tprivate _outputNode?: OutputElement;\n\n\t\tget outputNode() {\n\t\t\treturn this._outputNode;\n\t\t}\n\n\t\tconstructor(\n\t\t\tprivate readonly outputId: string,\n\t\t) {\n\t\t\tthis.element = document.createElement('div');\n\t\t\tthis.element.classList.add('output_container');\n\t\t\tthis.element.setAttribute('data-vscode-context', JSON.stringify({ 'preventDefaultContextMenuItems': true }));\n\t\t\tthis.element.style.position = 'absolute';\n\t\t\tthis.element.style.overflow = 'hidden';\n\t\t}\n\n\t\tpublic dispose() {\n\t\t\tthis._outputNode?.dispose();\n\t\t}\n\n\t\tpublic clear(rendererId: string | undefined) {\n\t\t\tif (rendererId) {\n\t\t\t\trenderers.clearOutput(rendererId, this.outputId);\n\t\t\t}\n\t\t\tthis.element.remove();\n\t\t}\n\n\t\tpublic updateHeight(height: number) {\n\t\t\tthis.element.style.maxHeight = `${height}px`;\n\t\t\tthis.element.style.height = `${height}px`;\n\t\t}\n\n\t\tpublic updateScroll(outputOffset: number) {\n\t\t\tthis.element.style.top = `${outputOffset}px`;\n\t\t}\n\n\t\tpublic createOutputElement(outputId: string, outputOffset: number, left: number, cellId: string): OutputElement {\n\t\t\tthis.element.innerText = '';\n\t\t\tthis.element.style.maxHeight = '0px';\n\t\t\tthis.element.style.top = `${outputOffset}px`;\n\n\t\t\tthis._outputNode?.dispose();\n\t\t\tthis._outputNode = new OutputElement(outputId, left, cellId);\n\t\t\tthis.element.appendChild(this._outputNode.element);\n\t\t\treturn this._outputNode;\n\t\t}\n\n\t\tpublic updateContentAndRender(content: webviewMessages.ICreationContent) {\n\t\t\tthis._outputNode?.updateAndRerender(content);\n\t\t}\n\t}\n\n\tvscode.postMessage({\n\t\t__vscode_notebook_message: true,\n\t\ttype: 'initialized'\n\t});\n\n\tfor (const preload of ctx.staticPreloadsData) {\n\t\tkernelPreloads.load(preload.entrypoint);\n\t}\n\n\tfunction postNotebookMessage<T extends webviewMessages.FromWebviewMessage>(\n\t\ttype: T['type'],\n\t\tproperties: Omit<T, '__vscode_notebook_message' | 'type'>\n\t) {\n\t\tvscode.postMessage({\n\t\t\t__vscode_notebook_message: true,\n\t\t\ttype,\n\t\t\t...properties\n\t\t});\n\t}\n\n\tclass OutputElement {\n\t\tpublic readonly element: HTMLElement;\n\t\tprivate _content?: {\n\t\t\treadonly preferredRendererId: string | undefined;\n\t\t\treadonly preloadErrors: ReadonlyArray<Error | undefined>;\n\t\t};\n\t\tprivate hasResizeObserver = false;\n\n\t\tprivate renderTaskAbort?: AbortController;\n\t\tprivate isImageOutput = false;\n\n\t\tconstructor(\n\t\t\tprivate readonly outputId: string,\n\t\t\tleft: number,\n\t\t\tpublic readonly cellId: string\n\t\t) {\n\t\t\tthis.element = document.createElement('div');\n\t\t\tthis.element.id = outputId;\n\t\t\tthis.element.classList.add('output');\n\t\t\tthis.element.style.position = 'absolute';\n\t\t\tthis.element.style.top = `0px`;\n\t\t\tthis.element.style.left = left + 'px';\n\t\t\tthis.element.style.padding = `${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodeLeftPadding}`;\n\n\t\t\tthis.element.addEventListener('mouseenter', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IMouseEnterMessage>('mouseenter', { id: outputId });\n\t\t\t});\n\t\t\tthis.element.addEventListener('mouseleave', () => {\n\t\t\t\tpostNotebookMessage<webviewMessages.IMouseLeaveMessage>('mouseleave', { id: outputId });\n\t\t\t});\n\n\t\t\t// Add drag handler\n\t\t\tthis.element.addEventListener('dragstart', (e: DragEvent) => {\n\t\t\t\tif (!e.dataTransfer) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst outputData: NotebookCellOutputTransferData = {\n\t\t\t\t\toutputId: this.outputId,\n\t\t\t\t};\n\n\t\t\t\te.dataTransfer.setData('notebook-cell-output', JSON.stringify(outputData));\n\t\t\t});\n\n\t\t\t// Add alt key handlers\n\t\t\twindow.addEventListener('keydown', (e) => {\n\t\t\t\tif (e.altKey) {\n\t\t\t\t\tthis.element.draggable = true;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\twindow.addEventListener('keyup', (e) => {\n\t\t\t\tif (!e.altKey) {\n\t\t\t\t\tthis.element.draggable = this.isImageOutput;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Handle window blur to reset draggable state\n\t\t\twindow.addEventListener('blur', () => {\n\t\t\t\tthis.element.draggable = this.isImageOutput;\n\t\t\t});\n\t\t}\n\n\t\tpublic dispose() {\n\t\t\tthis.renderTaskAbort?.abort();\n\t\t\tthis.renderTaskAbort = undefined;\n\t\t}\n\n\t\tpublic async render(content: webviewMessages.ICreationContent, preferredRendererId: string | undefined, preloadErrors: ReadonlyArray<Error | undefined>, signal?: AbortSignal) {\n\t\t\tthis.renderTaskAbort?.abort();\n\t\t\tthis.renderTaskAbort = undefined;\n\n\t\t\tthis._content = { preferredRendererId, preloadErrors };\n\t\t\tif (content.type === 0 /* RenderOutputType.Html */) {\n\t\t\t\tconst trustedHtml = ttPolicy?.createHTML(content.htmlContent) ?? content.htmlContent;\n\t\t\t\tthis.element.innerHTML = trustedHtml as string;  // CodeQL [SM03712] The content comes from renderer extensions, not from direct user input.\n\t\t\t} else if (preloadErrors.some(e => e instanceof Error)) {\n\t\t\t\tconst errors = preloadErrors.filter((e): e is Error => e instanceof Error);\n\t\t\t\tshowRenderError(`Error loading preloads`, this.element, errors);\n\t\t\t} else {\n\n\t\t\t\tconst imageMimeTypes = ['image/png', 'image/jpeg', 'image/svg'];\n\t\t\t\tthis.isImageOutput = imageMimeTypes.includes(content.output.mime);\n\t\t\t\tthis.element.draggable = this.isImageOutput;\n\n\t\t\t\tconst item = createOutputItem(this.outputId, content.output.mime, content.metadata, content.output.valueBytes, content.allOutputs, content.output.appended);\n\n\t\t\t\tconst controller = new AbortController();\n\t\t\t\tthis.renderTaskAbort = controller;\n\n\t\t\t\t// Abort rendering if caller aborts\n\t\t\t\tsignal?.addEventListener('abort', () => controller.abort());\n\n\t\t\t\ttry {\n\t\t\t\t\tawait renderers.render(item, preferredRendererId, this.element, controller.signal);\n\t\t\t\t} finally {\n\t\t\t\t\tif (this.renderTaskAbort === controller) {\n\t\t\t\t\t\tthis.renderTaskAbort = undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!this.hasResizeObserver) {\n\t\t\t\tthis.hasResizeObserver = true;\n\t\t\t\tresizeObserver.observe(this.element, this.outputId, true, this.cellId);\n\t\t\t}\n\n\t\t\tconst offsetHeight = this.element.offsetHeight;\n\t\t\tconst cps = document.defaultView!.getComputedStyle(this.element);\n\t\t\tconst verticalPadding = parseFloat(cps.paddingTop) + parseFloat(cps.paddingBottom);\n\t\t\tconst contentHeight = offsetHeight - verticalPadding;\n\t\t\tif (elementHasContent(contentHeight) && cps.padding === '0px') {\n\t\t\t\t// we set padding to zero if the output has no content (then we can have a zero-height output DOM node)\n\t\t\t\t// thus we need to ensure the padding is accounted when updating the init height of the output\n\t\t\t\tdimensionUpdater.updateHeight(this.outputId, offsetHeight + ctx.style.outputNodePadding * 2, {\n\t\t\t\t\tisOutput: true,\n\t\t\t\t\tinit: true\n\t\t\t\t});\n\n\t\t\t\tthis.element.style.padding = `${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodePadding}px ${ctx.style.outputNodeLeftPadding}`;\n\t\t\t} else if (elementHasContent(contentHeight)) {\n\t\t\t\tdimensionUpdater.updateHeight(this.outputId, this.element.offsetHeight, {\n\t\t\t\t\tisOutput: true,\n\t\t\t\t\tinit: true\n\t\t\t\t});\n\t\t\t\tthis.element.style.padding = `0 ${ctx.style.outputNodePadding}px 0 ${ctx.style.outputNodeLeftPadding}`;\n\t\t\t} else {\n\t\t\t\t// we have a zero-height output DOM node\n\t\t\t\tdimensionUpdater.updateHeight(this.outputId, 0, {\n\t\t\t\t\tisOutput: true,\n\t\t\t\t\tinit: true,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst root = this.element.shadowRoot ?? this.element;\n\t\t\tconst codeBlocks: Array<{ value: string; lang: string; id: string }> = MarkdownCodeBlock.requestHighlightCodeBlock(root);\n\n\t\t\tif (codeBlocks.length > 0) {\n\t\t\t\tpostNotebookMessage<webviewMessages.IRenderedCellOutputMessage>('renderedCellOutput', {\n\t\t\t\t\tcodeBlocks\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tpublic updateAndRerender(content: webviewMessages.ICreationContent) {\n\t\t\tif (this._content) {\n\t\t\t\tthis.render(content, this._content.preferredRendererId, this._content.preloadErrors);\n\t\t\t}\n\t\t}\n\t}\n\n\tconst markupCellDragManager = new class MarkupCellDragManager {\n\n\t\tprivate currentDrag: { cellId: string; clientY: number } | undefined;\n\n\t\t// Transparent overlay that prevents elements from inside the webview from eating\n\t\t// drag events.\n\t\tprivate dragOverlay?: HTMLElement;\n\n\t\tconstructor() {\n\t\t\twindow.document.addEventListener('dragover', e => {\n\t\t\t\t// Allow dropping dragged markup cells\n\t\t\t\te.preventDefault();\n\t\t\t});\n\n\t\t\twindow.document.addEventListener('drop', e => {\n\t\t\t\te.preventDefault();\n\n\t\t\t\tconst drag = this.currentDrag;\n\t\t\t\tif (!drag) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.currentDrag = undefined;\n\t\t\t\tpostNotebookMessage<webviewMessages.ICellDropMessage>('cell-drop', {\n\t\t\t\t\tcellId: drag.cellId,\n\t\t\t\t\tctrlKey: e.ctrlKey,\n\t\t\t\t\taltKey: e.altKey,\n\t\t\t\t\tdragOffsetY: e.clientY,\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tstartDrag(e: DragEvent, cellId: string) {\n\t\t\tif (!e.dataTransfer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!currentOptions.dragAndDropEnabled) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.currentDrag = { cellId, clientY: e.clientY };\n\n\t\t\tconst overlayZIndex = 9999;\n\t\t\tif (!this.dragOverlay) {\n\t\t\t\tthis.dragOverlay = document.createElement('div');\n\t\t\t\tthis.dragOverlay.style.position = 'absolute';\n\t\t\t\tthis.dragOverlay.style.top = '0';\n\t\t\t\tthis.dragOverlay.style.left = '0';\n\t\t\t\tthis.dragOverlay.style.zIndex = `${overlayZIndex}`;\n\t\t\t\tthis.dragOverlay.style.width = '100%';\n\t\t\t\tthis.dragOverlay.style.height = '100%';\n\t\t\t\tthis.dragOverlay.style.background = 'transparent';\n\t\t\t\twindow.document.body.appendChild(this.dragOverlay);\n\t\t\t}\n\t\t\t(e.target as HTMLElement).style.zIndex = `${overlayZIndex + 1}`;\n\t\t\t(e.target as HTMLElement).classList.add('dragging');\n\n\t\t\tpostNotebookMessage<webviewMessages.ICellDragStartMessage>('cell-drag-start', {\n\t\t\t\tcellId: cellId,\n\t\t\t\tdragOffsetY: e.clientY,\n\t\t\t});\n\n\t\t\t// Continuously send updates while dragging instead of relying on `updateDrag`.\n\t\t\t// This lets us scroll the list based on drag position.\n\t\t\tconst trySendDragUpdate = () => {\n\t\t\t\tif (this.currentDrag?.cellId !== cellId) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tpostNotebookMessage<webviewMessages.ICellDragMessage>('cell-drag', {\n\t\t\t\t\tcellId: cellId,\n\t\t\t\t\tdragOffsetY: this.currentDrag.clientY,\n\t\t\t\t});\n\t\t\t\twindow.requestAnimationFrame(trySendDragUpdate);\n\t\t\t};\n\t\t\twindow.requestAnimationFrame(trySendDragUpdate);\n\t\t}\n\n\t\tupdateDrag(e: DragEvent, cellId: string) {\n\t\t\tif (cellId !== this.currentDrag?.cellId) {\n\t\t\t\tthis.currentDrag = undefined;\n\t\t\t} else {\n\t\t\t\tthis.currentDrag = { cellId, clientY: e.clientY };\n\t\t\t}\n\t\t}\n\n\t\tendDrag(e: DragEvent, cellId: string) {\n\t\t\tthis.currentDrag = undefined;\n\t\t\t(e.target as HTMLElement).classList.remove('dragging');\n\t\t\tpostNotebookMessage<webviewMessages.ICellDragEndMessage>('cell-drag-end', {\n\t\t\t\tcellId: cellId\n\t\t\t});\n\n\t\t\tif (this.dragOverlay) {\n\t\t\t\tthis.dragOverlay.remove();\n\t\t\t\tthis.dragOverlay = undefined;\n\t\t\t}\n\n\t\t\t(e.target as HTMLElement).style.zIndex = '';\n\t\t}\n\t}();\n}\n\nexport function preloadsScriptStr(styleValues: PreloadStyles, options: PreloadOptions, renderOptions: RenderOptions, renderers: readonly webviewMessages.RendererMetadata[], preloads: readonly webviewMessages.StaticPreloadMetadata[], isWorkspaceTrusted: boolean, nonce: string) {\n\tconst ctx: PreloadContext = {\n\t\tstyle: styleValues,\n\t\toptions,\n\t\trenderOptions,\n\t\trendererData: renderers,\n\t\tstaticPreloadsData: preloads,\n\t\tisWorkspaceTrusted,\n\t\tnonce,\n\t};\n\t// TS will try compiling `import()` in webviewPreloads, so use a helper function instead\n\t// of using `import(...)` directly\n\treturn `\n\t\tconst __import = (x) => import(x);\n\t\t(${webviewPreloads})(\n\t\t\tJSON.parse(decodeURIComponent(\"${encodeURIComponent(JSON.stringify(ctx))}\"))\n\t\t)\\n//# sourceURL=notebookWebviewPreloads.js\\n`;\n}\n"]}