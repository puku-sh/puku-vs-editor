{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/test/browser/contrib/notebookCellDiagnostics.test.ts","vs/workbench/contrib/notebook/test/browser/contrib/notebookCellDiagnostics.test.ts"],"names":[],"mappings":"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","file":"notebookCellDiagnostics.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { Emitter, Event } from '../../../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../../../../base/common/map.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { mock } from '../../../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { IConfigurationService } from '../../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { TestInstantiationService } from '../../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { IMarkerData, IMarkerService } from '../../../../../../platform/markers/common/markers.js';\nimport { IChatAgent, IChatAgentData, IChatAgentService } from '../../../../chat/common/chatAgents.js';\nimport { CellDiagnostics } from '../../../browser/contrib/cellDiagnostics/cellDiagnosticEditorContrib.js';\nimport { CodeCellViewModel } from '../../../browser/viewModel/codeCellViewModel.js';\nimport { CellKind, NotebookSetting } from '../../../common/notebookCommon.js';\nimport { ICellExecutionStateChangedEvent, IExecutionStateChangedEvent, INotebookCellExecution, INotebookExecutionStateService, NotebookExecutionType } from '../../../common/notebookExecutionStateService.js';\nimport { setupInstantiationService, TestNotebookExecutionStateService, withTestNotebook } from '../testNotebookEditor.js';\nimport { nullExtensionDescription } from '../../../../../services/extensions/common/extensions.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../../../chat/common/constants.js';\n\n\nsuite('notebookCellDiagnostics', () => {\n\n\tlet instantiationService: TestInstantiationService;\n\tlet disposables: DisposableStore;\n\tlet testExecutionService: TestExecutionService;\n\tlet markerService: ITestMarkerService;\n\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tclass TestExecutionService extends TestNotebookExecutionStateService {\n\t\tprivate _onDidChangeExecution = new Emitter<ICellExecutionStateChangedEvent | IExecutionStateChangedEvent>();\n\t\toverride onDidChangeExecution = this._onDidChangeExecution.event;\n\n\t\tfireExecutionChanged(notebook: URI, cellHandle: number, changed?: INotebookCellExecution) {\n\t\t\tthis._onDidChangeExecution.fire({\n\t\t\t\ttype: NotebookExecutionType.cell,\n\t\t\t\tcellHandle,\n\t\t\t\tnotebook,\n\t\t\t\taffectsNotebook: () => true,\n\t\t\t\taffectsCell: () => true,\n\t\t\t\tchanged: changed\n\t\t\t});\n\t\t}\n\t}\n\n\tinterface ITestMarkerService extends IMarkerService {\n\t\tmarkers: ResourceMap<IMarkerData[]>;\n\t\treadonly onMarkersUpdated: Event<void>;\n\t}\n\n\tsetup(function () {\n\n\t\tdisposables = new DisposableStore();\n\n\t\tinstantiationService = setupInstantiationService(disposables);\n\t\ttestExecutionService = new TestExecutionService();\n\t\tinstantiationService.stub(INotebookExecutionStateService, testExecutionService);\n\n\t\tconst agentData = {\n\t\t\textensionId: nullExtensionDescription.identifier,\n\t\t\textensionVersion: undefined,\n\t\t\textensionDisplayName: '',\n\t\t\textensionPublisherId: '',\n\t\t\tname: 'testEditorAgent',\n\t\t\tisDefault: true,\n\t\t\tlocations: [ChatAgentLocation.Notebook],\n\t\t\tmodes: [ChatModeKind.Ask],\n\t\t\tmetadata: {},\n\t\t\tslashCommands: [],\n\t\t\tdisambiguation: [],\n\t\t};\n\t\tconst chatAgentService = new class extends mock<IChatAgentService>() {\n\t\t\toverride getAgents(): IChatAgentData[] {\n\t\t\t\treturn [{\n\t\t\t\t\tid: 'testEditorAgent',\n\t\t\t\t\t...agentData\n\t\t\t\t}];\n\t\t\t}\n\t\t\toverride onDidChangeAgents: Event<IChatAgent | undefined> = Event.None;\n\t\t};\n\t\tinstantiationService.stub(IChatAgentService, chatAgentService);\n\n\t\tmarkerService = new class extends mock<ITestMarkerService>() {\n\t\t\tprivate _onMarkersUpdated = new Emitter<void>();\n\t\t\toverride onMarkersUpdated = this._onMarkersUpdated.event;\n\t\t\toverride markers: ResourceMap<IMarkerData[]> = new ResourceMap();\n\t\t\toverride changeOne(owner: string, resource: URI, markers: IMarkerData[]) {\n\t\t\t\tthis.markers.set(resource, markers);\n\t\t\t\tthis._onMarkersUpdated.fire();\n\t\t\t}\n\t\t};\n\t\tinstantiationService.stub(IMarkerService, markerService);\n\n\t\tconst config = instantiationService.get<IConfigurationService>(IConfigurationService) as TestConfigurationService;\n\t\tconfig.setUserConfiguration(NotebookSetting.cellFailureDiagnostics, true);\n\t});\n\n\ttest('diagnostic is added for cell execution failure', async function () {\n\t\tawait withTestNotebook([\n\t\t\t['print(x)', 'python', CellKind.Code, [], {}]\n\t\t], async (editor, viewModel, store, accessor) => {\n\t\t\tconst cell = viewModel.viewCells[0] as CodeCellViewModel;\n\n\t\t\tdisposables.add(instantiationService.createInstance(CellDiagnostics, editor));\n\n\t\t\tcell.model.internalMetadata.lastRunSuccess = false;\n\t\t\tcell.model.internalMetadata.error = {\n\t\t\t\tname: 'error',\n\t\t\t\tmessage: 'something bad happened',\n\t\t\t\tstack: 'line 1 : print(x)',\n\t\t\t\turi: cell.uri,\n\t\t\t\tlocation: { startColumn: 1, endColumn: 5, startLineNumber: 1, endLineNumber: 1 }\n\t\t\t};\n\t\t\ttestExecutionService.fireExecutionChanged(editor.textModel.uri, cell.handle);\n\t\t\tawait new Promise<void>(resolve => Event.once(markerService.onMarkersUpdated)(resolve));\n\n\t\t\tassert.strictEqual(cell?.executionErrorDiagnostic.get()?.message, 'something bad happened');\n\t\t\tassert.equal(markerService.markers.get(cell.uri)?.length, 1);\n\t\t}, instantiationService);\n\t});\n\n\ttest('diagnostics are cleared only for cell with new execution', async function () {\n\t\tawait withTestNotebook([\n\t\t\t['print(x)', 'python', CellKind.Code, [], {}],\n\t\t\t['print(y)', 'python', CellKind.Code, [], {}]\n\t\t], async (editor, viewModel, store, accessor) => {\n\t\t\tconst cell = viewModel.viewCells[0] as CodeCellViewModel;\n\t\t\tconst cell2 = viewModel.viewCells[1] as CodeCellViewModel;\n\n\t\t\tdisposables.add(instantiationService.createInstance(CellDiagnostics, editor));\n\n\t\t\tcell.model.internalMetadata.lastRunSuccess = false;\n\t\t\tcell.model.internalMetadata.error = {\n\t\t\t\tname: 'error',\n\t\t\t\tmessage: 'something bad happened',\n\t\t\t\tstack: 'line 1 : print(x)',\n\t\t\t\turi: cell.uri,\n\t\t\t\tlocation: { startColumn: 1, endColumn: 5, startLineNumber: 1, endLineNumber: 1 }\n\t\t\t};\n\t\t\tcell2.model.internalMetadata.lastRunSuccess = false;\n\t\t\tcell2.model.internalMetadata.error = {\n\t\t\t\tname: 'error',\n\t\t\t\tmessage: 'another bad thing happened',\n\t\t\t\tstack: 'line 1 : print(y)',\n\t\t\t\turi: cell.uri,\n\t\t\t\tlocation: { startColumn: 1, endColumn: 5, startLineNumber: 1, endLineNumber: 1 }\n\t\t\t};\n\t\t\ttestExecutionService.fireExecutionChanged(editor.textModel.uri, cell.handle);\n\t\t\ttestExecutionService.fireExecutionChanged(editor.textModel.uri, cell2.handle);\n\n\t\t\tawait new Promise<void>(resolve => Event.once(markerService.onMarkersUpdated)(resolve));\n\n\t\t\tconst clearMarkers = new Promise<void>(resolve => Event.once(markerService.onMarkersUpdated)(resolve));\n\t\t\t// on NotebookCellExecution value will make it look like its currently running\n\t\t\ttestExecutionService.fireExecutionChanged(editor.textModel.uri, cell.handle, {} as INotebookCellExecution);\n\n\t\t\tawait clearMarkers;\n\n\t\t\tassert.strictEqual(cell?.executionErrorDiagnostic.get(), undefined);\n\t\t\tassert.strictEqual(cell2?.executionErrorDiagnostic.get()?.message, 'another bad thing happened', 'cell that was not executed should still have an error');\n\t\t\tassert.equal(markerService.markers.get(cell.uri)?.length, 0);\n\t\t\tassert.equal(markerService.markers.get(cell2.uri)?.length, 1);\n\t\t}, instantiationService);\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { Emitter, Event } from '../../../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../../../../base/common/map.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { mock } from '../../../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { IConfigurationService } from '../../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { TestInstantiationService } from '../../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { IMarkerData, IMarkerService } from '../../../../../../platform/markers/common/markers.js';\nimport { IChatAgent, IChatAgentData, IChatAgentService } from '../../../../chat/common/chatAgents.js';\nimport { CellDiagnostics } from '../../../browser/contrib/cellDiagnostics/cellDiagnosticEditorContrib.js';\nimport { CodeCellViewModel } from '../../../browser/viewModel/codeCellViewModel.js';\nimport { CellKind, NotebookSetting } from '../../../common/notebookCommon.js';\nimport { ICellExecutionStateChangedEvent, IExecutionStateChangedEvent, INotebookCellExecution, INotebookExecutionStateService, NotebookExecutionType } from '../../../common/notebookExecutionStateService.js';\nimport { setupInstantiationService, TestNotebookExecutionStateService, withTestNotebook } from '../testNotebookEditor.js';\nimport { nullExtensionDescription } from '../../../../../services/extensions/common/extensions.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../../../chat/common/constants.js';\n\n\nsuite('notebookCellDiagnostics', () => {\n\n\tlet instantiationService: TestInstantiationService;\n\tlet disposables: DisposableStore;\n\tlet testExecutionService: TestExecutionService;\n\tlet markerService: ITestMarkerService;\n\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tclass TestExecutionService extends TestNotebookExecutionStateService {\n\t\tprivate _onDidChangeExecution = new Emitter<ICellExecutionStateChangedEvent | IExecutionStateChangedEvent>();\n\t\toverride onDidChangeExecution = this._onDidChangeExecution.event;\n\n\t\tfireExecutionChanged(notebook: URI, cellHandle: number, changed?: INotebookCellExecution) {\n\t\t\tthis._onDidChangeExecution.fire({\n\t\t\t\ttype: NotebookExecutionType.cell,\n\t\t\t\tcellHandle,\n\t\t\t\tnotebook,\n\t\t\t\taffectsNotebook: () => true,\n\t\t\t\taffectsCell: () => true,\n\t\t\t\tchanged: changed\n\t\t\t});\n\t\t}\n\t}\n\n\tinterface ITestMarkerService extends IMarkerService {\n\t\tmarkers: ResourceMap<IMarkerData[]>;\n\t\treadonly onMarkersUpdated: Event<void>;\n\t}\n\n\tsetup(function () {\n\n\t\tdisposables = new DisposableStore();\n\n\t\tinstantiationService = setupInstantiationService(disposables);\n\t\ttestExecutionService = new TestExecutionService();\n\t\tinstantiationService.stub(INotebookExecutionStateService, testExecutionService);\n\n\t\tconst agentData = {\n\t\t\textensionId: nullExtensionDescription.identifier,\n\t\t\textensionVersion: undefined,\n\t\t\textensionDisplayName: '',\n\t\t\textensionPublisherId: '',\n\t\t\tname: 'testEditorAgent',\n\t\t\tisDefault: true,\n\t\t\tlocations: [ChatAgentLocation.Notebook],\n\t\t\tmodes: [ChatModeKind.Ask],\n\t\t\tmetadata: {},\n\t\t\tslashCommands: [],\n\t\t\tdisambiguation: [],\n\t\t};\n\t\tconst chatAgentService = new class extends mock<IChatAgentService>() {\n\t\t\toverride getAgents(): IChatAgentData[] {\n\t\t\t\treturn [{\n\t\t\t\t\tid: 'testEditorAgent',\n\t\t\t\t\t...agentData\n\t\t\t\t}];\n\t\t\t}\n\t\t\toverride onDidChangeAgents: Event<IChatAgent | undefined> = Event.None;\n\t\t};\n\t\tinstantiationService.stub(IChatAgentService, chatAgentService);\n\n\t\tmarkerService = new class extends mock<ITestMarkerService>() {\n\t\t\tprivate _onMarkersUpdated = new Emitter<void>();\n\t\t\toverride onMarkersUpdated = this._onMarkersUpdated.event;\n\t\t\toverride markers: ResourceMap<IMarkerData[]> = new ResourceMap();\n\t\t\toverride changeOne(owner: string, resource: URI, markers: IMarkerData[]) {\n\t\t\t\tthis.markers.set(resource, markers);\n\t\t\t\tthis._onMarkersUpdated.fire();\n\t\t\t}\n\t\t};\n\t\tinstantiationService.stub(IMarkerService, markerService);\n\n\t\tconst config = instantiationService.get<IConfigurationService>(IConfigurationService) as TestConfigurationService;\n\t\tconfig.setUserConfiguration(NotebookSetting.cellFailureDiagnostics, true);\n\t});\n\n\ttest('diagnostic is added for cell execution failure', async function () {\n\t\tawait withTestNotebook([\n\t\t\t['print(x)', 'python', CellKind.Code, [], {}]\n\t\t], async (editor, viewModel, store, accessor) => {\n\t\t\tconst cell = viewModel.viewCells[0] as CodeCellViewModel;\n\n\t\t\tdisposables.add(instantiationService.createInstance(CellDiagnostics, editor));\n\n\t\t\tcell.model.internalMetadata.lastRunSuccess = false;\n\t\t\tcell.model.internalMetadata.error = {\n\t\t\t\tname: 'error',\n\t\t\t\tmessage: 'something bad happened',\n\t\t\t\tstack: 'line 1 : print(x)',\n\t\t\t\turi: cell.uri,\n\t\t\t\tlocation: { startColumn: 1, endColumn: 5, startLineNumber: 1, endLineNumber: 1 }\n\t\t\t};\n\t\t\ttestExecutionService.fireExecutionChanged(editor.textModel.uri, cell.handle);\n\t\t\tawait new Promise<void>(resolve => Event.once(markerService.onMarkersUpdated)(resolve));\n\n\t\t\tassert.strictEqual(cell?.executionErrorDiagnostic.get()?.message, 'something bad happened');\n\t\t\tassert.equal(markerService.markers.get(cell.uri)?.length, 1);\n\t\t}, instantiationService);\n\t});\n\n\ttest('diagnostics are cleared only for cell with new execution', async function () {\n\t\tawait withTestNotebook([\n\t\t\t['print(x)', 'python', CellKind.Code, [], {}],\n\t\t\t['print(y)', 'python', CellKind.Code, [], {}]\n\t\t], async (editor, viewModel, store, accessor) => {\n\t\t\tconst cell = viewModel.viewCells[0] as CodeCellViewModel;\n\t\t\tconst cell2 = viewModel.viewCells[1] as CodeCellViewModel;\n\n\t\t\tdisposables.add(instantiationService.createInstance(CellDiagnostics, editor));\n\n\t\t\tcell.model.internalMetadata.lastRunSuccess = false;\n\t\t\tcell.model.internalMetadata.error = {\n\t\t\t\tname: 'error',\n\t\t\t\tmessage: 'something bad happened',\n\t\t\t\tstack: 'line 1 : print(x)',\n\t\t\t\turi: cell.uri,\n\t\t\t\tlocation: { startColumn: 1, endColumn: 5, startLineNumber: 1, endLineNumber: 1 }\n\t\t\t};\n\t\t\tcell2.model.internalMetadata.lastRunSuccess = false;\n\t\t\tcell2.model.internalMetadata.error = {\n\t\t\t\tname: 'error',\n\t\t\t\tmessage: 'another bad thing happened',\n\t\t\t\tstack: 'line 1 : print(y)',\n\t\t\t\turi: cell.uri,\n\t\t\t\tlocation: { startColumn: 1, endColumn: 5, startLineNumber: 1, endLineNumber: 1 }\n\t\t\t};\n\t\t\ttestExecutionService.fireExecutionChanged(editor.textModel.uri, cell.handle);\n\t\t\ttestExecutionService.fireExecutionChanged(editor.textModel.uri, cell2.handle);\n\n\t\t\tawait new Promise<void>(resolve => Event.once(markerService.onMarkersUpdated)(resolve));\n\n\t\t\tconst clearMarkers = new Promise<void>(resolve => Event.once(markerService.onMarkersUpdated)(resolve));\n\t\t\t// on NotebookCellExecution value will make it look like its currently running\n\t\t\ttestExecutionService.fireExecutionChanged(editor.textModel.uri, cell.handle, {} as INotebookCellExecution);\n\n\t\t\tawait clearMarkers;\n\n\t\t\tassert.strictEqual(cell?.executionErrorDiagnostic.get(), undefined);\n\t\t\tassert.strictEqual(cell2?.executionErrorDiagnostic.get()?.message, 'another bad thing happened', 'cell that was not executed should still have an error');\n\t\t\tassert.equal(markerService.markers.get(cell.uri)?.length, 0);\n\t\t\tassert.equal(markerService.markers.get(cell2.uri)?.length, 1);\n\t\t}, instantiationService);\n\t});\n});\n"]}