{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/test/browser/notebookExecutionService.test.ts","vs/workbench/contrib/notebook/test/browser/notebookExecutionService.test.ts"],"names":[],"mappings":"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","file":"notebookExecutionService.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport * as sinon from 'sinon';\nimport { AsyncIterableProducer } from '../../../../../base/common/async.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Event } from '../../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { assertThrowsAsync, ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { PLAINTEXT_LANGUAGE_ID } from '../../../../../editor/common/languages/modesRegistry.js';\nimport { IMenu, IMenuService } from '../../../../../platform/actions/common/actions.js';\nimport { ICommandService } from '../../../../../platform/commands/common/commands.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { ExtensionIdentifier } from '../../../../../platform/extensions/common/extensions.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { insertCellAtIndex } from '../../browser/controller/cellOperations.js';\nimport { NotebookExecutionService } from '../../browser/services/notebookExecutionServiceImpl.js';\nimport { NotebookKernelService } from '../../browser/services/notebookKernelServiceImpl.js';\nimport { NotebookViewModel } from '../../browser/viewModel/notebookViewModelImpl.js';\nimport { NotebookTextModel } from '../../common/model/notebookTextModel.js';\nimport { CellKind, IOutputDto, NotebookCellMetadata } from '../../common/notebookCommon.js';\nimport { INotebookExecutionStateService } from '../../common/notebookExecutionStateService.js';\nimport { INotebookKernel, INotebookKernelHistoryService, INotebookKernelService, INotebookTextModelLike, VariablesResult } from '../../common/notebookKernelService.js';\nimport { INotebookLoggingService } from '../../common/notebookLoggingService.js';\nimport { INotebookService } from '../../common/notebookService.js';\nimport { setupInstantiationService, withTestNotebook as _withTestNotebook } from './testNotebookEditor.js';\n\nsuite('NotebookExecutionService', () => {\n\n\tlet instantiationService: TestInstantiationService;\n\tlet contextKeyService: IContextKeyService;\n\tlet kernelService: INotebookKernelService;\n\tlet disposables: DisposableStore;\n\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tsetup(function () {\n\n\t\tdisposables = new DisposableStore();\n\n\t\tinstantiationService = setupInstantiationService(disposables);\n\n\t\tinstantiationService.stub(INotebookService, new class extends mock<INotebookService>() {\n\t\t\toverride onDidAddNotebookDocument = Event.None;\n\t\t\toverride onWillRemoveNotebookDocument = Event.None;\n\t\t\toverride getNotebookTextModels() { return []; }\n\t\t});\n\n\t\tinstantiationService.stub(INotebookLoggingService, new class extends mock<INotebookLoggingService>() {\n\t\t\toverride debug(category: string, output: string): void {\n\t\t\t\t//\n\t\t\t}\n\t\t});\n\n\t\tinstantiationService.stub(IMenuService, new class extends mock<IMenuService>() {\n\t\t\toverride createMenu() {\n\t\t\t\treturn new class extends mock<IMenu>() {\n\t\t\t\t\toverride onDidChange = Event.None;\n\t\t\t\t\toverride getActions() { return []; }\n\t\t\t\t\toverride dispose() { }\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tinstantiationService.stub(INotebookKernelHistoryService, new class extends mock<INotebookKernelHistoryService>() {\n\t\t\toverride getKernels(notebook: INotebookTextModelLike) {\n\t\t\t\treturn kernelService.getMatchingKernel(notebook);\n\t\t\t}\n\t\t\toverride addMostRecentKernel(kernel: INotebookKernel): void { }\n\t\t});\n\n\t\tinstantiationService.stub(ICommandService, new class extends mock<ICommandService>() {\n\t\t\toverride executeCommand(_commandId: string, ..._args: unknown[]) {\n\t\t\t\treturn Promise.resolve(undefined);\n\t\t\t}\n\t\t});\n\n\t\tkernelService = disposables.add(instantiationService.createInstance(NotebookKernelService));\n\t\tinstantiationService.set(INotebookKernelService, kernelService);\n\t\tcontextKeyService = instantiationService.get(IContextKeyService);\n\t});\n\n\tasync function withTestNotebook(cells: [string, string, CellKind, IOutputDto[], NotebookCellMetadata][], callback: (viewModel: NotebookViewModel, textModel: NotebookTextModel, disposables: DisposableStore) => void | Promise<void>) {\n\t\treturn _withTestNotebook(cells, (editor, viewModel, disposables) => callback(viewModel, viewModel.notebookDocument, disposables));\n\t}\n\n\t// test('ctor', () => {\n\t// \tinstantiationService.createInstance(NotebookEditorKernelManager, { activeKernel: undefined, viewModel: undefined });\n\t// \tconst contextKeyService = instantiationService.get(IContextKeyService);\n\n\t// \tassert.strictEqual(contextKeyService.getContextKeyValue(NOTEBOOK_KERNEL_COUNT.key), 0);\n\t// });\n\n\ttest('cell is not runnable when no kernel is selected', async () => {\n\t\tawait withTestNotebook(\n\t\t\t[],\n\t\t\tasync (viewModel, textModel, disposables) => {\n\t\t\t\tconst executionService = instantiationService.createInstance(NotebookExecutionService);\n\n\t\t\t\tconst cell = insertCellAtIndex(viewModel, 1, 'var c = 3', 'javascript', CellKind.Code, {}, [], true, true);\n\t\t\t\tawait assertThrowsAsync(async () => await executionService.executeNotebookCells(textModel, [cell.model], contextKeyService));\n\t\t\t});\n\t});\n\n\ttest('cell is not runnable when kernel does not support the language', async () => {\n\t\tawait withTestNotebook(\n\t\t\t[],\n\t\t\tasync (viewModel, textModel) => {\n\n\t\t\t\tdisposables.add(kernelService.registerKernel(new TestNotebookKernel({ languages: ['testlang'] })));\n\t\t\t\tconst executionService = disposables.add(instantiationService.createInstance(NotebookExecutionService));\n\t\t\t\tconst cell = disposables.add(insertCellAtIndex(viewModel, 1, 'var c = 3', 'javascript', CellKind.Code, {}, [], true, true));\n\t\t\t\tawait assertThrowsAsync(async () => await executionService.executeNotebookCells(textModel, [cell.model], contextKeyService));\n\n\t\t\t});\n\t});\n\n\ttest('cell is runnable when kernel does support the language', async () => {\n\t\tawait withTestNotebook(\n\t\t\t[],\n\t\t\tasync (viewModel, textModel) => {\n\t\t\t\tconst kernel = new TestNotebookKernel({ languages: ['javascript'] });\n\t\t\t\tdisposables.add(kernelService.registerKernel(kernel));\n\t\t\t\tkernelService.selectKernelForNotebook(kernel, textModel);\n\t\t\t\tconst executionService = disposables.add(instantiationService.createInstance(NotebookExecutionService));\n\t\t\t\tconst executeSpy = sinon.spy();\n\t\t\t\tkernel.executeNotebookCellsRequest = executeSpy;\n\n\t\t\t\tconst cell = disposables.add(insertCellAtIndex(viewModel, 0, 'var c = 3', 'javascript', CellKind.Code, {}, [], true, true));\n\t\t\t\tawait executionService.executeNotebookCells(viewModel.notebookDocument, [cell.model], contextKeyService);\n\t\t\t\tassert.strictEqual(executeSpy.calledOnce, true);\n\t\t\t});\n\t});\n\n\ttest('Completes unconfirmed executions', async function () {\n\n\t\treturn withTestNotebook([], async (viewModel, textModel) => {\n\t\t\tlet didExecute = false;\n\t\t\tconst kernel = new class extends TestNotebookKernel {\n\t\t\t\tconstructor() {\n\t\t\t\t\tsuper({ languages: ['javascript'] });\n\t\t\t\t\tthis.id = 'mySpecialId';\n\t\t\t\t}\n\n\t\t\t\toverride async executeNotebookCellsRequest() {\n\t\t\t\t\tdidExecute = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tdisposables.add(kernelService.registerKernel(kernel));\n\t\t\tkernelService.selectKernelForNotebook(kernel, textModel);\n\t\t\tconst executionService = disposables.add(instantiationService.createInstance(NotebookExecutionService));\n\t\t\tconst exeStateService = instantiationService.get(INotebookExecutionStateService);\n\n\t\t\tconst cell = disposables.add(insertCellAtIndex(viewModel, 0, 'var c = 3', 'javascript', CellKind.Code, {}, [], true, true));\n\t\t\tawait executionService.executeNotebookCells(textModel, [cell.model], contextKeyService);\n\n\t\t\tassert.strictEqual(didExecute, true);\n\t\t\tassert.strictEqual(exeStateService.getCellExecution(cell.uri), undefined);\n\t\t});\n\t});\n});\n\nclass TestNotebookKernel implements INotebookKernel {\n\tid: string = 'test';\n\tlabel: string = '';\n\tviewType = '*';\n\tonDidChange = Event.None;\n\textension: ExtensionIdentifier = new ExtensionIdentifier('test');\n\tlocalResourceRoot: URI = URI.file('/test');\n\tdescription?: string | undefined;\n\tdetail?: string | undefined;\n\tpreloadUris: URI[] = [];\n\tpreloadProvides: string[] = [];\n\tsupportedLanguages: string[] = [];\n\tprovideVariables(notebookUri: URI, parentId: number | undefined, kind: 'named' | 'indexed', start: number, token: CancellationToken): AsyncIterableProducer<VariablesResult> {\n\t\treturn AsyncIterableProducer.EMPTY;\n\t}\n\texecuteNotebookCellsRequest(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tcancelNotebookCellExecution(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tconstructor(opts?: { languages: string[] }) {\n\t\tthis.supportedLanguages = opts?.languages ?? [PLAINTEXT_LANGUAGE_ID];\n\t}\n\timplementsInterrupt?: boolean | undefined;\n\timplementsExecutionOrder?: boolean | undefined;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport * as sinon from 'sinon';\nimport { AsyncIterableProducer } from '../../../../../base/common/async.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Event } from '../../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { assertThrowsAsync, ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { PLAINTEXT_LANGUAGE_ID } from '../../../../../editor/common/languages/modesRegistry.js';\nimport { IMenu, IMenuService } from '../../../../../platform/actions/common/actions.js';\nimport { ICommandService } from '../../../../../platform/commands/common/commands.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { ExtensionIdentifier } from '../../../../../platform/extensions/common/extensions.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { insertCellAtIndex } from '../../browser/controller/cellOperations.js';\nimport { NotebookExecutionService } from '../../browser/services/notebookExecutionServiceImpl.js';\nimport { NotebookKernelService } from '../../browser/services/notebookKernelServiceImpl.js';\nimport { NotebookViewModel } from '../../browser/viewModel/notebookViewModelImpl.js';\nimport { NotebookTextModel } from '../../common/model/notebookTextModel.js';\nimport { CellKind, IOutputDto, NotebookCellMetadata } from '../../common/notebookCommon.js';\nimport { INotebookExecutionStateService } from '../../common/notebookExecutionStateService.js';\nimport { INotebookKernel, INotebookKernelHistoryService, INotebookKernelService, INotebookTextModelLike, VariablesResult } from '../../common/notebookKernelService.js';\nimport { INotebookLoggingService } from '../../common/notebookLoggingService.js';\nimport { INotebookService } from '../../common/notebookService.js';\nimport { setupInstantiationService, withTestNotebook as _withTestNotebook } from './testNotebookEditor.js';\n\nsuite('NotebookExecutionService', () => {\n\n\tlet instantiationService: TestInstantiationService;\n\tlet contextKeyService: IContextKeyService;\n\tlet kernelService: INotebookKernelService;\n\tlet disposables: DisposableStore;\n\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tsetup(function () {\n\n\t\tdisposables = new DisposableStore();\n\n\t\tinstantiationService = setupInstantiationService(disposables);\n\n\t\tinstantiationService.stub(INotebookService, new class extends mock<INotebookService>() {\n\t\t\toverride onDidAddNotebookDocument = Event.None;\n\t\t\toverride onWillRemoveNotebookDocument = Event.None;\n\t\t\toverride getNotebookTextModels() { return []; }\n\t\t});\n\n\t\tinstantiationService.stub(INotebookLoggingService, new class extends mock<INotebookLoggingService>() {\n\t\t\toverride debug(category: string, output: string): void {\n\t\t\t\t//\n\t\t\t}\n\t\t});\n\n\t\tinstantiationService.stub(IMenuService, new class extends mock<IMenuService>() {\n\t\t\toverride createMenu() {\n\t\t\t\treturn new class extends mock<IMenu>() {\n\t\t\t\t\toverride onDidChange = Event.None;\n\t\t\t\t\toverride getActions() { return []; }\n\t\t\t\t\toverride dispose() { }\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tinstantiationService.stub(INotebookKernelHistoryService, new class extends mock<INotebookKernelHistoryService>() {\n\t\t\toverride getKernels(notebook: INotebookTextModelLike) {\n\t\t\t\treturn kernelService.getMatchingKernel(notebook);\n\t\t\t}\n\t\t\toverride addMostRecentKernel(kernel: INotebookKernel): void { }\n\t\t});\n\n\t\tinstantiationService.stub(ICommandService, new class extends mock<ICommandService>() {\n\t\t\toverride executeCommand(_commandId: string, ..._args: unknown[]) {\n\t\t\t\treturn Promise.resolve(undefined);\n\t\t\t}\n\t\t});\n\n\t\tkernelService = disposables.add(instantiationService.createInstance(NotebookKernelService));\n\t\tinstantiationService.set(INotebookKernelService, kernelService);\n\t\tcontextKeyService = instantiationService.get(IContextKeyService);\n\t});\n\n\tasync function withTestNotebook(cells: [string, string, CellKind, IOutputDto[], NotebookCellMetadata][], callback: (viewModel: NotebookViewModel, textModel: NotebookTextModel, disposables: DisposableStore) => void | Promise<void>) {\n\t\treturn _withTestNotebook(cells, (editor, viewModel, disposables) => callback(viewModel, viewModel.notebookDocument, disposables));\n\t}\n\n\t// test('ctor', () => {\n\t// \tinstantiationService.createInstance(NotebookEditorKernelManager, { activeKernel: undefined, viewModel: undefined });\n\t// \tconst contextKeyService = instantiationService.get(IContextKeyService);\n\n\t// \tassert.strictEqual(contextKeyService.getContextKeyValue(NOTEBOOK_KERNEL_COUNT.key), 0);\n\t// });\n\n\ttest('cell is not runnable when no kernel is selected', async () => {\n\t\tawait withTestNotebook(\n\t\t\t[],\n\t\t\tasync (viewModel, textModel, disposables) => {\n\t\t\t\tconst executionService = instantiationService.createInstance(NotebookExecutionService);\n\n\t\t\t\tconst cell = insertCellAtIndex(viewModel, 1, 'var c = 3', 'javascript', CellKind.Code, {}, [], true, true);\n\t\t\t\tawait assertThrowsAsync(async () => await executionService.executeNotebookCells(textModel, [cell.model], contextKeyService));\n\t\t\t});\n\t});\n\n\ttest('cell is not runnable when kernel does not support the language', async () => {\n\t\tawait withTestNotebook(\n\t\t\t[],\n\t\t\tasync (viewModel, textModel) => {\n\n\t\t\t\tdisposables.add(kernelService.registerKernel(new TestNotebookKernel({ languages: ['testlang'] })));\n\t\t\t\tconst executionService = disposables.add(instantiationService.createInstance(NotebookExecutionService));\n\t\t\t\tconst cell = disposables.add(insertCellAtIndex(viewModel, 1, 'var c = 3', 'javascript', CellKind.Code, {}, [], true, true));\n\t\t\t\tawait assertThrowsAsync(async () => await executionService.executeNotebookCells(textModel, [cell.model], contextKeyService));\n\n\t\t\t});\n\t});\n\n\ttest('cell is runnable when kernel does support the language', async () => {\n\t\tawait withTestNotebook(\n\t\t\t[],\n\t\t\tasync (viewModel, textModel) => {\n\t\t\t\tconst kernel = new TestNotebookKernel({ languages: ['javascript'] });\n\t\t\t\tdisposables.add(kernelService.registerKernel(kernel));\n\t\t\t\tkernelService.selectKernelForNotebook(kernel, textModel);\n\t\t\t\tconst executionService = disposables.add(instantiationService.createInstance(NotebookExecutionService));\n\t\t\t\tconst executeSpy = sinon.spy();\n\t\t\t\tkernel.executeNotebookCellsRequest = executeSpy;\n\n\t\t\t\tconst cell = disposables.add(insertCellAtIndex(viewModel, 0, 'var c = 3', 'javascript', CellKind.Code, {}, [], true, true));\n\t\t\t\tawait executionService.executeNotebookCells(viewModel.notebookDocument, [cell.model], contextKeyService);\n\t\t\t\tassert.strictEqual(executeSpy.calledOnce, true);\n\t\t\t});\n\t});\n\n\ttest('Completes unconfirmed executions', async function () {\n\n\t\treturn withTestNotebook([], async (viewModel, textModel) => {\n\t\t\tlet didExecute = false;\n\t\t\tconst kernel = new class extends TestNotebookKernel {\n\t\t\t\tconstructor() {\n\t\t\t\t\tsuper({ languages: ['javascript'] });\n\t\t\t\t\tthis.id = 'mySpecialId';\n\t\t\t\t}\n\n\t\t\t\toverride async executeNotebookCellsRequest() {\n\t\t\t\t\tdidExecute = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tdisposables.add(kernelService.registerKernel(kernel));\n\t\t\tkernelService.selectKernelForNotebook(kernel, textModel);\n\t\t\tconst executionService = disposables.add(instantiationService.createInstance(NotebookExecutionService));\n\t\t\tconst exeStateService = instantiationService.get(INotebookExecutionStateService);\n\n\t\t\tconst cell = disposables.add(insertCellAtIndex(viewModel, 0, 'var c = 3', 'javascript', CellKind.Code, {}, [], true, true));\n\t\t\tawait executionService.executeNotebookCells(textModel, [cell.model], contextKeyService);\n\n\t\t\tassert.strictEqual(didExecute, true);\n\t\t\tassert.strictEqual(exeStateService.getCellExecution(cell.uri), undefined);\n\t\t});\n\t});\n});\n\nclass TestNotebookKernel implements INotebookKernel {\n\tid: string = 'test';\n\tlabel: string = '';\n\tviewType = '*';\n\tonDidChange = Event.None;\n\textension: ExtensionIdentifier = new ExtensionIdentifier('test');\n\tlocalResourceRoot: URI = URI.file('/test');\n\tdescription?: string | undefined;\n\tdetail?: string | undefined;\n\tpreloadUris: URI[] = [];\n\tpreloadProvides: string[] = [];\n\tsupportedLanguages: string[] = [];\n\tprovideVariables(notebookUri: URI, parentId: number | undefined, kind: 'named' | 'indexed', start: number, token: CancellationToken): AsyncIterableProducer<VariablesResult> {\n\t\treturn AsyncIterableProducer.EMPTY;\n\t}\n\texecuteNotebookCellsRequest(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tcancelNotebookCellExecution(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tconstructor(opts?: { languages: string[] }) {\n\t\tthis.supportedLanguages = opts?.languages ?? [PLAINTEXT_LANGUAGE_ID];\n\t}\n\timplementsInterrupt?: boolean | undefined;\n\timplementsExecutionOrder?: boolean | undefined;\n}\n"]}