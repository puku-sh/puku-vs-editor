{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/test/browser/diff/editorHeightCalculator.test.ts","vs/workbench/contrib/notebook/test/browser/diff/editorHeightCalculator.test.ts"],"names":[],"mappings":"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","file":"editorHeightCalculator.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { DisposableStore, IReference } from '../../../../../../base/common/lifecycle.js';\nimport { mock } from '../../../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { DiffEditorHeightCalculatorService } from '../../../browser/diff/editorHeightCalculator.js';\nimport { FontInfo } from '../../../../../../editor/common/config/fontInfo.js';\nimport { IResolvedTextEditorModel, ITextModelService } from '../../../../../../editor/common/services/resolverService.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { createTextModel as createTextModelWithText } from '../../../../../../editor/test/common/testTextModel.js';\nimport { ITextModel } from '../../../../../../editor/common/model.js';\nimport { DefaultLinesDiffComputer } from '../../../../../../editor/common/diff/defaultLinesDiffComputer/defaultLinesDiffComputer.js';\nimport { DiffAlgorithmName, IEditorWorkerService } from '../../../../../../editor/common/services/editorWorker.js';\nimport { IDocumentDiffProviderOptions, IDocumentDiff } from '../../../../../../editor/common/diff/documentDiffProvider.js';\nimport { getEditorPadding } from '../../../browser/diff/diffCellEditorOptions.js';\nimport { HeightOfHiddenLinesRegionInDiffEditor } from '../../../browser/diff/diffElementViewModel.js';\n\nsuite('NotebookDiff EditorHeightCalculator', () => {\n\t['Hide Unchanged Regions', 'Show Unchanged Regions'].forEach(suiteTitle => {\n\t\tsuite(suiteTitle, () => {\n\t\t\tconst fontInfo: FontInfo = { lineHeight: 18, fontSize: 18 } as FontInfo;\n\t\t\tlet disposables: DisposableStore;\n\t\t\tlet textModelResolver: ITextModelService;\n\t\t\tlet editorWorkerService: IEditorWorkerService;\n\t\t\tconst original: URI = URI.parse('original');\n\t\t\tconst modified: URI = URI.parse('modified');\n\t\t\tlet originalModel: ITextModel;\n\t\t\tlet modifiedModel: ITextModel;\n\t\t\tconst diffComputer = new DefaultLinesDiffComputer();\n\t\t\tlet calculator: DiffEditorHeightCalculatorService;\n\t\t\tconst hideUnchangedRegions = suiteTitle.startsWith('Hide');\n\t\t\tconst configurationService = new TestConfigurationService({\n\t\t\t\tnotebook: { diff: { ignoreMetadata: true } }, diffEditor: {\n\t\t\t\t\thideUnchangedRegions: {\n\t\t\t\t\t\tenabled: hideUnchangedRegions, minimumLineCount: 3, contextLineCount: 3\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tfunction createTextModel(lines: string[]): ITextModel {\n\t\t\t\treturn createTextModelWithText(lines.join('\\n'));\n\t\t\t}\n\n\t\t\tteardown(() => disposables.dispose());\n\t\t\tensureNoDisposablesAreLeakedInTestSuite();\n\n\t\t\tsetup(() => {\n\t\t\t\tdisposables = new DisposableStore();\n\t\t\t\ttextModelResolver = new class extends mock<ITextModelService>() {\n\t\t\t\t\toverride async createModelReference(resource: URI): Promise<IReference<IResolvedTextEditorModel>> {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tdispose: () => { },\n\t\t\t\t\t\t\tobject: {\n\t\t\t\t\t\t\t\ttextEditorModel: resource === original ? originalModel : modifiedModel,\n\t\t\t\t\t\t\t\tgetLanguageId: () => 'javascript',\n\t\t\t\t\t\t\t} as IResolvedTextEditorModel\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\teditorWorkerService = new class extends mock<IEditorWorkerService>() {\n\t\t\t\t\toverride async computeDiff(_original: URI, _modified: URI, options: IDocumentDiffProviderOptions, _algorithm: DiffAlgorithmName): Promise<IDocumentDiff | null> {\n\t\t\t\t\t\tconst originalLines = new Array(originalModel.getLineCount()).fill(0).map((_, i) => originalModel.getLineContent(i + 1));\n\t\t\t\t\t\tconst modifiedLines = new Array(modifiedModel.getLineCount()).fill(0).map((_, i) => modifiedModel.getLineContent(i + 1));\n\t\t\t\t\t\tconst result = diffComputer.computeDiff(originalLines, modifiedLines, options);\n\t\t\t\t\t\tconst identical = originalLines.join('') === modifiedLines.join('');\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tidentical,\n\t\t\t\t\t\t\tquitEarly: result.hitTimeout,\n\t\t\t\t\t\t\tchanges: result.changes,\n\t\t\t\t\t\t\tmoves: result.moves,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tcalculator = new DiffEditorHeightCalculatorService(fontInfo.lineHeight, textModelResolver, editorWorkerService, configurationService);\n\t\t\t});\n\n\t\t\ttest('1 original line with change in same line', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(['Hello World']));\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(['Foo Bar']));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(1, 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\ttest('1 original line with insertion of a new line', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(['Hello World']));\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(['Hello World', 'Foo Bar']));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(2, 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\ttest('1 line with update to a line and insert of a new line', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(['Hello World']));\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(['Foo Bar', 'Bar Baz']));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(2, 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\ttest('10 line with update to a line and insert of a new line', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(createLines(10)));\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(createLines(10).concat('Foo Bar')));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(hideUnchangedRegions ? 4 : 11, hideUnchangedRegions ? 1 : 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\ttest('50 lines with updates, deletions and inserts', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(createLines(60)));\n\t\t\t\tconst modifiedLines = createLines(60);\n\t\t\t\tmodifiedLines[3] = 'Foo Bar';\n\t\t\t\tmodifiedLines.splice(7, 3);\n\t\t\t\tmodifiedLines.splice(10, 0, 'Foo Bar1', 'Foo Bar2', 'Foo Bar3');\n\t\t\t\tmodifiedLines.splice(30, 0, '', '');\n\t\t\t\tmodifiedLines.splice(40, 4);\n\t\t\t\tmodifiedLines.splice(50, 0, '1', '2', '3', '4', '5');\n\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(modifiedLines));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(hideUnchangedRegions ? 50 : 70, hideUnchangedRegions ? 3 : 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\tfunction getExpectedHeight(visibleLineCount: number, unchangeRegionsHeight: number): number {\n\t\t\t\treturn (visibleLineCount * fontInfo.lineHeight) + getEditorPadding(visibleLineCount).top + getEditorPadding(visibleLineCount).bottom + (unchangeRegionsHeight * HeightOfHiddenLinesRegionInDiffEditor);\n\t\t\t}\n\n\t\t\tfunction createLines(count: number, linePrefix = 'Hello World'): string[] {\n\t\t\t\treturn new Array(count).fill(0).map((_, i) => `${linePrefix} ${i}`);\n\t\t\t}\n\t\t});\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { DisposableStore, IReference } from '../../../../../../base/common/lifecycle.js';\nimport { mock } from '../../../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { DiffEditorHeightCalculatorService } from '../../../browser/diff/editorHeightCalculator.js';\nimport { FontInfo } from '../../../../../../editor/common/config/fontInfo.js';\nimport { IResolvedTextEditorModel, ITextModelService } from '../../../../../../editor/common/services/resolverService.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { createTextModel as createTextModelWithText } from '../../../../../../editor/test/common/testTextModel.js';\nimport { ITextModel } from '../../../../../../editor/common/model.js';\nimport { DefaultLinesDiffComputer } from '../../../../../../editor/common/diff/defaultLinesDiffComputer/defaultLinesDiffComputer.js';\nimport { DiffAlgorithmName, IEditorWorkerService } from '../../../../../../editor/common/services/editorWorker.js';\nimport { IDocumentDiffProviderOptions, IDocumentDiff } from '../../../../../../editor/common/diff/documentDiffProvider.js';\nimport { getEditorPadding } from '../../../browser/diff/diffCellEditorOptions.js';\nimport { HeightOfHiddenLinesRegionInDiffEditor } from '../../../browser/diff/diffElementViewModel.js';\n\nsuite('NotebookDiff EditorHeightCalculator', () => {\n\t['Hide Unchanged Regions', 'Show Unchanged Regions'].forEach(suiteTitle => {\n\t\tsuite(suiteTitle, () => {\n\t\t\tconst fontInfo: FontInfo = { lineHeight: 18, fontSize: 18 } as FontInfo;\n\t\t\tlet disposables: DisposableStore;\n\t\t\tlet textModelResolver: ITextModelService;\n\t\t\tlet editorWorkerService: IEditorWorkerService;\n\t\t\tconst original: URI = URI.parse('original');\n\t\t\tconst modified: URI = URI.parse('modified');\n\t\t\tlet originalModel: ITextModel;\n\t\t\tlet modifiedModel: ITextModel;\n\t\t\tconst diffComputer = new DefaultLinesDiffComputer();\n\t\t\tlet calculator: DiffEditorHeightCalculatorService;\n\t\t\tconst hideUnchangedRegions = suiteTitle.startsWith('Hide');\n\t\t\tconst configurationService = new TestConfigurationService({\n\t\t\t\tnotebook: { diff: { ignoreMetadata: true } }, diffEditor: {\n\t\t\t\t\thideUnchangedRegions: {\n\t\t\t\t\t\tenabled: hideUnchangedRegions, minimumLineCount: 3, contextLineCount: 3\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tfunction createTextModel(lines: string[]): ITextModel {\n\t\t\t\treturn createTextModelWithText(lines.join('\\n'));\n\t\t\t}\n\n\t\t\tteardown(() => disposables.dispose());\n\t\t\tensureNoDisposablesAreLeakedInTestSuite();\n\n\t\t\tsetup(() => {\n\t\t\t\tdisposables = new DisposableStore();\n\t\t\t\ttextModelResolver = new class extends mock<ITextModelService>() {\n\t\t\t\t\toverride async createModelReference(resource: URI): Promise<IReference<IResolvedTextEditorModel>> {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tdispose: () => { },\n\t\t\t\t\t\t\tobject: {\n\t\t\t\t\t\t\t\ttextEditorModel: resource === original ? originalModel : modifiedModel,\n\t\t\t\t\t\t\t\tgetLanguageId: () => 'javascript',\n\t\t\t\t\t\t\t} as IResolvedTextEditorModel\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\teditorWorkerService = new class extends mock<IEditorWorkerService>() {\n\t\t\t\t\toverride async computeDiff(_original: URI, _modified: URI, options: IDocumentDiffProviderOptions, _algorithm: DiffAlgorithmName): Promise<IDocumentDiff | null> {\n\t\t\t\t\t\tconst originalLines = new Array(originalModel.getLineCount()).fill(0).map((_, i) => originalModel.getLineContent(i + 1));\n\t\t\t\t\t\tconst modifiedLines = new Array(modifiedModel.getLineCount()).fill(0).map((_, i) => modifiedModel.getLineContent(i + 1));\n\t\t\t\t\t\tconst result = diffComputer.computeDiff(originalLines, modifiedLines, options);\n\t\t\t\t\t\tconst identical = originalLines.join('') === modifiedLines.join('');\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tidentical,\n\t\t\t\t\t\t\tquitEarly: result.hitTimeout,\n\t\t\t\t\t\t\tchanges: result.changes,\n\t\t\t\t\t\t\tmoves: result.moves,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tcalculator = new DiffEditorHeightCalculatorService(fontInfo.lineHeight, textModelResolver, editorWorkerService, configurationService);\n\t\t\t});\n\n\t\t\ttest('1 original line with change in same line', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(['Hello World']));\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(['Foo Bar']));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(1, 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\ttest('1 original line with insertion of a new line', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(['Hello World']));\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(['Hello World', 'Foo Bar']));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(2, 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\ttest('1 line with update to a line and insert of a new line', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(['Hello World']));\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(['Foo Bar', 'Bar Baz']));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(2, 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\ttest('10 line with update to a line and insert of a new line', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(createLines(10)));\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(createLines(10).concat('Foo Bar')));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(hideUnchangedRegions ? 4 : 11, hideUnchangedRegions ? 1 : 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\ttest('50 lines with updates, deletions and inserts', async () => {\n\t\t\t\toriginalModel = disposables.add(createTextModel(createLines(60)));\n\t\t\t\tconst modifiedLines = createLines(60);\n\t\t\t\tmodifiedLines[3] = 'Foo Bar';\n\t\t\t\tmodifiedLines.splice(7, 3);\n\t\t\t\tmodifiedLines.splice(10, 0, 'Foo Bar1', 'Foo Bar2', 'Foo Bar3');\n\t\t\t\tmodifiedLines.splice(30, 0, '', '');\n\t\t\t\tmodifiedLines.splice(40, 4);\n\t\t\t\tmodifiedLines.splice(50, 0, '1', '2', '3', '4', '5');\n\n\t\t\t\tmodifiedModel = disposables.add(createTextModel(modifiedLines));\n\n\t\t\t\tconst height = await calculator.diffAndComputeHeight(original, modified);\n\t\t\t\tconst expectedHeight = getExpectedHeight(hideUnchangedRegions ? 50 : 70, hideUnchangedRegions ? 3 : 0);\n\n\t\t\t\tassert.strictEqual(height, expectedHeight);\n\t\t\t});\n\n\t\t\tfunction getExpectedHeight(visibleLineCount: number, unchangeRegionsHeight: number): number {\n\t\t\t\treturn (visibleLineCount * fontInfo.lineHeight) + getEditorPadding(visibleLineCount).top + getEditorPadding(visibleLineCount).bottom + (unchangeRegionsHeight * HeightOfHiddenLinesRegionInDiffEditor);\n\t\t\t}\n\n\t\t\tfunction createLines(count: number, linePrefix = 'Hello World'): string[] {\n\t\t\t\treturn new Array(count).fill(0).map((_, i) => `${linePrefix} ${i}`);\n\t\t\t}\n\t\t});\n\t});\n});\n"]}