{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/notebook/test/browser/notebookKernelService.test.ts","vs/workbench/contrib/notebook/test/browser/notebookKernelService.test.ts"],"names":[],"mappings":"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","file":"notebookKernelService.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { ExtensionIdentifier } from '../../../../../platform/extensions/common/extensions.js';\nimport { setupInstantiationService } from './testNotebookEditor.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { INotebookKernel, INotebookKernelService, VariablesResult } from '../../common/notebookKernelService.js';\nimport { NotebookKernelService } from '../../browser/services/notebookKernelServiceImpl.js';\nimport { INotebookService } from '../../common/notebookService.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { NotebookTextModel } from '../../common/model/notebookTextModel.js';\nimport { PLAINTEXT_LANGUAGE_ID } from '../../../../../editor/common/languages/modesRegistry.js';\nimport { IMenu, IMenuService } from '../../../../../platform/actions/common/actions.js';\nimport { TransientOptions } from '../../common/notebookCommon.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { AsyncIterableProducer } from '../../../../../base/common/async.js';\n\nsuite('NotebookKernelService', () => {\n\n\tlet instantiationService: TestInstantiationService;\n\tlet kernelService: INotebookKernelService;\n\tlet disposables: DisposableStore;\n\n\tlet onDidAddNotebookDocument: Emitter<NotebookTextModel>;\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tsetup(function () {\n\t\tdisposables = new DisposableStore();\n\n\t\tonDidAddNotebookDocument = new Emitter();\n\t\tdisposables.add(onDidAddNotebookDocument);\n\n\t\tinstantiationService = setupInstantiationService(disposables);\n\t\tinstantiationService.stub(INotebookService, new class extends mock<INotebookService>() {\n\t\t\toverride onDidAddNotebookDocument = onDidAddNotebookDocument.event;\n\t\t\toverride onWillRemoveNotebookDocument = Event.None;\n\t\t\toverride getNotebookTextModels() { return []; }\n\t\t});\n\t\tinstantiationService.stub(IMenuService, new class extends mock<IMenuService>() {\n\t\t\toverride createMenu() {\n\t\t\t\treturn new class extends mock<IMenu>() {\n\t\t\t\t\toverride onDidChange = Event.None;\n\t\t\t\t\toverride getActions() { return []; }\n\t\t\t\t\toverride dispose() { }\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\t\tkernelService = disposables.add(instantiationService.createInstance(NotebookKernelService));\n\t\tinstantiationService.set(INotebookKernelService, kernelService);\n\t});\n\n\ttest('notebook priorities', function () {\n\n\t\tconst u1 = URI.parse('foo:///one');\n\t\tconst u2 = URI.parse('foo:///two');\n\n\t\tconst k1 = new TestNotebookKernel({ label: 'z' });\n\t\tconst k2 = new TestNotebookKernel({ label: 'a' });\n\n\t\tdisposables.add(kernelService.registerKernel(k1));\n\t\tdisposables.add(kernelService.registerKernel(k2));\n\n\t\t// equal priorities -> sort by name\n\t\tlet info = kernelService.getMatchingKernel({ uri: u1, notebookType: 'foo' });\n\t\tassert.ok(info.all[0] === k2);\n\t\tassert.ok(info.all[1] === k1);\n\n\t\t// update priorities for u1 notebook\n\t\tkernelService.updateKernelNotebookAffinity(k2, u1, 2);\n\t\tkernelService.updateKernelNotebookAffinity(k2, u2, 1);\n\n\t\t// updated\n\t\tinfo = kernelService.getMatchingKernel({ uri: u1, notebookType: 'foo' });\n\t\tassert.ok(info.all[0] === k2);\n\t\tassert.ok(info.all[1] === k1);\n\n\t\t// NOT updated\n\t\tinfo = kernelService.getMatchingKernel({ uri: u2, notebookType: 'foo' });\n\t\tassert.ok(info.all[0] === k2);\n\t\tassert.ok(info.all[1] === k1);\n\n\t\t// reset\n\t\tkernelService.updateKernelNotebookAffinity(k2, u1, undefined);\n\t\tinfo = kernelService.getMatchingKernel({ uri: u1, notebookType: 'foo' });\n\t\tassert.ok(info.all[0] === k2);\n\t\tassert.ok(info.all[1] === k1);\n\t});\n\n\ttest('new kernel with higher affinity wins, https://github.com/microsoft/vscode/issues/122028', function () {\n\t\tconst notebook = URI.parse('foo:///one');\n\n\t\tconst kernel = new TestNotebookKernel();\n\t\tdisposables.add(kernelService.registerKernel(kernel));\n\n\t\tlet info = kernelService.getMatchingKernel({ uri: notebook, notebookType: 'foo' });\n\t\tassert.strictEqual(info.all.length, 1);\n\t\tassert.ok(info.all[0] === kernel);\n\n\t\tconst betterKernel = new TestNotebookKernel();\n\t\tdisposables.add(kernelService.registerKernel(betterKernel));\n\n\t\tinfo = kernelService.getMatchingKernel({ uri: notebook, notebookType: 'foo' });\n\t\tassert.strictEqual(info.all.length, 2);\n\n\t\tkernelService.updateKernelNotebookAffinity(betterKernel, notebook, 2);\n\t\tinfo = kernelService.getMatchingKernel({ uri: notebook, notebookType: 'foo' });\n\t\tassert.strictEqual(info.all.length, 2);\n\t\tassert.ok(info.all[0] === betterKernel);\n\t\tassert.ok(info.all[1] === kernel);\n\t});\n\n\ttest('onDidChangeSelectedNotebooks not fired on initial notebook open #121904', function () {\n\n\t\tconst uri = URI.parse('foo:///one');\n\t\tconst jupyter = { uri, viewType: 'jupyter', notebookType: 'jupyter' };\n\t\tconst dotnet = { uri, viewType: 'dotnet', notebookType: 'dotnet' };\n\n\t\tconst jupyterKernel = new TestNotebookKernel({ viewType: jupyter.viewType });\n\t\tconst dotnetKernel = new TestNotebookKernel({ viewType: dotnet.viewType });\n\t\tdisposables.add(kernelService.registerKernel(jupyterKernel));\n\t\tdisposables.add(kernelService.registerKernel(dotnetKernel));\n\n\t\tkernelService.selectKernelForNotebook(jupyterKernel, jupyter);\n\t\tkernelService.selectKernelForNotebook(dotnetKernel, dotnet);\n\n\t\tlet info = kernelService.getMatchingKernel(dotnet);\n\t\tassert.strictEqual(info.selected === dotnetKernel, true);\n\n\t\tinfo = kernelService.getMatchingKernel(jupyter);\n\t\tassert.strictEqual(info.selected === jupyterKernel, true);\n\t});\n\n\ttest('onDidChangeSelectedNotebooks not fired on initial notebook open #121904, p2', async function () {\n\n\t\tconst uri = URI.parse('foo:///one');\n\t\tconst jupyter = { uri, viewType: 'jupyter', notebookType: 'jupyter' };\n\t\tconst dotnet = { uri, viewType: 'dotnet', notebookType: 'dotnet' };\n\n\t\tconst jupyterKernel = new TestNotebookKernel({ viewType: jupyter.viewType });\n\t\tconst dotnetKernel = new TestNotebookKernel({ viewType: dotnet.viewType });\n\t\tdisposables.add(kernelService.registerKernel(jupyterKernel));\n\t\tdisposables.add(kernelService.registerKernel(dotnetKernel));\n\n\t\tkernelService.selectKernelForNotebook(jupyterKernel, jupyter);\n\t\tkernelService.selectKernelForNotebook(dotnetKernel, dotnet);\n\n\t\tconst transientOptions: TransientOptions = {\n\t\t\ttransientOutputs: false,\n\t\t\ttransientCellMetadata: {},\n\t\t\ttransientDocumentMetadata: {},\n\t\t\tcellContentMetadata: {},\n\t\t};\n\n\t\t{\n\t\t\t// open as jupyter -> bind event\n\t\t\tconst p1 = Event.toPromise(kernelService.onDidChangeSelectedNotebooks);\n\t\t\tconst d1 = disposables.add(instantiationService.createInstance(NotebookTextModel, jupyter.viewType, jupyter.uri, [], {}, transientOptions));\n\t\t\tonDidAddNotebookDocument.fire(d1);\n\t\t\tconst event = await p1;\n\t\t\tassert.strictEqual(event.newKernel, jupyterKernel.id);\n\t\t}\n\t\t{\n\t\t\t// RE-open as dotnet -> bind event\n\t\t\tconst p2 = Event.toPromise(kernelService.onDidChangeSelectedNotebooks);\n\t\t\tconst d2 = disposables.add(instantiationService.createInstance(NotebookTextModel, dotnet.viewType, dotnet.uri, [], {}, transientOptions));\n\t\t\tonDidAddNotebookDocument.fire(d2);\n\t\t\tconst event2 = await p2;\n\t\t\tassert.strictEqual(event2.newKernel, dotnetKernel.id);\n\t\t}\n\t});\n});\n\nclass TestNotebookKernel implements INotebookKernel {\n\tid: string = Math.random() + 'kernel';\n\tlabel: string = 'test-label';\n\tviewType = '*';\n\tonDidChange = Event.None;\n\textension: ExtensionIdentifier = new ExtensionIdentifier('test');\n\tlocalResourceRoot: URI = URI.file('/test');\n\tdescription?: string | undefined;\n\tdetail?: string | undefined;\n\tpreloadUris: URI[] = [];\n\tpreloadProvides: string[] = [];\n\tsupportedLanguages: string[] = [];\n\texecuteNotebookCellsRequest(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tcancelNotebookCellExecution(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tprovideVariables(notebookUri: URI, parentId: number | undefined, kind: 'named' | 'indexed', start: number, token: CancellationToken): AsyncIterableProducer<VariablesResult> {\n\t\treturn AsyncIterableProducer.EMPTY;\n\t}\n\n\tconstructor(opts?: { languages?: string[]; label?: string; viewType?: string }) {\n\t\tthis.supportedLanguages = opts?.languages ?? [PLAINTEXT_LANGUAGE_ID];\n\t\tthis.label = opts?.label ?? this.label;\n\t\tthis.viewType = opts?.viewType ?? this.viewType;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { ExtensionIdentifier } from '../../../../../platform/extensions/common/extensions.js';\nimport { setupInstantiationService } from './testNotebookEditor.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { INotebookKernel, INotebookKernelService, VariablesResult } from '../../common/notebookKernelService.js';\nimport { NotebookKernelService } from '../../browser/services/notebookKernelServiceImpl.js';\nimport { INotebookService } from '../../common/notebookService.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { NotebookTextModel } from '../../common/model/notebookTextModel.js';\nimport { PLAINTEXT_LANGUAGE_ID } from '../../../../../editor/common/languages/modesRegistry.js';\nimport { IMenu, IMenuService } from '../../../../../platform/actions/common/actions.js';\nimport { TransientOptions } from '../../common/notebookCommon.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { AsyncIterableProducer } from '../../../../../base/common/async.js';\n\nsuite('NotebookKernelService', () => {\n\n\tlet instantiationService: TestInstantiationService;\n\tlet kernelService: INotebookKernelService;\n\tlet disposables: DisposableStore;\n\n\tlet onDidAddNotebookDocument: Emitter<NotebookTextModel>;\n\tteardown(() => {\n\t\tdisposables.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tsetup(function () {\n\t\tdisposables = new DisposableStore();\n\n\t\tonDidAddNotebookDocument = new Emitter();\n\t\tdisposables.add(onDidAddNotebookDocument);\n\n\t\tinstantiationService = setupInstantiationService(disposables);\n\t\tinstantiationService.stub(INotebookService, new class extends mock<INotebookService>() {\n\t\t\toverride onDidAddNotebookDocument = onDidAddNotebookDocument.event;\n\t\t\toverride onWillRemoveNotebookDocument = Event.None;\n\t\t\toverride getNotebookTextModels() { return []; }\n\t\t});\n\t\tinstantiationService.stub(IMenuService, new class extends mock<IMenuService>() {\n\t\t\toverride createMenu() {\n\t\t\t\treturn new class extends mock<IMenu>() {\n\t\t\t\t\toverride onDidChange = Event.None;\n\t\t\t\t\toverride getActions() { return []; }\n\t\t\t\t\toverride dispose() { }\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\t\tkernelService = disposables.add(instantiationService.createInstance(NotebookKernelService));\n\t\tinstantiationService.set(INotebookKernelService, kernelService);\n\t});\n\n\ttest('notebook priorities', function () {\n\n\t\tconst u1 = URI.parse('foo:///one');\n\t\tconst u2 = URI.parse('foo:///two');\n\n\t\tconst k1 = new TestNotebookKernel({ label: 'z' });\n\t\tconst k2 = new TestNotebookKernel({ label: 'a' });\n\n\t\tdisposables.add(kernelService.registerKernel(k1));\n\t\tdisposables.add(kernelService.registerKernel(k2));\n\n\t\t// equal priorities -> sort by name\n\t\tlet info = kernelService.getMatchingKernel({ uri: u1, notebookType: 'foo' });\n\t\tassert.ok(info.all[0] === k2);\n\t\tassert.ok(info.all[1] === k1);\n\n\t\t// update priorities for u1 notebook\n\t\tkernelService.updateKernelNotebookAffinity(k2, u1, 2);\n\t\tkernelService.updateKernelNotebookAffinity(k2, u2, 1);\n\n\t\t// updated\n\t\tinfo = kernelService.getMatchingKernel({ uri: u1, notebookType: 'foo' });\n\t\tassert.ok(info.all[0] === k2);\n\t\tassert.ok(info.all[1] === k1);\n\n\t\t// NOT updated\n\t\tinfo = kernelService.getMatchingKernel({ uri: u2, notebookType: 'foo' });\n\t\tassert.ok(info.all[0] === k2);\n\t\tassert.ok(info.all[1] === k1);\n\n\t\t// reset\n\t\tkernelService.updateKernelNotebookAffinity(k2, u1, undefined);\n\t\tinfo = kernelService.getMatchingKernel({ uri: u1, notebookType: 'foo' });\n\t\tassert.ok(info.all[0] === k2);\n\t\tassert.ok(info.all[1] === k1);\n\t});\n\n\ttest('new kernel with higher affinity wins, https://github.com/microsoft/vscode/issues/122028', function () {\n\t\tconst notebook = URI.parse('foo:///one');\n\n\t\tconst kernel = new TestNotebookKernel();\n\t\tdisposables.add(kernelService.registerKernel(kernel));\n\n\t\tlet info = kernelService.getMatchingKernel({ uri: notebook, notebookType: 'foo' });\n\t\tassert.strictEqual(info.all.length, 1);\n\t\tassert.ok(info.all[0] === kernel);\n\n\t\tconst betterKernel = new TestNotebookKernel();\n\t\tdisposables.add(kernelService.registerKernel(betterKernel));\n\n\t\tinfo = kernelService.getMatchingKernel({ uri: notebook, notebookType: 'foo' });\n\t\tassert.strictEqual(info.all.length, 2);\n\n\t\tkernelService.updateKernelNotebookAffinity(betterKernel, notebook, 2);\n\t\tinfo = kernelService.getMatchingKernel({ uri: notebook, notebookType: 'foo' });\n\t\tassert.strictEqual(info.all.length, 2);\n\t\tassert.ok(info.all[0] === betterKernel);\n\t\tassert.ok(info.all[1] === kernel);\n\t});\n\n\ttest('onDidChangeSelectedNotebooks not fired on initial notebook open #121904', function () {\n\n\t\tconst uri = URI.parse('foo:///one');\n\t\tconst jupyter = { uri, viewType: 'jupyter', notebookType: 'jupyter' };\n\t\tconst dotnet = { uri, viewType: 'dotnet', notebookType: 'dotnet' };\n\n\t\tconst jupyterKernel = new TestNotebookKernel({ viewType: jupyter.viewType });\n\t\tconst dotnetKernel = new TestNotebookKernel({ viewType: dotnet.viewType });\n\t\tdisposables.add(kernelService.registerKernel(jupyterKernel));\n\t\tdisposables.add(kernelService.registerKernel(dotnetKernel));\n\n\t\tkernelService.selectKernelForNotebook(jupyterKernel, jupyter);\n\t\tkernelService.selectKernelForNotebook(dotnetKernel, dotnet);\n\n\t\tlet info = kernelService.getMatchingKernel(dotnet);\n\t\tassert.strictEqual(info.selected === dotnetKernel, true);\n\n\t\tinfo = kernelService.getMatchingKernel(jupyter);\n\t\tassert.strictEqual(info.selected === jupyterKernel, true);\n\t});\n\n\ttest('onDidChangeSelectedNotebooks not fired on initial notebook open #121904, p2', async function () {\n\n\t\tconst uri = URI.parse('foo:///one');\n\t\tconst jupyter = { uri, viewType: 'jupyter', notebookType: 'jupyter' };\n\t\tconst dotnet = { uri, viewType: 'dotnet', notebookType: 'dotnet' };\n\n\t\tconst jupyterKernel = new TestNotebookKernel({ viewType: jupyter.viewType });\n\t\tconst dotnetKernel = new TestNotebookKernel({ viewType: dotnet.viewType });\n\t\tdisposables.add(kernelService.registerKernel(jupyterKernel));\n\t\tdisposables.add(kernelService.registerKernel(dotnetKernel));\n\n\t\tkernelService.selectKernelForNotebook(jupyterKernel, jupyter);\n\t\tkernelService.selectKernelForNotebook(dotnetKernel, dotnet);\n\n\t\tconst transientOptions: TransientOptions = {\n\t\t\ttransientOutputs: false,\n\t\t\ttransientCellMetadata: {},\n\t\t\ttransientDocumentMetadata: {},\n\t\t\tcellContentMetadata: {},\n\t\t};\n\n\t\t{\n\t\t\t// open as jupyter -> bind event\n\t\t\tconst p1 = Event.toPromise(kernelService.onDidChangeSelectedNotebooks);\n\t\t\tconst d1 = disposables.add(instantiationService.createInstance(NotebookTextModel, jupyter.viewType, jupyter.uri, [], {}, transientOptions));\n\t\t\tonDidAddNotebookDocument.fire(d1);\n\t\t\tconst event = await p1;\n\t\t\tassert.strictEqual(event.newKernel, jupyterKernel.id);\n\t\t}\n\t\t{\n\t\t\t// RE-open as dotnet -> bind event\n\t\t\tconst p2 = Event.toPromise(kernelService.onDidChangeSelectedNotebooks);\n\t\t\tconst d2 = disposables.add(instantiationService.createInstance(NotebookTextModel, dotnet.viewType, dotnet.uri, [], {}, transientOptions));\n\t\t\tonDidAddNotebookDocument.fire(d2);\n\t\t\tconst event2 = await p2;\n\t\t\tassert.strictEqual(event2.newKernel, dotnetKernel.id);\n\t\t}\n\t});\n});\n\nclass TestNotebookKernel implements INotebookKernel {\n\tid: string = Math.random() + 'kernel';\n\tlabel: string = 'test-label';\n\tviewType = '*';\n\tonDidChange = Event.None;\n\textension: ExtensionIdentifier = new ExtensionIdentifier('test');\n\tlocalResourceRoot: URI = URI.file('/test');\n\tdescription?: string | undefined;\n\tdetail?: string | undefined;\n\tpreloadUris: URI[] = [];\n\tpreloadProvides: string[] = [];\n\tsupportedLanguages: string[] = [];\n\texecuteNotebookCellsRequest(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tcancelNotebookCellExecution(): Promise<void> {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tprovideVariables(notebookUri: URI, parentId: number | undefined, kind: 'named' | 'indexed', start: number, token: CancellationToken): AsyncIterableProducer<VariablesResult> {\n\t\treturn AsyncIterableProducer.EMPTY;\n\t}\n\n\tconstructor(opts?: { languages?: string[]; label?: string; viewType?: string }) {\n\t\tthis.supportedLanguages = opts?.languages ?? [PLAINTEXT_LANGUAGE_ID];\n\t\tthis.label = opts?.label ?? this.label;\n\t\tthis.viewType = opts?.viewType ?? this.viewType;\n\t}\n}\n"]}