{"version":3,"sources":["vs/workbench/contrib/comments/browser/commentsModel.ts"],"names":[],"mappings":"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","file":"commentsModel.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { groupBy } from '../../../../base/common/arrays.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { CommentThread } from '../../../../editor/common/languages.js';\nimport { localize } from '../../../../nls.js';\nimport { ResourceWithCommentThreads, ICommentThreadChangedEvent } from '../common/commentModel.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { isMarkdownString } from '../../../../base/common/htmlContent.js';\n\nexport function threadHasMeaningfulComments(thread: CommentThread): boolean {\n\treturn !!thread.comments && !!thread.comments.length && thread.comments.some(comment => isMarkdownString(comment.body) ? comment.body.value.length > 0 : comment.body.length > 0);\n\n}\n\nexport interface ICommentsModel {\n\thasCommentThreads(): boolean;\n\tgetMessage(): string;\n\treadonly resourceCommentThreads: ResourceWithCommentThreads[];\n\treadonly commentThreadsMap: Map<string, { resourceWithCommentThreads: ResourceWithCommentThreads[]; ownerLabel?: string }>;\n}\n\nexport class CommentsModel extends Disposable implements ICommentsModel {\n\treadonly _serviceBrand: undefined;\n\tprivate _resourceCommentThreads: ResourceWithCommentThreads[];\n\tget resourceCommentThreads(): ResourceWithCommentThreads[] { return this._resourceCommentThreads; }\n\treadonly commentThreadsMap: Map<string, { resourceWithCommentThreads: ResourceWithCommentThreads[]; ownerLabel?: string }>;\n\n\tconstructor(\n\t) {\n\t\tsuper();\n\t\tthis._resourceCommentThreads = [];\n\t\tthis.commentThreadsMap = new Map<string, { resourceWithCommentThreads: ResourceWithCommentThreads[]; ownerLabel: string }>();\n\t}\n\n\tprivate updateResourceCommentThreads() {\n\t\tconst includeLabel = this.commentThreadsMap.size > 1;\n\t\tthis._resourceCommentThreads = [...this.commentThreadsMap.values()].map(value => {\n\t\t\treturn value.resourceWithCommentThreads.map(resource => {\n\t\t\t\tresource.ownerLabel = includeLabel ? value.ownerLabel : undefined;\n\t\t\t\treturn resource;\n\t\t\t}).flat();\n\t\t}).flat();\n\t}\n\n\tpublic setCommentThreads(uniqueOwner: string, owner: string, ownerLabel: string, commentThreads: CommentThread[]): void {\n\t\tthis.commentThreadsMap.set(uniqueOwner, { ownerLabel, resourceWithCommentThreads: this.groupByResource(uniqueOwner, owner, commentThreads) });\n\t\tthis.updateResourceCommentThreads();\n\t}\n\n\tpublic deleteCommentsByOwner(uniqueOwner?: string): void {\n\t\tif (uniqueOwner) {\n\t\t\tconst existingOwner = this.commentThreadsMap.get(uniqueOwner);\n\t\t\tthis.commentThreadsMap.set(uniqueOwner, { ownerLabel: existingOwner?.ownerLabel, resourceWithCommentThreads: [] });\n\t\t} else {\n\t\t\tthis.commentThreadsMap.clear();\n\t\t}\n\t\tthis.updateResourceCommentThreads();\n\t}\n\n\tpublic updateCommentThreads(event: ICommentThreadChangedEvent): boolean {\n\t\tconst { uniqueOwner, owner, ownerLabel, removed, changed, added } = event;\n\n\t\tconst threadsForOwner = this.commentThreadsMap.get(uniqueOwner)?.resourceWithCommentThreads || [];\n\n\t\tremoved.forEach(thread => {\n\t\t\t// Find resource that has the comment thread\n\t\t\tconst matchingResourceIndex = threadsForOwner.findIndex((resourceData) => resourceData.id === thread.resource);\n\t\t\tconst matchingResourceData = matchingResourceIndex >= 0 ? threadsForOwner[matchingResourceIndex] : undefined;\n\n\t\t\t// Find comment node on resource that is that thread and remove it\n\t\t\tconst index = matchingResourceData?.commentThreads.findIndex((commentThread) => commentThread.threadId === thread.threadId) ?? 0;\n\t\t\tif (index >= 0) {\n\t\t\t\tmatchingResourceData?.commentThreads.splice(index, 1);\n\t\t\t}\n\n\t\t\t// If the comment thread was the last thread for a resource, remove that resource from the list\n\t\t\tif (matchingResourceData?.commentThreads.length === 0) {\n\t\t\t\tthreadsForOwner.splice(matchingResourceIndex, 1);\n\t\t\t}\n\t\t});\n\n\t\tchanged.forEach(thread => {\n\t\t\t// Find resource that has the comment thread\n\t\t\tconst matchingResourceIndex = threadsForOwner.findIndex((resourceData) => resourceData.id === thread.resource);\n\t\t\tconst matchingResourceData = matchingResourceIndex >= 0 ? threadsForOwner[matchingResourceIndex] : undefined;\n\t\t\tif (!matchingResourceData) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Find comment node on resource that is that thread and replace it\n\t\t\tconst index = matchingResourceData.commentThreads.findIndex((commentThread) => commentThread.threadId === thread.threadId);\n\t\t\tif (index >= 0) {\n\t\t\t\tmatchingResourceData.commentThreads[index] = ResourceWithCommentThreads.createCommentNode(uniqueOwner, owner, URI.parse(matchingResourceData.id), thread);\n\t\t\t} else if (thread.comments && thread.comments.length) {\n\t\t\t\tmatchingResourceData.commentThreads.push(ResourceWithCommentThreads.createCommentNode(uniqueOwner, owner, URI.parse(matchingResourceData.id), thread));\n\t\t\t}\n\t\t});\n\n\t\tadded.forEach(thread => {\n\t\t\tconst existingResource = threadsForOwner.filter(resourceWithThreads => resourceWithThreads.resource.toString() === thread.resource);\n\t\t\tif (existingResource.length) {\n\t\t\t\tconst resource = existingResource[0];\n\t\t\t\tif (thread.comments && thread.comments.length) {\n\t\t\t\t\tresource.commentThreads.push(ResourceWithCommentThreads.createCommentNode(uniqueOwner, owner, resource.resource, thread));\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthreadsForOwner.push(new ResourceWithCommentThreads(uniqueOwner, owner, URI.parse(thread.resource!), [thread]));\n\t\t\t}\n\t\t});\n\n\t\tthis.commentThreadsMap.set(uniqueOwner, { ownerLabel, resourceWithCommentThreads: threadsForOwner });\n\t\tthis.updateResourceCommentThreads();\n\n\t\treturn removed.length > 0 || changed.length > 0 || added.length > 0;\n\t}\n\n\tpublic hasCommentThreads(): boolean {\n\t\t// There's a resource with at least one thread\n\t\treturn !!this._resourceCommentThreads.length && this._resourceCommentThreads.some(resource => {\n\t\t\t// At least one of the threads in the resource has comments\n\t\t\treturn (resource.commentThreads.length > 0) && resource.commentThreads.some(thread => {\n\t\t\t\t// At least one of the comments in the thread is not empty\n\t\t\t\treturn threadHasMeaningfulComments(thread.thread);\n\t\t\t});\n\t\t});\n\t}\n\n\tpublic getMessage(): string {\n\t\tif (!this._resourceCommentThreads.length) {\n\t\t\treturn localize('noComments', \"There are no comments in this workspace yet.\");\n\t\t} else {\n\t\t\treturn '';\n\t\t}\n\t}\n\n\tprivate groupByResource(uniqueOwner: string, owner: string, commentThreads: CommentThread[]): ResourceWithCommentThreads[] {\n\t\tconst resourceCommentThreads: ResourceWithCommentThreads[] = [];\n\t\tconst commentThreadsByResource = new Map<string, ResourceWithCommentThreads>();\n\t\tfor (const group of groupBy(commentThreads, CommentsModel._compareURIs)) {\n\t\t\tcommentThreadsByResource.set(group[0].resource!, new ResourceWithCommentThreads(uniqueOwner, owner, URI.parse(group[0].resource!), group));\n\t\t}\n\n\t\tcommentThreadsByResource.forEach((v, i, m) => {\n\t\t\tresourceCommentThreads.push(v);\n\t\t});\n\n\t\treturn resourceCommentThreads;\n\t}\n\n\tprivate static _compareURIs(a: CommentThread, b: CommentThread) {\n\t\tconst resourceA = a.resource!.toString();\n\t\tconst resourceB = b.resource!.toString();\n\t\tif (resourceA < resourceB) {\n\t\t\treturn -1;\n\t\t} else if (resourceA > resourceB) {\n\t\t\treturn 1;\n\t\t} else {\n\t\t\treturn 0;\n\t\t}\n\t}\n}\n"]}