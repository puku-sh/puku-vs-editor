{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/tasks/test/browser/taskTerminalStatus.test.ts","vs/workbench/contrib/tasks/test/browser/taskTerminalStatus.test.ts"],"names":[],"mappings":"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","file":"taskTerminalStatus.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ok } from 'assert';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { AccessibilitySignal, IAccessibilitySignalService } from '../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { ACTIVE_TASK_STATUS, FAILED_TASK_STATUS, SUCCEEDED_TASK_STATUS, TaskTerminalStatus } from '../../browser/taskTerminalStatus.js';\nimport { AbstractProblemCollector } from '../../common/problemCollectors.js';\nimport { CommonTask, ITaskEvent, TaskEventKind, TaskRunType } from '../../common/tasks.js';\nimport { ITaskService, Task } from '../../common/taskService.js';\nimport { ITerminalInstance } from '../../../terminal/browser/terminal.js';\nimport { ITerminalStatusList, TerminalStatusList } from '../../../terminal/browser/terminalStatusList.js';\nimport { ITerminalStatus } from '../../../terminal/common/terminal.js';\nimport { IMarker } from '../../../../../platform/markers/common/markers.js';\n\nclass TestTaskService implements Partial<ITaskService> {\n\tprivate readonly _onDidStateChange: Emitter<ITaskEvent> = new Emitter();\n\tpublic get onDidStateChange(): Event<ITaskEvent> {\n\t\treturn this._onDidStateChange.event;\n\t}\n\tpublic triggerStateChange(event: Partial<ITaskEvent>): void {\n\t\tthis._onDidStateChange.fire(event as ITaskEvent);\n\t}\n}\n\nclass TestaccessibilitySignalService implements Partial<IAccessibilitySignalService> {\n\tasync playSignal(cue: AccessibilitySignal): Promise<void> {\n\t\treturn;\n\t}\n}\n\nclass TestTerminal extends Disposable implements Partial<ITerminalInstance> {\n\tstatusList: TerminalStatusList = this._register(new TerminalStatusList(new TestConfigurationService()));\n\tconstructor() {\n\t\tsuper();\n\t}\n\toverride dispose(): void {\n\t\tsuper.dispose();\n\t}\n}\n\nclass TestTask extends CommonTask {\n\n\tconstructor() {\n\t\tsuper('test', undefined, undefined, {}, {}, { kind: '', label: '' });\n\t}\n\n\tprotected getFolderId(): string | undefined {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tprotected fromObject(object: any): Task {\n\t\tthrow new Error('Method not implemented.');\n\t}\n}\n\nclass TestProblemCollector extends Disposable implements Partial<AbstractProblemCollector> {\n\tprotected readonly _onDidFindFirstMatch = new Emitter<void>();\n\treadonly onDidFindFirstMatch = this._onDidFindFirstMatch.event;\n\tprotected readonly _onDidFindErrors = new Emitter<IMarker[]>();\n\treadonly onDidFindErrors = this._onDidFindErrors.event;\n\tprotected readonly _onDidRequestInvalidateLastMarker = new Emitter<void>();\n\treadonly onDidRequestInvalidateLastMarker = this._onDidRequestInvalidateLastMarker.event;\n}\n\nsuite('Task Terminal Status', () => {\n\tlet instantiationService: TestInstantiationService;\n\tlet taskService: TestTaskService;\n\tlet taskTerminalStatus: TaskTerminalStatus;\n\tlet testTerminal: ITerminalInstance;\n\tlet testTask: Task;\n\tlet problemCollector: AbstractProblemCollector;\n\tlet accessibilitySignalService: TestaccessibilitySignalService;\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\tsetup(() => {\n\t\tinstantiationService = store.add(new TestInstantiationService());\n\t\ttaskService = new TestTaskService();\n\t\taccessibilitySignalService = new TestaccessibilitySignalService();\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\ttaskTerminalStatus = store.add(new TaskTerminalStatus(taskService as any, accessibilitySignalService as any));\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\ttestTerminal = store.add(instantiationService.createInstance(TestTerminal) as any);\n\t\ttestTask = instantiationService.createInstance(TestTask) as unknown as Task;\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tproblemCollector = store.add(instantiationService.createInstance(TestProblemCollector) as any);\n\t});\n\ttest('Should add failed status when there is an exit code on task end', async () => {\n\t\ttaskTerminalStatus.addTerminal(testTask, testTerminal, problemCollector);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.End });\n\t\tawait poll<void>(async () => Promise.resolve(), () => testTerminal?.statusList.primary?.id === FAILED_TASK_STATUS.id, 'terminal status should be updated');\n\t});\n\ttest('Should add active status when a non-background task is run for a second time in the same terminal', () => {\n\t\ttaskTerminalStatus.addTerminal(testTask, testTerminal, problemCollector);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted, runType: TaskRunType.SingleRun });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t});\n\ttest('Should drop status when a background task exits', async () => {\n\t\ttaskTerminalStatus.addTerminal(testTask, testTerminal, problemCollector);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted, runType: TaskRunType.Background });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessEnded, exitCode: 0 });\n\t\tawait poll<void>(async () => Promise.resolve(), () => testTerminal?.statusList.statuses?.includes(SUCCEEDED_TASK_STATUS) === false, 'terminal should have dropped status');\n\t});\n\ttest('Should add succeeded status when a non-background task exits', () => {\n\t\ttaskTerminalStatus.addTerminal(testTask, testTerminal, problemCollector);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted, runType: TaskRunType.SingleRun });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessEnded, exitCode: 0 });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t});\n});\n\nfunction assertStatus(actual: ITerminalStatusList, expected: ITerminalStatus): void {\n\tok(actual.statuses.length === 1, '# of statuses');\n\tok(actual.primary?.id === expected.id, 'ID');\n\tok(actual.primary?.severity === expected.severity, 'Severity');\n}\n\nasync function poll<T>(\n\tfn: () => Thenable<T>,\n\tacceptFn: (result: T) => boolean,\n\ttimeoutMessage: string,\n\tretryCount: number = 200,\n\tretryInterval: number = 10 // millis\n): Promise<T> {\n\tlet trial = 1;\n\tlet lastError: string = '';\n\n\twhile (true) {\n\t\tif (trial > retryCount) {\n\t\t\tthrow new Error(`Timeout: ${timeoutMessage} after ${(retryCount * retryInterval) / 1000} seconds.\\r${lastError}`);\n\t\t}\n\n\t\tlet result;\n\t\ttry {\n\t\t\tresult = await fn();\n\t\t\tif (acceptFn(result)) {\n\t\t\t\treturn result;\n\t\t\t} else {\n\t\t\t\tlastError = 'Did not pass accept function';\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tlastError = Array.isArray(e.stack) ? e.stack.join('\\n') : e.stack;\n\t\t}\n\n\t\tawait new Promise(resolve => setTimeout(resolve, retryInterval));\n\t\ttrial++;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ok } from 'assert';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { AccessibilitySignal, IAccessibilitySignalService } from '../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { ACTIVE_TASK_STATUS, FAILED_TASK_STATUS, SUCCEEDED_TASK_STATUS, TaskTerminalStatus } from '../../browser/taskTerminalStatus.js';\nimport { AbstractProblemCollector } from '../../common/problemCollectors.js';\nimport { CommonTask, ITaskEvent, TaskEventKind, TaskRunType } from '../../common/tasks.js';\nimport { ITaskService, Task } from '../../common/taskService.js';\nimport { ITerminalInstance } from '../../../terminal/browser/terminal.js';\nimport { ITerminalStatusList, TerminalStatusList } from '../../../terminal/browser/terminalStatusList.js';\nimport { ITerminalStatus } from '../../../terminal/common/terminal.js';\nimport { IMarker } from '../../../../../platform/markers/common/markers.js';\n\nclass TestTaskService implements Partial<ITaskService> {\n\tprivate readonly _onDidStateChange: Emitter<ITaskEvent> = new Emitter();\n\tpublic get onDidStateChange(): Event<ITaskEvent> {\n\t\treturn this._onDidStateChange.event;\n\t}\n\tpublic triggerStateChange(event: Partial<ITaskEvent>): void {\n\t\tthis._onDidStateChange.fire(event as ITaskEvent);\n\t}\n}\n\nclass TestaccessibilitySignalService implements Partial<IAccessibilitySignalService> {\n\tasync playSignal(cue: AccessibilitySignal): Promise<void> {\n\t\treturn;\n\t}\n}\n\nclass TestTerminal extends Disposable implements Partial<ITerminalInstance> {\n\tstatusList: TerminalStatusList = this._register(new TerminalStatusList(new TestConfigurationService()));\n\tconstructor() {\n\t\tsuper();\n\t}\n\toverride dispose(): void {\n\t\tsuper.dispose();\n\t}\n}\n\nclass TestTask extends CommonTask {\n\n\tconstructor() {\n\t\tsuper('test', undefined, undefined, {}, {}, { kind: '', label: '' });\n\t}\n\n\tprotected getFolderId(): string | undefined {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\tprotected fromObject(object: any): Task {\n\t\tthrow new Error('Method not implemented.');\n\t}\n}\n\nclass TestProblemCollector extends Disposable implements Partial<AbstractProblemCollector> {\n\tprotected readonly _onDidFindFirstMatch = new Emitter<void>();\n\treadonly onDidFindFirstMatch = this._onDidFindFirstMatch.event;\n\tprotected readonly _onDidFindErrors = new Emitter<IMarker[]>();\n\treadonly onDidFindErrors = this._onDidFindErrors.event;\n\tprotected readonly _onDidRequestInvalidateLastMarker = new Emitter<void>();\n\treadonly onDidRequestInvalidateLastMarker = this._onDidRequestInvalidateLastMarker.event;\n}\n\nsuite('Task Terminal Status', () => {\n\tlet instantiationService: TestInstantiationService;\n\tlet taskService: TestTaskService;\n\tlet taskTerminalStatus: TaskTerminalStatus;\n\tlet testTerminal: ITerminalInstance;\n\tlet testTask: Task;\n\tlet problemCollector: AbstractProblemCollector;\n\tlet accessibilitySignalService: TestaccessibilitySignalService;\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\tsetup(() => {\n\t\tinstantiationService = store.add(new TestInstantiationService());\n\t\ttaskService = new TestTaskService();\n\t\taccessibilitySignalService = new TestaccessibilitySignalService();\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\ttaskTerminalStatus = store.add(new TaskTerminalStatus(taskService as any, accessibilitySignalService as any));\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\ttestTerminal = store.add(instantiationService.createInstance(TestTerminal) as any);\n\t\ttestTask = instantiationService.createInstance(TestTask) as unknown as Task;\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tproblemCollector = store.add(instantiationService.createInstance(TestProblemCollector) as any);\n\t});\n\ttest('Should add failed status when there is an exit code on task end', async () => {\n\t\ttaskTerminalStatus.addTerminal(testTask, testTerminal, problemCollector);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.End });\n\t\tawait poll<void>(async () => Promise.resolve(), () => testTerminal?.statusList.primary?.id === FAILED_TASK_STATUS.id, 'terminal status should be updated');\n\t});\n\ttest('Should add active status when a non-background task is run for a second time in the same terminal', () => {\n\t\ttaskTerminalStatus.addTerminal(testTask, testTerminal, problemCollector);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted, runType: TaskRunType.SingleRun });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t});\n\ttest('Should drop status when a background task exits', async () => {\n\t\ttaskTerminalStatus.addTerminal(testTask, testTerminal, problemCollector);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted, runType: TaskRunType.Background });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessEnded, exitCode: 0 });\n\t\tawait poll<void>(async () => Promise.resolve(), () => testTerminal?.statusList.statuses?.includes(SUCCEEDED_TASK_STATUS) === false, 'terminal should have dropped status');\n\t});\n\ttest('Should add succeeded status when a non-background task exits', () => {\n\t\ttaskTerminalStatus.addTerminal(testTask, testTerminal, problemCollector);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessStarted, runType: TaskRunType.SingleRun });\n\t\tassertStatus(testTerminal.statusList, ACTIVE_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.Inactive });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t\ttaskService.triggerStateChange({ kind: TaskEventKind.ProcessEnded, exitCode: 0 });\n\t\tassertStatus(testTerminal.statusList, SUCCEEDED_TASK_STATUS);\n\t});\n});\n\nfunction assertStatus(actual: ITerminalStatusList, expected: ITerminalStatus): void {\n\tok(actual.statuses.length === 1, '# of statuses');\n\tok(actual.primary?.id === expected.id, 'ID');\n\tok(actual.primary?.severity === expected.severity, 'Severity');\n}\n\nasync function poll<T>(\n\tfn: () => Thenable<T>,\n\tacceptFn: (result: T) => boolean,\n\ttimeoutMessage: string,\n\tretryCount: number = 200,\n\tretryInterval: number = 10 // millis\n): Promise<T> {\n\tlet trial = 1;\n\tlet lastError: string = '';\n\n\twhile (true) {\n\t\tif (trial > retryCount) {\n\t\t\tthrow new Error(`Timeout: ${timeoutMessage} after ${(retryCount * retryInterval) / 1000} seconds.\\r${lastError}`);\n\t\t}\n\n\t\tlet result;\n\t\ttry {\n\t\t\tresult = await fn();\n\t\t\tif (acceptFn(result)) {\n\t\t\t\treturn result;\n\t\t\t} else {\n\t\t\t\tlastError = 'Did not pass accept function';\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tlastError = Array.isArray(e.stack) ? e.stack.join('\\n') : e.stack;\n\t\t}\n\n\t\tawait new Promise(resolve => setTimeout(resolve, retryInterval));\n\t\ttrial++;\n\t}\n}\n"]}