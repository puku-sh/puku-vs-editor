{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/terminalContrib/accessibility/test/browser/bufferContentTracker.test.ts","vs/workbench/contrib/terminalContrib/accessibility/test/browser/bufferContentTracker.test.ts"],"names":[],"mappings":"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","file":"bufferContentTracker.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { importAMDNodeModule } from '../../../../../../amdX.js';\nimport { isWindows } from '../../../../../../base/common/platform.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { IConfigurationService } from '../../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { IContextKeyService } from '../../../../../../platform/contextkey/common/contextkey.js';\nimport { ContextMenuService } from '../../../../../../platform/contextview/browser/contextMenuService.js';\nimport { IContextMenuService } from '../../../../../../platform/contextview/browser/contextView.js';\nimport { TestInstantiationService } from '../../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { MockContextKeyService } from '../../../../../../platform/keybinding/test/common/mockKeybindingService.js';\nimport { ILayoutService } from '../../../../../../platform/layout/browser/layoutService.js';\nimport { ILoggerService, NullLogService } from '../../../../../../platform/log/common/log.js';\nimport { TerminalCapability } from '../../../../../../platform/terminal/common/capabilities/capabilities.js';\nimport { TerminalCapabilityStore } from '../../../../../../platform/terminal/common/capabilities/terminalCapabilityStore.js';\nimport { ITerminalLogService } from '../../../../../../platform/terminal/common/terminal.js';\nimport { IThemeService } from '../../../../../../platform/theme/common/themeService.js';\nimport { TestThemeService } from '../../../../../../platform/theme/test/common/testThemeService.js';\nimport { writeP } from '../../../../terminal/browser/terminalTestHelpers.js';\nimport { XtermTerminal } from '../../../../terminal/browser/xterm/xtermTerminal.js';\nimport { ITerminalConfiguration } from '../../../../terminal/common/terminal.js';\nimport { BufferContentTracker } from '../../browser/bufferContentTracker.js';\nimport { ILifecycleService } from '../../../../../services/lifecycle/common/lifecycle.js';\nimport { TestLayoutService, TestLifecycleService } from '../../../../../test/browser/workbenchTestServices.js';\nimport { TestLoggerService } from '../../../../../test/common/workbenchTestServices.js';\nimport type { Terminal } from '@xterm/xterm';\nimport { IAccessibilitySignalService } from '../../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js';\nimport { ITerminalConfigurationService } from '../../../../terminal/browser/terminal.js';\nimport { TerminalConfigurationService } from '../../../../terminal/browser/terminalConfigurationService.js';\n\nconst defaultTerminalConfig: Partial<ITerminalConfiguration> = {\n\tfontFamily: 'monospace',\n\tfontWeight: 'normal',\n\tfontWeightBold: 'normal',\n\tgpuAcceleration: 'off',\n\tscrollback: 1000,\n\tfastScrollSensitivity: 2,\n\tmouseWheelScrollSensitivity: 1,\n\tunicodeVersion: '6'\n};\n\nsuite('Buffer Content Tracker', () => {\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet instantiationService: TestInstantiationService;\n\tlet configurationService: TestConfigurationService;\n\tlet themeService: TestThemeService;\n\tlet xterm: XtermTerminal;\n\tlet capabilities: TerminalCapabilityStore;\n\tlet bufferTracker: BufferContentTracker;\n\tconst prompt = 'vscode-git:(prompt/more-tests)';\n\tconst promptPlusData = 'vscode-git:(prompt/more-tests) ' + 'some data';\n\n\tsetup(async () => {\n\t\tconfigurationService = new TestConfigurationService({ terminal: { integrated: defaultTerminalConfig } });\n\t\tinstantiationService = store.add(new TestInstantiationService());\n\t\tthemeService = new TestThemeService();\n\t\tinstantiationService.stub(IConfigurationService, configurationService);\n\t\tinstantiationService.stub(ITerminalConfigurationService, store.add(instantiationService.createInstance(TerminalConfigurationService)));\n\t\tinstantiationService.stub(IThemeService, themeService);\n\t\tinstantiationService.stub(ITerminalLogService, new NullLogService());\n\t\tinstantiationService.stub(ILoggerService, store.add(new TestLoggerService()));\n\t\tinstantiationService.stub(IContextMenuService, store.add(instantiationService.createInstance(ContextMenuService)));\n\t\tinstantiationService.stub(ILifecycleService, store.add(new TestLifecycleService()));\n\t\tinstantiationService.stub(IContextKeyService, store.add(new MockContextKeyService()));\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tinstantiationService.stub(IAccessibilitySignalService, {\n\t\t\tplaySignal: async () => { },\n\t\t\tisSoundEnabled(signal: unknown) { return false; },\n\t\t} as any);\n\n\t\tinstantiationService.stub(ILayoutService, new TestLayoutService());\n\t\tcapabilities = store.add(new TerminalCapabilityStore());\n\t\tif (!isWindows) {\n\t\t\tcapabilities.add(TerminalCapability.NaiveCwdDetection, null!);\n\t\t}\n\t\tconst TerminalCtor = (await importAMDNodeModule<typeof import('@xterm/xterm')>('@xterm/xterm', 'lib/xterm.js')).Terminal;\n\t\txterm = store.add(instantiationService.createInstance(XtermTerminal, undefined, TerminalCtor, {\n\t\t\tcols: 80,\n\t\t\trows: 30,\n\t\t\txtermColorProvider: { getBackgroundColor: () => undefined },\n\t\t\tcapabilities,\n\t\t\tdisableShellIntegrationReporting: true\n\t\t}, undefined));\n\t\tconst container = document.createElement('div');\n\t\txterm.raw.open(container);\n\t\tconfigurationService = new TestConfigurationService({ terminal: { integrated: { tabs: { separator: ' - ', title: '${cwd}', description: '${cwd}' } } } });\n\t\tbufferTracker = store.add(instantiationService.createInstance(BufferContentTracker, xterm));\n\t});\n\n\ttest('should not clear the prompt line', async () => {\n\t\tassert.strictEqual(bufferTracker.lines.length, 0);\n\t\tawait writeP(xterm.raw, prompt);\n\t\txterm.clearBuffer();\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [prompt]);\n\t});\n\ttest('repeated updates should not change the content', async () => {\n\t\tassert.strictEqual(bufferTracker.lines.length, 0);\n\t\tawait writeP(xterm.raw, prompt);\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [prompt]);\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [prompt]);\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [prompt]);\n\t});\n\ttest('should add lines in the viewport and scrollback', async () => {\n\t\tawait writeAndAssertBufferState(promptPlusData, 38, xterm.raw, bufferTracker);\n\t});\n\ttest('should add lines in the viewport and full scrollback', async () => {\n\t\tawait writeAndAssertBufferState(promptPlusData, 1030, xterm.raw, bufferTracker);\n\t});\n\ttest('should refresh viewport', async () => {\n\t\tawait writeAndAssertBufferState(promptPlusData, 6, xterm.raw, bufferTracker);\n\t\tawait writeP(xterm.raw, '\\x1b[3Ainserteddata');\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [promptPlusData, promptPlusData, `${promptPlusData}inserteddata`, promptPlusData, promptPlusData, promptPlusData]);\n\t});\n\ttest('should refresh viewport with full scrollback', async () => {\n\t\tconst content = `${prompt}\\r\\n`.repeat(1030).trimEnd();\n\t\tawait writeP(xterm.raw, content);\n\t\tbufferTracker.update();\n\t\tawait writeP(xterm.raw, '\\x1b[4Ainsertion');\n\t\tbufferTracker.update();\n\t\tconst expected = content.split('\\r\\n');\n\t\texpected[1025] = `${prompt}insertion`;\n\t\tassert.deepStrictEqual(bufferTracker.lines[1025], `${prompt}insertion`);\n\t});\n\ttest('should cap the size of the cached lines, removing old lines in favor of new lines', async () => {\n\t\tconst content = `${prompt}\\r\\n`.repeat(1036).trimEnd();\n\t\tawait writeP(xterm.raw, content);\n\t\tbufferTracker.update();\n\t\tconst expected = content.split('\\r\\n');\n\t\t// delete the 6 lines that should be trimmed\n\t\tfor (let i = 0; i < 6; i++) {\n\t\t\texpected.pop();\n\t\t}\n\t\t// insert a new character\n\t\tawait writeP(xterm.raw, '\\x1b[2Ainsertion');\n\t\tbufferTracker.update();\n\t\texpected[1027] = `${prompt}insertion`;\n\t\tassert.strictEqual(bufferTracker.lines.length, expected.length);\n\t\tassert.deepStrictEqual(bufferTracker.lines, expected);\n\t});\n});\n\nasync function writeAndAssertBufferState(data: string, rows: number, terminal: Terminal, bufferTracker: BufferContentTracker): Promise<void> {\n\tconst content = `${data}\\r\\n`.repeat(rows).trimEnd();\n\tawait writeP(terminal, content);\n\tbufferTracker.update();\n\tassert.strictEqual(bufferTracker.lines.length, rows);\n\tassert.deepStrictEqual(bufferTracker.lines, content.split('\\r\\n'));\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { importAMDNodeModule } from '../../../../../../amdX.js';\nimport { isWindows } from '../../../../../../base/common/platform.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { IConfigurationService } from '../../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { IContextKeyService } from '../../../../../../platform/contextkey/common/contextkey.js';\nimport { ContextMenuService } from '../../../../../../platform/contextview/browser/contextMenuService.js';\nimport { IContextMenuService } from '../../../../../../platform/contextview/browser/contextView.js';\nimport { TestInstantiationService } from '../../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { MockContextKeyService } from '../../../../../../platform/keybinding/test/common/mockKeybindingService.js';\nimport { ILayoutService } from '../../../../../../platform/layout/browser/layoutService.js';\nimport { ILoggerService, NullLogService } from '../../../../../../platform/log/common/log.js';\nimport { TerminalCapability } from '../../../../../../platform/terminal/common/capabilities/capabilities.js';\nimport { TerminalCapabilityStore } from '../../../../../../platform/terminal/common/capabilities/terminalCapabilityStore.js';\nimport { ITerminalLogService } from '../../../../../../platform/terminal/common/terminal.js';\nimport { IThemeService } from '../../../../../../platform/theme/common/themeService.js';\nimport { TestThemeService } from '../../../../../../platform/theme/test/common/testThemeService.js';\nimport { writeP } from '../../../../terminal/browser/terminalTestHelpers.js';\nimport { XtermTerminal } from '../../../../terminal/browser/xterm/xtermTerminal.js';\nimport { ITerminalConfiguration } from '../../../../terminal/common/terminal.js';\nimport { BufferContentTracker } from '../../browser/bufferContentTracker.js';\nimport { ILifecycleService } from '../../../../../services/lifecycle/common/lifecycle.js';\nimport { TestLayoutService, TestLifecycleService } from '../../../../../test/browser/workbenchTestServices.js';\nimport { TestLoggerService } from '../../../../../test/common/workbenchTestServices.js';\nimport type { Terminal } from '@xterm/xterm';\nimport { IAccessibilitySignalService } from '../../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js';\nimport { ITerminalConfigurationService } from '../../../../terminal/browser/terminal.js';\nimport { TerminalConfigurationService } from '../../../../terminal/browser/terminalConfigurationService.js';\n\nconst defaultTerminalConfig: Partial<ITerminalConfiguration> = {\n\tfontFamily: 'monospace',\n\tfontWeight: 'normal',\n\tfontWeightBold: 'normal',\n\tgpuAcceleration: 'off',\n\tscrollback: 1000,\n\tfastScrollSensitivity: 2,\n\tmouseWheelScrollSensitivity: 1,\n\tunicodeVersion: '6'\n};\n\nsuite('Buffer Content Tracker', () => {\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet instantiationService: TestInstantiationService;\n\tlet configurationService: TestConfigurationService;\n\tlet themeService: TestThemeService;\n\tlet xterm: XtermTerminal;\n\tlet capabilities: TerminalCapabilityStore;\n\tlet bufferTracker: BufferContentTracker;\n\tconst prompt = 'vscode-git:(prompt/more-tests)';\n\tconst promptPlusData = 'vscode-git:(prompt/more-tests) ' + 'some data';\n\n\tsetup(async () => {\n\t\tconfigurationService = new TestConfigurationService({ terminal: { integrated: defaultTerminalConfig } });\n\t\tinstantiationService = store.add(new TestInstantiationService());\n\t\tthemeService = new TestThemeService();\n\t\tinstantiationService.stub(IConfigurationService, configurationService);\n\t\tinstantiationService.stub(ITerminalConfigurationService, store.add(instantiationService.createInstance(TerminalConfigurationService)));\n\t\tinstantiationService.stub(IThemeService, themeService);\n\t\tinstantiationService.stub(ITerminalLogService, new NullLogService());\n\t\tinstantiationService.stub(ILoggerService, store.add(new TestLoggerService()));\n\t\tinstantiationService.stub(IContextMenuService, store.add(instantiationService.createInstance(ContextMenuService)));\n\t\tinstantiationService.stub(ILifecycleService, store.add(new TestLifecycleService()));\n\t\tinstantiationService.stub(IContextKeyService, store.add(new MockContextKeyService()));\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tinstantiationService.stub(IAccessibilitySignalService, {\n\t\t\tplaySignal: async () => { },\n\t\t\tisSoundEnabled(signal: unknown) { return false; },\n\t\t} as any);\n\n\t\tinstantiationService.stub(ILayoutService, new TestLayoutService());\n\t\tcapabilities = store.add(new TerminalCapabilityStore());\n\t\tif (!isWindows) {\n\t\t\tcapabilities.add(TerminalCapability.NaiveCwdDetection, null!);\n\t\t}\n\t\tconst TerminalCtor = (await importAMDNodeModule<typeof import('@xterm/xterm')>('@xterm/xterm', 'lib/xterm.js')).Terminal;\n\t\txterm = store.add(instantiationService.createInstance(XtermTerminal, undefined, TerminalCtor, {\n\t\t\tcols: 80,\n\t\t\trows: 30,\n\t\t\txtermColorProvider: { getBackgroundColor: () => undefined },\n\t\t\tcapabilities,\n\t\t\tdisableShellIntegrationReporting: true\n\t\t}, undefined));\n\t\tconst container = document.createElement('div');\n\t\txterm.raw.open(container);\n\t\tconfigurationService = new TestConfigurationService({ terminal: { integrated: { tabs: { separator: ' - ', title: '${cwd}', description: '${cwd}' } } } });\n\t\tbufferTracker = store.add(instantiationService.createInstance(BufferContentTracker, xterm));\n\t});\n\n\ttest('should not clear the prompt line', async () => {\n\t\tassert.strictEqual(bufferTracker.lines.length, 0);\n\t\tawait writeP(xterm.raw, prompt);\n\t\txterm.clearBuffer();\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [prompt]);\n\t});\n\ttest('repeated updates should not change the content', async () => {\n\t\tassert.strictEqual(bufferTracker.lines.length, 0);\n\t\tawait writeP(xterm.raw, prompt);\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [prompt]);\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [prompt]);\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [prompt]);\n\t});\n\ttest('should add lines in the viewport and scrollback', async () => {\n\t\tawait writeAndAssertBufferState(promptPlusData, 38, xterm.raw, bufferTracker);\n\t});\n\ttest('should add lines in the viewport and full scrollback', async () => {\n\t\tawait writeAndAssertBufferState(promptPlusData, 1030, xterm.raw, bufferTracker);\n\t});\n\ttest('should refresh viewport', async () => {\n\t\tawait writeAndAssertBufferState(promptPlusData, 6, xterm.raw, bufferTracker);\n\t\tawait writeP(xterm.raw, '\\x1b[3Ainserteddata');\n\t\tbufferTracker.update();\n\t\tassert.deepStrictEqual(bufferTracker.lines, [promptPlusData, promptPlusData, `${promptPlusData}inserteddata`, promptPlusData, promptPlusData, promptPlusData]);\n\t});\n\ttest('should refresh viewport with full scrollback', async () => {\n\t\tconst content = `${prompt}\\r\\n`.repeat(1030).trimEnd();\n\t\tawait writeP(xterm.raw, content);\n\t\tbufferTracker.update();\n\t\tawait writeP(xterm.raw, '\\x1b[4Ainsertion');\n\t\tbufferTracker.update();\n\t\tconst expected = content.split('\\r\\n');\n\t\texpected[1025] = `${prompt}insertion`;\n\t\tassert.deepStrictEqual(bufferTracker.lines[1025], `${prompt}insertion`);\n\t});\n\ttest('should cap the size of the cached lines, removing old lines in favor of new lines', async () => {\n\t\tconst content = `${prompt}\\r\\n`.repeat(1036).trimEnd();\n\t\tawait writeP(xterm.raw, content);\n\t\tbufferTracker.update();\n\t\tconst expected = content.split('\\r\\n');\n\t\t// delete the 6 lines that should be trimmed\n\t\tfor (let i = 0; i < 6; i++) {\n\t\t\texpected.pop();\n\t\t}\n\t\t// insert a new character\n\t\tawait writeP(xterm.raw, '\\x1b[2Ainsertion');\n\t\tbufferTracker.update();\n\t\texpected[1027] = `${prompt}insertion`;\n\t\tassert.strictEqual(bufferTracker.lines.length, expected.length);\n\t\tassert.deepStrictEqual(bufferTracker.lines, expected);\n\t});\n});\n\nasync function writeAndAssertBufferState(data: string, rows: number, terminal: Terminal, bufferTracker: BufferContentTracker): Promise<void> {\n\tconst content = `${data}\\r\\n`.repeat(rows).trimEnd();\n\tawait writeP(terminal, content);\n\tbufferTracker.update();\n\tassert.strictEqual(bufferTracker.lines.length, rows);\n\tassert.deepStrictEqual(bufferTracker.lines, content.split('\\r\\n'));\n}\n"]}