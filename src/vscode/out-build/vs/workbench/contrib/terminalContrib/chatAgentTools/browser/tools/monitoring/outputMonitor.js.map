{"version":3,"sources":["vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/monitoring/outputMonitor.ts"],"names":[],"mappings":"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","file":"outputMonitor.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { IMarker as XtermMarker } from '@xterm/xterm';\nimport { IAction } from '../../../../../../../base/common/actions.js';\nimport { timeout, type MaybePromise } from '../../../../../../../base/common/async.js';\nimport { CancellationToken } from '../../../../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../../../../base/common/event.js';\nimport { MarkdownString } from '../../../../../../../base/common/htmlContent.js';\nimport { Disposable, type IDisposable } from '../../../../../../../base/common/lifecycle.js';\nimport { isObject, isString } from '../../../../../../../base/common/types.js';\nimport { localize } from '../../../../../../../nls.js';\nimport { ExtensionIdentifier } from '../../../../../../../platform/extensions/common/extensions.js';\nimport { IChatWidgetService } from '../../../../../chat/browser/chat.js';\nimport { ChatElicitationRequestPart } from '../../../../../chat/browser/chatElicitationRequestPart.js';\nimport { ChatModel } from '../../../../../chat/common/chatModel.js';\nimport { ElicitationState, IChatService } from '../../../../../chat/common/chatService.js';\nimport { ChatAgentLocation } from '../../../../../chat/common/constants.js';\nimport { ChatMessageRole, ILanguageModelsService } from '../../../../../chat/common/languageModels.js';\nimport { IToolInvocationContext } from '../../../../../chat/common/languageModelToolsService.js';\nimport { ITaskService } from '../../../../../tasks/common/taskService.js';\nimport { ILinkLocation } from '../../taskHelpers.js';\nimport { IConfirmationPrompt, IExecution, IPollingResult, OutputMonitorState, PollingConsts } from './types.js';\nimport { getTextResponseFromStream } from './utils.js';\nimport { IConfigurationService } from '../../../../../../../platform/configuration/common/configuration.js';\nimport { TerminalChatAgentToolsSettingId } from '../../../common/terminalChatAgentToolsConfiguration.js';\nimport { ILogService } from '../../../../../../../platform/log/common/log.js';\nimport { ITerminalService } from '../../../../../terminal/browser/terminal.js';\nimport { LocalChatSessionUri } from '../../../../../chat/common/chatUri.js';\n\nexport interface IOutputMonitor extends Disposable {\n\treadonly pollingResult: IPollingResult & { pollDurationMs: number } | undefined;\n\treadonly outputMonitorTelemetryCounters: IOutputMonitorTelemetryCounters;\n\n\treadonly onDidFinishCommand: Event<void>;\n}\n\nexport interface IOutputMonitorTelemetryCounters {\n\tinputToolManualAcceptCount: number;\n\tinputToolManualRejectCount: number;\n\tinputToolManualChars: number;\n\tinputToolAutoAcceptCount: number;\n\tinputToolAutoChars: number;\n\tinputToolManualShownCount: number;\n\tinputToolFreeFormInputShownCount: number;\n\tinputToolFreeFormInputCount: number;\n}\n\nexport class OutputMonitor extends Disposable implements IOutputMonitor {\n\tprivate _state: OutputMonitorState = OutputMonitorState.PollingForIdle;\n\tget state(): OutputMonitorState { return this._state; }\n\n\tprivate _lastPromptMarker: XtermMarker | undefined;\n\n\tprivate _lastPrompt: string | undefined;\n\n\tprivate _promptPart: ChatElicitationRequestPart | undefined;\n\n\tprivate _pollingResult: IPollingResult & { pollDurationMs: number } | undefined;\n\tget pollingResult(): IPollingResult & { pollDurationMs: number } | undefined { return this._pollingResult; }\n\n\tprivate readonly _outputMonitorTelemetryCounters: IOutputMonitorTelemetryCounters = {\n\t\tinputToolManualAcceptCount: 0,\n\t\tinputToolManualRejectCount: 0,\n\t\tinputToolManualChars: 0,\n\t\tinputToolAutoAcceptCount: 0,\n\t\tinputToolAutoChars: 0,\n\t\tinputToolManualShownCount: 0,\n\t\tinputToolFreeFormInputShownCount: 0,\n\t\tinputToolFreeFormInputCount: 0,\n\t};\n\tget outputMonitorTelemetryCounters(): Readonly<IOutputMonitorTelemetryCounters> { return this._outputMonitorTelemetryCounters; }\n\n\tprivate readonly _onDidFinishCommand = this._register(new Emitter<void>());\n\treadonly onDidFinishCommand: Event<void> = this._onDidFinishCommand.event;\n\n\tconstructor(\n\t\tprivate readonly _execution: IExecution,\n\t\tprivate readonly _pollFn: ((execution: IExecution, token: CancellationToken, taskService: ITaskService) => Promise<IPollingResult | undefined>) | undefined,\n\t\tinvocationContext: IToolInvocationContext | undefined,\n\t\ttoken: CancellationToken,\n\t\tcommand: string,\n\t\t@ILanguageModelsService private readonly _languageModelsService: ILanguageModelsService,\n\t\t@ITaskService private readonly _taskService: ITaskService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t\t@IChatWidgetService private readonly _chatWidgetService: IChatWidgetService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@ITerminalService private readonly _terminalService: ITerminalService,\n\t) {\n\t\tsuper();\n\n\t\t// Start async to ensure listeners are set up\n\t\ttimeout(0).then(() => {\n\t\t\tthis._startMonitoring(command, invocationContext, token);\n\t\t});\n\t}\n\n\tprivate async _startMonitoring(\n\t\tcommand: string,\n\t\tinvocationContext: IToolInvocationContext | undefined,\n\t\ttoken: CancellationToken\n\t): Promise<void> {\n\t\tconst pollStartTime = Date.now();\n\n\t\tlet modelOutputEvalResponse;\n\t\tlet resources;\n\t\tlet output;\n\n\t\tlet extended = false;\n\t\ttry {\n\t\t\twhile (!token.isCancellationRequested) {\n\t\t\t\tswitch (this._state) {\n\t\t\t\t\tcase OutputMonitorState.PollingForIdle: {\n\t\t\t\t\t\tthis._state = await this._waitForIdle(this._execution, extended, token);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tcase OutputMonitorState.Timeout: {\n\t\t\t\t\t\tconst shouldContinuePolling = await this._handleTimeoutState(command, invocationContext, extended, token);\n\t\t\t\t\t\tif (shouldContinuePolling) {\n\t\t\t\t\t\t\textended = true;\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis._promptPart?.hide();\n\t\t\t\t\t\t\tthis._promptPart = undefined;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tcase OutputMonitorState.Cancelled:\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase OutputMonitorState.Idle: {\n\t\t\t\t\t\tconst idleResult = await this._handleIdleState(token);\n\t\t\t\t\t\tif (idleResult.shouldContinuePollling) {\n\t\t\t\t\t\t\tthis._state = OutputMonitorState.PollingForIdle;\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tresources = idleResult.resources;\n\t\t\t\t\t\t\tmodelOutputEvalResponse = idleResult.modelOutputEvalResponse;\n\t\t\t\t\t\t\toutput = idleResult.output;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (this._state === OutputMonitorState.Idle || this._state === OutputMonitorState.Cancelled || this._state === OutputMonitorState.Timeout) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\tthis._state = OutputMonitorState.Cancelled;\n\t\t\t}\n\t\t} finally {\n\t\t\tthis._pollingResult = {\n\t\t\t\tstate: this._state,\n\t\t\t\toutput: output ?? this._execution.getOutput(),\n\t\t\t\tmodelOutputEvalResponse: token.isCancellationRequested ? 'Cancelled' : modelOutputEvalResponse,\n\t\t\t\tpollDurationMs: Date.now() - pollStartTime,\n\t\t\t\tresources\n\t\t\t};\n\t\t\tthis._promptPart?.hide();\n\t\t\tthis._promptPart = undefined;\n\t\t\tthis._onDidFinishCommand.fire();\n\t\t}\n\t}\n\n\n\tprivate async _handleIdleState(token: CancellationToken): Promise<{ resources?: ILinkLocation[]; modelOutputEvalResponse?: string; shouldContinuePollling: boolean; output?: string }> {\n\t\tconst confirmationPrompt = await this._determineUserInputOptions(this._execution, token);\n\n\t\tif (confirmationPrompt?.detectedRequestForFreeFormInput) {\n\t\t\tthis._outputMonitorTelemetryCounters.inputToolFreeFormInputShownCount++;\n\t\t\tconst receivedTerminalInput = await this._requestFreeFormTerminalInput(token, this._execution, confirmationPrompt);\n\t\t\tif (receivedTerminalInput) {\n\t\t\t\t// Small delay to ensure input is processed\n\t\t\t\tawait timeout(200);\n\t\t\t\t// Continue polling as we sent the input\n\t\t\t\treturn { shouldContinuePollling: true };\n\t\t\t} else {\n\t\t\t\t// User declined\n\t\t\t\treturn { shouldContinuePollling: false };\n\t\t\t}\n\t\t}\n\n\t\tif (confirmationPrompt?.options.length) {\n\t\t\tconst suggestedOptionResult = await this._selectAndHandleOption(confirmationPrompt, token);\n\t\t\tif (suggestedOptionResult?.sentToTerminal) {\n\t\t\t\t// Continue polling as we sent the input\n\t\t\t\treturn { shouldContinuePollling: true };\n\t\t\t}\n\t\t\tconst confirmed = await this._confirmRunInTerminal(token, suggestedOptionResult?.suggestedOption ?? confirmationPrompt.options[0], this._execution, confirmationPrompt);\n\t\t\tif (confirmed) {\n\t\t\t\t// Continue polling as we sent the input\n\t\t\t\treturn { shouldContinuePollling: true };\n\t\t\t} else {\n\t\t\t\t// User declined\n\t\t\t\tthis._execution.instance.focus(true);\n\t\t\t\treturn { shouldContinuePollling: false };\n\t\t\t}\n\t\t}\n\n\t\t// Let custom poller override if provided\n\t\tconst custom = await this._pollFn?.(this._execution, token, this._taskService);\n\t\tconst resources = custom?.resources;\n\t\tconst modelOutputEvalResponse = await this._assessOutputForErrors(this._execution.getOutput(), token);\n\t\treturn { resources, modelOutputEvalResponse, shouldContinuePollling: false, output: custom?.output };\n\t}\n\n\tprivate async _handleTimeoutState(command: string, invocationContext: IToolInvocationContext | undefined, extended: boolean, token: CancellationToken): Promise<boolean> {\n\t\tlet continuePollingPart: ChatElicitationRequestPart | undefined;\n\t\tif (extended) {\n\t\t\tthis._state = OutputMonitorState.Cancelled;\n\t\t\treturn false;\n\t\t}\n\t\textended = true;\n\n\t\tconst { promise: p, part } = await this._promptForMorePolling(command, token, invocationContext);\n\t\tlet continuePollingDecisionP: Promise<boolean> | undefined = p;\n\t\tcontinuePollingPart = part;\n\n\t\t// Start another polling pass and race it against the user's decision\n\t\tconst nextPollP = this._waitForIdle(this._execution, extended, token)\n\t\t\t.catch((): IPollingResult => ({\n\t\t\t\tstate: OutputMonitorState.Cancelled,\n\t\t\t\toutput: this._execution.getOutput(),\n\t\t\t\tmodelOutputEvalResponse: 'Cancelled'\n\t\t\t}));\n\n\t\tconst race = await Promise.race([\n\t\t\tcontinuePollingDecisionP.then(v => ({ kind: 'decision' as const, v })),\n\t\t\tnextPollP.then(r => ({ kind: 'poll' as const, r }))\n\t\t]);\n\n\t\tif (race.kind === 'decision') {\n\t\t\ttry { continuePollingPart?.hide(); } catch { /* noop */ }\n\t\t\tcontinuePollingPart = undefined;\n\n\t\t\t// User explicitly declined to keep waiting, so finish with the timed-out result\n\t\t\tif (race.v === false) {\n\t\t\t\tthis._state = OutputMonitorState.Cancelled;\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// User accepted; keep polling (the loop iterates again).\n\t\t\t// Clear the decision so we don't race on a resolved promise.\n\t\t\tcontinuePollingDecisionP = undefined;\n\t\t\treturn true;\n\t\t} else {\n\t\t\t// A background poll completed while waiting for a decision\n\t\t\tconst r = race.r;\n\n\t\t\tif (r === OutputMonitorState.Idle || r === OutputMonitorState.Cancelled || r === OutputMonitorState.Timeout) {\n\t\t\t\ttry { continuePollingPart?.hide(); } catch { /* noop */ }\n\t\t\t\tcontinuePollingPart = undefined;\n\t\t\t\tcontinuePollingDecisionP = undefined;\n\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// Still timing out; loop and race again with the same prompt.\n\t\t\treturn true;\n\t\t}\n\t}\n\n\t/**\n\t * Single bounded polling pass that returns when:\n\t *  - terminal becomes inactive/idle, or\n\t *  - timeout window elapses.\n\t */\n\tprivate async _waitForIdle(\n\t\texecution: IExecution,\n\t\textendedPolling: boolean,\n\t\ttoken: CancellationToken,\n\t): Promise<OutputMonitorState> {\n\n\t\tconst maxWaitMs = extendedPolling ? PollingConsts.ExtendedPollingMaxDuration : PollingConsts.FirstPollingMaxDuration;\n\t\tconst maxInterval = PollingConsts.MaxPollingIntervalDuration;\n\t\tlet currentInterval = PollingConsts.MinPollingDuration;\n\t\tlet waited = 0;\n\t\tlet consecutiveIdleEvents = 0;\n\t\tlet hasReceivedData = false;\n\t\tconst onDataDisposable = execution.instance.onData((_data) => {\n\t\t\thasReceivedData = true;\n\t\t});\n\n\t\ttry {\n\t\t\twhile (!token.isCancellationRequested && waited < maxWaitMs) {\n\t\t\t\tconst waitTime = Math.min(currentInterval, maxWaitMs - waited);\n\t\t\t\tawait timeout(waitTime, token);\n\t\t\t\twaited += waitTime;\n\t\t\t\tcurrentInterval = Math.min(currentInterval * 2, maxInterval);\n\t\t\t\tconst currentOutput = execution.getOutput();\n\t\t\t\tconst promptResult = detectsInputRequiredPattern(currentOutput);\n\t\t\t\tif (promptResult) {\n\t\t\t\t\tthis._state = OutputMonitorState.Idle;\n\t\t\t\t\treturn this._state;\n\t\t\t\t}\n\n\t\t\t\tif (hasReceivedData) {\n\t\t\t\t\tconsecutiveIdleEvents = 0;\n\t\t\t\t\thasReceivedData = false;\n\t\t\t\t} else {\n\t\t\t\t\tconsecutiveIdleEvents++;\n\t\t\t\t}\n\n\t\t\t\tconst recentlyIdle = consecutiveIdleEvents >= PollingConsts.MinIdleEvents;\n\t\t\t\tconst isActive = execution.isActive ? await execution.isActive() : undefined;\n\t\t\t\tthis._logService.trace(`OutputMonitor: waitForIdle check: waited=${waited}ms, recentlyIdle=${recentlyIdle}, isActive=${isActive}`);\n\t\t\t\tif (recentlyIdle && isActive !== true) {\n\t\t\t\t\tthis._state = OutputMonitorState.Idle;\n\t\t\t\t\treturn this._state;\n\t\t\t\t}\n\t\t\t}\n\t\t} finally {\n\t\t\tonDataDisposable.dispose();\n\t\t}\n\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn OutputMonitorState.Cancelled;\n\t\t}\n\n\t\treturn OutputMonitorState.Timeout;\n\t}\n\n\tprivate async _promptForMorePolling(command: string, token: CancellationToken, context: IToolInvocationContext | undefined): Promise<{ promise: Promise<boolean>; part?: ChatElicitationRequestPart }> {\n\t\tif (token.isCancellationRequested || this._state === OutputMonitorState.Cancelled) {\n\t\t\treturn { promise: Promise.resolve(false) };\n\t\t}\n\t\tconst result = this._createElicitationPart<boolean>(\n\t\t\ttoken,\n\t\t\tcontext?.sessionId,\n\t\t\tnew MarkdownString(localize('poll.terminal.waiting', \"Continue waiting for `{0}`?\", command)),\n\t\t\tnew MarkdownString(localize('poll.terminal.polling', \"This will continue to poll for output to determine when the terminal becomes idle for up to 2 minutes.\")),\n\t\t\t'',\n\t\t\tlocalize('poll.terminal.accept', 'Yes'),\n\t\t\tlocalize('poll.terminal.reject', 'No'),\n\t\t\tasync () => true,\n\t\t\tasync () => { this._state = OutputMonitorState.Cancelled; return false; }\n\t\t);\n\n\t\treturn { promise: result.promise.then(p => p ?? false), part: result.part };\n\t}\n\n\n\n\tprivate async _assessOutputForErrors(buffer: string, token: CancellationToken): Promise<string | undefined> {\n\t\tconst model = await this._getLanguageModel();\n\t\tif (!model) {\n\t\t\treturn 'No models available';\n\t\t}\n\n\t\tconst response = await this._languageModelsService.sendChatRequest(\n\t\t\tmodel,\n\t\t\tnew ExtensionIdentifier('core'),\n\t\t\t[{ role: ChatMessageRole.User, content: [{ type: 'text', value: `Evaluate this terminal output to determine if there were errors. If there are errors, return them. Otherwise, return undefined: ${buffer}.` }] }],\n\t\t\t{},\n\t\t\ttoken\n\t\t);\n\n\t\ttry {\n\t\t\tconst responseFromStream = getTextResponseFromStream(response);\n\t\t\tawait Promise.all([response.result, responseFromStream]);\n\t\t\treturn await responseFromStream;\n\t\t} catch (err) {\n\t\t\treturn 'Error occurred ' + err;\n\t\t}\n\t}\n\n\tprivate async _determineUserInputOptions(execution: IExecution, token: CancellationToken): Promise<IConfirmationPrompt | undefined> {\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn;\n\t\t}\n\t\tconst model = await this._getLanguageModel();\n\t\tif (!model) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst lastLines = execution.getOutput(this._lastPromptMarker).trimEnd().split('\\n').slice(-15).join('\\n');\n\t\tconst promptText =\n\t\t\t`Analyze the following terminal output. If it contains a prompt requesting user input (such as a confirmation, selection, or yes/no question) and that prompt has NOT already been answered, extract the prompt text. The prompt may ask to choose from a set. If so, extract the possible options as a JSON object with keys 'prompt', 'options' (an array of strings or an object with option to description mappings), and 'freeFormInput': false. If no options are provided, and free form input is requested, for example: Password:, return the word freeFormInput. For example, if the options are \"[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [C] Cancel\", the option to description mappings would be {\"Y\": \"Yes\", \"A\": \"Yes to All\", \"N\": \"No\", \"L\": \"No to All\", \"C\": \"Cancel\"}. If there is no such prompt, return null. If the option is ambiguous, return null.\n\t\t\tExamples:\n\t\t\t1. Output: \"Do you want to overwrite? (y/n)\"\n\t\t\t\tResponse: {\"prompt\": \"Do you want to overwrite?\", \"options\": [\"y\", \"n\"], \"freeFormInput\": false}\n\n\t\t\t2. Output: \"Confirm: [Y] Yes  [A] Yes to All  [N] No  [L] No to All  [C] Cancel\"\n\t\t\t\tResponse: {\"prompt\": \"Confirm\", \"options\": [\"Y\", \"A\", \"N\", \"L\", \"C\"], \"freeFormInput\": false}\n\n\t\t\t3. Output: \"Accept license terms? (yes/no)\"\n\t\t\t\tResponse: {\"prompt\": \"Accept license terms?\", \"options\": [\"yes\", \"no\"], \"freeFormInput\": false}\n\n\t\t\t4. Output: \"Press Enter to continue\"\n\t\t\t\tResponse: {\"prompt\": \"Press Enter to continue\", \"options\": [\"Enter\"], \"freeFormInput\": false}\n\n\t\t\t5. Output: \"Type Yes to proceed\"\n\t\t\t\tResponse: {\"prompt\": \"Type Yes to proceed\", \"options\": [\"Yes\"], \"freeFormInput\": false}\n\n\t\t\t6. Output: \"Continue [y/N]\"\n\t\t\t\tResponse: {\"prompt\": \"Continue\", \"options\": [\"y\", \"N\"], \"freeFormInput\": false}\n\n\t\t\t7. Output: \"Press any key to close the terminal.\"\n\t\t\t\tResponse: {\"prompt\": \"Press any key to continue...\", \"options\": [\"a\"], \"freeFormInput\": false}\n\n\t\t\t8. Output: \"Terminal will be reused by tasks, press any key to close it.\"\n\t\t\t\tResponse: {\"prompt\": \"Terminal will be reused by tasks, press any key to close it.\", \"options\": [\"a\"], \"freeFormInput\": false}\n\n\t\t\t9. Output: \"Password:\"\n\t\t\t\tResponse: {\"prompt\": \"Password:\", \"freeFormInput\": true, \"options\": []}\n\t\t\t10. Output: \"press ctrl-c to detach, ctrl-d to kill\"\n\t\t\t\tResponse: null\n\n\t\t\tAlternatively, the prompt may request free form input, for example:\n\t\t\t1. Output: \"Enter your username:\"\n\t\t\t\tResponse: {\"prompt\": \"Enter your username:\", \"freeFormInput\": true, \"options\": []}\n\t\t\t2. Output: \"Password:\"\n\t\t\t\tResponse: {\"prompt\": \"Password:\", \"freeFormInput\": true, \"options\": []}\n\t\t\tNow, analyze this output:\n\t\t\t${lastLines}\n\t\t\t`;\n\n\t\tconst response = await this._languageModelsService.sendChatRequest(model, new ExtensionIdentifier('core'), [{ role: ChatMessageRole.User, content: [{ type: 'text', value: promptText }] }], {}, token);\n\t\tconst responseText = await getTextResponseFromStream(response);\n\t\ttry {\n\t\t\tconst match = responseText.match(/\\{[\\s\\S]*\\}/);\n\t\t\tif (match) {\n\t\t\t\tconst obj = JSON.parse(match[0]) as unknown;\n\t\t\t\tif (\n\t\t\t\t\tisObject(obj) &&\n\t\t\t\t\t'prompt' in obj && isString(obj.prompt) &&\n\t\t\t\t\t'options' in obj &&\n\t\t\t\t\t'options' in obj &&\n\t\t\t\t\t'freeFormInput' in obj && typeof obj.freeFormInput === 'boolean'\n\t\t\t\t) {\n\t\t\t\t\tif (this._lastPrompt === obj.prompt) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (obj.freeFormInput === true) {\n\t\t\t\t\t\treturn { prompt: obj.prompt, options: [], detectedRequestForFreeFormInput: true };\n\t\t\t\t\t}\n\t\t\t\t\tif (Array.isArray(obj.options) && obj.options.every(isString)) {\n\t\t\t\t\t\treturn { prompt: obj.prompt, options: obj.options, detectedRequestForFreeFormInput: obj.freeFormInput };\n\t\t\t\t\t} else if (isObject(obj.options) && Object.values(obj.options).every(isString)) {\n\t\t\t\t\t\tconst keys = Object.keys(obj.options);\n\t\t\t\t\t\tif (keys.length === 0) {\n\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst descriptions = keys.map(key => (obj.options as Record<string, string>)[key]);\n\t\t\t\t\t\treturn { prompt: obj.prompt, options: keys, descriptions, detectedRequestForFreeFormInput: obj.freeFormInput };\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tconsole.error('Failed to parse confirmation prompt from language model response:', err);\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprivate async _selectAndHandleOption(\n\t\tconfirmationPrompt: IConfirmationPrompt | undefined,\n\t\ttoken: CancellationToken,\n\t): Promise<ISuggestedOptionResult | undefined> {\n\t\tif (!confirmationPrompt?.options.length) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst model = this._chatWidgetService.getWidgetsByLocations(ChatAgentLocation.Chat)[0]?.input.currentLanguageModel;\n\t\tif (!model) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst models = await this._languageModelsService.selectLanguageModels({ vendor: 'copilot', family: model.replaceAll('copilot/', '') });\n\t\tif (!models.length) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst prompt = confirmationPrompt.prompt;\n\t\tconst options = confirmationPrompt.options;\n\n\t\tconst currentMarker = this._execution.instance.registerMarker();\n\t\tif (!currentMarker) {\n\t\t\t// Unable to register marker, so cannot track prompt location\n\t\t\treturn undefined;\n\t\t}\n\n\t\tthis._lastPromptMarker = currentMarker;\n\t\tthis._lastPrompt = prompt;\n\n\t\tconst promptText = `Given the following confirmation prompt and options from a terminal output, which option is the default?\\nPrompt: \"${prompt}\"\\nOptions: ${JSON.stringify(options)}\\nRespond with only the option string.`;\n\t\tconst response = await this._languageModelsService.sendChatRequest(models[0], new ExtensionIdentifier('core'), [\n\t\t\t{ role: ChatMessageRole.User, content: [{ type: 'text', value: promptText }] }\n\t\t], {}, token);\n\n\t\tconst suggestedOption = (await getTextResponseFromStream(response)).trim();\n\t\tif (!suggestedOption) {\n\t\t\treturn;\n\t\t}\n\t\tconst parsed = suggestedOption.replace(/['\"`]/g, '').trim();\n\t\tconst index = confirmationPrompt.options.indexOf(parsed);\n\t\tconst validOption = confirmationPrompt.options.find(opt => parsed === 'any key' || parsed === opt.replace(/['\"`]/g, '').trim());\n\t\tif (!validOption || index === -1) {\n\t\t\treturn;\n\t\t}\n\t\tlet sentToTerminal = false;\n\t\tif (this._configurationService.getValue(TerminalChatAgentToolsSettingId.AutoReplyToPrompts)) {\n\t\t\tawait this._execution.instance.sendText(validOption, true);\n\t\t\tthis._outputMonitorTelemetryCounters.inputToolAutoAcceptCount++;\n\t\t\tthis._outputMonitorTelemetryCounters.inputToolAutoChars += validOption?.length || 0;\n\t\t\tsentToTerminal = true;\n\t\t}\n\t\tconst description = confirmationPrompt.descriptions?.[index];\n\t\treturn description ? { suggestedOption: { description, option: validOption }, sentToTerminal } : { suggestedOption: validOption, sentToTerminal };\n\t}\n\n\tprivate async _requestFreeFormTerminalInput(token: CancellationToken, execution: IExecution, confirmationPrompt: IConfirmationPrompt): Promise<boolean> {\n\t\tconst focusTerminalSelection = Symbol('focusTerminalSelection');\n\t\tconst { promise: userPrompt, part } = this._createElicitationPart<boolean | typeof focusTerminalSelection>(\n\t\t\ttoken,\n\t\t\texecution.sessionId,\n\t\t\tnew MarkdownString(localize('poll.terminal.inputRequest', \"The terminal is awaiting input.\")),\n\t\t\tnew MarkdownString(localize('poll.terminal.requireInput', \"{0}\\nPlease provide the required input to the terminal.\\n\\n\", confirmationPrompt.prompt)),\n\t\t\t'',\n\t\t\tlocalize('poll.terminal.enterInput', 'Focus terminal'),\n\t\t\tundefined,\n\t\t\t() => {\n\t\t\t\tthis._showInstance(execution.instance.instanceId);\n\t\t\t\treturn focusTerminalSelection;\n\t\t\t}\n\t\t);\n\n\t\tlet inputDataDisposable: IDisposable = Disposable.None;\n\t\tconst inputPromise = new Promise<boolean>(resolve => {\n\t\t\tinputDataDisposable = this._register(execution.instance.onDidInputData((data) => {\n\t\t\t\tif (!data || data === '\\r' || data === '\\n' || data === '\\r\\n') {\n\t\t\t\t\tpart.hide();\n\t\t\t\t\tinputDataDisposable.dispose();\n\t\t\t\t\tthis._state = OutputMonitorState.PollingForIdle;\n\t\t\t\t\tthis._outputMonitorTelemetryCounters.inputToolFreeFormInputCount++;\n\t\t\t\t\tresolve(true);\n\t\t\t\t}\n\t\t\t}));\n\t\t});\n\n\t\tconst result = await Promise.race([userPrompt, inputPromise]);\n\t\tif (result === focusTerminalSelection) {\n\t\t\treturn await inputPromise;\n\t\t}\n\t\tif (result === undefined) {\n\t\t\tinputDataDisposable.dispose();\n\t\t\t// Prompt was dismissed without providing input\n\t\t\treturn false;\n\t\t}\n\t\treturn !!result;\n\t}\n\n\tprivate async _confirmRunInTerminal(token: CancellationToken, suggestedOption: SuggestedOption, execution: IExecution, confirmationPrompt: IConfirmationPrompt): Promise<string | boolean | undefined> {\n\t\tlet suggestedOptionValue = isString(suggestedOption) ? suggestedOption : suggestedOption.option;\n\t\tif (suggestedOptionValue === 'any key') {\n\t\t\tsuggestedOptionValue = 'a';\n\t\t}\n\t\tconst focusTerminalSelection = Symbol('focusTerminalSelection');\n\t\tlet inputDataDisposable: IDisposable = Disposable.None;\n\t\tconst { promise: userPrompt, part } = this._createElicitationPart<string | boolean | typeof focusTerminalSelection | undefined>(\n\t\t\ttoken,\n\t\t\texecution.sessionId,\n\t\t\tnew MarkdownString(localize('poll.terminal.confirmRequired', \"The terminal is awaiting input.\")),\n\t\t\tnew MarkdownString(localize('poll.terminal.confirmRunDetail', \"{0}\\n Do you want to send `{1}`{2} followed by `Enter` to the terminal?\", confirmationPrompt.prompt, suggestedOptionValue, isString(suggestedOption) ? '' : suggestedOption.description ? ' (' + suggestedOption.description + ')' : '')),\n\t\t\t'',\n\t\t\tlocalize('poll.terminal.acceptRun', 'Allow'),\n\t\t\tlocalize('poll.terminal.rejectRun', 'Focus Terminal'),\n\t\t\tasync (value: IAction | true) => {\n\t\t\t\tlet option: string | undefined = undefined;\n\t\t\t\tif (value === true) {\n\t\t\t\t\toption = suggestedOptionValue;\n\t\t\t\t} else if (typeof value === 'object' && 'label' in value) {\n\t\t\t\t\toption = value.label.split(' (')[0];\n\t\t\t\t}\n\t\t\t\tthis._outputMonitorTelemetryCounters.inputToolManualAcceptCount++;\n\t\t\t\tthis._outputMonitorTelemetryCounters.inputToolManualChars += option?.length || 0;\n\t\t\t\treturn option;\n\t\t\t},\n\t\t\t() => {\n\t\t\t\tthis._showInstance(execution.instance.instanceId);\n\t\t\t\tthis._outputMonitorTelemetryCounters.inputToolManualRejectCount++;\n\t\t\t\treturn focusTerminalSelection;\n\t\t\t},\n\t\t\tgetMoreActions(suggestedOption, confirmationPrompt)\n\t\t);\n\t\tconst inputPromise = new Promise<boolean>(resolve => {\n\t\t\tinputDataDisposable = this._register(execution.instance.onDidInputData(() => {\n\t\t\t\tpart.hide();\n\t\t\t\tinputDataDisposable.dispose();\n\t\t\t\tthis._state = OutputMonitorState.PollingForIdle;\n\t\t\t\tresolve(true);\n\t\t\t}));\n\t\t});\n\n\t\tconst optionToRun = await Promise.race([userPrompt, inputPromise]);\n\t\tif (optionToRun === focusTerminalSelection) {\n\t\t\treturn await inputPromise;\n\t\t}\n\t\tif (optionToRun === true) {\n\t\t\treturn true;\n\t\t}\n\t\tif (typeof optionToRun === 'string' && optionToRun.length) {\n\t\t\tinputDataDisposable.dispose();\n\t\t\tawait execution.instance.sendText(optionToRun, true);\n\t\t\treturn optionToRun;\n\t\t}\n\t\tinputDataDisposable.dispose();\n\t\treturn optionToRun;\n\t}\n\n\tprivate _showInstance(instanceId?: number): void {\n\t\tif (!instanceId) {\n\t\t\treturn;\n\t\t}\n\t\tconst instance = this._terminalService.getInstanceFromId(instanceId);\n\t\tif (!instance) {\n\t\t\treturn;\n\t\t}\n\t\tthis._terminalService.setActiveInstance(instance);\n\t\tthis._terminalService.revealActiveTerminal(true);\n\t}\n\t// Helper to create, register, and wire a ChatElicitationRequestPart. Returns the promise that\n\t// resolves when the part is accepted/rejected and the registered part itself so callers can\n\t// attach additional listeners (e.g., onDidRequestHide) or compose with other promises.\n\tprivate _createElicitationPart<T>(\n\t\ttoken: CancellationToken,\n\t\tsessionId: string | undefined,\n\t\ttitle: MarkdownString,\n\t\tdetail: MarkdownString,\n\t\tsubtitle: string,\n\t\tacceptLabel: string,\n\t\trejectLabel?: string,\n\t\tonAccept?: (value: IAction | true) => MaybePromise<T | undefined>,\n\t\tonReject?: () => MaybePromise<T | undefined>,\n\t\tmoreActions?: IAction[] | undefined\n\t): { promise: Promise<T | undefined>; part: ChatElicitationRequestPart } {\n\t\tconst chatModel = sessionId && this._chatService.getSession(LocalChatSessionUri.forSession(sessionId));\n\t\tif (!(chatModel instanceof ChatModel)) {\n\t\t\tthrow new Error('No model');\n\t\t}\n\t\tconst request = chatModel.getRequests().at(-1);\n\t\tif (!request) {\n\t\t\tthrow new Error('No request');\n\t\t}\n\t\tlet part!: ChatElicitationRequestPart;\n\t\tconst promise = new Promise<T | undefined>(resolve => {\n\t\t\tconst thePart = part = this._register(new ChatElicitationRequestPart(\n\t\t\t\ttitle,\n\t\t\t\tdetail,\n\t\t\t\tsubtitle,\n\t\t\t\tacceptLabel,\n\t\t\t\trejectLabel,\n\t\t\t\tasync (value: IAction | true) => {\n\t\t\t\t\tthePart.hide();\n\t\t\t\t\tthis._promptPart = undefined;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst r = await (onAccept ? onAccept(value) : undefined);\n\t\t\t\t\t\tresolve(r as T | undefined);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tresolve(undefined);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ElicitationState.Accepted;\n\t\t\t\t},\n\t\t\t\tasync () => {\n\t\t\t\t\tthePart.hide();\n\t\t\t\t\tthis._promptPart = undefined;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst r = await (onReject ? onReject() : undefined);\n\t\t\t\t\t\tresolve(r as T | undefined);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tresolve(undefined);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ElicitationState.Rejected;\n\t\t\t\t},\n\t\t\t\tundefined, // source\n\t\t\t\tmoreActions,\n\t\t\t\t() => this._outputMonitorTelemetryCounters.inputToolManualShownCount++\n\t\t\t));\n\n\t\t\tchatModel.acceptResponseProgress(request, thePart);\n\t\t\tthis._promptPart = thePart;\n\t\t});\n\n\t\tthis._register(token.onCancellationRequested(() => part.hide()));\n\n\t\treturn { promise, part };\n\t}\n\n\tprivate async _getLanguageModel(): Promise<string | undefined> {\n\t\tlet models = await this._languageModelsService.selectLanguageModels({ vendor: 'copilot', id: 'copilot-fast' });\n\n\t\t// Fallback to gpt-4o-mini if copilot-fast is not available for backwards compatibility\n\t\tif (!models.length) {\n\t\t\tmodels = await this._languageModelsService.selectLanguageModels({ vendor: 'copilot', family: 'gpt-4o-mini' });\n\t\t}\n\n\t\treturn models.length ? models[0] : undefined;\n\t}\n}\n\nfunction getMoreActions(suggestedOption: SuggestedOption, confirmationPrompt: IConfirmationPrompt): IAction[] | undefined {\n\tconst moreActions: IAction[] = [];\n\tconst moreOptions = confirmationPrompt.options.filter(a => a !== (isString(suggestedOption) ? suggestedOption : suggestedOption.option));\n\tlet i = 0;\n\tfor (const option of moreOptions) {\n\t\tconst label = option + (confirmationPrompt.descriptions ? ' (' + confirmationPrompt.descriptions[i] + ')' : '');\n\t\tconst action = {\n\t\t\tlabel,\n\t\t\ttooltip: label,\n\t\t\tid: `terminal.poll.send.${option}`,\n\t\t\tclass: undefined,\n\t\t\tenabled: true,\n\t\t\trun: async () => { }\n\t\t};\n\t\ti++;\n\t\tmoreActions.push(action);\n\t}\n\treturn moreActions.length ? moreActions : undefined;\n}\n\ntype SuggestedOption = string | { description: string; option: string };\ninterface ISuggestedOptionResult {\n\tsuggestedOption?: SuggestedOption;\n\tsentToTerminal?: boolean;\n}\n\nexport function detectsInputRequiredPattern(cursorLine: string): boolean {\n\treturn [\n\t\t// PowerShell-style multi-option line (supports [?] Help and optional default suffix) ending\n\t\t// in whitespace\n\t\t/\\s*(?:\\[[^\\]]\\]\\s+[^\\[]+\\s*)+(?:\\(default is\\s+\"[^\"]+\"\\):)?\\s+$/,\n\t\t// Bracketed/parenthesized yes/no pairs at end of line: (y/n), [Y/n], (yes/no), [no/yes]\n\t\t/(?:\\(|\\[)\\s*(?:y(?:es)?\\s*\\/\\s*n(?:o)?|n(?:o)?\\s*\\/\\s*y(?:es)?)\\s*(?:\\]|\\))\\s+$/i,\n\t\t// Same as above but allows a preceding '?' or ':' and optional wrappers e.g.\n\t\t// \"Continue? (y/n)\" or \"Overwrite: [yes/no]\"\n\t\t/[?:]\\s*(?:\\(|\\[)?\\s*y(?:es)?\\s*\\/\\s*n(?:o)?\\s*(?:\\]|\\))?\\s+$/i,\n\t\t// Confirmation prompts ending with (y) e.g. \"Ok to proceed? (y)\"\n\t\t/\\(y\\)\\s*$/i,\n\t\t// Line ends with ':'\n\t\t/:\\s*$/,\n\t\t// Line contains (END) which is common in pagers\n\t\t/\\(END\\)$/,\n\t\t// Password prompt\n\t\t/password[:]?$/i,\n\t\t// Line ends with '?'\n\t\t/\\?\\s*(?:\\([a-z\\s]+\\))?$/i,\n\t\t// \"Press a key\" or \"Press any key\"\n\t\t/press a(?:ny)? key/i,\n\t].some(e => e.test(cursorLine));\n}\n"]}