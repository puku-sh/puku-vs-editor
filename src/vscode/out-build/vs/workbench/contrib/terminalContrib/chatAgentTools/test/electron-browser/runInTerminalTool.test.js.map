{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/terminalContrib/chatAgentTools/test/electron-browser/runInTerminalTool.test.ts","vs/workbench/contrib/terminalContrib/chatAgentTools/test/electron-browser/runInTerminalTool.test.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,EAAE,EAAE,EAAE,WAAW,EAAE,MAAM,QAAQ,CAAC;AACzC,OAAO,EAAE,SAAS,EAAE,MAAM,0CAA0C,CAAC;AACrE,OAAO,EAAE,iBAAiB,EAAE,MAAM,+CAA+C,CAAC;AAClF,OAAO,EAAE,OAAO,EAAE,MAAM,wCAAwC,CAAC;AACjE,OAAO,EAAE,OAAO,EAAE,MAAM,0CAA0C,CAAC;AACnE,OAAO,EAAE,OAAO,EAAE,SAAS,EAAmB,MAAM,2CAA2C,CAAC;AAChG,OAAO,EAAE,KAAK,EAAE,MAAM,0CAA0C,CAAC;AAEjE,OAAO,EAAE,GAAG,EAAE,MAAM,sCAAsC,CAAC;AAC3D,OAAO,EAAE,uCAAuC,EAAE,MAAM,6CAA6C,CAAC;AACtG,OAAO,EAAE,yBAAyB,EAAE,MAAM,iFAAiF,CAAC;AAE5H,OAAO,EAAE,wBAAwB,EAAE,MAAM,kFAAkF,CAAC;AAE5H,OAAO,EAAE,WAAW,EAAE,MAAM,wDAAwD,CAAC;AAErF,OAAO,EAAE,cAAc,EAAE,MAAM,8CAA8C,CAAC;AAC9E,OAAO,EAAE,eAAe,EAA+B,MAAM,sDAAsD,CAAC;AAEpH,OAAO,EAAE,wBAAwB,EAAE,iBAAiB,EAAE,MAAM,0DAA0D,CAAC;AACvH,OAAO,EAAE,SAAS,EAAE,MAAM,mEAAmE,CAAC;AAC9F,OAAO,EAAE,eAAe,EAAE,MAAM,mDAAmD,CAAC;AACpF,OAAO,EAAE,wBAAwB,EAAE,MAAM,wEAAwE,CAAC;AAClH,OAAO,EAAE,6BAA6B,EAAE,MAAM,sDAAsD,CAAC;AACrG,OAAO,EAAE,kBAAkB,EAAE,MAAM,qDAAqD,CAAC;AACzF,OAAO,EAAE,yBAAyB,EAAE,MAAM,+DAA+D,CAAC;AAE1G,OAAO,EAAE,YAAY,EAAwC,MAAM,wCAAwC,CAAC;AAC5G,OAAO,EAAE,mBAAmB,EAAE,MAAM,oCAAoC,CAAC;AACzE,OAAO,EAAE,0BAA0B,EAA2F,MAAM,sDAAsD,CAAC;AAC3L,OAAO,EAAE,oBAAoB,EAAE,gBAAgB,EAA0B,MAAM,0CAA0C,CAAC;AAC1H,OAAO,EAAE,+BAA+B,EAAE,MAAM,yCAAyC,CAAC;AAC1F,OAAO,EAAE,iBAAiB,EAAkC,MAAM,0CAA0C,CAAC;AAE7G,OAAO,EAAE,mCAAmC,EAAmC,MAAM,qDAAqD,CAAC;AAC3I,OAAO,EAAE,mBAAmB,EAAE,MAAM,8CAA8C,CAAC;AAEnF,MAAM,qBAAsB,SAAQ,iBAAiB;IAArD;;QACoB,eAAU,GAA6B,OAAO,CAAC,OAAO,iCAAyB,CAAC;IAQpG,CAAC;IANA,IAAI,2BAA2B,KAAK,OAAO,IAAI,CAAC,4BAA4B,CAAC,CAAC,CAAC;IAC/E,IAAI,cAAc,KAAK,OAAO,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC;IAErD,YAAY,CAAC,EAAmB;QAC/B,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;IACvC,CAAC;CACD;AAED,KAAK,CAAC,mBAAmB,EAAE,GAAG,EAAE;IAC/B,MAAM,KAAK,GAAG,uCAAuC,EAAE,CAAC;IAExD,IAAI,oBAA8C,CAAC;IACnD,IAAI,oBAA8C,CAAC;IACnD,IAAI,WAAyB,CAAC;IAC9B,IAAI,cAA+B,CAAC;IACpC,IAAI,uBAA2C,CAAC;IAChD,IAAI,6BAAyD,CAAC;IAC9D,IAAI,yBAA+E,CAAC;IAEpF,IAAI,iBAAwC,CAAC;IAE7C,KAAK,CAAC,GAAG,EAAE;QACV,oBAAoB,GAAG,IAAI,wBAAwB,EAAE,CAAC;QACtD,uBAAuB,GAAG,IAAI,kBAAkB,EAAE,CAAC;QAEnD,MAAM,UAAU,GAAG,IAAI,cAAc,EAAE,CAAC;QACxC,WAAW,GAAG,KAAK,CAAC,GAAG,CAAC,IAAI,WAAW,CAAC,UAAU,CAAC,CAAC,CAAC;QACrD,MAAM,kBAAkB,GAAG,IAAI,yBAAyB,EAAE,CAAC;QAC3D,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,gBAAgB,CAAC,OAAO,CAAC,IAAI,EAAE,kBAAkB,CAAC,CAAC,CAAC;QAE1E,SAAS,kGAAoD,IAAI,CAAC,CAAC;QACnE,6BAA6B,GAAG,IAAI,OAAO,EAAqB,CAAC;QACjE,yBAAyB,GAAG,IAAI,OAAO,EAA+C,CAAC;QAEvF,oBAAoB,GAAG,6BAA6B,CAAC;YACpD,oBAAoB,EAAE,GAAG,EAAE,CAAC,oBAAoB;YAChD,WAAW,EAAE,GAAG,EAAE,CAAC,WAAW;SAC9B,EAAE,KAAK,CAAC,CAAC;QAEV,oBAAoB,CAAC,IAAI,CAAC,oBAAoB,EAAE,KAAK,CAAC,GAAG,CAAC,oBAAoB,CAAC,cAAc,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC;QACrH,oBAAoB,CAAC,IAAI,CAAC,wBAAwB,EAAE,uBAAuB,CAAC,CAAC;QAC7E,oBAAoB,CAAC,IAAI,CAAC,eAAe,EAAE;YAC1C,0BAA0B,EAAE,GAAG,EAAE,CAAC,SAAS;SAC3C,CAAC,CAAC;QAEH,MAAM,wBAAwB,GAAG,KAAK,CAAC,GAAG,CAAC,oBAAoB,CAAC,cAAc,CAAC,wBAAwB,CAAC,CAAC,CAAC;QAC1G,wBAAwB,CAAC,MAAM,GAAG,IAAI,CAAC;QACvC,oBAAoB,CAAC,IAAI,CAAC,yBAAyB,EAAE,wBAAwB,CAAC,CAAC;QAE/E,oBAAoB,CAAC,IAAI,CAAC,0BAA0B,EAAE;YACrD,QAAQ;gBACP,OAAO,EAAE,CAAC;YACX,CAAC;SACD,CAAC,CAAC;QACH,oBAAoB,CAAC,IAAI,CAAC,gBAAgB,EAAE;YAC3C,oBAAoB,EAAE,6BAA6B,CAAC,KAAK;YACzD,gBAAgB,EAAE,KAAK,IAAI,EAAE,GAAG,CAAC;SACjC,CAAC,CAAC;QACH,oBAAoB,CAAC,IAAI,CAAC,YAAY,EAAE;YACvC,mBAAmB,EAAE,yBAAyB,CAAC,KAAK;SACpD,CAAC,CAAC;QACH,oBAAoB,CAAC,IAAI,CAAC,+BAA+B,EAAE;YAC1D,iBAAiB,EAAE,KAAK,IAAI,EAAE,CAAC,CAAC,EAAE,IAAI,EAAE,MAAM,EAAuB,CAAA;SACrE,CAAC,CAAC;QAEH,cAAc,GAAG,oBAAoB,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;QAC3D,cAAc,CAAC,KAAK,iIAAyE,IAAI,gEAA+C,CAAC;QAEjJ,iBAAiB,GAAG,KAAK,CAAC,GAAG,CAAC,oBAAoB,CAAC,cAAc,CAAC,qBAAqB,CAAC,CAAC,CAAC;IAC3F,CAAC,CAAC,CAAC;IAEH,SAAS,cAAc,CAAC,KAAoF;QAC3G,SAAS,sFAA8C,KAAK,CAAC,CAAC;IAC/D,CAAC;IAED,SAAS,SAAS,CAAC,GAAW,EAAE,KAAc;QAC7C,oBAAoB,CAAC,oBAAoB,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;QACtD,oBAAoB,CAAC,+BAA+B,CAAC,IAAI,CAAC;YACzD,oBAAoB,EAAE,GAAG,EAAE,CAAC,IAAI;YAChC,YAAY,EAAE,IAAI,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC;YAC5B,MAAM,kCAA0B;YAChC,MAAM,EAAE,IAAK;SACb,CAAC,CAAC;IACJ,CAAC;IAED,SAAS,oCAAoC;QAC5C,cAAc,CAAC,MAAM,mKAAkG,CAAC;IACzH,CAAC;IAED;;OAEG;IACH,KAAK,UAAU,eAAe,CAC7B,MAA0C;QAE1C,MAAM,OAAO,GAAsC;YAClD,UAAU,EAAE;gBACX,OAAO,EAAE,YAAY;gBACrB,WAAW,EAAE,4BAA4B;gBACzC,YAAY,EAAE,KAAK;gBACnB,GAAG,MAAM;aACoB;SACO,CAAC;QAEvC,MAAM,MAAM,GAAG,MAAM,iBAAiB,CAAC,qBAAqB,CAAC,OAAO,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAC9F,OAAO,MAAM,CAAC;IACf,CAAC;IAED,SAAS,WAAW,CAAC,MAA8B;QAClD,OAAO,MAAM,YAAY,SAAS,CAAC;IACpC,CAAC;IAED;;OAEG;IACH,SAAS,kBAAkB,CAAC,kBAAuD;QAClF,EAAE,CAAC,kBAAkB,EAAE,4CAA4C,CAAC,CAAC;QACrE,EAAE,CAAC,CAAC,kBAAkB,CAAC,oBAAoB,EAAE,6DAA6D,CAAC,CAAC;IAC7G,CAAC;IAED;;OAEG;IACH,SAAS,0BAA0B,CAAC,kBAAuD,EAAE,aAAsB;QAClH,EAAE,CAAC,kBAAkB,EAAE,4CAA4C,CAAC,CAAC;QACrE,EAAE,CAAC,kBAAkB,CAAC,oBAAoB,EAAE,yDAAyD,CAAC,CAAC;QACvG,IAAI,aAAa,EAAE,CAAC;YACnB,WAAW,CAAC,kBAAkB,CAAC,oBAAqB,CAAC,KAAK,EAAE,aAAa,CAAC,CAAC;QAC5E,CAAC;IACF,CAAC;IAED,KAAK,CAAC,4BAA4B,EAAE,GAAG,EAAE;QACxC,MAAM,QAAQ,GAAG,mCAAmC,qFAA6C,CAAC,OAAqF,CAAC;QAExL,UAAU,CAAC,GAAG,EAAE;YACf,gFAAgF;YAChF,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,MAAM,GAAG,EAAE,CAAC,CAAC;QACvC,CAAC,CAAC,CAAC;QACH,KAAK,CAAC,GAAG,EAAE;YACV,cAAc,CAAC,QAAQ,CAAC,CAAC;QAC1B,CAAC,CAAC,CAAC;QAEH,MAAM,qBAAqB,GAAG;YAC7B,gBAAgB;YAChB,UAAU;YACV,YAAY;YACZ,cAAc;YACd,QAAQ;YACR,KAAK;YACL,cAAc;YACd,qBAAqB;YACrB,iBAAiB;YACjB,0BAA0B;YAC1B,gBAAgB;YAChB,YAAY;YACZ,aAAa;YACb,iBAAiB;YACjB,YAAY;YACZ,wBAAwB;YACxB,uBAAuB;YACvB,YAAY;YACZ,kBAAkB;YAClB,eAAe;YACf,mBAAmB;YACnB,eAAe;YACf,OAAO;YACP,SAAS;YACT,eAAe;YACf,yBAAyB;YAEzB,wBAAwB;YACxB,YAAY;YACZ,mBAAmB;YACnB,eAAe;YACf,eAAe;YACf,iBAAiB;YAEjB,sBAAsB;YACtB,eAAe;YACf,UAAU;YACV,YAAY;YACZ,cAAc;YACd,oBAAoB;YACpB,qBAAqB;YACrB,4BAA4B;YAC5B,0BAA0B;YAC1B,eAAe;YAEf,yCAAyC;YACzC,oBAAoB;YACpB,uBAAuB;YACvB,sBAAsB;YACtB,cAAc;YACd,kBAAkB;YAElB,qCAAqC;YACrC,iBAAiB;YACjB,gBAAgB;YAChB,sBAAsB;YACtB,uBAAuB;YACvB,eAAe;YACf,gBAAgB;SAChB,CAAC;QACF,MAAM,6BAA6B,GAAG;YACrC,4BAA4B;YAC5B,cAAc;YACd,cAAc;YACd,cAAc;YACd,sBAAsB;YACtB,aAAa;YACb,WAAW;YACX,gBAAgB;YAChB,yBAAyB;YAEzB,qBAAqB;YACrB,WAAW;YACX,QAAQ;YACR,KAAK;YACL,uBAAuB;YACvB,cAAc;YACd,6BAA6B;YAC7B,6BAA6B;YAE7B,eAAe;YACf,0BAA0B;YAC1B,+BAA+B;YAC/B,2CAA2C;YAC3C,uCAAuC;YACvC,yBAAyB;YACzB,yBAAyB;YAEzB,mBAAmB;YACnB,mBAAmB;YACnB,2BAA2B;YAC3B,4CAA4C;YAC5C,8BAA8B;YAC9B,uBAAuB;YAEvB,oBAAoB;YACpB,wBAAwB;YACxB,UAAU;YACV,mBAAmB;YACnB,8BAA8B;YAC9B,uBAAuB;YAEvB,oCAAoC;YACpC,0BAA0B;YAC1B,yBAAyB;YACzB,gBAAgB;YAChB,wBAAwB;YACxB,2BAA2B;YAC3B,2BAA2B;YAC3B,8BAA8B;YAC9B,uBAAuB;YACvB,oBAAoB;YAEpB,kCAAkC;YAClC,wCAAwC;YACxC,6CAA6C;YAC7C,gDAAgD;YAChD,mCAAmC;YACnC,yBAAyB;SACzB,CAAC;QAEF,KAAK,CAAC,IAAI,CAAC,eAAe,EAAE,GAAG,EAAE;YAChC,KAAK,MAAM,OAAO,IAAI,qBAAqB,EAAE,CAAC;gBAC7C,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,IAAI,EAAE,KAAK,CAAC,EAAE,KAAK,IAAI,EAAE;oBAChD,kBAAkB,CAAC,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC;gBACxD,CAAC,CAAC,CAAC;YACJ,CAAC;QACF,CAAC,CAAC,CAAC;QACH,KAAK,CAAC,uBAAuB,EAAE,GAAG,EAAE;YACnC,KAAK,MAAM,OAAO,IAAI,6BAA6B,EAAE,CAAC;gBACrD,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,IAAI,EAAE,KAAK,CAAC,EAAE,KAAK,IAAI,EAAE;oBAChD,0BAA0B,CAAC,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC;gBAChE,CAAC,CAAC,CAAC;YACJ,CAAC;QACF,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,KAAK,CAAC,gDAAgD,EAAE,GAAG,EAAE;QAE5D,IAAI,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC7D,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,kBAAkB,EAAE,CAAC,CAAC;YACtE,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC5B,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,4DAA4D,EAAE,KAAK,IAAI,EAAE;YAC7E,cAAc,CAAC;gBACd,EAAE,EAAE,IAAI;aACR,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,aAAa;gBACtB,WAAW,EAAE,eAAe;aAC5B,CAAC,CAAC;YACH,0BAA0B,CAAC,MAAM,EAAE,qBAAqB,CAAC,CAAC;QAC3D,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,6EAA6E,EAAE,KAAK,IAAI,EAAE;YAC9F,cAAc,CAAC;gBACd,EAAE,EAAE,KAAK;gBACT,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,uBAAuB;gBAChC,WAAW,EAAE,yBAAyB;aACtC,CAAC,CAAC;YACH,0BAA0B,CAAC,MAAM,EAAE,qBAAqB,CAAC,CAAC;QAC3D,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,qDAAqD,EAAE,KAAK,IAAI,EAAE;YACtE,cAAc,CAAC;gBACd,EAAE,EAAE,IAAI;aACR,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,iCAAiC;gBAC9C,YAAY,EAAE,IAAI;aAClB,CAAC,CAAC;YACH,0BAA0B,CAAC,MAAM,EAAE,2CAA2C,CAAC,CAAC;QACjF,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;YACxE,cAAc,CAAC;gBACd,GAAG,EAAE,IAAI;aACT,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,iCAAiC;gBAC9C,YAAY,EAAE,IAAI;aAClB,CAAC,CAAC;YACH,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC5B,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,0DAA0D,EAAE,KAAK,IAAI,EAAE;YAC3E,cAAc,CAAC;gBACd,GAAG,EAAE,IAAI;aACT,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,iCAAiC;gBAC9C,YAAY,EAAE,IAAI;aAClB,CAAC,CAAC;YACH,kBAAkB,CAAC,MAAM,CAAC,CAAC;YAE3B,mDAAmD;YACnD,EAAE,CAAC,MAAM,EAAE,gBAAgB,EAAE,yCAAyC,CAAC,CAAC;YACxE,mDAAmD;YACnD,MAAM,YAAY,GAAG,MAAO,CAAC,gBAAuB,CAAC;YACrD,EAAE,CAAC,YAAY,CAAC,eAAe,EAAE,6EAA6E,CAAC,CAAC;YAChH,EAAE,CAAC,YAAY,CAAC,eAAe,CAAC,KAAK,EAAE,0CAA0C,CAAC,CAAC;YACnF,EAAE,CAAC,YAAY,CAAC,eAAe,CAAC,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,EAAE,uDAAuD,CAAC,CAAC;QACjH,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC7D,cAAc,CAAC;gBACd,qBAAqB,EAAE,IAAI;aAC3B,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,wBAAwB,EAAE,CAAC,CAAC;YAC5E,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC5B,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,wDAAwD,EAAE,KAAK,IAAI,EAAE;YACzE,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;gBACV,EAAE,EAAE,IAAI;aACR,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,wBAAwB,EAAE,CAAC,CAAC;YAC5E,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC5B,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,kEAAkE,EAAE,KAAK,IAAI,EAAE;YACnF,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,6BAA6B,EAAE,CAAC,CAAC;YACjF,0BAA0B,CAAC,MAAM,CAAC,CAAC;QACpC,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,qCAAqC,EAAE,KAAK,IAAI,EAAE;YACtD,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,EAAE;gBACX,WAAW,EAAE,eAAe;aAC5B,CAAC,CAAC;YACH,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC5B,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,+CAA+C,EAAE,KAAK,IAAI,EAAE;YAChE,cAAc,CAAC;gBACd,aAAa,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,gBAAgB,EAAE,IAAI,EAAE;gBACzD,MAAM,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,gBAAgB,EAAE,IAAI,EAAE;aACjD,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,kBAAkB,EAAE,CAAC,CAAC;YACvE,kBAAkB,CAAC,OAAO,CAAC,CAAC;YAE5B,MAAM,OAAO,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,kCAAkC,EAAE,CAAC,CAAC;YACvF,0BAA0B,CAAC,OAAO,CAAC,CAAC;QACrC,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,2EAA2E,EAAE,KAAK,IAAI,EAAE;YAC5F,cAAc,CAAC;gBACd,KAAK,EAAE,IAAI;gBACX,SAAS,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,gBAAgB,EAAE,IAAI,EAAE;aACrD,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;YAC1D,0BAA0B,CAAC,OAAO,CAAC,CAAC;YAEpC,MAAM,OAAO,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,SAAS,EAAE,CAAC,CAAC;YAC9D,kBAAkB,CAAC,OAAO,CAAC,CAAC;QAC7B,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,KAAK,CAAC,qDAAqD,EAAE,GAAG,EAAE;QAEjE,SAAS,qBAAqB,CAAC,MAA2C,EAAE,KAAyG;YACpL,MAAM,OAAO,GAAG,MAAM,EAAE,oBAAoB,EAAE,qBAAsB,CAAC;YACrE,EAAE,CAAC,OAAO,EAAE,uCAAuC,CAAC,CAAC;YAErD,WAAW,CAAC,OAAO,CAAC,MAAM,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC;YAE1C,KAAK,MAAM,CAAC,CAAC,EAAE,IAAI,CAAC,IAAI,KAAK,CAAC,OAAO,EAAE,EAAE,CAAC;gBACzC,MAAM,MAAM,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;gBAC1B,IAAI,IAAI,KAAK,KAAK,EAAE,CAAC;oBACpB,EAAE,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;gBACzB,CAAC;qBAAM,CAAC;oBACP,EAAE,CAAC,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;oBACzB,IAAI,IAAI,KAAK,WAAW,EAAE,CAAC;wBAC1B,WAAW,CAAC,MAAM,CAAC,KAAK,EAAE,2BAA2B,CAAC,CAAC;wBACvD,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC;oBAC5C,CAAC;yBAAM,IAAI,IAAI,KAAK,iBAAiB,EAAE,CAAC;wBACvC,WAAW,CAAC,MAAM,CAAC,KAAK,EAAE,oCAAoC,CAAC,CAAC;wBAChE,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,iBAAiB,CAAC,CAAC;oBAClD,CAAC;yBAAM,IAAI,IAAI,KAAK,aAAa,EAAE,CAAC;wBACnC,WAAW,CAAC,MAAM,CAAC,KAAK,EAAE,iCAAiC,CAAC,CAAC;wBAC7D,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;wBACzC,EAAE,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,+BAA+B,CAAC,CAAC;oBACvE,CAAC;yBAAM,CAAC;wBACP,IAAI,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE,CAAC;4BACpC,WAAW,CAAC,MAAM,CAAC,KAAK,EAAE,0BAA0B,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;wBACnF,CAAC;6BAAM,CAAC;4BACP,WAAW,CAAC,MAAM,CAAC,KAAK,EAAE,yBAAyB,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC;wBACvE,CAAC;wBACD,WAAW,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;wBACzC,EAAE,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,8BAA8B,CAAC,CAAC;oBACrE,CAAC;gBACF,CAAC;YACF,CAAC;QACF,CAAC;QAED,IAAI,CAAC,+DAA+D,EAAE,KAAK,IAAI,EAAE;YAChF,cAAc,CAAC;gBACd,EAAE,EAAE,IAAI;aACR,CAAC,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,mBAAmB;aAChC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,EAAE,qBAAqB,CAAC,CAAC;YAC1D,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,eAAe,EAAE;gBAC/B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,yDAAyD,EAAE,KAAK,IAAI,EAAE;YAC1E,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,KAAK;gBACd,WAAW,EAAE,iBAAiB;aAC9B,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,KAAK,EAAE;gBACrB,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,+DAA+D,EAAE,KAAK,IAAI,EAAE;YAChF,cAAc,CAAC;gBACd,GAAG,EAAE,IAAI;aACT,CAAC,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,mBAAmB;aAChC,CAAC,CAAC;YAEH,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC5B,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,sEAAsE,EAAE,KAAK,IAAI,EAAE;YACvF,cAAc,CAAC;gBACd,GAAG,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE;aACvB,CAAC,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,mBAAmB;aAChC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,EAAE,qBAAqB,CAAC,CAAC;YAC1D,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,uEAAuE,EAAE,KAAK,IAAI,EAAE;YACxF,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,8BAA8B;gBACvC,WAAW,EAAE,gCAAgC;aAC7C,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,EAAE,qBAAqB,CAAC,CAAC;YAC1D,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,CAAC,aAAa,EAAE,eAAe,CAAC,EAAE;gBAChD,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,8DAA8D,EAAE,KAAK,IAAI,EAAE;YAC/E,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI,CAAE,+CAA+C;aAC3D,CAAC,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,gBAAgB;gBACzB,WAAW,EAAE,yCAAyC;aACtD,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,EAAE,qBAAqB,CAAC,CAAC;YAC1D,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,KAAK,EAAE;gBACrB,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,iFAAiF,EAAE,KAAK,IAAI,EAAE;YAClG,cAAc,CAAC;gBACd,GAAG,EAAE,IAAI;gBACT,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,gBAAgB;gBACzB,WAAW,EAAE,yCAAyC;aACtD,CAAC,CAAC;YAEH,kBAAkB,CAAC,MAAM,CAAC,CAAC;QAC5B,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,gEAAgE,EAAE,KAAK,IAAI,EAAE;YACjF,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;gBACV,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YACH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,kCAAkC;gBAC3C,WAAW,EAAE,6BAA6B;aAC1C,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,EAAE,qBAAqB,CAAC,CAAC;YAC1D,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,CAAC,KAAK,EAAE,KAAK,CAAC,EAAE;gBAC9B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC7D,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,YAAY;gBACrB,WAAW,EAAE,kBAAkB;aAC/B,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,YAAY,EAAE;gBAC5B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC7D,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,UAAU;gBACnB,WAAW,EAAE,eAAe;aAC5B,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,UAAU,EAAE;gBAC1B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;YACxE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,kBAAkB;aAC/B,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,eAAe,EAAE;gBAC/B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,wDAAwD,EAAE,KAAK,IAAI,EAAE;YACzE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,iBAAiB;aAC9B,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,eAAe,EAAE;gBAC/B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;YACxE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,iBAAiB;gBAC1B,WAAW,EAAE,oBAAoB;aACjC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,KAAK,EAAE;gBACrB,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,sDAAsD,EAAE,KAAK,IAAI,EAAE;YACvE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,yBAAyB;gBAClC,WAAW,EAAE,4BAA4B;aACzC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,aAAa,EAAE;gBAC7B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,gDAAgD,EAAE,KAAK,IAAI,EAAE;YACjE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,6BAA6B;gBACtC,WAAW,EAAE,wBAAwB;aACrC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,CAAC,eAAe,EAAE,YAAY,CAAC,EAAE;gBAC/C,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,oDAAoD,EAAE,KAAK,IAAI,EAAE;YACrE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,yBAAyB;gBAClC,WAAW,EAAE,qBAAqB;aAClC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,CAAC,UAAU,EAAE,MAAM,CAAC,EAAE;gBACpC,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,sDAAsD,EAAE,KAAK,IAAI,EAAE;YACvE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,iCAAiC;gBAC1C,WAAW,EAAE,sBAAsB;aACnC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,CAAC,YAAY,EAAE,SAAS,CAAC,EAAE;gBACzC,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,sDAAsD,EAAE,KAAK,IAAI,EAAE;YACvE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,SAAS;gBAClB,WAAW,EAAE,2BAA2B;aACxC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,KAAK,EAAE;gBACrB,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,gEAAgE,EAAE,KAAK,IAAI,EAAE;YACjF,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,KAAK;gBACd,WAAW,EAAE,iBAAiB;aAC9B,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,qDAAqD,EAAE,KAAK,IAAI,EAAE;YACtE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,gCAAgC;gBACzC,WAAW,EAAE,iBAAiB;aAC9B,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,UAAU,EAAE;gBAC1B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,uEAAuE,EAAE,KAAK,IAAI,EAAE;YACxF,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,eAAe;gBACxB,WAAW,EAAE,mBAAmB;aAChC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,EAAE,UAAU,EAAE,KAAK,EAAE;gBACrB,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;YACxE,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,sBAAsB;gBAC/B,WAAW,EAAE,kBAAkB;aAC/B,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,aAAa;gBACb,KAAK;gBACL,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,yDAAyD,EAAE,KAAK,IAAI,EAAE;YAC1E,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;gBACV,aAAa,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,gBAAgB,EAAE,IAAI,EAAE;aACzD,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,YAAY;aACrB,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,qBAAqB,CAAC,MAAM,EAAE;gBAC7B,iBAAiB;gBACjB,KAAK;gBACL,WAAW;aACX,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,2EAA2E,EAAE,KAAK,IAAI,EAAE;YAC5F,SAAS,8GAA0D,kBAAkB,CAAC,CAAC;YACvF,cAAc,CAAC,EAAE,CAAC,CAAC;YAEnB,MAAM,eAAe,GAAG,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,sBAAsB,CAAC,CAAC,CAAC,oBAAoB,CAAC,CAAC;YAC5F,MAAM,SAAS,GAAG,IAAI,SAAS,CAAC,MAAM,EAAE,CAAC,iBAAiB,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;YAC9E,uBAAuB,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;YAChD,oBAAoB,CAAC,IAAI,CAAC,eAAe,EAAE;gBAC1C,0BAA0B,EAAE,GAAG,EAAE,CAAC,eAAe;aACjD,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC;gBACpC,OAAO,EAAE,0BAA0B;aACnC,CAAC,CAAC;YAEH,0BAA0B,CAAC,MAAM,CAAC,CAAC;YACnC,WAAW,CAAC,MAAM,EAAE,oBAAoB,EAAE,qBAAqB,EAAE,SAAS,EAAE,uDAAuD,CAAC,CAAC;QACtI,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,KAAK,CAAC,+BAA+B,EAAE,GAAG,EAAE;QAC3C,IAAI,CAAC,mEAAmE,EAAE,GAAG,EAAE;YAC9E,MAAM,SAAS,GAAG,kBAAkB,CAAC;YACrC,mDAAmD;YACnD,MAAM,YAAY,GAAsB;gBACvC,OAAO,EAAE,GAAG,EAAE,GAAsB,CAAC;gBACrC,SAAS,EAAE,KAAK;aACT,CAAC;YACT,IAAI,gBAAgB,GAAG,KAAK,CAAC;YAC7B,YAAY,CAAC,OAAO,GAAG,GAAG,EAAE,GAAG,gBAAgB,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;YAE1D,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,SAAS,EAAE;gBAC5D,QAAQ,EAAE,YAAY;gBACtB,uBAAuB,2CAA8B;aACrD,CAAC,CAAC;YAEH,EAAE,CAAC,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,mDAAmD,CAAC,CAAC;YAEtH,yBAAyB,CAAC,IAAI,CAAC,EAAE,eAAe,EAAE,mBAAmB,CAAC,UAAU,CAAC,SAAS,CAAC,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;YAElH,WAAW,CAAC,gBAAgB,EAAE,IAAI,EAAE,oCAAoC,CAAC,CAAC;YAC1E,EAAE,CAAC,CAAC,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE,uDAAuD,CAAC,CAAC;QAC5H,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,+DAA+D,EAAE,GAAG,EAAE;YAC1E,MAAM,UAAU,GAAG,gBAAgB,CAAC;YACpC,MAAM,UAAU,GAAG,gBAAgB,CAAC;YACpC,mDAAmD;YACnD,MAAM,aAAa,GAAsB;gBACxC,OAAO,EAAE,GAAG,EAAE,GAAsB,CAAC;gBACrC,SAAS,EAAE,KAAK;aACT,CAAC;YACT,mDAAmD;YACnD,MAAM,aAAa,GAAsB;gBACxC,OAAO,EAAE,GAAG,EAAE,GAAsB,CAAC;gBACrC,SAAS,EAAE,KAAK;aACT,CAAC;YAET,IAAI,iBAAiB,GAAG,KAAK,CAAC;YAC9B,IAAI,iBAAiB,GAAG,KAAK,CAAC;YAC9B,aAAa,CAAC,OAAO,GAAG,GAAG,EAAE,GAAG,iBAAiB,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;YAC5D,aAAa,CAAC,OAAO,GAAG,GAAG,EAAE,GAAG,iBAAiB,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC;YAE5D,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,UAAU,EAAE;gBAC7D,QAAQ,EAAE,aAAa;gBACvB,uBAAuB,2CAA8B;aACrD,CAAC,CAAC;YACH,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,UAAU,EAAE;gBAC7D,QAAQ,EAAE,aAAa;gBACvB,uBAAuB,2CAA8B;aACrD,CAAC,CAAC;YAEH,EAAE,CAAC,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,6CAA6C,CAAC,CAAC;YACjH,EAAE,CAAC,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,6CAA6C,CAAC,CAAC;YAEjH,yBAAyB,CAAC,IAAI,CAAC,EAAE,eAAe,EAAE,mBAAmB,CAAC,UAAU,CAAC,UAAU,CAAC,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;YAEnH,WAAW,CAAC,iBAAiB,EAAE,IAAI,EAAE,sCAAsC,CAAC,CAAC;YAC7E,WAAW,CAAC,iBAAiB,EAAE,KAAK,EAAE,0CAA0C,CAAC,CAAC;YAClF,EAAE,CAAC,CAAC,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,kDAAkD,CAAC,CAAC;YACvH,EAAE,CAAC,iBAAiB,CAAC,2BAA2B,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,8CAA8C,CAAC,CAAC;QACnH,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,2DAA2D,EAAE,GAAG,EAAE;YACtE,WAAW,CAAC,iBAAiB,CAAC,2BAA2B,CAAC,IAAI,EAAE,CAAC,EAAE,wCAAwC,CAAC,CAAC;YAC7G,yBAAyB,CAAC,IAAI,CAAC,EAAE,eAAe,EAAE,mBAAmB,CAAC,UAAU,CAAC,sBAAsB,CAAC,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC,CAAC;YAC/H,WAAW,CAAC,iBAAiB,CAAC,2BAA2B,CAAC,IAAI,EAAE,CAAC,EAAE,kEAAkE,CAAC,CAAC;QACxI,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,KAAK,CAAC,2CAA2C,EAAE,GAAG,EAAE;QACvD,IAAI,CAAC,oFAAoF,EAAE,KAAK,IAAI,EAAE;YACrG,SAAS,kGAAoD,IAAI,CAAC,CAAC;YACnE,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YAEH,oCAAoC,EAAE,CAAC;YAEvC,0BAA0B,CAAC,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,kBAAkB,EAAE,CAAC,EAAE,qBAAqB,CAAC,CAAC;QAC3G,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,kFAAkF,EAAE,KAAK,IAAI,EAAE;YACnG,SAAS,kGAAoD,IAAI,CAAC,CAAC;YACnE,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YAEH,kBAAkB,CAAC,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,kBAAkB,EAAE,CAAC,CAAC,CAAC;QAC5E,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,yFAAyF,EAAE,KAAK,IAAI,EAAE;YAC1G,SAAS,kGAAoD,KAAK,CAAC,CAAC;YACpE,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,kBAAkB,EAAE,CAAC,CAAC;YACtE,0BAA0B,CAAC,MAAM,EAAE,qBAAqB,CAAC,CAAC;QAC3D,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,KAAK,CAAC,4BAA4B,EAAE,GAAG,EAAE;QACxC,IAAI,CAAC,6EAA6E,EAAE,KAAK,IAAI,EAAE;YAC9F,cAAc,CAAC;gBACd,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;YAEH,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,EAAE,OAAO,EAAE,0BAA0B,EAAE,CAAC,CAAC;YAC9E,kBAAkB,CAAC,MAAM,CAAC,CAAC;YAE3B,MAAM,eAAe,GAAI,MAAO,CAAC,gBAAoD,CAAC,eAAgB,CAAC;YACvG,EAAE,CAAC,eAAe,CAAC,CAAC;YACpB,EAAE,CAAC,eAAe,CAAC,KAAK,CAAC,QAAQ,CAAC,wBAAwB,CAAC,EAAE,4CAA4C,CAAC,CAAC;YAC3G,WAAW,CAAC,KAAK,CAAC,eAAe,CAAC,KAAK,EAAE,MAAM,CAAC,EAAE,CAAC,CAAC,CAAC;QACtD,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,KAAK,CAAC,uBAAuB,EAAE,GAAG,EAAE;QACnC,IAAI,CAAC,yEAAyE,EAAE,KAAK,IAAI,EAAE;YAC1F,MAAM,SAAS,GAAG,kBAAkB,CAAC;YACrC,MAAM,mBAAmB,GAAG,oBAAoB,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;YAE3E,MAAM,OAAO,GAAsC;gBAClD,UAAU,EAAE;oBACX,OAAO,EAAE,uBAAuB;oBAChC,WAAW,EAAE,eAAe;oBAC5B,YAAY,EAAE,KAAK;iBACU;gBAC9B,aAAa,EAAE,SAAS;aACa,CAAC;YAEvC,IAAI,MAAM,GAAG,MAAM,iBAAiB,CAAC,qBAAqB,CAAC,OAAO,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;YAC5F,0BAA0B,CAAC,MAAM,CAAC,CAAC;YAEnC,mBAAmB,CAAC,0BAA0B,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;YAEhE,MAAM,GAAG,MAAM,iBAAiB,CAAC,qBAAqB,CAAC,OAAO,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;YACxF,kBAAkB,CAAC,MAAM,CAAC,CAAC;YAE3B,MAAM,YAAY,GAAG,MAAO,CAAC,gBAAmD,CAAC;YACjF,EAAE,CAAC,YAAY,CAAC,eAAe,EAAE,wCAAwC,CAAC,CAAC;YAC3E,EAAE,CAAC,YAAY,CAAC,eAAe,CAAC,KAAK,CAAC,QAAQ,CAAC,gCAAgC,CAAC,EAAE,mCAAmC,CAAC,CAAC;QACxH,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;IAEH,KAAK,CAAC,wBAAwB,EAAE,GAAG,EAAE;QACpC,KAAK,CAAC,mBAAmB,EAAE,GAAG,EAAE;YAC/B,CAAC,SAAS,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,8CAA8C,EAAE,KAAK,IAAI,EAAE;gBACzF,iBAAiB,CAAC,YAAY,iCAAyB,CAAC;gBACxD,MAAM,aAAa,GAAG,MAAM,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,uCAAuC,EAAE,IAAI,EAAE,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;gBAC7G,SAAS,6GAAyD,aAAa,CAAC,CAAC;gBAEjF,MAAM,MAAM,GAAG,MAAM,iBAAiB,CAAC,cAAc,CAAC,iBAAiB,EAAE,CAAC;gBAC1E,WAAW,CAAC,MAAM,EAAE,aAAa,CAAC,CAAC;YACpC,CAAC,CAAC,CAAC;YAEH,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,wEAAwE,EAAE,KAAK,IAAI,EAAE;gBACjH,iBAAiB,CAAC,YAAY,+BAAuB,CAAC;gBACtD,SAAS,yGAAuD,IAAI,CAAC,CAAC;gBAEtE,MAAM,MAAM,GAAG,MAAM,iBAAiB,CAAC,cAAc,CAAC,iBAAiB,EAAE,CAAC;gBAC1E,WAAW,CAAC,OAAO,MAAM,EAAE,QAAQ,CAAC,CAAC;gBACrC,WAAW,CAAE,MAA2B,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;YACxD,CAAC,CAAC,CAAC;QACJ,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC","file":"runInTerminalTool.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ok, strictEqual } from 'assert';\nimport { Separator } from '../../../../../../base/common/actions.js';\nimport { CancellationToken } from '../../../../../../base/common/cancellation.js';\nimport { Emitter } from '../../../../../../base/common/event.js';\nimport { Schemas } from '../../../../../../base/common/network.js';\nimport { isLinux, isWindows, OperatingSystem } from '../../../../../../base/common/platform.js';\nimport { count } from '../../../../../../base/common/strings.js';\nimport type { SingleOrMany } from '../../../../../../base/common/types.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { ITreeSitterLibraryService } from '../../../../../../editor/common/services/treeSitter/treeSitterLibraryService.js';\nimport { ConfigurationTarget } from '../../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { IFileService } from '../../../../../../platform/files/common/files.js';\nimport { FileService } from '../../../../../../platform/files/common/fileService.js';\nimport type { TestInstantiationService } from '../../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { NullLogService } from '../../../../../../platform/log/common/log.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../../platform/storage/common/storage.js';\nimport { ITerminalProfile } from '../../../../../../platform/terminal/common/terminal.js';\nimport { IWorkspaceContextService, toWorkspaceFolder } from '../../../../../../platform/workspace/common/workspace.js';\nimport { Workspace } from '../../../../../../platform/workspace/test/common/testWorkspace.js';\nimport { IHistoryService } from '../../../../../services/history/common/history.js';\nimport { TreeSitterLibraryService } from '../../../../../services/treeSitter/browser/treeSitterLibraryService.js';\nimport { workbenchInstantiationService } from '../../../../../test/browser/workbenchTestServices.js';\nimport { TestContextService } from '../../../../../test/common/workbenchTestServices.js';\nimport { TestIPCFileSystemProvider } from '../../../../../test/electron-browser/workbenchTestServices.js';\nimport { TerminalToolConfirmationStorageKeys } from '../../../../chat/browser/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.js';\nimport { IChatService, type IChatTerminalToolInvocationData } from '../../../../chat/common/chatService.js';\nimport { LocalChatSessionUri } from '../../../../chat/common/chatUri.js';\nimport { ILanguageModelToolsService, IPreparedToolInvocation, IToolInvocationPreparationContext, type ToolConfirmationAction } from '../../../../chat/common/languageModelToolsService.js';\nimport { ITerminalChatService, ITerminalService, type ITerminalInstance } from '../../../../terminal/browser/terminal.js';\nimport { ITerminalProfileResolverService } from '../../../../terminal/common/terminal.js';\nimport { RunInTerminalTool, type IRunInTerminalInputParams } from '../../browser/tools/runInTerminalTool.js';\nimport { ShellIntegrationQuality } from '../../browser/toolTerminalCreator.js';\nimport { terminalChatAgentToolsConfiguration, TerminalChatAgentToolsSettingId } from '../../common/terminalChatAgentToolsConfiguration.js';\nimport { TerminalChatService } from '../../../chat/browser/terminalChatService.js';\n\nclass TestRunInTerminalTool extends RunInTerminalTool {\n\tprotected override _osBackend: Promise<OperatingSystem> = Promise.resolve(OperatingSystem.Windows);\n\n\tget sessionTerminalAssociations() { return this._sessionTerminalAssociations; }\n\tget profileFetcher() { return this._profileFetcher; }\n\n\tsetBackendOs(os: OperatingSystem) {\n\t\tthis._osBackend = Promise.resolve(os);\n\t}\n}\n\nsuite('RunInTerminalTool', () => {\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet instantiationService: TestInstantiationService;\n\tlet configurationService: TestConfigurationService;\n\tlet fileService: IFileService;\n\tlet storageService: IStorageService;\n\tlet workspaceContextService: TestContextService;\n\tlet terminalServiceDisposeEmitter: Emitter<ITerminalInstance>;\n\tlet chatServiceDisposeEmitter: Emitter<{ sessionResource: URI; reason: 'cleared' }>;\n\n\tlet runInTerminalTool: TestRunInTerminalTool;\n\n\tsetup(() => {\n\t\tconfigurationService = new TestConfigurationService();\n\t\tworkspaceContextService = new TestContextService();\n\n\t\tconst logService = new NullLogService();\n\t\tfileService = store.add(new FileService(logService));\n\t\tconst fileSystemProvider = new TestIPCFileSystemProvider();\n\t\tstore.add(fileService.registerProvider(Schemas.file, fileSystemProvider));\n\n\t\tsetConfig(TerminalChatAgentToolsSettingId.EnableAutoApprove, true);\n\t\tterminalServiceDisposeEmitter = new Emitter<ITerminalInstance>();\n\t\tchatServiceDisposeEmitter = new Emitter<{ sessionResource: URI; reason: 'cleared' }>();\n\n\t\tinstantiationService = workbenchInstantiationService({\n\t\t\tconfigurationService: () => configurationService,\n\t\t\tfileService: () => fileService,\n\t\t}, store);\n\n\t\tinstantiationService.stub(ITerminalChatService, store.add(instantiationService.createInstance(TerminalChatService)));\n\t\tinstantiationService.stub(IWorkspaceContextService, workspaceContextService);\n\t\tinstantiationService.stub(IHistoryService, {\n\t\t\tgetLastActiveWorkspaceRoot: () => undefined\n\t\t});\n\n\t\tconst treeSitterLibraryService = store.add(instantiationService.createInstance(TreeSitterLibraryService));\n\t\ttreeSitterLibraryService.isTest = true;\n\t\tinstantiationService.stub(ITreeSitterLibraryService, treeSitterLibraryService);\n\n\t\tinstantiationService.stub(ILanguageModelToolsService, {\n\t\t\tgetTools() {\n\t\t\t\treturn [];\n\t\t\t},\n\t\t});\n\t\tinstantiationService.stub(ITerminalService, {\n\t\t\tonDidDisposeInstance: terminalServiceDisposeEmitter.event,\n\t\t\tsetNextCommandId: async () => { }\n\t\t});\n\t\tinstantiationService.stub(IChatService, {\n\t\t\tonDidDisposeSession: chatServiceDisposeEmitter.event\n\t\t});\n\t\tinstantiationService.stub(ITerminalProfileResolverService, {\n\t\t\tgetDefaultProfile: async () => ({ path: 'bash' } as ITerminalProfile)\n\t\t});\n\n\t\tstorageService = instantiationService.get(IStorageService);\n\t\tstorageService.store(TerminalToolConfirmationStorageKeys.TerminalAutoApproveWarningAccepted, true, StorageScope.APPLICATION, StorageTarget.USER);\n\n\t\trunInTerminalTool = store.add(instantiationService.createInstance(TestRunInTerminalTool));\n\t});\n\n\tfunction setAutoApprove(value: { [key: string]: { approve: boolean; matchCommandLine?: boolean } | boolean }) {\n\t\tsetConfig(TerminalChatAgentToolsSettingId.AutoApprove, value);\n\t}\n\n\tfunction setConfig(key: string, value: unknown) {\n\t\tconfigurationService.setUserConfiguration(key, value);\n\t\tconfigurationService.onDidChangeConfigurationEmitter.fire({\n\t\t\taffectsConfiguration: () => true,\n\t\t\taffectedKeys: new Set([key]),\n\t\t\tsource: ConfigurationTarget.USER,\n\t\t\tchange: null!,\n\t\t});\n\t}\n\n\tfunction clearAutoApproveWarningAcceptedState() {\n\t\tstorageService.remove(TerminalToolConfirmationStorageKeys.TerminalAutoApproveWarningAccepted, StorageScope.APPLICATION);\n\t}\n\n\t/**\n\t * Executes a test scenario for the RunInTerminalTool\n\t */\n\tasync function executeToolTest(\n\t\tparams: Partial<IRunInTerminalInputParams>\n\t): Promise<IPreparedToolInvocation | undefined> {\n\t\tconst context: IToolInvocationPreparationContext = {\n\t\t\tparameters: {\n\t\t\t\tcommand: 'echo hello',\n\t\t\t\texplanation: 'Print hello to the console',\n\t\t\t\tisBackground: false,\n\t\t\t\t...params\n\t\t\t} as IRunInTerminalInputParams\n\t\t} as IToolInvocationPreparationContext;\n\n\t\tconst result = await runInTerminalTool.prepareToolInvocation(context, CancellationToken.None);\n\t\treturn result;\n\t}\n\n\tfunction isSeparator(action: ToolConfirmationAction): action is Separator {\n\t\treturn action instanceof Separator;\n\t}\n\n\t/**\n\t * Helper to assert that a command should be auto-approved (no confirmation required)\n\t */\n\tfunction assertAutoApproved(preparedInvocation: IPreparedToolInvocation | undefined) {\n\t\tok(preparedInvocation, 'Expected prepared invocation to be defined');\n\t\tok(!preparedInvocation.confirmationMessages, 'Expected no confirmation messages for auto-approved command');\n\t}\n\n\t/**\n\t * Helper to assert that a command requires confirmation\n\t */\n\tfunction assertConfirmationRequired(preparedInvocation: IPreparedToolInvocation | undefined, expectedTitle?: string) {\n\t\tok(preparedInvocation, 'Expected prepared invocation to be defined');\n\t\tok(preparedInvocation.confirmationMessages, 'Expected confirmation messages for non-approved command');\n\t\tif (expectedTitle) {\n\t\t\tstrictEqual(preparedInvocation.confirmationMessages!.title, expectedTitle);\n\t\t}\n\t}\n\n\tsuite('default auto-approve rules', () => {\n\t\tconst defaults = terminalChatAgentToolsConfiguration[TerminalChatAgentToolsSettingId.AutoApprove].default as Record<string, boolean | { approve: boolean; matchCommandLine?: boolean }>;\n\n\t\tsuiteSetup(() => {\n\t\t\t// Sanity check on entries to make sure that the defaults are actually pulled in\n\t\t\tok(Object.keys(defaults).length > 50);\n\t\t});\n\t\tsetup(() => {\n\t\t\tsetAutoApprove(defaults);\n\t\t});\n\n\t\tconst autoApprovedTestCases = [\n\t\t\t// Safe commands\n\t\t\t'echo abc',\n\t\t\t'echo \"abc\"',\n\t\t\t'echo \\'abc\\'',\n\t\t\t'ls -la',\n\t\t\t'pwd',\n\t\t\t'cat file.txt',\n\t\t\t'head -n 10 file.txt',\n\t\t\t'tail -f log.txt',\n\t\t\t'findstr pattern file.txt',\n\t\t\t'wc -l file.txt',\n\t\t\t'tr a-z A-Z',\n\t\t\t'cut -d: -f1',\n\t\t\t'cmp file1 file2',\n\t\t\t'which node',\n\t\t\t'basename /path/to/file',\n\t\t\t'dirname /path/to/file',\n\t\t\t'realpath .',\n\t\t\t'readlink symlink',\n\t\t\t'stat file.txt',\n\t\t\t'file document.pdf',\n\t\t\t'du -sh folder',\n\t\t\t'df -h',\n\t\t\t'sleep 5',\n\t\t\t'cd /home/user',\n\t\t\t'nl -ba path/to/file.txt',\n\n\t\t\t// Safe git sub-commands\n\t\t\t'git status',\n\t\t\t'git log --oneline',\n\t\t\t'git show HEAD',\n\t\t\t'git diff main',\n\t\t\t'git grep \"TODO\"',\n\n\t\t\t// PowerShell commands\n\t\t\t'Get-ChildItem',\n\t\t\t'Get-Date',\n\t\t\t'Get-Random',\n\t\t\t'Get-Location',\n\t\t\t'Write-Host \"Hello\"',\n\t\t\t'Write-Output \"Test\"',\n\t\t\t'Split-Path C:\\\\Users\\\\test',\n\t\t\t'Join-Path C:\\\\Users test',\n\t\t\t'Start-Sleep 2',\n\n\t\t\t// PowerShell safe verbs (regex patterns)\n\t\t\t'Select-Object Name',\n\t\t\t'Measure-Object Length',\n\t\t\t'Compare-Object $a $b',\n\t\t\t'Format-Table',\n\t\t\t'Sort-Object Name',\n\n\t\t\t// Commands with acceptable arguments\n\t\t\t'column data.txt',\n\t\t\t'date +%Y-%m-%d',\n\t\t\t'find . -name \"*.txt\"',\n\t\t\t'grep pattern file.txt',\n\t\t\t'sort file.txt',\n\t\t\t'tree directory'\n\t\t];\n\t\tconst confirmationRequiredTestCases = [\n\t\t\t// Dangerous file operations\n\t\t\t'rm README.md',\n\t\t\t'rmdir folder',\n\t\t\t'del file.txt',\n\t\t\t'Remove-Item file.txt',\n\t\t\t'ri file.txt',\n\t\t\t'rd folder',\n\t\t\t'erase file.txt',\n\t\t\t'dd if=/dev/zero of=file',\n\n\t\t\t// Process management\n\t\t\t'kill 1234',\n\t\t\t'ps aux',\n\t\t\t'top',\n\t\t\t'Stop-Process -Id 1234',\n\t\t\t'spps notepad',\n\t\t\t'taskkill /f /im notepad.exe',\n\t\t\t'taskkill.exe /f /im cmd.exe',\n\n\t\t\t// Web requests\n\t\t\t'curl https://example.com',\n\t\t\t'wget https://example.com/file',\n\t\t\t'Invoke-RestMethod https://api.example.com',\n\t\t\t'Invoke-WebRequest https://example.com',\n\t\t\t'irm https://example.com',\n\t\t\t'iwr https://example.com',\n\n\t\t\t// File permissions\n\t\t\t'chmod 755 file.sh',\n\t\t\t'chown user:group file.txt',\n\t\t\t'Set-ItemProperty file.txt IsReadOnly $true',\n\t\t\t'sp file.txt IsReadOnly $true',\n\t\t\t'Set-Acl file.txt $acl',\n\n\t\t\t// Command execution\n\t\t\t'jq \\'.name\\' file.json',\n\t\t\t'xargs rm',\n\t\t\t'eval \"echo hello\"',\n\t\t\t'Invoke-Expression \"Get-Date\"',\n\t\t\t'iex \"Write-Host test\"',\n\n\t\t\t// Commands with dangerous arguments\n\t\t\t'column -c 10000 file.txt',\n\t\t\t'date --set=\"2023-01-01\"',\n\t\t\t'find . -delete',\n\t\t\t'find . -exec rm {} \\\\;',\n\t\t\t'find . -execdir rm {} \\\\;',\n\t\t\t'find . -fprint output.txt',\n\t\t\t'sort -o /etc/passwd file.txt',\n\t\t\t'sort -S 100G file.txt',\n\t\t\t'tree -o output.txt',\n\n\t\t\t// Transient environment variables\n\t\t\t'ls=\"test\" curl https://api.example.com',\n\t\t\t'API_KEY=secret curl https://api.example.com',\n\t\t\t'HTTP_PROXY=proxy:8080 wget https://example.com',\n\t\t\t'VAR1=value1 VAR2=value2 echo test',\n\t\t\t'A=1 B=2 C=3 ./script.sh',\n\t\t];\n\n\t\tsuite.skip('auto approved', () => {\n\t\t\tfor (const command of autoApprovedTestCases) {\n\t\t\t\ttest(command.replaceAll('\\n', '\\\\n'), async () => {\n\t\t\t\t\tassertAutoApproved(await executeToolTest({ command }));\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t\tsuite('confirmation required', () => {\n\t\t\tfor (const command of confirmationRequiredTestCases) {\n\t\t\t\ttest(command.replaceAll('\\n', '\\\\n'), async () => {\n\t\t\t\t\tassertConfirmationRequired(await executeToolTest({ command }));\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n\n\tsuite('prepareToolInvocation - auto approval behavior', () => {\n\n\t\ttest('should auto-approve commands in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo hello world' });\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should require confirmation for commands not in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tls: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'rm file.txt',\n\t\t\t\texplanation: 'Remove a file'\n\t\t\t});\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t});\n\n\t\ttest('should require confirmation for commands in deny list even if in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\trm: false,\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'rm dangerous-file.txt',\n\t\t\t\texplanation: 'Remove a dangerous file'\n\t\t\t});\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t});\n\n\t\ttest('should handle background commands with confirmation', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tls: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run watch',\n\t\t\t\texplanation: 'Start watching for file changes',\n\t\t\t\tisBackground: true\n\t\t\t});\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command? (background terminal)');\n\t\t});\n\n\t\ttest('should auto-approve background commands in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tnpm: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run watch',\n\t\t\t\texplanation: 'Start watching for file changes',\n\t\t\t\tisBackground: true\n\t\t\t});\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should include auto-approve info for background commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tnpm: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run watch',\n\t\t\t\texplanation: 'Start watching for file changes',\n\t\t\t\tisBackground: true\n\t\t\t});\n\t\t\tassertAutoApproved(result);\n\n\t\t\t// Verify that auto-approve information is included\n\t\t\tok(result?.toolSpecificData, 'Expected toolSpecificData to be defined');\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst terminalData = result!.toolSpecificData as any;\n\t\t\tok(terminalData.autoApproveInfo, 'Expected autoApproveInfo to be defined for auto-approved background command');\n\t\t\tok(terminalData.autoApproveInfo.value, 'Expected autoApproveInfo to have a value');\n\t\t\tok(terminalData.autoApproveInfo.value.includes('npm'), 'Expected autoApproveInfo to mention the approved rule');\n\t\t});\n\n\t\ttest('should handle regex patterns in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\t'/^git (status|log)/': true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'git status --porcelain' });\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should handle complex command chains with sub-commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true,\n\t\t\t\tls: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo \"hello\" && ls -la' });\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should require confirmation when one sub-command is not approved', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo \"hello\" && rm file.txt' });\n\t\t\tassertConfirmationRequired(result);\n\t\t});\n\n\t\ttest('should handle empty command strings', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: '',\n\t\t\t\texplanation: 'Empty command'\n\t\t\t});\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should handle matchCommandLine: true patterns', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\t'/dangerous/': { approve: false, matchCommandLine: true },\n\t\t\t\t'echo': { approve: true, matchCommandLine: true }\n\t\t\t});\n\n\t\t\tconst result1 = await executeToolTest({ command: 'echo hello world' });\n\t\t\tassertAutoApproved(result1);\n\n\t\t\tconst result2 = await executeToolTest({ command: 'echo this is a dangerous command' });\n\t\t\tassertConfirmationRequired(result2);\n\t\t});\n\n\t\ttest('should only approve when neither sub-commands or command lines are denied', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\t'foo': true,\n\t\t\t\t'/^foo$/': { approve: false, matchCommandLine: true },\n\t\t\t});\n\n\t\t\tconst result1 = await executeToolTest({ command: 'foo' });\n\t\t\tassertConfirmationRequired(result1);\n\n\t\t\tconst result2 = await executeToolTest({ command: 'foo bar' });\n\t\t\tassertAutoApproved(result2);\n\t\t});\n\t});\n\n\tsuite('prepareToolInvocation - custom actions for dropdown', () => {\n\n\t\tfunction assertDropdownActions(result: IPreparedToolInvocation | undefined, items: ({ subCommand: SingleOrMany<string> } | 'commandLine' | '---' | 'configure' | 'sessionApproval')[]) {\n\t\t\tconst actions = result?.confirmationMessages?.terminalCustomActions!;\n\t\t\tok(actions, 'Expected custom actions to be defined');\n\n\t\t\tstrictEqual(actions.length, items.length);\n\n\t\t\tfor (const [i, item] of items.entries()) {\n\t\t\t\tconst action = actions[i];\n\t\t\t\tif (item === '---') {\n\t\t\t\t\tok(isSeparator(action));\n\t\t\t\t} else {\n\t\t\t\t\tok(!isSeparator(action));\n\t\t\t\t\tif (item === 'configure') {\n\t\t\t\t\t\tstrictEqual(action.label, 'Configure Auto Approve...');\n\t\t\t\t\t\tstrictEqual(action.data.type, 'configure');\n\t\t\t\t\t} else if (item === 'sessionApproval') {\n\t\t\t\t\t\tstrictEqual(action.label, 'Allow All Commands in this Session');\n\t\t\t\t\t\tstrictEqual(action.data.type, 'sessionApproval');\n\t\t\t\t\t} else if (item === 'commandLine') {\n\t\t\t\t\t\tstrictEqual(action.label, 'Always Allow Exact Command Line');\n\t\t\t\t\t\tstrictEqual(action.data.type, 'newRule');\n\t\t\t\t\t\tok(!Array.isArray(action.data.rule), 'Expected rule to be an object');\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (Array.isArray(item.subCommand)) {\n\t\t\t\t\t\t\tstrictEqual(action.label, `Always Allow Commands: ${item.subCommand.join(', ')}`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tstrictEqual(action.label, `Always Allow Command: ${item.subCommand}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstrictEqual(action.data.type, 'newRule');\n\t\t\t\t\t\tok(Array.isArray(action.data.rule), 'Expected rule to be an array');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\ttest('should generate custom actions for non-auto-approved commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tls: true,\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build',\n\t\t\t\texplanation: 'Build the project'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm run build' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should generate custom actions for single word commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo',\n\t\t\t\texplanation: 'Run foo command'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not generate custom actions for auto-approved commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tnpm: true\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build',\n\t\t\t\texplanation: 'Build the project'\n\t\t\t});\n\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should only generate configure action for explicitly denied commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tnpm: { approve: false }\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build',\n\t\t\t\texplanation: 'Build the project'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should handle && in command line labels with proper mnemonic escaping', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm install && npm run build',\n\t\t\t\texplanation: 'Install dependencies and build'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['npm install', 'npm run build'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not show approved commands in custom actions dropdown', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\thead: true  // head is approved by default in real scenario\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo | head -20',\n\t\t\t\texplanation: 'Run foo command and show first 20 lines'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not show any command-specific actions when all sub-commands are approved', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tfoo: true,\n\t\t\t\thead: true\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo | head -20',\n\t\t\t\texplanation: 'Run foo command and show first 20 lines'\n\t\t\t});\n\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should handle mixed approved and unapproved commands correctly', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\thead: true,\n\t\t\t\ttail: true\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo | head -20 && bar | tail -10',\n\t\t\t\texplanation: 'Run multiple piped commands'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['foo', 'bar'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest subcommand for git commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'git status',\n\t\t\t\texplanation: 'Check git status'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'git status' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest subcommand for npm commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm test',\n\t\t\t\texplanation: 'Run npm tests'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm test' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest 3-part subcommand for npm run commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build',\n\t\t\t\texplanation: 'Run build script'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm run build' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest 3-part subcommand for yarn run commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'yarn run test',\n\t\t\t\texplanation: 'Run test script'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'yarn run test' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not suggest subcommand for commands with flags', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo --foo --bar',\n\t\t\t\texplanation: 'Run foo with flags'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not suggest subcommand for npm run with flags', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run abc --some-flag',\n\t\t\t\texplanation: 'Run npm run abc with flags'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm run abc' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should handle mixed npm run and other commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build && git status',\n\t\t\t\texplanation: 'Build and check status'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['npm run build', 'git status'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest mixed subcommands and base commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'git push && echo \"done\"',\n\t\t\t\texplanation: 'Push and print done'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['git push', 'echo'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest subcommands for multiple git commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'git status && git log --oneline',\n\t\t\t\texplanation: 'Check status and log'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['git status', 'git log'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest base command for non-subcommand tools', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo bar',\n\t\t\t\texplanation: 'Download from example.com'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should handle single word commands from subcommand-aware tools', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'git',\n\t\t\t\texplanation: 'Run git command'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should deduplicate identical subcommand suggestions', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm test && npm test --verbose',\n\t\t\t\texplanation: 'Run tests twice'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm test' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should handle flags differently than subcommands for suggestion logic', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo --version',\n\t\t\t\texplanation: 'Check foo version'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not suggest overly permissive subcommand rules', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'bash -c \"echo hello\"',\n\t\t\t\texplanation: 'Run bash command'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not show command line option when it\\'s rejected', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true,\n\t\t\t\t'/\\\\(.+\\\\)/s': { approve: false, matchCommandLine: true }\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'echo (abc)'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should prevent auto approval when writing to a file outside the workspace', async () => {\n\t\t\tsetConfig(TerminalChatAgentToolsSettingId.BlockDetectedFileWrites, 'outsideWorkspace');\n\t\t\tsetAutoApprove({});\n\n\t\t\tconst workspaceFolder = URI.file(isWindows ? 'C:/workspace/project' : '/workspace/project');\n\t\t\tconst workspace = new Workspace('test', [toWorkspaceFolder(workspaceFolder)]);\n\t\t\tworkspaceContextService.setWorkspace(workspace);\n\t\t\tinstantiationService.stub(IHistoryService, {\n\t\t\t\tgetLastActiveWorkspaceRoot: () => workspaceFolder\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'echo \"abc\" > ../file.txt'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tstrictEqual(result?.confirmationMessages?.terminalCustomActions, undefined, 'Expected no custom actions when file write is blocked');\n\t\t});\n\t});\n\n\tsuite('chat session disposal cleanup', () => {\n\t\ttest('should dispose associated terminals when chat session is disposed', () => {\n\t\t\tconst sessionId = 'test-session-123';\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst mockTerminal: ITerminalInstance = {\n\t\t\t\tdispose: () => { /* Mock dispose */ },\n\t\t\t\tprocessId: 12345\n\t\t\t} as any;\n\t\t\tlet terminalDisposed = false;\n\t\t\tmockTerminal.dispose = () => { terminalDisposed = true; };\n\n\t\t\trunInTerminalTool.sessionTerminalAssociations.set(sessionId, {\n\t\t\t\tinstance: mockTerminal,\n\t\t\t\tshellIntegrationQuality: ShellIntegrationQuality.None\n\t\t\t});\n\n\t\t\tok(runInTerminalTool.sessionTerminalAssociations.has(sessionId), 'Terminal association should exist before disposal');\n\n\t\t\tchatServiceDisposeEmitter.fire({ sessionResource: LocalChatSessionUri.forSession(sessionId), reason: 'cleared' });\n\n\t\t\tstrictEqual(terminalDisposed, true, 'Terminal should have been disposed');\n\t\t\tok(!runInTerminalTool.sessionTerminalAssociations.has(sessionId), 'Terminal association should be removed after disposal');\n\t\t});\n\n\t\ttest('should not affect other sessions when one session is disposed', () => {\n\t\t\tconst sessionId1 = 'test-session-1';\n\t\t\tconst sessionId2 = 'test-session-2';\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst mockTerminal1: ITerminalInstance = {\n\t\t\t\tdispose: () => { /* Mock dispose */ },\n\t\t\t\tprocessId: 12345\n\t\t\t} as any;\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst mockTerminal2: ITerminalInstance = {\n\t\t\t\tdispose: () => { /* Mock dispose */ },\n\t\t\t\tprocessId: 67890\n\t\t\t} as any;\n\n\t\t\tlet terminal1Disposed = false;\n\t\t\tlet terminal2Disposed = false;\n\t\t\tmockTerminal1.dispose = () => { terminal1Disposed = true; };\n\t\t\tmockTerminal2.dispose = () => { terminal2Disposed = true; };\n\n\t\t\trunInTerminalTool.sessionTerminalAssociations.set(sessionId1, {\n\t\t\t\tinstance: mockTerminal1,\n\t\t\t\tshellIntegrationQuality: ShellIntegrationQuality.None\n\t\t\t});\n\t\t\trunInTerminalTool.sessionTerminalAssociations.set(sessionId2, {\n\t\t\t\tinstance: mockTerminal2,\n\t\t\t\tshellIntegrationQuality: ShellIntegrationQuality.None\n\t\t\t});\n\n\t\t\tok(runInTerminalTool.sessionTerminalAssociations.has(sessionId1), 'Session 1 terminal association should exist');\n\t\t\tok(runInTerminalTool.sessionTerminalAssociations.has(sessionId2), 'Session 2 terminal association should exist');\n\n\t\t\tchatServiceDisposeEmitter.fire({ sessionResource: LocalChatSessionUri.forSession(sessionId1), reason: 'cleared' });\n\n\t\t\tstrictEqual(terminal1Disposed, true, 'Terminal 1 should have been disposed');\n\t\t\tstrictEqual(terminal2Disposed, false, 'Terminal 2 should NOT have been disposed');\n\t\t\tok(!runInTerminalTool.sessionTerminalAssociations.has(sessionId1), 'Session 1 terminal association should be removed');\n\t\t\tok(runInTerminalTool.sessionTerminalAssociations.has(sessionId2), 'Session 2 terminal association should remain');\n\t\t});\n\n\t\ttest('should handle disposal of non-existent session gracefully', () => {\n\t\t\tstrictEqual(runInTerminalTool.sessionTerminalAssociations.size, 0, 'No associations should exist initially');\n\t\t\tchatServiceDisposeEmitter.fire({ sessionResource: LocalChatSessionUri.forSession('non-existent-session'), reason: 'cleared' });\n\t\t\tstrictEqual(runInTerminalTool.sessionTerminalAssociations.size, 0, 'No associations should exist after handling non-existent session');\n\t\t});\n\t});\n\n\tsuite('auto approve warning acceptance mechanism', () => {\n\t\ttest('should require confirmation for auto-approvable commands when warning not accepted', async () => {\n\t\t\tsetConfig(TerminalChatAgentToolsSettingId.EnableAutoApprove, true);\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tclearAutoApproveWarningAcceptedState();\n\n\t\t\tassertConfirmationRequired(await executeToolTest({ command: 'echo hello world' }), 'Run `bash` command?');\n\t\t});\n\n\t\ttest('should auto-approve commands when both auto-approve enabled and warning accepted', async () => {\n\t\t\tsetConfig(TerminalChatAgentToolsSettingId.EnableAutoApprove, true);\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tassertAutoApproved(await executeToolTest({ command: 'echo hello world' }));\n\t\t});\n\n\t\ttest('should require confirmation when auto-approve disabled regardless of warning acceptance', async () => {\n\t\t\tsetConfig(TerminalChatAgentToolsSettingId.EnableAutoApprove, false);\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo hello world' });\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t});\n\t});\n\n\tsuite('unique rules deduplication', () => {\n\t\ttest('should properly deduplicate rules with same sourceText in auto-approve info', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo hello && echo world' });\n\t\t\tassertAutoApproved(result);\n\n\t\t\tconst autoApproveInfo = (result!.toolSpecificData as IChatTerminalToolInvocationData).autoApproveInfo!;\n\t\t\tok(autoApproveInfo);\n\t\t\tok(autoApproveInfo.value.includes('Auto approved by rule '), 'should contain singular \"rule\", not plural');\n\t\t\tstrictEqual(count(autoApproveInfo.value, 'echo'), 1);\n\t\t});\n\t});\n\n\tsuite('session auto approval', () => {\n\t\ttest('should auto approve all commands when session has auto approval enabled', async () => {\n\t\t\tconst sessionId = 'test-session-123';\n\t\t\tconst terminalChatService = instantiationService.get(ITerminalChatService);\n\n\t\t\tconst context: IToolInvocationPreparationContext = {\n\t\t\t\tparameters: {\n\t\t\t\t\tcommand: 'rm dangerous-file.txt',\n\t\t\t\t\texplanation: 'Remove a file',\n\t\t\t\t\tisBackground: false\n\t\t\t\t} as IRunInTerminalInputParams,\n\t\t\t\tchatSessionId: sessionId\n\t\t\t} as IToolInvocationPreparationContext;\n\n\t\t\tlet result = await runInTerminalTool.prepareToolInvocation(context, CancellationToken.None);\n\t\t\tassertConfirmationRequired(result);\n\n\t\t\tterminalChatService.setChatSessionAutoApproval(sessionId, true);\n\n\t\t\tresult = await runInTerminalTool.prepareToolInvocation(context, CancellationToken.None);\n\t\t\tassertAutoApproved(result);\n\n\t\t\tconst terminalData = result!.toolSpecificData as IChatTerminalToolInvocationData;\n\t\t\tok(terminalData.autoApproveInfo, 'Expected autoApproveInfo to be defined');\n\t\t\tok(terminalData.autoApproveInfo.value.includes('Auto approved for this session'), 'Expected session approval message');\n\t\t});\n\t});\n\n\tsuite('TerminalProfileFetcher', () => {\n\t\tsuite('getCopilotProfile', () => {\n\t\t\t(isWindows ? test : test.skip)('should return custom profile when configured', async () => {\n\t\t\t\trunInTerminalTool.setBackendOs(OperatingSystem.Windows);\n\t\t\t\tconst customProfile = Object.freeze({ path: 'C:\\\\Windows\\\\System32\\\\powershell.exe', args: ['-NoProfile'] });\n\t\t\t\tsetConfig(TerminalChatAgentToolsSettingId.TerminalProfileWindows, customProfile);\n\n\t\t\t\tconst result = await runInTerminalTool.profileFetcher.getCopilotProfile();\n\t\t\t\tstrictEqual(result, customProfile);\n\t\t\t});\n\n\t\t\t(isLinux ? test : test.skip)('should fall back to default shell when no custom profile is configured', async () => {\n\t\t\t\trunInTerminalTool.setBackendOs(OperatingSystem.Linux);\n\t\t\t\tsetConfig(TerminalChatAgentToolsSettingId.TerminalProfileLinux, null);\n\n\t\t\t\tconst result = await runInTerminalTool.profileFetcher.getCopilotProfile();\n\t\t\t\tstrictEqual(typeof result, 'object');\n\t\t\t\tstrictEqual((result as ITerminalProfile).path, 'bash');\n\t\t\t});\n\t\t});\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ok, strictEqual } from 'assert';\nimport { Separator } from '../../../../../../base/common/actions.js';\nimport { CancellationToken } from '../../../../../../base/common/cancellation.js';\nimport { Emitter } from '../../../../../../base/common/event.js';\nimport { Schemas } from '../../../../../../base/common/network.js';\nimport { isLinux, isWindows, OperatingSystem } from '../../../../../../base/common/platform.js';\nimport { count } from '../../../../../../base/common/strings.js';\nimport type { SingleOrMany } from '../../../../../../base/common/types.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { ITreeSitterLibraryService } from '../../../../../../editor/common/services/treeSitter/treeSitterLibraryService.js';\nimport { ConfigurationTarget } from '../../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { IFileService } from '../../../../../../platform/files/common/files.js';\nimport { FileService } from '../../../../../../platform/files/common/fileService.js';\nimport type { TestInstantiationService } from '../../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { NullLogService } from '../../../../../../platform/log/common/log.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../../platform/storage/common/storage.js';\nimport { ITerminalProfile } from '../../../../../../platform/terminal/common/terminal.js';\nimport { IWorkspaceContextService, toWorkspaceFolder } from '../../../../../../platform/workspace/common/workspace.js';\nimport { Workspace } from '../../../../../../platform/workspace/test/common/testWorkspace.js';\nimport { IHistoryService } from '../../../../../services/history/common/history.js';\nimport { TreeSitterLibraryService } from '../../../../../services/treeSitter/browser/treeSitterLibraryService.js';\nimport { workbenchInstantiationService } from '../../../../../test/browser/workbenchTestServices.js';\nimport { TestContextService } from '../../../../../test/common/workbenchTestServices.js';\nimport { TestIPCFileSystemProvider } from '../../../../../test/electron-browser/workbenchTestServices.js';\nimport { TerminalToolConfirmationStorageKeys } from '../../../../chat/browser/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.js';\nimport { IChatService, type IChatTerminalToolInvocationData } from '../../../../chat/common/chatService.js';\nimport { LocalChatSessionUri } from '../../../../chat/common/chatUri.js';\nimport { ILanguageModelToolsService, IPreparedToolInvocation, IToolInvocationPreparationContext, type ToolConfirmationAction } from '../../../../chat/common/languageModelToolsService.js';\nimport { ITerminalChatService, ITerminalService, type ITerminalInstance } from '../../../../terminal/browser/terminal.js';\nimport { ITerminalProfileResolverService } from '../../../../terminal/common/terminal.js';\nimport { RunInTerminalTool, type IRunInTerminalInputParams } from '../../browser/tools/runInTerminalTool.js';\nimport { ShellIntegrationQuality } from '../../browser/toolTerminalCreator.js';\nimport { terminalChatAgentToolsConfiguration, TerminalChatAgentToolsSettingId } from '../../common/terminalChatAgentToolsConfiguration.js';\nimport { TerminalChatService } from '../../../chat/browser/terminalChatService.js';\n\nclass TestRunInTerminalTool extends RunInTerminalTool {\n\tprotected override _osBackend: Promise<OperatingSystem> = Promise.resolve(OperatingSystem.Windows);\n\n\tget sessionTerminalAssociations() { return this._sessionTerminalAssociations; }\n\tget profileFetcher() { return this._profileFetcher; }\n\n\tsetBackendOs(os: OperatingSystem) {\n\t\tthis._osBackend = Promise.resolve(os);\n\t}\n}\n\nsuite('RunInTerminalTool', () => {\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet instantiationService: TestInstantiationService;\n\tlet configurationService: TestConfigurationService;\n\tlet fileService: IFileService;\n\tlet storageService: IStorageService;\n\tlet workspaceContextService: TestContextService;\n\tlet terminalServiceDisposeEmitter: Emitter<ITerminalInstance>;\n\tlet chatServiceDisposeEmitter: Emitter<{ sessionResource: URI; reason: 'cleared' }>;\n\n\tlet runInTerminalTool: TestRunInTerminalTool;\n\n\tsetup(() => {\n\t\tconfigurationService = new TestConfigurationService();\n\t\tworkspaceContextService = new TestContextService();\n\n\t\tconst logService = new NullLogService();\n\t\tfileService = store.add(new FileService(logService));\n\t\tconst fileSystemProvider = new TestIPCFileSystemProvider();\n\t\tstore.add(fileService.registerProvider(Schemas.file, fileSystemProvider));\n\n\t\tsetConfig(TerminalChatAgentToolsSettingId.EnableAutoApprove, true);\n\t\tterminalServiceDisposeEmitter = new Emitter<ITerminalInstance>();\n\t\tchatServiceDisposeEmitter = new Emitter<{ sessionResource: URI; reason: 'cleared' }>();\n\n\t\tinstantiationService = workbenchInstantiationService({\n\t\t\tconfigurationService: () => configurationService,\n\t\t\tfileService: () => fileService,\n\t\t}, store);\n\n\t\tinstantiationService.stub(ITerminalChatService, store.add(instantiationService.createInstance(TerminalChatService)));\n\t\tinstantiationService.stub(IWorkspaceContextService, workspaceContextService);\n\t\tinstantiationService.stub(IHistoryService, {\n\t\t\tgetLastActiveWorkspaceRoot: () => undefined\n\t\t});\n\n\t\tconst treeSitterLibraryService = store.add(instantiationService.createInstance(TreeSitterLibraryService));\n\t\ttreeSitterLibraryService.isTest = true;\n\t\tinstantiationService.stub(ITreeSitterLibraryService, treeSitterLibraryService);\n\n\t\tinstantiationService.stub(ILanguageModelToolsService, {\n\t\t\tgetTools() {\n\t\t\t\treturn [];\n\t\t\t},\n\t\t});\n\t\tinstantiationService.stub(ITerminalService, {\n\t\t\tonDidDisposeInstance: terminalServiceDisposeEmitter.event,\n\t\t\tsetNextCommandId: async () => { }\n\t\t});\n\t\tinstantiationService.stub(IChatService, {\n\t\t\tonDidDisposeSession: chatServiceDisposeEmitter.event\n\t\t});\n\t\tinstantiationService.stub(ITerminalProfileResolverService, {\n\t\t\tgetDefaultProfile: async () => ({ path: 'bash' } as ITerminalProfile)\n\t\t});\n\n\t\tstorageService = instantiationService.get(IStorageService);\n\t\tstorageService.store(TerminalToolConfirmationStorageKeys.TerminalAutoApproveWarningAccepted, true, StorageScope.APPLICATION, StorageTarget.USER);\n\n\t\trunInTerminalTool = store.add(instantiationService.createInstance(TestRunInTerminalTool));\n\t});\n\n\tfunction setAutoApprove(value: { [key: string]: { approve: boolean; matchCommandLine?: boolean } | boolean }) {\n\t\tsetConfig(TerminalChatAgentToolsSettingId.AutoApprove, value);\n\t}\n\n\tfunction setConfig(key: string, value: unknown) {\n\t\tconfigurationService.setUserConfiguration(key, value);\n\t\tconfigurationService.onDidChangeConfigurationEmitter.fire({\n\t\t\taffectsConfiguration: () => true,\n\t\t\taffectedKeys: new Set([key]),\n\t\t\tsource: ConfigurationTarget.USER,\n\t\t\tchange: null!,\n\t\t});\n\t}\n\n\tfunction clearAutoApproveWarningAcceptedState() {\n\t\tstorageService.remove(TerminalToolConfirmationStorageKeys.TerminalAutoApproveWarningAccepted, StorageScope.APPLICATION);\n\t}\n\n\t/**\n\t * Executes a test scenario for the RunInTerminalTool\n\t */\n\tasync function executeToolTest(\n\t\tparams: Partial<IRunInTerminalInputParams>\n\t): Promise<IPreparedToolInvocation | undefined> {\n\t\tconst context: IToolInvocationPreparationContext = {\n\t\t\tparameters: {\n\t\t\t\tcommand: 'echo hello',\n\t\t\t\texplanation: 'Print hello to the console',\n\t\t\t\tisBackground: false,\n\t\t\t\t...params\n\t\t\t} as IRunInTerminalInputParams\n\t\t} as IToolInvocationPreparationContext;\n\n\t\tconst result = await runInTerminalTool.prepareToolInvocation(context, CancellationToken.None);\n\t\treturn result;\n\t}\n\n\tfunction isSeparator(action: ToolConfirmationAction): action is Separator {\n\t\treturn action instanceof Separator;\n\t}\n\n\t/**\n\t * Helper to assert that a command should be auto-approved (no confirmation required)\n\t */\n\tfunction assertAutoApproved(preparedInvocation: IPreparedToolInvocation | undefined) {\n\t\tok(preparedInvocation, 'Expected prepared invocation to be defined');\n\t\tok(!preparedInvocation.confirmationMessages, 'Expected no confirmation messages for auto-approved command');\n\t}\n\n\t/**\n\t * Helper to assert that a command requires confirmation\n\t */\n\tfunction assertConfirmationRequired(preparedInvocation: IPreparedToolInvocation | undefined, expectedTitle?: string) {\n\t\tok(preparedInvocation, 'Expected prepared invocation to be defined');\n\t\tok(preparedInvocation.confirmationMessages, 'Expected confirmation messages for non-approved command');\n\t\tif (expectedTitle) {\n\t\t\tstrictEqual(preparedInvocation.confirmationMessages!.title, expectedTitle);\n\t\t}\n\t}\n\n\tsuite('default auto-approve rules', () => {\n\t\tconst defaults = terminalChatAgentToolsConfiguration[TerminalChatAgentToolsSettingId.AutoApprove].default as Record<string, boolean | { approve: boolean; matchCommandLine?: boolean }>;\n\n\t\tsuiteSetup(() => {\n\t\t\t// Sanity check on entries to make sure that the defaults are actually pulled in\n\t\t\tok(Object.keys(defaults).length > 50);\n\t\t});\n\t\tsetup(() => {\n\t\t\tsetAutoApprove(defaults);\n\t\t});\n\n\t\tconst autoApprovedTestCases = [\n\t\t\t// Safe commands\n\t\t\t'echo abc',\n\t\t\t'echo \"abc\"',\n\t\t\t'echo \\'abc\\'',\n\t\t\t'ls -la',\n\t\t\t'pwd',\n\t\t\t'cat file.txt',\n\t\t\t'head -n 10 file.txt',\n\t\t\t'tail -f log.txt',\n\t\t\t'findstr pattern file.txt',\n\t\t\t'wc -l file.txt',\n\t\t\t'tr a-z A-Z',\n\t\t\t'cut -d: -f1',\n\t\t\t'cmp file1 file2',\n\t\t\t'which node',\n\t\t\t'basename /path/to/file',\n\t\t\t'dirname /path/to/file',\n\t\t\t'realpath .',\n\t\t\t'readlink symlink',\n\t\t\t'stat file.txt',\n\t\t\t'file document.pdf',\n\t\t\t'du -sh folder',\n\t\t\t'df -h',\n\t\t\t'sleep 5',\n\t\t\t'cd /home/user',\n\t\t\t'nl -ba path/to/file.txt',\n\n\t\t\t// Safe git sub-commands\n\t\t\t'git status',\n\t\t\t'git log --oneline',\n\t\t\t'git show HEAD',\n\t\t\t'git diff main',\n\t\t\t'git grep \"TODO\"',\n\n\t\t\t// PowerShell commands\n\t\t\t'Get-ChildItem',\n\t\t\t'Get-Date',\n\t\t\t'Get-Random',\n\t\t\t'Get-Location',\n\t\t\t'Write-Host \"Hello\"',\n\t\t\t'Write-Output \"Test\"',\n\t\t\t'Split-Path C:\\\\Users\\\\test',\n\t\t\t'Join-Path C:\\\\Users test',\n\t\t\t'Start-Sleep 2',\n\n\t\t\t// PowerShell safe verbs (regex patterns)\n\t\t\t'Select-Object Name',\n\t\t\t'Measure-Object Length',\n\t\t\t'Compare-Object $a $b',\n\t\t\t'Format-Table',\n\t\t\t'Sort-Object Name',\n\n\t\t\t// Commands with acceptable arguments\n\t\t\t'column data.txt',\n\t\t\t'date +%Y-%m-%d',\n\t\t\t'find . -name \"*.txt\"',\n\t\t\t'grep pattern file.txt',\n\t\t\t'sort file.txt',\n\t\t\t'tree directory'\n\t\t];\n\t\tconst confirmationRequiredTestCases = [\n\t\t\t// Dangerous file operations\n\t\t\t'rm README.md',\n\t\t\t'rmdir folder',\n\t\t\t'del file.txt',\n\t\t\t'Remove-Item file.txt',\n\t\t\t'ri file.txt',\n\t\t\t'rd folder',\n\t\t\t'erase file.txt',\n\t\t\t'dd if=/dev/zero of=file',\n\n\t\t\t// Process management\n\t\t\t'kill 1234',\n\t\t\t'ps aux',\n\t\t\t'top',\n\t\t\t'Stop-Process -Id 1234',\n\t\t\t'spps notepad',\n\t\t\t'taskkill /f /im notepad.exe',\n\t\t\t'taskkill.exe /f /im cmd.exe',\n\n\t\t\t// Web requests\n\t\t\t'curl https://example.com',\n\t\t\t'wget https://example.com/file',\n\t\t\t'Invoke-RestMethod https://api.example.com',\n\t\t\t'Invoke-WebRequest https://example.com',\n\t\t\t'irm https://example.com',\n\t\t\t'iwr https://example.com',\n\n\t\t\t// File permissions\n\t\t\t'chmod 755 file.sh',\n\t\t\t'chown user:group file.txt',\n\t\t\t'Set-ItemProperty file.txt IsReadOnly $true',\n\t\t\t'sp file.txt IsReadOnly $true',\n\t\t\t'Set-Acl file.txt $acl',\n\n\t\t\t// Command execution\n\t\t\t'jq \\'.name\\' file.json',\n\t\t\t'xargs rm',\n\t\t\t'eval \"echo hello\"',\n\t\t\t'Invoke-Expression \"Get-Date\"',\n\t\t\t'iex \"Write-Host test\"',\n\n\t\t\t// Commands with dangerous arguments\n\t\t\t'column -c 10000 file.txt',\n\t\t\t'date --set=\"2023-01-01\"',\n\t\t\t'find . -delete',\n\t\t\t'find . -exec rm {} \\\\;',\n\t\t\t'find . -execdir rm {} \\\\;',\n\t\t\t'find . -fprint output.txt',\n\t\t\t'sort -o /etc/passwd file.txt',\n\t\t\t'sort -S 100G file.txt',\n\t\t\t'tree -o output.txt',\n\n\t\t\t// Transient environment variables\n\t\t\t'ls=\"test\" curl https://api.example.com',\n\t\t\t'API_KEY=secret curl https://api.example.com',\n\t\t\t'HTTP_PROXY=proxy:8080 wget https://example.com',\n\t\t\t'VAR1=value1 VAR2=value2 echo test',\n\t\t\t'A=1 B=2 C=3 ./script.sh',\n\t\t];\n\n\t\tsuite.skip('auto approved', () => {\n\t\t\tfor (const command of autoApprovedTestCases) {\n\t\t\t\ttest(command.replaceAll('\\n', '\\\\n'), async () => {\n\t\t\t\t\tassertAutoApproved(await executeToolTest({ command }));\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t\tsuite('confirmation required', () => {\n\t\t\tfor (const command of confirmationRequiredTestCases) {\n\t\t\t\ttest(command.replaceAll('\\n', '\\\\n'), async () => {\n\t\t\t\t\tassertConfirmationRequired(await executeToolTest({ command }));\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t});\n\n\tsuite('prepareToolInvocation - auto approval behavior', () => {\n\n\t\ttest('should auto-approve commands in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo hello world' });\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should require confirmation for commands not in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tls: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'rm file.txt',\n\t\t\t\texplanation: 'Remove a file'\n\t\t\t});\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t});\n\n\t\ttest('should require confirmation for commands in deny list even if in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\trm: false,\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'rm dangerous-file.txt',\n\t\t\t\texplanation: 'Remove a dangerous file'\n\t\t\t});\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t});\n\n\t\ttest('should handle background commands with confirmation', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tls: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run watch',\n\t\t\t\texplanation: 'Start watching for file changes',\n\t\t\t\tisBackground: true\n\t\t\t});\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command? (background terminal)');\n\t\t});\n\n\t\ttest('should auto-approve background commands in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tnpm: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run watch',\n\t\t\t\texplanation: 'Start watching for file changes',\n\t\t\t\tisBackground: true\n\t\t\t});\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should include auto-approve info for background commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tnpm: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run watch',\n\t\t\t\texplanation: 'Start watching for file changes',\n\t\t\t\tisBackground: true\n\t\t\t});\n\t\t\tassertAutoApproved(result);\n\n\t\t\t// Verify that auto-approve information is included\n\t\t\tok(result?.toolSpecificData, 'Expected toolSpecificData to be defined');\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst terminalData = result!.toolSpecificData as any;\n\t\t\tok(terminalData.autoApproveInfo, 'Expected autoApproveInfo to be defined for auto-approved background command');\n\t\t\tok(terminalData.autoApproveInfo.value, 'Expected autoApproveInfo to have a value');\n\t\t\tok(terminalData.autoApproveInfo.value.includes('npm'), 'Expected autoApproveInfo to mention the approved rule');\n\t\t});\n\n\t\ttest('should handle regex patterns in allow list', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\t'/^git (status|log)/': true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'git status --porcelain' });\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should handle complex command chains with sub-commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true,\n\t\t\t\tls: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo \"hello\" && ls -la' });\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should require confirmation when one sub-command is not approved', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo \"hello\" && rm file.txt' });\n\t\t\tassertConfirmationRequired(result);\n\t\t});\n\n\t\ttest('should handle empty command strings', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: '',\n\t\t\t\texplanation: 'Empty command'\n\t\t\t});\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should handle matchCommandLine: true patterns', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\t'/dangerous/': { approve: false, matchCommandLine: true },\n\t\t\t\t'echo': { approve: true, matchCommandLine: true }\n\t\t\t});\n\n\t\t\tconst result1 = await executeToolTest({ command: 'echo hello world' });\n\t\t\tassertAutoApproved(result1);\n\n\t\t\tconst result2 = await executeToolTest({ command: 'echo this is a dangerous command' });\n\t\t\tassertConfirmationRequired(result2);\n\t\t});\n\n\t\ttest('should only approve when neither sub-commands or command lines are denied', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\t'foo': true,\n\t\t\t\t'/^foo$/': { approve: false, matchCommandLine: true },\n\t\t\t});\n\n\t\t\tconst result1 = await executeToolTest({ command: 'foo' });\n\t\t\tassertConfirmationRequired(result1);\n\n\t\t\tconst result2 = await executeToolTest({ command: 'foo bar' });\n\t\t\tassertAutoApproved(result2);\n\t\t});\n\t});\n\n\tsuite('prepareToolInvocation - custom actions for dropdown', () => {\n\n\t\tfunction assertDropdownActions(result: IPreparedToolInvocation | undefined, items: ({ subCommand: SingleOrMany<string> } | 'commandLine' | '---' | 'configure' | 'sessionApproval')[]) {\n\t\t\tconst actions = result?.confirmationMessages?.terminalCustomActions!;\n\t\t\tok(actions, 'Expected custom actions to be defined');\n\n\t\t\tstrictEqual(actions.length, items.length);\n\n\t\t\tfor (const [i, item] of items.entries()) {\n\t\t\t\tconst action = actions[i];\n\t\t\t\tif (item === '---') {\n\t\t\t\t\tok(isSeparator(action));\n\t\t\t\t} else {\n\t\t\t\t\tok(!isSeparator(action));\n\t\t\t\t\tif (item === 'configure') {\n\t\t\t\t\t\tstrictEqual(action.label, 'Configure Auto Approve...');\n\t\t\t\t\t\tstrictEqual(action.data.type, 'configure');\n\t\t\t\t\t} else if (item === 'sessionApproval') {\n\t\t\t\t\t\tstrictEqual(action.label, 'Allow All Commands in this Session');\n\t\t\t\t\t\tstrictEqual(action.data.type, 'sessionApproval');\n\t\t\t\t\t} else if (item === 'commandLine') {\n\t\t\t\t\t\tstrictEqual(action.label, 'Always Allow Exact Command Line');\n\t\t\t\t\t\tstrictEqual(action.data.type, 'newRule');\n\t\t\t\t\t\tok(!Array.isArray(action.data.rule), 'Expected rule to be an object');\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (Array.isArray(item.subCommand)) {\n\t\t\t\t\t\t\tstrictEqual(action.label, `Always Allow Commands: ${item.subCommand.join(', ')}`);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tstrictEqual(action.label, `Always Allow Command: ${item.subCommand}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstrictEqual(action.data.type, 'newRule');\n\t\t\t\t\t\tok(Array.isArray(action.data.rule), 'Expected rule to be an array');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\ttest('should generate custom actions for non-auto-approved commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tls: true,\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build',\n\t\t\t\texplanation: 'Build the project'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm run build' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should generate custom actions for single word commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo',\n\t\t\t\texplanation: 'Run foo command'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not generate custom actions for auto-approved commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tnpm: true\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build',\n\t\t\t\texplanation: 'Build the project'\n\t\t\t});\n\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should only generate configure action for explicitly denied commands', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tnpm: { approve: false }\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build',\n\t\t\t\texplanation: 'Build the project'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should handle && in command line labels with proper mnemonic escaping', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm install && npm run build',\n\t\t\t\texplanation: 'Install dependencies and build'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['npm install', 'npm run build'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not show approved commands in custom actions dropdown', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\thead: true  // head is approved by default in real scenario\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo | head -20',\n\t\t\t\texplanation: 'Run foo command and show first 20 lines'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not show any command-specific actions when all sub-commands are approved', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\tfoo: true,\n\t\t\t\thead: true\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo | head -20',\n\t\t\t\texplanation: 'Run foo command and show first 20 lines'\n\t\t\t});\n\n\t\t\tassertAutoApproved(result);\n\t\t});\n\n\t\ttest('should handle mixed approved and unapproved commands correctly', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\thead: true,\n\t\t\t\ttail: true\n\t\t\t});\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo | head -20 && bar | tail -10',\n\t\t\t\texplanation: 'Run multiple piped commands'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['foo', 'bar'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest subcommand for git commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'git status',\n\t\t\t\texplanation: 'Check git status'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'git status' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest subcommand for npm commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm test',\n\t\t\t\texplanation: 'Run npm tests'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm test' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest 3-part subcommand for npm run commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build',\n\t\t\t\texplanation: 'Run build script'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm run build' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest 3-part subcommand for yarn run commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'yarn run test',\n\t\t\t\texplanation: 'Run test script'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'yarn run test' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not suggest subcommand for commands with flags', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo --foo --bar',\n\t\t\t\texplanation: 'Run foo with flags'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not suggest subcommand for npm run with flags', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run abc --some-flag',\n\t\t\t\texplanation: 'Run npm run abc with flags'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm run abc' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should handle mixed npm run and other commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm run build && git status',\n\t\t\t\texplanation: 'Build and check status'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['npm run build', 'git status'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest mixed subcommands and base commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'git push && echo \"done\"',\n\t\t\t\texplanation: 'Push and print done'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['git push', 'echo'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest subcommands for multiple git commands', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'git status && git log --oneline',\n\t\t\t\texplanation: 'Check status and log'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: ['git status', 'git log'] },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should suggest base command for non-subcommand tools', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo bar',\n\t\t\t\texplanation: 'Download from example.com'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should handle single word commands from subcommand-aware tools', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'git',\n\t\t\t\texplanation: 'Run git command'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should deduplicate identical subcommand suggestions', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'npm test && npm test --verbose',\n\t\t\t\texplanation: 'Run tests twice'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'npm test' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should handle flags differently than subcommands for suggestion logic', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'foo --version',\n\t\t\t\texplanation: 'Check foo version'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t{ subCommand: 'foo' },\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not suggest overly permissive subcommand rules', async () => {\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'bash -c \"echo hello\"',\n\t\t\t\texplanation: 'Run bash command'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t'commandLine',\n\t\t\t\t'---',\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should not show command line option when it\\'s rejected', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true,\n\t\t\t\t'/\\\\(.+\\\\)/s': { approve: false, matchCommandLine: true }\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'echo (abc)'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tassertDropdownActions(result, [\n\t\t\t\t'sessionApproval',\n\t\t\t\t'---',\n\t\t\t\t'configure',\n\t\t\t]);\n\t\t});\n\n\t\ttest('should prevent auto approval when writing to a file outside the workspace', async () => {\n\t\t\tsetConfig(TerminalChatAgentToolsSettingId.BlockDetectedFileWrites, 'outsideWorkspace');\n\t\t\tsetAutoApprove({});\n\n\t\t\tconst workspaceFolder = URI.file(isWindows ? 'C:/workspace/project' : '/workspace/project');\n\t\t\tconst workspace = new Workspace('test', [toWorkspaceFolder(workspaceFolder)]);\n\t\t\tworkspaceContextService.setWorkspace(workspace);\n\t\t\tinstantiationService.stub(IHistoryService, {\n\t\t\t\tgetLastActiveWorkspaceRoot: () => workspaceFolder\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({\n\t\t\t\tcommand: 'echo \"abc\" > ../file.txt'\n\t\t\t});\n\n\t\t\tassertConfirmationRequired(result);\n\t\t\tstrictEqual(result?.confirmationMessages?.terminalCustomActions, undefined, 'Expected no custom actions when file write is blocked');\n\t\t});\n\t});\n\n\tsuite('chat session disposal cleanup', () => {\n\t\ttest('should dispose associated terminals when chat session is disposed', () => {\n\t\t\tconst sessionId = 'test-session-123';\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst mockTerminal: ITerminalInstance = {\n\t\t\t\tdispose: () => { /* Mock dispose */ },\n\t\t\t\tprocessId: 12345\n\t\t\t} as any;\n\t\t\tlet terminalDisposed = false;\n\t\t\tmockTerminal.dispose = () => { terminalDisposed = true; };\n\n\t\t\trunInTerminalTool.sessionTerminalAssociations.set(sessionId, {\n\t\t\t\tinstance: mockTerminal,\n\t\t\t\tshellIntegrationQuality: ShellIntegrationQuality.None\n\t\t\t});\n\n\t\t\tok(runInTerminalTool.sessionTerminalAssociations.has(sessionId), 'Terminal association should exist before disposal');\n\n\t\t\tchatServiceDisposeEmitter.fire({ sessionResource: LocalChatSessionUri.forSession(sessionId), reason: 'cleared' });\n\n\t\t\tstrictEqual(terminalDisposed, true, 'Terminal should have been disposed');\n\t\t\tok(!runInTerminalTool.sessionTerminalAssociations.has(sessionId), 'Terminal association should be removed after disposal');\n\t\t});\n\n\t\ttest('should not affect other sessions when one session is disposed', () => {\n\t\t\tconst sessionId1 = 'test-session-1';\n\t\t\tconst sessionId2 = 'test-session-2';\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst mockTerminal1: ITerminalInstance = {\n\t\t\t\tdispose: () => { /* Mock dispose */ },\n\t\t\t\tprocessId: 12345\n\t\t\t} as any;\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tconst mockTerminal2: ITerminalInstance = {\n\t\t\t\tdispose: () => { /* Mock dispose */ },\n\t\t\t\tprocessId: 67890\n\t\t\t} as any;\n\n\t\t\tlet terminal1Disposed = false;\n\t\t\tlet terminal2Disposed = false;\n\t\t\tmockTerminal1.dispose = () => { terminal1Disposed = true; };\n\t\t\tmockTerminal2.dispose = () => { terminal2Disposed = true; };\n\n\t\t\trunInTerminalTool.sessionTerminalAssociations.set(sessionId1, {\n\t\t\t\tinstance: mockTerminal1,\n\t\t\t\tshellIntegrationQuality: ShellIntegrationQuality.None\n\t\t\t});\n\t\t\trunInTerminalTool.sessionTerminalAssociations.set(sessionId2, {\n\t\t\t\tinstance: mockTerminal2,\n\t\t\t\tshellIntegrationQuality: ShellIntegrationQuality.None\n\t\t\t});\n\n\t\t\tok(runInTerminalTool.sessionTerminalAssociations.has(sessionId1), 'Session 1 terminal association should exist');\n\t\t\tok(runInTerminalTool.sessionTerminalAssociations.has(sessionId2), 'Session 2 terminal association should exist');\n\n\t\t\tchatServiceDisposeEmitter.fire({ sessionResource: LocalChatSessionUri.forSession(sessionId1), reason: 'cleared' });\n\n\t\t\tstrictEqual(terminal1Disposed, true, 'Terminal 1 should have been disposed');\n\t\t\tstrictEqual(terminal2Disposed, false, 'Terminal 2 should NOT have been disposed');\n\t\t\tok(!runInTerminalTool.sessionTerminalAssociations.has(sessionId1), 'Session 1 terminal association should be removed');\n\t\t\tok(runInTerminalTool.sessionTerminalAssociations.has(sessionId2), 'Session 2 terminal association should remain');\n\t\t});\n\n\t\ttest('should handle disposal of non-existent session gracefully', () => {\n\t\t\tstrictEqual(runInTerminalTool.sessionTerminalAssociations.size, 0, 'No associations should exist initially');\n\t\t\tchatServiceDisposeEmitter.fire({ sessionResource: LocalChatSessionUri.forSession('non-existent-session'), reason: 'cleared' });\n\t\t\tstrictEqual(runInTerminalTool.sessionTerminalAssociations.size, 0, 'No associations should exist after handling non-existent session');\n\t\t});\n\t});\n\n\tsuite('auto approve warning acceptance mechanism', () => {\n\t\ttest('should require confirmation for auto-approvable commands when warning not accepted', async () => {\n\t\t\tsetConfig(TerminalChatAgentToolsSettingId.EnableAutoApprove, true);\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tclearAutoApproveWarningAcceptedState();\n\n\t\t\tassertConfirmationRequired(await executeToolTest({ command: 'echo hello world' }), 'Run `bash` command?');\n\t\t});\n\n\t\ttest('should auto-approve commands when both auto-approve enabled and warning accepted', async () => {\n\t\t\tsetConfig(TerminalChatAgentToolsSettingId.EnableAutoApprove, true);\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tassertAutoApproved(await executeToolTest({ command: 'echo hello world' }));\n\t\t});\n\n\t\ttest('should require confirmation when auto-approve disabled regardless of warning acceptance', async () => {\n\t\t\tsetConfig(TerminalChatAgentToolsSettingId.EnableAutoApprove, false);\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo hello world' });\n\t\t\tassertConfirmationRequired(result, 'Run `bash` command?');\n\t\t});\n\t});\n\n\tsuite('unique rules deduplication', () => {\n\t\ttest('should properly deduplicate rules with same sourceText in auto-approve info', async () => {\n\t\t\tsetAutoApprove({\n\t\t\t\techo: true\n\t\t\t});\n\n\t\t\tconst result = await executeToolTest({ command: 'echo hello && echo world' });\n\t\t\tassertAutoApproved(result);\n\n\t\t\tconst autoApproveInfo = (result!.toolSpecificData as IChatTerminalToolInvocationData).autoApproveInfo!;\n\t\t\tok(autoApproveInfo);\n\t\t\tok(autoApproveInfo.value.includes('Auto approved by rule '), 'should contain singular \"rule\", not plural');\n\t\t\tstrictEqual(count(autoApproveInfo.value, 'echo'), 1);\n\t\t});\n\t});\n\n\tsuite('session auto approval', () => {\n\t\ttest('should auto approve all commands when session has auto approval enabled', async () => {\n\t\t\tconst sessionId = 'test-session-123';\n\t\t\tconst terminalChatService = instantiationService.get(ITerminalChatService);\n\n\t\t\tconst context: IToolInvocationPreparationContext = {\n\t\t\t\tparameters: {\n\t\t\t\t\tcommand: 'rm dangerous-file.txt',\n\t\t\t\t\texplanation: 'Remove a file',\n\t\t\t\t\tisBackground: false\n\t\t\t\t} as IRunInTerminalInputParams,\n\t\t\t\tchatSessionId: sessionId\n\t\t\t} as IToolInvocationPreparationContext;\n\n\t\t\tlet result = await runInTerminalTool.prepareToolInvocation(context, CancellationToken.None);\n\t\t\tassertConfirmationRequired(result);\n\n\t\t\tterminalChatService.setChatSessionAutoApproval(sessionId, true);\n\n\t\t\tresult = await runInTerminalTool.prepareToolInvocation(context, CancellationToken.None);\n\t\t\tassertAutoApproved(result);\n\n\t\t\tconst terminalData = result!.toolSpecificData as IChatTerminalToolInvocationData;\n\t\t\tok(terminalData.autoApproveInfo, 'Expected autoApproveInfo to be defined');\n\t\t\tok(terminalData.autoApproveInfo.value.includes('Auto approved for this session'), 'Expected session approval message');\n\t\t});\n\t});\n\n\tsuite('TerminalProfileFetcher', () => {\n\t\tsuite('getCopilotProfile', () => {\n\t\t\t(isWindows ? test : test.skip)('should return custom profile when configured', async () => {\n\t\t\t\trunInTerminalTool.setBackendOs(OperatingSystem.Windows);\n\t\t\t\tconst customProfile = Object.freeze({ path: 'C:\\\\Windows\\\\System32\\\\powershell.exe', args: ['-NoProfile'] });\n\t\t\t\tsetConfig(TerminalChatAgentToolsSettingId.TerminalProfileWindows, customProfile);\n\n\t\t\t\tconst result = await runInTerminalTool.profileFetcher.getCopilotProfile();\n\t\t\t\tstrictEqual(result, customProfile);\n\t\t\t});\n\n\t\t\t(isLinux ? test : test.skip)('should fall back to default shell when no custom profile is configured', async () => {\n\t\t\t\trunInTerminalTool.setBackendOs(OperatingSystem.Linux);\n\t\t\t\tsetConfig(TerminalChatAgentToolsSettingId.TerminalProfileLinux, null);\n\n\t\t\t\tconst result = await runInTerminalTool.profileFetcher.getCopilotProfile();\n\t\t\t\tstrictEqual(typeof result, 'object');\n\t\t\t\tstrictEqual((result as ITerminalProfile).path, 'bash');\n\t\t\t});\n\t\t});\n\t});\n});\n"]}