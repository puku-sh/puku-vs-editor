{"version":3,"sources":["vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/commandLineAnalyzer/commandLineFileWriteAnalyzer.ts"],"names":[],"mappings":"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","file":"commandLineFileWriteAnalyzer.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../../../../base/common/uri.js';\nimport { win32, posix } from '../../../../../../../base/common/path.js';\nimport { localize } from '../../../../../../../nls.js';\nimport { IConfigurationService } from '../../../../../../../platform/configuration/common/configuration.js';\nimport { IWorkspaceContextService } from '../../../../../../../platform/workspace/common/workspace.js';\nimport { TerminalChatAgentToolsSettingId } from '../../../common/terminalChatAgentToolsConfiguration.js';\nimport { TreeSitterCommandParserLanguage, type TreeSitterCommandParser } from '../../treeSitterCommandParser.js';\nimport type { ICommandLineAnalyzer, ICommandLineAnalyzerOptions, ICommandLineAnalyzerResult } from './commandLineAnalyzer.js';\nimport { OperatingSystem } from '../../../../../../../base/common/platform.js';\nimport { isString } from '../../../../../../../base/common/types.js';\nimport { ILabelService } from '../../../../../../../platform/label/common/label.js';\n\nconst nullDevice = Symbol('null device');\n\ntype FileWrite = URI | string | typeof nullDevice;\n\nexport class CommandLineFileWriteAnalyzer extends Disposable implements ICommandLineAnalyzer {\n\tconstructor(\n\t\tprivate readonly _treeSitterCommandParser: TreeSitterCommandParser,\n\t\tprivate readonly _log: (message: string, ...args: unknown[]) => void,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@ILabelService private readonly _labelService: ILabelService,\n\t\t@IWorkspaceContextService private readonly _workspaceContextService: IWorkspaceContextService,\n\t) {\n\t\tsuper();\n\t}\n\n\tasync analyze(options: ICommandLineAnalyzerOptions): Promise<ICommandLineAnalyzerResult> {\n\t\tlet fileWrites: FileWrite[];\n\t\ttry {\n\t\t\tfileWrites = await this._getFileWrites(options);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t\tthis._log('Failed to get file writes via grammar', options.treeSitterLanguage);\n\t\t\treturn {\n\t\t\t\tisAutoApproveAllowed: false\n\t\t\t};\n\t\t}\n\t\treturn this._getResult(options, fileWrites);\n\t}\n\n\tprivate async _getFileWrites(options: ICommandLineAnalyzerOptions): Promise<FileWrite[]> {\n\t\tlet fileWrites: FileWrite[] = [];\n\t\tconst capturedFileWrites = (await this._treeSitterCommandParser.getFileWrites(options.treeSitterLanguage, options.commandLine))\n\t\t\t.map(this._mapNullDevice.bind(this, options));\n\t\tif (capturedFileWrites.length) {\n\t\t\tconst cwd = options.cwd;\n\t\t\tif (cwd) {\n\t\t\t\tthis._log('Detected cwd', cwd.toString());\n\t\t\t\tfileWrites = capturedFileWrites.map(e => {\n\t\t\t\t\tif (e === nullDevice) {\n\t\t\t\t\t\treturn e;\n\t\t\t\t\t}\n\t\t\t\t\tconst isAbsolute = options.os === OperatingSystem.Windows ? win32.isAbsolute(e) : posix.isAbsolute(e);\n\t\t\t\t\tif (isAbsolute) {\n\t\t\t\t\t\treturn URI.file(e);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn URI.joinPath(cwd, e);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis._log('Cwd could not be detected');\n\t\t\t\tfileWrites = capturedFileWrites;\n\t\t\t}\n\t\t}\n\t\tthis._log('File writes detected', fileWrites.map(e => e.toString()));\n\t\treturn fileWrites;\n\t}\n\n\tprivate _mapNullDevice(options: ICommandLineAnalyzerOptions, rawFileWrite: string): string | typeof nullDevice {\n\t\tif (options.treeSitterLanguage === TreeSitterCommandParserLanguage.PowerShell) {\n\t\t\treturn rawFileWrite === '$null'\n\t\t\t\t? nullDevice\n\t\t\t\t: rawFileWrite;\n\t\t}\n\t\treturn rawFileWrite === '/dev/null'\n\t\t\t? nullDevice\n\t\t\t: rawFileWrite;\n\t}\n\n\tprivate _getResult(options: ICommandLineAnalyzerOptions, fileWrites: FileWrite[]): ICommandLineAnalyzerResult {\n\t\tlet isAutoApproveAllowed = true;\n\t\tif (fileWrites.length > 0) {\n\t\t\tconst blockDetectedFileWrites = this._configurationService.getValue<string>(TerminalChatAgentToolsSettingId.BlockDetectedFileWrites);\n\t\t\tswitch (blockDetectedFileWrites) {\n\t\t\t\tcase 'all': {\n\t\t\t\t\tisAutoApproveAllowed = false;\n\t\t\t\t\tthis._log('File writes blocked due to \"all\" setting');\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'outsideWorkspace': {\n\t\t\t\t\tconst workspaceFolders = this._workspaceContextService.getWorkspace().folders;\n\t\t\t\t\tif (workspaceFolders.length > 0) {\n\t\t\t\t\t\tfor (const fileWrite of fileWrites) {\n\t\t\t\t\t\t\tif (fileWrite === nullDevice) {\n\t\t\t\t\t\t\t\tthis._log('File write to null device allowed', URI.isUri(fileWrite) ? fileWrite.toString() : fileWrite);\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (isString(fileWrite)) {\n\t\t\t\t\t\t\t\tconst isAbsolute = options.os === OperatingSystem.Windows ? win32.isAbsolute(fileWrite) : posix.isAbsolute(fileWrite);\n\t\t\t\t\t\t\t\tif (!isAbsolute) {\n\t\t\t\t\t\t\t\t\tisAutoApproveAllowed = false;\n\t\t\t\t\t\t\t\t\tthis._log('File write blocked due to unknown terminal cwd', fileWrite);\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst fileUri = URI.isUri(fileWrite) ? fileWrite : URI.file(fileWrite);\n\t\t\t\t\t\t\t// TODO: Handle command substitutions/complex destinations properly https://github.com/microsoft/vscode/issues/274167\n\t\t\t\t\t\t\t// TODO: Handle environment variables properly https://github.com/microsoft/vscode/issues/274166\n\t\t\t\t\t\t\tif (fileUri.fsPath.match(/[$\\(\\){}]/)) {\n\t\t\t\t\t\t\t\tisAutoApproveAllowed = false;\n\t\t\t\t\t\t\t\tthis._log('File write blocked due to likely containing a variable', fileUri.toString());\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst isInsideWorkspace = workspaceFolders.some(folder =>\n\t\t\t\t\t\t\t\tfolder.uri.scheme === fileUri.scheme &&\n\t\t\t\t\t\t\t\t(fileUri.path.startsWith(folder.uri.path + '/') || fileUri.path === folder.uri.path)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tif (!isInsideWorkspace) {\n\t\t\t\t\t\t\t\tisAutoApproveAllowed = false;\n\t\t\t\t\t\t\t\tthis._log('File write blocked outside workspace', fileUri.toString());\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// No workspace folders, allow safe null device paths even without workspace\n\t\t\t\t\t\tconst hasOnlyNullDevices = fileWrites.every(fw => fw === nullDevice);\n\t\t\t\t\t\tif (!hasOnlyNullDevices) {\n\t\t\t\t\t\t\tisAutoApproveAllowed = false;\n\t\t\t\t\t\t\tthis._log('File writes blocked - no workspace folders');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'never':\n\t\t\t\tdefault: {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst disclaimers: string[] = [];\n\t\tif (fileWrites.length > 0) {\n\t\t\tconst fileWritesList = fileWrites.map(fw => `\\`${URI.isUri(fw) ? this._labelService.getUriLabel(fw) : fw === nullDevice ? '/dev/null' : fw.toString()}\\``).join(', ');\n\t\t\tif (!isAutoApproveAllowed) {\n\t\t\t\tdisclaimers.push(localize('runInTerminal.fileWriteBlockedDisclaimer', 'File write operations detected that cannot be auto approved: {0}', fileWritesList));\n\t\t\t} else {\n\t\t\t\tdisclaimers.push(localize('runInTerminal.fileWriteDisclaimer', 'File write operations detected: {0}', fileWritesList));\n\t\t\t}\n\t\t}\n\t\treturn {\n\t\t\tisAutoApproveAllowed,\n\t\t\tdisclaimers,\n\t\t};\n\t}\n}\n"]}