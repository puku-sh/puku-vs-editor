{"version":3,"sources":["vs/workbench/contrib/terminalContrib/chatAgentTools/browser/tools/commandLineAnalyzer/commandLineAutoApproveAnalyzer.ts"],"names":[],"mappings":"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","file":"commandLineAutoApproveAnalyzer.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { asArray } from '../../../../../../../base/common/arrays.js';\nimport { createCommandUri, MarkdownString, type IMarkdownString } from '../../../../../../../base/common/htmlContent.js';\nimport { Disposable } from '../../../../../../../base/common/lifecycle.js';\nimport type { SingleOrMany } from '../../../../../../../base/common/types.js';\nimport { localize } from '../../../../../../../nls.js';\nimport { IConfigurationService } from '../../../../../../../platform/configuration/common/configuration.js';\nimport { IInstantiationService } from '../../../../../../../platform/instantiation/common/instantiation.js';\nimport { ITerminalChatService } from '../../../../../terminal/browser/terminal.js';\nimport { IStorageService, StorageScope } from '../../../../../../../platform/storage/common/storage.js';\nimport { TerminalToolConfirmationStorageKeys } from '../../../../../chat/browser/chatContentParts/toolInvocationParts/chatTerminalToolConfirmationSubPart.js';\nimport { openTerminalSettingsLinkCommandId } from '../../../../../chat/browser/chatContentParts/toolInvocationParts/chatTerminalToolProgressPart.js';\nimport { ChatConfiguration } from '../../../../../chat/common/constants.js';\nimport type { ToolConfirmationAction } from '../../../../../chat/common/languageModelToolsService.js';\nimport { TerminalChatAgentToolsSettingId } from '../../../common/terminalChatAgentToolsConfiguration.js';\nimport { CommandLineAutoApprover, type IAutoApproveRule, type ICommandApprovalResult, type ICommandApprovalResultWithReason } from '../../commandLineAutoApprover.js';\nimport { dedupeRules, generateAutoApproveActions, isPowerShell } from '../../runInTerminalHelpers.js';\nimport type { RunInTerminalToolTelemetry } from '../../runInTerminalToolTelemetry.js';\nimport { type TreeSitterCommandParser } from '../../treeSitterCommandParser.js';\nimport type { ICommandLineAnalyzer, ICommandLineAnalyzerOptions, ICommandLineAnalyzerResult } from './commandLineAnalyzer.js';\n\nconst promptInjectionWarningCommandsLower = [\n\t'curl',\n\t'wget',\n];\nconst promptInjectionWarningCommandsLowerPwshOnly = [\n\t'invoke-restmethod',\n\t'invoke-webrequest',\n\t'irm',\n\t'iwr',\n];\n\nexport class CommandLineAutoApproveAnalyzer extends Disposable implements ICommandLineAnalyzer {\n\tprivate readonly _commandLineAutoApprover: CommandLineAutoApprover;\n\n\tconstructor(\n\t\tprivate readonly _treeSitterCommandParser: TreeSitterCommandParser,\n\t\tprivate readonly _telemetry: RunInTerminalToolTelemetry,\n\t\tprivate readonly _log: (message: string, ...args: unknown[]) => void,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@ITerminalChatService private readonly _terminalChatService: ITerminalChatService,\n\t) {\n\t\tsuper();\n\t\tthis._commandLineAutoApprover = this._register(instantiationService.createInstance(CommandLineAutoApprover));\n\t}\n\n\tasync analyze(options: ICommandLineAnalyzerOptions): Promise<ICommandLineAnalyzerResult> {\n\t\tif (options.chatSessionId && this._terminalChatService.hasChatSessionAutoApproval(options.chatSessionId)) {\n\t\t\tthis._log('Session has auto approval enabled, auto approving command');\n\t\t\tconst disableUri = createCommandUri('_chat.disableSessionAutoApproval', options.chatSessionId);\n\t\t\tconst mdTrustSettings = {\n\t\t\t\tisTrusted: {\n\t\t\t\t\tenabledCommands: ['_chat.disableSessionAutoApproval']\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn {\n\t\t\t\tisAutoApproved: true,\n\t\t\t\tisAutoApproveAllowed: true,\n\t\t\t\tdisclaimers: [],\n\t\t\t\tautoApproveInfo: new MarkdownString(`${localize('autoApprove.session', 'Auto approved for this session')} ([${localize('autoApprove.session.disable', 'Disable')}](${disableUri.toString()}))`, mdTrustSettings),\n\t\t\t};\n\t\t}\n\n\t\tlet subCommands: string[] | undefined;\n\t\ttry {\n\t\t\tsubCommands = await this._treeSitterCommandParser.extractSubCommands(options.treeSitterLanguage, options.commandLine);\n\t\t\tthis._log(`Parsed sub-commands via ${options.treeSitterLanguage} grammar`, subCommands);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t\tthis._log(`Failed to parse sub-commands via ${options.treeSitterLanguage} grammar`);\n\t\t}\n\n\t\tlet isAutoApproved = false;\n\t\tlet autoApproveInfo: IMarkdownString | undefined;\n\t\tlet customActions: ToolConfirmationAction[] | undefined;\n\n\t\tif (!subCommands) {\n\t\t\treturn {\n\t\t\t\tisAutoApproveAllowed: false,\n\t\t\t\tdisclaimers: [],\n\t\t\t};\n\t\t}\n\n\t\tconst subCommandResults = subCommands.map(e => this._commandLineAutoApprover.isCommandAutoApproved(e, options.shell, options.os));\n\t\tconst commandLineResult = this._commandLineAutoApprover.isCommandLineAutoApproved(options.commandLine);\n\t\tconst autoApproveReasons: string[] = [\n\t\t\t...subCommandResults.map(e => e.reason),\n\t\t\tcommandLineResult.reason,\n\t\t];\n\n\t\tlet isDenied = false;\n\t\tlet autoApproveReason: 'subCommand' | 'commandLine' | undefined;\n\t\tlet autoApproveDefault: boolean | undefined;\n\n\t\tconst deniedSubCommandResult = subCommandResults.find(e => e.result === 'denied');\n\t\tif (deniedSubCommandResult) {\n\t\t\tthis._log('Sub-command DENIED auto approval');\n\t\t\tisDenied = true;\n\t\t\tautoApproveDefault = deniedSubCommandResult.rule?.isDefaultRule;\n\t\t\tautoApproveReason = 'subCommand';\n\t\t} else if (commandLineResult.result === 'denied') {\n\t\t\tthis._log('Command line DENIED auto approval');\n\t\t\tisDenied = true;\n\t\t\tautoApproveDefault = commandLineResult.rule?.isDefaultRule;\n\t\t\tautoApproveReason = 'commandLine';\n\t\t} else {\n\t\t\tif (subCommandResults.every(e => e.result === 'approved')) {\n\t\t\t\tthis._log('All sub-commands auto-approved');\n\t\t\t\tautoApproveReason = 'subCommand';\n\t\t\t\tisAutoApproved = true;\n\t\t\t\tautoApproveDefault = subCommandResults.every(e => e.rule?.isDefaultRule);\n\t\t\t} else {\n\t\t\t\tthis._log('All sub-commands NOT auto-approved');\n\t\t\t\tif (commandLineResult.result === 'approved') {\n\t\t\t\t\tthis._log('Command line auto-approved');\n\t\t\t\t\tautoApproveReason = 'commandLine';\n\t\t\t\t\tisAutoApproved = true;\n\t\t\t\t\tautoApproveDefault = commandLineResult.rule?.isDefaultRule;\n\t\t\t\t} else {\n\t\t\t\t\tthis._log('Command line NOT auto-approved');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Log detailed auto approval reasoning\n\t\tfor (const reason of autoApproveReasons) {\n\t\t\tthis._log(`- ${reason}`);\n\t\t}\n\n\t\t// Apply auto approval or force it off depending on enablement/opt-in state\n\t\tconst isAutoApproveEnabled = this._configurationService.getValue(TerminalChatAgentToolsSettingId.EnableAutoApprove) === true;\n\t\tconst isAutoApproveWarningAccepted = this._storageService.getBoolean(TerminalToolConfirmationStorageKeys.TerminalAutoApproveWarningAccepted, StorageScope.APPLICATION, false);\n\t\tif (isAutoApproveEnabled && isAutoApproved) {\n\t\t\tautoApproveInfo = this._createAutoApproveInfo(\n\t\t\t\tisAutoApproved,\n\t\t\t\tisDenied,\n\t\t\t\tautoApproveReason,\n\t\t\t\tsubCommandResults,\n\t\t\t\tcommandLineResult,\n\t\t\t);\n\t\t} else {\n\t\t\tisAutoApproved = false;\n\t\t}\n\n\t\t// Send telemetry about auto approval process\n\t\tthis._telemetry.logPrepare({\n\t\t\tterminalToolSessionId: options.terminalToolSessionId,\n\t\t\tsubCommands,\n\t\t\tautoApproveAllowed: !isAutoApproveEnabled ? 'off' : isAutoApproveWarningAccepted ? 'allowed' : 'needsOptIn',\n\t\t\tautoApproveResult: isAutoApproved ? 'approved' : isDenied ? 'denied' : 'manual',\n\t\t\tautoApproveReason,\n\t\t\tautoApproveDefault\n\t\t});\n\n\t\t// Prompt injection warning for common commands that return content from the web\n\t\tconst disclaimers: string[] = [];\n\t\tconst subCommandsLowerFirstWordOnly = subCommands.map(command => command.split(' ')[0].toLowerCase());\n\t\tif (!isAutoApproved && (\n\t\t\tsubCommandsLowerFirstWordOnly.some(command => promptInjectionWarningCommandsLower.includes(command)) ||\n\t\t\t(isPowerShell(options.shell, options.os) && subCommandsLowerFirstWordOnly.some(command => promptInjectionWarningCommandsLowerPwshOnly.includes(command)))\n\t\t)) {\n\t\t\tdisclaimers.push(localize('runInTerminal.promptInjectionDisclaimer', 'Web content may contain malicious code or attempt prompt injection attacks.'));\n\t\t}\n\n\t\tif (!isAutoApproved && isAutoApproveEnabled) {\n\t\t\tcustomActions = generateAutoApproveActions(options.commandLine, subCommands, { subCommandResults, commandLineResult });\n\t\t}\n\n\t\treturn {\n\t\t\tisAutoApproved,\n\t\t\t// This is not based on isDenied because we want the user to be able to configure it\n\t\t\tisAutoApproveAllowed: true,\n\t\t\tdisclaimers,\n\t\t\tautoApproveInfo,\n\t\t\tcustomActions,\n\t\t};\n\t}\n\n\tprivate _createAutoApproveInfo(\n\t\tisAutoApproved: boolean,\n\t\tisDenied: boolean,\n\t\tautoApproveReason: 'subCommand' | 'commandLine' | undefined,\n\t\tsubCommandResults: ICommandApprovalResultWithReason[],\n\t\tcommandLineResult: ICommandApprovalResultWithReason,\n\t): IMarkdownString | undefined {\n\t\tconst formatRuleLinks = (result: SingleOrMany<{ result: ICommandApprovalResult; rule?: IAutoApproveRule; reason: string }>): string => {\n\t\t\treturn asArray(result).map(e => {\n\t\t\t\tconst settingsUri = createCommandUri(openTerminalSettingsLinkCommandId, e.rule!.sourceTarget);\n\t\t\t\treturn `[\\`${e.rule!.sourceText}\\`](${settingsUri.toString()} \"${localize('ruleTooltip', 'View rule in settings')}\")`;\n\t\t\t}).join(', ');\n\t\t};\n\n\t\tconst mdTrustSettings = {\n\t\t\tisTrusted: {\n\t\t\t\tenabledCommands: [openTerminalSettingsLinkCommandId]\n\t\t\t}\n\t\t};\n\n\t\tconst config = this._configurationService.inspect<boolean | Record<string, boolean>>(ChatConfiguration.GlobalAutoApprove);\n\t\tconst isGlobalAutoApproved = config?.value ?? config.defaultValue;\n\t\tif (isGlobalAutoApproved) {\n\t\t\tconst settingsUri = createCommandUri(openTerminalSettingsLinkCommandId, 'global');\n\t\t\treturn new MarkdownString(`${localize('autoApprove.global', 'Auto approved by setting {0}', `[\\`${ChatConfiguration.GlobalAutoApprove}\\`](${settingsUri.toString()} \"${localize('ruleTooltip.global', 'View settings')}\")`)}`, mdTrustSettings);\n\t\t}\n\n\t\tif (isAutoApproved) {\n\t\t\tswitch (autoApproveReason) {\n\t\t\t\tcase 'commandLine': {\n\t\t\t\t\tif (commandLineResult.rule) {\n\t\t\t\t\t\treturn new MarkdownString(localize('autoApprove.rule', 'Auto approved by rule {0}', formatRuleLinks(commandLineResult)), mdTrustSettings);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'subCommand': {\n\t\t\t\t\tconst uniqueRules = dedupeRules(subCommandResults);\n\t\t\t\t\tif (uniqueRules.length === 1) {\n\t\t\t\t\t\treturn new MarkdownString(localize('autoApprove.rule', 'Auto approved by rule {0}', formatRuleLinks(uniqueRules)), mdTrustSettings);\n\t\t\t\t\t} else if (uniqueRules.length > 1) {\n\t\t\t\t\t\treturn new MarkdownString(localize('autoApprove.rules', 'Auto approved by rules {0}', formatRuleLinks(uniqueRules)), mdTrustSettings);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (isDenied) {\n\t\t\tswitch (autoApproveReason) {\n\t\t\t\tcase 'commandLine': {\n\t\t\t\t\tif (commandLineResult.rule) {\n\t\t\t\t\t\treturn new MarkdownString(localize('autoApproveDenied.rule', 'Auto approval denied by rule {0}', formatRuleLinks(commandLineResult)), mdTrustSettings);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'subCommand': {\n\t\t\t\t\tconst uniqueRules = dedupeRules(subCommandResults.filter(e => e.result === 'denied'));\n\t\t\t\t\tif (uniqueRules.length === 1) {\n\t\t\t\t\t\treturn new MarkdownString(localize('autoApproveDenied.rule', 'Auto approval denied by rule {0}', formatRuleLinks(uniqueRules)));\n\t\t\t\t\t} else if (uniqueRules.length > 1) {\n\t\t\t\t\t\treturn new MarkdownString(localize('autoApproveDenied.rules', 'Auto approval denied by rules {0}', formatRuleLinks(uniqueRules)));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n}\n"]}