{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/terminalContrib/chatAgentTools/browser/treeSitterCommandParser.ts","vs/workbench/contrib/terminalContrib/chatAgentTools/browser/treeSitterCommandParser.ts"],"names":[],"mappings":"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","file":"treeSitterCommandParser.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { Parser, Query, QueryCapture, Tree } from '@vscode/tree-sitter-wasm';\nimport { RunOnceScheduler } from '../../../../../base/common/async.js';\nimport { BugIndicatingError, ErrorNoTelemetry } from '../../../../../base/common/errors.js';\nimport { Lazy } from '../../../../../base/common/lazy.js';\nimport { Disposable, MutableDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { ITreeSitterLibraryService } from '../../../../../editor/common/services/treeSitter/treeSitterLibraryService.js';\n\nexport const enum TreeSitterCommandParserLanguage {\n\tBash = 'bash',\n\tPowerShell = 'powershell',\n}\n\nexport class TreeSitterCommandParser extends Disposable {\n\tprivate readonly _parser: Lazy<Promise<Parser>>;\n\tprivate readonly _treeCache = this._register(new TreeCache());\n\n\tconstructor(\n\t\t@ITreeSitterLibraryService private readonly _treeSitterLibraryService: ITreeSitterLibraryService,\n\t) {\n\t\tsuper();\n\t\tthis._parser = new Lazy(() => this._treeSitterLibraryService.getParserClass().then(ParserCtor => new ParserCtor()));\n\t}\n\n\tasync extractSubCommands(languageId: TreeSitterCommandParserLanguage, commandLine: string): Promise<string[]> {\n\t\tconst captures = await this._queryTree(languageId, commandLine, '(command) @command');\n\t\treturn captures.map(e => e.node.text);\n\t}\n\n\tasync extractPwshDoubleAmpersandChainOperators(commandLine: string): Promise<QueryCapture[]> {\n\t\tconst captures = await this._queryTree(TreeSitterCommandParserLanguage.PowerShell, commandLine, [\n\t\t\t'(',\n\t\t\t'  (pipeline',\n\t\t\t'    (pipeline_chain_tail) @double.ampersand)',\n\t\t\t')',\n\t\t].join('\\n'));\n\t\treturn captures;\n\t}\n\n\tasync getFileWrites(languageId: TreeSitterCommandParserLanguage, commandLine: string): Promise<string[]> {\n\t\tlet query: string;\n\t\tswitch (languageId) {\n\t\t\tcase TreeSitterCommandParserLanguage.Bash:\n\t\t\t\tquery = [\n\t\t\t\t\t'(file_redirect',\n\t\t\t\t\t'  destination: [(word) (string (string_content)) (raw_string) (concatenation)] @file)',\n\t\t\t\t].join('\\n');\n\t\t\t\tbreak;\n\t\t\tcase TreeSitterCommandParserLanguage.PowerShell:\n\t\t\t\tquery = [\n\t\t\t\t\t'(redirection',\n\t\t\t\t\t'  (redirected_file_name) @file)',\n\t\t\t\t].join('\\n');\n\t\t\t\tbreak;\n\t\t}\n\t\tconst captures = await this._queryTree(languageId, commandLine, query);\n\t\treturn captures.map(e => e.node.text.trim());\n\t}\n\n\tprivate async _queryTree(languageId: TreeSitterCommandParserLanguage, commandLine: string, querySource: string): Promise<QueryCapture[]> {\n\t\tconst { tree, query } = await this._doQuery(languageId, commandLine, querySource);\n\t\treturn query.captures(tree.rootNode);\n\t}\n\n\tprivate async _doQuery(languageId: TreeSitterCommandParserLanguage, commandLine: string, querySource: string): Promise<{ tree: Tree; query: Query }> {\n\t\tconst language = await this._treeSitterLibraryService.getLanguagePromise(languageId);\n\t\tif (!language) {\n\t\t\tthrow new BugIndicatingError('Failed to fetch language grammar');\n\t\t}\n\n\t\tlet tree = this._treeCache.get(languageId, commandLine);\n\t\tif (!tree) {\n\t\t\tconst parser = await this._parser.value;\n\t\t\tparser.setLanguage(language);\n\t\t\tconst parsedTree = parser.parse(commandLine);\n\t\t\tif (!parsedTree) {\n\t\t\t\tthrow new ErrorNoTelemetry('Failed to parse tree');\n\t\t\t}\n\n\t\t\ttree = parsedTree;\n\t\t\tthis._treeCache.set(languageId, commandLine, tree);\n\t\t}\n\n\t\tconst query = await this._treeSitterLibraryService.createQuery(language, querySource);\n\t\tif (!query) {\n\t\t\tthrow new BugIndicatingError('Failed to create tree sitter query');\n\t\t}\n\n\t\treturn { tree, query };\n\t}\n}\n\n/**\n * Caches trees temporarily to avoid reparsing the same command line multiple\n * times in quick succession.\n */\nclass TreeCache extends Disposable {\n\tprivate readonly _cache = new Map<string, Tree>();\n\tprivate readonly _clearScheduler = this._register(new MutableDisposable<RunOnceScheduler>());\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis._register(toDisposable(() => this._cache.clear()));\n\t}\n\n\tget(languageId: TreeSitterCommandParserLanguage, commandLine: string): Tree | undefined {\n\t\tthis._resetClearTimer();\n\t\treturn this._cache.get(this._getCacheKey(languageId, commandLine));\n\t}\n\n\tset(languageId: TreeSitterCommandParserLanguage, commandLine: string, tree: Tree): void {\n\t\tthis._resetClearTimer();\n\t\tthis._cache.set(this._getCacheKey(languageId, commandLine), tree);\n\t}\n\n\tprivate _getCacheKey(languageId: TreeSitterCommandParserLanguage, commandLine: string): string {\n\t\treturn `${languageId}:${commandLine}`;\n\t}\n\n\tprivate _resetClearTimer(): void {\n\t\tthis._clearScheduler.value = new RunOnceScheduler(() => {\n\t\t\tthis._cache.clear();\n\t\t}, 10000);\n\t\tthis._clearScheduler.value.schedule();\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { Parser, Query, QueryCapture, Tree } from '@vscode/tree-sitter-wasm';\nimport { RunOnceScheduler } from '../../../../../base/common/async.js';\nimport { BugIndicatingError, ErrorNoTelemetry } from '../../../../../base/common/errors.js';\nimport { Lazy } from '../../../../../base/common/lazy.js';\nimport { Disposable, MutableDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { ITreeSitterLibraryService } from '../../../../../editor/common/services/treeSitter/treeSitterLibraryService.js';\n\nexport const enum TreeSitterCommandParserLanguage {\n\tBash = 'bash',\n\tPowerShell = 'powershell',\n}\n\nexport class TreeSitterCommandParser extends Disposable {\n\tprivate readonly _parser: Lazy<Promise<Parser>>;\n\tprivate readonly _treeCache = this._register(new TreeCache());\n\n\tconstructor(\n\t\t@ITreeSitterLibraryService private readonly _treeSitterLibraryService: ITreeSitterLibraryService,\n\t) {\n\t\tsuper();\n\t\tthis._parser = new Lazy(() => this._treeSitterLibraryService.getParserClass().then(ParserCtor => new ParserCtor()));\n\t}\n\n\tasync extractSubCommands(languageId: TreeSitterCommandParserLanguage, commandLine: string): Promise<string[]> {\n\t\tconst captures = await this._queryTree(languageId, commandLine, '(command) @command');\n\t\treturn captures.map(e => e.node.text);\n\t}\n\n\tasync extractPwshDoubleAmpersandChainOperators(commandLine: string): Promise<QueryCapture[]> {\n\t\tconst captures = await this._queryTree(TreeSitterCommandParserLanguage.PowerShell, commandLine, [\n\t\t\t'(',\n\t\t\t'  (pipeline',\n\t\t\t'    (pipeline_chain_tail) @double.ampersand)',\n\t\t\t')',\n\t\t].join('\\n'));\n\t\treturn captures;\n\t}\n\n\tasync getFileWrites(languageId: TreeSitterCommandParserLanguage, commandLine: string): Promise<string[]> {\n\t\tlet query: string;\n\t\tswitch (languageId) {\n\t\t\tcase TreeSitterCommandParserLanguage.Bash:\n\t\t\t\tquery = [\n\t\t\t\t\t'(file_redirect',\n\t\t\t\t\t'  destination: [(word) (string (string_content)) (raw_string) (concatenation)] @file)',\n\t\t\t\t].join('\\n');\n\t\t\t\tbreak;\n\t\t\tcase TreeSitterCommandParserLanguage.PowerShell:\n\t\t\t\tquery = [\n\t\t\t\t\t'(redirection',\n\t\t\t\t\t'  (redirected_file_name) @file)',\n\t\t\t\t].join('\\n');\n\t\t\t\tbreak;\n\t\t}\n\t\tconst captures = await this._queryTree(languageId, commandLine, query);\n\t\treturn captures.map(e => e.node.text.trim());\n\t}\n\n\tprivate async _queryTree(languageId: TreeSitterCommandParserLanguage, commandLine: string, querySource: string): Promise<QueryCapture[]> {\n\t\tconst { tree, query } = await this._doQuery(languageId, commandLine, querySource);\n\t\treturn query.captures(tree.rootNode);\n\t}\n\n\tprivate async _doQuery(languageId: TreeSitterCommandParserLanguage, commandLine: string, querySource: string): Promise<{ tree: Tree; query: Query }> {\n\t\tconst language = await this._treeSitterLibraryService.getLanguagePromise(languageId);\n\t\tif (!language) {\n\t\t\tthrow new BugIndicatingError('Failed to fetch language grammar');\n\t\t}\n\n\t\tlet tree = this._treeCache.get(languageId, commandLine);\n\t\tif (!tree) {\n\t\t\tconst parser = await this._parser.value;\n\t\t\tparser.setLanguage(language);\n\t\t\tconst parsedTree = parser.parse(commandLine);\n\t\t\tif (!parsedTree) {\n\t\t\t\tthrow new ErrorNoTelemetry('Failed to parse tree');\n\t\t\t}\n\n\t\t\ttree = parsedTree;\n\t\t\tthis._treeCache.set(languageId, commandLine, tree);\n\t\t}\n\n\t\tconst query = await this._treeSitterLibraryService.createQuery(language, querySource);\n\t\tif (!query) {\n\t\t\tthrow new BugIndicatingError('Failed to create tree sitter query');\n\t\t}\n\n\t\treturn { tree, query };\n\t}\n}\n\n/**\n * Caches trees temporarily to avoid reparsing the same command line multiple\n * times in quick succession.\n */\nclass TreeCache extends Disposable {\n\tprivate readonly _cache = new Map<string, Tree>();\n\tprivate readonly _clearScheduler = this._register(new MutableDisposable<RunOnceScheduler>());\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis._register(toDisposable(() => this._cache.clear()));\n\t}\n\n\tget(languageId: TreeSitterCommandParserLanguage, commandLine: string): Tree | undefined {\n\t\tthis._resetClearTimer();\n\t\treturn this._cache.get(this._getCacheKey(languageId, commandLine));\n\t}\n\n\tset(languageId: TreeSitterCommandParserLanguage, commandLine: string, tree: Tree): void {\n\t\tthis._resetClearTimer();\n\t\tthis._cache.set(this._getCacheKey(languageId, commandLine), tree);\n\t}\n\n\tprivate _getCacheKey(languageId: TreeSitterCommandParserLanguage, commandLine: string): string {\n\t\treturn `${languageId}:${commandLine}`;\n\t}\n\n\tprivate _resetClearTimer(): void {\n\t\tthis._clearScheduler.value = new RunOnceScheduler(() => {\n\t\t\tthis._cache.clear();\n\t\t}, 10000);\n\t\tthis._clearScheduler.value.schedule();\n\t}\n}\n"]}