{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/terminalContrib/chat/browser/terminalChatService.ts","vs/workbench/contrib/terminalContrib/chat/browser/terminalChatService.ts"],"names":[],"mappings":"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","file":"terminalChatService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable, DisposableMap, IDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { ILogService } from '../../../../../platform/log/common/log.js';\nimport { IChatTerminalToolProgressPart, ITerminalChatService, ITerminalInstance, ITerminalService } from '../../../terminal/browser/terminal.js';\nimport { IContextKey, IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../platform/storage/common/storage.js';\nimport { IChatService } from '../../../chat/common/chatService.js';\nimport { TerminalChatContextKeys } from './terminalChat.js';\nimport { LocalChatSessionUri } from '../../../chat/common/chatUri.js';\nimport { isNumber, isString } from '../../../../../base/common/types.js';\n\nconst enum StorageKeys {\n\tToolSessionMappings = 'terminalChat.toolSessionMappings',\n\tCommandIdMappings = 'terminalChat.commandIdMappings'\n}\n\n\n/**\n * Used to manage chat tool invocations and the underlying terminal instances they create/use.\n */\nexport class TerminalChatService extends Disposable implements ITerminalChatService {\n\tdeclare _serviceBrand: undefined;\n\n\tprivate readonly _terminalInstancesByToolSessionId = new Map<string, ITerminalInstance>();\n\tprivate readonly _toolSessionIdByTerminalInstance = new Map<ITerminalInstance, string>();\n\tprivate readonly _chatSessionIdByTerminalInstance = new Map<ITerminalInstance, string>();\n\tprivate readonly _terminalInstanceListenersByToolSessionId = this._register(new DisposableMap<string, IDisposable>());\n\tprivate readonly _chatSessionListenersByTerminalInstance = this._register(new DisposableMap<ITerminalInstance, IDisposable>());\n\tprivate readonly _onDidRegisterTerminalInstanceForToolSession = new Emitter<ITerminalInstance>();\n\treadonly onDidRegisterTerminalInstanceWithToolSession: Event<ITerminalInstance> = this._onDidRegisterTerminalInstanceForToolSession.event;\n\tprivate readonly _activeProgressParts = new Set<IChatTerminalToolProgressPart>();\n\tprivate _focusedProgressPart: IChatTerminalToolProgressPart | undefined;\n\tprivate _mostRecentProgressPart: IChatTerminalToolProgressPart | undefined;\n\n\t/**\n\t * Pending mappings restored from storage that have not yet been matched to a live terminal\n\t * instance (we match by persistentProcessId when it becomes available after reconnection).\n\t * toolSessionId -> persistentProcessId\n\t */\n\tprivate readonly _pendingRestoredMappings = new Map<string, number>();\n\n\tprivate readonly _hasToolTerminalContext: IContextKey<boolean>;\n\tprivate readonly _hasHiddenToolTerminalContext: IContextKey<boolean>;\n\n\t/**\n\t * Tracks chat session IDs that have auto approval enabled for all commands. This is a temporary\n\t * approval that lasts only for the duration of the session.\n\t */\n\tprivate readonly _sessionAutoApprovalEnabled = new Set<string>();\n\n\tconstructor(\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@ITerminalService private readonly _terminalService: ITerminalService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t) {\n\t\tsuper();\n\n\t\tthis._hasToolTerminalContext = TerminalChatContextKeys.hasChatTerminals.bindTo(this._contextKeyService);\n\t\tthis._hasHiddenToolTerminalContext = TerminalChatContextKeys.hasHiddenChatTerminals.bindTo(this._contextKeyService);\n\n\t\tthis._restoreFromStorage();\n\t}\n\n\tregisterTerminalInstanceWithToolSession(terminalToolSessionId: string | undefined, instance: ITerminalInstance): void {\n\t\tif (!terminalToolSessionId) {\n\t\t\tthis._logService.warn('Attempted to register a terminal instance with an undefined tool session ID');\n\t\t\treturn;\n\t\t}\n\t\tthis._terminalInstancesByToolSessionId.set(terminalToolSessionId, instance);\n\t\tthis._toolSessionIdByTerminalInstance.set(instance, terminalToolSessionId);\n\t\tthis._onDidRegisterTerminalInstanceForToolSession.fire(instance);\n\t\tthis._terminalInstanceListenersByToolSessionId.set(terminalToolSessionId, instance.onDisposed(() => {\n\t\t\tthis._terminalInstancesByToolSessionId.delete(terminalToolSessionId);\n\t\t\tthis._toolSessionIdByTerminalInstance.delete(instance);\n\t\t\tthis._terminalInstanceListenersByToolSessionId.deleteAndDispose(terminalToolSessionId);\n\t\t\tthis._persistToStorage();\n\t\t\tthis._updateHasToolTerminalContextKeys();\n\t\t}));\n\n\t\tthis._register(this._chatService.onDidDisposeSession(e => {\n\t\t\tif (LocalChatSessionUri.parseLocalSessionId(e.sessionResource) === terminalToolSessionId) {\n\t\t\t\tthis._terminalInstancesByToolSessionId.delete(terminalToolSessionId);\n\t\t\t\tthis._toolSessionIdByTerminalInstance.delete(instance);\n\t\t\t\tthis._terminalInstanceListenersByToolSessionId.deleteAndDispose(terminalToolSessionId);\n\t\t\t\t// Clean up session auto approval state\n\t\t\t\tconst sessionId = LocalChatSessionUri.parseLocalSessionId(e.sessionResource);\n\t\t\t\tif (sessionId) {\n\t\t\t\t\tthis._sessionAutoApprovalEnabled.delete(sessionId);\n\t\t\t\t}\n\t\t\t\tthis._persistToStorage();\n\t\t\t\tthis._updateHasToolTerminalContextKeys();\n\t\t\t}\n\t\t}));\n\n\t\t// Update context keys when terminal instances change (including when terminals are created, disposed, revealed, or hidden)\n\t\tthis._register(this._terminalService.onDidChangeInstances(() => this._updateHasToolTerminalContextKeys()));\n\n\t\tif (isNumber(instance.shellLaunchConfig?.attachPersistentProcess?.id) || isNumber(instance.persistentProcessId)) {\n\t\t\tthis._persistToStorage();\n\t\t}\n\n\t\tthis._updateHasToolTerminalContextKeys();\n\t}\n\n\tasync getTerminalInstanceByToolSessionId(terminalToolSessionId: string | undefined): Promise<ITerminalInstance | undefined> {\n\t\tawait this._terminalService.whenConnected;\n\t\tif (!terminalToolSessionId) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (this._pendingRestoredMappings.has(terminalToolSessionId)) {\n\t\t\tconst instance = this._terminalService.instances.find(i => i.shellLaunchConfig.attachPersistentProcess?.id === this._pendingRestoredMappings.get(terminalToolSessionId));\n\t\t\tif (instance) {\n\t\t\t\tthis._tryAdoptRestoredMapping(instance);\n\t\t\t\treturn instance;\n\t\t\t}\n\t\t}\n\t\treturn this._terminalInstancesByToolSessionId.get(terminalToolSessionId);\n\t}\n\n\tgetToolSessionTerminalInstances(hiddenOnly?: boolean): readonly ITerminalInstance[] {\n\t\tif (hiddenOnly) {\n\t\t\tconst foregroundInstances = new Set(this._terminalService.foregroundInstances.map(i => i.instanceId));\n\t\t\tconst uniqueInstances = new Set(this._terminalInstancesByToolSessionId.values());\n\t\t\treturn Array.from(uniqueInstances).filter(i => !foregroundInstances.has(i.instanceId));\n\t\t}\n\t\t// Ensure unique instances in case multiple tool sessions map to the same terminal\n\t\treturn Array.from(new Set(this._terminalInstancesByToolSessionId.values()));\n\t}\n\n\tgetToolSessionIdForInstance(instance: ITerminalInstance): string | undefined {\n\t\treturn this._toolSessionIdByTerminalInstance.get(instance);\n\t}\n\n\tregisterTerminalInstanceWithChatSession(chatSessionId: string, instance: ITerminalInstance): void {\n\t\t// If already registered with the same session ID, skip to avoid duplicate listeners\n\t\tif (this._chatSessionIdByTerminalInstance.get(instance) === chatSessionId) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Clean up previous listener if the instance was registered with a different session\n\t\tthis._chatSessionListenersByTerminalInstance.deleteAndDispose(instance);\n\n\t\tthis._chatSessionIdByTerminalInstance.set(instance, chatSessionId);\n\t\t// Clean up when the instance is disposed\n\t\tconst disposable = instance.onDisposed(() => {\n\t\t\tthis._chatSessionIdByTerminalInstance.delete(instance);\n\t\t\tthis._chatSessionListenersByTerminalInstance.deleteAndDispose(instance);\n\t\t});\n\t\tthis._chatSessionListenersByTerminalInstance.set(instance, disposable);\n\t}\n\n\tgetChatSessionIdForInstance(instance: ITerminalInstance): string | undefined {\n\t\treturn this._chatSessionIdByTerminalInstance.get(instance);\n\t}\n\n\tisBackgroundTerminal(terminalToolSessionId?: string): boolean {\n\t\tif (!terminalToolSessionId) {\n\t\t\treturn false;\n\t\t}\n\t\tconst instance = this._terminalInstancesByToolSessionId.get(terminalToolSessionId);\n\t\tif (!instance) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this._terminalService.instances.includes(instance) && !this._terminalService.foregroundInstances.includes(instance);\n\t}\n\n\tregisterProgressPart(part: IChatTerminalToolProgressPart): IDisposable {\n\t\tthis._activeProgressParts.add(part);\n\t\tif (this._isAfter(part, this._mostRecentProgressPart)) {\n\t\t\tthis._mostRecentProgressPart = part;\n\t\t}\n\t\treturn toDisposable(() => {\n\t\t\tthis._activeProgressParts.delete(part);\n\t\t\tif (this._focusedProgressPart === part) {\n\t\t\t\tthis._focusedProgressPart = undefined;\n\t\t\t}\n\t\t\tif (this._mostRecentProgressPart === part) {\n\t\t\t\tthis._mostRecentProgressPart = this._getLastActiveProgressPart();\n\t\t\t}\n\t\t});\n\t}\n\n\tsetFocusedProgressPart(part: IChatTerminalToolProgressPart): void {\n\t\tthis._focusedProgressPart = part;\n\t}\n\n\tclearFocusedProgressPart(part: IChatTerminalToolProgressPart): void {\n\t\tif (this._focusedProgressPart === part) {\n\t\t\tthis._focusedProgressPart = undefined;\n\t\t}\n\t}\n\n\tgetFocusedProgressPart(): IChatTerminalToolProgressPart | undefined {\n\t\treturn this._focusedProgressPart;\n\t}\n\n\tgetMostRecentProgressPart(): IChatTerminalToolProgressPart | undefined {\n\t\treturn this._mostRecentProgressPart;\n\t}\n\n\tprivate _getLastActiveProgressPart(): IChatTerminalToolProgressPart | undefined {\n\t\tlet latest: IChatTerminalToolProgressPart | undefined;\n\t\tfor (const part of this._activeProgressParts) {\n\t\t\tif (this._isAfter(part, latest)) {\n\t\t\t\tlatest = part;\n\t\t\t}\n\t\t}\n\t\treturn latest;\n\t}\n\n\tprivate _isAfter(candidate: IChatTerminalToolProgressPart, current: IChatTerminalToolProgressPart | undefined): boolean {\n\t\tif (!current) {\n\t\t\treturn true;\n\t\t}\n\t\tif (candidate.elementIndex === current.elementIndex) {\n\t\t\treturn candidate.contentIndex >= current.contentIndex;\n\t\t}\n\t\treturn candidate.elementIndex > current.elementIndex;\n\t}\n\n\tprivate _restoreFromStorage(): void {\n\t\ttry {\n\t\t\tconst raw = this._storageService.get(StorageKeys.ToolSessionMappings, StorageScope.WORKSPACE);\n\t\t\tif (!raw) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst parsed: [string, number][] = JSON.parse(raw);\n\t\t\tfor (const [toolSessionId, persistentProcessId] of parsed) {\n\t\t\t\tif (isString(toolSessionId) && isNumber(persistentProcessId)) {\n\t\t\t\t\tthis._pendingRestoredMappings.set(toolSessionId, persistentProcessId);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tthis._logService.warn('Failed to restore terminal chat tool session mappings', err);\n\t\t}\n\t}\n\n\tprivate _tryAdoptRestoredMapping(instance: ITerminalInstance): void {\n\t\tif (this._pendingRestoredMappings.size === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tfor (const [toolSessionId, persistentProcessId] of this._pendingRestoredMappings) {\n\t\t\tif (persistentProcessId === instance.shellLaunchConfig.attachPersistentProcess?.id) {\n\t\t\t\tthis._terminalInstancesByToolSessionId.set(toolSessionId, instance);\n\t\t\t\tthis._toolSessionIdByTerminalInstance.set(instance, toolSessionId);\n\t\t\t\tthis._onDidRegisterTerminalInstanceForToolSession.fire(instance);\n\t\t\t\tthis._terminalInstanceListenersByToolSessionId.set(toolSessionId, instance.onDisposed(() => {\n\t\t\t\t\tthis._terminalInstancesByToolSessionId.delete(toolSessionId);\n\t\t\t\t\tthis._toolSessionIdByTerminalInstance.delete(instance);\n\t\t\t\t\tthis._terminalInstanceListenersByToolSessionId.deleteAndDispose(toolSessionId);\n\t\t\t\t\tthis._persistToStorage();\n\t\t\t\t}));\n\t\t\t\tthis._pendingRestoredMappings.delete(toolSessionId);\n\t\t\t\tthis._persistToStorage();\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _persistToStorage(): void {\n\t\tthis._updateHasToolTerminalContextKeys();\n\t\ttry {\n\t\t\tconst entries: [string, number][] = [];\n\t\t\tfor (const [toolSessionId, instance] of this._terminalInstancesByToolSessionId.entries()) {\n\t\t\t\tif (isNumber(instance.persistentProcessId) && instance.shouldPersist) {\n\t\t\t\t\tentries.push([toolSessionId, instance.persistentProcessId]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (entries.length > 0) {\n\t\t\t\tthis._storageService.store(StorageKeys.ToolSessionMappings, JSON.stringify(entries), StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\t\t} else {\n\t\t\t\tthis._storageService.remove(StorageKeys.ToolSessionMappings, StorageScope.WORKSPACE);\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tthis._logService.warn('Failed to persist terminal chat tool session mappings', err);\n\t\t}\n\t}\n\n\tprivate _updateHasToolTerminalContextKeys(): void {\n\t\tconst toolCount = this._terminalInstancesByToolSessionId.size;\n\t\tthis._hasToolTerminalContext.set(toolCount > 0);\n\t\tconst hiddenTerminalCount = this.getToolSessionTerminalInstances(true).length;\n\t\tthis._hasHiddenToolTerminalContext.set(hiddenTerminalCount > 0);\n\t}\n\n\tsetChatSessionAutoApproval(chatSessionId: string, enabled: boolean): void {\n\t\tif (enabled) {\n\t\t\tthis._sessionAutoApprovalEnabled.add(chatSessionId);\n\t\t} else {\n\t\t\tthis._sessionAutoApprovalEnabled.delete(chatSessionId);\n\t\t}\n\t}\n\n\thasChatSessionAutoApproval(chatSessionId: string): boolean {\n\t\treturn this._sessionAutoApprovalEnabled.has(chatSessionId);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable, DisposableMap, IDisposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { ILogService } from '../../../../../platform/log/common/log.js';\nimport { IChatTerminalToolProgressPart, ITerminalChatService, ITerminalInstance, ITerminalService } from '../../../terminal/browser/terminal.js';\nimport { IContextKey, IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../platform/storage/common/storage.js';\nimport { IChatService } from '../../../chat/common/chatService.js';\nimport { TerminalChatContextKeys } from './terminalChat.js';\nimport { LocalChatSessionUri } from '../../../chat/common/chatUri.js';\nimport { isNumber, isString } from '../../../../../base/common/types.js';\n\nconst enum StorageKeys {\n\tToolSessionMappings = 'terminalChat.toolSessionMappings',\n\tCommandIdMappings = 'terminalChat.commandIdMappings'\n}\n\n\n/**\n * Used to manage chat tool invocations and the underlying terminal instances they create/use.\n */\nexport class TerminalChatService extends Disposable implements ITerminalChatService {\n\tdeclare _serviceBrand: undefined;\n\n\tprivate readonly _terminalInstancesByToolSessionId = new Map<string, ITerminalInstance>();\n\tprivate readonly _toolSessionIdByTerminalInstance = new Map<ITerminalInstance, string>();\n\tprivate readonly _chatSessionIdByTerminalInstance = new Map<ITerminalInstance, string>();\n\tprivate readonly _terminalInstanceListenersByToolSessionId = this._register(new DisposableMap<string, IDisposable>());\n\tprivate readonly _chatSessionListenersByTerminalInstance = this._register(new DisposableMap<ITerminalInstance, IDisposable>());\n\tprivate readonly _onDidRegisterTerminalInstanceForToolSession = new Emitter<ITerminalInstance>();\n\treadonly onDidRegisterTerminalInstanceWithToolSession: Event<ITerminalInstance> = this._onDidRegisterTerminalInstanceForToolSession.event;\n\tprivate readonly _activeProgressParts = new Set<IChatTerminalToolProgressPart>();\n\tprivate _focusedProgressPart: IChatTerminalToolProgressPart | undefined;\n\tprivate _mostRecentProgressPart: IChatTerminalToolProgressPart | undefined;\n\n\t/**\n\t * Pending mappings restored from storage that have not yet been matched to a live terminal\n\t * instance (we match by persistentProcessId when it becomes available after reconnection).\n\t * toolSessionId -> persistentProcessId\n\t */\n\tprivate readonly _pendingRestoredMappings = new Map<string, number>();\n\n\tprivate readonly _hasToolTerminalContext: IContextKey<boolean>;\n\tprivate readonly _hasHiddenToolTerminalContext: IContextKey<boolean>;\n\n\t/**\n\t * Tracks chat session IDs that have auto approval enabled for all commands. This is a temporary\n\t * approval that lasts only for the duration of the session.\n\t */\n\tprivate readonly _sessionAutoApprovalEnabled = new Set<string>();\n\n\tconstructor(\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@ITerminalService private readonly _terminalService: ITerminalService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t) {\n\t\tsuper();\n\n\t\tthis._hasToolTerminalContext = TerminalChatContextKeys.hasChatTerminals.bindTo(this._contextKeyService);\n\t\tthis._hasHiddenToolTerminalContext = TerminalChatContextKeys.hasHiddenChatTerminals.bindTo(this._contextKeyService);\n\n\t\tthis._restoreFromStorage();\n\t}\n\n\tregisterTerminalInstanceWithToolSession(terminalToolSessionId: string | undefined, instance: ITerminalInstance): void {\n\t\tif (!terminalToolSessionId) {\n\t\t\tthis._logService.warn('Attempted to register a terminal instance with an undefined tool session ID');\n\t\t\treturn;\n\t\t}\n\t\tthis._terminalInstancesByToolSessionId.set(terminalToolSessionId, instance);\n\t\tthis._toolSessionIdByTerminalInstance.set(instance, terminalToolSessionId);\n\t\tthis._onDidRegisterTerminalInstanceForToolSession.fire(instance);\n\t\tthis._terminalInstanceListenersByToolSessionId.set(terminalToolSessionId, instance.onDisposed(() => {\n\t\t\tthis._terminalInstancesByToolSessionId.delete(terminalToolSessionId);\n\t\t\tthis._toolSessionIdByTerminalInstance.delete(instance);\n\t\t\tthis._terminalInstanceListenersByToolSessionId.deleteAndDispose(terminalToolSessionId);\n\t\t\tthis._persistToStorage();\n\t\t\tthis._updateHasToolTerminalContextKeys();\n\t\t}));\n\n\t\tthis._register(this._chatService.onDidDisposeSession(e => {\n\t\t\tif (LocalChatSessionUri.parseLocalSessionId(e.sessionResource) === terminalToolSessionId) {\n\t\t\t\tthis._terminalInstancesByToolSessionId.delete(terminalToolSessionId);\n\t\t\t\tthis._toolSessionIdByTerminalInstance.delete(instance);\n\t\t\t\tthis._terminalInstanceListenersByToolSessionId.deleteAndDispose(terminalToolSessionId);\n\t\t\t\t// Clean up session auto approval state\n\t\t\t\tconst sessionId = LocalChatSessionUri.parseLocalSessionId(e.sessionResource);\n\t\t\t\tif (sessionId) {\n\t\t\t\t\tthis._sessionAutoApprovalEnabled.delete(sessionId);\n\t\t\t\t}\n\t\t\t\tthis._persistToStorage();\n\t\t\t\tthis._updateHasToolTerminalContextKeys();\n\t\t\t}\n\t\t}));\n\n\t\t// Update context keys when terminal instances change (including when terminals are created, disposed, revealed, or hidden)\n\t\tthis._register(this._terminalService.onDidChangeInstances(() => this._updateHasToolTerminalContextKeys()));\n\n\t\tif (isNumber(instance.shellLaunchConfig?.attachPersistentProcess?.id) || isNumber(instance.persistentProcessId)) {\n\t\t\tthis._persistToStorage();\n\t\t}\n\n\t\tthis._updateHasToolTerminalContextKeys();\n\t}\n\n\tasync getTerminalInstanceByToolSessionId(terminalToolSessionId: string | undefined): Promise<ITerminalInstance | undefined> {\n\t\tawait this._terminalService.whenConnected;\n\t\tif (!terminalToolSessionId) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (this._pendingRestoredMappings.has(terminalToolSessionId)) {\n\t\t\tconst instance = this._terminalService.instances.find(i => i.shellLaunchConfig.attachPersistentProcess?.id === this._pendingRestoredMappings.get(terminalToolSessionId));\n\t\t\tif (instance) {\n\t\t\t\tthis._tryAdoptRestoredMapping(instance);\n\t\t\t\treturn instance;\n\t\t\t}\n\t\t}\n\t\treturn this._terminalInstancesByToolSessionId.get(terminalToolSessionId);\n\t}\n\n\tgetToolSessionTerminalInstances(hiddenOnly?: boolean): readonly ITerminalInstance[] {\n\t\tif (hiddenOnly) {\n\t\t\tconst foregroundInstances = new Set(this._terminalService.foregroundInstances.map(i => i.instanceId));\n\t\t\tconst uniqueInstances = new Set(this._terminalInstancesByToolSessionId.values());\n\t\t\treturn Array.from(uniqueInstances).filter(i => !foregroundInstances.has(i.instanceId));\n\t\t}\n\t\t// Ensure unique instances in case multiple tool sessions map to the same terminal\n\t\treturn Array.from(new Set(this._terminalInstancesByToolSessionId.values()));\n\t}\n\n\tgetToolSessionIdForInstance(instance: ITerminalInstance): string | undefined {\n\t\treturn this._toolSessionIdByTerminalInstance.get(instance);\n\t}\n\n\tregisterTerminalInstanceWithChatSession(chatSessionId: string, instance: ITerminalInstance): void {\n\t\t// If already registered with the same session ID, skip to avoid duplicate listeners\n\t\tif (this._chatSessionIdByTerminalInstance.get(instance) === chatSessionId) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Clean up previous listener if the instance was registered with a different session\n\t\tthis._chatSessionListenersByTerminalInstance.deleteAndDispose(instance);\n\n\t\tthis._chatSessionIdByTerminalInstance.set(instance, chatSessionId);\n\t\t// Clean up when the instance is disposed\n\t\tconst disposable = instance.onDisposed(() => {\n\t\t\tthis._chatSessionIdByTerminalInstance.delete(instance);\n\t\t\tthis._chatSessionListenersByTerminalInstance.deleteAndDispose(instance);\n\t\t});\n\t\tthis._chatSessionListenersByTerminalInstance.set(instance, disposable);\n\t}\n\n\tgetChatSessionIdForInstance(instance: ITerminalInstance): string | undefined {\n\t\treturn this._chatSessionIdByTerminalInstance.get(instance);\n\t}\n\n\tisBackgroundTerminal(terminalToolSessionId?: string): boolean {\n\t\tif (!terminalToolSessionId) {\n\t\t\treturn false;\n\t\t}\n\t\tconst instance = this._terminalInstancesByToolSessionId.get(terminalToolSessionId);\n\t\tif (!instance) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this._terminalService.instances.includes(instance) && !this._terminalService.foregroundInstances.includes(instance);\n\t}\n\n\tregisterProgressPart(part: IChatTerminalToolProgressPart): IDisposable {\n\t\tthis._activeProgressParts.add(part);\n\t\tif (this._isAfter(part, this._mostRecentProgressPart)) {\n\t\t\tthis._mostRecentProgressPart = part;\n\t\t}\n\t\treturn toDisposable(() => {\n\t\t\tthis._activeProgressParts.delete(part);\n\t\t\tif (this._focusedProgressPart === part) {\n\t\t\t\tthis._focusedProgressPart = undefined;\n\t\t\t}\n\t\t\tif (this._mostRecentProgressPart === part) {\n\t\t\t\tthis._mostRecentProgressPart = this._getLastActiveProgressPart();\n\t\t\t}\n\t\t});\n\t}\n\n\tsetFocusedProgressPart(part: IChatTerminalToolProgressPart): void {\n\t\tthis._focusedProgressPart = part;\n\t}\n\n\tclearFocusedProgressPart(part: IChatTerminalToolProgressPart): void {\n\t\tif (this._focusedProgressPart === part) {\n\t\t\tthis._focusedProgressPart = undefined;\n\t\t}\n\t}\n\n\tgetFocusedProgressPart(): IChatTerminalToolProgressPart | undefined {\n\t\treturn this._focusedProgressPart;\n\t}\n\n\tgetMostRecentProgressPart(): IChatTerminalToolProgressPart | undefined {\n\t\treturn this._mostRecentProgressPart;\n\t}\n\n\tprivate _getLastActiveProgressPart(): IChatTerminalToolProgressPart | undefined {\n\t\tlet latest: IChatTerminalToolProgressPart | undefined;\n\t\tfor (const part of this._activeProgressParts) {\n\t\t\tif (this._isAfter(part, latest)) {\n\t\t\t\tlatest = part;\n\t\t\t}\n\t\t}\n\t\treturn latest;\n\t}\n\n\tprivate _isAfter(candidate: IChatTerminalToolProgressPart, current: IChatTerminalToolProgressPart | undefined): boolean {\n\t\tif (!current) {\n\t\t\treturn true;\n\t\t}\n\t\tif (candidate.elementIndex === current.elementIndex) {\n\t\t\treturn candidate.contentIndex >= current.contentIndex;\n\t\t}\n\t\treturn candidate.elementIndex > current.elementIndex;\n\t}\n\n\tprivate _restoreFromStorage(): void {\n\t\ttry {\n\t\t\tconst raw = this._storageService.get(StorageKeys.ToolSessionMappings, StorageScope.WORKSPACE);\n\t\t\tif (!raw) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst parsed: [string, number][] = JSON.parse(raw);\n\t\t\tfor (const [toolSessionId, persistentProcessId] of parsed) {\n\t\t\t\tif (isString(toolSessionId) && isNumber(persistentProcessId)) {\n\t\t\t\t\tthis._pendingRestoredMappings.set(toolSessionId, persistentProcessId);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tthis._logService.warn('Failed to restore terminal chat tool session mappings', err);\n\t\t}\n\t}\n\n\tprivate _tryAdoptRestoredMapping(instance: ITerminalInstance): void {\n\t\tif (this._pendingRestoredMappings.size === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tfor (const [toolSessionId, persistentProcessId] of this._pendingRestoredMappings) {\n\t\t\tif (persistentProcessId === instance.shellLaunchConfig.attachPersistentProcess?.id) {\n\t\t\t\tthis._terminalInstancesByToolSessionId.set(toolSessionId, instance);\n\t\t\t\tthis._toolSessionIdByTerminalInstance.set(instance, toolSessionId);\n\t\t\t\tthis._onDidRegisterTerminalInstanceForToolSession.fire(instance);\n\t\t\t\tthis._terminalInstanceListenersByToolSessionId.set(toolSessionId, instance.onDisposed(() => {\n\t\t\t\t\tthis._terminalInstancesByToolSessionId.delete(toolSessionId);\n\t\t\t\t\tthis._toolSessionIdByTerminalInstance.delete(instance);\n\t\t\t\t\tthis._terminalInstanceListenersByToolSessionId.deleteAndDispose(toolSessionId);\n\t\t\t\t\tthis._persistToStorage();\n\t\t\t\t}));\n\t\t\t\tthis._pendingRestoredMappings.delete(toolSessionId);\n\t\t\t\tthis._persistToStorage();\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _persistToStorage(): void {\n\t\tthis._updateHasToolTerminalContextKeys();\n\t\ttry {\n\t\t\tconst entries: [string, number][] = [];\n\t\t\tfor (const [toolSessionId, instance] of this._terminalInstancesByToolSessionId.entries()) {\n\t\t\t\tif (isNumber(instance.persistentProcessId) && instance.shouldPersist) {\n\t\t\t\t\tentries.push([toolSessionId, instance.persistentProcessId]);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (entries.length > 0) {\n\t\t\t\tthis._storageService.store(StorageKeys.ToolSessionMappings, JSON.stringify(entries), StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\t\t} else {\n\t\t\t\tthis._storageService.remove(StorageKeys.ToolSessionMappings, StorageScope.WORKSPACE);\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tthis._logService.warn('Failed to persist terminal chat tool session mappings', err);\n\t\t}\n\t}\n\n\tprivate _updateHasToolTerminalContextKeys(): void {\n\t\tconst toolCount = this._terminalInstancesByToolSessionId.size;\n\t\tthis._hasToolTerminalContext.set(toolCount > 0);\n\t\tconst hiddenTerminalCount = this.getToolSessionTerminalInstances(true).length;\n\t\tthis._hasHiddenToolTerminalContext.set(hiddenTerminalCount > 0);\n\t}\n\n\tsetChatSessionAutoApproval(chatSessionId: string, enabled: boolean): void {\n\t\tif (enabled) {\n\t\t\tthis._sessionAutoApprovalEnabled.add(chatSessionId);\n\t\t} else {\n\t\t\tthis._sessionAutoApprovalEnabled.delete(chatSessionId);\n\t\t}\n\t}\n\n\thasChatSessionAutoApproval(chatSessionId: string): boolean {\n\t\treturn this._sessionAutoApprovalEnabled.has(chatSessionId);\n\t}\n}\n"]}