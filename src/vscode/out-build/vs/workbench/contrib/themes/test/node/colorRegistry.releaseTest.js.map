{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/themes/test/node/colorRegistry.releaseTest.ts","vs/workbench/contrib/themes/test/node/colorRegistry.releaseTest.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,KAAK,EAAE,MAAM,IAAI,CAAC;AACzB,OAAO,EAAE,QAAQ,EAAE,MAAM,qDAAqD,CAAC;AAC/E,OAAO,EAAkB,UAAU,EAAqB,iBAAiB,EAAE,MAAM,uDAAuD,CAAC;AACzI,OAAO,EAAE,aAAa,EAAE,MAAM,mDAAmD,CAAC;AAClF,OAAO,KAAK,GAAG,MAAM,iCAAiC,CAAC;AACvD,OAAO,KAAK,IAAI,MAAM,oCAAoC,CAAC;AAC3D,OAAO,MAAM,MAAM,QAAQ,CAAC;AAC5B,OAAO,EAAE,iBAAiB,EAAE,MAAM,4CAA4C,CAAC;AAC/E,OAAO,EAAE,cAAc,EAAE,MAAM,wDAAwD,CAAC;AACxF,OAAO,EAAE,wBAAwB,EAAE,MAAM,+EAA+E,CAAC;AACzH,sDAAsD;AACtD,OAAO,uCAAuC,CAAC;AAC/C,OAAO,EAAE,cAAc,EAAE,MAAM,2CAA2C,CAAC;AAC3E,OAAO,EAAE,IAAI,EAAE,MAAM,yCAAyC,CAAC;AAE/D,OAAO,EAAE,UAAU,EAAE,MAAM,uCAAuC,CAAC;AAanE,MAAM,CAAC,MAAM,YAAY,GAAa,EAAE,CAAC,CAAC,uEAAuE;AAGjH,MAAM,sBAAsB,GAAG,6BAA6B,CAAC;AAE7D,KAAK,CAAC,gBAAgB,EAAE;IAEvB,IAAI,CAAC,oBAAoB,sBAAsB,EAAE,EAAE,KAAK;QACvD,MAAM,WAAW,GAAG,UAAU,CAAC,SAAS,CAAC,gCAAgC,sBAAsB,EAAE,CAAC,CAAC,MAAM,CAAC;QAC1G,MAAM,OAAO,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC;QAErE,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;QAE1C,MAAM,WAAW,GAAG,aAAa,CAAC,MAAkB,CAAC;QAErD,MAAM,CAAC,EAAE,CAAC,WAAW,IAAI,WAAW,CAAC,MAAM,GAAG,CAAC,EAAE,0DAA0D,CAAC,CAAC;QAE7G,MAAM,MAAM,GAAG,IAAI,GAAG,CAAC,WAAW,CAAC,CAAC;QAEpC,MAAM,aAAa,GAAG,EAAE,CAAC;QACzB,MAAM,OAAO,GAAG,EAAE,CAAC;QACnB,MAAM,eAAe,GAAG,QAAQ,CAAC,EAAE,CAAiB,UAAU,CAAC,iBAAiB,CAAC,CAAC;QAClF,KAAK,MAAM,KAAK,IAAI,eAAe,CAAC,SAAS,EAAE,EAAE,CAAC;YACjD,MAAM,EAAE,GAAG,iBAAiB,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YAEvC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC;gBACrB,IAAI,CAAC,KAAK,CAAC,kBAAkB,EAAE,CAAC;oBAC/B,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;gBAClB,CAAC;YACF,CAAC;iBAAM,CAAC;gBACP,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;YACnB,CAAC;YACD,aAAa,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QACxB,CAAC;QAED,MAAM,eAAe,GAAG,CAAC,GAAG,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC;QAE3C,IAAI,SAAS,GAAG,EAAE,CAAC;QACnB,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YACxB,SAAS,IAAI,sCAAsC,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,SAAS,EAAE,IAAI,CAAC,IAAI,CAAC;QACjG,CAAC;QACD,IAAI,eAAe,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAChC,SAAS,IAAI,wCAAwC,eAAe,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC;QACrF,CAAC;QAED,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC1B,aAAa,CAAC,IAAI,EAAE,CAAC;YACrB,aAAa,CAAC,MAAM,GAAG,aAAa,CAAC;YACrC,MAAM,GAAG,CAAC,QAAQ,CAAC,SAAS,CAAC,WAAW,EAAE,IAAI,CAAC,SAAS,CAAC,aAAa,EAAE,SAAS,EAAE,IAAI,CAAC,CAAC,CAAC;YAE1F,MAAM,CAAC,IAAI,CAAC,eAAe,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,mCAAmC,SAAS,IAAI,CAAC,CAAC;QACzG,CAAC;IACF,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,qCAAqC,EAAE,KAAK;QAChD,wHAAwH;QACxH,MAAM,kBAAkB,GAAG,IAAI,KAAM,SAAQ,IAAI,EAA6B;YAA/C;;gBAA2D,SAAI,GAAG,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC;YAAC,CAAC;SAAA,CAAC;QAE9G,MAAM,MAAM,GAAG,6FAA6F,CAAC;QAE7G,MAAM,UAAU,GAAG,MAAM,IAAI,cAAc,CAAC,OAAO,EAAE,IAAI,wBAAwB,EAAE,EAAE,kBAAkB,EAAE,IAAI,cAAc,EAAE,CAAC,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,MAAM,EAAE,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;QAChL,MAAM,OAAO,GAAG,CAAC,MAAM,aAAa,CAAC,UAAU,CAAC,CAAE,CAAC;QAEnD,MAAM,UAAU,GAAG,0BAA0B,CAAC;QAE9C,IAAI,CAAyB,CAAC;QAC9B,MAAM,WAAW,GAAgC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QACrE,IAAI,YAAY,GAAG,CAAC,CAAC;QACrB,OAAO,CAAC,GAAG,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;YACrC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,EAAE,WAAW,EAAE,CAAC,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,CAAC,CAAC,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC;YAC7E,YAAY,EAAE,CAAC;QAChB,CAAC;QACD,MAAM,CAAC,EAAE,CAAC,YAAY,GAAG,CAAC,EAAE,+CAA+C,CAAC,CAAC;QAE7E,MAAM,OAAO,GAAG,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QACpC,MAAM,gBAAgB,GAAsC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAEhF,MAAM,eAAe,GAAG,QAAQ,CAAC,EAAE,CAAiB,UAAU,CAAC,iBAAiB,CAAC,CAAC;QAClF,KAAK,MAAM,KAAK,IAAI,eAAe,CAAC,SAAS,EAAE,EAAE,CAAC;YACjD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,EAAE,CAAC,EAAE,CAAC;gBAC5B,IAAI,CAAC,KAAK,CAAC,kBAAkB,EAAE,CAAC;oBAC/B,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,cAAc,CAAC,KAAK,CAAC,CAAC;gBAC3C,CAAC;YACF,CAAC;iBAAM,CAAC;gBACP,MAAM,cAAc,GAAG,WAAW,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,WAAW,CAAC;gBACzD,MAAM,eAAe,GAAG,cAAc,CAAC,KAAK,CAAC,CAAC;gBAC9C,IAAI,cAAc,KAAK,eAAe,EAAE,CAAC;oBACxC,gBAAgB,CAAC,KAAK,CAAC,EAAE,CAAC,GAAG,EAAE,cAAc,EAAE,eAAe,EAAE,CAAC;gBAClE,CAAC;gBACD,OAAO,WAAW,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YAC9B,CAAC;QACF,CAAC;QACD,MAAM,kBAAkB,GAAG,MAAM,sBAAsB,EAAE,CAAC;QAC1D,KAAK,MAAM,OAAO,IAAI,kBAAkB,EAAE,CAAC;YAC1C,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,EAAE,CAAC;gBAC3B,OAAO,CAAC,OAAO,CAAC,GAAG,kBAAkB,CAAC,OAAO,CAAC,CAAC;YAChD,CAAC;iBAAM,CAAC;gBACP,OAAO,WAAW,CAAC,OAAO,CAAC,CAAC;YAC7B,CAAC;QACF,CAAC;QACD,KAAK,MAAM,OAAO,IAAI,YAAY,EAAE,CAAC;YACpC,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC;gBACtB,OAAO,OAAO,CAAC,OAAO,CAAC,CAAC;YACzB,CAAC;YACD,IAAI,WAAW,CAAC,OAAO,CAAC,EAAE,CAAC;gBAC1B,MAAM,CAAC,IAAI,CAAC,SAAS,OAAO,8EAA8E,CAAC,CAAC;YAC7G,CAAC;QACF,CAAC;QACD,MAAM,eAAe,GAAG,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACjD,MAAM,gBAAgB,GAAG,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,KAAK,CAAC,OAAO,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;QAGlF,IAAI,SAAS,GAAG,EAAE,CAAC;QACnB,IAAI,gBAAgB,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YACjC,SAAS,IAAI,oCAAoC,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC;QAClF,CAAC;QACD,IAAI,eAAe,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAChC,SAAS,IAAI,sCAAsC,eAAe,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC;QACnF,CAAC;QAED,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC1B,MAAM,CAAC,IAAI,CAAC,gGAAgG,SAAS,EAAE,CAAC,CAAC;QAC1H,CAAC;IACF,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAEH,SAAS,cAAc,CAAC,KAAwB;IAC/C,IAAI,eAAe,GAAG,KAAK,CAAC,WAAW,CAAC;IACxC,IAAI,KAAK,CAAC,kBAAkB,EAAE,CAAC;QAC9B,eAAe,GAAG,eAAe,GAAG,GAAG,GAAG,KAAK,CAAC,kBAAkB,CAAC;IACpE,CAAC;IACD,OAAO,eAAe,CAAC;AACxB,CAAC;AAED,KAAK,UAAU,sBAAsB;IACpC,MAAM,OAAO,GAAG,UAAU,CAAC,SAAS,CAAC,qBAAqB,CAAC,CAAC,MAAM,CAAC;IACnE,MAAM,UAAU,GAAG,MAAM,GAAG,CAAC,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;IAC7D,MAAM,MAAM,GAA6B,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;IAC7D,KAAK,MAAM,MAAM,IAAI,UAAU,EAAE,CAAC;QACjC,IAAI,CAAC;YACJ,MAAM,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,MAAM,EAAE,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,MAAM,EAAE,cAAc,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;YACpH,MAAM,WAAW,GAAG,WAAW,CAAC,aAAa,CAAC,CAAC;YAC/C,IAAI,WAAW,EAAE,CAAC;gBACjB,MAAM,MAAM,GAAG,WAAW,CAAC,QAAQ,CAAC,CAAC;gBACrC,IAAI,MAAM,EAAE,CAAC;oBACZ,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;wBAC5B,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC;wBAC5B,IAAI,OAAO,EAAE,CAAC;4BACb,MAAM,CAAC,OAAO,CAAC,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;wBAC1C,CAAC;oBACF,CAAC;gBACF,CAAC;YACF,CAAC;QACF,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACZ,SAAS;QACV,CAAC;IAEF,CAAC;IACD,OAAO,MAAM,CAAC;AACf,CAAC","file":"colorRegistry.releaseTest.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as fs from 'fs';\nimport { Registry } from '../../../../../platform/registry/common/platform.js';\nimport { IColorRegistry, Extensions, ColorContribution, asCssVariableName } from '../../../../../platform/theme/common/colorRegistry.js';\nimport { asTextOrError } from '../../../../../platform/request/common/request.js';\nimport * as pfs from '../../../../../base/node/pfs.js';\nimport * as path from '../../../../../base/common/path.js';\nimport assert from 'assert';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { RequestService } from '../../../../../platform/request/node/requestService.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\n// eslint-disable-next-line local/code-import-patterns\nimport '../../../../workbench.desktop.main.js';\nimport { NullLogService } from '../../../../../platform/log/common/log.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { INativeEnvironmentService } from '../../../../../platform/environment/common/environment.js';\nimport { FileAccess } from '../../../../../base/common/network.js';\n\ninterface ColorInfo {\n\tdescription: string;\n\toffset: number;\n\tlength: number;\n}\n\ninterface DescriptionDiff {\n\tdocDescription: string;\n\tspecDescription: string;\n}\n\nexport const experimental: string[] = []; // 'settings.modifiedItemForeground', 'editorUnnecessary.foreground' ];\n\n\nconst knwonVariablesFileName = 'vscode-known-variables.json';\n\nsuite('Color Registry', function () {\n\n\ttest(`update colors in ${knwonVariablesFileName}`, async function () {\n\t\tconst varFilePath = FileAccess.asFileUri(`vs/../../build/lib/stylelint/${knwonVariablesFileName}`).fsPath;\n\t\tconst content = (await fs.promises.readFile(varFilePath)).toString();\n\n\t\tconst variablesInfo = JSON.parse(content);\n\n\t\tconst colorsArray = variablesInfo.colors as string[];\n\n\t\tassert.ok(colorsArray && colorsArray.length > 0, '${knwonVariablesFileName} contains no color descriptions');\n\n\t\tconst colors = new Set(colorsArray);\n\n\t\tconst updatedColors = [];\n\t\tconst missing = [];\n\t\tconst themingRegistry = Registry.as<IColorRegistry>(Extensions.ColorContribution);\n\t\tfor (const color of themingRegistry.getColors()) {\n\t\t\tconst id = asCssVariableName(color.id);\n\n\t\t\tif (!colors.has(id)) {\n\t\t\t\tif (!color.deprecationMessage) {\n\t\t\t\t\tmissing.push(id);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tcolors.delete(id);\n\t\t\t}\n\t\t\tupdatedColors.push(id);\n\t\t}\n\n\t\tconst superfluousKeys = [...colors.keys()];\n\n\t\tlet errorText = '';\n\t\tif (missing.length > 0) {\n\t\t\terrorText += `\\n\\Adding the following colors:\\n\\n${JSON.stringify(missing, undefined, '\\t')}\\n`;\n\t\t}\n\t\tif (superfluousKeys.length > 0) {\n\t\t\terrorText += `\\n\\Removing the following colors:\\n\\n${superfluousKeys.join('\\n')}\\n`;\n\t\t}\n\n\t\tif (errorText.length > 0) {\n\t\t\tupdatedColors.sort();\n\t\t\tvariablesInfo.colors = updatedColors;\n\t\t\tawait pfs.Promises.writeFile(varFilePath, JSON.stringify(variablesInfo, undefined, '\\t'));\n\n\t\t\tassert.fail(`\\n\\Updating ${path.normalize(varFilePath)}.\\nPlease verify and commit.\\n\\n${errorText}\\n`);\n\t\t}\n\t});\n\n\ttest('all colors listed in theme-color.md', async function () {\n\t\t// avoid importing the TestEnvironmentService as it brings in a duplicate registration of the file editor input factory.\n\t\tconst environmentService = new class extends mock<INativeEnvironmentService>() { override args = { _: [] }; };\n\n\t\tconst docUrl = 'https://raw.githubusercontent.com/microsoft/vscode-docs/vnext/api/references/theme-color.md';\n\n\t\tconst reqContext = await new RequestService('local', new TestConfigurationService(), environmentService, new NullLogService()).request({ url: docUrl }, CancellationToken.None);\n\t\tconst content = (await asTextOrError(reqContext))!;\n\n\t\tconst expression = /-\\s*\\`([\\w\\.]+)\\`: (.*)/g;\n\n\t\tlet m: RegExpExecArray | null;\n\t\tconst colorsInDoc: { [id: string]: ColorInfo } = Object.create(null);\n\t\tlet nColorsInDoc = 0;\n\t\twhile (m = expression.exec(content)) {\n\t\t\tcolorsInDoc[m[1]] = { description: m[2], offset: m.index, length: m.length };\n\t\t\tnColorsInDoc++;\n\t\t}\n\t\tassert.ok(nColorsInDoc > 0, 'theme-color.md contains to color descriptions');\n\n\t\tconst missing = Object.create(null);\n\t\tconst descriptionDiffs: { [id: string]: DescriptionDiff } = Object.create(null);\n\n\t\tconst themingRegistry = Registry.as<IColorRegistry>(Extensions.ColorContribution);\n\t\tfor (const color of themingRegistry.getColors()) {\n\t\t\tif (!colorsInDoc[color.id]) {\n\t\t\t\tif (!color.deprecationMessage) {\n\t\t\t\t\tmissing[color.id] = getDescription(color);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst docDescription = colorsInDoc[color.id].description;\n\t\t\t\tconst specDescription = getDescription(color);\n\t\t\t\tif (docDescription !== specDescription) {\n\t\t\t\t\tdescriptionDiffs[color.id] = { docDescription, specDescription };\n\t\t\t\t}\n\t\t\t\tdelete colorsInDoc[color.id];\n\t\t\t}\n\t\t}\n\t\tconst colorsInExtensions = await getColorsFromExtension();\n\t\tfor (const colorId in colorsInExtensions) {\n\t\t\tif (!colorsInDoc[colorId]) {\n\t\t\t\tmissing[colorId] = colorsInExtensions[colorId];\n\t\t\t} else {\n\t\t\t\tdelete colorsInDoc[colorId];\n\t\t\t}\n\t\t}\n\t\tfor (const colorId of experimental) {\n\t\t\tif (missing[colorId]) {\n\t\t\t\tdelete missing[colorId];\n\t\t\t}\n\t\t\tif (colorsInDoc[colorId]) {\n\t\t\t\tassert.fail(`Color ${colorId} found in doc but marked experimental. Please remove from experimental list.`);\n\t\t\t}\n\t\t}\n\t\tconst superfluousKeys = Object.keys(colorsInDoc);\n\t\tconst undocumentedKeys = Object.keys(missing).map(k => `\\`${k}\\`: ${missing[k]}`);\n\n\n\t\tlet errorText = '';\n\t\tif (undocumentedKeys.length > 0) {\n\t\t\terrorText += `\\n\\nAdd the following colors:\\n\\n${undocumentedKeys.join('\\n')}\\n`;\n\t\t}\n\t\tif (superfluousKeys.length > 0) {\n\t\t\terrorText += `\\n\\Remove the following colors:\\n\\n${superfluousKeys.join('\\n')}\\n`;\n\t\t}\n\n\t\tif (errorText.length > 0) {\n\t\t\tassert.fail(`\\n\\nOpen https://github.dev/microsoft/vscode-docs/blob/vnext/api/references/theme-color.md#50${errorText}`);\n\t\t}\n\t});\n});\n\nfunction getDescription(color: ColorContribution) {\n\tlet specDescription = color.description;\n\tif (color.deprecationMessage) {\n\t\tspecDescription = specDescription + ' ' + color.deprecationMessage;\n\t}\n\treturn specDescription;\n}\n\nasync function getColorsFromExtension(): Promise<{ [id: string]: string }> {\n\tconst extPath = FileAccess.asFileUri('vs/../../extensions').fsPath;\n\tconst extFolders = await pfs.Promises.readDirsInDir(extPath);\n\tconst result: { [id: string]: string } = Object.create(null);\n\tfor (const folder of extFolders) {\n\t\ttry {\n\t\t\tconst packageJSON = JSON.parse((await fs.promises.readFile(path.join(extPath, folder, 'package.json'))).toString());\n\t\t\tconst contributes = packageJSON['contributes'];\n\t\t\tif (contributes) {\n\t\t\t\tconst colors = contributes['colors'];\n\t\t\t\tif (colors) {\n\t\t\t\t\tfor (const color of colors) {\n\t\t\t\t\t\tconst colorId = color['id'];\n\t\t\t\t\t\tif (colorId) {\n\t\t\t\t\t\t\tresult[colorId] = colorId['description'];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t// ignore\n\t\t}\n\n\t}\n\treturn result;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as fs from 'fs';\nimport { Registry } from '../../../../../platform/registry/common/platform.js';\nimport { IColorRegistry, Extensions, ColorContribution, asCssVariableName } from '../../../../../platform/theme/common/colorRegistry.js';\nimport { asTextOrError } from '../../../../../platform/request/common/request.js';\nimport * as pfs from '../../../../../base/node/pfs.js';\nimport * as path from '../../../../../base/common/path.js';\nimport assert from 'assert';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { RequestService } from '../../../../../platform/request/node/requestService.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\n// eslint-disable-next-line local/code-import-patterns\nimport '../../../../workbench.desktop.main.js';\nimport { NullLogService } from '../../../../../platform/log/common/log.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { INativeEnvironmentService } from '../../../../../platform/environment/common/environment.js';\nimport { FileAccess } from '../../../../../base/common/network.js';\n\ninterface ColorInfo {\n\tdescription: string;\n\toffset: number;\n\tlength: number;\n}\n\ninterface DescriptionDiff {\n\tdocDescription: string;\n\tspecDescription: string;\n}\n\nexport const experimental: string[] = []; // 'settings.modifiedItemForeground', 'editorUnnecessary.foreground' ];\n\n\nconst knwonVariablesFileName = 'vscode-known-variables.json';\n\nsuite('Color Registry', function () {\n\n\ttest(`update colors in ${knwonVariablesFileName}`, async function () {\n\t\tconst varFilePath = FileAccess.asFileUri(`vs/../../build/lib/stylelint/${knwonVariablesFileName}`).fsPath;\n\t\tconst content = (await fs.promises.readFile(varFilePath)).toString();\n\n\t\tconst variablesInfo = JSON.parse(content);\n\n\t\tconst colorsArray = variablesInfo.colors as string[];\n\n\t\tassert.ok(colorsArray && colorsArray.length > 0, '${knwonVariablesFileName} contains no color descriptions');\n\n\t\tconst colors = new Set(colorsArray);\n\n\t\tconst updatedColors = [];\n\t\tconst missing = [];\n\t\tconst themingRegistry = Registry.as<IColorRegistry>(Extensions.ColorContribution);\n\t\tfor (const color of themingRegistry.getColors()) {\n\t\t\tconst id = asCssVariableName(color.id);\n\n\t\t\tif (!colors.has(id)) {\n\t\t\t\tif (!color.deprecationMessage) {\n\t\t\t\t\tmissing.push(id);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tcolors.delete(id);\n\t\t\t}\n\t\t\tupdatedColors.push(id);\n\t\t}\n\n\t\tconst superfluousKeys = [...colors.keys()];\n\n\t\tlet errorText = '';\n\t\tif (missing.length > 0) {\n\t\t\terrorText += `\\n\\Adding the following colors:\\n\\n${JSON.stringify(missing, undefined, '\\t')}\\n`;\n\t\t}\n\t\tif (superfluousKeys.length > 0) {\n\t\t\terrorText += `\\n\\Removing the following colors:\\n\\n${superfluousKeys.join('\\n')}\\n`;\n\t\t}\n\n\t\tif (errorText.length > 0) {\n\t\t\tupdatedColors.sort();\n\t\t\tvariablesInfo.colors = updatedColors;\n\t\t\tawait pfs.Promises.writeFile(varFilePath, JSON.stringify(variablesInfo, undefined, '\\t'));\n\n\t\t\tassert.fail(`\\n\\Updating ${path.normalize(varFilePath)}.\\nPlease verify and commit.\\n\\n${errorText}\\n`);\n\t\t}\n\t});\n\n\ttest('all colors listed in theme-color.md', async function () {\n\t\t// avoid importing the TestEnvironmentService as it brings in a duplicate registration of the file editor input factory.\n\t\tconst environmentService = new class extends mock<INativeEnvironmentService>() { override args = { _: [] }; };\n\n\t\tconst docUrl = 'https://raw.githubusercontent.com/microsoft/vscode-docs/vnext/api/references/theme-color.md';\n\n\t\tconst reqContext = await new RequestService('local', new TestConfigurationService(), environmentService, new NullLogService()).request({ url: docUrl }, CancellationToken.None);\n\t\tconst content = (await asTextOrError(reqContext))!;\n\n\t\tconst expression = /-\\s*\\`([\\w\\.]+)\\`: (.*)/g;\n\n\t\tlet m: RegExpExecArray | null;\n\t\tconst colorsInDoc: { [id: string]: ColorInfo } = Object.create(null);\n\t\tlet nColorsInDoc = 0;\n\t\twhile (m = expression.exec(content)) {\n\t\t\tcolorsInDoc[m[1]] = { description: m[2], offset: m.index, length: m.length };\n\t\t\tnColorsInDoc++;\n\t\t}\n\t\tassert.ok(nColorsInDoc > 0, 'theme-color.md contains to color descriptions');\n\n\t\tconst missing = Object.create(null);\n\t\tconst descriptionDiffs: { [id: string]: DescriptionDiff } = Object.create(null);\n\n\t\tconst themingRegistry = Registry.as<IColorRegistry>(Extensions.ColorContribution);\n\t\tfor (const color of themingRegistry.getColors()) {\n\t\t\tif (!colorsInDoc[color.id]) {\n\t\t\t\tif (!color.deprecationMessage) {\n\t\t\t\t\tmissing[color.id] = getDescription(color);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst docDescription = colorsInDoc[color.id].description;\n\t\t\t\tconst specDescription = getDescription(color);\n\t\t\t\tif (docDescription !== specDescription) {\n\t\t\t\t\tdescriptionDiffs[color.id] = { docDescription, specDescription };\n\t\t\t\t}\n\t\t\t\tdelete colorsInDoc[color.id];\n\t\t\t}\n\t\t}\n\t\tconst colorsInExtensions = await getColorsFromExtension();\n\t\tfor (const colorId in colorsInExtensions) {\n\t\t\tif (!colorsInDoc[colorId]) {\n\t\t\t\tmissing[colorId] = colorsInExtensions[colorId];\n\t\t\t} else {\n\t\t\t\tdelete colorsInDoc[colorId];\n\t\t\t}\n\t\t}\n\t\tfor (const colorId of experimental) {\n\t\t\tif (missing[colorId]) {\n\t\t\t\tdelete missing[colorId];\n\t\t\t}\n\t\t\tif (colorsInDoc[colorId]) {\n\t\t\t\tassert.fail(`Color ${colorId} found in doc but marked experimental. Please remove from experimental list.`);\n\t\t\t}\n\t\t}\n\t\tconst superfluousKeys = Object.keys(colorsInDoc);\n\t\tconst undocumentedKeys = Object.keys(missing).map(k => `\\`${k}\\`: ${missing[k]}`);\n\n\n\t\tlet errorText = '';\n\t\tif (undocumentedKeys.length > 0) {\n\t\t\terrorText += `\\n\\nAdd the following colors:\\n\\n${undocumentedKeys.join('\\n')}\\n`;\n\t\t}\n\t\tif (superfluousKeys.length > 0) {\n\t\t\terrorText += `\\n\\Remove the following colors:\\n\\n${superfluousKeys.join('\\n')}\\n`;\n\t\t}\n\n\t\tif (errorText.length > 0) {\n\t\t\tassert.fail(`\\n\\nOpen https://github.dev/microsoft/vscode-docs/blob/vnext/api/references/theme-color.md#50${errorText}`);\n\t\t}\n\t});\n});\n\nfunction getDescription(color: ColorContribution) {\n\tlet specDescription = color.description;\n\tif (color.deprecationMessage) {\n\t\tspecDescription = specDescription + ' ' + color.deprecationMessage;\n\t}\n\treturn specDescription;\n}\n\nasync function getColorsFromExtension(): Promise<{ [id: string]: string }> {\n\tconst extPath = FileAccess.asFileUri('vs/../../extensions').fsPath;\n\tconst extFolders = await pfs.Promises.readDirsInDir(extPath);\n\tconst result: { [id: string]: string } = Object.create(null);\n\tfor (const folder of extFolders) {\n\t\ttry {\n\t\t\tconst packageJSON = JSON.parse((await fs.promises.readFile(path.join(extPath, folder, 'package.json'))).toString());\n\t\t\tconst contributes = packageJSON['contributes'];\n\t\t\tif (contributes) {\n\t\t\t\tconst colors = contributes['colors'];\n\t\t\t\tif (colors) {\n\t\t\t\t\tfor (const color of colors) {\n\t\t\t\t\t\tconst colorId = color['id'];\n\t\t\t\t\t\tif (colorId) {\n\t\t\t\t\t\t\tresult[colorId] = colorId['description'];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t// ignore\n\t\t}\n\n\t}\n\treturn result;\n}\n"]}