{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/mcp/test/common/mcpSamplingLog.test.ts","vs/workbench/contrib/mcp/test/common/mcpSamplingLog.test.ts"],"names":[],"mappings":"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","file":"mcpSamplingLog.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as assert from 'assert';\nimport * as sinon from 'sinon';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport {\n\tStorageScope\n} from '../../../../../platform/storage/common/storage.js';\nimport { TestStorageService } from '../../../../test/common/workbenchTestServices.js';\nimport { ISamplingStoredData, McpSamplingLog } from '../../common/mcpSamplingLog.js';\nimport { IMcpServer } from '../../common/mcpTypes.js';\n\nsuite('MCP - Sampling Log', () => {\n\tconst ds = ensureNoDisposablesAreLeakedInTestSuite();\n\tconst fakeServer: IMcpServer = {\n\t\tdefinition: { id: 'testServer' },\n\t\treadDefinitions: () => ({\n\t\t\tget: () => ({ collection: { scope: StorageScope.APPLICATION } }),\n\t\t}),\n\t} as IMcpServer;\n\n\tlet log: McpSamplingLog;\n\tlet storage: TestStorageService;\n\tlet clock: sinon.SinonFakeTimers;\n\n\tsetup(() => {\n\t\tstorage = ds.add(new TestStorageService());\n\t\tlog = ds.add(new McpSamplingLog(storage));\n\t\tclock = sinon.useFakeTimers();\n\t\tclock.setSystemTime(new Date('2023-10-01T00:00:00Z').getTime());\n\t});\n\n\tteardown(() => {\n\t\tclock.restore();\n\t});\n\n\ttest('logs a single request', async () => {\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'test request' } }],\n\t\t\t'test response here',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// storage.testEmitWillSaveState(WillSaveStateReason.NONE);\n\t\tawait storage.flush();\n\t\tassert.deepStrictEqual(\n\t\t\t(storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as unknown),\n\t\t\t[\n\t\t\t\t[\n\t\t\t\t\t'testServer',\n\t\t\t\t\t{\n\t\t\t\t\t\thead: 19631,\n\t\t\t\t\t\tbins: [1, 0, 0, 0, 0, 0, 0],\n\t\t\t\t\t\tlastReqs: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\trequest: [{ role: 'user', content: { type: 'text', text: 'test request' } }],\n\t\t\t\t\t\t\t\tresponse: 'test response here',\n\t\t\t\t\t\t\t\tat: 1696118400000,\n\t\t\t\t\t\t\t\tmodel: 'foobar9000',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t],\n\t\t);\n\t});\n\n\ttest('logs multiple requests on the same day', async () => {\n\t\t// First request\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'first request' } }],\n\t\t\t'first response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// Advance time by a few hours but stay on the same day\n\t\tclock.tick(5 * 60 * 60 * 1000); // 5 hours\n\n\t\t// Second request\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'second request' } }],\n\t\t\t'second response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst data = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, any][])[0][1];\n\n\t\t// Verify the bin for the current day has 2 requests\n\t\tassert.strictEqual(data.bins[0], 2);\n\n\t\t// Verify both requests are in the lastReqs array, with the most recent first\n\t\tassert.strictEqual(data.lastReqs.length, 2);\n\t\tassert.strictEqual(data.lastReqs[0].request[0].content.text, 'second request');\n\t\tassert.strictEqual(data.lastReqs[1].request[0].content.text, 'first request');\n\t});\n\n\ttest('shifts bins when adding requests on different days', async () => {\n\t\t// First request on day 1\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'day 1 request' } }],\n\t\t\t'day 1 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// Advance time to the next day\n\t\tclock.tick(24 * 60 * 60 * 1000);\n\n\t\t// Second request on day 2\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'day 2 request' } }],\n\t\t\t'day 2 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst data = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][])[0][1];\n\n\t\t// Verify the bins: day 2 should have 1 request, day 1 should have 1 request\n\t\tassert.strictEqual(data.bins[0], 1); // day 2\n\t\tassert.strictEqual(data.bins[1], 1); // day 1\n\n\t\t// Advance time by 5 more days\n\t\tclock.tick(5 * 24 * 60 * 60 * 1000);\n\n\t\t// Request on day 7\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'day 7 request' } }],\n\t\t\t'day 7 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst updatedData = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][])[0][1];\n\n\t\t// Verify the bins have shifted correctly\n\t\tassert.strictEqual(updatedData.bins[0], 1); // day 7\n\t\tassert.strictEqual(updatedData.bins[5], 1); // day 2\n\t\tassert.strictEqual(updatedData.bins[6], 1); // day 1\n\t});\n\n\ttest('limits the number of stored requests', async () => {\n\t\t// Add more than the maximum number of requests (Constants.SamplingLastNMessage = 30)\n\t\tfor (let i = 0; i < 35; i++) {\n\t\t\tlog.add(\n\t\t\t\tfakeServer,\n\t\t\t\t[{ role: 'user', content: { type: 'text', text: `request ${i}` } }],\n\t\t\t\t`response ${i}`,\n\t\t\t\t'foobar9000',\n\t\t\t);\n\t\t}\n\n\t\tawait storage.flush();\n\t\tconst data = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][])[0][1];\n\n\t\t// Verify only the last 30 requests are kept\n\t\tassert.strictEqual(data.lastReqs.length, 30);\n\t\tassert.strictEqual((data.lastReqs[0].request[0].content as { type: 'text'; text: string }).text, 'request 34');\n\t\tassert.strictEqual((data.lastReqs[29].request[0].content as { type: 'text'; text: string }).text, 'request 5');\n\t});\n\n\ttest('handles different content types', async () => {\n\t\t// Add a request with text content\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'text request' } }],\n\t\t\t'text response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// Add a request with image content\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{\n\t\t\t\trole: 'user',\n\t\t\t\tcontent: {\n\t\t\t\t\ttype: 'image',\n\t\t\t\t\tdata: 'base64data',\n\t\t\t\t\tmimeType: 'image/png'\n\t\t\t\t}\n\t\t\t}],\n\t\t\t'image response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// Add a request with mixed content\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[\n\t\t\t\t{ role: 'user', content: { type: 'text', text: 'text and image' } },\n\t\t\t\t{\n\t\t\t\t\trole: 'assistant',\n\t\t\t\t\tcontent: {\n\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\tdata: 'base64data',\n\t\t\t\t\t\tmimeType: 'image/jpeg'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\t'mixed response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst data = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][])[0][1];\n\n\t\t// Verify all requests are stored correctly\n\t\tassert.strictEqual(data.lastReqs.length, 3);\n\t\tassert.strictEqual(data.lastReqs[0].request.length, 2); // Mixed content request has 2 messages\n\t\tassert.strictEqual(data.lastReqs[1].request[0].content.type, 'image');\n\t\tassert.strictEqual(data.lastReqs[2].request[0].content.type, 'text');\n\t});\n\n\ttest('handles multiple servers', async () => {\n\t\tconst fakeServer2: IMcpServer = {\n\t\t\tdefinition: { id: 'testServer2' },\n\t\t\treadDefinitions: () => ({\n\t\t\t\tget: () => ({ collection: { scope: StorageScope.APPLICATION } }),\n\t\t\t}),\n\t\t} as IMcpServer;\n\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'server1 request' } }],\n\t\t\t'server1 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tlog.add(\n\t\t\tfakeServer2,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'server2 request' } }],\n\t\t\t'server2 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst storageData = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][]);\n\n\t\t// Verify both servers have their data stored\n\t\tassert.strictEqual(storageData.length, 2);\n\t\tassert.strictEqual(storageData[0][0], 'testServer');\n\t\tassert.strictEqual(storageData[1][0], 'testServer2');\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as assert from 'assert';\nimport * as sinon from 'sinon';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport {\n\tStorageScope\n} from '../../../../../platform/storage/common/storage.js';\nimport { TestStorageService } from '../../../../test/common/workbenchTestServices.js';\nimport { ISamplingStoredData, McpSamplingLog } from '../../common/mcpSamplingLog.js';\nimport { IMcpServer } from '../../common/mcpTypes.js';\n\nsuite('MCP - Sampling Log', () => {\n\tconst ds = ensureNoDisposablesAreLeakedInTestSuite();\n\tconst fakeServer: IMcpServer = {\n\t\tdefinition: { id: 'testServer' },\n\t\treadDefinitions: () => ({\n\t\t\tget: () => ({ collection: { scope: StorageScope.APPLICATION } }),\n\t\t}),\n\t} as IMcpServer;\n\n\tlet log: McpSamplingLog;\n\tlet storage: TestStorageService;\n\tlet clock: sinon.SinonFakeTimers;\n\n\tsetup(() => {\n\t\tstorage = ds.add(new TestStorageService());\n\t\tlog = ds.add(new McpSamplingLog(storage));\n\t\tclock = sinon.useFakeTimers();\n\t\tclock.setSystemTime(new Date('2023-10-01T00:00:00Z').getTime());\n\t});\n\n\tteardown(() => {\n\t\tclock.restore();\n\t});\n\n\ttest('logs a single request', async () => {\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'test request' } }],\n\t\t\t'test response here',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// storage.testEmitWillSaveState(WillSaveStateReason.NONE);\n\t\tawait storage.flush();\n\t\tassert.deepStrictEqual(\n\t\t\t(storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as unknown),\n\t\t\t[\n\t\t\t\t[\n\t\t\t\t\t'testServer',\n\t\t\t\t\t{\n\t\t\t\t\t\thead: 19631,\n\t\t\t\t\t\tbins: [1, 0, 0, 0, 0, 0, 0],\n\t\t\t\t\t\tlastReqs: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\trequest: [{ role: 'user', content: { type: 'text', text: 'test request' } }],\n\t\t\t\t\t\t\t\tresponse: 'test response here',\n\t\t\t\t\t\t\t\tat: 1696118400000,\n\t\t\t\t\t\t\t\tmodel: 'foobar9000',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t],\n\t\t);\n\t});\n\n\ttest('logs multiple requests on the same day', async () => {\n\t\t// First request\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'first request' } }],\n\t\t\t'first response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// Advance time by a few hours but stay on the same day\n\t\tclock.tick(5 * 60 * 60 * 1000); // 5 hours\n\n\t\t// Second request\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'second request' } }],\n\t\t\t'second response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst data = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, any][])[0][1];\n\n\t\t// Verify the bin for the current day has 2 requests\n\t\tassert.strictEqual(data.bins[0], 2);\n\n\t\t// Verify both requests are in the lastReqs array, with the most recent first\n\t\tassert.strictEqual(data.lastReqs.length, 2);\n\t\tassert.strictEqual(data.lastReqs[0].request[0].content.text, 'second request');\n\t\tassert.strictEqual(data.lastReqs[1].request[0].content.text, 'first request');\n\t});\n\n\ttest('shifts bins when adding requests on different days', async () => {\n\t\t// First request on day 1\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'day 1 request' } }],\n\t\t\t'day 1 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// Advance time to the next day\n\t\tclock.tick(24 * 60 * 60 * 1000);\n\n\t\t// Second request on day 2\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'day 2 request' } }],\n\t\t\t'day 2 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst data = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][])[0][1];\n\n\t\t// Verify the bins: day 2 should have 1 request, day 1 should have 1 request\n\t\tassert.strictEqual(data.bins[0], 1); // day 2\n\t\tassert.strictEqual(data.bins[1], 1); // day 1\n\n\t\t// Advance time by 5 more days\n\t\tclock.tick(5 * 24 * 60 * 60 * 1000);\n\n\t\t// Request on day 7\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'day 7 request' } }],\n\t\t\t'day 7 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst updatedData = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][])[0][1];\n\n\t\t// Verify the bins have shifted correctly\n\t\tassert.strictEqual(updatedData.bins[0], 1); // day 7\n\t\tassert.strictEqual(updatedData.bins[5], 1); // day 2\n\t\tassert.strictEqual(updatedData.bins[6], 1); // day 1\n\t});\n\n\ttest('limits the number of stored requests', async () => {\n\t\t// Add more than the maximum number of requests (Constants.SamplingLastNMessage = 30)\n\t\tfor (let i = 0; i < 35; i++) {\n\t\t\tlog.add(\n\t\t\t\tfakeServer,\n\t\t\t\t[{ role: 'user', content: { type: 'text', text: `request ${i}` } }],\n\t\t\t\t`response ${i}`,\n\t\t\t\t'foobar9000',\n\t\t\t);\n\t\t}\n\n\t\tawait storage.flush();\n\t\tconst data = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][])[0][1];\n\n\t\t// Verify only the last 30 requests are kept\n\t\tassert.strictEqual(data.lastReqs.length, 30);\n\t\tassert.strictEqual((data.lastReqs[0].request[0].content as { type: 'text'; text: string }).text, 'request 34');\n\t\tassert.strictEqual((data.lastReqs[29].request[0].content as { type: 'text'; text: string }).text, 'request 5');\n\t});\n\n\ttest('handles different content types', async () => {\n\t\t// Add a request with text content\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'text request' } }],\n\t\t\t'text response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// Add a request with image content\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{\n\t\t\t\trole: 'user',\n\t\t\t\tcontent: {\n\t\t\t\t\ttype: 'image',\n\t\t\t\t\tdata: 'base64data',\n\t\t\t\t\tmimeType: 'image/png'\n\t\t\t\t}\n\t\t\t}],\n\t\t\t'image response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\t// Add a request with mixed content\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[\n\t\t\t\t{ role: 'user', content: { type: 'text', text: 'text and image' } },\n\t\t\t\t{\n\t\t\t\t\trole: 'assistant',\n\t\t\t\t\tcontent: {\n\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\tdata: 'base64data',\n\t\t\t\t\t\tmimeType: 'image/jpeg'\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\t'mixed response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst data = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][])[0][1];\n\n\t\t// Verify all requests are stored correctly\n\t\tassert.strictEqual(data.lastReqs.length, 3);\n\t\tassert.strictEqual(data.lastReqs[0].request.length, 2); // Mixed content request has 2 messages\n\t\tassert.strictEqual(data.lastReqs[1].request[0].content.type, 'image');\n\t\tassert.strictEqual(data.lastReqs[2].request[0].content.type, 'text');\n\t});\n\n\ttest('handles multiple servers', async () => {\n\t\tconst fakeServer2: IMcpServer = {\n\t\t\tdefinition: { id: 'testServer2' },\n\t\t\treadDefinitions: () => ({\n\t\t\t\tget: () => ({ collection: { scope: StorageScope.APPLICATION } }),\n\t\t\t}),\n\t\t} as IMcpServer;\n\n\t\tlog.add(\n\t\t\tfakeServer,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'server1 request' } }],\n\t\t\t'server1 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tlog.add(\n\t\t\tfakeServer2,\n\t\t\t[{ role: 'user', content: { type: 'text', text: 'server2 request' } }],\n\t\t\t'server2 response',\n\t\t\t'foobar9000',\n\t\t);\n\n\t\tawait storage.flush();\n\t\tconst storageData = (storage.getObject('mcp.sampling.logs', StorageScope.APPLICATION) as [string, ISamplingStoredData][]);\n\n\t\t// Verify both servers have their data stored\n\t\tassert.strictEqual(storageData.length, 2);\n\t\tassert.strictEqual(storageData[0][0], 'testServer');\n\t\tassert.strictEqual(storageData[1][0], 'testServer2');\n\t});\n});\n"]}