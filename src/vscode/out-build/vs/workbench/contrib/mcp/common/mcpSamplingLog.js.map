{"version":3,"sources":["vs/workbench/contrib/mcp/common/mcpSamplingLog.ts"],"names":[],"mappings":"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","file":"mcpSamplingLog.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { localize } from '../../../../nls.js';\nimport { ObservableMemento, observableMemento } from '../../../../platform/observable/common/observableMemento.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { IMcpServer } from './mcpTypes.js';\nimport { MCP } from './modelContextProtocol.js';\n\nconst enum Constants {\n\tSamplingRetentionDays = 7,\n\tMsPerDay = 24 * 60 * 60 * 1000,\n\tSamplingRetentionMs = SamplingRetentionDays * MsPerDay,\n\tSamplingLastNMessage = 30,\n}\n\nexport interface ISamplingStoredData {\n\t// UTC day ordinal of the first bin in the bins\n\thead: number;\n\t// Requests per day, max length of `Constants.SamplingRetentionDays`\n\tbins: number[];\n\t// Last sampling requests/responses\n\tlastReqs: { request: MCP.SamplingMessage[]; response: string; at: number; model: string }[];\n}\n\nconst samplingMemento = observableMemento<ReadonlyMap<string, ISamplingStoredData>>({\n\tdefaultValue: new Map(),\n\tkey: 'mcp.sampling.logs',\n\ttoStorage: v => JSON.stringify(Array.from(v.entries())),\n\tfromStorage: v => new Map(JSON.parse(v)),\n});\n\nexport class McpSamplingLog extends Disposable {\n\tprivate readonly _logs: { [K in StorageScope]?: ObservableMemento<ReadonlyMap<string, ISamplingStoredData>> } = {};\n\n\tconstructor(\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t) {\n\t\tsuper();\n\t}\n\n\tpublic has(server: IMcpServer): boolean {\n\t\tconst storage = this._getLogStorageForServer(server);\n\t\treturn storage.get().has(server.definition.id);\n\t}\n\n\tpublic get(server: IMcpServer): Readonly<ISamplingStoredData | undefined> {\n\t\tconst storage = this._getLogStorageForServer(server);\n\t\treturn storage.get().get(server.definition.id);\n\t}\n\n\tpublic getAsText(server: IMcpServer): string {\n\t\tconst storage = this._getLogStorageForServer(server);\n\t\tconst record = storage.get().get(server.definition.id);\n\t\tif (!record) {\n\t\t\treturn '';\n\t\t}\n\n\t\tconst parts: string[] = [];\n\t\tconst total = record.bins.reduce((sum, value) => sum + value, 0);\n\t\tparts.push(localize('mcp.sampling.rpd', '{0} total requests in the last 7 days.', total));\n\n\t\tparts.push(this._formatRecentRequests(record));\n\t\treturn parts.join('\\n');\n\t}\n\n\tprivate _formatRecentRequests(data: ISamplingStoredData): string {\n\t\tif (!data.lastReqs.length) {\n\t\t\treturn '\\nNo recent requests.';\n\t\t}\n\n\t\tconst result: string[] = [];\n\t\tfor (let i = 0; i < data.lastReqs.length; i++) {\n\t\t\tconst { request, response, at, model } = data.lastReqs[i];\n\t\t\tresult.push(`\\n[${i + 1}] ${new Date(at).toISOString()} ${model}`);\n\n\t\t\tresult.push('  Request:');\n\t\t\tfor (const msg of request) {\n\t\t\t\tconst role = msg.role.padEnd(9);\n\t\t\t\tlet content = '';\n\t\t\t\tif ('text' in msg.content && msg.content.type === 'text') {\n\t\t\t\t\tcontent = msg.content.text;\n\t\t\t\t} else if ('data' in msg.content) {\n\t\t\t\t\tcontent = `[${msg.content.type} data: ${msg.content.mimeType}]`;\n\t\t\t\t}\n\t\t\t\tresult.push(`    ${role}: ${content}`);\n\t\t\t}\n\t\t\tresult.push('  Response:');\n\t\t\tresult.push(`    ${response}`);\n\t\t}\n\n\t\treturn result.join('\\n');\n\t}\n\n\tpublic async add(server: IMcpServer, request: MCP.SamplingMessage[], response: string, model: string) {\n\t\tconst now = Date.now();\n\t\tconst utcOrdinal = Math.floor(now / Constants.MsPerDay);\n\t\tconst storage = this._getLogStorageForServer(server);\n\n\t\tconst next = new Map(storage.get());\n\t\tlet record = next.get(server.definition.id);\n\t\tif (!record) {\n\t\t\trecord = {\n\t\t\t\thead: utcOrdinal,\n\t\t\t\tbins: Array.from({ length: Constants.SamplingRetentionDays }, () => 0),\n\t\t\t\tlastReqs: [],\n\t\t\t};\n\t\t} else {\n\t\t\t// Shift bins back by daysSinceHead, dropping old days\n\t\t\tfor (let i = 0; i < (utcOrdinal - record.head) && i < Constants.SamplingRetentionDays; i++) {\n\t\t\t\trecord.bins.pop();\n\t\t\t\trecord.bins.unshift(0);\n\t\t\t}\n\t\t\trecord.head = utcOrdinal;\n\t\t}\n\n\t\t// Increment the current day's bin (head)\n\t\trecord.bins[0]++;\n\t\trecord.lastReqs.unshift({ request, response, at: now, model });\n\t\twhile (record.lastReqs.length > Constants.SamplingLastNMessage) {\n\t\t\trecord.lastReqs.pop();\n\t\t}\n\n\t\tnext.set(server.definition.id, record);\n\t\tstorage.set(next, undefined);\n\t}\n\n\tprivate _getLogStorageForServer(server: IMcpServer) {\n\t\tconst scope = server.readDefinitions().get().collection?.scope ?? StorageScope.WORKSPACE;\n\t\treturn this._logs[scope] ??= this._register(samplingMemento(scope, StorageTarget.MACHINE, this._storageService));\n\t}\n}\n"]}