{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/mcp/common/discovery/installedMcpServersDiscovery.ts","vs/workbench/contrib/mcp/common/discovery/installedMcpServersDiscovery.ts"],"names":[],"mappings":"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","file":"installedMcpServersDiscovery.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { equals } from '../../../../../base/common/arrays.js';\nimport { Throttler } from '../../../../../base/common/async.js';\nimport { Disposable, DisposableMap, DisposableStore, IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../../../base/common/map.js';\nimport { ISettableObservable, observableValue } from '../../../../../base/common/observable.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { Location } from '../../../../../editor/common/languages.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { ConfigurationTarget } from '../../../../../platform/configuration/common/configuration.js';\nimport { ILogService } from '../../../../../platform/log/common/log.js';\nimport { StorageScope } from '../../../../../platform/storage/common/storage.js';\nimport { IWorkbenchLocalMcpServer } from '../../../../services/mcp/common/mcpWorkbenchManagementService.js';\nimport { getMcpServerMapping } from '../mcpConfigFileUtils.js';\nimport { mcpConfigurationSection } from '../mcpConfiguration.js';\nimport { IMcpRegistry } from '../mcpRegistryTypes.js';\nimport { IMcpConfigPath, IMcpWorkbenchService, McpCollectionDefinition, McpServerDefinition, McpServerLaunch, McpServerTransportType, McpServerTrust } from '../mcpTypes.js';\nimport { IMcpDiscovery } from './mcpDiscovery.js';\n\ninterface CollectionState extends IDisposable {\n\tdefinition: McpCollectionDefinition;\n\tserverDefinitions: ISettableObservable<readonly McpServerDefinition[]>;\n}\n\nexport class InstalledMcpServersDiscovery extends Disposable implements IMcpDiscovery {\n\n\treadonly fromGallery = true;\n\tprivate readonly collections = this._register(new DisposableMap<string, CollectionState>());\n\n\tconstructor(\n\t\t@IMcpWorkbenchService private readonly mcpWorkbenchService: IMcpWorkbenchService,\n\t\t@IMcpRegistry private readonly mcpRegistry: IMcpRegistry,\n\t\t@ITextModelService private readonly textModelService: ITextModelService,\n\t\t@ILogService private readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t}\n\n\tpublic start(): void {\n\t\tconst throttler = this._register(new Throttler());\n\t\tthis._register(this.mcpWorkbenchService.onChange(() => throttler.queue(() => this.sync())));\n\t\tthis.sync();\n\t}\n\n\tprivate async getServerIdMapping(resource: URI, pathToServers: string[]): Promise<Map<string, Location>> {\n\t\tconst store = new DisposableStore();\n\t\ttry {\n\t\t\tconst ref = await this.textModelService.createModelReference(resource);\n\t\t\tstore.add(ref);\n\t\t\tconst serverIdMapping = getMcpServerMapping({ model: ref.object.textEditorModel, pathToServers });\n\t\t\treturn serverIdMapping;\n\t\t} catch {\n\t\t\treturn new Map();\n\t\t} finally {\n\t\t\tstore.dispose();\n\t\t}\n\t}\n\n\tprivate async sync(): Promise<void> {\n\t\ttry {\n\t\t\tconst collections = new Map<string, [IMcpConfigPath | undefined, McpServerDefinition[]]>();\n\t\t\tconst mcpConfigPathInfos = new ResourceMap<Promise<IMcpConfigPath & { locations: Map<string, Location> } | undefined>>();\n\t\t\tfor (const server of this.mcpWorkbenchService.getEnabledLocalMcpServers()) {\n\t\t\t\tlet mcpConfigPathPromise = mcpConfigPathInfos.get(server.mcpResource);\n\t\t\t\tif (!mcpConfigPathPromise) {\n\t\t\t\t\tmcpConfigPathPromise = (async (local: IWorkbenchLocalMcpServer) => {\n\t\t\t\t\t\tconst mcpConfigPath = this.mcpWorkbenchService.getMcpConfigPath(local);\n\t\t\t\t\t\tconst locations = mcpConfigPath?.uri ? await this.getServerIdMapping(mcpConfigPath?.uri, mcpConfigPath.section ? [...mcpConfigPath.section, 'servers'] : ['servers']) : new Map();\n\t\t\t\t\t\treturn mcpConfigPath ? { ...mcpConfigPath, locations } : undefined;\n\t\t\t\t\t})(server);\n\t\t\t\t\tmcpConfigPathInfos.set(server.mcpResource, mcpConfigPathPromise);\n\t\t\t\t}\n\n\t\t\t\tconst config = server.config;\n\t\t\t\tconst mcpConfigPath = await mcpConfigPathPromise;\n\t\t\t\tconst collectionId = `mcp.config.${mcpConfigPath ? mcpConfigPath.id : 'unknown'}`;\n\n\t\t\t\tlet definitions = collections.get(collectionId);\n\t\t\t\tif (!definitions) {\n\t\t\t\t\tdefinitions = [mcpConfigPath, []];\n\t\t\t\t\tcollections.set(collectionId, definitions);\n\t\t\t\t}\n\n\t\t\t\tconst launch: McpServerLaunch = config.type === 'http' ? {\n\t\t\t\t\ttype: McpServerTransportType.HTTP,\n\t\t\t\t\turi: URI.parse(config.url),\n\t\t\t\t\theaders: Object.entries(config.headers || {}),\n\t\t\t\t} : {\n\t\t\t\t\ttype: McpServerTransportType.Stdio,\n\t\t\t\t\tcommand: config.command,\n\t\t\t\t\targs: config.args || [],\n\t\t\t\t\tenv: config.env || {},\n\t\t\t\t\tenvFile: config.envFile,\n\t\t\t\t\tcwd: config.cwd,\n\t\t\t\t};\n\n\t\t\t\tdefinitions[1].push({\n\t\t\t\t\tid: `${collectionId}.${server.name}`,\n\t\t\t\t\tlabel: server.name,\n\t\t\t\t\tlaunch,\n\t\t\t\t\tcacheNonce: await McpServerLaunch.hash(launch),\n\t\t\t\t\troots: mcpConfigPath?.workspaceFolder ? [mcpConfigPath.workspaceFolder.uri] : undefined,\n\t\t\t\t\tvariableReplacement: {\n\t\t\t\t\t\tfolder: mcpConfigPath?.workspaceFolder,\n\t\t\t\t\t\tsection: mcpConfigurationSection,\n\t\t\t\t\t\ttarget: mcpConfigPath?.target ?? ConfigurationTarget.USER,\n\t\t\t\t\t},\n\t\t\t\t\tdevMode: config.dev,\n\t\t\t\t\tpresentation: {\n\t\t\t\t\t\torder: mcpConfigPath?.order,\n\t\t\t\t\t\torigin: mcpConfigPath?.locations.get(server.name)\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfor (const [id] of this.collections) {\n\t\t\t\tif (!collections.has(id)) {\n\t\t\t\t\tthis.collections.deleteAndDispose(id);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const [id, [mcpConfigPath, serverDefinitions]] of collections) {\n\t\t\t\tconst newServerDefinitions = observableValue<readonly McpServerDefinition[]>(this, serverDefinitions);\n\t\t\t\tconst newCollection: McpCollectionDefinition = {\n\t\t\t\t\tid,\n\t\t\t\t\tlabel: mcpConfigPath?.label ?? '',\n\t\t\t\t\tpresentation: {\n\t\t\t\t\t\torder: serverDefinitions[0]?.presentation?.order,\n\t\t\t\t\t\torigin: mcpConfigPath?.uri,\n\t\t\t\t\t},\n\t\t\t\t\tremoteAuthority: mcpConfigPath?.remoteAuthority ?? null,\n\t\t\t\t\tserverDefinitions: newServerDefinitions,\n\t\t\t\t\ttrustBehavior: McpServerTrust.Kind.Trusted,\n\t\t\t\t\tconfigTarget: mcpConfigPath?.target ?? ConfigurationTarget.USER,\n\t\t\t\t\tscope: mcpConfigPath?.scope ?? StorageScope.PROFILE,\n\t\t\t\t};\n\t\t\t\tconst existingCollection = this.collections.get(id);\n\n\t\t\t\tconst collectionDefinitionsChanged = existingCollection ? !McpCollectionDefinition.equals(existingCollection.definition, newCollection) : true;\n\t\t\t\tif (!collectionDefinitionsChanged) {\n\t\t\t\t\tconst serverDefinitionsChanged = existingCollection ? !equals(existingCollection.definition.serverDefinitions.get(), newCollection.serverDefinitions.get(), McpServerDefinition.equals) : true;\n\t\t\t\t\tif (serverDefinitionsChanged) {\n\t\t\t\t\t\texistingCollection?.serverDefinitions.set(serverDefinitions, undefined);\n\t\t\t\t\t}\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.collections.deleteAndDispose(id);\n\t\t\t\tconst disposable = this.mcpRegistry.registerCollection(newCollection);\n\t\t\t\tthis.collections.set(id, {\n\t\t\t\t\tdefinition: newCollection,\n\t\t\t\t\tserverDefinitions: newServerDefinitions,\n\t\t\t\t\tdispose: () => disposable.dispose()\n\t\t\t\t});\n\t\t\t}\n\n\t\t} catch (error) {\n\t\t\tthis.logService.error(error);\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { equals } from '../../../../../base/common/arrays.js';\nimport { Throttler } from '../../../../../base/common/async.js';\nimport { Disposable, DisposableMap, DisposableStore, IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../../../base/common/map.js';\nimport { ISettableObservable, observableValue } from '../../../../../base/common/observable.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { Location } from '../../../../../editor/common/languages.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { ConfigurationTarget } from '../../../../../platform/configuration/common/configuration.js';\nimport { ILogService } from '../../../../../platform/log/common/log.js';\nimport { StorageScope } from '../../../../../platform/storage/common/storage.js';\nimport { IWorkbenchLocalMcpServer } from '../../../../services/mcp/common/mcpWorkbenchManagementService.js';\nimport { getMcpServerMapping } from '../mcpConfigFileUtils.js';\nimport { mcpConfigurationSection } from '../mcpConfiguration.js';\nimport { IMcpRegistry } from '../mcpRegistryTypes.js';\nimport { IMcpConfigPath, IMcpWorkbenchService, McpCollectionDefinition, McpServerDefinition, McpServerLaunch, McpServerTransportType, McpServerTrust } from '../mcpTypes.js';\nimport { IMcpDiscovery } from './mcpDiscovery.js';\n\ninterface CollectionState extends IDisposable {\n\tdefinition: McpCollectionDefinition;\n\tserverDefinitions: ISettableObservable<readonly McpServerDefinition[]>;\n}\n\nexport class InstalledMcpServersDiscovery extends Disposable implements IMcpDiscovery {\n\n\treadonly fromGallery = true;\n\tprivate readonly collections = this._register(new DisposableMap<string, CollectionState>());\n\n\tconstructor(\n\t\t@IMcpWorkbenchService private readonly mcpWorkbenchService: IMcpWorkbenchService,\n\t\t@IMcpRegistry private readonly mcpRegistry: IMcpRegistry,\n\t\t@ITextModelService private readonly textModelService: ITextModelService,\n\t\t@ILogService private readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t}\n\n\tpublic start(): void {\n\t\tconst throttler = this._register(new Throttler());\n\t\tthis._register(this.mcpWorkbenchService.onChange(() => throttler.queue(() => this.sync())));\n\t\tthis.sync();\n\t}\n\n\tprivate async getServerIdMapping(resource: URI, pathToServers: string[]): Promise<Map<string, Location>> {\n\t\tconst store = new DisposableStore();\n\t\ttry {\n\t\t\tconst ref = await this.textModelService.createModelReference(resource);\n\t\t\tstore.add(ref);\n\t\t\tconst serverIdMapping = getMcpServerMapping({ model: ref.object.textEditorModel, pathToServers });\n\t\t\treturn serverIdMapping;\n\t\t} catch {\n\t\t\treturn new Map();\n\t\t} finally {\n\t\t\tstore.dispose();\n\t\t}\n\t}\n\n\tprivate async sync(): Promise<void> {\n\t\ttry {\n\t\t\tconst collections = new Map<string, [IMcpConfigPath | undefined, McpServerDefinition[]]>();\n\t\t\tconst mcpConfigPathInfos = new ResourceMap<Promise<IMcpConfigPath & { locations: Map<string, Location> } | undefined>>();\n\t\t\tfor (const server of this.mcpWorkbenchService.getEnabledLocalMcpServers()) {\n\t\t\t\tlet mcpConfigPathPromise = mcpConfigPathInfos.get(server.mcpResource);\n\t\t\t\tif (!mcpConfigPathPromise) {\n\t\t\t\t\tmcpConfigPathPromise = (async (local: IWorkbenchLocalMcpServer) => {\n\t\t\t\t\t\tconst mcpConfigPath = this.mcpWorkbenchService.getMcpConfigPath(local);\n\t\t\t\t\t\tconst locations = mcpConfigPath?.uri ? await this.getServerIdMapping(mcpConfigPath?.uri, mcpConfigPath.section ? [...mcpConfigPath.section, 'servers'] : ['servers']) : new Map();\n\t\t\t\t\t\treturn mcpConfigPath ? { ...mcpConfigPath, locations } : undefined;\n\t\t\t\t\t})(server);\n\t\t\t\t\tmcpConfigPathInfos.set(server.mcpResource, mcpConfigPathPromise);\n\t\t\t\t}\n\n\t\t\t\tconst config = server.config;\n\t\t\t\tconst mcpConfigPath = await mcpConfigPathPromise;\n\t\t\t\tconst collectionId = `mcp.config.${mcpConfigPath ? mcpConfigPath.id : 'unknown'}`;\n\n\t\t\t\tlet definitions = collections.get(collectionId);\n\t\t\t\tif (!definitions) {\n\t\t\t\t\tdefinitions = [mcpConfigPath, []];\n\t\t\t\t\tcollections.set(collectionId, definitions);\n\t\t\t\t}\n\n\t\t\t\tconst launch: McpServerLaunch = config.type === 'http' ? {\n\t\t\t\t\ttype: McpServerTransportType.HTTP,\n\t\t\t\t\turi: URI.parse(config.url),\n\t\t\t\t\theaders: Object.entries(config.headers || {}),\n\t\t\t\t} : {\n\t\t\t\t\ttype: McpServerTransportType.Stdio,\n\t\t\t\t\tcommand: config.command,\n\t\t\t\t\targs: config.args || [],\n\t\t\t\t\tenv: config.env || {},\n\t\t\t\t\tenvFile: config.envFile,\n\t\t\t\t\tcwd: config.cwd,\n\t\t\t\t};\n\n\t\t\t\tdefinitions[1].push({\n\t\t\t\t\tid: `${collectionId}.${server.name}`,\n\t\t\t\t\tlabel: server.name,\n\t\t\t\t\tlaunch,\n\t\t\t\t\tcacheNonce: await McpServerLaunch.hash(launch),\n\t\t\t\t\troots: mcpConfigPath?.workspaceFolder ? [mcpConfigPath.workspaceFolder.uri] : undefined,\n\t\t\t\t\tvariableReplacement: {\n\t\t\t\t\t\tfolder: mcpConfigPath?.workspaceFolder,\n\t\t\t\t\t\tsection: mcpConfigurationSection,\n\t\t\t\t\t\ttarget: mcpConfigPath?.target ?? ConfigurationTarget.USER,\n\t\t\t\t\t},\n\t\t\t\t\tdevMode: config.dev,\n\t\t\t\t\tpresentation: {\n\t\t\t\t\t\torder: mcpConfigPath?.order,\n\t\t\t\t\t\torigin: mcpConfigPath?.locations.get(server.name)\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfor (const [id] of this.collections) {\n\t\t\t\tif (!collections.has(id)) {\n\t\t\t\t\tthis.collections.deleteAndDispose(id);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const [id, [mcpConfigPath, serverDefinitions]] of collections) {\n\t\t\t\tconst newServerDefinitions = observableValue<readonly McpServerDefinition[]>(this, serverDefinitions);\n\t\t\t\tconst newCollection: McpCollectionDefinition = {\n\t\t\t\t\tid,\n\t\t\t\t\tlabel: mcpConfigPath?.label ?? '',\n\t\t\t\t\tpresentation: {\n\t\t\t\t\t\torder: serverDefinitions[0]?.presentation?.order,\n\t\t\t\t\t\torigin: mcpConfigPath?.uri,\n\t\t\t\t\t},\n\t\t\t\t\tremoteAuthority: mcpConfigPath?.remoteAuthority ?? null,\n\t\t\t\t\tserverDefinitions: newServerDefinitions,\n\t\t\t\t\ttrustBehavior: McpServerTrust.Kind.Trusted,\n\t\t\t\t\tconfigTarget: mcpConfigPath?.target ?? ConfigurationTarget.USER,\n\t\t\t\t\tscope: mcpConfigPath?.scope ?? StorageScope.PROFILE,\n\t\t\t\t};\n\t\t\t\tconst existingCollection = this.collections.get(id);\n\n\t\t\t\tconst collectionDefinitionsChanged = existingCollection ? !McpCollectionDefinition.equals(existingCollection.definition, newCollection) : true;\n\t\t\t\tif (!collectionDefinitionsChanged) {\n\t\t\t\t\tconst serverDefinitionsChanged = existingCollection ? !equals(existingCollection.definition.serverDefinitions.get(), newCollection.serverDefinitions.get(), McpServerDefinition.equals) : true;\n\t\t\t\t\tif (serverDefinitionsChanged) {\n\t\t\t\t\t\texistingCollection?.serverDefinitions.set(serverDefinitions, undefined);\n\t\t\t\t\t}\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.collections.deleteAndDispose(id);\n\t\t\t\tconst disposable = this.mcpRegistry.registerCollection(newCollection);\n\t\t\t\tthis.collections.set(id, {\n\t\t\t\t\tdefinition: newCollection,\n\t\t\t\t\tserverDefinitions: newServerDefinitions,\n\t\t\t\t\tdispose: () => disposable.dispose()\n\t\t\t\t});\n\t\t\t}\n\n\t\t} catch (error) {\n\t\t\tthis.logService.error(error);\n\t\t}\n\t}\n}\n"]}