{"version":3,"sources":["vs/workbench/contrib/mcp/common/mcpServer.ts"],"names":[],"mappings":"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","file":"mcpServer.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { AsyncIterableProducer, raceCancellationError, Sequencer } from '../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport * as json from '../../../../base/common/json.js';\nimport { Disposable, DisposableStore, IDisposable, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { LRUCache } from '../../../../base/common/map.js';\nimport { mapValues } from '../../../../base/common/objects.js';\nimport { autorun, autorunSelfDisposable, derived, disposableObservableValue, IDerivedReader, IObservable, IReader, ITransaction, observableFromEvent, ObservablePromise, observableValue, transaction } from '../../../../base/common/observable.js';\nimport { basename } from '../../../../base/common/resources.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { createURITransformer } from '../../../../base/common/uriTransformer.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { localize } from '../../../../nls.js';\nimport { ICommandService } from '../../../../platform/commands/common/commands.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogger, ILoggerService } from '../../../../platform/log/common/log.js';\nimport { INotificationService, IPromptChoice, Severity } from '../../../../platform/notification/common/notification.js';\nimport { IOpenerService } from '../../../../platform/opener/common/opener.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IWorkspaceContextService } from '../../../../platform/workspace/common/workspace.js';\nimport { IEditorService } from '../../../services/editor/common/editorService.js';\nimport { IWorkbenchEnvironmentService } from '../../../services/environment/common/environmentService.js';\nimport { IExtensionService } from '../../../services/extensions/common/extensions.js';\nimport { IOutputService } from '../../../services/output/common/output.js';\nimport { ToolProgress } from '../../chat/common/languageModelToolsService.js';\nimport { mcpActivationEvent } from './mcpConfiguration.js';\nimport { McpDevModeServerAttache } from './mcpDevMode.js';\nimport { McpIcons, parseAndValidateMcpIcon, StoredMcpIcons } from './mcpIcons.js';\nimport { IMcpRegistry } from './mcpRegistryTypes.js';\nimport { McpServerRequestHandler } from './mcpServerRequestHandler.js';\nimport { ElicitationKind, extensionMcpCollectionPrefix, IMcpElicitationService, IMcpIcons, IMcpPrompt, IMcpPromptMessage, IMcpResource, IMcpResourceTemplate, IMcpSamplingService, IMcpServer, IMcpServerConnection, IMcpServerStartOpts, IMcpTool, IMcpToolCallContext, McpCapability, McpCollectionDefinition, McpCollectionReference, McpConnectionFailedError, McpConnectionState, McpDefinitionReference, mcpPromptReplaceSpecialChars, McpResourceURI, McpServerCacheState, McpServerDefinition, McpServerStaticToolAvailability, McpServerTransportType, McpToolName, MpcResponseError, UserInteractionRequiredError } from './mcpTypes.js';\nimport { MCP } from './modelContextProtocol.js';\nimport { UriTemplate } from './uriTemplate.js';\n\ntype ServerBootData = {\n\tsupportsLogging: boolean;\n\tsupportsPrompts: boolean;\n\tsupportsResources: boolean;\n\ttoolCount: number;\n\tserverName: string;\n\tserverVersion: string;\n};\ntype ServerBootClassification = {\n\towner: 'connor4312';\n\tcomment: 'Details the capabilities of the MCP server';\n\tsupportsLogging: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; isMeasurement: true; comment: 'Whether the server supports logging' };\n\tsupportsPrompts: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; isMeasurement: true; comment: 'Whether the server supports prompts' };\n\tsupportsResources: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; isMeasurement: true; comment: 'Whether the server supports resource' };\n\ttoolCount: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; isMeasurement: true; comment: 'The number of tools the server advertises' };\n\tserverName: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the MCP server' };\n\tserverVersion: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The version of the MCP server' };\n};\n\ntype ElicitationTelemetryData = {\n\tserverName: string;\n\tserverVersion: string;\n};\n\ntype ElicitationTelemetryClassification = {\n\towner: 'connor4312';\n\tcomment: 'Triggered when elictation is requested';\n\tserverName: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the MCP server' };\n\tserverVersion: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The version of the MCP server' };\n};\n\nexport type McpServerInstallData = {\n\tserverName: string;\n\tsource: 'gallery' | 'local';\n\tscope: string;\n\tsuccess: boolean;\n\terror?: string;\n\thasInputs: boolean;\n};\n\nexport type McpServerInstallClassification = {\n\towner: 'connor4312';\n\tcomment: 'MCP server installation event tracking';\n\tserverName: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the MCP server being installed' };\n\tsource: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Installation source (gallery or local)' };\n\tscope: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Installation scope (user, workspace, etc.)' };\n\tsuccess: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; isMeasurement: true; comment: 'Whether installation succeeded' };\n\terror?: { classification: 'CallstackOrException'; purpose: 'FeatureInsight'; comment: 'Error message if installation failed' };\n\thasInputs: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; isMeasurement: true; comment: 'Whether the server requires input configuration' };\n};\n\ntype ServerBootState = {\n\tstate: string;\n\ttime: number;\n};\ntype ServerBootStateClassification = {\n\towner: 'connor4312';\n\tcomment: 'Details the capabilities of the MCP server';\n\tstate: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The server outcome' };\n\ttime: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; isMeasurement: true; comment: 'Duration in milliseconds to reach that state' };\n};\n\ntype StoredMcpPrompt = MCP.Prompt & { _icons: StoredMcpIcons };\n\ninterface IToolCacheEntry {\n\treadonly serverName: string | undefined;\n\treadonly serverInstructions: string | undefined;\n\treadonly serverIcons: StoredMcpIcons;\n\n\treadonly trustedAtNonce: string | undefined;\n\n\treadonly nonce: string | undefined;\n\t/** Cached tools so we can show what's available before it's started */\n\treadonly tools: readonly ValidatedMcpTool[];\n\t/** Cached prompts */\n\treadonly prompts: readonly StoredMcpPrompt[] | undefined;\n\t/** Cached capabilities */\n\treadonly capabilities: McpCapability | undefined;\n}\n\nconst emptyToolEntry: IToolCacheEntry = {\n\tserverName: undefined,\n\tserverIcons: [],\n\tserverInstructions: undefined,\n\ttrustedAtNonce: undefined,\n\tnonce: undefined,\n\ttools: [],\n\tprompts: undefined,\n\tcapabilities: undefined,\n};\n\ninterface IServerCacheEntry {\n\treadonly servers: readonly McpServerDefinition.Serialized[];\n}\n\nconst toolInvalidCharRe = /[^a-z0-9_-]/gi;\n\nexport class McpServerMetadataCache extends Disposable {\n\tprivate didChange = false;\n\tprivate readonly cache = new LRUCache<string, IToolCacheEntry>(128);\n\tprivate readonly extensionServers = new Map</* collection ID */string, IServerCacheEntry>();\n\n\tconstructor(\n\t\tscope: StorageScope,\n\t\t@IStorageService storageService: IStorageService,\n\t) {\n\t\tsuper();\n\n\t\ttype StoredType = {\n\t\t\textensionServers: [string, IServerCacheEntry][];\n\t\t\tserverTools: [string, IToolCacheEntry][];\n\t\t};\n\n\t\tconst storageKey = 'mcpToolCache';\n\t\tthis._register(storageService.onWillSaveState(() => {\n\t\t\tif (this.didChange) {\n\t\t\t\tstorageService.store(storageKey, {\n\t\t\t\t\textensionServers: [...this.extensionServers],\n\t\t\t\t\tserverTools: this.cache.toJSON(),\n\t\t\t\t} satisfies StoredType, scope, StorageTarget.MACHINE);\n\t\t\t\tthis.didChange = false;\n\t\t\t}\n\t\t}));\n\n\t\ttry {\n\t\t\tconst cached: StoredType | undefined = storageService.getObject(storageKey, scope);\n\t\t\tthis.extensionServers = new Map(cached?.extensionServers ?? []);\n\t\t\tcached?.serverTools?.forEach(([k, v]) => this.cache.set(k, v));\n\t\t} catch {\n\t\t\t// ignored\n\t\t}\n\t}\n\n\t/** Resets the cache for primitives and extension servers */\n\treset() {\n\t\tthis.cache.clear();\n\t\tthis.extensionServers.clear();\n\t\tthis.didChange = true;\n\t}\n\n\t/** Gets cached primitives for a server (used before a server is running) */\n\tget(definitionId: string) {\n\t\treturn this.cache.get(definitionId);\n\t}\n\n\t/** Sets cached primitives for a server */\n\tstore(definitionId: string, entry: Partial<IToolCacheEntry>): void {\n\t\tconst prev = this.get(definitionId) || emptyToolEntry;\n\t\tthis.cache.set(definitionId, { ...prev, ...entry });\n\t\tthis.didChange = true;\n\t}\n\n\t/** Gets cached servers for a collection (used for extensions, before the extension activates) */\n\tgetServers(collectionId: string) {\n\t\treturn this.extensionServers.get(collectionId);\n\t}\n\n\t/** Sets cached servers for a collection */\n\tstoreServers(collectionId: string, entry: IServerCacheEntry | undefined): void {\n\t\tif (entry) {\n\t\t\tthis.extensionServers.set(collectionId, entry);\n\t\t} else {\n\t\t\tthis.extensionServers.delete(collectionId);\n\t\t}\n\t\tthis.didChange = true;\n\t}\n}\n\ntype ValidatedMcpTool = MCP.Tool & {\n\t_icons: StoredMcpIcons;\n\n\t/**\n\t * Tool name as published by the MCP server. This may\n\t * be different than the one in {@link definition} due to name normalization\n\t * in {@link McpServer._getValidatedTools}.\n\t */\n\tserverToolName: string;\n};\n\ninterface StoredServerMetadata {\n\treadonly serverName: string | undefined;\n\treadonly serverInstructions: string | undefined;\n\treadonly serverIcons: StoredMcpIcons | undefined;\n}\n\ninterface ServerMetadata {\n\treadonly serverName: string | undefined;\n\treadonly serverInstructions: string | undefined;\n\treadonly icons: IMcpIcons;\n}\n\nclass CachedPrimitive<T, C> {\n\t/**\n\t * @param _definitionId Server definition ID\n\t * @param _cache Metadata cache instance\n\t * @param _fromStaticDefinition Static definition that came with the server.\n\t * This should ONLY have a value if it should be used instead of whatever\n\t * is currently in the cache.\n\t * @param _fromCache Pull the value from the cache entry.\n\t * @param _toT Transform the value to the observable type.\n\t * @param defaultValue Default value if no cache entry.\n\t */\n\tconstructor(\n\t\tprivate readonly _definitionId: string,\n\t\tprivate readonly _cache: McpServerMetadataCache,\n\t\tprivate readonly _fromStaticDefinition: IObservable<C | undefined> | undefined,\n\t\tprivate readonly _fromCache: (entry: IToolCacheEntry) => C,\n\t\tprivate readonly _toT: (values: C, reader: IDerivedReader<void>) => T,\n\t\tprivate readonly defaultValue: C,\n\t) { }\n\n\tpublic get fromCache(): { nonce: string | undefined; data: C } | undefined {\n\t\tconst c = this._cache.get(this._definitionId);\n\t\treturn c ? { data: this._fromCache(c), nonce: c.nonce } : undefined;\n\t}\n\n\tpublic hasStaticDefinition(reader: IReader | undefined) {\n\t\treturn !!this._fromStaticDefinition?.read(reader);\n\t}\n\n\tpublic readonly fromServerPromise = observableValue<ObservablePromise<{\n\t\treadonly data: C;\n\t\treadonly nonce: string | undefined;\n\t}> | undefined>(this, undefined);\n\n\tprivate readonly fromServer = derived(reader => this.fromServerPromise.read(reader)?.promiseResult.read(reader)?.data);\n\n\tpublic readonly value: IObservable<T> = derived(reader => {\n\t\tconst serverTools = this.fromServer.read(reader);\n\t\tconst definitions = serverTools?.data ?? this._fromStaticDefinition?.read(reader) ?? this.fromCache?.data ?? this.defaultValue;\n\t\treturn this._toT(definitions, reader);\n\t});\n}\n\nexport class McpServer extends Disposable implements IMcpServer {\n\t/**\n\t * Helper function to call the function on the handler once it's online. The\n\t * connection started if it is not already.\n\t */\n\tpublic static async callOn<R>(server: IMcpServer, fn: (handler: McpServerRequestHandler) => Promise<R>, token: CancellationToken = CancellationToken.None): Promise<R> {\n\t\tawait server.start({ promptType: 'all-untrusted' }); // idempotent\n\n\t\tlet ranOnce = false;\n\t\tlet d: IDisposable;\n\n\t\tconst callPromise = new Promise<R>((resolve, reject) => {\n\n\t\t\td = autorun(reader => {\n\t\t\t\tconst connection = server.connection.read(reader);\n\t\t\t\tif (!connection || ranOnce) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst handler = connection.handler.read(reader);\n\t\t\t\tif (!handler) {\n\t\t\t\t\tconst state = connection.state.read(reader);\n\t\t\t\t\tif (state.state === McpConnectionState.Kind.Error) {\n\t\t\t\t\t\treject(new McpConnectionFailedError(`MCP server could not be started: ${state.message}`));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} else if (state.state === McpConnectionState.Kind.Stopped) {\n\t\t\t\t\t\treject(new McpConnectionFailedError('MCP server has stopped'));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// keep waiting for handler\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tresolve(fn(handler));\n\t\t\t\tranOnce = true; // aggressive prevent multiple racey calls, don't dispose because autorun is sync\n\t\t\t});\n\t\t});\n\n\t\treturn raceCancellationError(callPromise, token).finally(() => d.dispose());\n\t}\n\n\tpublic readonly collection: McpCollectionReference;\n\tprivate readonly _connectionSequencer = new Sequencer();\n\tprivate readonly _connection = this._register(disposableObservableValue<IMcpServerConnection | undefined>(this, undefined));\n\n\tpublic readonly connection = this._connection;\n\tpublic readonly connectionState: IObservable<McpConnectionState> = derived(reader => this._connection.read(reader)?.state.read(reader) ?? { state: McpConnectionState.Kind.Stopped });\n\n\n\tprivate readonly _capabilities: CachedPrimitive<number | undefined, number | undefined>;\n\tpublic get capabilities() {\n\t\treturn this._capabilities.value;\n\t}\n\n\tprivate readonly _tools: CachedPrimitive<readonly IMcpTool[], readonly ValidatedMcpTool[]>;\n\tpublic get tools() {\n\t\treturn this._tools.value;\n\t}\n\n\tprivate readonly _prompts: CachedPrimitive<readonly IMcpPrompt[], readonly StoredMcpPrompt[]>;\n\tpublic get prompts() {\n\t\treturn this._prompts.value;\n\t}\n\n\tprivate readonly _serverMetadata: CachedPrimitive<ServerMetadata, StoredServerMetadata | undefined>;\n\tpublic get serverMetadata() {\n\t\treturn this._serverMetadata.value;\n\t}\n\n\tpublic get trustedAtNonce() {\n\t\treturn this._primitiveCache.get(this.definition.id)?.trustedAtNonce;\n\t}\n\n\tpublic set trustedAtNonce(nonce: string | undefined) {\n\t\tthis._primitiveCache.store(this.definition.id, { trustedAtNonce: nonce });\n\t}\n\n\tprivate readonly _fullDefinitions: IObservable<{\n\t\tserver: McpServerDefinition | undefined;\n\t\tcollection: McpCollectionDefinition | undefined;\n\t}>;\n\n\tpublic readonly cacheState = derived(reader => {\n\t\tconst currentNonce = () => this._fullDefinitions.read(reader)?.server?.cacheNonce;\n\t\tconst stateWhenServingFromCache = () => {\n\t\t\tif (this._tools.hasStaticDefinition(reader)) {\n\t\t\t\treturn McpServerCacheState.Cached;\n\t\t\t}\n\n\t\t\tif (!this._tools.fromCache) {\n\t\t\t\treturn McpServerCacheState.Unknown;\n\t\t\t}\n\n\t\t\treturn currentNonce() === this._tools.fromCache.nonce ? McpServerCacheState.Cached : McpServerCacheState.Outdated;\n\t\t};\n\n\t\tconst fromServer = this._tools.fromServerPromise.read(reader);\n\t\tconst connectionState = this.connectionState.read(reader);\n\t\tconst isIdle = McpConnectionState.canBeStarted(connectionState.state) || !fromServer;\n\t\tif (isIdle) {\n\t\t\treturn stateWhenServingFromCache();\n\t\t}\n\n\t\tconst fromServerResult = fromServer?.promiseResult.read(reader);\n\t\tif (!fromServerResult) {\n\t\t\treturn this._tools.fromCache ? McpServerCacheState.RefreshingFromCached : McpServerCacheState.RefreshingFromUnknown;\n\t\t}\n\n\t\tif (fromServerResult.error) {\n\t\t\treturn stateWhenServingFromCache();\n\t\t}\n\n\t\treturn fromServerResult.data?.nonce === currentNonce() ? McpServerCacheState.Live : McpServerCacheState.Outdated;\n\t});\n\n\tprivate readonly _loggerId: string;\n\tprivate readonly _logger: ILogger;\n\tprivate _lastModeDebugged = false;\n\t/** Count of running tool calls, used to detect if sampling is during an LM call */\n\tpublic runningToolCalls = new Set<IMcpToolCallContext>();\n\n\tconstructor(\n\t\tinitialCollection: McpCollectionDefinition,\n\t\tpublic readonly definition: McpDefinitionReference,\n\t\texplicitRoots: URI[] | undefined,\n\t\tprivate readonly _requiresExtensionActivation: boolean | undefined,\n\t\tprivate readonly _primitiveCache: McpServerMetadataCache,\n\t\ttoolPrefix: string,\n\t\t@IMcpRegistry private readonly _mcpRegistry: IMcpRegistry,\n\t\t@IWorkspaceContextService workspacesService: IWorkspaceContextService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@ILoggerService private readonly _loggerService: ILoggerService,\n\t\t@IOutputService private readonly _outputService: IOutputService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@ICommandService private readonly _commandService: ICommandService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@INotificationService private readonly _notificationService: INotificationService,\n\t\t@IOpenerService private readonly _openerService: IOpenerService,\n\t\t@IMcpSamplingService private readonly _samplingService: IMcpSamplingService,\n\t\t@IMcpElicitationService private readonly _elicitationService: IMcpElicitationService,\n\t\t@IWorkbenchEnvironmentService environmentService: IWorkbenchEnvironmentService,\n\t) {\n\t\tsuper();\n\n\t\tthis.collection = initialCollection;\n\t\tthis._fullDefinitions = this._mcpRegistry.getServerDefinition(this.collection, this.definition);\n\t\tthis._loggerId = `mcpServer.${definition.id}`;\n\t\tthis._logger = this._register(_loggerService.createLogger(this._loggerId, { hidden: true, name: `MCP: ${definition.label}` }));\n\n\t\tconst that = this;\n\t\tthis._register(this._instantiationService.createInstance(McpDevModeServerAttache, this, { get lastModeDebugged() { return that._lastModeDebugged; } }));\n\n\t\t// If the logger is disposed but not deregistered, then the disposed instance\n\t\t// is reused and no-ops. todo@sandy081 this seems like a bug.\n\t\tthis._register(toDisposable(() => _loggerService.deregisterLogger(this._loggerId)));\n\n\t\t// 1. Reflect workspaces into the MCP roots\n\t\tconst workspaces = explicitRoots\n\t\t\t? observableValue(this, explicitRoots.map(uri => ({ uri, name: basename(uri) })))\n\t\t\t: observableFromEvent(\n\t\t\t\tthis,\n\t\t\t\tworkspacesService.onDidChangeWorkspaceFolders,\n\t\t\t\t() => workspacesService.getWorkspace().folders,\n\t\t\t);\n\n\t\tconst uriTransformer = environmentService.remoteAuthority ? createURITransformer(environmentService.remoteAuthority) : undefined;\n\n\t\tthis._register(autorun(reader => {\n\t\t\tconst cnx = this._connection.read(reader)?.handler.read(reader);\n\t\t\tif (!cnx) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcnx.roots = workspaces.read(reader)\n\t\t\t\t.filter(w => w.uri.authority === (initialCollection.remoteAuthority || ''))\n\t\t\t\t.map(w => ({\n\t\t\t\t\tname: w.name,\n\t\t\t\t\turi: URI.from(uriTransformer?.transformIncoming(w.uri) ?? w.uri).toString()\n\t\t\t\t}));\n\t\t}));\n\n\t\t// 2. Populate this.tools when we connect to a server.\n\t\tthis._register(autorun(reader => {\n\t\t\tconst cnx = this._connection.read(reader);\n\t\t\tconst handler = cnx?.handler.read(reader);\n\t\t\tif (handler) {\n\t\t\t\tthis._populateLiveData(handler, cnx?.definition.cacheNonce, reader.store);\n\t\t\t} else if (this._tools) {\n\t\t\t\tthis.resetLiveData();\n\t\t\t}\n\t\t}));\n\n\t\tconst staticMetadata = derived(reader => {\n\t\t\tconst def = this._fullDefinitions.read(reader).server;\n\t\t\treturn def && def.cacheNonce !== this._tools.fromCache?.nonce ? def.staticMetadata : undefined;\n\t\t});\n\n\t\t// 3. Publish tools\n\t\tthis._tools = new CachedPrimitive<readonly IMcpTool[], readonly ValidatedMcpTool[]>(\n\t\t\tthis.definition.id,\n\t\t\tthis._primitiveCache,\n\t\t\tstaticMetadata\n\t\t\t\t.map(m => {\n\t\t\t\t\tconst tools = m?.tools?.filter(t => t.availability === McpServerStaticToolAvailability.Initial).map(t => t.definition);\n\t\t\t\t\treturn tools?.length ? new ObservablePromise(this._getValidatedTools(tools)) : undefined;\n\t\t\t\t})\n\t\t\t\t.map((o, reader) => o?.promiseResult.read(reader)?.data),\n\t\t\t(entry) => entry.tools,\n\t\t\t(entry) => entry.map(def => this._instantiationService.createInstance(McpTool, this, toolPrefix, def)).sort((a, b) => a.compare(b)),\n\t\t\t[],\n\t\t);\n\n\t\t// 4. Publish prompts\n\t\tthis._prompts = new CachedPrimitive<readonly IMcpPrompt[], readonly StoredMcpPrompt[]>(\n\t\t\tthis.definition.id,\n\t\t\tthis._primitiveCache,\n\t\t\tundefined,\n\t\t\t(entry) => entry.prompts || [],\n\t\t\t(entry) => entry.map(e => new McpPrompt(this, e)),\n\t\t\t[],\n\t\t);\n\n\t\tthis._serverMetadata = new CachedPrimitive<ServerMetadata, StoredServerMetadata | undefined>(\n\t\t\tthis.definition.id,\n\t\t\tthis._primitiveCache,\n\t\t\tstaticMetadata.map(m => m ? this._toStoredMetadata(m?.serverInfo, m?.instructions) : undefined),\n\t\t\t(entry) => ({ serverName: entry.serverName, serverInstructions: entry.serverInstructions, serverIcons: entry.serverIcons }),\n\t\t\t(entry) => ({ serverName: entry?.serverName, serverInstructions: entry?.serverInstructions, icons: McpIcons.fromStored(entry?.serverIcons) }),\n\t\t\tundefined,\n\t\t);\n\n\t\tthis._capabilities = new CachedPrimitive<number | undefined, number | undefined>(\n\t\t\tthis.definition.id,\n\t\t\tthis._primitiveCache,\n\t\t\tstaticMetadata.map(m => m?.capabilities !== undefined ? encodeCapabilities(m.capabilities) : undefined),\n\t\t\t(entry) => entry.capabilities,\n\t\t\t(entry) => entry,\n\t\t\tundefined,\n\t\t);\n\t}\n\n\tpublic readDefinitions(): IObservable<{ server: McpServerDefinition | undefined; collection: McpCollectionDefinition | undefined }> {\n\t\treturn this._fullDefinitions;\n\t}\n\n\tpublic showOutput(preserveFocus?: boolean) {\n\t\tthis._loggerService.setVisibility(this._loggerId, true);\n\t\treturn this._outputService.showChannel(this._loggerId, preserveFocus);\n\t}\n\n\tpublic resources(token?: CancellationToken): AsyncIterable<IMcpResource[]> {\n\t\tconst cts = new CancellationTokenSource(token);\n\t\treturn new AsyncIterableProducer<IMcpResource[]>(async emitter => {\n\t\t\tawait McpServer.callOn(this, async (handler) => {\n\t\t\t\tfor await (const resource of handler.listResourcesIterable({}, cts.token)) {\n\t\t\t\t\temitter.emitOne(resource.map(r => new McpResource(this, r, McpIcons.fromParsed(this._parseIcons(r)))));\n\t\t\t\t\tif (cts.token.isCancellationRequested) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}, () => cts.dispose(true));\n\t}\n\n\tpublic resourceTemplates(token?: CancellationToken): Promise<IMcpResourceTemplate[]> {\n\t\treturn McpServer.callOn(this, async (handler) => {\n\t\t\tconst templates = await handler.listResourceTemplates({}, token);\n\t\t\treturn templates.map(t => new McpResourceTemplate(this, t, McpIcons.fromParsed(this._parseIcons(t))));\n\t\t}, token);\n\t}\n\n\tpublic start({ interaction, autoTrustChanges, promptType, debug, errorOnUserInteraction }: IMcpServerStartOpts = {}): Promise<McpConnectionState> {\n\t\tinteraction?.participants.set(this.definition.id, { s: 'unknown' });\n\n\t\treturn this._connectionSequencer.queue<McpConnectionState>(async () => {\n\t\t\tconst activationEvent = mcpActivationEvent(this.collection.id.slice(extensionMcpCollectionPrefix.length));\n\t\t\tif (this._requiresExtensionActivation && !this._extensionService.activationEventIsDone(activationEvent)) {\n\t\t\t\tawait this._extensionService.activateByEvent(activationEvent);\n\t\t\t\tawait Promise.all(this._mcpRegistry.delegates.get()\n\t\t\t\t\t.map(r => r.waitForInitialProviderPromises()));\n\t\t\t\t// This can happen if the server was created from a cached MCP server seen\n\t\t\t\t// from an extension, but then it wasn't registered when the extension activated.\n\t\t\t\tif (this._store.isDisposed) {\n\t\t\t\t\treturn { state: McpConnectionState.Kind.Stopped };\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet connection = this._connection.get();\n\t\t\tif (connection && McpConnectionState.canBeStarted(connection.state.get().state)) {\n\t\t\t\tconnection.dispose();\n\t\t\t\tconnection = undefined;\n\t\t\t\tthis._connection.set(connection, undefined);\n\t\t\t}\n\n\t\t\tif (!connection) {\n\t\t\t\tthis._lastModeDebugged = !!debug;\n\t\t\t\tconst that = this;\n\t\t\t\tconnection = await this._mcpRegistry.resolveConnection({\n\t\t\t\t\tinteraction,\n\t\t\t\t\tautoTrustChanges,\n\t\t\t\t\tpromptType,\n\t\t\t\t\ttrustNonceBearer: {\n\t\t\t\t\t\tget trustedAtNonce() { return that.trustedAtNonce; },\n\t\t\t\t\t\tset trustedAtNonce(nonce: string | undefined) { that.trustedAtNonce = nonce; }\n\t\t\t\t\t},\n\t\t\t\t\tlogger: this._logger,\n\t\t\t\t\tcollectionRef: this.collection,\n\t\t\t\t\tdefinitionRef: this.definition,\n\t\t\t\t\tdebug,\n\t\t\t\t\terrorOnUserInteraction,\n\t\t\t\t});\n\t\t\t\tif (!connection) {\n\t\t\t\t\treturn { state: McpConnectionState.Kind.Stopped };\n\t\t\t\t}\n\n\t\t\t\tif (this._store.isDisposed) {\n\t\t\t\t\tconnection.dispose();\n\t\t\t\t\treturn { state: McpConnectionState.Kind.Stopped };\n\t\t\t\t}\n\n\t\t\t\tthis._connection.set(connection, undefined);\n\n\t\t\t\tif (connection.definition.devMode) {\n\t\t\t\t\tthis.showOutput();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst start = Date.now();\n\t\t\tlet state = await connection.start({\n\t\t\t\tcreateMessageRequestHandler: params => this._samplingService.sample({\n\t\t\t\t\tisDuringToolCall: this.runningToolCalls.size > 0,\n\t\t\t\t\tserver: this,\n\t\t\t\t\tparams,\n\t\t\t\t}).then(r => r.sample),\n\t\t\t\telicitationRequestHandler: async req => {\n\t\t\t\t\tconst serverInfo = connection.handler.get()?.serverInfo;\n\t\t\t\t\tif (serverInfo) {\n\t\t\t\t\t\tthis._telemetryService.publicLog2<ElicitationTelemetryData, ElicitationTelemetryClassification>('mcp.elicitationRequested', {\n\t\t\t\t\t\t\tserverName: serverInfo.name,\n\t\t\t\t\t\t\tserverVersion: serverInfo.version,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tconst r = await this._elicitationService.elicit(this, Iterable.first(this.runningToolCalls), req, CancellationToken.None);\n\t\t\t\t\tr.dispose();\n\t\t\t\t\treturn r.value;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis._telemetryService.publicLog2<ServerBootState, ServerBootStateClassification>('mcp/serverBootState', {\n\t\t\t\tstate: McpConnectionState.toKindString(state.state),\n\t\t\t\ttime: Date.now() - start,\n\t\t\t});\n\n\t\t\tif (state.state === McpConnectionState.Kind.Error) {\n\t\t\t\tthis.showInteractiveError(connection, state, debug);\n\t\t\t}\n\n\t\t\t// MCP servers that need auth can 'start' but will stop with an interaction-needed\n\t\t\t// error they first make a request. In this case, wait until the handler fully\n\t\t\t// initializes before resolving (throwing if it ends up needing auth)\n\t\t\tif (errorOnUserInteraction && state.state === McpConnectionState.Kind.Running) {\n\t\t\t\tlet disposable: IDisposable;\n\t\t\t\tstate = await new Promise<McpConnectionState>((resolve, reject) => {\n\t\t\t\t\tdisposable = autorun(reader => {\n\t\t\t\t\t\tconst handler = connection.handler.read(reader);\n\t\t\t\t\t\tif (handler) {\n\t\t\t\t\t\t\tresolve(state);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst s = connection.state.read(reader);\n\t\t\t\t\t\tif (s.state === McpConnectionState.Kind.Stopped && s.reason === 'needs-user-interaction') {\n\t\t\t\t\t\t\treject(new UserInteractionRequiredError('auth'));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!McpConnectionState.isRunning(s)) {\n\t\t\t\t\t\t\tresolve(s);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}).finally(() => disposable.dispose());\n\t\t\t}\n\n\t\t\treturn state;\n\t\t}).finally(() => {\n\t\t\tinteraction?.participants.set(this.definition.id, { s: 'resolved' });\n\t\t});\n\t}\n\n\tprivate showInteractiveError(cnx: IMcpServerConnection, error: McpConnectionState.Error, debug?: boolean) {\n\t\tif (error.code === 'ENOENT' && cnx.launchDefinition.type === McpServerTransportType.Stdio) {\n\t\t\tlet docsLink: string | undefined;\n\t\t\tswitch (cnx.launchDefinition.command) {\n\t\t\t\tcase 'uvx':\n\t\t\t\t\tdocsLink = `https://aka.ms/vscode-mcp-install/uvx`;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'npx':\n\t\t\t\t\tdocsLink = `https://aka.ms/vscode-mcp-install/npx`;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'dnx':\n\t\t\t\t\tdocsLink = `https://aka.ms/vscode-mcp-install/dnx`;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'dotnet':\n\t\t\t\t\tdocsLink = `https://aka.ms/vscode-mcp-install/dotnet`;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst options: IPromptChoice[] = [{\n\t\t\t\tlabel: localize('mcp.command.showOutput', \"Show Output\"),\n\t\t\t\trun: () => this.showOutput(),\n\t\t\t}];\n\n\t\t\tif (cnx.definition.devMode?.debug?.type === 'debugpy' && debug) {\n\t\t\t\tthis._notificationService.prompt(Severity.Error, localize('mcpDebugPyHelp', 'The command \"{0}\" was not found. You can specify the path to debugpy in the `dev.debug.debugpyPath` option.', cnx.launchDefinition.command, cnx.definition.label), [...options, {\n\t\t\t\t\tlabel: localize('mcpViewDocs', 'View Docs'),\n\t\t\t\t\trun: () => this._openerService.open(URI.parse('https://aka.ms/vscode-mcp-install/debugpy')),\n\t\t\t\t}]);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (docsLink) {\n\t\t\t\toptions.push({\n\t\t\t\t\tlabel: localize('mcpServerInstall', 'Install {0}', cnx.launchDefinition.command),\n\t\t\t\t\trun: () => this._openerService.open(URI.parse(docsLink)),\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis._notificationService.prompt(Severity.Error, localize('mcpServerNotFound', 'The command \"{0}\" needed to run {1} was not found.', cnx.launchDefinition.command, cnx.definition.label), options);\n\t\t} else {\n\t\t\tthis._notificationService.warn(localize('mcpServerError', 'The MCP server {0} could not be started: {1}', cnx.definition.label, error.message));\n\t\t}\n\t}\n\n\tpublic stop(): Promise<void> {\n\t\treturn this._connection.get()?.stop() || Promise.resolve();\n\t}\n\n\t/** Waits for any ongoing tools to be refreshed before resolving. */\n\tpublic awaitToolRefresh() {\n\t\treturn new Promise<void>(resolve => {\n\t\t\tautorunSelfDisposable(reader => {\n\t\t\t\tconst promise = this._tools.fromServerPromise.read(reader);\n\t\t\t\tconst result = promise?.promiseResult.read(reader);\n\t\t\t\tif (result) {\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate resetLiveData() {\n\t\ttransaction(tx => {\n\t\t\tthis._tools.fromServerPromise.set(undefined, tx);\n\t\t\tthis._prompts.fromServerPromise.set(undefined, tx);\n\t\t});\n\t}\n\n\tprivate async _normalizeTool(originalTool: MCP.Tool): Promise<ValidatedMcpTool | { error: string[] }> {\n\t\tconst tool: ValidatedMcpTool = {\n\t\t\t...originalTool,\n\t\t\tserverToolName: originalTool.name,\n\t\t\t_icons: this._parseIcons(originalTool),\n\t\t};\n\t\tif (!tool.description) {\n\t\t\t// Ensure a description is provided for each tool, #243919\n\t\t\tthis._logger.warn(`Tool ${tool.name} does not have a description. Tools must be accurately described to be called`);\n\t\t\ttool.description = '<empty>';\n\t\t}\n\n\t\tif (toolInvalidCharRe.test(tool.name)) {\n\t\t\tthis._logger.warn(`Tool ${JSON.stringify(tool.name)} is invalid. Tools names may only contain [a-z0-9_-]`);\n\t\t\ttool.name = tool.name.replace(toolInvalidCharRe, '_');\n\t\t}\n\n\t\ttype JsonDiagnostic = { message: string; range: { line: number; character: number }[] };\n\n\t\tlet diagnostics: JsonDiagnostic[] = [];\n\t\tconst toolJson = JSON.stringify(tool.inputSchema);\n\t\ttry {\n\t\t\tconst schemaUri = URI.parse('https://json-schema.org/draft-07/schema');\n\t\t\tdiagnostics = await this._commandService.executeCommand<JsonDiagnostic[]>('json.validate', schemaUri, toolJson) || [];\n\t\t} catch (e) {\n\t\t\t// ignored (error in json extension?);\n\t\t}\n\n\t\tif (!diagnostics.length) {\n\t\t\treturn tool;\n\t\t}\n\n\t\t// because it's all one line from JSON.stringify, we can treat characters as offsets.\n\t\tconst tree = json.parseTree(toolJson);\n\t\tconst messages = diagnostics.map(d => {\n\t\t\tconst node = json.findNodeAtOffset(tree, d.range[0].character);\n\t\t\tconst path = node && `/${json.getNodePath(node).join('/')}`;\n\t\t\treturn d.message + (path ? ` (at ${path})` : '');\n\t\t});\n\n\t\treturn { error: messages };\n\t}\n\n\tprivate async _getValidatedTools(tools: MCP.Tool[]): Promise<ValidatedMcpTool[]> {\n\t\tlet error = '';\n\n\t\tconst validations = await Promise.all(tools.map(t => this._normalizeTool(t)));\n\t\tconst validated: ValidatedMcpTool[] = [];\n\t\tfor (const [i, result] of validations.entries()) {\n\t\t\tif ('error' in result) {\n\t\t\t\terror += localize('mcpBadSchema.tool', 'Tool `{0}` has invalid JSON parameters:', tools[i].name) + '\\n';\n\t\t\t\tfor (const message of result.error) {\n\t\t\t\t\terror += `\\t- ${message}\\n`;\n\t\t\t\t}\n\t\t\t\terror += `\\t- Schema: ${JSON.stringify(tools[i].inputSchema)}\\n\\n`;\n\t\t\t} else {\n\t\t\t\tvalidated.push(result);\n\t\t\t}\n\t\t}\n\n\t\tif (error) {\n\t\t\tthis._logger.warn(`${tools.length - validated.length} tools have invalid JSON schemas and will be omitted`);\n\t\t\twarnInvalidTools(this._instantiationService, this.definition.label, error);\n\t\t}\n\n\t\treturn validated;\n\t}\n\n\t/**\n\t * Parses incoming MCP icons and returns the resulting 'stored' record. Note\n\t * that this requires an active MCP server connection since we validate\n\t * against some of that connection's data. The icons may however be stored\n\t * and rehydrated later.\n\t */\n\tprivate _parseIcons(icons: MCP.Icons) {\n\t\tconst cnx = this._connection.get();\n\t\tif (!cnx) {\n\t\t\treturn [];\n\t\t}\n\n\t\treturn parseAndValidateMcpIcon(icons, cnx.launchDefinition, this._logger);\n\t}\n\n\tprivate _setServerTools(nonce: string | undefined, toolsPromise: Promise<MCP.Tool[]>, tx: ITransaction | undefined) {\n\t\tconst toolPromiseSafe = toolsPromise.then(async tools => {\n\t\t\tthis._logger.info(`Discovered ${tools.length} tools`);\n\t\t\tconst data = await this._getValidatedTools(tools);\n\t\t\tthis._primitiveCache.store(this.definition.id, { tools: data, nonce });\n\t\t\treturn { data, nonce };\n\t\t});\n\t\tthis._tools.fromServerPromise.set(new ObservablePromise(toolPromiseSafe), tx);\n\t\treturn toolPromiseSafe;\n\t}\n\n\tprivate _setServerPrompts(nonce: string | undefined, promptsPromise: Promise<MCP.Prompt[]>, tx: ITransaction | undefined) {\n\t\tconst promptsPromiseSafe = promptsPromise.then((result): { data: StoredMcpPrompt[]; nonce: string | undefined } => {\n\t\t\tconst data: StoredMcpPrompt[] = result.map(prompt => ({\n\t\t\t\t...prompt,\n\t\t\t\t_icons: this._parseIcons(prompt)\n\t\t\t}));\n\t\t\tthis._primitiveCache.store(this.definition.id, { prompts: data, nonce });\n\t\t\treturn { data, nonce };\n\t\t});\n\n\t\tthis._prompts.fromServerPromise.set(new ObservablePromise(promptsPromiseSafe), tx);\n\t\treturn promptsPromiseSafe;\n\t}\n\n\tprivate _toStoredMetadata(serverInfo?: MCP.Implementation, instructions?: string): StoredServerMetadata {\n\t\treturn {\n\t\t\tserverName: serverInfo ? serverInfo.title || serverInfo.name : undefined,\n\t\t\tserverInstructions: instructions,\n\t\t\tserverIcons: serverInfo ? this._parseIcons(serverInfo) : undefined,\n\t\t};\n\t}\n\n\tprivate _setServerMetadata(\n\t\tnonce: string | undefined,\n\t\t{ serverInfo, instructions, capabilities }: { serverInfo: MCP.Implementation; instructions: string | undefined; capabilities: MCP.ServerCapabilities },\n\t\ttx: ITransaction | undefined,\n\t) {\n\t\tconst serverMetadata: StoredServerMetadata = this._toStoredMetadata(serverInfo, instructions);\n\t\tthis._serverMetadata.fromServerPromise.set(ObservablePromise.resolved({ nonce, data: serverMetadata }), tx);\n\n\t\tconst capabilitiesEncoded = encodeCapabilities(capabilities);\n\t\tthis._capabilities.fromServerPromise.set(ObservablePromise.resolved({ data: capabilitiesEncoded, nonce }), tx);\n\t\tthis._primitiveCache.store(this.definition.id, { ...serverMetadata, nonce, capabilities: capabilitiesEncoded });\n\t}\n\n\tprivate _populateLiveData(handler: McpServerRequestHandler, cacheNonce: string | undefined, store: DisposableStore) {\n\t\tconst cts = new CancellationTokenSource();\n\t\tstore.add(toDisposable(() => cts.dispose(true)));\n\n\t\tconst updateTools = (tx: ITransaction | undefined) => {\n\t\t\tconst toolPromise = handler.capabilities.tools ? handler.listTools({}, cts.token) : Promise.resolve([]);\n\t\t\treturn this._setServerTools(cacheNonce, toolPromise, tx);\n\t\t};\n\n\t\tconst updatePrompts = (tx: ITransaction | undefined) => {\n\t\t\tconst promptsPromise = handler.capabilities.prompts ? handler.listPrompts({}, cts.token) : Promise.resolve([]);\n\t\t\treturn this._setServerPrompts(cacheNonce, promptsPromise, tx);\n\t\t};\n\n\t\tstore.add(handler.onDidChangeToolList(() => {\n\t\t\tthis._logger.info('Tool list changed, refreshing tools...');\n\t\t\tupdateTools(undefined);\n\t\t}));\n\n\t\tstore.add(handler.onDidChangePromptList(() => {\n\t\t\tthis._logger.info('Prompts list changed, refreshing prompts...');\n\t\t\tupdatePrompts(undefined);\n\t\t}));\n\n\t\ttransaction(tx => {\n\t\t\tthis._setServerMetadata(cacheNonce, { serverInfo: handler.serverInfo, instructions: handler.serverInstructions, capabilities: handler.capabilities }, tx);\n\t\t\tupdatePrompts(tx);\n\t\t\tconst toolUpdate = updateTools(tx);\n\n\t\t\ttoolUpdate.then(tools => {\n\t\t\t\tthis._telemetryService.publicLog2<ServerBootData, ServerBootClassification>('mcp/serverBoot', {\n\t\t\t\t\tsupportsLogging: !!handler.capabilities.logging,\n\t\t\t\t\tsupportsPrompts: !!handler.capabilities.prompts,\n\t\t\t\t\tsupportsResources: !!handler.capabilities.resources,\n\t\t\t\t\ttoolCount: tools.data.length,\n\t\t\t\t\tserverName: handler.serverInfo.name,\n\t\t\t\t\tserverVersion: handler.serverInfo.version,\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n}\n\nclass McpPrompt implements IMcpPrompt {\n\treadonly id: string;\n\treadonly name: string;\n\treadonly description?: string;\n\treadonly title?: string;\n\treadonly arguments: readonly MCP.PromptArgument[];\n\treadonly icons: IMcpIcons;\n\n\tconstructor(\n\t\tprivate readonly _server: McpServer,\n\t\tprivate readonly _definition: StoredMcpPrompt,\n\t) {\n\t\tthis.id = mcpPromptReplaceSpecialChars(this._server.definition.label + '.' + _definition.name);\n\t\tthis.name = _definition.name;\n\t\tthis.title = _definition.title;\n\t\tthis.description = _definition.description;\n\t\tthis.arguments = _definition.arguments || [];\n\t\tthis.icons = McpIcons.fromStored(this._definition._icons);\n\t}\n\n\tasync resolve(args: Record<string, string>, token?: CancellationToken): Promise<IMcpPromptMessage[]> {\n\t\tconst result = await McpServer.callOn(this._server, h => h.getPrompt({ name: this._definition.name, arguments: args }, token), token);\n\t\treturn result.messages;\n\t}\n\n\tasync complete(argument: string, prefix: string, alreadyResolved: Record<string, string>, token?: CancellationToken): Promise<string[]> {\n\t\tconst result = await McpServer.callOn(this._server, h => h.complete({\n\t\t\tref: { type: 'ref/prompt', name: this._definition.name },\n\t\t\targument: { name: argument, value: prefix },\n\t\t\tcontext: { arguments: alreadyResolved },\n\t\t}, token), token);\n\t\treturn result.completion.values;\n\t}\n}\n\nfunction encodeCapabilities(cap: MCP.ServerCapabilities): McpCapability {\n\tlet out = 0;\n\tif (cap.logging) { out |= McpCapability.Logging; }\n\tif (cap.completions) { out |= McpCapability.Completions; }\n\tif (cap.prompts) {\n\t\tout |= McpCapability.Prompts;\n\t\tif (cap.prompts.listChanged) {\n\t\t\tout |= McpCapability.PromptsListChanged;\n\t\t}\n\t}\n\tif (cap.resources) {\n\t\tout |= McpCapability.Resources;\n\t\tif (cap.resources.subscribe) {\n\t\t\tout |= McpCapability.ResourcesSubscribe;\n\t\t}\n\t\tif (cap.resources.listChanged) {\n\t\t\tout |= McpCapability.ResourcesListChanged;\n\t\t}\n\t}\n\tif (cap.tools) {\n\t\tout |= McpCapability.Tools;\n\t\tif (cap.tools.listChanged) {\n\t\t\tout |= McpCapability.ToolsListChanged;\n\t\t}\n\t}\n\treturn out;\n}\n\nexport class McpTool implements IMcpTool {\n\n\treadonly id: string;\n\treadonly referenceName: string;\n\treadonly icons: IMcpIcons;\n\n\tpublic get definition(): MCP.Tool { return this._definition; }\n\n\tconstructor(\n\t\tprivate readonly _server: McpServer,\n\t\tidPrefix: string,\n\t\tprivate readonly _definition: ValidatedMcpTool,\n\t\t@IMcpElicitationService private readonly _elicitationService: IMcpElicitationService,\n\t) {\n\t\tthis.referenceName = _definition.name.replaceAll('.', '_');\n\t\tthis.id = (idPrefix + _definition.name).replaceAll('.', '_').slice(0, McpToolName.MaxLength);\n\t\tthis.icons = McpIcons.fromStored(this._definition._icons);\n\t}\n\n\tasync call(params: Record<string, unknown>, context?: IMcpToolCallContext, token?: CancellationToken): Promise<MCP.CallToolResult> {\n\t\tif (context) { this._server.runningToolCalls.add(context); }\n\t\ttry {\n\t\t\treturn await this._callWithProgress(params, undefined, context, token);\n\t\t} finally {\n\t\t\tif (context) { this._server.runningToolCalls.delete(context); }\n\t\t}\n\t}\n\n\tasync callWithProgress(params: Record<string, unknown>, progress: ToolProgress, context?: IMcpToolCallContext, token?: CancellationToken): Promise<MCP.CallToolResult> {\n\t\tif (context) { this._server.runningToolCalls.add(context); }\n\t\ttry {\n\t\t\treturn await this._callWithProgress(params, progress, context, token);\n\t\t} finally {\n\t\t\tif (context) { this._server.runningToolCalls.delete(context); }\n\t\t}\n\t}\n\n\t_callWithProgress(params: Record<string, unknown>, progress: ToolProgress | undefined, context?: IMcpToolCallContext, token = CancellationToken.None, allowRetry = true): Promise<MCP.CallToolResult> {\n\t\t// serverToolName is always set now, but older cache entries (from 1.99-Insiders) may not have it.\n\t\tconst name = this._definition.serverToolName ?? this._definition.name;\n\t\tconst progressToken = progress ? generateUuid() : undefined;\n\t\tconst store = new DisposableStore();\n\n\t\treturn McpServer.callOn(this._server, async h => {\n\t\t\tif (progress) {\n\t\t\t\tstore.add(h.onDidReceiveProgressNotification((e) => {\n\t\t\t\t\tif (e.params.progressToken === progressToken) {\n\t\t\t\t\t\tprogress.report({\n\t\t\t\t\t\t\tmessage: e.params.message,\n\t\t\t\t\t\t\tprogress: e.params.total !== undefined && e.params.progress !== undefined ? e.params.progress / e.params.total : undefined,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t}\n\n\t\t\tconst meta: Record<string, unknown> = { progressToken };\n\t\t\tif (context?.chatSessionId) {\n\t\t\t\tmeta['vscode.conversationId'] = context.chatSessionId;\n\t\t\t}\n\t\t\tif (context?.chatRequestId) {\n\t\t\t\tmeta['vscode.requestId'] = context.chatRequestId;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst result = await h.callTool({ name, arguments: params, _meta: meta }, token);\n\t\t\t\t// Wait for tools to refresh for dynamic servers (#261611)\n\t\t\t\tawait this._server.awaitToolRefresh();\n\n\t\t\t\treturn result;\n\t\t\t} catch (err) {\n\t\t\t\t// Handle URL elicitation required error\n\t\t\t\tif (err instanceof MpcResponseError && err.code === MCP.URL_ELICITATION_REQUIRED && allowRetry) {\n\t\t\t\t\tawait this._handleElicitationErr(err, context, token);\n\t\t\t\t\treturn this._callWithProgress(params, progress, context, token, false);\n\t\t\t\t}\n\n\t\t\t\tconst state = this._server.connectionState.get();\n\t\t\t\tif (allowRetry && state.state === McpConnectionState.Kind.Error && state.shouldRetry) {\n\t\t\t\t\treturn this._callWithProgress(params, progress, context, token, false);\n\t\t\t\t} else {\n\t\t\t\t\tthrow err;\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tstore.dispose();\n\t\t\t}\n\t\t}, token);\n\t}\n\n\tprivate async _handleElicitationErr(err: MpcResponseError, context: IMcpToolCallContext | undefined, token: CancellationToken) {\n\t\tconst elicitations = (err.data as MCP.URLElicitationRequiredError['error']['data'])?.elicitations;\n\t\tif (Array.isArray(elicitations) && elicitations.length > 0) {\n\t\t\tfor (const elicitation of elicitations) {\n\t\t\t\tconst elicitResult = await this._elicitationService.elicit(this._server, context, elicitation, token);\n\n\t\t\t\ttry {\n\t\t\t\t\tif (elicitResult.value.action !== 'accept') {\n\t\t\t\t\t\tthrow err;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (elicitResult.kind === ElicitationKind.URL) {\n\t\t\t\t\t\tawait elicitResult.wait;\n\t\t\t\t\t}\n\t\t\t\t} finally {\n\t\t\t\t\telicitResult.dispose();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tcompare(other: IMcpTool): number {\n\t\treturn this._definition.name.localeCompare(other.definition.name);\n\t}\n}\n\nfunction warnInvalidTools(instaService: IInstantiationService, serverName: string, errorText: string) {\n\tinstaService.invokeFunction((accessor) => {\n\t\tconst notificationService = accessor.get(INotificationService);\n\t\tconst editorService = accessor.get(IEditorService);\n\t\tnotificationService.notify({\n\t\t\tseverity: Severity.Warning,\n\t\t\tmessage: localize('mcpBadSchema', 'MCP server `{0}` has tools with invalid parameters which will be omitted.', serverName),\n\t\t\tactions: {\n\t\t\t\tprimary: [{\n\t\t\t\t\tclass: undefined,\n\t\t\t\t\tenabled: true,\n\t\t\t\t\tid: 'mcpBadSchema.show',\n\t\t\t\t\ttooltip: '',\n\t\t\t\t\tlabel: localize('mcpBadSchema.show', 'Show'),\n\t\t\t\t\trun: () => {\n\t\t\t\t\t\teditorService.openEditor({\n\t\t\t\t\t\t\tresource: undefined,\n\t\t\t\t\t\t\tcontents: errorText,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}]\n\t\t\t}\n\t\t});\n\t});\n}\n\nclass McpResource implements IMcpResource {\n\treadonly uri: URI;\n\treadonly mcpUri: string;\n\treadonly name: string;\n\treadonly description: string | undefined;\n\treadonly mimeType: string | undefined;\n\treadonly sizeInBytes: number | undefined;\n\treadonly title: string | undefined;\n\n\tconstructor(\n\t\tserver: McpServer,\n\t\toriginal: MCP.Resource,\n\t\tpublic readonly icons: IMcpIcons,\n\t) {\n\t\tthis.mcpUri = original.uri;\n\t\tthis.title = original.title;\n\t\tthis.uri = McpResourceURI.fromServer(server.definition, original.uri);\n\t\tthis.name = original.name;\n\t\tthis.description = original.description;\n\t\tthis.mimeType = original.mimeType;\n\t\tthis.sizeInBytes = original.size;\n\t}\n}\n\nclass McpResourceTemplate implements IMcpResourceTemplate {\n\treadonly name: string;\n\treadonly title?: string | undefined;\n\treadonly description?: string;\n\treadonly mimeType?: string;\n\treadonly template: UriTemplate;\n\n\tconstructor(\n\t\tprivate readonly _server: McpServer,\n\t\tprivate readonly _definition: MCP.ResourceTemplate,\n\t\tpublic readonly icons: IMcpIcons,\n\t) {\n\t\tthis.name = _definition.name;\n\t\tthis.description = _definition.description;\n\t\tthis.mimeType = _definition.mimeType;\n\t\tthis.title = _definition.title;\n\t\tthis.template = UriTemplate.parse(_definition.uriTemplate);\n\t}\n\n\tpublic resolveURI(vars: Record<string, unknown>): URI {\n\t\tconst serverUri = this.template.resolve(vars);\n\t\treturn McpResourceURI.fromServer(this._server.definition, serverUri);\n\t}\n\n\tasync complete(templatePart: string, prefix: string, alreadyResolved: Record<string, string | string[]>, token?: CancellationToken): Promise<string[]> {\n\t\tconst result = await McpServer.callOn(this._server, h => h.complete({\n\t\t\tref: { type: 'ref/resource', uri: this._definition.uriTemplate },\n\t\t\targument: { name: templatePart, value: prefix },\n\t\t\tcontext: {\n\t\t\t\targuments: mapValues(alreadyResolved, v => Array.isArray(v) ? v.join('/') : v),\n\t\t\t},\n\t\t}, token), token);\n\t\treturn result.completion.values;\n\t}\n}\n"]}