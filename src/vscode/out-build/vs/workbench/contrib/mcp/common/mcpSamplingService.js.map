{"version":3,"sources":["vs/workbench/contrib/mcp/common/mcpSamplingService.ts"],"names":[],"mappings":"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","file":"mcpSamplingService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { mapFindFirst } from '../../../../base/common/arraysFind.js';\nimport { Sequencer } from '../../../../base/common/async.js';\nimport { decodeBase64 } from '../../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { Event } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { isDefined } from '../../../../base/common/types.js';\nimport { localize } from '../../../../nls.js';\nimport { ICommandService } from '../../../../platform/commands/common/commands.js';\nimport { ConfigurationTarget, getConfigValueInTarget, IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { ExtensionIdentifier } from '../../../../platform/extensions/common/extensions.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { INotificationService, Severity } from '../../../../platform/notification/common/notification.js';\nimport { ChatImageMimeType, ChatMessageRole, IChatMessage, IChatMessagePart, ILanguageModelsService } from '../../chat/common/languageModels.js';\nimport { McpCommandIds } from './mcpCommandIds.js';\nimport { IMcpServerSamplingConfiguration, mcpServerSamplingSection } from './mcpConfiguration.js';\nimport { McpSamplingLog } from './mcpSamplingLog.js';\nimport { IMcpSamplingService, IMcpServer, ISamplingOptions, ISamplingResult, McpError } from './mcpTypes.js';\nimport { MCP } from './modelContextProtocol.js';\n\nconst enum ModelMatch {\n\tUnsureAllowedDuringChat,\n\tUnsureAllowedOutsideChat,\n\tNotAllowed,\n\tNoMatchingModel,\n}\n\nexport class McpSamplingService extends Disposable implements IMcpSamplingService {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _sessionSets = {\n\t\tallowedDuringChat: new Map<string, boolean>(),\n\t\tallowedOutsideChat: new Map<string, boolean>(),\n\t};\n\n\tprivate readonly _logs: McpSamplingLog;\n\n\tprivate readonly _modelSequencer = new Sequencer();\n\n\tconstructor(\n\t\t@ILanguageModelsService private readonly _languageModelsService: ILanguageModelsService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@INotificationService private readonly _notificationService: INotificationService,\n\t\t@ICommandService private readonly _commandService: ICommandService,\n\t\t@IInstantiationService instaService: IInstantiationService,\n\t) {\n\t\tsuper();\n\t\tthis._logs = this._register(instaService.createInstance(McpSamplingLog));\n\t}\n\n\tasync sample(opts: ISamplingOptions, token = CancellationToken.None): Promise<ISamplingResult> {\n\t\tconst messages = opts.params.messages.map((message): IChatMessage | undefined => {\n\t\t\tconst content: IChatMessagePart | undefined = message.content.type === 'text'\n\t\t\t\t? { type: 'text', value: message.content.text }\n\t\t\t\t: message.content.type === 'image' || message.content.type === 'audio'\n\t\t\t\t\t? { type: 'image_url', value: { mimeType: message.content.mimeType as ChatImageMimeType, data: decodeBase64(message.content.data) } }\n\t\t\t\t\t: undefined;\n\t\t\tif (!content) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\trole: message.role === 'assistant' ? ChatMessageRole.Assistant : ChatMessageRole.User,\n\t\t\t\tcontent: [content]\n\t\t\t};\n\t\t}).filter(isDefined);\n\n\t\tif (opts.params.systemPrompt) {\n\t\t\tmessages.unshift({ role: ChatMessageRole.System, content: [{ type: 'text', value: opts.params.systemPrompt }] });\n\t\t}\n\n\t\tconst model = await this._modelSequencer.queue(() => this._getMatchingModel(opts));\n\t\t// todo@connor4312: nullExtensionDescription.identifier -> undefined with API update\n\t\tconst response = await this._languageModelsService.sendChatRequest(model, new ExtensionIdentifier('core'), messages, {}, token);\n\n\t\tlet responseText = '';\n\n\t\t// MCP doesn't have a notion of a multi-part sampling response, so we only preserve text\n\t\t// Ref https://github.com/modelcontextprotocol/modelcontextprotocol/issues/91\n\t\tconst streaming = (async () => {\n\t\t\tfor await (const part of response.stream) {\n\t\t\t\tif (Array.isArray(part)) {\n\t\t\t\t\tfor (const p of part) {\n\t\t\t\t\t\tif (p.type === 'text') {\n\t\t\t\t\t\t\tresponseText += p.value;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else if (part.type === 'text') {\n\t\t\t\t\tresponseText += part.value;\n\t\t\t\t}\n\t\t\t}\n\t\t})();\n\n\t\ttry {\n\t\t\tawait Promise.all([response.result, streaming]);\n\t\t\tthis._logs.add(opts.server, opts.params.messages, responseText, model);\n\t\t\treturn {\n\t\t\t\tsample: {\n\t\t\t\t\tmodel,\n\t\t\t\t\tcontent: { type: 'text', text: responseText },\n\t\t\t\t\trole: 'assistant', // it came from the model!\n\t\t\t\t},\n\t\t\t};\n\t\t} catch (err) {\n\t\t\tthrow McpError.unknown(err);\n\t\t}\n\t}\n\n\thasLogs(server: IMcpServer): boolean {\n\t\treturn this._logs.has(server);\n\t}\n\n\tgetLogText(server: IMcpServer): string {\n\t\treturn this._logs.getAsText(server);\n\t}\n\n\tprivate async _getMatchingModel(opts: ISamplingOptions): Promise<string> {\n\t\tconst model = await this._getMatchingModelInner(opts.server, opts.isDuringToolCall, opts.params.modelPreferences);\n\n\t\tif (model === ModelMatch.UnsureAllowedDuringChat) {\n\t\t\tconst retry = await this._showContextual(\n\t\t\t\topts.isDuringToolCall,\n\t\t\t\tlocalize('mcp.sampling.allowDuringChat.title', 'Allow MCP tools from \"{0}\" to make LLM requests?', opts.server.definition.label),\n\t\t\t\tlocalize('mcp.sampling.allowDuringChat.desc', 'The MCP server \"{0}\" has issued a request to make a language model call. Do you want to allow it to make requests during chat?', opts.server.definition.label),\n\t\t\t\tthis.allowButtons(opts.server, 'allowedDuringChat')\n\t\t\t);\n\t\t\tif (retry) {\n\t\t\t\treturn this._getMatchingModel(opts);\n\t\t\t}\n\t\t\tthrow McpError.notAllowed();\n\t\t} else if (model === ModelMatch.UnsureAllowedOutsideChat) {\n\t\t\tconst retry = await this._showContextual(\n\t\t\t\topts.isDuringToolCall,\n\t\t\t\tlocalize('mcp.sampling.allowOutsideChat.title', 'Allow MCP server \"{0}\" to make LLM requests?', opts.server.definition.label),\n\t\t\t\tlocalize('mcp.sampling.allowOutsideChat.desc', 'The MCP server \"{0}\" has issued a request to make a language model call. Do you want to allow it to make requests, outside of tool calls during chat?', opts.server.definition.label),\n\t\t\t\tthis.allowButtons(opts.server, 'allowedOutsideChat')\n\t\t\t);\n\t\t\tif (retry) {\n\t\t\t\treturn this._getMatchingModel(opts);\n\t\t\t}\n\t\t\tthrow McpError.notAllowed();\n\t\t} else if (model === ModelMatch.NotAllowed) {\n\t\t\tthrow McpError.notAllowed();\n\t\t} else if (model === ModelMatch.NoMatchingModel) {\n\t\t\tconst newlyPickedModels = opts.isDuringToolCall\n\t\t\t\t? await this._commandService.executeCommand<number>(McpCommandIds.ConfigureSamplingModels, opts.server)\n\t\t\t\t: await this._notify(\n\t\t\t\t\tlocalize('mcp.sampling.needsModels', 'MCP server \"{0}\" triggered a language model request, but it has no allowlisted models.', opts.server.definition.label),\n\t\t\t\t\t{\n\t\t\t\t\t\t[localize('configure', 'Configure')]: () => this._commandService.executeCommand<number>(McpCommandIds.ConfigureSamplingModels, opts.server),\n\t\t\t\t\t\t[localize('cancel', 'Cancel')]: () => Promise.resolve(undefined),\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\tif (newlyPickedModels) {\n\t\t\t\treturn this._getMatchingModel(opts);\n\t\t\t}\n\t\t\tthrow McpError.notAllowed();\n\t\t}\n\n\t\treturn model;\n\t}\n\n\tprivate allowButtons(server: IMcpServer, key: 'allowedDuringChat' | 'allowedOutsideChat') {\n\t\treturn {\n\t\t\t[localize('mcp.sampling.allow.inSession', 'Allow in this Session')]: async () => {\n\t\t\t\tthis._sessionSets[key].set(server.definition.id, true);\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\t[localize('mcp.sampling.allow.always', 'Always')]: async () => {\n\t\t\t\tawait this.updateConfig(server, c => c[key] = true);\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\t[localize('mcp.sampling.allow.notNow', 'Not Now')]: async () => {\n\t\t\t\tthis._sessionSets[key].set(server.definition.id, false);\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\t[localize('mcp.sampling.allow.never', 'Never')]: async () => {\n\t\t\t\tawait this.updateConfig(server, c => c[key] = false);\n\t\t\t\treturn false;\n\t\t\t},\n\t\t};\n\t}\n\n\tprivate async _showContextual<T>(isDuringToolCall: boolean, title: string, message: string, buttons: Record<string, () => T>): Promise<Awaited<T> | undefined> {\n\t\tif (isDuringToolCall) {\n\t\t\tconst result = await this._dialogService.prompt({\n\t\t\t\ttype: 'question',\n\t\t\t\ttitle: title,\n\t\t\t\tmessage,\n\t\t\t\tbuttons: Object.entries(buttons).map(([label, run]) => ({ label, run })),\n\t\t\t});\n\t\t\treturn await result.result;\n\t\t} else {\n\t\t\treturn await this._notify(message, buttons);\n\t\t}\n\t}\n\n\tprivate async _notify<T>(message: string, buttons: Record<string, () => T>): Promise<Awaited<T> | undefined> {\n\t\treturn await new Promise<T | undefined>(resolve => {\n\t\t\tconst handle = this._notificationService.prompt(\n\t\t\t\tSeverity.Info,\n\t\t\t\tmessage,\n\t\t\t\tObject.entries(buttons).map(([label, action]) => ({\n\t\t\t\t\tlabel,\n\t\t\t\t\trun: () => resolve(action()),\n\t\t\t\t}))\n\t\t\t);\n\t\t\tEvent.once(handle.onDidClose)(() => resolve(undefined));\n\t\t});\n\t}\n\n\t/**\n\t * Gets the matching model for the MCP server in this context, or\n\t * a reason why no model could be selected.\n\t */\n\tprivate async _getMatchingModelInner(server: IMcpServer, isDuringToolCall: boolean, preferences: MCP.ModelPreferences | undefined): Promise<ModelMatch | string> {\n\t\tconst config = this.getConfig(server);\n\t\t// 1. Ensure the server is allowed to sample in this context\n\t\tif (isDuringToolCall && !config.allowedDuringChat && !this._sessionSets.allowedDuringChat.has(server.definition.id)) {\n\t\t\treturn config.allowedDuringChat === undefined ? ModelMatch.UnsureAllowedDuringChat : ModelMatch.NotAllowed;\n\t\t} else if (!isDuringToolCall && !config.allowedOutsideChat && !this._sessionSets.allowedOutsideChat.has(server.definition.id)) {\n\t\t\treturn config.allowedOutsideChat === undefined ? ModelMatch.UnsureAllowedOutsideChat : ModelMatch.NotAllowed;\n\t\t}\n\n\t\t// 2. Get the configured models, or the default model(s)\n\t\tconst foundModelIdsDeep = config.allowedModels?.filter(m => !!this._languageModelsService.lookupLanguageModel(m)) || this._languageModelsService.getLanguageModelIds().filter(m => this._languageModelsService.lookupLanguageModel(m)?.isDefault);\n\n\t\tconst foundModelIds = foundModelIdsDeep.flat().sort((a, b) => b.length - a.length); // Sort by length to prefer most specific\n\n\t\tif (!foundModelIds.length) {\n\t\t\treturn ModelMatch.NoMatchingModel;\n\t\t}\n\n\t\t// 3. If preferences are provided, try to match them from the allowed models\n\t\tif (preferences?.hints) {\n\t\t\tconst found = mapFindFirst(preferences.hints, hint => foundModelIds.find(model => model.toLowerCase().includes(hint.name!.toLowerCase())));\n\t\t\tif (found) {\n\t\t\t\treturn found;\n\t\t\t}\n\t\t}\n\n\t\treturn foundModelIds[0]; // Return the first matching model\n\t}\n\n\tprivate _configKey(server: IMcpServer) {\n\t\treturn `${server.collection.label}: ${server.definition.label}`;\n\t}\n\n\tpublic getConfig(server: IMcpServer): IMcpServerSamplingConfiguration {\n\t\treturn this._getConfig(server).value || {};\n\t}\n\n\t/**\n\t * _getConfig reads the sampling config reads the `{ server: data }` mapping\n\t * from the appropriate config. We read from the most specific possible\n\t * config up to the default configuration location that the MCP server itself\n\t * is defined in. We don't go further because then workspace-specific servers\n\t * would get in the user settings which is not meaningful and could lead\n\t * to confusion.\n\t *\n\t * todo@connor4312: generalize this for other esttings when we have them\n\t */\n\tprivate _getConfig(server: IMcpServer) {\n\t\tconst def = server.readDefinitions().get();\n\t\tconst mostSpecificConfig = ConfigurationTarget.MEMORY;\n\t\tconst leastSpecificConfig = def.collection?.configTarget || ConfigurationTarget.USER;\n\t\tconst key = this._configKey(server);\n\t\tconst resource = def.collection?.presentation?.origin;\n\n\t\tconst configValue = this._configurationService.inspect<Record<string, IMcpServerSamplingConfiguration>>(mcpServerSamplingSection, { resource });\n\t\tfor (let target = mostSpecificConfig; target >= leastSpecificConfig; target--) {\n\t\t\tconst mapping = getConfigValueInTarget(configValue, target);\n\t\t\tconst config = mapping?.[key];\n\t\t\tif (config) {\n\t\t\t\treturn { value: config, key, mapping, target, resource };\n\t\t\t}\n\t\t}\n\n\t\treturn { value: undefined, mapping: getConfigValueInTarget(configValue, leastSpecificConfig), key, target: leastSpecificConfig, resource };\n\t}\n\n\tpublic async updateConfig(server: IMcpServer, mutate: (r: IMcpServerSamplingConfiguration) => unknown) {\n\t\tconst { value, mapping, key, target, resource } = this._getConfig(server);\n\n\t\tconst newConfig = { ...value };\n\t\tmutate(newConfig);\n\n\t\tawait this._configurationService.updateValue(\n\t\t\tmcpServerSamplingSection,\n\t\t\t{ ...mapping, [key]: newConfig },\n\t\t\t{ resource },\n\t\t\ttarget,\n\t\t);\n\t\treturn newConfig;\n\t}\n}\n"]}