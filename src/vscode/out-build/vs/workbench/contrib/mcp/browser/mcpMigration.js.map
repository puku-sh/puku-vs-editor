{"version":3,"sources":["vs/workbench/contrib/mcp/browser/mcpMigration.ts"],"names":[],"mappings":"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","file":"mcpMigration.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ConfigurationTarget } from '../../../../platform/configuration/common/configuration.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IMcpServerConfiguration, IMcpServerVariable, IMcpStdioServerConfiguration, McpServerType } from '../../../../platform/mcp/common/mcpPlatformTypes.js';\nimport { IStringDictionary } from '../../../../base/common/collections.js';\nimport { mcpConfigurationSection } from '../../../contrib/mcp/common/mcpConfiguration.js';\nimport { IWorkbenchMcpManagementService } from '../../../services/mcp/common/mcpWorkbenchManagementService.js';\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { IUserDataProfileService } from '../../../services/userDataProfile/common/userDataProfile.js';\nimport { FileOperationResult, IFileService, toFileOperationResult } from '../../../../platform/files/common/files.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { parse } from '../../../../base/common/jsonc.js';\nimport { isObject, Mutable } from '../../../../base/common/types.js';\nimport { IRemoteAgentService } from '../../../services/remote/common/remoteAgentService.js';\nimport { IJSONEditingService } from '../../../services/configuration/common/jsonEditing.js';\nimport { INotificationService, Severity } from '../../../../platform/notification/common/notification.js';\nimport { ICommandService } from '../../../../platform/commands/common/commands.js';\nimport { McpCommandIds } from '../common/mcpCommandIds.js';\nimport { localize } from '../../../../nls.js';\n\ninterface IMcpConfiguration {\n\tinputs?: IMcpServerVariable[];\n\tservers?: IStringDictionary<IMcpServerConfiguration>;\n}\n\nexport class McpConfigMigrationContribution extends Disposable implements IWorkbenchContribution {\n\n\tstatic ID = 'workbench.mcp.config.migration';\n\n\tconstructor(\n\t\t@IWorkbenchMcpManagementService private readonly mcpManagementService: IWorkbenchMcpManagementService,\n\t\t@IUserDataProfileService private readonly userDataProfileService: IUserDataProfileService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IRemoteAgentService private readonly remoteAgentService: IRemoteAgentService,\n\t\t@IJSONEditingService private readonly jsonEditingService: IJSONEditingService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@INotificationService private readonly notificationService: INotificationService,\n\t\t@ICommandService private readonly commandService: ICommandService,\n\t) {\n\t\tsuper();\n\t\tthis.migrateMcpConfig();\n\t}\n\n\tprivate async migrateMcpConfig(): Promise<void> {\n\t\ttry {\n\t\t\tconst userMcpConfig = await this.parseMcpConfig(this.userDataProfileService.currentProfile.settingsResource);\n\t\t\tif (userMcpConfig && userMcpConfig.servers && Object.keys(userMcpConfig.servers).length > 0) {\n\t\t\t\tawait Promise.all(Object.entries(userMcpConfig.servers).map(([name, config], index) => this.mcpManagementService.install({ name, config, inputs: index === 0 ? userMcpConfig.inputs : undefined })));\n\t\t\t\tawait this.removeMcpConfig(this.userDataProfileService.currentProfile.settingsResource);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error(`MCP migration: Failed to migrate user MCP config`, error);\n\t\t}\n\t\tthis.watchForMcpConfiguration(this.userDataProfileService.currentProfile.settingsResource, false);\n\n\t\tconst remoteEnvironment = await this.remoteAgentService.getEnvironment();\n\t\tif (remoteEnvironment) {\n\t\t\ttry {\n\t\t\t\tconst userRemoteMcpConfig = await this.parseMcpConfig(remoteEnvironment.settingsPath);\n\t\t\t\tif (userRemoteMcpConfig && userRemoteMcpConfig.servers && Object.keys(userRemoteMcpConfig.servers).length > 0) {\n\t\t\t\t\tawait Promise.all(Object.entries(userRemoteMcpConfig.servers).map(([name, config], index) => this.mcpManagementService.install({ name, config, inputs: index === 0 ? userRemoteMcpConfig.inputs : undefined }, { target: ConfigurationTarget.USER_REMOTE })));\n\t\t\t\t\tawait this.removeMcpConfig(remoteEnvironment.settingsPath);\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(`MCP migration: Failed to migrate remote MCP config`, error);\n\t\t\t}\n\t\t\tthis.watchForMcpConfiguration(remoteEnvironment.settingsPath, true);\n\t\t}\n\n\t}\n\n\tprivate watchForMcpConfiguration(file: URI, isRemote: boolean): void {\n\t\tthis._register(this.fileService.watch(file));\n\t\tthis._register(this.fileService.onDidFilesChange(e => {\n\t\t\tif (e.contains(file)) {\n\t\t\t\tthis.checkForMcpConfigInFile(file, isRemote);\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate async checkForMcpConfigInFile(settingsFile: URI, isRemote: boolean): Promise<void> {\n\t\ttry {\n\t\t\tconst mcpConfig = await this.parseMcpConfig(settingsFile);\n\t\t\tif (mcpConfig && mcpConfig.servers && Object.keys(mcpConfig.servers).length > 0) {\n\t\t\t\tthis.showMcpConfigErrorNotification(isRemote);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\t// Ignore parsing errors - file might not exist or be malformed\n\t\t}\n\t}\n\n\tprivate showMcpConfigErrorNotification(isRemote: boolean): void {\n\t\tconst message = isRemote\n\t\t\t? localize('mcp.migration.remoteConfigFound', 'MCP servers should no longer be configured in remote user settings. Use the dedicated MCP configuration instead.')\n\t\t\t: localize('mcp.migration.userConfigFound', 'MCP servers should no longer be configured in user settings. Use the dedicated MCP configuration instead.');\n\n\t\tconst openConfigLabel = isRemote\n\t\t\t? localize('mcp.migration.openRemoteConfig', 'Open Remote User MCP Configuration')\n\t\t\t: localize('mcp.migration.openUserConfig', 'Open User MCP Configuration');\n\n\t\tconst commandId = isRemote ? McpCommandIds.OpenRemoteUserMcp : McpCommandIds.OpenUserMcp;\n\n\t\tthis.notificationService.prompt(\n\t\t\tSeverity.Error,\n\t\t\tmessage,\n\t\t\t[{\n\t\t\t\tlabel: localize('mcp.migration.update', 'Update Now'),\n\t\t\t\trun: async () => {\n\t\t\t\t\tawait this.migrateMcpConfig();\n\t\t\t\t\tawait this.commandService.executeCommand(commandId);\n\t\t\t\t},\n\t\t\t}, {\n\t\t\t\tlabel: openConfigLabel,\n\t\t\t\tkeepOpen: true,\n\t\t\t\trun: () => this.commandService.executeCommand(commandId)\n\t\t\t}]\n\t\t);\n\t}\n\n\tprivate async parseMcpConfig(settingsFile: URI): Promise<IMcpConfiguration | undefined> {\n\t\ttry {\n\t\t\tconst content = await this.fileService.readFile(settingsFile);\n\t\t\tconst settingsObject: IStringDictionary<unknown> = parse(content.value.toString());\n\t\t\tif (!isObject(settingsObject)) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tconst mcpConfiguration = settingsObject[mcpConfigurationSection] as IMcpConfiguration;\n\t\t\tif (mcpConfiguration && mcpConfiguration.servers) {\n\t\t\t\tfor (const [, config] of Object.entries(mcpConfiguration.servers)) {\n\t\t\t\t\tif (config.type === undefined) {\n\t\t\t\t\t\t(<Mutable<IMcpServerConfiguration>>config).type = (<IMcpStdioServerConfiguration>config).command ? McpServerType.LOCAL : McpServerType.REMOTE;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn mcpConfiguration;\n\t\t} catch (error) {\n\t\t\tif (toFileOperationResult(error) !== FileOperationResult.FILE_NOT_FOUND) {\n\t\t\t\tthis.logService.warn(`MCP migration: Failed to parse MCP config from ${settingsFile}:`, error);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t}\n\n\tprivate async removeMcpConfig(settingsFile: URI): Promise<void> {\n\t\ttry {\n\t\t\tawait this.jsonEditingService.write(settingsFile, [\n\t\t\t\t{\n\t\t\t\t\tpath: [mcpConfigurationSection],\n\t\t\t\t\tvalue: undefined\n\t\t\t\t}\n\t\t\t], true);\n\t\t} catch (error) {\n\t\t\tthis.logService.warn(`MCP migration: Failed to remove MCP config from ${settingsFile}:`, error);\n\t\t}\n\t}\n}\n"]}