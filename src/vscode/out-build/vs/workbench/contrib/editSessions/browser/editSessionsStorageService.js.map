{"version":3,"sources":["vs/workbench/contrib/editSessions/browser/editSessionsStorageService.ts"],"names":[],"mappings":"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","file":"editSessionsStorageService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable, DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { localize } from '../../../../nls.js';\nimport { Action2, MenuId, MenuRegistry, registerAction2 } from '../../../../platform/actions/common/actions.js';\nimport { ContextKeyExpr, IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IEnvironmentService } from '../../../../platform/environment/common/environment.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { IQuickInputService, IQuickPickItem, IQuickPickSeparator } from '../../../../platform/quickinput/common/quickInput.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { createSyncHeaders, IAuthenticationProvider, IResourceRefHandle } from '../../../../platform/userDataSync/common/userDataSync.js';\nimport { AuthenticationSession, AuthenticationSessionsChangeEvent, IAuthenticationService } from '../../../services/authentication/common/authentication.js';\nimport { IExtensionService } from '../../../services/extensions/common/extensions.js';\nimport { EDIT_SESSIONS_SIGNED_IN, EditSession, EDIT_SESSION_SYNC_CATEGORY, IEditSessionsStorageService, EDIT_SESSIONS_SIGNED_IN_KEY, IEditSessionsLogService, SyncResource, EDIT_SESSIONS_PENDING_KEY } from '../common/editSessions.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { getCurrentAuthenticationSessionInfo } from '../../../services/authentication/browser/authenticationService.js';\nimport { isWeb } from '../../../../base/common/platform.js';\nimport { IUserDataSyncMachinesService, UserDataSyncMachinesService } from '../../../../platform/userDataSync/common/userDataSyncMachines.js';\nimport { Emitter } from '../../../../base/common/event.js';\nimport { CancellationError } from '../../../../base/common/errors.js';\nimport { EditSessionsStoreClient } from '../common/editSessionsStorageClient.js';\nimport { ISecretStorageService } from '../../../../platform/secrets/common/secrets.js';\n\ntype ExistingSession = IQuickPickItem & { session: AuthenticationSession & { providerId: string } };\ntype AuthenticationProviderOption = IQuickPickItem & { provider: IAuthenticationProvider };\n\nexport class EditSessionsWorkbenchService extends Disposable implements IEditSessionsStorageService {\n\n\tdeclare _serviceBrand: undefined;\n\n\tpublic readonly SIZE_LIMIT = Math.floor(1024 * 1024 * 1.9); // 2 MB\n\n\tprivate serverConfiguration;\n\tprivate machineClient: IUserDataSyncMachinesService | undefined;\n\n\tprivate authenticationInfo: { sessionId: string; token: string; providerId: string } | undefined;\n\tprivate static CACHED_SESSION_STORAGE_KEY = 'editSessionAccountPreference';\n\n\tprivate initialized = false;\n\tprivate readonly signedInContext: IContextKey<boolean>;\n\n\tget isSignedIn() {\n\t\treturn this.existingSessionId !== undefined;\n\t}\n\n\tprivate _didSignIn = new Emitter<void>();\n\tget onDidSignIn() {\n\t\treturn this._didSignIn.event;\n\t}\n\n\tprivate _didSignOut = new Emitter<void>();\n\tget onDidSignOut() {\n\t\treturn this._didSignOut.event;\n\t}\n\n\tprivate _lastWrittenResources = new Map<SyncResource, { ref: string; content: string }>();\n\tget lastWrittenResources() {\n\t\treturn this._lastWrittenResources;\n\t}\n\n\tprivate _lastReadResources = new Map<SyncResource, { ref: string; content: string }>();\n\tget lastReadResources() {\n\t\treturn this._lastReadResources;\n\t}\n\n\tstoreClient: EditSessionsStoreClient | undefined; // TODO@joyceerhl lifecycle hack\n\n\tconstructor(\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@IQuickInputService private readonly quickInputService: IQuickInputService,\n\t\t@IAuthenticationService private readonly authenticationService: IAuthenticationService,\n\t\t@IExtensionService private readonly extensionService: IExtensionService,\n\t\t@IEnvironmentService private readonly environmentService: IEnvironmentService,\n\t\t@IEditSessionsLogService private readonly logService: IEditSessionsLogService,\n\t\t@IProductService private readonly productService: IProductService,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService,\n\t\t@IDialogService private readonly dialogService: IDialogService,\n\t\t@ISecretStorageService private readonly secretStorageService: ISecretStorageService\n\t) {\n\t\tsuper();\n\t\tthis.serverConfiguration = this.productService['editSessions.store'];\n\t\t// If the user signs out of the current session, reset our cached auth state in memory and on disk\n\t\tthis._register(this.authenticationService.onDidChangeSessions((e) => this.onDidChangeSessions(e.event)));\n\n\t\t// If another window changes the preferred session storage, reset our cached auth state in memory\n\t\tthis._register(this.storageService.onDidChangeValue(StorageScope.APPLICATION, EditSessionsWorkbenchService.CACHED_SESSION_STORAGE_KEY, this._store)(() => this.onDidChangeStorage()));\n\n\t\tthis.registerSignInAction();\n\t\tthis.registerResetAuthenticationAction();\n\n\t\tthis.signedInContext = EDIT_SESSIONS_SIGNED_IN.bindTo(this.contextKeyService);\n\t\tthis.signedInContext.set(this.existingSessionId !== undefined);\n\t}\n\n\t/**\n\t * @param resource: The resource to retrieve content for.\n\t * @param content An object representing resource state to be restored.\n\t * @returns The ref of the stored state.\n\t */\n\tasync write(resource: SyncResource, content: string | EditSession): Promise<string> {\n\t\tawait this.initialize('write', false);\n\t\tif (!this.initialized) {\n\t\t\tthrow new Error('Please sign in to store your edit session.');\n\t\t}\n\n\t\tif (typeof content !== 'string' && content.machine === undefined) {\n\t\t\tcontent.machine = await this.getOrCreateCurrentMachineId();\n\t\t}\n\n\t\tcontent = typeof content === 'string' ? content : JSON.stringify(content);\n\t\tconst ref = await this.storeClient!.writeResource(resource, content, null, undefined, createSyncHeaders(generateUuid()));\n\n\t\tthis._lastWrittenResources.set(resource, { ref, content });\n\n\t\treturn ref;\n\t}\n\n\t/**\n\t * @param resource: The resource to retrieve content for.\n\t * @param ref: A specific content ref to retrieve content for, if it exists.\n\t * If undefined, this method will return the latest saved edit session, if any.\n\t *\n\t * @returns An object representing the requested or latest state, if any.\n\t */\n\tasync read(resource: SyncResource, ref: string | undefined): Promise<{ ref: string; content: string } | undefined> {\n\t\tawait this.initialize('read', false);\n\t\tif (!this.initialized) {\n\t\t\tthrow new Error('Please sign in to apply your latest edit session.');\n\t\t}\n\n\t\tlet content: string | undefined | null;\n\t\tconst headers = createSyncHeaders(generateUuid());\n\t\ttry {\n\t\t\tif (ref !== undefined) {\n\t\t\t\tcontent = await this.storeClient?.resolveResourceContent(resource, ref, undefined, headers);\n\t\t\t} else {\n\t\t\t\tconst result = await this.storeClient?.readResource(resource, null, undefined, headers);\n\t\t\t\tcontent = result?.content;\n\t\t\t\tref = result?.ref;\n\t\t\t}\n\t\t} catch (ex) {\n\t\t\tthis.logService.error(ex);\n\t\t}\n\n\t\t// TODO@joyceerhl Validate session data, check schema version\n\t\tif (content !== undefined && content !== null && ref !== undefined) {\n\t\t\tthis._lastReadResources.set(resource, { ref, content });\n\t\t\treturn { ref, content };\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tasync delete(resource: SyncResource, ref: string | null) {\n\t\tawait this.initialize('write', false);\n\t\tif (!this.initialized) {\n\t\t\tthrow new Error(`Unable to delete edit session with ref ${ref}.`);\n\t\t}\n\n\t\ttry {\n\t\t\tawait this.storeClient?.deleteResource(resource, ref);\n\t\t} catch (ex) {\n\t\t\tthis.logService.error(ex);\n\t\t}\n\t}\n\n\tasync list(resource: SyncResource): Promise<IResourceRefHandle[]> {\n\t\tawait this.initialize('read', false);\n\t\tif (!this.initialized) {\n\t\t\tthrow new Error(`Unable to list edit sessions.`);\n\t\t}\n\n\t\ttry {\n\t\t\treturn this.storeClient?.getAllResourceRefs(resource) ?? [];\n\t\t} catch (ex) {\n\t\t\tthis.logService.error(ex);\n\t\t}\n\n\t\treturn [];\n\t}\n\n\tpublic async initialize(reason: 'read' | 'write', silent: boolean = false) {\n\t\tif (this.initialized) {\n\t\t\treturn true;\n\t\t}\n\t\tthis.initialized = await this.doInitialize(reason, silent);\n\t\tthis.signedInContext.set(this.initialized);\n\t\tif (this.initialized) {\n\t\t\tthis._didSignIn.fire();\n\t\t}\n\t\treturn this.initialized;\n\n\t}\n\n\t/**\n\t *\n\t * Ensures that the store client is initialized,\n\t * meaning that authentication is configured and it\n\t * can be used to communicate with the remote storage service\n\t */\n\tprivate async doInitialize(reason: 'read' | 'write', silent: boolean): Promise<boolean> {\n\t\t// Wait for authentication extensions to be registered\n\t\tawait this.extensionService.whenInstalledExtensionsRegistered();\n\n\t\tif (!this.serverConfiguration?.url) {\n\t\t\tthrow new Error('Unable to initialize sessions sync as session sync preference is not configured in product.json.');\n\t\t}\n\n\t\tif (this.storeClient === undefined) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._register(this.storeClient.onTokenFailed(() => {\n\t\t\tthis.logService.info('Clearing edit sessions authentication preference because of successive token failures.');\n\t\t\tthis.clearAuthenticationPreference();\n\t\t}));\n\n\t\tif (this.machineClient === undefined) {\n\t\t\tthis.machineClient = new UserDataSyncMachinesService(this.environmentService, this.fileService, this.storageService, this.storeClient, this.logService, this.productService);\n\t\t}\n\n\t\t// If we already have an existing auth session in memory, use that\n\t\tif (this.authenticationInfo !== undefined) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst authenticationSession = await this.getAuthenticationSession(reason, silent);\n\t\tif (authenticationSession !== undefined) {\n\t\t\tthis.authenticationInfo = authenticationSession;\n\t\t\tthis.storeClient.setAuthToken(authenticationSession.token, authenticationSession.providerId);\n\t\t}\n\n\t\treturn authenticationSession !== undefined;\n\t}\n\n\tprivate cachedMachines: Map<string, string> | undefined;\n\n\tasync getMachineById(machineId: string) {\n\t\tawait this.initialize('read', false);\n\n\t\tif (!this.cachedMachines) {\n\t\t\tconst machines = await this.machineClient!.getMachines();\n\t\t\tthis.cachedMachines = machines.reduce((map, machine) => map.set(machine.id, machine.name), new Map<string, string>());\n\t\t}\n\n\t\treturn this.cachedMachines.get(machineId);\n\t}\n\n\tprivate async getOrCreateCurrentMachineId(): Promise<string> {\n\t\tconst currentMachineId = await this.machineClient!.getMachines().then((machines) => machines.find((m) => m.isCurrent)?.id);\n\n\t\tif (currentMachineId === undefined) {\n\t\t\tawait this.machineClient!.addCurrentMachine();\n\t\t\treturn await this.machineClient!.getMachines().then((machines) => machines.find((m) => m.isCurrent)!.id);\n\t\t}\n\n\t\treturn currentMachineId;\n\t}\n\n\tprivate async getAuthenticationSession(reason: 'read' | 'write', silent: boolean) {\n\t\t// If the user signed in previously and the session is still available, reuse that without prompting the user again\n\t\tif (this.existingSessionId) {\n\t\t\tthis.logService.info(`Searching for existing authentication session with ID ${this.existingSessionId}`);\n\t\t\tconst existingSession = await this.getExistingSession();\n\t\t\tif (existingSession) {\n\t\t\t\tthis.logService.info(`Found existing authentication session with ID ${existingSession.session.id}`);\n\t\t\t\treturn { sessionId: existingSession.session.id, token: existingSession.session.idToken ?? existingSession.session.accessToken, providerId: existingSession.session.providerId };\n\t\t\t} else {\n\t\t\t\tthis._didSignOut.fire();\n\t\t\t}\n\t\t}\n\n\t\t// If settings sync is already enabled, avoid asking again to authenticate\n\t\tif (this.shouldAttemptEditSessionInit()) {\n\t\t\tthis.logService.info(`Reusing user data sync enablement`);\n\t\t\tconst authenticationSessionInfo = await getCurrentAuthenticationSessionInfo(this.secretStorageService, this.productService);\n\t\t\tif (authenticationSessionInfo !== undefined) {\n\t\t\t\tthis.logService.info(`Using current authentication session with ID ${authenticationSessionInfo.id}`);\n\t\t\t\tthis.existingSessionId = authenticationSessionInfo.id;\n\t\t\t\treturn { sessionId: authenticationSessionInfo.id, token: authenticationSessionInfo.accessToken, providerId: authenticationSessionInfo.providerId };\n\t\t\t}\n\t\t}\n\n\t\t// If we aren't supposed to prompt the user because\n\t\t// we're in a silent flow, just return here\n\t\tif (silent) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Ask the user to pick a preferred account\n\t\tconst authenticationSession = await this.getAccountPreference(reason);\n\t\tif (authenticationSession !== undefined) {\n\t\t\tthis.existingSessionId = authenticationSession.id;\n\t\t\treturn { sessionId: authenticationSession.id, token: authenticationSession.idToken ?? authenticationSession.accessToken, providerId: authenticationSession.providerId };\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate shouldAttemptEditSessionInit(): boolean {\n\t\treturn isWeb && this.storageService.isNew(StorageScope.APPLICATION) && this.storageService.isNew(StorageScope.WORKSPACE);\n\t}\n\n\t/**\n\t *\n\t * Prompts the user to pick an authentication option for storing and getting edit sessions.\n\t */\n\tprivate async getAccountPreference(reason: 'read' | 'write'): Promise<AuthenticationSession & { providerId: string } | undefined> {\n\t\tconst disposables = new DisposableStore();\n\t\tconst quickpick = disposables.add(this.quickInputService.createQuickPick<ExistingSession | AuthenticationProviderOption | IQuickPickItem>({ useSeparators: true }));\n\t\tquickpick.ok = false;\n\t\tquickpick.placeholder = reason === 'read' ? localize('choose account read placeholder', \"Select an account to restore your working changes from the cloud\") : localize('choose account placeholder', \"Select an account to store your working changes in the cloud\");\n\t\tquickpick.ignoreFocusOut = true;\n\t\tquickpick.items = await this.createQuickpickItems();\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tdisposables.add(quickpick.onDidHide((e) => {\n\t\t\t\treject(new CancellationError());\n\t\t\t\tdisposables.dispose();\n\t\t\t}));\n\n\t\t\tdisposables.add(quickpick.onDidAccept(async (e) => {\n\t\t\t\tconst selection = quickpick.selectedItems[0];\n\t\t\t\tconst session = 'provider' in selection ? { ...await this.authenticationService.createSession(selection.provider.id, selection.provider.scopes), providerId: selection.provider.id } : ('session' in selection ? selection.session : undefined);\n\t\t\t\tresolve(session);\n\t\t\t\tquickpick.hide();\n\t\t\t}));\n\n\t\t\tquickpick.show();\n\t\t});\n\t}\n\n\tprivate async createQuickpickItems(): Promise<(ExistingSession | AuthenticationProviderOption | IQuickPickSeparator | IQuickPickItem & { canceledAuthentication: boolean })[]> {\n\t\tconst options: (ExistingSession | AuthenticationProviderOption | IQuickPickSeparator | IQuickPickItem & { canceledAuthentication: boolean })[] = [];\n\n\t\toptions.push({ type: 'separator', label: localize('signed in', \"Signed In\") });\n\n\t\tconst sessions = await this.getAllSessions();\n\t\toptions.push(...sessions);\n\n\t\toptions.push({ type: 'separator', label: localize('others', \"Others\") });\n\n\t\tfor (const authenticationProvider of (await this.getAuthenticationProviders())) {\n\t\t\tconst signedInForProvider = sessions.some(account => account.session.providerId === authenticationProvider.id);\n\t\t\tif (!signedInForProvider || this.authenticationService.getProvider(authenticationProvider.id).supportsMultipleAccounts) {\n\t\t\t\tconst providerName = this.authenticationService.getProvider(authenticationProvider.id).label;\n\t\t\t\toptions.push({ label: localize('sign in using account', \"Sign in with {0}\", providerName), provider: authenticationProvider });\n\t\t\t}\n\t\t}\n\n\t\treturn options;\n\t}\n\n\t/**\n\t *\n\t * Returns all authentication sessions available from {@link getAuthenticationProviders}.\n\t */\n\tprivate async getAllSessions() {\n\t\tconst authenticationProviders = await this.getAuthenticationProviders();\n\t\tconst accounts = new Map<string, ExistingSession>();\n\t\tlet currentSession: ExistingSession | undefined;\n\n\t\tfor (const provider of authenticationProviders) {\n\t\t\tconst sessions = await this.authenticationService.getSessions(provider.id, provider.scopes);\n\n\t\t\tfor (const session of sessions) {\n\t\t\t\tconst item = {\n\t\t\t\t\tlabel: session.account.label,\n\t\t\t\t\tdescription: this.authenticationService.getProvider(provider.id).label,\n\t\t\t\t\tsession: { ...session, providerId: provider.id }\n\t\t\t\t};\n\t\t\t\taccounts.set(item.session.account.id, item);\n\t\t\t\tif (this.existingSessionId === session.id) {\n\t\t\t\t\tcurrentSession = item;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (currentSession !== undefined) {\n\t\t\taccounts.set(currentSession.session.account.id, currentSession);\n\t\t}\n\n\t\treturn [...accounts.values()].sort((a, b) => a.label.localeCompare(b.label));\n\t}\n\n\t/**\n\t *\n\t * Returns all authentication providers which can be used to authenticate\n\t * to the remote storage service, based on product.json configuration\n\t * and registered authentication providers.\n\t */\n\tprivate async getAuthenticationProviders() {\n\t\tif (!this.serverConfiguration) {\n\t\t\tthrow new Error('Unable to get configured authentication providers as session sync preference is not configured in product.json.');\n\t\t}\n\n\t\t// Get the list of authentication providers configured in product.json\n\t\tconst authenticationProviders = this.serverConfiguration.authenticationProviders;\n\t\tconst configuredAuthenticationProviders = Object.keys(authenticationProviders).reduce<IAuthenticationProvider[]>((result, id) => {\n\t\t\tresult.push({ id, scopes: authenticationProviders[id].scopes });\n\t\t\treturn result;\n\t\t}, []);\n\n\t\t// Filter out anything that isn't currently available through the authenticationService\n\t\tconst availableAuthenticationProviders = this.authenticationService.declaredProviders;\n\n\t\treturn configuredAuthenticationProviders.filter(({ id }) => availableAuthenticationProviders.some(provider => provider.id === id));\n\t}\n\n\tprivate get existingSessionId() {\n\t\treturn this.storageService.get(EditSessionsWorkbenchService.CACHED_SESSION_STORAGE_KEY, StorageScope.APPLICATION);\n\t}\n\n\tprivate set existingSessionId(sessionId: string | undefined) {\n\t\tthis.logService.trace(`Saving authentication session preference for ID ${sessionId}.`);\n\t\tif (sessionId === undefined) {\n\t\t\tthis.storageService.remove(EditSessionsWorkbenchService.CACHED_SESSION_STORAGE_KEY, StorageScope.APPLICATION);\n\t\t} else {\n\t\t\tthis.storageService.store(EditSessionsWorkbenchService.CACHED_SESSION_STORAGE_KEY, sessionId, StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\t}\n\t}\n\n\tprivate async getExistingSession() {\n\t\tconst accounts = await this.getAllSessions();\n\t\treturn accounts.find((account) => account.session.id === this.existingSessionId);\n\t}\n\n\tprivate async onDidChangeStorage(): Promise<void> {\n\t\tconst newSessionId = this.existingSessionId;\n\t\tconst previousSessionId = this.authenticationInfo?.sessionId;\n\n\t\tif (previousSessionId !== newSessionId) {\n\t\t\tthis.logService.trace(`Resetting authentication state because authentication session ID preference changed from ${previousSessionId} to ${newSessionId}.`);\n\t\t\tthis.authenticationInfo = undefined;\n\t\t\tthis.initialized = false;\n\t\t}\n\t}\n\n\tprivate clearAuthenticationPreference(): void {\n\t\tthis.authenticationInfo = undefined;\n\t\tthis.initialized = false;\n\t\tthis.existingSessionId = undefined;\n\t\tthis.signedInContext.set(false);\n\t}\n\n\tprivate onDidChangeSessions(e: AuthenticationSessionsChangeEvent): void {\n\t\tif (this.authenticationInfo?.sessionId && e.removed?.find(session => session.id === this.authenticationInfo?.sessionId)) {\n\t\t\tthis.clearAuthenticationPreference();\n\t\t}\n\t}\n\n\tprivate registerSignInAction() {\n\t\tif (!this.serverConfiguration?.url) {\n\t\t\treturn;\n\t\t}\n\t\tconst that = this;\n\t\tconst id = 'workbench.editSessions.actions.signIn';\n\t\tconst when = ContextKeyExpr.and(ContextKeyExpr.equals(EDIT_SESSIONS_PENDING_KEY, false), ContextKeyExpr.equals(EDIT_SESSIONS_SIGNED_IN_KEY, false));\n\t\tthis._register(registerAction2(class ResetEditSessionAuthenticationAction extends Action2 {\n\t\t\tconstructor() {\n\t\t\t\tsuper({\n\t\t\t\t\tid,\n\t\t\t\t\ttitle: localize('sign in', 'Turn on Cloud Changes...'),\n\t\t\t\t\tcategory: EDIT_SESSION_SYNC_CATEGORY,\n\t\t\t\t\tprecondition: when,\n\t\t\t\t\tmenu: [{\n\t\t\t\t\t\tid: MenuId.CommandPalette,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tid: MenuId.AccountsContext,\n\t\t\t\t\t\tgroup: '2_editSessions',\n\t\t\t\t\t\twhen,\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tasync run() {\n\t\t\t\treturn await that.initialize('write', false);\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(MenuRegistry.appendMenuItem(MenuId.AccountsContext, {\n\t\t\tgroup: '2_editSessions',\n\t\t\tcommand: {\n\t\t\t\tid,\n\t\t\t\ttitle: localize('sign in badge', 'Turn on Cloud Changes... (1)'),\n\t\t\t},\n\t\t\twhen: ContextKeyExpr.and(ContextKeyExpr.equals(EDIT_SESSIONS_PENDING_KEY, true), ContextKeyExpr.equals(EDIT_SESSIONS_SIGNED_IN_KEY, false))\n\t\t}));\n\t}\n\n\tprivate registerResetAuthenticationAction() {\n\t\tconst that = this;\n\t\tthis._register(registerAction2(class ResetEditSessionAuthenticationAction extends Action2 {\n\t\t\tconstructor() {\n\t\t\t\tsuper({\n\t\t\t\t\tid: 'workbench.editSessions.actions.resetAuth',\n\t\t\t\t\ttitle: localize('reset auth.v3', 'Turn off Cloud Changes...'),\n\t\t\t\t\tcategory: EDIT_SESSION_SYNC_CATEGORY,\n\t\t\t\t\tprecondition: ContextKeyExpr.equals(EDIT_SESSIONS_SIGNED_IN_KEY, true),\n\t\t\t\t\tmenu: [{\n\t\t\t\t\t\tid: MenuId.CommandPalette,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tid: MenuId.AccountsContext,\n\t\t\t\t\t\tgroup: '2_editSessions',\n\t\t\t\t\t\twhen: ContextKeyExpr.equals(EDIT_SESSIONS_SIGNED_IN_KEY, true),\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tasync run() {\n\t\t\t\tconst result = await that.dialogService.confirm({\n\t\t\t\t\tmessage: localize('sign out of cloud changes clear data prompt', 'Do you want to disable storing working changes in the cloud?'),\n\t\t\t\t\tcheckbox: { label: localize('delete all cloud changes', 'Delete all stored data from the cloud.') }\n\t\t\t\t});\n\t\t\t\tif (result.confirmed) {\n\t\t\t\t\tif (result.checkboxChecked) {\n\t\t\t\t\t\tthat.storeClient?.deleteResource('editSessions', null);\n\t\t\t\t\t}\n\t\t\t\t\tthat.clearAuthenticationPreference();\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n}\n"]}