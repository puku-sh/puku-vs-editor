{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/logs/common/defaultLogLevels.ts","vs/workbench/contrib/logs/common/defaultLogLevels.ts"],"names":[],"mappings":"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","file":"defaultLogLevels.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ILogService, ILoggerService, LogLevel, LogLevelToString, getLogLevel, parseLogLevel } from '../../../../platform/log/common/log.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IWorkbenchEnvironmentService } from '../../../services/environment/common/environmentService.js';\nimport { FileOperationResult, IFileService, toFileOperationResult } from '../../../../platform/files/common/files.js';\nimport { IJSONEditingService } from '../../../services/configuration/common/jsonEditing.js';\nimport { isString, isUndefined } from '../../../../base/common/types.js';\nimport { EXTENSION_IDENTIFIER_WITH_LOG_REGEX } from '../../../../platform/environment/common/environmentService.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { parse } from '../../../../base/common/json.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\n\ninterface ParsedArgvLogLevels {\n\tdefault?: LogLevel;\n\textensions?: [string, LogLevel][];\n}\n\nexport type DefaultLogLevels = Required<Readonly<ParsedArgvLogLevels>>;\n\nexport const IDefaultLogLevelsService = createDecorator<IDefaultLogLevelsService>('IDefaultLogLevelsService');\n\nexport interface IDefaultLogLevelsService {\n\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * An event which fires when default log levels are changed\n\t */\n\treadonly onDidChangeDefaultLogLevels: Event<void>;\n\n\tgetDefaultLogLevels(): Promise<DefaultLogLevels>;\n\n\tgetDefaultLogLevel(extensionId?: string): Promise<LogLevel>;\n\n\tsetDefaultLogLevel(logLevel: LogLevel, extensionId?: string): Promise<void>;\n}\n\nclass DefaultLogLevelsService extends Disposable implements IDefaultLogLevelsService {\n\n\t_serviceBrand: undefined;\n\n\tprivate _onDidChangeDefaultLogLevels = this._register(new Emitter<void>);\n\treadonly onDidChangeDefaultLogLevels = this._onDidChangeDefaultLogLevels.event;\n\n\tconstructor(\n\t\t@IWorkbenchEnvironmentService private readonly environmentService: IWorkbenchEnvironmentService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IJSONEditingService private readonly jsonEditingService: IJSONEditingService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@ILoggerService private readonly loggerService: ILoggerService,\n\t) {\n\t\tsuper();\n\t}\n\n\tasync getDefaultLogLevels(): Promise<DefaultLogLevels> {\n\t\tconst argvLogLevel = await this._parseLogLevelsFromArgv();\n\t\treturn {\n\t\t\tdefault: argvLogLevel?.default ?? this._getDefaultLogLevelFromEnv(),\n\t\t\textensions: argvLogLevel?.extensions ?? this._getExtensionsDefaultLogLevelsFromEnv()\n\t\t};\n\t}\n\n\tasync getDefaultLogLevel(extensionId?: string): Promise<LogLevel> {\n\t\tconst argvLogLevel = await this._parseLogLevelsFromArgv() ?? {};\n\t\tif (extensionId) {\n\t\t\textensionId = extensionId.toLowerCase();\n\t\t\treturn this._getDefaultLogLevel(argvLogLevel, extensionId);\n\t\t} else {\n\t\t\treturn this._getDefaultLogLevel(argvLogLevel);\n\t\t}\n\t}\n\n\tasync setDefaultLogLevel(defaultLogLevel: LogLevel, extensionId?: string): Promise<void> {\n\t\tconst argvLogLevel = await this._parseLogLevelsFromArgv() ?? {};\n\t\tif (extensionId) {\n\t\t\textensionId = extensionId.toLowerCase();\n\t\t\tconst currentDefaultLogLevel = this._getDefaultLogLevel(argvLogLevel, extensionId);\n\t\t\targvLogLevel.extensions = argvLogLevel.extensions ?? [];\n\t\t\tconst extension = argvLogLevel.extensions.find(([extension]) => extension === extensionId);\n\t\t\tif (extension) {\n\t\t\t\textension[1] = defaultLogLevel;\n\t\t\t} else {\n\t\t\t\targvLogLevel.extensions.push([extensionId, defaultLogLevel]);\n\t\t\t}\n\t\t\tawait this._writeLogLevelsToArgv(argvLogLevel);\n\t\t\tconst extensionLoggers = [...this.loggerService.getRegisteredLoggers()].filter(logger => logger.extensionId && logger.extensionId.toLowerCase() === extensionId);\n\t\t\tfor (const { resource } of extensionLoggers) {\n\t\t\t\tif (this.loggerService.getLogLevel(resource) === currentDefaultLogLevel) {\n\t\t\t\t\tthis.loggerService.setLogLevel(resource, defaultLogLevel);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tconst currentLogLevel = this._getDefaultLogLevel(argvLogLevel);\n\t\t\targvLogLevel.default = defaultLogLevel;\n\t\t\tawait this._writeLogLevelsToArgv(argvLogLevel);\n\t\t\tif (this.loggerService.getLogLevel() === currentLogLevel) {\n\t\t\t\tthis.loggerService.setLogLevel(defaultLogLevel);\n\t\t\t}\n\t\t}\n\t\tthis._onDidChangeDefaultLogLevels.fire();\n\t}\n\n\tprivate _getDefaultLogLevel(argvLogLevels: ParsedArgvLogLevels, extension?: string): LogLevel {\n\t\tif (extension) {\n\t\t\tconst extensionLogLevel = argvLogLevels.extensions?.find(([extensionId]) => extensionId === extension);\n\t\t\tif (extensionLogLevel) {\n\t\t\t\treturn extensionLogLevel[1];\n\t\t\t}\n\t\t}\n\t\treturn argvLogLevels.default ?? getLogLevel(this.environmentService);\n\t}\n\n\tprivate async _writeLogLevelsToArgv(logLevels: ParsedArgvLogLevels): Promise<void> {\n\t\tconst logLevelsValue: string[] = [];\n\t\tif (!isUndefined(logLevels.default)) {\n\t\t\tlogLevelsValue.push(LogLevelToString(logLevels.default));\n\t\t}\n\t\tfor (const [extension, logLevel] of logLevels.extensions ?? []) {\n\t\t\tlogLevelsValue.push(`${extension}=${LogLevelToString(logLevel)}`);\n\t\t}\n\t\tawait this.jsonEditingService.write(this.environmentService.argvResource, [{ path: ['log-level'], value: logLevelsValue.length ? logLevelsValue : undefined }], true);\n\t}\n\n\tprivate async _parseLogLevelsFromArgv(): Promise<ParsedArgvLogLevels | undefined> {\n\t\tconst result: ParsedArgvLogLevels = { extensions: [] };\n\t\tconst logLevels = await this._readLogLevelsFromArgv();\n\t\tfor (const extensionLogLevel of logLevels) {\n\t\t\tconst matches = EXTENSION_IDENTIFIER_WITH_LOG_REGEX.exec(extensionLogLevel);\n\t\t\tif (matches && matches[1] && matches[2]) {\n\t\t\t\tconst logLevel = parseLogLevel(matches[2]);\n\t\t\t\tif (!isUndefined(logLevel)) {\n\t\t\t\t\tresult.extensions?.push([matches[1].toLowerCase(), logLevel]);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst logLevel = parseLogLevel(extensionLogLevel);\n\t\t\t\tif (!isUndefined(logLevel)) {\n\t\t\t\t\tresult.default = logLevel;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn !isUndefined(result.default) || result.extensions?.length ? result : undefined;\n\t}\n\n\tprivate async _readLogLevelsFromArgv(): Promise<string[]> {\n\t\ttry {\n\t\t\tconst content = await this.fileService.readFile(this.environmentService.argvResource);\n\t\t\tconst argv: { 'log-level'?: string | string[] } = parse(content.value.toString());\n\t\t\treturn isString(argv['log-level']) ? [argv['log-level']] : Array.isArray(argv['log-level']) ? argv['log-level'] : [];\n\t\t} catch (error) {\n\t\t\tif (toFileOperationResult(error) !== FileOperationResult.FILE_NOT_FOUND) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t}\n\t\t}\n\t\treturn [];\n\t}\n\n\tprivate _getDefaultLogLevelFromEnv(): LogLevel {\n\t\treturn getLogLevel(this.environmentService);\n\t}\n\n\tprivate _getExtensionsDefaultLogLevelsFromEnv(): [string, LogLevel][] {\n\t\tconst result: [string, LogLevel][] = [];\n\t\tfor (const [extension, logLevelValue] of this.environmentService.extensionLogLevel ?? []) {\n\t\t\tconst logLevel = parseLogLevel(logLevelValue);\n\t\t\tif (!isUndefined(logLevel)) {\n\t\t\t\tresult.push([extension, logLevel]);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n}\n\nregisterSingleton(IDefaultLogLevelsService, DefaultLogLevelsService, InstantiationType.Delayed);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ILogService, ILoggerService, LogLevel, LogLevelToString, getLogLevel, parseLogLevel } from '../../../../platform/log/common/log.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IWorkbenchEnvironmentService } from '../../../services/environment/common/environmentService.js';\nimport { FileOperationResult, IFileService, toFileOperationResult } from '../../../../platform/files/common/files.js';\nimport { IJSONEditingService } from '../../../services/configuration/common/jsonEditing.js';\nimport { isString, isUndefined } from '../../../../base/common/types.js';\nimport { EXTENSION_IDENTIFIER_WITH_LOG_REGEX } from '../../../../platform/environment/common/environmentService.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { parse } from '../../../../base/common/json.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\n\ninterface ParsedArgvLogLevels {\n\tdefault?: LogLevel;\n\textensions?: [string, LogLevel][];\n}\n\nexport type DefaultLogLevels = Required<Readonly<ParsedArgvLogLevels>>;\n\nexport const IDefaultLogLevelsService = createDecorator<IDefaultLogLevelsService>('IDefaultLogLevelsService');\n\nexport interface IDefaultLogLevelsService {\n\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * An event which fires when default log levels are changed\n\t */\n\treadonly onDidChangeDefaultLogLevels: Event<void>;\n\n\tgetDefaultLogLevels(): Promise<DefaultLogLevels>;\n\n\tgetDefaultLogLevel(extensionId?: string): Promise<LogLevel>;\n\n\tsetDefaultLogLevel(logLevel: LogLevel, extensionId?: string): Promise<void>;\n}\n\nclass DefaultLogLevelsService extends Disposable implements IDefaultLogLevelsService {\n\n\t_serviceBrand: undefined;\n\n\tprivate _onDidChangeDefaultLogLevels = this._register(new Emitter<void>);\n\treadonly onDidChangeDefaultLogLevels = this._onDidChangeDefaultLogLevels.event;\n\n\tconstructor(\n\t\t@IWorkbenchEnvironmentService private readonly environmentService: IWorkbenchEnvironmentService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IJSONEditingService private readonly jsonEditingService: IJSONEditingService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@ILoggerService private readonly loggerService: ILoggerService,\n\t) {\n\t\tsuper();\n\t}\n\n\tasync getDefaultLogLevels(): Promise<DefaultLogLevels> {\n\t\tconst argvLogLevel = await this._parseLogLevelsFromArgv();\n\t\treturn {\n\t\t\tdefault: argvLogLevel?.default ?? this._getDefaultLogLevelFromEnv(),\n\t\t\textensions: argvLogLevel?.extensions ?? this._getExtensionsDefaultLogLevelsFromEnv()\n\t\t};\n\t}\n\n\tasync getDefaultLogLevel(extensionId?: string): Promise<LogLevel> {\n\t\tconst argvLogLevel = await this._parseLogLevelsFromArgv() ?? {};\n\t\tif (extensionId) {\n\t\t\textensionId = extensionId.toLowerCase();\n\t\t\treturn this._getDefaultLogLevel(argvLogLevel, extensionId);\n\t\t} else {\n\t\t\treturn this._getDefaultLogLevel(argvLogLevel);\n\t\t}\n\t}\n\n\tasync setDefaultLogLevel(defaultLogLevel: LogLevel, extensionId?: string): Promise<void> {\n\t\tconst argvLogLevel = await this._parseLogLevelsFromArgv() ?? {};\n\t\tif (extensionId) {\n\t\t\textensionId = extensionId.toLowerCase();\n\t\t\tconst currentDefaultLogLevel = this._getDefaultLogLevel(argvLogLevel, extensionId);\n\t\t\targvLogLevel.extensions = argvLogLevel.extensions ?? [];\n\t\t\tconst extension = argvLogLevel.extensions.find(([extension]) => extension === extensionId);\n\t\t\tif (extension) {\n\t\t\t\textension[1] = defaultLogLevel;\n\t\t\t} else {\n\t\t\t\targvLogLevel.extensions.push([extensionId, defaultLogLevel]);\n\t\t\t}\n\t\t\tawait this._writeLogLevelsToArgv(argvLogLevel);\n\t\t\tconst extensionLoggers = [...this.loggerService.getRegisteredLoggers()].filter(logger => logger.extensionId && logger.extensionId.toLowerCase() === extensionId);\n\t\t\tfor (const { resource } of extensionLoggers) {\n\t\t\t\tif (this.loggerService.getLogLevel(resource) === currentDefaultLogLevel) {\n\t\t\t\t\tthis.loggerService.setLogLevel(resource, defaultLogLevel);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tconst currentLogLevel = this._getDefaultLogLevel(argvLogLevel);\n\t\t\targvLogLevel.default = defaultLogLevel;\n\t\t\tawait this._writeLogLevelsToArgv(argvLogLevel);\n\t\t\tif (this.loggerService.getLogLevel() === currentLogLevel) {\n\t\t\t\tthis.loggerService.setLogLevel(defaultLogLevel);\n\t\t\t}\n\t\t}\n\t\tthis._onDidChangeDefaultLogLevels.fire();\n\t}\n\n\tprivate _getDefaultLogLevel(argvLogLevels: ParsedArgvLogLevels, extension?: string): LogLevel {\n\t\tif (extension) {\n\t\t\tconst extensionLogLevel = argvLogLevels.extensions?.find(([extensionId]) => extensionId === extension);\n\t\t\tif (extensionLogLevel) {\n\t\t\t\treturn extensionLogLevel[1];\n\t\t\t}\n\t\t}\n\t\treturn argvLogLevels.default ?? getLogLevel(this.environmentService);\n\t}\n\n\tprivate async _writeLogLevelsToArgv(logLevels: ParsedArgvLogLevels): Promise<void> {\n\t\tconst logLevelsValue: string[] = [];\n\t\tif (!isUndefined(logLevels.default)) {\n\t\t\tlogLevelsValue.push(LogLevelToString(logLevels.default));\n\t\t}\n\t\tfor (const [extension, logLevel] of logLevels.extensions ?? []) {\n\t\t\tlogLevelsValue.push(`${extension}=${LogLevelToString(logLevel)}`);\n\t\t}\n\t\tawait this.jsonEditingService.write(this.environmentService.argvResource, [{ path: ['log-level'], value: logLevelsValue.length ? logLevelsValue : undefined }], true);\n\t}\n\n\tprivate async _parseLogLevelsFromArgv(): Promise<ParsedArgvLogLevels | undefined> {\n\t\tconst result: ParsedArgvLogLevels = { extensions: [] };\n\t\tconst logLevels = await this._readLogLevelsFromArgv();\n\t\tfor (const extensionLogLevel of logLevels) {\n\t\t\tconst matches = EXTENSION_IDENTIFIER_WITH_LOG_REGEX.exec(extensionLogLevel);\n\t\t\tif (matches && matches[1] && matches[2]) {\n\t\t\t\tconst logLevel = parseLogLevel(matches[2]);\n\t\t\t\tif (!isUndefined(logLevel)) {\n\t\t\t\t\tresult.extensions?.push([matches[1].toLowerCase(), logLevel]);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconst logLevel = parseLogLevel(extensionLogLevel);\n\t\t\t\tif (!isUndefined(logLevel)) {\n\t\t\t\t\tresult.default = logLevel;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn !isUndefined(result.default) || result.extensions?.length ? result : undefined;\n\t}\n\n\tprivate async _readLogLevelsFromArgv(): Promise<string[]> {\n\t\ttry {\n\t\t\tconst content = await this.fileService.readFile(this.environmentService.argvResource);\n\t\t\tconst argv: { 'log-level'?: string | string[] } = parse(content.value.toString());\n\t\t\treturn isString(argv['log-level']) ? [argv['log-level']] : Array.isArray(argv['log-level']) ? argv['log-level'] : [];\n\t\t} catch (error) {\n\t\t\tif (toFileOperationResult(error) !== FileOperationResult.FILE_NOT_FOUND) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t}\n\t\t}\n\t\treturn [];\n\t}\n\n\tprivate _getDefaultLogLevelFromEnv(): LogLevel {\n\t\treturn getLogLevel(this.environmentService);\n\t}\n\n\tprivate _getExtensionsDefaultLogLevelsFromEnv(): [string, LogLevel][] {\n\t\tconst result: [string, LogLevel][] = [];\n\t\tfor (const [extension, logLevelValue] of this.environmentService.extensionLogLevel ?? []) {\n\t\t\tconst logLevel = parseLogLevel(logLevelValue);\n\t\t\tif (!isUndefined(logLevel)) {\n\t\t\t\tresult.push([extension, logLevel]);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n}\n\nregisterSingleton(IDefaultLogLevelsService, DefaultLogLevelsService, InstantiationType.Delayed);\n"]}