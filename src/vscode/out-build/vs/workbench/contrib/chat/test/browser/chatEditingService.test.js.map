{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/test/browser/chatEditingService.test.ts","vs/workbench/contrib/chat/test/browser/chatEditingService.test.ts"],"names":[],"mappings":"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","file":"chatEditingService.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { waitForState } from '../../../../../base/common/observable.js';\nimport { isEqual } from '../../../../../base/common/resources.js';\nimport { assertType } from '../../../../../base/common/types.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { assertThrowsAsync, ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { EditOperation } from '../../../../../editor/common/core/editOperation.js';\nimport { Position } from '../../../../../editor/common/core/position.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { TextEdit } from '../../../../../editor/common/languages.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { IModelService } from '../../../../../editor/common/services/model.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { SyncDescriptor } from '../../../../../platform/instantiation/common/descriptors.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { IWorkbenchAssignmentService } from '../../../../services/assignment/common/assignmentService.js';\nimport { NullWorkbenchAssignmentService } from '../../../../services/assignment/test/common/nullAssignmentService.js';\nimport { nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { workbenchInstantiationService } from '../../../../test/browser/workbenchTestServices.js';\nimport { TestWorkerService } from '../../../inlineChat/test/browser/testWorkerService.js';\nimport { IMcpService } from '../../../mcp/common/mcpTypes.js';\nimport { TestMcpService } from '../../../mcp/test/common/testMcpService.js';\nimport { IMultiDiffSourceResolver, IMultiDiffSourceResolverService } from '../../../multiDiffEditor/browser/multiDiffSourceResolverService.js';\nimport { NotebookTextModel } from '../../../notebook/common/model/notebookTextModel.js';\nimport { INotebookService } from '../../../notebook/common/notebookService.js';\nimport { ChatEditingService } from '../../browser/chatEditing/chatEditingServiceImpl.js';\nimport { ChatSessionsService } from '../../browser/chatSessions.contribution.js';\nimport { ChatAgentService, IChatAgentData, IChatAgentImplementation, IChatAgentService } from '../../common/chatAgents.js';\nimport { ChatEditingSessionState, IChatEditingService, IChatEditingSession, ModifiedFileEntryState } from '../../common/chatEditingService.js';\nimport { ChatModel } from '../../common/chatModel.js';\nimport { IChatService } from '../../common/chatService.js';\nimport { ChatService } from '../../common/chatServiceImpl.js';\nimport { IChatSessionsService } from '../../common/chatSessionsService.js';\nimport { IChatSlashCommandService } from '../../common/chatSlashCommands.js';\nimport { ChatTransferService, IChatTransferService } from '../../common/chatTransferService.js';\nimport { IChatVariablesService } from '../../common/chatVariables.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../common/constants.js';\nimport { ILanguageModelsService } from '../../common/languageModels.js';\nimport { NullLanguageModelsService } from '../common/languageModels.js';\nimport { MockChatVariablesService } from '../common/mockChatVariables.js';\nimport { runWithFakedTimers } from '../../../../../base/test/common/timeTravelScheduler.js';\n\nfunction getAgentData(id: string): IChatAgentData {\n\treturn {\n\t\tname: id,\n\t\tid: id,\n\t\textensionId: nullExtensionDescription.identifier,\n\t\textensionVersion: undefined,\n\t\textensionPublisherId: '',\n\t\tpublisherDisplayName: '',\n\t\textensionDisplayName: '',\n\t\tlocations: [ChatAgentLocation.Chat],\n\t\tmodes: [ChatModeKind.Ask],\n\t\tmetadata: {},\n\t\tslashCommands: [],\n\t\tdisambiguation: [],\n\t};\n}\n\nsuite('ChatEditingService', function () {\n\n\tconst store = new DisposableStore();\n\tlet editingService: ChatEditingService;\n\tlet chatService: IChatService;\n\tlet textModelService: ITextModelService;\n\n\tsetup(function () {\n\t\tconst collection = new ServiceCollection();\n\t\tcollection.set(IWorkbenchAssignmentService, new NullWorkbenchAssignmentService());\n\t\tcollection.set(IChatAgentService, new SyncDescriptor(ChatAgentService));\n\t\tcollection.set(IChatVariablesService, new MockChatVariablesService());\n\t\tcollection.set(IChatSlashCommandService, new class extends mock<IChatSlashCommandService>() { });\n\t\tcollection.set(IChatTransferService, new SyncDescriptor(ChatTransferService));\n\t\tcollection.set(IChatSessionsService, new SyncDescriptor(ChatSessionsService));\n\t\tcollection.set(IChatEditingService, new SyncDescriptor(ChatEditingService));\n\t\tcollection.set(IEditorWorkerService, new SyncDescriptor(TestWorkerService));\n\t\tcollection.set(IChatService, new SyncDescriptor(ChatService));\n\t\tcollection.set(IMcpService, new TestMcpService());\n\t\tcollection.set(ILanguageModelsService, new SyncDescriptor(NullLanguageModelsService));\n\t\tcollection.set(IMultiDiffSourceResolverService, new class extends mock<IMultiDiffSourceResolverService>() {\n\t\t\toverride registerResolver(_resolver: IMultiDiffSourceResolver): IDisposable {\n\t\t\t\treturn Disposable.None;\n\t\t\t}\n\t\t});\n\t\tcollection.set(INotebookService, new class extends mock<INotebookService>() {\n\t\t\toverride getNotebookTextModel(_uri: URI): NotebookTextModel | undefined {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\toverride hasSupportedNotebooks(_resource: URI): boolean {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t\tconst insta = store.add(store.add(workbenchInstantiationService(undefined, store)).createChild(collection));\n\t\tstore.add(insta.get(IEditorWorkerService) as TestWorkerService);\n\t\tconst value = insta.get(IChatEditingService);\n\t\tassert.ok(value instanceof ChatEditingService);\n\t\teditingService = value;\n\n\t\tchatService = insta.get(IChatService);\n\n\t\tstore.add(insta.get(IChatSessionsService) as ChatSessionsService); // Needs to be disposed in between test runs to clear extensionPoint contribution\n\n\t\tconst chatAgentService = insta.get(IChatAgentService);\n\n\t\tconst agent: IChatAgentImplementation = {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\treturn {};\n\t\t\t},\n\t\t};\n\t\tstore.add(chatAgentService.registerAgent('testAgent', { ...getAgentData('testAgent'), isDefault: true }));\n\t\tstore.add(chatAgentService.registerAgentImplementation('testAgent', agent));\n\n\t\ttextModelService = insta.get(ITextModelService);\n\n\t\tconst modelService = insta.get(IModelService);\n\n\t\tstore.add(textModelService.registerTextModelContentProvider('test', {\n\t\t\tasync provideTextContent(resource) {\n\t\t\t\treturn store.add(modelService.createModel(resource.path.repeat(10), null, resource, false));\n\t\t\t},\n\t\t}));\n\t});\n\n\tteardown(() => {\n\t\tstore.clear();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('create session', async function () {\n\t\tassert.ok(editingService);\n\n\t\tconst model = chatService.startSession(ChatAgentLocation.EditorInline, CancellationToken.None);\n\t\tconst session = editingService.createEditingSession(model, true);\n\n\t\tassert.strictEqual(session.chatSessionResource.toString(), model.sessionResource.toString());\n\t\tassert.strictEqual(session.isGlobalEditingSession, true);\n\n\t\tawait assertThrowsAsync(async () => {\n\t\t\t// DUPE not allowed\n\t\t\teditingService.createEditingSession(model);\n\t\t});\n\n\t\tsession.dispose();\n\t\tmodel.dispose();\n\t});\n\n\ttest('create session, file entry & isCurrentlyBeingModifiedBy', async function () {\n\t\tassert.ok(editingService);\n\n\t\tconst uri = URI.from({ scheme: 'test', path: 'HelloWorld' });\n\n\t\tconst model = chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None);\n\t\tconst session = model.editingSession;\n\t\tif (!session) {\n\t\t\tassert.fail('session not created');\n\t\t}\n\n\t\tconst chatRequest = model?.addRequest({ text: '', parts: [] }, { variables: [] }, 0);\n\t\tassertType(chatRequest.response);\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [], done: false });\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'FarBoo\\n' }], done: false });\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [], done: true });\n\n\t\tconst entry = await waitForState(session.entries.map(value => value.find(a => isEqual(a.modifiedURI, uri))));\n\n\t\tassert.ok(isEqual(entry.modifiedURI, uri));\n\n\t\tawait waitForState(entry.isCurrentlyBeingModifiedBy.map(value => value === chatRequest.response));\n\t\tassert.ok(entry.isCurrentlyBeingModifiedBy.get()?.responseModel === chatRequest.response);\n\n\t\tconst unset = waitForState(entry.isCurrentlyBeingModifiedBy.map(res => res === undefined));\n\n\t\tchatRequest.response.complete();\n\n\t\tawait unset;\n\n\t\tawait entry.reject();\n\n\t\tmodel.dispose();\n\t});\n\n\tasync function idleAfterEdit(session: IChatEditingSession, model: ChatModel, uri: URI, edits: TextEdit[]) {\n\t\tconst isStreaming = waitForState(session.state.map(s => s === ChatEditingSessionState.StreamingEdits), Boolean);\n\n\t\tconst chatRequest = model.addRequest({ text: '', parts: [] }, { variables: [] }, 0);\n\t\tassertType(chatRequest.response);\n\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits, done: true });\n\n\t\tconst entry = await waitForState(session.entries.map(value => value.find(a => isEqual(a.modifiedURI, uri))));\n\n\t\tassert.ok(isEqual(entry.modifiedURI, uri));\n\n\t\tchatRequest.response.complete();\n\n\t\tawait isStreaming;\n\n\t\tconst isIdle = waitForState(session.state.map(s => s === ChatEditingSessionState.Idle), Boolean);\n\t\tawait isIdle;\n\n\t\treturn entry;\n\t}\n\n\ttest('mirror typing outside -> accept', async function () {\n\t\treturn runWithFakedTimers({}, async () => {\n\t\t\tassert.ok(editingService);\n\n\t\t\tconst uri = URI.from({ scheme: 'test', path: 'abc\\n' });\n\n\t\t\tconst model = store.add(chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tconst session = model.editingSession;\n\t\t\tassertType(session, 'session not created');\n\n\t\t\tconst entry = await idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'FarBoo\\n' }]);\n\t\t\tconst original = store.add(await textModelService.createModelReference(entry.originalURI)).object.textEditorModel;\n\t\t\tconst modified = store.add(await textModelService.createModelReference(entry.modifiedURI)).object.textEditorModel;\n\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Modified);\n\n\t\t\tassert.strictEqual(original.getValue(), 'abc\\n'.repeat(10));\n\t\t\tassert.strictEqual(modified.getValue(), 'FarBoo\\n' + 'abc\\n'.repeat(10));\n\n\t\t\tmodified.pushEditOperations(null, [EditOperation.insert(new Position(3, 1), 'USER_TYPE\\n')], () => null);\n\n\t\t\tassert.ok(modified.getValue().includes('USER_TYPE'));\n\t\t\tassert.ok(original.getValue().includes('USER_TYPE'));\n\n\t\t\tawait entry.accept();\n\t\t\tassert.strictEqual(modified.getValue(), original.getValue());\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Accepted);\n\n\t\t\tassert.ok(modified.getValue().includes('FarBoo'));\n\t\t\tassert.ok(original.getValue().includes('FarBoo'));\n\t\t});\n\t});\n\n\ttest('mirror typing outside -> reject', async function () {\n\t\treturn runWithFakedTimers({}, async () => {\n\t\t\tassert.ok(editingService);\n\n\t\t\tconst uri = URI.from({ scheme: 'test', path: 'abc\\n' });\n\n\t\t\tconst model = store.add(chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tconst session = model.editingSession;\n\t\t\tassertType(session, 'session not created');\n\n\t\t\tconst entry = await idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'FarBoo\\n' }]);\n\t\t\tconst original = store.add(await textModelService.createModelReference(entry.originalURI)).object.textEditorModel;\n\t\t\tconst modified = store.add(await textModelService.createModelReference(entry.modifiedURI)).object.textEditorModel;\n\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Modified);\n\n\t\t\tassert.strictEqual(original.getValue(), 'abc\\n'.repeat(10));\n\t\t\tassert.strictEqual(modified.getValue(), 'FarBoo\\n' + 'abc\\n'.repeat(10));\n\n\t\t\tmodified.pushEditOperations(null, [EditOperation.insert(new Position(3, 1), 'USER_TYPE\\n')], () => null);\n\n\t\t\tassert.ok(modified.getValue().includes('USER_TYPE'));\n\t\t\tassert.ok(original.getValue().includes('USER_TYPE'));\n\n\t\t\tawait entry.reject();\n\t\t\tassert.strictEqual(modified.getValue(), original.getValue());\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Rejected);\n\n\t\t\tassert.ok(!modified.getValue().includes('FarBoo'));\n\t\t\tassert.ok(!original.getValue().includes('FarBoo'));\n\t\t});\n\t});\n\n\ttest('NO mirror typing inside -> accept', async function () {\n\t\treturn runWithFakedTimers({}, async () => {\n\t\t\tassert.ok(editingService);\n\n\t\t\tconst uri = URI.from({ scheme: 'test', path: 'abc\\n' });\n\n\t\t\tconst model = store.add(chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tconst session = model.editingSession;\n\t\t\tassertType(session, 'session not created');\n\n\t\t\tconst entry = await idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'FarBoo\\n' }]);\n\t\t\tconst original = store.add(await textModelService.createModelReference(entry.originalURI)).object.textEditorModel;\n\t\t\tconst modified = store.add(await textModelService.createModelReference(entry.modifiedURI)).object.textEditorModel;\n\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Modified);\n\n\t\t\tassert.strictEqual(original.getValue(), 'abc\\n'.repeat(10));\n\t\t\tassert.strictEqual(modified.getValue(), 'FarBoo\\n' + 'abc\\n'.repeat(10));\n\n\t\t\tmodified.pushEditOperations(null, [EditOperation.replace(new Range(1, 2, 1, 7), 'ooBar')], () => null);\n\n\t\t\tassert.ok(modified.getValue().includes('FooBar'));\n\t\t\tassert.ok(!original.getValue().includes('FooBar')); // typed in the AI edits, DO NOT transpose\n\n\t\t\tawait entry.accept();\n\t\t\tassert.strictEqual(modified.getValue(), original.getValue());\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Accepted);\n\n\t\t\tassert.ok(modified.getValue().includes('FooBar'));\n\t\t\tassert.ok(original.getValue().includes('FooBar'));\n\t\t});\n\t});\n\n\ttest('ChatEditingService merges text edits it shouldn\\'t merge, #272679', async function () {\n\t\treturn runWithFakedTimers({}, async () => {\n\t\t\tassert.ok(editingService);\n\n\t\t\tconst uri = URI.from({ scheme: 'test', path: 'abc' });\n\n\t\t\tconst modified = store.add(await textModelService.createModelReference(uri)).object.textEditorModel;\n\n\t\t\tconst model = store.add(chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tconst session = model.editingSession;\n\t\t\tassertType(session, 'session not created');\n\n\t\t\tmodified.setValue('');\n\t\t\tawait idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'a' }, { range: new Range(1, 1, 1, 1), text: 'b' }]);\n\t\t\tassert.strictEqual(modified.getValue(), 'ab');\n\n\t\t\tmodified.setValue('');\n\t\t\tawait idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'a' }]);\n\t\t\tawait idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'b' }]);\n\t\t\tassert.strictEqual(modified.getValue(), 'ba');\n\t\t});\n\t});\n\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { waitForState } from '../../../../../base/common/observable.js';\nimport { isEqual } from '../../../../../base/common/resources.js';\nimport { assertType } from '../../../../../base/common/types.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { assertThrowsAsync, ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { EditOperation } from '../../../../../editor/common/core/editOperation.js';\nimport { Position } from '../../../../../editor/common/core/position.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { TextEdit } from '../../../../../editor/common/languages.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { IModelService } from '../../../../../editor/common/services/model.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { SyncDescriptor } from '../../../../../platform/instantiation/common/descriptors.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { IWorkbenchAssignmentService } from '../../../../services/assignment/common/assignmentService.js';\nimport { NullWorkbenchAssignmentService } from '../../../../services/assignment/test/common/nullAssignmentService.js';\nimport { nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { workbenchInstantiationService } from '../../../../test/browser/workbenchTestServices.js';\nimport { TestWorkerService } from '../../../inlineChat/test/browser/testWorkerService.js';\nimport { IMcpService } from '../../../mcp/common/mcpTypes.js';\nimport { TestMcpService } from '../../../mcp/test/common/testMcpService.js';\nimport { IMultiDiffSourceResolver, IMultiDiffSourceResolverService } from '../../../multiDiffEditor/browser/multiDiffSourceResolverService.js';\nimport { NotebookTextModel } from '../../../notebook/common/model/notebookTextModel.js';\nimport { INotebookService } from '../../../notebook/common/notebookService.js';\nimport { ChatEditingService } from '../../browser/chatEditing/chatEditingServiceImpl.js';\nimport { ChatSessionsService } from '../../browser/chatSessions.contribution.js';\nimport { ChatAgentService, IChatAgentData, IChatAgentImplementation, IChatAgentService } from '../../common/chatAgents.js';\nimport { ChatEditingSessionState, IChatEditingService, IChatEditingSession, ModifiedFileEntryState } from '../../common/chatEditingService.js';\nimport { ChatModel } from '../../common/chatModel.js';\nimport { IChatService } from '../../common/chatService.js';\nimport { ChatService } from '../../common/chatServiceImpl.js';\nimport { IChatSessionsService } from '../../common/chatSessionsService.js';\nimport { IChatSlashCommandService } from '../../common/chatSlashCommands.js';\nimport { ChatTransferService, IChatTransferService } from '../../common/chatTransferService.js';\nimport { IChatVariablesService } from '../../common/chatVariables.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../common/constants.js';\nimport { ILanguageModelsService } from '../../common/languageModels.js';\nimport { NullLanguageModelsService } from '../common/languageModels.js';\nimport { MockChatVariablesService } from '../common/mockChatVariables.js';\nimport { runWithFakedTimers } from '../../../../../base/test/common/timeTravelScheduler.js';\n\nfunction getAgentData(id: string): IChatAgentData {\n\treturn {\n\t\tname: id,\n\t\tid: id,\n\t\textensionId: nullExtensionDescription.identifier,\n\t\textensionVersion: undefined,\n\t\textensionPublisherId: '',\n\t\tpublisherDisplayName: '',\n\t\textensionDisplayName: '',\n\t\tlocations: [ChatAgentLocation.Chat],\n\t\tmodes: [ChatModeKind.Ask],\n\t\tmetadata: {},\n\t\tslashCommands: [],\n\t\tdisambiguation: [],\n\t};\n}\n\nsuite('ChatEditingService', function () {\n\n\tconst store = new DisposableStore();\n\tlet editingService: ChatEditingService;\n\tlet chatService: IChatService;\n\tlet textModelService: ITextModelService;\n\n\tsetup(function () {\n\t\tconst collection = new ServiceCollection();\n\t\tcollection.set(IWorkbenchAssignmentService, new NullWorkbenchAssignmentService());\n\t\tcollection.set(IChatAgentService, new SyncDescriptor(ChatAgentService));\n\t\tcollection.set(IChatVariablesService, new MockChatVariablesService());\n\t\tcollection.set(IChatSlashCommandService, new class extends mock<IChatSlashCommandService>() { });\n\t\tcollection.set(IChatTransferService, new SyncDescriptor(ChatTransferService));\n\t\tcollection.set(IChatSessionsService, new SyncDescriptor(ChatSessionsService));\n\t\tcollection.set(IChatEditingService, new SyncDescriptor(ChatEditingService));\n\t\tcollection.set(IEditorWorkerService, new SyncDescriptor(TestWorkerService));\n\t\tcollection.set(IChatService, new SyncDescriptor(ChatService));\n\t\tcollection.set(IMcpService, new TestMcpService());\n\t\tcollection.set(ILanguageModelsService, new SyncDescriptor(NullLanguageModelsService));\n\t\tcollection.set(IMultiDiffSourceResolverService, new class extends mock<IMultiDiffSourceResolverService>() {\n\t\t\toverride registerResolver(_resolver: IMultiDiffSourceResolver): IDisposable {\n\t\t\t\treturn Disposable.None;\n\t\t\t}\n\t\t});\n\t\tcollection.set(INotebookService, new class extends mock<INotebookService>() {\n\t\t\toverride getNotebookTextModel(_uri: URI): NotebookTextModel | undefined {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\toverride hasSupportedNotebooks(_resource: URI): boolean {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t\tconst insta = store.add(store.add(workbenchInstantiationService(undefined, store)).createChild(collection));\n\t\tstore.add(insta.get(IEditorWorkerService) as TestWorkerService);\n\t\tconst value = insta.get(IChatEditingService);\n\t\tassert.ok(value instanceof ChatEditingService);\n\t\teditingService = value;\n\n\t\tchatService = insta.get(IChatService);\n\n\t\tstore.add(insta.get(IChatSessionsService) as ChatSessionsService); // Needs to be disposed in between test runs to clear extensionPoint contribution\n\n\t\tconst chatAgentService = insta.get(IChatAgentService);\n\n\t\tconst agent: IChatAgentImplementation = {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\treturn {};\n\t\t\t},\n\t\t};\n\t\tstore.add(chatAgentService.registerAgent('testAgent', { ...getAgentData('testAgent'), isDefault: true }));\n\t\tstore.add(chatAgentService.registerAgentImplementation('testAgent', agent));\n\n\t\ttextModelService = insta.get(ITextModelService);\n\n\t\tconst modelService = insta.get(IModelService);\n\n\t\tstore.add(textModelService.registerTextModelContentProvider('test', {\n\t\t\tasync provideTextContent(resource) {\n\t\t\t\treturn store.add(modelService.createModel(resource.path.repeat(10), null, resource, false));\n\t\t\t},\n\t\t}));\n\t});\n\n\tteardown(() => {\n\t\tstore.clear();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('create session', async function () {\n\t\tassert.ok(editingService);\n\n\t\tconst model = chatService.startSession(ChatAgentLocation.EditorInline, CancellationToken.None);\n\t\tconst session = editingService.createEditingSession(model, true);\n\n\t\tassert.strictEqual(session.chatSessionResource.toString(), model.sessionResource.toString());\n\t\tassert.strictEqual(session.isGlobalEditingSession, true);\n\n\t\tawait assertThrowsAsync(async () => {\n\t\t\t// DUPE not allowed\n\t\t\teditingService.createEditingSession(model);\n\t\t});\n\n\t\tsession.dispose();\n\t\tmodel.dispose();\n\t});\n\n\ttest('create session, file entry & isCurrentlyBeingModifiedBy', async function () {\n\t\tassert.ok(editingService);\n\n\t\tconst uri = URI.from({ scheme: 'test', path: 'HelloWorld' });\n\n\t\tconst model = chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None);\n\t\tconst session = model.editingSession;\n\t\tif (!session) {\n\t\t\tassert.fail('session not created');\n\t\t}\n\n\t\tconst chatRequest = model?.addRequest({ text: '', parts: [] }, { variables: [] }, 0);\n\t\tassertType(chatRequest.response);\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [], done: false });\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'FarBoo\\n' }], done: false });\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [], done: true });\n\n\t\tconst entry = await waitForState(session.entries.map(value => value.find(a => isEqual(a.modifiedURI, uri))));\n\n\t\tassert.ok(isEqual(entry.modifiedURI, uri));\n\n\t\tawait waitForState(entry.isCurrentlyBeingModifiedBy.map(value => value === chatRequest.response));\n\t\tassert.ok(entry.isCurrentlyBeingModifiedBy.get()?.responseModel === chatRequest.response);\n\n\t\tconst unset = waitForState(entry.isCurrentlyBeingModifiedBy.map(res => res === undefined));\n\n\t\tchatRequest.response.complete();\n\n\t\tawait unset;\n\n\t\tawait entry.reject();\n\n\t\tmodel.dispose();\n\t});\n\n\tasync function idleAfterEdit(session: IChatEditingSession, model: ChatModel, uri: URI, edits: TextEdit[]) {\n\t\tconst isStreaming = waitForState(session.state.map(s => s === ChatEditingSessionState.StreamingEdits), Boolean);\n\n\t\tconst chatRequest = model.addRequest({ text: '', parts: [] }, { variables: [] }, 0);\n\t\tassertType(chatRequest.response);\n\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits, done: true });\n\n\t\tconst entry = await waitForState(session.entries.map(value => value.find(a => isEqual(a.modifiedURI, uri))));\n\n\t\tassert.ok(isEqual(entry.modifiedURI, uri));\n\n\t\tchatRequest.response.complete();\n\n\t\tawait isStreaming;\n\n\t\tconst isIdle = waitForState(session.state.map(s => s === ChatEditingSessionState.Idle), Boolean);\n\t\tawait isIdle;\n\n\t\treturn entry;\n\t}\n\n\ttest('mirror typing outside -> accept', async function () {\n\t\treturn runWithFakedTimers({}, async () => {\n\t\t\tassert.ok(editingService);\n\n\t\t\tconst uri = URI.from({ scheme: 'test', path: 'abc\\n' });\n\n\t\t\tconst model = store.add(chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tconst session = model.editingSession;\n\t\t\tassertType(session, 'session not created');\n\n\t\t\tconst entry = await idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'FarBoo\\n' }]);\n\t\t\tconst original = store.add(await textModelService.createModelReference(entry.originalURI)).object.textEditorModel;\n\t\t\tconst modified = store.add(await textModelService.createModelReference(entry.modifiedURI)).object.textEditorModel;\n\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Modified);\n\n\t\t\tassert.strictEqual(original.getValue(), 'abc\\n'.repeat(10));\n\t\t\tassert.strictEqual(modified.getValue(), 'FarBoo\\n' + 'abc\\n'.repeat(10));\n\n\t\t\tmodified.pushEditOperations(null, [EditOperation.insert(new Position(3, 1), 'USER_TYPE\\n')], () => null);\n\n\t\t\tassert.ok(modified.getValue().includes('USER_TYPE'));\n\t\t\tassert.ok(original.getValue().includes('USER_TYPE'));\n\n\t\t\tawait entry.accept();\n\t\t\tassert.strictEqual(modified.getValue(), original.getValue());\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Accepted);\n\n\t\t\tassert.ok(modified.getValue().includes('FarBoo'));\n\t\t\tassert.ok(original.getValue().includes('FarBoo'));\n\t\t});\n\t});\n\n\ttest('mirror typing outside -> reject', async function () {\n\t\treturn runWithFakedTimers({}, async () => {\n\t\t\tassert.ok(editingService);\n\n\t\t\tconst uri = URI.from({ scheme: 'test', path: 'abc\\n' });\n\n\t\t\tconst model = store.add(chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tconst session = model.editingSession;\n\t\t\tassertType(session, 'session not created');\n\n\t\t\tconst entry = await idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'FarBoo\\n' }]);\n\t\t\tconst original = store.add(await textModelService.createModelReference(entry.originalURI)).object.textEditorModel;\n\t\t\tconst modified = store.add(await textModelService.createModelReference(entry.modifiedURI)).object.textEditorModel;\n\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Modified);\n\n\t\t\tassert.strictEqual(original.getValue(), 'abc\\n'.repeat(10));\n\t\t\tassert.strictEqual(modified.getValue(), 'FarBoo\\n' + 'abc\\n'.repeat(10));\n\n\t\t\tmodified.pushEditOperations(null, [EditOperation.insert(new Position(3, 1), 'USER_TYPE\\n')], () => null);\n\n\t\t\tassert.ok(modified.getValue().includes('USER_TYPE'));\n\t\t\tassert.ok(original.getValue().includes('USER_TYPE'));\n\n\t\t\tawait entry.reject();\n\t\t\tassert.strictEqual(modified.getValue(), original.getValue());\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Rejected);\n\n\t\t\tassert.ok(!modified.getValue().includes('FarBoo'));\n\t\t\tassert.ok(!original.getValue().includes('FarBoo'));\n\t\t});\n\t});\n\n\ttest('NO mirror typing inside -> accept', async function () {\n\t\treturn runWithFakedTimers({}, async () => {\n\t\t\tassert.ok(editingService);\n\n\t\t\tconst uri = URI.from({ scheme: 'test', path: 'abc\\n' });\n\n\t\t\tconst model = store.add(chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tconst session = model.editingSession;\n\t\t\tassertType(session, 'session not created');\n\n\t\t\tconst entry = await idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'FarBoo\\n' }]);\n\t\t\tconst original = store.add(await textModelService.createModelReference(entry.originalURI)).object.textEditorModel;\n\t\t\tconst modified = store.add(await textModelService.createModelReference(entry.modifiedURI)).object.textEditorModel;\n\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Modified);\n\n\t\t\tassert.strictEqual(original.getValue(), 'abc\\n'.repeat(10));\n\t\t\tassert.strictEqual(modified.getValue(), 'FarBoo\\n' + 'abc\\n'.repeat(10));\n\n\t\t\tmodified.pushEditOperations(null, [EditOperation.replace(new Range(1, 2, 1, 7), 'ooBar')], () => null);\n\n\t\t\tassert.ok(modified.getValue().includes('FooBar'));\n\t\t\tassert.ok(!original.getValue().includes('FooBar')); // typed in the AI edits, DO NOT transpose\n\n\t\t\tawait entry.accept();\n\t\t\tassert.strictEqual(modified.getValue(), original.getValue());\n\t\t\tassert.strictEqual(entry.state.get(), ModifiedFileEntryState.Accepted);\n\n\t\t\tassert.ok(modified.getValue().includes('FooBar'));\n\t\t\tassert.ok(original.getValue().includes('FooBar'));\n\t\t});\n\t});\n\n\ttest('ChatEditingService merges text edits it shouldn\\'t merge, #272679', async function () {\n\t\treturn runWithFakedTimers({}, async () => {\n\t\t\tassert.ok(editingService);\n\n\t\t\tconst uri = URI.from({ scheme: 'test', path: 'abc' });\n\n\t\t\tconst modified = store.add(await textModelService.createModelReference(uri)).object.textEditorModel;\n\n\t\t\tconst model = store.add(chatService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tconst session = model.editingSession;\n\t\t\tassertType(session, 'session not created');\n\n\t\t\tmodified.setValue('');\n\t\t\tawait idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'a' }, { range: new Range(1, 1, 1, 1), text: 'b' }]);\n\t\t\tassert.strictEqual(modified.getValue(), 'ab');\n\n\t\t\tmodified.setValue('');\n\t\t\tawait idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'a' }]);\n\t\t\tawait idleAfterEdit(session, model, uri, [{ range: new Range(1, 1, 1, 1), text: 'b' }]);\n\t\t\tassert.strictEqual(modified.getValue(), 'ba');\n\t\t});\n\t});\n\n});\n"]}