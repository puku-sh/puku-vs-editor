{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/test/common/chatService.test.ts","vs/workbench/contrib/chat/test/common/chatService.test.ts"],"names":[],"mappings":"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","file":"chatService.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Event } from '../../../../../base/common/event.js';\nimport { MarkdownString } from '../../../../../base/common/htmlContent.js';\nimport { observableValue } from '../../../../../base/common/observable.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { assertSnapshot } from '../../../../../base/test/common/snapshot.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IEnvironmentService } from '../../../../../platform/environment/common/environment.js';\nimport { IFileService } from '../../../../../platform/files/common/files.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { MockContextKeyService } from '../../../../../platform/keybinding/test/common/mockKeybindingService.js';\nimport { ILogService, NullLogService } from '../../../../../platform/log/common/log.js';\nimport { IStorageService } from '../../../../../platform/storage/common/storage.js';\nimport { ITelemetryService } from '../../../../../platform/telemetry/common/telemetry.js';\nimport { NullTelemetryService } from '../../../../../platform/telemetry/common/telemetryUtils.js';\nimport { IWorkspaceContextService } from '../../../../../platform/workspace/common/workspace.js';\nimport { IWorkbenchAssignmentService } from '../../../../services/assignment/common/assignmentService.js';\nimport { NullWorkbenchAssignmentService } from '../../../../services/assignment/test/common/nullAssignmentService.js';\nimport { IExtensionService, nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { ILifecycleService } from '../../../../services/lifecycle/common/lifecycle.js';\nimport { IViewsService } from '../../../../services/views/common/viewsService.js';\nimport { InMemoryTestFileService, mock, TestContextService, TestExtensionService, TestStorageService } from '../../../../test/common/workbenchTestServices.js';\nimport { IMcpService } from '../../../mcp/common/mcpTypes.js';\nimport { TestMcpService } from '../../../mcp/test/common/testMcpService.js';\nimport { ChatAgentService, IChatAgent, IChatAgentData, IChatAgentImplementation, IChatAgentService } from '../../common/chatAgents.js';\nimport { IChatEditingService, IChatEditingSession } from '../../common/chatEditingService.js';\nimport { IChatModel, ISerializableChatData } from '../../common/chatModel.js';\nimport { IChatFollowup, IChatService } from '../../common/chatService.js';\nimport { ChatService } from '../../common/chatServiceImpl.js';\nimport { ChatSlashCommandService, IChatSlashCommandService } from '../../common/chatSlashCommands.js';\nimport { IChatVariablesService } from '../../common/chatVariables.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../common/constants.js';\nimport { MockChatService } from './mockChatService.js';\nimport { MockChatVariablesService } from './mockChatVariables.js';\n\nconst chatAgentWithUsedContextId = 'ChatProviderWithUsedContext';\nconst chatAgentWithUsedContext: IChatAgent = {\n\tid: chatAgentWithUsedContextId,\n\tname: chatAgentWithUsedContextId,\n\textensionId: nullExtensionDescription.identifier,\n\textensionVersion: undefined,\n\tpublisherDisplayName: '',\n\textensionPublisherId: '',\n\textensionDisplayName: '',\n\tlocations: [ChatAgentLocation.Chat],\n\tmodes: [ChatModeKind.Ask],\n\tmetadata: {},\n\tslashCommands: [],\n\tdisambiguation: [],\n\tasync invoke(request, progress, history, token) {\n\t\tprogress([{\n\t\t\tdocuments: [\n\t\t\t\t{\n\t\t\t\t\turi: URI.file('/test/path/to/file'),\n\t\t\t\t\tversion: 3,\n\t\t\t\t\tranges: [\n\t\t\t\t\t\tnew Range(1, 1, 2, 2)\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t],\n\t\t\tkind: 'usedContext'\n\t\t}]);\n\n\t\treturn { metadata: { metadataKey: 'value' } };\n\t},\n\tasync provideFollowups(sessionId, token) {\n\t\treturn [{ kind: 'reply', message: 'Something else', agentId: '', tooltip: 'a tooltip' } satisfies IChatFollowup];\n\t},\n};\n\nconst chatAgentWithMarkdownId = 'ChatProviderWithMarkdown';\nconst chatAgentWithMarkdown: IChatAgent = {\n\tid: chatAgentWithMarkdownId,\n\tname: chatAgentWithMarkdownId,\n\textensionId: nullExtensionDescription.identifier,\n\textensionVersion: undefined,\n\tpublisherDisplayName: '',\n\textensionPublisherId: '',\n\textensionDisplayName: '',\n\tlocations: [ChatAgentLocation.Chat],\n\tmodes: [ChatModeKind.Ask],\n\tmetadata: {},\n\tslashCommands: [],\n\tdisambiguation: [],\n\tasync invoke(request, progress, history, token) {\n\t\tprogress([{ kind: 'markdownContent', content: new MarkdownString('test') }]);\n\t\treturn { metadata: { metadataKey: 'value' } };\n\t},\n\tasync provideFollowups(sessionId, token) {\n\t\treturn [];\n\t},\n};\n\nfunction getAgentData(id: string): IChatAgentData {\n\treturn {\n\t\tname: id,\n\t\tid: id,\n\t\textensionId: nullExtensionDescription.identifier,\n\t\textensionVersion: undefined,\n\t\textensionPublisherId: '',\n\t\tpublisherDisplayName: '',\n\t\textensionDisplayName: '',\n\t\tlocations: [ChatAgentLocation.Chat],\n\t\tmodes: [ChatModeKind.Ask],\n\t\tmetadata: {},\n\t\tslashCommands: [],\n\t\tdisambiguation: [],\n\t};\n}\n\nsuite('ChatService', () => {\n\tconst testDisposables = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet instantiationService: TestInstantiationService;\n\tlet testFileService: InMemoryTestFileService;\n\n\tlet chatAgentService: IChatAgentService;\n\n\tsetup(async () => {\n\t\tinstantiationService = testDisposables.add(new TestInstantiationService(new ServiceCollection(\n\t\t\t[IChatVariablesService, new MockChatVariablesService()],\n\t\t\t[IWorkbenchAssignmentService, new NullWorkbenchAssignmentService()],\n\t\t\t[IMcpService, new TestMcpService()],\n\t\t)));\n\t\tinstantiationService.stub(IStorageService, testDisposables.add(new TestStorageService()));\n\t\tinstantiationService.stub(ILogService, new NullLogService());\n\t\tinstantiationService.stub(ITelemetryService, NullTelemetryService);\n\t\tinstantiationService.stub(IExtensionService, new TestExtensionService());\n\t\tinstantiationService.stub(IContextKeyService, new MockContextKeyService());\n\t\tinstantiationService.stub(IViewsService, new TestExtensionService());\n\t\tinstantiationService.stub(IWorkspaceContextService, new TestContextService());\n\t\tinstantiationService.stub(IChatSlashCommandService, testDisposables.add(instantiationService.createInstance(ChatSlashCommandService)));\n\t\tinstantiationService.stub(IConfigurationService, new TestConfigurationService());\n\t\tinstantiationService.stub(IChatService, new MockChatService());\n\t\tinstantiationService.stub(IEnvironmentService, { workspaceStorageHome: URI.file('/test/path/to/workspaceStorage') });\n\t\tinstantiationService.stub(ILifecycleService, { onWillShutdown: Event.None });\n\t\tinstantiationService.stub(IChatEditingService, new class extends mock<IChatEditingService>() {\n\t\t\toverride startOrContinueGlobalEditingSession(): IChatEditingSession {\n\t\t\t\treturn {\n\t\t\t\t\trequestDisablement: observableValue('requestDisablement', []),\n\t\t\t\t\tdispose: () => { }\n\t\t\t\t} as unknown as IChatEditingSession;\n\t\t\t}\n\t\t});\n\n\t\t// Configure test file service with tracking and in-memory storage\n\t\ttestFileService = testDisposables.add(new InMemoryTestFileService());\n\t\tinstantiationService.stub(IFileService, testFileService);\n\n\t\tchatAgentService = testDisposables.add(instantiationService.createInstance(ChatAgentService));\n\t\tinstantiationService.stub(IChatAgentService, chatAgentService);\n\n\t\tconst agent: IChatAgentImplementation = {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\treturn {};\n\t\t\t},\n\t\t};\n\t\ttestDisposables.add(chatAgentService.registerAgent('testAgent', { ...getAgentData('testAgent'), isDefault: true }));\n\t\ttestDisposables.add(chatAgentService.registerAgent(chatAgentWithUsedContextId, getAgentData(chatAgentWithUsedContextId)));\n\t\ttestDisposables.add(chatAgentService.registerAgent(chatAgentWithMarkdownId, getAgentData(chatAgentWithMarkdownId)));\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation('testAgent', agent));\n\t\tchatAgentService.updateAgent('testAgent', {});\n\t});\n\n\ttest('retrieveSession', async () => {\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\t\tconst session1 = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tsession1.addRequest({ parts: [], text: 'request 1' }, { variables: [] }, 0);\n\n\t\tconst session2 = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tsession2.addRequest({ parts: [], text: 'request 2' }, { variables: [] }, 0);\n\n\t\t// Clear sessions to trigger persistence to file service\n\t\tawait testService.clearSession(session1.sessionResource);\n\t\tawait testService.clearSession(session2.sessionResource);\n\n\t\t// Verify that sessions were written to the file service\n\t\tassert.strictEqual(testFileService.writeOperations.length, 2, 'Should have written 2 sessions to file service');\n\n\t\tconst session1WriteOp = testFileService.writeOperations.find((op: { resource: URI; content: string }) =>\n\t\t\top.content.includes('request 1'));\n\t\tconst session2WriteOp = testFileService.writeOperations.find((op: { resource: URI; content: string }) =>\n\t\t\top.content.includes('request 2'));\n\n\t\tassert.ok(session1WriteOp, 'Session 1 should have been written to file service');\n\t\tassert.ok(session2WriteOp, 'Session 2 should have been written to file service');\n\n\t\t// Create a new service instance to simulate app restart\n\t\tconst testService2 = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\t// Retrieve sessions and verify they're loaded from file service\n\t\tconst retrieved1 = testDisposables.add((await testService2.getOrRestoreSession(session1.sessionResource))!);\n\t\tconst retrieved2 = testDisposables.add((await testService2.getOrRestoreSession(session2.sessionResource))!);\n\n\t\tassert.ok(retrieved1, 'Should retrieve session 1');\n\t\tassert.ok(retrieved2, 'Should retrieve session 2');\n\t\tassert.deepStrictEqual(retrieved1.getRequests()[0]?.message.text, 'request 1');\n\t\tassert.deepStrictEqual(retrieved2.getRequests()[0]?.message.text, 'request 2');\n\t});\n\n\ttest('addCompleteRequest', async () => {\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst model = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tassert.strictEqual(model.getRequests().length, 0);\n\n\t\tawait testService.addCompleteRequest(model.sessionResource, 'test request', undefined, 0, { message: 'test response' });\n\t\tassert.strictEqual(model.getRequests().length, 1);\n\t\tassert.ok(model.getRequests()[0].response);\n\t\tassert.strictEqual(model.getRequests()[0].response?.response.toString(), 'test response');\n\t});\n\n\ttest('sendRequest fails', async () => {\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst model = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tconst response = await testService.sendRequest(model.sessionResource, `@${chatAgentWithUsedContextId} test request`);\n\t\tassert(response);\n\t\tawait response.responseCompletePromise;\n\n\t\tawait assertSnapshot(toSnapshotExportData(model));\n\t});\n\n\ttest('history', async () => {\n\t\tconst historyLengthAgent: IChatAgentImplementation = {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\treturn {\n\t\t\t\t\tmetadata: { historyLength: history.length }\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\n\t\ttestDisposables.add(chatAgentService.registerAgent('defaultAgent', { ...getAgentData('defaultAgent'), isDefault: true }));\n\t\ttestDisposables.add(chatAgentService.registerAgent('agent2', getAgentData('agent2')));\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation('defaultAgent', historyLengthAgent));\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation('agent2', historyLengthAgent));\n\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\t\tconst model = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\n\t\t// Send a request to default agent\n\t\tconst response = await testService.sendRequest(model.sessionResource, `test request`, { agentId: 'defaultAgent' });\n\t\tassert(response);\n\t\tawait response.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 1);\n\t\tassert.strictEqual(model.getRequests()[0].response?.result?.metadata?.historyLength, 0);\n\n\t\t// Send a request to agent2- it can't see the default agent's message\n\t\tconst response2 = await testService.sendRequest(model.sessionResource, `test request`, { agentId: 'agent2' });\n\t\tassert(response2);\n\t\tawait response2.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 2);\n\t\tassert.strictEqual(model.getRequests()[1].response?.result?.metadata?.historyLength, 0);\n\n\t\t// Send a request to defaultAgent - the default agent can see agent2's message\n\t\tconst response3 = await testService.sendRequest(model.sessionResource, `test request`, { agentId: 'defaultAgent' });\n\t\tassert(response3);\n\t\tawait response3.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 3);\n\t\tassert.strictEqual(model.getRequests()[2].response?.result?.metadata?.historyLength, 2);\n\t});\n\n\ttest('can serialize', async () => {\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation(chatAgentWithUsedContextId, chatAgentWithUsedContext));\n\t\tchatAgentService.updateAgent(chatAgentWithUsedContextId, {});\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst model = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tassert.strictEqual(model.getRequests().length, 0);\n\n\t\tawait assertSnapshot(toSnapshotExportData(model));\n\n\t\tconst response = await testService.sendRequest(model.sessionResource, `@${chatAgentWithUsedContextId} test request`);\n\t\tassert(response);\n\t\tawait response.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 1);\n\n\t\tconst response2 = await testService.sendRequest(model.sessionResource, `test request 2`);\n\t\tassert(response2);\n\t\tawait response2.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 2);\n\n\t\tawait assertSnapshot(toSnapshotExportData(model));\n\t});\n\n\ttest('can deserialize', async () => {\n\t\tlet serializedChatData: ISerializableChatData;\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation(chatAgentWithUsedContextId, chatAgentWithUsedContext));\n\n\t\t// create the first service, send request, get response, and serialize the state\n\t\t{  // serapate block to not leak variables in outer scope\n\t\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\t\tconst chatModel1 = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tassert.strictEqual(chatModel1.getRequests().length, 0);\n\n\t\t\tconst response = await testService.sendRequest(chatModel1.sessionResource, `@${chatAgentWithUsedContextId} test request`);\n\t\t\tassert(response);\n\n\t\t\tawait response.responseCompletePromise;\n\n\t\t\tserializedChatData = JSON.parse(JSON.stringify(chatModel1));\n\t\t}\n\n\t\t// try deserializing the state into a new service\n\n\t\tconst testService2 = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst chatModel2 = testService2.loadSessionFromContent(serializedChatData);\n\t\tassert(chatModel2);\n\n\t\tawait assertSnapshot(toSnapshotExportData(chatModel2));\n\t\tchatModel2.dispose();\n\t});\n\n\ttest('can deserialize with response', async () => {\n\t\tlet serializedChatData: ISerializableChatData;\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation(chatAgentWithMarkdownId, chatAgentWithMarkdown));\n\n\t\t{\n\t\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\t\tconst chatModel1 = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tassert.strictEqual(chatModel1.getRequests().length, 0);\n\n\t\t\tconst response = await testService.sendRequest(chatModel1.sessionResource, `@${chatAgentWithUsedContextId} test request`);\n\t\t\tassert(response);\n\n\t\t\tawait response.responseCompletePromise;\n\n\t\t\tserializedChatData = JSON.parse(JSON.stringify(chatModel1));\n\t\t}\n\n\t\t// try deserializing the state into a new service\n\n\t\tconst testService2 = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst chatModel2 = testService2.loadSessionFromContent(serializedChatData);\n\t\tassert(chatModel2);\n\n\t\tawait assertSnapshot(toSnapshotExportData(chatModel2));\n\t\tchatModel2.dispose();\n\t});\n});\n\n\nfunction toSnapshotExportData(model: IChatModel) {\n\tconst exp = model.toExport();\n\treturn {\n\t\t...exp,\n\t\trequests: exp.requests.map(r => {\n\t\t\treturn {\n\t\t\t\t...r,\n\t\t\t\tmodelState: {\n\t\t\t\t\t...r.modelState,\n\t\t\t\t\tcompletedAt: undefined\n\t\t\t\t},\n\t\t\t\ttimestamp: undefined,\n\t\t\t\trequestId: undefined, // id contains a random part\n\t\t\t\tresponseId: undefined, // id contains a random part\n\t\t\t};\n\t\t})\n\t};\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Event } from '../../../../../base/common/event.js';\nimport { MarkdownString } from '../../../../../base/common/htmlContent.js';\nimport { observableValue } from '../../../../../base/common/observable.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { assertSnapshot } from '../../../../../base/test/common/snapshot.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IEnvironmentService } from '../../../../../platform/environment/common/environment.js';\nimport { IFileService } from '../../../../../platform/files/common/files.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { MockContextKeyService } from '../../../../../platform/keybinding/test/common/mockKeybindingService.js';\nimport { ILogService, NullLogService } from '../../../../../platform/log/common/log.js';\nimport { IStorageService } from '../../../../../platform/storage/common/storage.js';\nimport { ITelemetryService } from '../../../../../platform/telemetry/common/telemetry.js';\nimport { NullTelemetryService } from '../../../../../platform/telemetry/common/telemetryUtils.js';\nimport { IWorkspaceContextService } from '../../../../../platform/workspace/common/workspace.js';\nimport { IWorkbenchAssignmentService } from '../../../../services/assignment/common/assignmentService.js';\nimport { NullWorkbenchAssignmentService } from '../../../../services/assignment/test/common/nullAssignmentService.js';\nimport { IExtensionService, nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { ILifecycleService } from '../../../../services/lifecycle/common/lifecycle.js';\nimport { IViewsService } from '../../../../services/views/common/viewsService.js';\nimport { InMemoryTestFileService, mock, TestContextService, TestExtensionService, TestStorageService } from '../../../../test/common/workbenchTestServices.js';\nimport { IMcpService } from '../../../mcp/common/mcpTypes.js';\nimport { TestMcpService } from '../../../mcp/test/common/testMcpService.js';\nimport { ChatAgentService, IChatAgent, IChatAgentData, IChatAgentImplementation, IChatAgentService } from '../../common/chatAgents.js';\nimport { IChatEditingService, IChatEditingSession } from '../../common/chatEditingService.js';\nimport { IChatModel, ISerializableChatData } from '../../common/chatModel.js';\nimport { IChatFollowup, IChatService } from '../../common/chatService.js';\nimport { ChatService } from '../../common/chatServiceImpl.js';\nimport { ChatSlashCommandService, IChatSlashCommandService } from '../../common/chatSlashCommands.js';\nimport { IChatVariablesService } from '../../common/chatVariables.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../common/constants.js';\nimport { MockChatService } from './mockChatService.js';\nimport { MockChatVariablesService } from './mockChatVariables.js';\n\nconst chatAgentWithUsedContextId = 'ChatProviderWithUsedContext';\nconst chatAgentWithUsedContext: IChatAgent = {\n\tid: chatAgentWithUsedContextId,\n\tname: chatAgentWithUsedContextId,\n\textensionId: nullExtensionDescription.identifier,\n\textensionVersion: undefined,\n\tpublisherDisplayName: '',\n\textensionPublisherId: '',\n\textensionDisplayName: '',\n\tlocations: [ChatAgentLocation.Chat],\n\tmodes: [ChatModeKind.Ask],\n\tmetadata: {},\n\tslashCommands: [],\n\tdisambiguation: [],\n\tasync invoke(request, progress, history, token) {\n\t\tprogress([{\n\t\t\tdocuments: [\n\t\t\t\t{\n\t\t\t\t\turi: URI.file('/test/path/to/file'),\n\t\t\t\t\tversion: 3,\n\t\t\t\t\tranges: [\n\t\t\t\t\t\tnew Range(1, 1, 2, 2)\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t],\n\t\t\tkind: 'usedContext'\n\t\t}]);\n\n\t\treturn { metadata: { metadataKey: 'value' } };\n\t},\n\tasync provideFollowups(sessionId, token) {\n\t\treturn [{ kind: 'reply', message: 'Something else', agentId: '', tooltip: 'a tooltip' } satisfies IChatFollowup];\n\t},\n};\n\nconst chatAgentWithMarkdownId = 'ChatProviderWithMarkdown';\nconst chatAgentWithMarkdown: IChatAgent = {\n\tid: chatAgentWithMarkdownId,\n\tname: chatAgentWithMarkdownId,\n\textensionId: nullExtensionDescription.identifier,\n\textensionVersion: undefined,\n\tpublisherDisplayName: '',\n\textensionPublisherId: '',\n\textensionDisplayName: '',\n\tlocations: [ChatAgentLocation.Chat],\n\tmodes: [ChatModeKind.Ask],\n\tmetadata: {},\n\tslashCommands: [],\n\tdisambiguation: [],\n\tasync invoke(request, progress, history, token) {\n\t\tprogress([{ kind: 'markdownContent', content: new MarkdownString('test') }]);\n\t\treturn { metadata: { metadataKey: 'value' } };\n\t},\n\tasync provideFollowups(sessionId, token) {\n\t\treturn [];\n\t},\n};\n\nfunction getAgentData(id: string): IChatAgentData {\n\treturn {\n\t\tname: id,\n\t\tid: id,\n\t\textensionId: nullExtensionDescription.identifier,\n\t\textensionVersion: undefined,\n\t\textensionPublisherId: '',\n\t\tpublisherDisplayName: '',\n\t\textensionDisplayName: '',\n\t\tlocations: [ChatAgentLocation.Chat],\n\t\tmodes: [ChatModeKind.Ask],\n\t\tmetadata: {},\n\t\tslashCommands: [],\n\t\tdisambiguation: [],\n\t};\n}\n\nsuite('ChatService', () => {\n\tconst testDisposables = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet instantiationService: TestInstantiationService;\n\tlet testFileService: InMemoryTestFileService;\n\n\tlet chatAgentService: IChatAgentService;\n\n\tsetup(async () => {\n\t\tinstantiationService = testDisposables.add(new TestInstantiationService(new ServiceCollection(\n\t\t\t[IChatVariablesService, new MockChatVariablesService()],\n\t\t\t[IWorkbenchAssignmentService, new NullWorkbenchAssignmentService()],\n\t\t\t[IMcpService, new TestMcpService()],\n\t\t)));\n\t\tinstantiationService.stub(IStorageService, testDisposables.add(new TestStorageService()));\n\t\tinstantiationService.stub(ILogService, new NullLogService());\n\t\tinstantiationService.stub(ITelemetryService, NullTelemetryService);\n\t\tinstantiationService.stub(IExtensionService, new TestExtensionService());\n\t\tinstantiationService.stub(IContextKeyService, new MockContextKeyService());\n\t\tinstantiationService.stub(IViewsService, new TestExtensionService());\n\t\tinstantiationService.stub(IWorkspaceContextService, new TestContextService());\n\t\tinstantiationService.stub(IChatSlashCommandService, testDisposables.add(instantiationService.createInstance(ChatSlashCommandService)));\n\t\tinstantiationService.stub(IConfigurationService, new TestConfigurationService());\n\t\tinstantiationService.stub(IChatService, new MockChatService());\n\t\tinstantiationService.stub(IEnvironmentService, { workspaceStorageHome: URI.file('/test/path/to/workspaceStorage') });\n\t\tinstantiationService.stub(ILifecycleService, { onWillShutdown: Event.None });\n\t\tinstantiationService.stub(IChatEditingService, new class extends mock<IChatEditingService>() {\n\t\t\toverride startOrContinueGlobalEditingSession(): IChatEditingSession {\n\t\t\t\treturn {\n\t\t\t\t\trequestDisablement: observableValue('requestDisablement', []),\n\t\t\t\t\tdispose: () => { }\n\t\t\t\t} as unknown as IChatEditingSession;\n\t\t\t}\n\t\t});\n\n\t\t// Configure test file service with tracking and in-memory storage\n\t\ttestFileService = testDisposables.add(new InMemoryTestFileService());\n\t\tinstantiationService.stub(IFileService, testFileService);\n\n\t\tchatAgentService = testDisposables.add(instantiationService.createInstance(ChatAgentService));\n\t\tinstantiationService.stub(IChatAgentService, chatAgentService);\n\n\t\tconst agent: IChatAgentImplementation = {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\treturn {};\n\t\t\t},\n\t\t};\n\t\ttestDisposables.add(chatAgentService.registerAgent('testAgent', { ...getAgentData('testAgent'), isDefault: true }));\n\t\ttestDisposables.add(chatAgentService.registerAgent(chatAgentWithUsedContextId, getAgentData(chatAgentWithUsedContextId)));\n\t\ttestDisposables.add(chatAgentService.registerAgent(chatAgentWithMarkdownId, getAgentData(chatAgentWithMarkdownId)));\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation('testAgent', agent));\n\t\tchatAgentService.updateAgent('testAgent', {});\n\t});\n\n\ttest('retrieveSession', async () => {\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\t\tconst session1 = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tsession1.addRequest({ parts: [], text: 'request 1' }, { variables: [] }, 0);\n\n\t\tconst session2 = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tsession2.addRequest({ parts: [], text: 'request 2' }, { variables: [] }, 0);\n\n\t\t// Clear sessions to trigger persistence to file service\n\t\tawait testService.clearSession(session1.sessionResource);\n\t\tawait testService.clearSession(session2.sessionResource);\n\n\t\t// Verify that sessions were written to the file service\n\t\tassert.strictEqual(testFileService.writeOperations.length, 2, 'Should have written 2 sessions to file service');\n\n\t\tconst session1WriteOp = testFileService.writeOperations.find((op: { resource: URI; content: string }) =>\n\t\t\top.content.includes('request 1'));\n\t\tconst session2WriteOp = testFileService.writeOperations.find((op: { resource: URI; content: string }) =>\n\t\t\top.content.includes('request 2'));\n\n\t\tassert.ok(session1WriteOp, 'Session 1 should have been written to file service');\n\t\tassert.ok(session2WriteOp, 'Session 2 should have been written to file service');\n\n\t\t// Create a new service instance to simulate app restart\n\t\tconst testService2 = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\t// Retrieve sessions and verify they're loaded from file service\n\t\tconst retrieved1 = testDisposables.add((await testService2.getOrRestoreSession(session1.sessionResource))!);\n\t\tconst retrieved2 = testDisposables.add((await testService2.getOrRestoreSession(session2.sessionResource))!);\n\n\t\tassert.ok(retrieved1, 'Should retrieve session 1');\n\t\tassert.ok(retrieved2, 'Should retrieve session 2');\n\t\tassert.deepStrictEqual(retrieved1.getRequests()[0]?.message.text, 'request 1');\n\t\tassert.deepStrictEqual(retrieved2.getRequests()[0]?.message.text, 'request 2');\n\t});\n\n\ttest('addCompleteRequest', async () => {\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst model = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tassert.strictEqual(model.getRequests().length, 0);\n\n\t\tawait testService.addCompleteRequest(model.sessionResource, 'test request', undefined, 0, { message: 'test response' });\n\t\tassert.strictEqual(model.getRequests().length, 1);\n\t\tassert.ok(model.getRequests()[0].response);\n\t\tassert.strictEqual(model.getRequests()[0].response?.response.toString(), 'test response');\n\t});\n\n\ttest('sendRequest fails', async () => {\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst model = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tconst response = await testService.sendRequest(model.sessionResource, `@${chatAgentWithUsedContextId} test request`);\n\t\tassert(response);\n\t\tawait response.responseCompletePromise;\n\n\t\tawait assertSnapshot(toSnapshotExportData(model));\n\t});\n\n\ttest('history', async () => {\n\t\tconst historyLengthAgent: IChatAgentImplementation = {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\treturn {\n\t\t\t\t\tmetadata: { historyLength: history.length }\n\t\t\t\t};\n\t\t\t},\n\t\t};\n\n\t\ttestDisposables.add(chatAgentService.registerAgent('defaultAgent', { ...getAgentData('defaultAgent'), isDefault: true }));\n\t\ttestDisposables.add(chatAgentService.registerAgent('agent2', getAgentData('agent2')));\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation('defaultAgent', historyLengthAgent));\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation('agent2', historyLengthAgent));\n\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\t\tconst model = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\n\t\t// Send a request to default agent\n\t\tconst response = await testService.sendRequest(model.sessionResource, `test request`, { agentId: 'defaultAgent' });\n\t\tassert(response);\n\t\tawait response.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 1);\n\t\tassert.strictEqual(model.getRequests()[0].response?.result?.metadata?.historyLength, 0);\n\n\t\t// Send a request to agent2- it can't see the default agent's message\n\t\tconst response2 = await testService.sendRequest(model.sessionResource, `test request`, { agentId: 'agent2' });\n\t\tassert(response2);\n\t\tawait response2.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 2);\n\t\tassert.strictEqual(model.getRequests()[1].response?.result?.metadata?.historyLength, 0);\n\n\t\t// Send a request to defaultAgent - the default agent can see agent2's message\n\t\tconst response3 = await testService.sendRequest(model.sessionResource, `test request`, { agentId: 'defaultAgent' });\n\t\tassert(response3);\n\t\tawait response3.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 3);\n\t\tassert.strictEqual(model.getRequests()[2].response?.result?.metadata?.historyLength, 2);\n\t});\n\n\ttest('can serialize', async () => {\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation(chatAgentWithUsedContextId, chatAgentWithUsedContext));\n\t\tchatAgentService.updateAgent(chatAgentWithUsedContextId, {});\n\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst model = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\tassert.strictEqual(model.getRequests().length, 0);\n\n\t\tawait assertSnapshot(toSnapshotExportData(model));\n\n\t\tconst response = await testService.sendRequest(model.sessionResource, `@${chatAgentWithUsedContextId} test request`);\n\t\tassert(response);\n\t\tawait response.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 1);\n\n\t\tconst response2 = await testService.sendRequest(model.sessionResource, `test request 2`);\n\t\tassert(response2);\n\t\tawait response2.responseCompletePromise;\n\t\tassert.strictEqual(model.getRequests().length, 2);\n\n\t\tawait assertSnapshot(toSnapshotExportData(model));\n\t});\n\n\ttest('can deserialize', async () => {\n\t\tlet serializedChatData: ISerializableChatData;\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation(chatAgentWithUsedContextId, chatAgentWithUsedContext));\n\n\t\t// create the first service, send request, get response, and serialize the state\n\t\t{  // serapate block to not leak variables in outer scope\n\t\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\t\tconst chatModel1 = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tassert.strictEqual(chatModel1.getRequests().length, 0);\n\n\t\t\tconst response = await testService.sendRequest(chatModel1.sessionResource, `@${chatAgentWithUsedContextId} test request`);\n\t\t\tassert(response);\n\n\t\t\tawait response.responseCompletePromise;\n\n\t\t\tserializedChatData = JSON.parse(JSON.stringify(chatModel1));\n\t\t}\n\n\t\t// try deserializing the state into a new service\n\n\t\tconst testService2 = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst chatModel2 = testService2.loadSessionFromContent(serializedChatData);\n\t\tassert(chatModel2);\n\n\t\tawait assertSnapshot(toSnapshotExportData(chatModel2));\n\t\tchatModel2.dispose();\n\t});\n\n\ttest('can deserialize with response', async () => {\n\t\tlet serializedChatData: ISerializableChatData;\n\t\ttestDisposables.add(chatAgentService.registerAgentImplementation(chatAgentWithMarkdownId, chatAgentWithMarkdown));\n\n\t\t{\n\t\t\tconst testService = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\t\tconst chatModel1 = testDisposables.add(testService.startSession(ChatAgentLocation.Chat, CancellationToken.None));\n\t\t\tassert.strictEqual(chatModel1.getRequests().length, 0);\n\n\t\t\tconst response = await testService.sendRequest(chatModel1.sessionResource, `@${chatAgentWithUsedContextId} test request`);\n\t\t\tassert(response);\n\n\t\t\tawait response.responseCompletePromise;\n\n\t\t\tserializedChatData = JSON.parse(JSON.stringify(chatModel1));\n\t\t}\n\n\t\t// try deserializing the state into a new service\n\n\t\tconst testService2 = testDisposables.add(instantiationService.createInstance(ChatService));\n\n\t\tconst chatModel2 = testService2.loadSessionFromContent(serializedChatData);\n\t\tassert(chatModel2);\n\n\t\tawait assertSnapshot(toSnapshotExportData(chatModel2));\n\t\tchatModel2.dispose();\n\t});\n});\n\n\nfunction toSnapshotExportData(model: IChatModel) {\n\tconst exp = model.toExport();\n\treturn {\n\t\t...exp,\n\t\trequests: exp.requests.map(r => {\n\t\t\treturn {\n\t\t\t\t...r,\n\t\t\t\tmodelState: {\n\t\t\t\t\t...r.modelState,\n\t\t\t\t\tcompletedAt: undefined\n\t\t\t\t},\n\t\t\t\ttimestamp: undefined,\n\t\t\t\trequestId: undefined, // id contains a random part\n\t\t\t\tresponseId: undefined, // id contains a random part\n\t\t\t};\n\t\t})\n\t};\n}\n"]}