{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/test/browser/promptSytntax/promptBodyAutocompletion.test.ts","vs/workbench/contrib/chat/test/browser/promptSytntax/promptBodyAutocompletion.test.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,MAAM,MAAM,QAAQ,CAAC;AAC5B,OAAO,EAAE,iBAAiB,EAAE,MAAM,+CAA+C,CAAC;AAClF,OAAO,EAAE,uCAAuC,EAAE,MAAM,6CAA6C,CAAC;AACtG,OAAO,EAAE,QAAQ,EAAE,MAAM,kDAAkD,CAAC;AAE5E,OAAO,EAAE,iBAAiB,EAAE,MAAM,oEAAoE,CAAC;AACvG,OAAO,EAAE,wBAAwB,EAAE,MAAM,kFAAkF,CAAC;AAC5H,OAAO,EAAE,mBAAmB,EAAE,MAAM,4DAA4D,CAAC;AAEjG,OAAO,EAAE,6BAA6B,EAAE,MAAM,sDAAsD,CAAC;AACrG,OAAO,EAAE,yBAAyB,EAAE,MAAM,+CAA+C,CAAC;AAC1F,OAAO,EAAE,iBAAiB,EAAE,MAAM,8BAA8B,CAAC;AACjE,OAAO,EAAE,0BAA0B,EAAa,cAAc,EAAE,MAAM,8CAA8C,CAAC;AACrH,OAAO,EAAE,wBAAwB,EAAE,MAAM,4EAA4E,CAAC;AACtH,OAAO,EAAE,eAAe,EAAE,MAAM,uDAAuD,CAAC;AACxF,OAAO,EAAE,GAAG,EAAE,MAAM,sCAAsC,CAAC;AAC3D,OAAO,EAAE,2BAA2B,EAAE,WAAW,EAAE,MAAM,6CAA6C,CAAC;AACvG,OAAO,EAAE,sBAAsB,EAAE,MAAM,4DAA4D,CAAC;AACpG,OAAO,EAAE,YAAY,EAAE,MAAM,kDAAkD,CAAC;AAChF,OAAO,EAAE,WAAW,EAAE,MAAM,wDAAwD,CAAC;AACrF,OAAO,EAAE,QAAQ,EAAE,MAAM,yCAAyC,CAAC;AACnE,OAAO,EAAE,0BAA0B,EAAE,MAAM,uEAAuE,CAAC;AACnH,OAAO,EAAE,WAAW,EAAE,cAAc,EAAE,MAAM,8CAA8C,CAAC;AAC3F,OAAO,EAAE,KAAK,EAAE,MAAM,+CAA+C,CAAC;AAEtE,KAAK,CAAC,0BAA0B,EAAE,GAAG,EAAE;IACtC,MAAM,WAAW,GAAG,uCAAuC,EAAE,CAAC;IAE9D,IAAI,YAAsC,CAAC;IAC3C,IAAI,kBAA4C,CAAC;IAEjD,KAAK,CAAC,KAAK,IAAI,EAAE;QAChB,MAAM,iBAAiB,GAAG,IAAI,wBAAwB,EAAE,CAAC;QACzD,iBAAiB,CAAC,oBAAoB,CAAC,iBAAiB,CAAC,qBAAqB,EAAE,IAAI,CAAC,CAAC;QACtF,YAAY,GAAG,6BAA6B,CAAC;YAC5C,iBAAiB,EAAE,GAAG,EAAE,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,iBAAiB,CAAC,iBAAiB,CAAC,CAAC;YAClF,oBAAoB,EAAE,GAAG,EAAE,CAAC,iBAAiB;SAC7C,EAAE,WAAW,CAAC,CAAC;QAChB,YAAY,CAAC,IAAI,CAAC,WAAW,EAAE,IAAI,cAAc,EAAE,CAAC,CAAC;QACrD,MAAM,WAAW,GAAG,WAAW,CAAC,GAAG,CAAC,YAAY,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC,CAAC;QAC9E,YAAY,CAAC,IAAI,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;QAE7C,MAAM,kBAAkB,GAAG,WAAW,CAAC,GAAG,CAAC,IAAI,0BAA0B,EAAE,CAAC,CAAC;QAC7E,WAAW,CAAC,GAAG,CAAC,WAAW,CAAC,gBAAgB,CAAC,MAAM,EAAE,kBAAkB,CAAC,CAAC,CAAC;QAE1E,yCAAyC;QACzC,MAAM,WAAW,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,mBAAmB,CAAC,CAAC,CAAC;QAC/D,MAAM,WAAW,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,uBAAuB,CAAC,CAAC,CAAC;QACnE,MAAM,WAAW,CAAC,YAAY,CAAC,GAAG,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC,CAAC;QACpE,MAAM,WAAW,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,gCAAgC,CAAC,EAAE,QAAQ,CAAC,UAAU,CAAC,4BAA4B,CAAC,CAAC,CAAC;QAC5H,MAAM,WAAW,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,6BAA6B,CAAC,EAAE,QAAQ,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC,CAAC;QACxG,MAAM,WAAW,CAAC,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,gCAAgC,CAAC,EAAE,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC;QAEpG,MAAM,WAAW,GAAG,WAAW,CAAC,GAAG,CAAC,YAAY,CAAC,cAAc,CAAC,yBAAyB,CAAC,CAAC,CAAC;QAE5F,MAAM,SAAS,GAAG,EAAE,EAAE,EAAE,WAAW,EAAE,WAAW,EAAE,OAAO,EAAE,uBAAuB,EAAE,IAAI,EAAE,gBAAgB,EAAE,aAAa,EAAE,MAAM,EAAE,cAAc,CAAC,QAAQ,EAAE,WAAW,EAAE,EAAE,EAAsB,CAAC;QAClM,WAAW,CAAC,GAAG,CAAC,WAAW,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC,CAAC;QAEzD,MAAM,SAAS,GAAG,EAAE,EAAE,EAAE,WAAW,EAAE,WAAW,EAAE,OAAO,EAAE,uBAAuB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,gBAAgB,EAAE,aAAa,EAAE,MAAM,EAAE,cAAc,CAAC,QAAQ,EAAE,WAAW,EAAE,EAAE,EAAsB,CAAC;QAC9N,WAAW,CAAC,GAAG,CAAC,WAAW,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC,CAAC;QAEzD,MAAM,WAAW,GAAG,EAAE,IAAI,EAAE,WAAW,EAAE,KAAK,EAAE,cAAc,EAAE,WAAW,EAAE,IAAI,mBAAmB,CAAC,cAAc,CAAC,EAA2B,CAAC;QAChJ,MAAM,SAAS,GAAG,EAAE,EAAE,EAAE,WAAW,EAAE,WAAW,EAAE,OAAO,EAAE,uBAAuB,EAAE,IAAI,EAAE,iBAAiB,EAAE,OAAO,EAAE,gBAAgB,EAAE,aAAa,EAAE,MAAM,EAAE,WAAW,EAAE,WAAW,EAAE,EAAE,EAAsB,CAAC;QAClN,WAAW,CAAC,GAAG,CAAC,WAAW,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAC,CAAC;QAEzD,MAAM,WAAW,GAAG,EAAE,IAAI,EAAE,WAAW,EAAE,KAAK,EAAE,+BAA+B,EAAE,WAAW,EAAE,IAAI,mBAAmB,CAAC,mCAAmC,CAAC,EAA2B,CAAC;QACtL,MAAM,UAAU,GAAG,EAAE,EAAE,EAAE,YAAY,EAAE,uBAAuB,EAAE,IAAI,EAAE,iBAAiB,EAAE,aAAa,EAAE,gBAAgB,EAAE,OAAO,EAAE,WAAW,EAAE,aAAa,EAAE,MAAM,EAAE,WAAW,EAAE,WAAW,EAAE,EAAE,EAAsB,CAAC;QAC1N,WAAW,CAAC,GAAG,CAAC,WAAW,CAAC,gBAAgB,CAAC,UAAU,CAAC,CAAC,CAAC;QAE1D,YAAY,CAAC,GAAG,CAAC,0BAA0B,EAAE,WAAW,CAAC,CAAC;QAE1D,kBAAkB,GAAG,YAAY,CAAC,cAAc,CAAC,wBAAwB,CAAC,CAAC;IAC5E,CAAC,CAAC,CAAC;IAEH,KAAK,UAAU,cAAc,CAAC,OAAe,EAAE,IAAY,EAAE,MAAc,EAAE,UAAuB;QACnG,MAAM,UAAU,GAAG,2BAA2B,CAAC,UAAU,CAAC,CAAC;QAC3D,MAAM,KAAK,GAAG,WAAW,CAAC,GAAG,CAAC,eAAe,CAAC,OAAO,EAAE,UAAU,EAAE,SAAS,EAAE,GAAG,CAAC,KAAK,CAAC,uBAAuB,GAAG,sBAAsB,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;QACxJ,MAAM,QAAQ,GAAG,IAAI,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;QAC5C,MAAM,OAAO,GAAsB,EAAE,WAAW,sCAA8B,EAAE,CAAC;QACjF,MAAM,MAAM,GAAG,MAAM,kBAAkB,CAAC,sBAAsB,CAAC,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;QACjH,IAAI,CAAC,MAAM,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC;YACpC,OAAO,EAAE,CAAC;QACX,CAAC;QACD,MAAM,WAAW,GAAG,KAAK,CAAC,cAAc,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC;QAC9D,OAAO,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE;YACjC,MAAM,CAAC,CAAC,CAAC,KAAK,YAAY,KAAK,CAAC,CAAC;YACjC,OAAO;gBACN,KAAK,EAAE,CAAC,CAAC,KAAK;gBACd,MAAM,EAAE,WAAW,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,CAAC,WAAW,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,UAAU,GAAG,WAAW,CAAC,SAAS,CAAC,CAAC,CAAC,KAAK,CAAC,SAAS,GAAG,CAAC,CAAC;aACvH,CAAC;QACH,CAAC,CAAC,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,yBAAyB,EAAE,GAAG,EAAE;QACrC,IAAI,CAAC,qBAAqB,EAAE,KAAK,IAAI,EAAE;YACtC,MAAM,OAAO,GAAG;gBACf,KAAK;gBACL,qBAAqB;gBACrB,KAAK;gBACL,EAAE;gBACF,oCAAoC;gBACpC,cAAc;aACd,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAEb,CAAC;gBACA,MAAM,MAAM,GAAG,CAAC,MAAM,cAAc,CAAC,OAAO,EAAE,CAAC,EAAE,CAAC,EAAE,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;gBACzE,MAAM,CAAC,SAAS,CAAC,MAAM,EAAE;oBACxB;wBACC,KAAK,EAAE,OAAO;wBACd,MAAM,EAAE,yCAAyC;qBACjD;oBACD;wBACC,KAAK,EAAE,OAAO;wBACd,MAAM,EAAE,yCAAyC;qBACjD;iBACD,CAAC,CAAC;YACJ,CAAC;YACD,CAAC;gBACA,MAAM,MAAM,GAAG,CAAC,MAAM,cAAc,CAAC,OAAO,EAAE,CAAC,EAAE,EAAE,EAAE,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;gBAC1E,MAAM,CAAC,SAAS,CAAC,MAAM,EAAE;oBACxB;wBACC,KAAK,EAAE,OAAO;wBACd,MAAM,EAAE,iBAAiB;qBACzB;oBACD;wBACC,KAAK,EAAE,OAAO;wBACd,MAAM,EAAE,iBAAiB;qBACzB;iBACD,CAAC,CAAC;YACJ,CAAC;QACF,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,kBAAkB,EAAE,KAAK,IAAI,EAAE;YACnC,MAAM,OAAO,GAAG;gBACf,KAAK;gBACL,qBAAqB;gBACrB,KAAK;gBACL,EAAE;gBACF,iCAAiC;aACjC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACb,CAAC;gBACA,MAAM,MAAM,GAAG,CAAC,MAAM,cAAc,CAAC,OAAO,EAAE,CAAC,EAAE,EAAE,EAAE,WAAW,CAAC,MAAM,CAAC,CAAC,CAAC;gBAC1E,MAAM,CAAC,SAAS,CAAC,MAAM,EAAE;oBACxB;wBACC,KAAK,EAAE,QAAQ;wBACf,MAAM,EAAE,uCAAuC;qBAC/C;oBACD;wBACC,KAAK,EAAE,QAAQ;wBACf,MAAM,EAAE,uCAAuC;qBAC/C;oBACD;wBACC,KAAK,EAAE,OAAO;wBACd,MAAM,EAAE,sCAAsC;qBAC9C;oBACD;wBACC,KAAK,EAAE,OAAO;wBACd,MAAM,EAAE,sCAAsC;qBAC9C;oBACD;wBACC,KAAK,EAAE,oBAAoB;wBAC3B,MAAM,EAAE,mDAAmD;qBAC3D;oBACD;wBACC,KAAK,EAAE,+CAA+C;wBACtD,MAAM,EAAE,8EAA8E;qBACtF;iBACD,CAAC,CAAC;YACJ,CAAC;QACF,CAAC,CAAC,CAAC;IACJ,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC","file":"promptBodyAutocompletion.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { CancellationToken } from '../../../../../../base/common/cancellation.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { Position } from '../../../../../../editor/common/core/position.js';\nimport { CompletionContext, CompletionTriggerKind } from '../../../../../../editor/common/languages.js';\nimport { ContextKeyService } from '../../../../../../platform/contextkey/browser/contextKeyService.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { ExtensionIdentifier } from '../../../../../../platform/extensions/common/extensions.js';\nimport { TestInstantiationService } from '../../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { workbenchInstantiationService } from '../../../../../test/browser/workbenchTestServices.js';\nimport { LanguageModelToolsService } from '../../../browser/languageModelToolsService.js';\nimport { ChatConfiguration } from '../../../common/constants.js';\nimport { ILanguageModelToolsService, IToolData, ToolDataSource } from '../../../common/languageModelToolsService.js';\nimport { PromptBodyAutocompletion } from '../../../common/promptSyntax/languageProviders/promptBodyAutocompletion.js';\nimport { createTextModel } from '../../../../../../editor/test/common/testTextModel.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { getLanguageIdForPromptsType, PromptsType } from '../../../common/promptSyntax/promptTypes.js';\nimport { getPromptFileExtension } from '../../../common/promptSyntax/config/promptFileLocations.js';\nimport { IFileService } from '../../../../../../platform/files/common/files.js';\nimport { FileService } from '../../../../../../platform/files/common/fileService.js';\nimport { VSBuffer } from '../../../../../../base/common/buffer.js';\nimport { InMemoryFileSystemProvider } from '../../../../../../platform/files/common/inMemoryFilesystemProvider.js';\nimport { ILogService, NullLogService } from '../../../../../../platform/log/common/log.js';\nimport { Range } from '../../../../../../editor/common/core/range.js';\n\nsuite('PromptBodyAutocompletion', () => {\n\tconst disposables = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet instaService: TestInstantiationService;\n\tlet completionProvider: PromptBodyAutocompletion;\n\n\tsetup(async () => {\n\t\tconst testConfigService = new TestConfigurationService();\n\t\ttestConfigService.setUserConfiguration(ChatConfiguration.ExtensionToolsEnabled, true);\n\t\tinstaService = workbenchInstantiationService({\n\t\t\tcontextKeyService: () => disposables.add(new ContextKeyService(testConfigService)),\n\t\t\tconfigurationService: () => testConfigService\n\t\t}, disposables);\n\t\tinstaService.stub(ILogService, new NullLogService());\n\t\tconst fileService = disposables.add(instaService.createInstance(FileService));\n\t\tinstaService.stub(IFileService, fileService);\n\n\t\tconst fileSystemProvider = disposables.add(new InMemoryFileSystemProvider());\n\t\tdisposables.add(fileService.registerProvider('test', fileSystemProvider));\n\n\t\t// Create some test files and directories\n\t\tawait fileService.createFolder(URI.parse('test:///workspace'));\n\t\tawait fileService.createFolder(URI.parse('test:///workspace/src'));\n\t\tawait fileService.createFolder(URI.parse('test:///workspace/docs'));\n\t\tawait fileService.writeFile(URI.parse('test:///workspace/src/index.ts'), VSBuffer.fromString('export function hello() {}'));\n\t\tawait fileService.writeFile(URI.parse('test:///workspace/README.md'), VSBuffer.fromString('# Project'));\n\t\tawait fileService.writeFile(URI.parse('test:///workspace/package.json'), VSBuffer.fromString('{}'));\n\n\t\tconst toolService = disposables.add(instaService.createInstance(LanguageModelToolsService));\n\n\t\tconst testTool1 = { id: 'testTool1', displayName: 'tool1', canBeReferencedInPrompt: true, modelDescription: 'Test Tool 1', source: ToolDataSource.External, inputSchema: {} } satisfies IToolData;\n\t\tdisposables.add(toolService.registerToolData(testTool1));\n\n\t\tconst testTool2 = { id: 'testTool2', displayName: 'tool2', canBeReferencedInPrompt: true, toolReferenceName: 'tool2', modelDescription: 'Test Tool 2', source: ToolDataSource.External, inputSchema: {} } satisfies IToolData;\n\t\tdisposables.add(toolService.registerToolData(testTool2));\n\n\t\tconst myExtSource = { type: 'extension', label: 'My Extension', extensionId: new ExtensionIdentifier('My.extension') } satisfies ToolDataSource;\n\t\tconst testTool3 = { id: 'testTool3', displayName: 'tool3', canBeReferencedInPrompt: true, toolReferenceName: 'tool3', modelDescription: 'Test Tool 3', source: myExtSource, inputSchema: {} } satisfies IToolData;\n\t\tdisposables.add(toolService.registerToolData(testTool3));\n\n\t\tconst prExtSource = { type: 'extension', label: 'GitHub Pull Request Extension', extensionId: new ExtensionIdentifier('github.vscode-pull-request-github') } satisfies ToolDataSource;\n\t\tconst prExtTool1 = { id: 'suggestFix', canBeReferencedInPrompt: true, toolReferenceName: 'suggest-fix', modelDescription: 'tool4', displayName: 'Test Tool 4', source: prExtSource, inputSchema: {} } satisfies IToolData;\n\t\tdisposables.add(toolService.registerToolData(prExtTool1));\n\n\t\tinstaService.set(ILanguageModelToolsService, toolService);\n\n\t\tcompletionProvider = instaService.createInstance(PromptBodyAutocompletion);\n\t});\n\n\tasync function getCompletions(content: string, line: number, column: number, promptType: PromptsType) {\n\t\tconst languageId = getLanguageIdForPromptsType(promptType);\n\t\tconst model = disposables.add(createTextModel(content, languageId, undefined, URI.parse('test://workspace/test' + getPromptFileExtension(promptType))));\n\t\tconst position = new Position(line, column);\n\t\tconst context: CompletionContext = { triggerKind: CompletionTriggerKind.Invoke };\n\t\tconst result = await completionProvider.provideCompletionItems(model, position, context, CancellationToken.None);\n\t\tif (!result || !result.suggestions) {\n\t\t\treturn [];\n\t\t}\n\t\tconst lineContent = model.getLineContent(position.lineNumber);\n\t\treturn result.suggestions.map(s => {\n\t\t\tassert(s.range instanceof Range);\n\t\t\treturn {\n\t\t\t\tlabel: s.label,\n\t\t\t\tresult: lineContent.substring(0, s.range.startColumn - 1) + s.insertText + lineContent.substring(s.range.endColumn - 1)\n\t\t\t};\n\t\t});\n\t}\n\n\tsuite('prompt body completions', () => {\n\t\ttest('default suggestions', async () => {\n\t\t\tconst content = [\n\t\t\t\t'---',\n\t\t\t\t'description: \"Test\"',\n\t\t\t\t'---',\n\t\t\t\t'',\n\t\t\t\t'Use # to reference a file or tool.',\n\t\t\t\t'One more #to'\n\t\t\t].join('\\n');\n\n\t\t\t{\n\t\t\t\tconst actual = (await getCompletions(content, 5, 6, PromptsType.prompt));\n\t\t\t\tassert.deepEqual(actual, [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'file:',\n\t\t\t\t\t\tresult: 'Use #file: to reference a file or tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'tool:',\n\t\t\t\t\t\tresult: 'Use #tool: to reference a file or tool.'\n\t\t\t\t\t}\n\t\t\t\t]);\n\t\t\t}\n\t\t\t{\n\t\t\t\tconst actual = (await getCompletions(content, 6, 13, PromptsType.prompt));\n\t\t\t\tassert.deepEqual(actual, [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'file:',\n\t\t\t\t\t\tresult: 'One more #file:'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'tool:',\n\t\t\t\t\t\tresult: 'One more #tool:'\n\t\t\t\t\t}\n\t\t\t\t]);\n\t\t\t}\n\t\t});\n\n\t\ttest('tool suggestions', async () => {\n\t\t\tconst content = [\n\t\t\t\t'---',\n\t\t\t\t'description: \"Test\"',\n\t\t\t\t'---',\n\t\t\t\t'',\n\t\t\t\t'Use #tool: to reference a tool.',\n\t\t\t].join('\\n');\n\t\t\t{\n\t\t\t\tconst actual = (await getCompletions(content, 5, 11, PromptsType.prompt));\n\t\t\t\tassert.deepEqual(actual, [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'vscode',\n\t\t\t\t\t\tresult: 'Use #tool:vscode to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'launch',\n\t\t\t\t\t\tresult: 'Use #tool:launch to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'tool1',\n\t\t\t\t\t\tresult: 'Use #tool:tool1 to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'tool2',\n\t\t\t\t\t\tresult: 'Use #tool:tool2 to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'my.extension/tool3',\n\t\t\t\t\t\tresult: 'Use #tool:my.extension/tool3 to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'github.vscode-pull-request-github/suggest-fix',\n\t\t\t\t\t\tresult: 'Use #tool:github.vscode-pull-request-github/suggest-fix to reference a tool.'\n\t\t\t\t\t}\n\t\t\t\t]);\n\t\t\t}\n\t\t});\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { CancellationToken } from '../../../../../../base/common/cancellation.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { Position } from '../../../../../../editor/common/core/position.js';\nimport { CompletionContext, CompletionTriggerKind } from '../../../../../../editor/common/languages.js';\nimport { ContextKeyService } from '../../../../../../platform/contextkey/browser/contextKeyService.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { ExtensionIdentifier } from '../../../../../../platform/extensions/common/extensions.js';\nimport { TestInstantiationService } from '../../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { workbenchInstantiationService } from '../../../../../test/browser/workbenchTestServices.js';\nimport { LanguageModelToolsService } from '../../../browser/languageModelToolsService.js';\nimport { ChatConfiguration } from '../../../common/constants.js';\nimport { ILanguageModelToolsService, IToolData, ToolDataSource } from '../../../common/languageModelToolsService.js';\nimport { PromptBodyAutocompletion } from '../../../common/promptSyntax/languageProviders/promptBodyAutocompletion.js';\nimport { createTextModel } from '../../../../../../editor/test/common/testTextModel.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { getLanguageIdForPromptsType, PromptsType } from '../../../common/promptSyntax/promptTypes.js';\nimport { getPromptFileExtension } from '../../../common/promptSyntax/config/promptFileLocations.js';\nimport { IFileService } from '../../../../../../platform/files/common/files.js';\nimport { FileService } from '../../../../../../platform/files/common/fileService.js';\nimport { VSBuffer } from '../../../../../../base/common/buffer.js';\nimport { InMemoryFileSystemProvider } from '../../../../../../platform/files/common/inMemoryFilesystemProvider.js';\nimport { ILogService, NullLogService } from '../../../../../../platform/log/common/log.js';\nimport { Range } from '../../../../../../editor/common/core/range.js';\n\nsuite('PromptBodyAutocompletion', () => {\n\tconst disposables = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet instaService: TestInstantiationService;\n\tlet completionProvider: PromptBodyAutocompletion;\n\n\tsetup(async () => {\n\t\tconst testConfigService = new TestConfigurationService();\n\t\ttestConfigService.setUserConfiguration(ChatConfiguration.ExtensionToolsEnabled, true);\n\t\tinstaService = workbenchInstantiationService({\n\t\t\tcontextKeyService: () => disposables.add(new ContextKeyService(testConfigService)),\n\t\t\tconfigurationService: () => testConfigService\n\t\t}, disposables);\n\t\tinstaService.stub(ILogService, new NullLogService());\n\t\tconst fileService = disposables.add(instaService.createInstance(FileService));\n\t\tinstaService.stub(IFileService, fileService);\n\n\t\tconst fileSystemProvider = disposables.add(new InMemoryFileSystemProvider());\n\t\tdisposables.add(fileService.registerProvider('test', fileSystemProvider));\n\n\t\t// Create some test files and directories\n\t\tawait fileService.createFolder(URI.parse('test:///workspace'));\n\t\tawait fileService.createFolder(URI.parse('test:///workspace/src'));\n\t\tawait fileService.createFolder(URI.parse('test:///workspace/docs'));\n\t\tawait fileService.writeFile(URI.parse('test:///workspace/src/index.ts'), VSBuffer.fromString('export function hello() {}'));\n\t\tawait fileService.writeFile(URI.parse('test:///workspace/README.md'), VSBuffer.fromString('# Project'));\n\t\tawait fileService.writeFile(URI.parse('test:///workspace/package.json'), VSBuffer.fromString('{}'));\n\n\t\tconst toolService = disposables.add(instaService.createInstance(LanguageModelToolsService));\n\n\t\tconst testTool1 = { id: 'testTool1', displayName: 'tool1', canBeReferencedInPrompt: true, modelDescription: 'Test Tool 1', source: ToolDataSource.External, inputSchema: {} } satisfies IToolData;\n\t\tdisposables.add(toolService.registerToolData(testTool1));\n\n\t\tconst testTool2 = { id: 'testTool2', displayName: 'tool2', canBeReferencedInPrompt: true, toolReferenceName: 'tool2', modelDescription: 'Test Tool 2', source: ToolDataSource.External, inputSchema: {} } satisfies IToolData;\n\t\tdisposables.add(toolService.registerToolData(testTool2));\n\n\t\tconst myExtSource = { type: 'extension', label: 'My Extension', extensionId: new ExtensionIdentifier('My.extension') } satisfies ToolDataSource;\n\t\tconst testTool3 = { id: 'testTool3', displayName: 'tool3', canBeReferencedInPrompt: true, toolReferenceName: 'tool3', modelDescription: 'Test Tool 3', source: myExtSource, inputSchema: {} } satisfies IToolData;\n\t\tdisposables.add(toolService.registerToolData(testTool3));\n\n\t\tconst prExtSource = { type: 'extension', label: 'GitHub Pull Request Extension', extensionId: new ExtensionIdentifier('github.vscode-pull-request-github') } satisfies ToolDataSource;\n\t\tconst prExtTool1 = { id: 'suggestFix', canBeReferencedInPrompt: true, toolReferenceName: 'suggest-fix', modelDescription: 'tool4', displayName: 'Test Tool 4', source: prExtSource, inputSchema: {} } satisfies IToolData;\n\t\tdisposables.add(toolService.registerToolData(prExtTool1));\n\n\t\tinstaService.set(ILanguageModelToolsService, toolService);\n\n\t\tcompletionProvider = instaService.createInstance(PromptBodyAutocompletion);\n\t});\n\n\tasync function getCompletions(content: string, line: number, column: number, promptType: PromptsType) {\n\t\tconst languageId = getLanguageIdForPromptsType(promptType);\n\t\tconst model = disposables.add(createTextModel(content, languageId, undefined, URI.parse('test://workspace/test' + getPromptFileExtension(promptType))));\n\t\tconst position = new Position(line, column);\n\t\tconst context: CompletionContext = { triggerKind: CompletionTriggerKind.Invoke };\n\t\tconst result = await completionProvider.provideCompletionItems(model, position, context, CancellationToken.None);\n\t\tif (!result || !result.suggestions) {\n\t\t\treturn [];\n\t\t}\n\t\tconst lineContent = model.getLineContent(position.lineNumber);\n\t\treturn result.suggestions.map(s => {\n\t\t\tassert(s.range instanceof Range);\n\t\t\treturn {\n\t\t\t\tlabel: s.label,\n\t\t\t\tresult: lineContent.substring(0, s.range.startColumn - 1) + s.insertText + lineContent.substring(s.range.endColumn - 1)\n\t\t\t};\n\t\t});\n\t}\n\n\tsuite('prompt body completions', () => {\n\t\ttest('default suggestions', async () => {\n\t\t\tconst content = [\n\t\t\t\t'---',\n\t\t\t\t'description: \"Test\"',\n\t\t\t\t'---',\n\t\t\t\t'',\n\t\t\t\t'Use # to reference a file or tool.',\n\t\t\t\t'One more #to'\n\t\t\t].join('\\n');\n\n\t\t\t{\n\t\t\t\tconst actual = (await getCompletions(content, 5, 6, PromptsType.prompt));\n\t\t\t\tassert.deepEqual(actual, [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'file:',\n\t\t\t\t\t\tresult: 'Use #file: to reference a file or tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'tool:',\n\t\t\t\t\t\tresult: 'Use #tool: to reference a file or tool.'\n\t\t\t\t\t}\n\t\t\t\t]);\n\t\t\t}\n\t\t\t{\n\t\t\t\tconst actual = (await getCompletions(content, 6, 13, PromptsType.prompt));\n\t\t\t\tassert.deepEqual(actual, [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'file:',\n\t\t\t\t\t\tresult: 'One more #file:'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'tool:',\n\t\t\t\t\t\tresult: 'One more #tool:'\n\t\t\t\t\t}\n\t\t\t\t]);\n\t\t\t}\n\t\t});\n\n\t\ttest('tool suggestions', async () => {\n\t\t\tconst content = [\n\t\t\t\t'---',\n\t\t\t\t'description: \"Test\"',\n\t\t\t\t'---',\n\t\t\t\t'',\n\t\t\t\t'Use #tool: to reference a tool.',\n\t\t\t].join('\\n');\n\t\t\t{\n\t\t\t\tconst actual = (await getCompletions(content, 5, 11, PromptsType.prompt));\n\t\t\t\tassert.deepEqual(actual, [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'vscode',\n\t\t\t\t\t\tresult: 'Use #tool:vscode to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'launch',\n\t\t\t\t\t\tresult: 'Use #tool:launch to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'tool1',\n\t\t\t\t\t\tresult: 'Use #tool:tool1 to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'tool2',\n\t\t\t\t\t\tresult: 'Use #tool:tool2 to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'my.extension/tool3',\n\t\t\t\t\t\tresult: 'Use #tool:my.extension/tool3 to reference a tool.'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: 'github.vscode-pull-request-github/suggest-fix',\n\t\t\t\t\t\tresult: 'Use #tool:github.vscode-pull-request-github/suggest-fix to reference a tool.'\n\t\t\t\t\t}\n\t\t\t\t]);\n\t\t\t}\n\t\t});\n\t});\n});\n"]}