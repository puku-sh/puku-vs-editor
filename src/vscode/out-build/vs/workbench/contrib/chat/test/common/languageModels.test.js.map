{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/test/common/languageModels.test.ts","vs/workbench/contrib/chat/test/common/languageModels.test.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,MAAM,MAAM,QAAQ,CAAC;AAC5B,OAAO,EAAE,mBAAmB,EAAE,eAAe,EAAE,OAAO,EAAE,MAAM,qCAAqC,CAAC;AACpG,OAAO,EAAqB,uBAAuB,EAAE,MAAM,4CAA4C,CAAC;AACxG,OAAO,EAAE,eAAe,EAAE,MAAM,yCAAyC,CAAC;AAC1E,OAAO,EAAE,IAAI,EAAE,MAAM,yCAAyC,CAAC;AAC/D,OAAO,EAAE,uCAAuC,EAAE,MAAM,0CAA0C,CAAC;AACnG,OAAO,EAAE,cAAc,EAAE,MAAM,2CAA2C,CAAC;AAC3E,OAAO,EAAmB,uCAAuC,EAAE,qBAAqB,EAAmC,MAAM,gCAAgC,CAAC;AAClK,OAAO,EAAqB,wBAAwB,EAAE,MAAM,sDAAsD,CAAC;AACnH,OAAO,EAAE,kBAAkB,EAAE,MAAM,8DAA8D,CAAC;AAClG,OAAO,EAAE,6BAA6B,EAAE,MAAM,+CAA+C,CAAC;AAE9F,OAAO,EAAE,0BAA0B,EAAE,kBAAkB,EAAE,MAAM,kDAAkD,CAAC;AAClH,OAAO,EAAE,KAAK,EAAE,MAAM,qCAAqC,CAAC;AAC5D,OAAO,EAAE,qBAAqB,EAAE,MAAM,yEAAyE,CAAC;AAChH,OAAO,EAAE,wBAAwB,EAAE,MAAM,+EAA+E,CAAC;AAGzH,KAAK,CAAC,gBAAgB,EAAE;IAEvB,IAAI,cAAqC,CAAC;IAE1C,MAAM,KAAK,GAAG,IAAI,eAAe,EAAE,CAAC;IACpC,MAAM,gBAAgB,GAAG,IAAI,GAAG,EAAU,CAAC;IAE3C,KAAK,CAAC;QAEL,cAAc,GAAG,IAAI,qBAAqB,CACzC,IAAI,KAAM,SAAQ,IAAI,EAAqB;YACjC,eAAe,CAAC,IAAY;gBACpC,gBAAgB,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;gBAC3B,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;YAC1B,CAAC;SACD,EACD,IAAI,cAAc,EAAE,EACpB,IAAI,kBAAkB,EAAE,EACxB,IAAI,qBAAqB,EAAE,EAC3B,IAAI,wBAAwB,EAAE,EAC9B,IAAI,0BAA0B,EAAE,CAChC,CAAC;QAEF,MAAM,GAAG,GAAG,kBAAkB,CAAC,kBAAkB,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,uCAAuC,CAAC,IAAI,CAAE,CAAC;QAExH,GAAG,CAAC,WAAW,CAAC,CAAC;gBAChB,WAAW,EAAE,EAAE,GAAG,wBAAwB,EAAE;gBAC5C,KAAK,EAAE,EAAE,MAAM,EAAE,aAAa,EAAE;gBAChC,SAAS,EAAE,IAAK;aAChB,EAAE;gBACF,WAAW,EAAE,EAAE,GAAG,wBAAwB,EAAE;gBAC5C,KAAK,EAAE,EAAE,MAAM,EAAE,eAAe,EAAE;gBAClC,SAAS,EAAE,IAAK;aAChB,CAAC,CAAC,CAAC;QAEJ,KAAK,CAAC,GAAG,CAAC,cAAc,CAAC,6BAA6B,CAAC,aAAa,EAAE;YACrE,WAAW,EAAE,KAAK,CAAC,IAAI;YACvB,4BAA4B,EAAE,KAAK,IAAI,EAAE;gBACxC,MAAM,aAAa,GAAG;oBACrB;wBACC,SAAS,EAAE,wBAAwB,CAAC,UAAU;wBAC9C,IAAI,EAAE,aAAa;wBACnB,MAAM,EAAE,aAAa;wBACrB,MAAM,EAAE,aAAa;wBACrB,OAAO,EAAE,cAAc;wBACvB,mBAAmB,EAAE,SAAS;wBAC9B,EAAE,EAAE,WAAW;wBACf,cAAc,EAAE,GAAG;wBACnB,eAAe,EAAE,GAAG;qBACpB;oBACD;wBACC,SAAS,EAAE,wBAAwB,CAAC,UAAU;wBAC9C,IAAI,EAAE,aAAa;wBACnB,MAAM,EAAE,aAAa;wBACrB,MAAM,EAAE,cAAc;wBACtB,OAAO,EAAE,eAAe;wBACxB,mBAAmB,EAAE,SAAS;wBAC9B,EAAE,EAAE,YAAY;wBAChB,cAAc,EAAE,GAAG;wBACnB,eAAe,EAAE,GAAG;qBACpB;iBACD,CAAC;gBACF,MAAM,0BAA0B,GAAG,aAAa,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;oBAC1D,QAAQ,EAAE,CAAC;oBACX,UAAU,EAAE,CAAC,CAAC,EAAE;iBAChB,CAAC,CAAC,CAAC;gBACJ,OAAO,0BAA0B,CAAC;YACnC,CAAC;YACD,eAAe,EAAE,KAAK,IAAI,EAAE;gBAC3B,MAAM,IAAI,KAAK,EAAE,CAAC;YACnB,CAAC;YACD,iBAAiB,EAAE,KAAK,IAAI,EAAE;gBAC7B,MAAM,IAAI,KAAK,EAAE,CAAC;YACnB,CAAC;SACD,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC;QACR,cAAc,CAAC,OAAO,EAAE,CAAC;QACzB,gBAAgB,CAAC,KAAK,EAAE,CAAC;QACzB,KAAK,CAAC,KAAK,EAAE,CAAC;IACf,CAAC,CAAC,CAAC;IAEH,uCAAuC,EAAE,CAAC;IAE1C,IAAI,CAAC,4BAA4B,EAAE,KAAK;QAEvC,MAAM,OAAO,GAAG,MAAM,cAAc,CAAC,oBAAoB,CAAC,EAAE,CAAC,CAAC;QAC9D,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QAC1C,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,WAAW,CAAC,CAAC;QAChD,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,YAAY,CAAC,CAAC;IAClD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,iCAAiC,EAAE,KAAK;QAC5C,MAAM,OAAO,GAAG,MAAM,cAAc,CAAC,oBAAoB,CAAC,EAAE,EAAE,EAAE,WAAW,EAAE,CAAC,CAAC;QAC/E,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QAC1C,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,WAAW,CAAC,CAAC;IACjD,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,wDAAwD,EAAE,KAAK;QACnE,MAAM,OAAO,GAAG,MAAM,cAAc,CAAC,oBAAoB,CAAC,EAAE,MAAM,EAAE,aAAa,EAAE,CAAC,CAAC;QACrF,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QAE1C,MAAM,OAAO,GAAG,MAAM,cAAc,CAAC,oBAAoB,CAAC,EAAE,MAAM,EAAE,aAAa,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,CAAC;QACrG,MAAM,CAAC,eAAe,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;IAC3C,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,2CAA2C,EAAE,KAAK;QAEtD,KAAK,CAAC,GAAG,CAAC,cAAc,CAAC,6BAA6B,CAAC,eAAe,EAAE;YACvE,WAAW,EAAE,KAAK,CAAC,IAAI;YACvB,4BAA4B,EAAE,KAAK,IAAI,EAAE;gBACxC,MAAM,aAAa,GAAG;oBACrB;wBACC,SAAS,EAAE,wBAAwB,CAAC,UAAU;wBAC9C,IAAI,EAAE,aAAa;wBACnB,MAAM,EAAE,eAAe;wBACvB,MAAM,EAAE,eAAe;wBACvB,OAAO,EAAE,gBAAgB;wBACzB,EAAE,EAAE,WAAW;wBACf,cAAc,EAAE,GAAG;wBACnB,eAAe,EAAE,GAAG;wBACpB,mBAAmB,EAAE,6BAA6B;qBAClD;iBACD,CAAC;gBACF,MAAM,0BAA0B,GAAG,aAAa,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;oBAC1D,QAAQ,EAAE,CAAC;oBACX,UAAU,EAAE,CAAC,CAAC,EAAE;iBAChB,CAAC,CAAC,CAAC;gBACJ,OAAO,0BAA0B,CAAC;YACnC,CAAC;YACD,eAAe,EAAE,KAAK,EAAE,OAAe,EAAE,QAAwB,EAAE,KAA0B,EAAE,QAAiC,EAAE,KAAwB,EAAE,EAAE;gBAC7J,mCAAmC;gBAEnC,MAAM,KAAK,GAAG,IAAI,eAAe,EAAE,CAAC;gBACpC,MAAM,MAAM,GAAG,IAAI,mBAAmB,EAAqB,CAAC;gBAE5D,CAAC,KAAK,IAAI,EAAE;oBACX,OAAO,CAAC,KAAK,CAAC,uBAAuB,EAAE,CAAC;wBACvC,MAAM,CAAC,OAAO,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,CAAC,GAAG,EAAE,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;wBAC/D,MAAM,OAAO,CAAC,EAAE,CAAC,CAAC;oBACnB,CAAC;oBACD,KAAK,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;gBAC3B,CAAC,CAAC,EAAE,CAAC;gBAEL,OAAO;oBACN,MAAM,EAAE,MAAM,CAAC,aAAa;oBAC5B,MAAM,EAAE,KAAK,CAAC,CAAC;iBACf,CAAC;YACH,CAAC;YACD,iBAAiB,EAAE,KAAK,IAAI,EAAE;gBAC7B,MAAM,IAAI,KAAK,EAAE,CAAC;YACnB,CAAC;SACD,CAAC,CAAC,CAAC;QAEJ,qDAAqD;QACrD,MAAM,GAAG,GAAG,kBAAkB,CAAC,kBAAkB,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,uCAAuC,CAAC,IAAI,CAAE,CAAC;QACxH,GAAG,CAAC,WAAW,CAAC,CAAC;gBAChB,WAAW,EAAE,EAAE,GAAG,wBAAwB,EAAE;gBAC5C,KAAK,EAAE,EAAE,MAAM,EAAE,eAAe,EAAE;gBAClC,SAAS,EAAE,IAAK;aAChB,CAAC,CAAC,CAAC;QAEJ,MAAM,MAAM,GAAG,MAAM,cAAc,CAAC,oBAAoB,CAAC,EAAE,EAAE,EAAE,WAAW,EAAE,CAAC,CAAC;QAC9E,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC;QAE/B,MAAM,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;QAExB,MAAM,GAAG,GAAG,IAAI,uBAAuB,EAAE,CAAC;QAE1C,MAAM,OAAO,GAAG,MAAM,cAAc,CAAC,eAAe,CAAC,KAAK,EAAE,wBAAwB,CAAC,UAAU,EAAE,CAAC,EAAE,IAAI,8BAAsB,EAAE,OAAO,EAAE,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,EAAE,GAAG,CAAC,KAAK,CAAC,CAAC;QAE/L,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC;QAEnB,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QAElB,MAAM,OAAO,CAAC,MAAM,CAAC;IACtB,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,2CAA2C,EAAE,KAAK;QACtD,MAAM,OAAO,GAAG,cAAc,CAAC,UAAU,EAAE,CAAC;QAC5C,oFAAoF;QACpF,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM,IAAI,CAAC,CAAC,CAAC;QAC/B,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,aAAa,CAAC,CAAC,CAAC;QACzD,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,eAAe,CAAC,CAAC,CAAC;IAC5D,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAEH,KAAK,CAAC,8BAA8B,EAAE;IAErC,MAAM,qBAAsB,SAAQ,qBAAqB;QAC/C,mBAAmB,CAAC,KAA2B;YACvD,IAAI,CAAC,KAAK,EAAE,CAAC;gBACZ,OAAO,IAAI,CAAC;YACb,CAAC;YACD,yCAAyC;YACzC,MAAM,IAAI,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;YAC1B,KAAK,MAAM,GAAG,IAAI,IAAI,EAAE,CAAC;gBACxB,MAAM,UAAU,GAAG,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC;gBAChD,oDAAoD;gBACpD,IAAI,UAAU,EAAE,CAAC;oBAChB,OAAO,IAAI,CAAC;gBACb,CAAC;YACF,CAAC;YACD,OAAO,KAAK,CAAC;QACd,CAAC;KACD;IAED,IAAI,sBAA6C,CAAC;IAClD,IAAI,iBAAwC,CAAC;IAE7C,KAAK,CAAC;QACL,iBAAiB,GAAG,IAAI,qBAAqB,EAAE,CAAC;QAChD,iBAAiB,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;QAE7C,sBAAsB,GAAG,IAAI,qBAAqB,CACjD,IAAI,KAAM,SAAQ,IAAI,EAAqB;YACjC,eAAe,CAAC,IAAY;gBACpC,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;YAC1B,CAAC;SACD,EACD,IAAI,cAAc,EAAE,EACpB,IAAI,kBAAkB,EAAE,EACxB,iBAAiB,EACjB,IAAI,wBAAwB,EAAE,EAC9B,IAAI,0BAA0B,EAAE,CAChC,CAAC;QAEF,MAAM,GAAG,GAAG,kBAAkB,CAAC,kBAAkB,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,uCAAuC,CAAC,IAAI,CAAE,CAAC;QAExH,GAAG,CAAC,WAAW,CAAC,CAAC;gBAChB,WAAW,EAAE,EAAE,GAAG,wBAAwB,EAAE;gBAC5C,KAAK,EAAE,EAAE,MAAM,EAAE,gBAAgB,EAAE,WAAW,EAAE,gBAAgB,EAAE;gBAClE,SAAS,EAAE,IAAK;aAChB,EAAE;gBACF,WAAW,EAAE,EAAE,GAAG,wBAAwB,EAAE;gBAC5C,KAAK,EAAE,EAAE,MAAM,EAAE,oBAAoB,EAAE,WAAW,EAAE,oBAAoB,EAAE,IAAI,EAAE,SAAS,EAAE;gBAC3F,SAAS,EAAE,IAAK;aAChB,EAAE;gBACF,WAAW,EAAE,EAAE,GAAG,wBAAwB,EAAE;gBAC5C,KAAK,EAAE,EAAE,MAAM,EAAE,eAAe,EAAE,WAAW,EAAE,eAAe,EAAE,IAAI,EAAE,UAAU,EAAE;gBAClF,SAAS,EAAE,IAAK;aAChB,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC;QACR,sBAAsB,CAAC,OAAO,EAAE,CAAC;IAClC,CAAC,CAAC,CAAC;IAEH,uCAAuC,EAAE,CAAC;IAE1C,IAAI,CAAC,uCAAuC,EAAE,KAAK;QAClD,MAAM,OAAO,GAAG,sBAAsB,CAAC,UAAU,EAAE,CAAC;QACpD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;QACtC,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,gBAAgB,CAAC,CAAC,CAAC;QAC5D,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,oBAAoB,CAAC,CAAC,CAAC;QAChE,MAAM,CAAC,EAAE,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,eAAe,CAAC,CAAC,CAAC;IAC7D,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,wDAAwD,EAAE,KAAK;QACnE,MAAM,OAAO,GAAG,sBAAsB,CAAC,UAAU,EAAE,CAAC;QACpD,MAAM,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,oBAAoB,CAAC,EAAE,2DAA2D,CAAC,CAAC;IAC9H,CAAC,CAAC,CAAC;IAEH,IAAI,CAAC,0DAA0D,EAAE,KAAK;QACrE,MAAM,OAAO,GAAG,sBAAsB,CAAC,UAAU,EAAE,CAAC;QACpD,MAAM,CAAC,EAAE,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,eAAe,CAAC,EAAE,uDAAuD,CAAC,CAAC;IACtH,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC","file":"languageModels.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { AsyncIterableSource, DeferredPromise, timeout } from '../../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../../base/common/cancellation.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { NullLogService } from '../../../../../platform/log/common/log.js';\nimport { ChatMessageRole, languageModelChatProviderExtensionPoint, LanguageModelsService, IChatMessage, IChatResponsePart } from '../../common/languageModels.js';\nimport { IExtensionService, nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { ExtensionsRegistry } from '../../../../services/extensions/common/extensionsRegistry.js';\nimport { DEFAULT_MODEL_PICKER_CATEGORY } from '../../common/modelPicker/modelPickerWidget.js';\nimport { ExtensionIdentifier } from '../../../../../platform/extensions/common/extensions.js';\nimport { TestChatEntitlementService, TestStorageService } from '../../../../test/common/workbenchTestServices.js';\nimport { Event } from '../../../../../base/common/event.js';\nimport { MockContextKeyService } from '../../../../../platform/keybinding/test/common/mockKeybindingService.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { ContextKeyExpression } from '../../../../../platform/contextkey/common/contextkey.js';\n\nsuite('LanguageModels', function () {\n\n\tlet languageModels: LanguageModelsService;\n\n\tconst store = new DisposableStore();\n\tconst activationEvents = new Set<string>();\n\n\tsetup(function () {\n\n\t\tlanguageModels = new LanguageModelsService(\n\t\t\tnew class extends mock<IExtensionService>() {\n\t\t\t\toverride activateByEvent(name: string) {\n\t\t\t\t\tactivationEvents.add(name);\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t}\n\t\t\t},\n\t\t\tnew NullLogService(),\n\t\t\tnew TestStorageService(),\n\t\t\tnew MockContextKeyService(),\n\t\t\tnew TestConfigurationService(),\n\t\t\tnew TestChatEntitlementService()\n\t\t);\n\n\t\tconst ext = ExtensionsRegistry.getExtensionPoints().find(e => e.name === languageModelChatProviderExtensionPoint.name)!;\n\n\t\text.acceptUsers([{\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'test-vendor' },\n\t\t\tcollector: null!\n\t\t}, {\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'actual-vendor' },\n\t\t\tcollector: null!\n\t\t}]);\n\n\t\tstore.add(languageModels.registerLanguageModelProvider('test-vendor', {\n\t\t\tonDidChange: Event.None,\n\t\t\tprovideLanguageModelChatInfo: async () => {\n\t\t\t\tconst modelMetadata = [\n\t\t\t\t\t{\n\t\t\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\t\t\tname: 'Pretty Name',\n\t\t\t\t\t\tvendor: 'test-vendor',\n\t\t\t\t\t\tfamily: 'test-family',\n\t\t\t\t\t\tversion: 'test-version',\n\t\t\t\t\t\tmodelPickerCategory: undefined,\n\t\t\t\t\t\tid: 'test-id-1',\n\t\t\t\t\t\tmaxInputTokens: 100,\n\t\t\t\t\t\tmaxOutputTokens: 100,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\t\t\tname: 'Pretty Name',\n\t\t\t\t\t\tvendor: 'test-vendor',\n\t\t\t\t\t\tfamily: 'test2-family',\n\t\t\t\t\t\tversion: 'test2-version',\n\t\t\t\t\t\tmodelPickerCategory: undefined,\n\t\t\t\t\t\tid: 'test-id-12',\n\t\t\t\t\t\tmaxInputTokens: 100,\n\t\t\t\t\t\tmaxOutputTokens: 100,\n\t\t\t\t\t}\n\t\t\t\t];\n\t\t\t\tconst modelMetadataAndIdentifier = modelMetadata.map(m => ({\n\t\t\t\t\tmetadata: m,\n\t\t\t\t\tidentifier: m.id,\n\t\t\t\t}));\n\t\t\t\treturn modelMetadataAndIdentifier;\n\t\t\t},\n\t\t\tsendChatRequest: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t},\n\t\t\tprovideTokenCount: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t}\n\t\t}));\n\t});\n\n\tteardown(function () {\n\t\tlanguageModels.dispose();\n\t\tactivationEvents.clear();\n\t\tstore.clear();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('empty selector returns all', async function () {\n\n\t\tconst result1 = await languageModels.selectLanguageModels({});\n\t\tassert.deepStrictEqual(result1.length, 2);\n\t\tassert.deepStrictEqual(result1[0], 'test-id-1');\n\t\tassert.deepStrictEqual(result1[1], 'test-id-12');\n\t});\n\n\ttest('selector with id works properly', async function () {\n\t\tconst result1 = await languageModels.selectLanguageModels({ id: 'test-id-1' });\n\t\tassert.deepStrictEqual(result1.length, 1);\n\t\tassert.deepStrictEqual(result1[0], 'test-id-1');\n\t});\n\n\ttest('no warning that a matching model was not found #213716', async function () {\n\t\tconst result1 = await languageModels.selectLanguageModels({ vendor: 'test-vendor' });\n\t\tassert.deepStrictEqual(result1.length, 2);\n\n\t\tconst result2 = await languageModels.selectLanguageModels({ vendor: 'test-vendor', family: 'FAKE' });\n\t\tassert.deepStrictEqual(result2.length, 0);\n\t});\n\n\ttest('sendChatRequest returns a response-stream', async function () {\n\n\t\tstore.add(languageModels.registerLanguageModelProvider('actual-vendor', {\n\t\t\tonDidChange: Event.None,\n\t\t\tprovideLanguageModelChatInfo: async () => {\n\t\t\t\tconst modelMetadata = [\n\t\t\t\t\t{\n\t\t\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\t\t\tname: 'Pretty Name',\n\t\t\t\t\t\tvendor: 'actual-vendor',\n\t\t\t\t\t\tfamily: 'actual-family',\n\t\t\t\t\t\tversion: 'actual-version',\n\t\t\t\t\t\tid: 'actual-lm',\n\t\t\t\t\t\tmaxInputTokens: 100,\n\t\t\t\t\t\tmaxOutputTokens: 100,\n\t\t\t\t\t\tmodelPickerCategory: DEFAULT_MODEL_PICKER_CATEGORY,\n\t\t\t\t\t}\n\t\t\t\t];\n\t\t\t\tconst modelMetadataAndIdentifier = modelMetadata.map(m => ({\n\t\t\t\t\tmetadata: m,\n\t\t\t\t\tidentifier: m.id,\n\t\t\t\t}));\n\t\t\t\treturn modelMetadataAndIdentifier;\n\t\t\t},\n\t\t\tsendChatRequest: async (modelId: string, messages: IChatMessage[], _from: ExtensionIdentifier, _options: { [name: string]: any }, token: CancellationToken) => {\n\t\t\t\t// const message = messages.at(-1);\n\n\t\t\t\tconst defer = new DeferredPromise();\n\t\t\t\tconst stream = new AsyncIterableSource<IChatResponsePart>();\n\n\t\t\t\t(async () => {\n\t\t\t\t\twhile (!token.isCancellationRequested) {\n\t\t\t\t\t\tstream.emitOne({ type: 'text', value: Date.now().toString() });\n\t\t\t\t\t\tawait timeout(10);\n\t\t\t\t\t}\n\t\t\t\t\tdefer.complete(undefined);\n\t\t\t\t})();\n\n\t\t\t\treturn {\n\t\t\t\t\tstream: stream.asyncIterable,\n\t\t\t\t\tresult: defer.p\n\t\t\t\t};\n\t\t\t},\n\t\t\tprovideTokenCount: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t}\n\t\t}));\n\n\t\t// Register the extension point for the actual vendor\n\t\tconst ext = ExtensionsRegistry.getExtensionPoints().find(e => e.name === languageModelChatProviderExtensionPoint.name)!;\n\t\text.acceptUsers([{\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'actual-vendor' },\n\t\t\tcollector: null!\n\t\t}]);\n\n\t\tconst models = await languageModels.selectLanguageModels({ id: 'actual-lm' });\n\t\tassert.ok(models.length === 1);\n\n\t\tconst first = models[0];\n\n\t\tconst cts = new CancellationTokenSource();\n\n\t\tconst request = await languageModels.sendChatRequest(first, nullExtensionDescription.identifier, [{ role: ChatMessageRole.User, content: [{ type: 'text', value: 'hello' }] }], {}, cts.token);\n\n\t\tassert.ok(request);\n\n\t\tcts.dispose(true);\n\n\t\tawait request.result;\n\t});\n\n\ttest('when clause defaults to true when omitted', async function () {\n\t\tconst vendors = languageModels.getVendors();\n\t\t// Both test-vendor and actual-vendor have no when clause, so they should be visible\n\t\tassert.ok(vendors.length >= 2);\n\t\tassert.ok(vendors.some(v => v.vendor === 'test-vendor'));\n\t\tassert.ok(vendors.some(v => v.vendor === 'actual-vendor'));\n\t});\n});\n\nsuite('LanguageModels - When Clause', function () {\n\n\tclass TestContextKeyService extends MockContextKeyService {\n\t\toverride contextMatchesRules(rules: ContextKeyExpression): boolean {\n\t\t\tif (!rules) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\t// Simple evaluation based on stored keys\n\t\t\tconst keys = rules.keys();\n\t\t\tfor (const key of keys) {\n\t\t\t\tconst contextKey = this.getContextKeyValue(key);\n\t\t\t\t// If the key exists and is truthy, the rule matches\n\t\t\t\tif (contextKey) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tlet languageModelsWithWhen: LanguageModelsService;\n\tlet contextKeyService: TestContextKeyService;\n\n\tsetup(function () {\n\t\tcontextKeyService = new TestContextKeyService();\n\t\tcontextKeyService.createKey('testKey', true);\n\n\t\tlanguageModelsWithWhen = new LanguageModelsService(\n\t\t\tnew class extends mock<IExtensionService>() {\n\t\t\t\toverride activateByEvent(name: string) {\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t}\n\t\t\t},\n\t\t\tnew NullLogService(),\n\t\t\tnew TestStorageService(),\n\t\t\tcontextKeyService,\n\t\t\tnew TestConfigurationService(),\n\t\t\tnew TestChatEntitlementService()\n\t\t);\n\n\t\tconst ext = ExtensionsRegistry.getExtensionPoints().find(e => e.name === languageModelChatProviderExtensionPoint.name)!;\n\n\t\text.acceptUsers([{\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'visible-vendor', displayName: 'Visible Vendor' },\n\t\t\tcollector: null!\n\t\t}, {\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'conditional-vendor', displayName: 'Conditional Vendor', when: 'testKey' },\n\t\t\tcollector: null!\n\t\t}, {\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'hidden-vendor', displayName: 'Hidden Vendor', when: 'falseKey' },\n\t\t\tcollector: null!\n\t\t}]);\n\t});\n\n\tteardown(function () {\n\t\tlanguageModelsWithWhen.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('when clause filters vendors correctly', async function () {\n\t\tconst vendors = languageModelsWithWhen.getVendors();\n\t\tassert.strictEqual(vendors.length, 2);\n\t\tassert.ok(vendors.some(v => v.vendor === 'visible-vendor'));\n\t\tassert.ok(vendors.some(v => v.vendor === 'conditional-vendor'));\n\t\tassert.ok(!vendors.some(v => v.vendor === 'hidden-vendor'));\n\t});\n\n\ttest('when clause evaluates to true when context key is true', async function () {\n\t\tconst vendors = languageModelsWithWhen.getVendors();\n\t\tassert.ok(vendors.some(v => v.vendor === 'conditional-vendor'), 'conditional-vendor should be visible when testKey is true');\n\t});\n\n\ttest('when clause evaluates to false when context key is false', async function () {\n\t\tconst vendors = languageModelsWithWhen.getVendors();\n\t\tassert.ok(!vendors.some(v => v.vendor === 'hidden-vendor'), 'hidden-vendor should be hidden when falseKey is false');\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { AsyncIterableSource, DeferredPromise, timeout } from '../../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../../base/common/cancellation.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { NullLogService } from '../../../../../platform/log/common/log.js';\nimport { ChatMessageRole, languageModelChatProviderExtensionPoint, LanguageModelsService, IChatMessage, IChatResponsePart } from '../../common/languageModels.js';\nimport { IExtensionService, nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { ExtensionsRegistry } from '../../../../services/extensions/common/extensionsRegistry.js';\nimport { DEFAULT_MODEL_PICKER_CATEGORY } from '../../common/modelPicker/modelPickerWidget.js';\nimport { ExtensionIdentifier } from '../../../../../platform/extensions/common/extensions.js';\nimport { TestChatEntitlementService, TestStorageService } from '../../../../test/common/workbenchTestServices.js';\nimport { Event } from '../../../../../base/common/event.js';\nimport { MockContextKeyService } from '../../../../../platform/keybinding/test/common/mockKeybindingService.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { ContextKeyExpression } from '../../../../../platform/contextkey/common/contextkey.js';\n\nsuite('LanguageModels', function () {\n\n\tlet languageModels: LanguageModelsService;\n\n\tconst store = new DisposableStore();\n\tconst activationEvents = new Set<string>();\n\n\tsetup(function () {\n\n\t\tlanguageModels = new LanguageModelsService(\n\t\t\tnew class extends mock<IExtensionService>() {\n\t\t\t\toverride activateByEvent(name: string) {\n\t\t\t\t\tactivationEvents.add(name);\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t}\n\t\t\t},\n\t\t\tnew NullLogService(),\n\t\t\tnew TestStorageService(),\n\t\t\tnew MockContextKeyService(),\n\t\t\tnew TestConfigurationService(),\n\t\t\tnew TestChatEntitlementService()\n\t\t);\n\n\t\tconst ext = ExtensionsRegistry.getExtensionPoints().find(e => e.name === languageModelChatProviderExtensionPoint.name)!;\n\n\t\text.acceptUsers([{\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'test-vendor' },\n\t\t\tcollector: null!\n\t\t}, {\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'actual-vendor' },\n\t\t\tcollector: null!\n\t\t}]);\n\n\t\tstore.add(languageModels.registerLanguageModelProvider('test-vendor', {\n\t\t\tonDidChange: Event.None,\n\t\t\tprovideLanguageModelChatInfo: async () => {\n\t\t\t\tconst modelMetadata = [\n\t\t\t\t\t{\n\t\t\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\t\t\tname: 'Pretty Name',\n\t\t\t\t\t\tvendor: 'test-vendor',\n\t\t\t\t\t\tfamily: 'test-family',\n\t\t\t\t\t\tversion: 'test-version',\n\t\t\t\t\t\tmodelPickerCategory: undefined,\n\t\t\t\t\t\tid: 'test-id-1',\n\t\t\t\t\t\tmaxInputTokens: 100,\n\t\t\t\t\t\tmaxOutputTokens: 100,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\t\t\tname: 'Pretty Name',\n\t\t\t\t\t\tvendor: 'test-vendor',\n\t\t\t\t\t\tfamily: 'test2-family',\n\t\t\t\t\t\tversion: 'test2-version',\n\t\t\t\t\t\tmodelPickerCategory: undefined,\n\t\t\t\t\t\tid: 'test-id-12',\n\t\t\t\t\t\tmaxInputTokens: 100,\n\t\t\t\t\t\tmaxOutputTokens: 100,\n\t\t\t\t\t}\n\t\t\t\t];\n\t\t\t\tconst modelMetadataAndIdentifier = modelMetadata.map(m => ({\n\t\t\t\t\tmetadata: m,\n\t\t\t\t\tidentifier: m.id,\n\t\t\t\t}));\n\t\t\t\treturn modelMetadataAndIdentifier;\n\t\t\t},\n\t\t\tsendChatRequest: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t},\n\t\t\tprovideTokenCount: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t}\n\t\t}));\n\t});\n\n\tteardown(function () {\n\t\tlanguageModels.dispose();\n\t\tactivationEvents.clear();\n\t\tstore.clear();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('empty selector returns all', async function () {\n\n\t\tconst result1 = await languageModels.selectLanguageModels({});\n\t\tassert.deepStrictEqual(result1.length, 2);\n\t\tassert.deepStrictEqual(result1[0], 'test-id-1');\n\t\tassert.deepStrictEqual(result1[1], 'test-id-12');\n\t});\n\n\ttest('selector with id works properly', async function () {\n\t\tconst result1 = await languageModels.selectLanguageModels({ id: 'test-id-1' });\n\t\tassert.deepStrictEqual(result1.length, 1);\n\t\tassert.deepStrictEqual(result1[0], 'test-id-1');\n\t});\n\n\ttest('no warning that a matching model was not found #213716', async function () {\n\t\tconst result1 = await languageModels.selectLanguageModels({ vendor: 'test-vendor' });\n\t\tassert.deepStrictEqual(result1.length, 2);\n\n\t\tconst result2 = await languageModels.selectLanguageModels({ vendor: 'test-vendor', family: 'FAKE' });\n\t\tassert.deepStrictEqual(result2.length, 0);\n\t});\n\n\ttest('sendChatRequest returns a response-stream', async function () {\n\n\t\tstore.add(languageModels.registerLanguageModelProvider('actual-vendor', {\n\t\t\tonDidChange: Event.None,\n\t\t\tprovideLanguageModelChatInfo: async () => {\n\t\t\t\tconst modelMetadata = [\n\t\t\t\t\t{\n\t\t\t\t\t\textension: nullExtensionDescription.identifier,\n\t\t\t\t\t\tname: 'Pretty Name',\n\t\t\t\t\t\tvendor: 'actual-vendor',\n\t\t\t\t\t\tfamily: 'actual-family',\n\t\t\t\t\t\tversion: 'actual-version',\n\t\t\t\t\t\tid: 'actual-lm',\n\t\t\t\t\t\tmaxInputTokens: 100,\n\t\t\t\t\t\tmaxOutputTokens: 100,\n\t\t\t\t\t\tmodelPickerCategory: DEFAULT_MODEL_PICKER_CATEGORY,\n\t\t\t\t\t}\n\t\t\t\t];\n\t\t\t\tconst modelMetadataAndIdentifier = modelMetadata.map(m => ({\n\t\t\t\t\tmetadata: m,\n\t\t\t\t\tidentifier: m.id,\n\t\t\t\t}));\n\t\t\t\treturn modelMetadataAndIdentifier;\n\t\t\t},\n\t\t\tsendChatRequest: async (modelId: string, messages: IChatMessage[], _from: ExtensionIdentifier, _options: { [name: string]: any }, token: CancellationToken) => {\n\t\t\t\t// const message = messages.at(-1);\n\n\t\t\t\tconst defer = new DeferredPromise();\n\t\t\t\tconst stream = new AsyncIterableSource<IChatResponsePart>();\n\n\t\t\t\t(async () => {\n\t\t\t\t\twhile (!token.isCancellationRequested) {\n\t\t\t\t\t\tstream.emitOne({ type: 'text', value: Date.now().toString() });\n\t\t\t\t\t\tawait timeout(10);\n\t\t\t\t\t}\n\t\t\t\t\tdefer.complete(undefined);\n\t\t\t\t})();\n\n\t\t\t\treturn {\n\t\t\t\t\tstream: stream.asyncIterable,\n\t\t\t\t\tresult: defer.p\n\t\t\t\t};\n\t\t\t},\n\t\t\tprovideTokenCount: async () => {\n\t\t\t\tthrow new Error();\n\t\t\t}\n\t\t}));\n\n\t\t// Register the extension point for the actual vendor\n\t\tconst ext = ExtensionsRegistry.getExtensionPoints().find(e => e.name === languageModelChatProviderExtensionPoint.name)!;\n\t\text.acceptUsers([{\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'actual-vendor' },\n\t\t\tcollector: null!\n\t\t}]);\n\n\t\tconst models = await languageModels.selectLanguageModels({ id: 'actual-lm' });\n\t\tassert.ok(models.length === 1);\n\n\t\tconst first = models[0];\n\n\t\tconst cts = new CancellationTokenSource();\n\n\t\tconst request = await languageModels.sendChatRequest(first, nullExtensionDescription.identifier, [{ role: ChatMessageRole.User, content: [{ type: 'text', value: 'hello' }] }], {}, cts.token);\n\n\t\tassert.ok(request);\n\n\t\tcts.dispose(true);\n\n\t\tawait request.result;\n\t});\n\n\ttest('when clause defaults to true when omitted', async function () {\n\t\tconst vendors = languageModels.getVendors();\n\t\t// Both test-vendor and actual-vendor have no when clause, so they should be visible\n\t\tassert.ok(vendors.length >= 2);\n\t\tassert.ok(vendors.some(v => v.vendor === 'test-vendor'));\n\t\tassert.ok(vendors.some(v => v.vendor === 'actual-vendor'));\n\t});\n});\n\nsuite('LanguageModels - When Clause', function () {\n\n\tclass TestContextKeyService extends MockContextKeyService {\n\t\toverride contextMatchesRules(rules: ContextKeyExpression): boolean {\n\t\t\tif (!rules) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\t// Simple evaluation based on stored keys\n\t\t\tconst keys = rules.keys();\n\t\t\tfor (const key of keys) {\n\t\t\t\tconst contextKey = this.getContextKeyValue(key);\n\t\t\t\t// If the key exists and is truthy, the rule matches\n\t\t\t\tif (contextKey) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tlet languageModelsWithWhen: LanguageModelsService;\n\tlet contextKeyService: TestContextKeyService;\n\n\tsetup(function () {\n\t\tcontextKeyService = new TestContextKeyService();\n\t\tcontextKeyService.createKey('testKey', true);\n\n\t\tlanguageModelsWithWhen = new LanguageModelsService(\n\t\t\tnew class extends mock<IExtensionService>() {\n\t\t\t\toverride activateByEvent(name: string) {\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t}\n\t\t\t},\n\t\t\tnew NullLogService(),\n\t\t\tnew TestStorageService(),\n\t\t\tcontextKeyService,\n\t\t\tnew TestConfigurationService(),\n\t\t\tnew TestChatEntitlementService()\n\t\t);\n\n\t\tconst ext = ExtensionsRegistry.getExtensionPoints().find(e => e.name === languageModelChatProviderExtensionPoint.name)!;\n\n\t\text.acceptUsers([{\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'visible-vendor', displayName: 'Visible Vendor' },\n\t\t\tcollector: null!\n\t\t}, {\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'conditional-vendor', displayName: 'Conditional Vendor', when: 'testKey' },\n\t\t\tcollector: null!\n\t\t}, {\n\t\t\tdescription: { ...nullExtensionDescription },\n\t\t\tvalue: { vendor: 'hidden-vendor', displayName: 'Hidden Vendor', when: 'falseKey' },\n\t\t\tcollector: null!\n\t\t}]);\n\t});\n\n\tteardown(function () {\n\t\tlanguageModelsWithWhen.dispose();\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('when clause filters vendors correctly', async function () {\n\t\tconst vendors = languageModelsWithWhen.getVendors();\n\t\tassert.strictEqual(vendors.length, 2);\n\t\tassert.ok(vendors.some(v => v.vendor === 'visible-vendor'));\n\t\tassert.ok(vendors.some(v => v.vendor === 'conditional-vendor'));\n\t\tassert.ok(!vendors.some(v => v.vendor === 'hidden-vendor'));\n\t});\n\n\ttest('when clause evaluates to true when context key is true', async function () {\n\t\tconst vendors = languageModelsWithWhen.getVendors();\n\t\tassert.ok(vendors.some(v => v.vendor === 'conditional-vendor'), 'conditional-vendor should be visible when testKey is true');\n\t});\n\n\ttest('when clause evaluates to false when context key is false', async function () {\n\t\tconst vendors = languageModelsWithWhen.getVendors();\n\t\tassert.ok(!vendors.some(v => v.vendor === 'hidden-vendor'), 'hidden-vendor should be hidden when falseKey is false');\n\t});\n});\n"]}