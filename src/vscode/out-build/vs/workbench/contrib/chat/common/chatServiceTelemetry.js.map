{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/common/chatServiceTelemetry.ts","vs/workbench/contrib/chat/common/chatServiceTelemetry.ts"],"names":[],"mappings":"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","file":"chatServiceTelemetry.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { URI } from '../../../../base/common/uri.js';\nimport { isLocation } from '../../../../editor/common/languages.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IChatAgentData } from './chatAgents.js';\nimport { ChatRequestModel, IChatRequestVariableData } from './chatModel.js';\nimport { ChatRequestAgentSubcommandPart, ChatRequestSlashCommandPart } from './chatParserTypes.js';\nimport { ChatAgentVoteDirection, ChatCopyKind, IChatSendRequestOptions, IChatUserActionEvent } from './chatService.js';\nimport { isImageVariableEntry } from './chatVariableEntries.js';\nimport { ChatAgentLocation } from './constants.js';\nimport { ILanguageModelsService } from './languageModels.js';\n\ntype ChatVoteEvent = {\n\tdirection: 'up' | 'down';\n\tagentId: string;\n\tcommand: string | undefined;\n\treason: string | undefined;\n};\n\ntype ChatVoteClassification = {\n\tdirection: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the user voted up or down.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat agent that this vote is for.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the slash command that this vote is for.' };\n\treason: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The reason selected by the user for voting down.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the performance of Chat agents.';\n};\n\ntype ChatCopyEvent = {\n\tcopyKind: 'action' | 'toolbar';\n\tagentId: string;\n\tcommand: string | undefined;\n};\n\ntype ChatCopyClassification = {\n\tcopyKind: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'How the copy was initiated.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat agent that the copy acted on.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the slash command the copy acted on.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatInsertEvent = {\n\tnewFile: boolean;\n\tagentId: string;\n\tcommand: string | undefined;\n};\n\ntype ChatInsertClassification = {\n\tnewFile: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the code was inserted into a new untitled file.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat agent that this insertion is for.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the slash command that this insertion is for.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatApplyEvent = {\n\tnewFile: boolean;\n\tagentId: string;\n\tcommand: string | undefined;\n\tcodeMapper: string | undefined;\n\teditsProposed: boolean;\n};\n\ntype ChatApplyClassification = {\n\tnewFile: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the code was inserted into a new untitled file.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat agent that this insertion is for.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the slash command that this insertion is for.' };\n\tcodeMapper: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The code mapper that wa used to compute the edit.' };\n\teditsProposed: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether there was a change proposed to the user.' };\n\towner: 'aeschli';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatFollowupEvent = {\n\tagentId: string;\n\tcommand: string | undefined;\n};\n\ntype ChatFollowupClassification = {\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the related chat agent.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the related slash command.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatTerminalEvent = {\n\tlanguageId: string;\n\tagentId: string;\n\tcommand: string | undefined;\n};\n\ntype ChatTerminalClassification = {\n\tlanguageId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The language of the code that was run in the terminal.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the related chat agent.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the related slash command.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatFollowupsRetrievedEvent = {\n\tagentId: string;\n\tcommand: string | undefined;\n\tnumFollowups: number;\n};\n\ntype ChatFollowupsRetrievedClassification = {\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the related chat agent.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the related slash command.' };\n\tnumFollowups: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of followup prompts returned by the agent.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatEditHunkEvent = {\n\tagentId: string;\n\toutcome: 'accepted' | 'rejected';\n\tlineCount: number;\n\thasRemainingEdits: boolean;\n};\n\ntype ChatEditHunkClassification = {\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the related chat agent.' };\n\toutcome: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The outcome of the edit hunk action.' };\n\tlineCount: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of lines in the relevant change.' };\n\thasRemainingEdits: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether there are remaining edits in the file after this action.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\nexport type ChatProviderInvokedEvent = {\n\ttimeToFirstProgress: number | undefined;\n\ttotalTime: number | undefined;\n\tresult: 'success' | 'error' | 'errorWithOutput' | 'cancelled' | 'filtered';\n\trequestType: 'string' | 'followup' | 'slashCommand';\n\tchatSessionId: string;\n\tagent: string;\n\tagentExtensionId: string | undefined;\n\tslashCommand: string | undefined;\n\tlocation: ChatAgentLocation;\n\tcitations: number;\n\tnumCodeBlocks: number;\n\tisParticipantDetected: boolean;\n\tenableCommandDetection: boolean;\n\tattachmentKinds: string[];\n\tmodel: string | undefined;\n};\n\nexport type ChatProviderInvokedClassification = {\n\ttimeToFirstProgress: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time in milliseconds from invoking the provider to getting the first data.' };\n\ttotalTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The total time it took to run the provider\\'s `provideResponseWithProgress`.' };\n\tresult: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether invoking the ChatProvider resulted in an error.' };\n\trequestType: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The type of request that the user made.' };\n\tchatSessionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'A random ID for the session.' };\n\tagent: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The type of agent used.' };\n\tagentExtensionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The extension that contributed the agent.' };\n\tslashCommand?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The type of slashCommand used.' };\n\tlocation: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The location at which chat request was made.' };\n\tcitations: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of public code citations that were returned with the response.' };\n\tnumCodeBlocks: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of code blocks in the response.' };\n\tisParticipantDetected: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the participant was automatically detected.' };\n\tenableCommandDetection: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether participation detection was disabled for this invocation.' };\n\tattachmentKinds: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The types of variables/attachments that the user included with their query.' };\n\tmodel: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The model used to generate the response.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the performance of Chat agents.';\n};\n\nexport class ChatServiceTelemetry {\n\tconstructor(\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t) { }\n\n\tnotifyUserAction(action: IChatUserActionEvent): void {\n\t\tif (action.action.kind === 'vote') {\n\t\t\tthis.telemetryService.publicLog2<ChatVoteEvent, ChatVoteClassification>('interactiveSessionVote', {\n\t\t\t\tdirection: action.action.direction === ChatAgentVoteDirection.Up ? 'up' : 'down',\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t\treason: action.action.reason,\n\t\t\t});\n\t\t} else if (action.action.kind === 'copy') {\n\t\t\tthis.telemetryService.publicLog2<ChatCopyEvent, ChatCopyClassification>('interactiveSessionCopy', {\n\t\t\t\tcopyKind: action.action.copyKind === ChatCopyKind.Action ? 'action' : 'toolbar',\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t});\n\t\t} else if (action.action.kind === 'insert') {\n\t\t\tthis.telemetryService.publicLog2<ChatInsertEvent, ChatInsertClassification>('interactiveSessionInsert', {\n\t\t\t\tnewFile: !!action.action.newFile,\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t});\n\t\t} else if (action.action.kind === 'apply') {\n\t\t\tthis.telemetryService.publicLog2<ChatApplyEvent, ChatApplyClassification>('interactiveSessionApply', {\n\t\t\t\tnewFile: !!action.action.newFile,\n\t\t\t\tcodeMapper: action.action.codeMapper,\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t\teditsProposed: !!action.action.editsProposed,\n\t\t\t});\n\t\t} else if (action.action.kind === 'runInTerminal') {\n\t\t\tthis.telemetryService.publicLog2<ChatTerminalEvent, ChatTerminalClassification>('interactiveSessionRunInTerminal', {\n\t\t\t\tlanguageId: action.action.languageId ?? '',\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t});\n\t\t} else if (action.action.kind === 'followUp') {\n\t\t\tthis.telemetryService.publicLog2<ChatFollowupEvent, ChatFollowupClassification>('chatFollowupClicked', {\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t});\n\t\t} else if (action.action.kind === 'chatEditingHunkAction') {\n\t\t\tthis.telemetryService.publicLog2<ChatEditHunkEvent, ChatEditHunkClassification>('chatEditHunk', {\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\toutcome: action.action.outcome,\n\t\t\t\tlineCount: action.action.lineCount,\n\t\t\t\thasRemainingEdits: action.action.hasRemainingEdits,\n\t\t\t});\n\t\t}\n\t}\n\n\tretrievedFollowups(agentId: string, command: string | undefined, numFollowups: number): void {\n\t\tthis.telemetryService.publicLog2<ChatFollowupsRetrievedEvent, ChatFollowupsRetrievedClassification>('chatFollowupsRetrieved', {\n\t\t\tagentId,\n\t\t\tcommand,\n\t\t\tnumFollowups,\n\t\t});\n\t}\n}\n\nfunction getCodeBlocks(text: string): string[] {\n\tconst lines = text.split('\\n');\n\tconst codeBlockLanguages: string[] = [];\n\n\tlet codeBlockState: undefined | { readonly delimiter: string; readonly languageId: string };\n\tfor (let i = 0; i < lines.length; i++) {\n\t\tconst line = lines[i];\n\n\t\tif (codeBlockState) {\n\t\t\tif (new RegExp(`^\\\\s*${codeBlockState.delimiter}\\\\s*$`).test(line)) {\n\t\t\t\tcodeBlockLanguages.push(codeBlockState.languageId);\n\t\t\t\tcodeBlockState = undefined;\n\t\t\t}\n\t\t} else {\n\t\t\tconst match = line.match(/^(\\s*)(`{3,}|~{3,})(\\w*)/);\n\t\t\tif (match) {\n\t\t\t\tcodeBlockState = { delimiter: match[2], languageId: match[3] };\n\t\t\t}\n\t\t}\n\t}\n\treturn codeBlockLanguages;\n}\n\nexport class ChatRequestTelemetry {\n\tprivate isComplete = false;\n\n\tconstructor(private readonly opts: {\n\t\tagent: IChatAgentData;\n\t\tagentSlashCommandPart: ChatRequestAgentSubcommandPart | undefined;\n\t\tcommandPart: ChatRequestSlashCommandPart | undefined;\n\t\tsessionId: string;\n\t\tlocation: ChatAgentLocation;\n\t\toptions: IChatSendRequestOptions | undefined;\n\t\tenableCommandDetection: boolean;\n\t},\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@ILanguageModelsService private readonly languageModelsService: ILanguageModelsService\n\t) { }\n\n\tcomplete({ timeToFirstProgress, totalTime, result, requestType, request, detectedAgent }: {\n\t\ttimeToFirstProgress: number | undefined;\n\t\ttotalTime: number | undefined;\n\t\tresult: ChatProviderInvokedEvent['result'];\n\t\trequestType: ChatProviderInvokedEvent['requestType'];\n\t\t// Should rearrange so these 2 can be in the constructor\n\t\trequest: ChatRequestModel;\n\t\tdetectedAgent: IChatAgentData | undefined;\n\t}) {\n\t\tif (this.isComplete) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.isComplete = true;\n\t\tthis.telemetryService.publicLog2<ChatProviderInvokedEvent, ChatProviderInvokedClassification>('interactiveSessionProviderInvoked', {\n\t\t\ttimeToFirstProgress,\n\t\t\ttotalTime,\n\t\t\tresult,\n\t\t\trequestType,\n\t\t\tagent: detectedAgent?.id ?? this.opts.agent.id,\n\t\t\tagentExtensionId: detectedAgent?.extensionId.value ?? this.opts.agent.extensionId.value,\n\t\t\tslashCommand: this.opts.agentSlashCommandPart ? this.opts.agentSlashCommandPart.command.name : this.opts.commandPart?.slashCommand.command,\n\t\t\tchatSessionId: this.opts.sessionId,\n\t\t\tenableCommandDetection: this.opts.enableCommandDetection,\n\t\t\tisParticipantDetected: !!detectedAgent,\n\t\t\tlocation: this.opts.location,\n\t\t\tcitations: request.response?.codeCitations.length ?? 0,\n\t\t\tnumCodeBlocks: getCodeBlocks(request.response?.response.toString() ?? '').length,\n\t\t\tattachmentKinds: this.attachmentKindsForTelemetry(request.variableData),\n\t\t\tmodel: this.resolveModelId(this.opts.options?.userSelectedModelId),\n\t\t});\n\t}\n\n\tprivate attachmentKindsForTelemetry(variableData: IChatRequestVariableData): string[] {\n\t\t// this shows why attachments still have to be cleaned up somewhat\n\t\treturn variableData.variables.map(v => {\n\t\t\tif (v.kind === 'implicit') {\n\t\t\t\treturn 'implicit';\n\t\t\t} else if (v.range) {\n\t\t\t\t// 'range' is range within the prompt text\n\t\t\t\tif (v.kind === 'tool') {\n\t\t\t\t\treturn 'toolInPrompt';\n\t\t\t\t} else if (v.kind === 'toolset') {\n\t\t\t\t\treturn 'toolsetInPrompt';\n\t\t\t\t} else {\n\t\t\t\t\treturn 'fileInPrompt';\n\t\t\t\t}\n\t\t\t} else if (v.kind === 'command') {\n\t\t\t\treturn 'command';\n\t\t\t} else if (v.kind === 'symbol') {\n\t\t\t\treturn 'symbol';\n\t\t\t} else if (isImageVariableEntry(v)) {\n\t\t\t\treturn 'image';\n\t\t\t} else if (v.kind === 'directory') {\n\t\t\t\treturn 'directory';\n\t\t\t} else if (v.kind === 'tool') {\n\t\t\t\treturn 'tool';\n\t\t\t} else if (v.kind === 'toolset') {\n\t\t\t\treturn 'toolset';\n\t\t\t} else {\n\t\t\t\tif (URI.isUri(v.value)) {\n\t\t\t\t\treturn 'file';\n\t\t\t\t} else if (isLocation(v.value)) {\n\t\t\t\t\treturn 'location';\n\t\t\t\t} else {\n\t\t\t\t\treturn 'otherAttachment';\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate resolveModelId(userSelectedModelId: string | undefined): string | undefined {\n\t\treturn userSelectedModelId && this.languageModelsService.lookupLanguageModel(userSelectedModelId)?.id;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { URI } from '../../../../base/common/uri.js';\nimport { isLocation } from '../../../../editor/common/languages.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IChatAgentData } from './chatAgents.js';\nimport { ChatRequestModel, IChatRequestVariableData } from './chatModel.js';\nimport { ChatRequestAgentSubcommandPart, ChatRequestSlashCommandPart } from './chatParserTypes.js';\nimport { ChatAgentVoteDirection, ChatCopyKind, IChatSendRequestOptions, IChatUserActionEvent } from './chatService.js';\nimport { isImageVariableEntry } from './chatVariableEntries.js';\nimport { ChatAgentLocation } from './constants.js';\nimport { ILanguageModelsService } from './languageModels.js';\n\ntype ChatVoteEvent = {\n\tdirection: 'up' | 'down';\n\tagentId: string;\n\tcommand: string | undefined;\n\treason: string | undefined;\n};\n\ntype ChatVoteClassification = {\n\tdirection: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the user voted up or down.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat agent that this vote is for.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the slash command that this vote is for.' };\n\treason: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The reason selected by the user for voting down.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the performance of Chat agents.';\n};\n\ntype ChatCopyEvent = {\n\tcopyKind: 'action' | 'toolbar';\n\tagentId: string;\n\tcommand: string | undefined;\n};\n\ntype ChatCopyClassification = {\n\tcopyKind: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'How the copy was initiated.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat agent that the copy acted on.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the slash command the copy acted on.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatInsertEvent = {\n\tnewFile: boolean;\n\tagentId: string;\n\tcommand: string | undefined;\n};\n\ntype ChatInsertClassification = {\n\tnewFile: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the code was inserted into a new untitled file.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat agent that this insertion is for.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the slash command that this insertion is for.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatApplyEvent = {\n\tnewFile: boolean;\n\tagentId: string;\n\tcommand: string | undefined;\n\tcodeMapper: string | undefined;\n\teditsProposed: boolean;\n};\n\ntype ChatApplyClassification = {\n\tnewFile: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the code was inserted into a new untitled file.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat agent that this insertion is for.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the slash command that this insertion is for.' };\n\tcodeMapper: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The code mapper that wa used to compute the edit.' };\n\teditsProposed: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether there was a change proposed to the user.' };\n\towner: 'aeschli';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatFollowupEvent = {\n\tagentId: string;\n\tcommand: string | undefined;\n};\n\ntype ChatFollowupClassification = {\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the related chat agent.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the related slash command.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatTerminalEvent = {\n\tlanguageId: string;\n\tagentId: string;\n\tcommand: string | undefined;\n};\n\ntype ChatTerminalClassification = {\n\tlanguageId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The language of the code that was run in the terminal.' };\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the related chat agent.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the related slash command.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatFollowupsRetrievedEvent = {\n\tagentId: string;\n\tcommand: string | undefined;\n\tnumFollowups: number;\n};\n\ntype ChatFollowupsRetrievedClassification = {\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the related chat agent.' };\n\tcommand: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The name of the related slash command.' };\n\tnumFollowups: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of followup prompts returned by the agent.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\ntype ChatEditHunkEvent = {\n\tagentId: string;\n\toutcome: 'accepted' | 'rejected';\n\tlineCount: number;\n\thasRemainingEdits: boolean;\n};\n\ntype ChatEditHunkClassification = {\n\tagentId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the related chat agent.' };\n\toutcome: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The outcome of the edit hunk action.' };\n\tlineCount: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of lines in the relevant change.' };\n\thasRemainingEdits: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether there are remaining edits in the file after this action.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of Chat features.';\n};\n\nexport type ChatProviderInvokedEvent = {\n\ttimeToFirstProgress: number | undefined;\n\ttotalTime: number | undefined;\n\tresult: 'success' | 'error' | 'errorWithOutput' | 'cancelled' | 'filtered';\n\trequestType: 'string' | 'followup' | 'slashCommand';\n\tchatSessionId: string;\n\tagent: string;\n\tagentExtensionId: string | undefined;\n\tslashCommand: string | undefined;\n\tlocation: ChatAgentLocation;\n\tcitations: number;\n\tnumCodeBlocks: number;\n\tisParticipantDetected: boolean;\n\tenableCommandDetection: boolean;\n\tattachmentKinds: string[];\n\tmodel: string | undefined;\n};\n\nexport type ChatProviderInvokedClassification = {\n\ttimeToFirstProgress: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time in milliseconds from invoking the provider to getting the first data.' };\n\ttotalTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The total time it took to run the provider\\'s `provideResponseWithProgress`.' };\n\tresult: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether invoking the ChatProvider resulted in an error.' };\n\trequestType: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The type of request that the user made.' };\n\tchatSessionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'A random ID for the session.' };\n\tagent: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The type of agent used.' };\n\tagentExtensionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The extension that contributed the agent.' };\n\tslashCommand?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The type of slashCommand used.' };\n\tlocation: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The location at which chat request was made.' };\n\tcitations: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of public code citations that were returned with the response.' };\n\tnumCodeBlocks: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The number of code blocks in the response.' };\n\tisParticipantDetected: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether the participant was automatically detected.' };\n\tenableCommandDetection: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether participation detection was disabled for this invocation.' };\n\tattachmentKinds: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The types of variables/attachments that the user included with their query.' };\n\tmodel: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The model used to generate the response.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the performance of Chat agents.';\n};\n\nexport class ChatServiceTelemetry {\n\tconstructor(\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t) { }\n\n\tnotifyUserAction(action: IChatUserActionEvent): void {\n\t\tif (action.action.kind === 'vote') {\n\t\t\tthis.telemetryService.publicLog2<ChatVoteEvent, ChatVoteClassification>('interactiveSessionVote', {\n\t\t\t\tdirection: action.action.direction === ChatAgentVoteDirection.Up ? 'up' : 'down',\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t\treason: action.action.reason,\n\t\t\t});\n\t\t} else if (action.action.kind === 'copy') {\n\t\t\tthis.telemetryService.publicLog2<ChatCopyEvent, ChatCopyClassification>('interactiveSessionCopy', {\n\t\t\t\tcopyKind: action.action.copyKind === ChatCopyKind.Action ? 'action' : 'toolbar',\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t});\n\t\t} else if (action.action.kind === 'insert') {\n\t\t\tthis.telemetryService.publicLog2<ChatInsertEvent, ChatInsertClassification>('interactiveSessionInsert', {\n\t\t\t\tnewFile: !!action.action.newFile,\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t});\n\t\t} else if (action.action.kind === 'apply') {\n\t\t\tthis.telemetryService.publicLog2<ChatApplyEvent, ChatApplyClassification>('interactiveSessionApply', {\n\t\t\t\tnewFile: !!action.action.newFile,\n\t\t\t\tcodeMapper: action.action.codeMapper,\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t\teditsProposed: !!action.action.editsProposed,\n\t\t\t});\n\t\t} else if (action.action.kind === 'runInTerminal') {\n\t\t\tthis.telemetryService.publicLog2<ChatTerminalEvent, ChatTerminalClassification>('interactiveSessionRunInTerminal', {\n\t\t\t\tlanguageId: action.action.languageId ?? '',\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t});\n\t\t} else if (action.action.kind === 'followUp') {\n\t\t\tthis.telemetryService.publicLog2<ChatFollowupEvent, ChatFollowupClassification>('chatFollowupClicked', {\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\tcommand: action.command,\n\t\t\t});\n\t\t} else if (action.action.kind === 'chatEditingHunkAction') {\n\t\t\tthis.telemetryService.publicLog2<ChatEditHunkEvent, ChatEditHunkClassification>('chatEditHunk', {\n\t\t\t\tagentId: action.agentId ?? '',\n\t\t\t\toutcome: action.action.outcome,\n\t\t\t\tlineCount: action.action.lineCount,\n\t\t\t\thasRemainingEdits: action.action.hasRemainingEdits,\n\t\t\t});\n\t\t}\n\t}\n\n\tretrievedFollowups(agentId: string, command: string | undefined, numFollowups: number): void {\n\t\tthis.telemetryService.publicLog2<ChatFollowupsRetrievedEvent, ChatFollowupsRetrievedClassification>('chatFollowupsRetrieved', {\n\t\t\tagentId,\n\t\t\tcommand,\n\t\t\tnumFollowups,\n\t\t});\n\t}\n}\n\nfunction getCodeBlocks(text: string): string[] {\n\tconst lines = text.split('\\n');\n\tconst codeBlockLanguages: string[] = [];\n\n\tlet codeBlockState: undefined | { readonly delimiter: string; readonly languageId: string };\n\tfor (let i = 0; i < lines.length; i++) {\n\t\tconst line = lines[i];\n\n\t\tif (codeBlockState) {\n\t\t\tif (new RegExp(`^\\\\s*${codeBlockState.delimiter}\\\\s*$`).test(line)) {\n\t\t\t\tcodeBlockLanguages.push(codeBlockState.languageId);\n\t\t\t\tcodeBlockState = undefined;\n\t\t\t}\n\t\t} else {\n\t\t\tconst match = line.match(/^(\\s*)(`{3,}|~{3,})(\\w*)/);\n\t\t\tif (match) {\n\t\t\t\tcodeBlockState = { delimiter: match[2], languageId: match[3] };\n\t\t\t}\n\t\t}\n\t}\n\treturn codeBlockLanguages;\n}\n\nexport class ChatRequestTelemetry {\n\tprivate isComplete = false;\n\n\tconstructor(private readonly opts: {\n\t\tagent: IChatAgentData;\n\t\tagentSlashCommandPart: ChatRequestAgentSubcommandPart | undefined;\n\t\tcommandPart: ChatRequestSlashCommandPart | undefined;\n\t\tsessionId: string;\n\t\tlocation: ChatAgentLocation;\n\t\toptions: IChatSendRequestOptions | undefined;\n\t\tenableCommandDetection: boolean;\n\t},\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@ILanguageModelsService private readonly languageModelsService: ILanguageModelsService\n\t) { }\n\n\tcomplete({ timeToFirstProgress, totalTime, result, requestType, request, detectedAgent }: {\n\t\ttimeToFirstProgress: number | undefined;\n\t\ttotalTime: number | undefined;\n\t\tresult: ChatProviderInvokedEvent['result'];\n\t\trequestType: ChatProviderInvokedEvent['requestType'];\n\t\t// Should rearrange so these 2 can be in the constructor\n\t\trequest: ChatRequestModel;\n\t\tdetectedAgent: IChatAgentData | undefined;\n\t}) {\n\t\tif (this.isComplete) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.isComplete = true;\n\t\tthis.telemetryService.publicLog2<ChatProviderInvokedEvent, ChatProviderInvokedClassification>('interactiveSessionProviderInvoked', {\n\t\t\ttimeToFirstProgress,\n\t\t\ttotalTime,\n\t\t\tresult,\n\t\t\trequestType,\n\t\t\tagent: detectedAgent?.id ?? this.opts.agent.id,\n\t\t\tagentExtensionId: detectedAgent?.extensionId.value ?? this.opts.agent.extensionId.value,\n\t\t\tslashCommand: this.opts.agentSlashCommandPart ? this.opts.agentSlashCommandPart.command.name : this.opts.commandPart?.slashCommand.command,\n\t\t\tchatSessionId: this.opts.sessionId,\n\t\t\tenableCommandDetection: this.opts.enableCommandDetection,\n\t\t\tisParticipantDetected: !!detectedAgent,\n\t\t\tlocation: this.opts.location,\n\t\t\tcitations: request.response?.codeCitations.length ?? 0,\n\t\t\tnumCodeBlocks: getCodeBlocks(request.response?.response.toString() ?? '').length,\n\t\t\tattachmentKinds: this.attachmentKindsForTelemetry(request.variableData),\n\t\t\tmodel: this.resolveModelId(this.opts.options?.userSelectedModelId),\n\t\t});\n\t}\n\n\tprivate attachmentKindsForTelemetry(variableData: IChatRequestVariableData): string[] {\n\t\t// this shows why attachments still have to be cleaned up somewhat\n\t\treturn variableData.variables.map(v => {\n\t\t\tif (v.kind === 'implicit') {\n\t\t\t\treturn 'implicit';\n\t\t\t} else if (v.range) {\n\t\t\t\t// 'range' is range within the prompt text\n\t\t\t\tif (v.kind === 'tool') {\n\t\t\t\t\treturn 'toolInPrompt';\n\t\t\t\t} else if (v.kind === 'toolset') {\n\t\t\t\t\treturn 'toolsetInPrompt';\n\t\t\t\t} else {\n\t\t\t\t\treturn 'fileInPrompt';\n\t\t\t\t}\n\t\t\t} else if (v.kind === 'command') {\n\t\t\t\treturn 'command';\n\t\t\t} else if (v.kind === 'symbol') {\n\t\t\t\treturn 'symbol';\n\t\t\t} else if (isImageVariableEntry(v)) {\n\t\t\t\treturn 'image';\n\t\t\t} else if (v.kind === 'directory') {\n\t\t\t\treturn 'directory';\n\t\t\t} else if (v.kind === 'tool') {\n\t\t\t\treturn 'tool';\n\t\t\t} else if (v.kind === 'toolset') {\n\t\t\t\treturn 'toolset';\n\t\t\t} else {\n\t\t\t\tif (URI.isUri(v.value)) {\n\t\t\t\t\treturn 'file';\n\t\t\t\t} else if (isLocation(v.value)) {\n\t\t\t\t\treturn 'location';\n\t\t\t\t} else {\n\t\t\t\t\treturn 'otherAttachment';\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate resolveModelId(userSelectedModelId: string | undefined): string | undefined {\n\t\treturn userSelectedModelId && this.languageModelsService.lookupLanguageModel(userSelectedModelId)?.id;\n\t}\n}\n"]}