{"version":3,"sources":["vs/workbench/contrib/chat/common/chatEditingService.ts"],"names":[],"mappings":"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","file":"chatEditingService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { decodeHex, encodeHex, VSBuffer } from '../../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { Event } from '../../../../base/common/event.js';\nimport { IDisposable } from '../../../../base/common/lifecycle.js';\nimport { autorunSelfDisposable, IObservable, IReader } from '../../../../base/common/observable.js';\nimport { hasKey } from '../../../../base/common/types.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IDocumentDiff } from '../../../../editor/common/diff/documentDiffProvider.js';\nimport { Location, TextEdit } from '../../../../editor/common/languages.js';\nimport { ITextModel } from '../../../../editor/common/model.js';\nimport { EditSuggestionId } from '../../../../editor/common/textModelEditSource.js';\nimport { localize } from '../../../../nls.js';\nimport { RawContextKey } from '../../../../platform/contextkey/common/contextkey.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IEditorPane } from '../../../common/editor.js';\nimport { ICellEditOperation } from '../../notebook/common/notebookCommon.js';\nimport { IChatAgentResult } from './chatAgents.js';\nimport { ChatModel, IChatRequestDisablement, IChatResponseModel } from './chatModel.js';\nimport { IChatProgress } from './chatService.js';\n\nexport const IChatEditingService = createDecorator<IChatEditingService>('chatEditingService');\n\nexport interface IChatEditingService {\n\n\t_serviceBrand: undefined;\n\n\tstartOrContinueGlobalEditingSession(chatModel: ChatModel): IChatEditingSession;\n\n\tgetEditingSession(chatSessionResource: URI): IChatEditingSession | undefined;\n\n\t/**\n\t * All editing sessions, sorted by recency, e.g the last created session comes first.\n\t */\n\treadonly editingSessionsObs: IObservable<readonly IChatEditingSession[]>;\n\n\t/**\n\t * Creates a new short lived editing session\n\t */\n\tcreateEditingSession(chatModel: ChatModel): IChatEditingSession;\n\n\t/**\n\t * Creates an editing session with state transferred from the provided session.\n\t */\n\ttransferEditingSession(chatModel: ChatModel, session: IChatEditingSession): IChatEditingSession;\n\n\t//#region related files\n\n\thasRelatedFilesProviders(): boolean;\n\tregisterRelatedFilesProvider(handle: number, provider: IChatRelatedFilesProvider): IDisposable;\n\tgetRelatedFiles(chatSessionResource: URI, prompt: string, files: URI[], token: CancellationToken): Promise<{ group: string; files: IChatRelatedFile[] }[] | undefined>;\n\n\t//#endregion\n}\n\nexport interface IChatRequestDraft {\n\treadonly prompt: string;\n\treadonly files: readonly URI[];\n}\n\nexport interface IChatRelatedFileProviderMetadata {\n\treadonly description: string;\n}\n\nexport interface IChatRelatedFile {\n\treadonly uri: URI;\n\treadonly description: string;\n}\n\nexport interface IChatRelatedFilesProvider {\n\treadonly description: string;\n\tprovideRelatedFiles(chatRequest: IChatRequestDraft, token: CancellationToken): Promise<IChatRelatedFile[] | undefined>;\n}\n\nexport interface WorkingSetDisplayMetadata {\n\tstate: ModifiedFileEntryState;\n\tdescription?: string;\n}\n\nexport interface IStreamingEdits {\n\tpushText(edits: TextEdit[], isLastEdits: boolean): void;\n\tpushNotebookCellText(cell: URI, edits: TextEdit[], isLastEdits: boolean): void;\n\tpushNotebook(edits: ICellEditOperation[], isLastEdits: boolean): void;\n\t/** Marks edits as done, idempotent */\n\tcomplete(): void;\n}\n\nexport interface IModifiedEntryTelemetryInfo {\n\treadonly agentId: string | undefined;\n\treadonly command: string | undefined;\n\treadonly sessionResource: URI;\n\treadonly requestId: string;\n\treadonly result: IChatAgentResult | undefined;\n\treadonly modelId: string | undefined;\n\treadonly modeId: 'ask' | 'edit' | 'agent' | 'custom' | 'applyCodeBlock' | undefined;\n\treadonly applyCodeBlockSuggestionId: EditSuggestionId | undefined;\n\treadonly feature: 'sideBarChat' | 'inlineChat' | undefined;\n}\n\nexport interface ISnapshotEntry {\n\treadonly resource: URI;\n\treadonly languageId: string;\n\treadonly snapshotUri: URI;\n\treadonly original: string;\n\treadonly current: string;\n\treadonly state: ModifiedFileEntryState;\n\ttelemetryInfo: IModifiedEntryTelemetryInfo;\n}\n\nexport interface IChatEditingSession extends IDisposable {\n\treadonly isGlobalEditingSession: boolean;\n\treadonly chatSessionResource: URI;\n\treadonly onDidDispose: Event<void>;\n\treadonly state: IObservable<ChatEditingSessionState>;\n\treadonly entries: IObservable<readonly IModifiedFileEntry[]>;\n\t/** Requests disabled by undo/redo in the session */\n\treadonly requestDisablement: IObservable<IChatRequestDisablement[]>;\n\n\tshow(previousChanges?: boolean): Promise<void>;\n\taccept(...uris: URI[]): Promise<void>;\n\treject(...uris: URI[]): Promise<void>;\n\tgetEntry(uri: URI): IModifiedFileEntry | undefined;\n\treadEntry(uri: URI, reader: IReader): IModifiedFileEntry | undefined;\n\n\trestoreSnapshot(requestId: string, stopId: string | undefined): Promise<void>;\n\n\t/**\n\t * Marks all edits to the given resources as agent edits until\n\t * {@link stopExternalEdits} is called with the same ID. This is used for\n\t * agents that make changes on-disk rather than streaming edits through the\n\t * chat session.\n\t */\n\tstartExternalEdits(responseModel: IChatResponseModel, operationId: number, resources: URI[]): Promise<IChatProgress[]>;\n\tstopExternalEdits(responseModel: IChatResponseModel, operationId: number): Promise<IChatProgress[]>;\n\n\t/**\n\t * Gets the snapshot URI of a file at the request and _after_ changes made in the undo stop.\n\t * @param uri File in the workspace\n\t */\n\tgetSnapshotUri(requestId: string, uri: URI, stopId: string | undefined): URI | undefined;\n\n\tgetSnapshotContents(requestId: string, uri: URI, stopId: string | undefined): Promise<VSBuffer | undefined>;\n\tgetSnapshotModel(requestId: string, undoStop: string | undefined, snapshotUri: URI): Promise<ITextModel | null>;\n\n\t/**\n\t * Will lead to this object getting disposed\n\t */\n\tstop(clearState?: boolean): Promise<void>;\n\n\t/**\n\t * Starts making edits to the resource.\n\t * @param resource URI that's being edited\n\t * @param responseModel The response model making the edits\n\t * @param inUndoStop The undo stop the edits will be grouped in\n\t */\n\tstartStreamingEdits(resource: URI, responseModel: IChatResponseModel, inUndoStop: string | undefined): IStreamingEdits;\n\n\t/**\n\t * Gets the document diff of a change made to a URI between one undo stop and\n\t * the next one.\n\t * @returns The observable or undefined if there is no diff between the stops.\n\t */\n\tgetEntryDiffBetweenStops(uri: URI, requestId: string | undefined, stopId: string | undefined): IObservable<IEditSessionEntryDiff | undefined> | undefined;\n\n\t/**\n\t * Gets the document diff of a change made to a URI between one request to another one.\n\t * @returns The observable or undefined if there is no diff between the requests.\n\t */\n\tgetEntryDiffBetweenRequests(uri: URI, startRequestIs: string, stopRequestId: string): IObservable<IEditSessionEntryDiff | undefined>;\n\n\treadonly canUndo: IObservable<boolean>;\n\treadonly canRedo: IObservable<boolean>;\n\tundoInteraction(): Promise<void>;\n\tredoInteraction(): Promise<void>;\n}\n\nexport function chatEditingSessionIsReady(session: IChatEditingSession): Promise<void> {\n\treturn new Promise<void>(resolve => {\n\t\tautorunSelfDisposable(reader => {\n\t\t\tconst state = session.state.read(reader);\n\t\t\tif (state !== ChatEditingSessionState.Initial) {\n\t\t\t\treader.dispose();\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t});\n}\n\nexport interface IEditSessionEntryDiff {\n\t/** LHS and RHS of a diff editor, if opened: */\n\toriginalURI: URI;\n\tmodifiedURI: URI;\n\n\t/** Diff state information: */\n\tquitEarly: boolean;\n\tidentical: boolean;\n\n\t/** True if nothing else will be added to this diff. */\n\tisFinal: boolean;\n\n\t/** Added data (e.g. line numbers) to show in the UI */\n\tadded: number;\n\t/** Removed data (e.g. line numbers) to show in the UI */\n\tremoved: number;\n}\n\nexport const enum ModifiedFileEntryState {\n\tModified,\n\tAccepted,\n\tRejected,\n}\n\n/**\n * Represents a part of a change\n */\nexport interface IModifiedFileEntryChangeHunk {\n\taccept(): Promise<boolean>;\n\treject(): Promise<boolean>;\n}\n\nexport interface IModifiedFileEntryEditorIntegration extends IDisposable {\n\n\t/**\n\t * The index of a change\n\t */\n\tcurrentIndex: IObservable<number>;\n\n\t/**\n\t * Reveal the first (`true`) or last (`false`) change\n\t */\n\treveal(firstOrLast: boolean, preserveFocus?: boolean): void;\n\n\t/**\n\t * Go to next change and increate `currentIndex`\n\t * @param wrap When at the last, start over again or not\n\t * @returns If it went next\n\t */\n\tnext(wrap: boolean): boolean;\n\n\t/**\n\t * @see `next`\n\t */\n\tprevious(wrap: boolean): boolean;\n\n\t/**\n\t * Enable the accessible diff viewer for this editor\n\t */\n\tenableAccessibleDiffView(): void;\n\n\t/**\n\t * Accept the change given or the nearest\n\t * @param change An opaque change object\n\t */\n\tacceptNearestChange(change?: IModifiedFileEntryChangeHunk): Promise<void>;\n\n\t/**\n\t * @see `acceptNearestChange`\n\t */\n\trejectNearestChange(change?: IModifiedFileEntryChangeHunk): Promise<void>;\n\n\t/**\n\t * Toggle between diff-editor and normal editor\n\t * @param change An opaque change object\n\t * @param show Optional boolean to control if the diff should show\n\t */\n\ttoggleDiff(change: IModifiedFileEntryChangeHunk | undefined, show?: boolean): Promise<void>;\n}\n\nexport interface IModifiedFileEntry {\n\treadonly entryId: string;\n\treadonly originalURI: URI;\n\treadonly modifiedURI: URI;\n\n\treadonly lastModifyingRequestId: string;\n\n\treadonly state: IObservable<ModifiedFileEntryState>;\n\treadonly isCurrentlyBeingModifiedBy: IObservable<{ responseModel: IChatResponseModel; undoStopId: string | undefined } | undefined>;\n\treadonly lastModifyingResponse: IObservable<IChatResponseModel | undefined>;\n\treadonly rewriteRatio: IObservable<number>;\n\n\treadonly waitsForLastEdits: IObservable<boolean>;\n\n\taccept(): Promise<void>;\n\treject(): Promise<void>;\n\n\treviewMode: IObservable<boolean>;\n\tautoAcceptController: IObservable<{ total: number; remaining: number; cancel(): void } | undefined>;\n\tenableReviewModeUntilSettled(): void;\n\n\t/**\n\t * Number of changes for this file\n\t */\n\treadonly changesCount: IObservable<number>;\n\n\t/**\n\t * Diff information for this entry\n\t */\n\treadonly diffInfo?: IObservable<IDocumentDiff>;\n\n\t/**\n\t * Number of lines added in this entry.\n\t */\n\treadonly linesAdded?: IObservable<number>;\n\n\t/**\n\t * Number of lines removed in this entry\n\t */\n\treadonly linesRemoved?: IObservable<number>;\n\n\tgetEditorIntegration(editor: IEditorPane): IModifiedFileEntryEditorIntegration;\n\thasModificationAt(location: Location): boolean;\n}\n\nexport interface IChatEditingSessionStream {\n\ttextEdits(resource: URI, textEdits: TextEdit[], isLastEdits: boolean, responseModel: IChatResponseModel): void;\n\tnotebookEdits(resource: URI, edits: ICellEditOperation[], isLastEdits: boolean, responseModel: IChatResponseModel): void;\n}\n\nexport const enum ChatEditingSessionState {\n\tInitial = 0,\n\tStreamingEdits = 1,\n\tIdle = 2,\n\tDisposed = 3\n}\n\nexport const CHAT_EDITING_MULTI_DIFF_SOURCE_RESOLVER_SCHEME = 'chat-editing-multi-diff-source';\n\nexport const chatEditingWidgetFileStateContextKey = new RawContextKey<ModifiedFileEntryState>('chatEditingWidgetFileState', undefined, localize('chatEditingWidgetFileState', \"The current state of the file in the chat editing widget\"));\nexport const chatEditingAgentSupportsReadonlyReferencesContextKey = new RawContextKey<boolean>('chatEditingAgentSupportsReadonlyReferences', undefined, localize('chatEditingAgentSupportsReadonlyReferences', \"Whether the chat editing agent supports readonly references (temporary)\"));\nexport const decidedChatEditingResourceContextKey = new RawContextKey<string[]>('decidedChatEditingResource', []);\nexport const chatEditingResourceContextKey = new RawContextKey<string | undefined>('chatEditingResource', undefined);\nexport const inChatEditingSessionContextKey = new RawContextKey<boolean | undefined>('inChatEditingSession', undefined);\nexport const hasUndecidedChatEditingResourceContextKey = new RawContextKey<boolean | undefined>('hasUndecidedChatEditingResource', false);\nexport const hasAppliedChatEditsContextKey = new RawContextKey<boolean | undefined>('hasAppliedChatEdits', false);\nexport const applyingChatEditsFailedContextKey = new RawContextKey<boolean | undefined>('applyingChatEditsFailed', false);\n\nexport const chatEditingMaxFileAssignmentName = 'chatEditingSessionFileLimit';\nexport const defaultChatEditingMaxFileLimit = 10;\n\nexport const enum ChatEditKind {\n\tCreated,\n\tModified,\n}\n\nexport interface IChatEditingActionContext {\n\t// The chat session that this editing session is associated with\n\tsessionResource: URI;\n}\n\nexport function isChatEditingActionContext(thing: unknown): thing is IChatEditingActionContext {\n\treturn typeof thing === 'object' && !!thing && hasKey(thing, { sessionResource: true });\n}\n\nexport function getMultiDiffSourceUri(session: IChatEditingSession, showPreviousChanges?: boolean): URI {\n\treturn URI.from({\n\t\tscheme: CHAT_EDITING_MULTI_DIFF_SOURCE_RESOLVER_SCHEME,\n\t\tauthority: encodeHex(VSBuffer.fromString(session.chatSessionResource.toString())),\n\t\tquery: showPreviousChanges ? 'previous' : undefined,\n\t});\n}\n\nexport function parseChatMultiDiffUri(uri: URI): { chatSessionResource: URI; showPreviousChanges: boolean } {\n\tconst chatSessionResource = URI.parse(decodeHex(uri.authority).toString());\n\tconst showPreviousChanges = uri.query === 'previous';\n\n\treturn { chatSessionResource, showPreviousChanges };\n}\n"]}