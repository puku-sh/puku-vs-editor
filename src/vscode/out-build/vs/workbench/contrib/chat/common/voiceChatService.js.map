{"version":3,"sources":["vs/workbench/contrib/chat/common/voiceChatService.ts"],"names":[],"mappings":"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","file":"voiceChatService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { localize } from '../../../../nls.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable, DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { rtrim } from '../../../../base/common/strings.js';\nimport { IContextKey, IContextKeyService, RawContextKey } from '../../../../platform/contextkey/common/contextkey.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IChatAgentService } from './chatAgents.js';\nimport { IChatModel } from './chatModel.js';\nimport { chatAgentLeader, chatSubcommandLeader } from './chatParserTypes.js';\nimport { ISpeechService, ISpeechToTextEvent, SpeechToTextStatus } from '../../speech/common/speechService.js';\n\nexport const IVoiceChatService = createDecorator<IVoiceChatService>('voiceChatService');\n\nexport interface IVoiceChatSessionOptions {\n\treadonly usesAgents?: boolean;\n\treadonly model?: IChatModel;\n}\n\nexport interface IVoiceChatService {\n\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * Similar to `ISpeechService.createSpeechToTextSession`, but with\n\t * support for agent prefixes and command prefixes. For example,\n\t * if the user says \"at workspace slash fix this problem\", the result\n\t * will be \"@workspace /fix this problem\".\n\t */\n\tcreateVoiceChatSession(token: CancellationToken, options: IVoiceChatSessionOptions): Promise<IVoiceChatSession>;\n}\n\nexport interface IVoiceChatTextEvent extends ISpeechToTextEvent {\n\n\t/**\n\t * This property will be `true` when the text recognized\n\t * so far only consists of agent prefixes (`@workspace`)\n\t * and/or command prefixes (`@workspace /fix`).\n\t */\n\treadonly waitingForInput?: boolean;\n}\n\nexport interface IVoiceChatSession {\n\treadonly onDidChange: Event<IVoiceChatTextEvent>;\n}\n\ninterface IPhraseValue {\n\treadonly agent: string;\n\treadonly command?: string;\n}\n\nenum PhraseTextType {\n\tAGENT = 1,\n\tCOMMAND = 2,\n\tAGENT_AND_COMMAND = 3\n}\n\nexport const VoiceChatInProgress = new RawContextKey<boolean>('voiceChatInProgress', false, { type: 'boolean', description: localize('voiceChatInProgress', \"A speech-to-text session is in progress for chat.\") });\n\nexport class VoiceChatService extends Disposable implements IVoiceChatService {\n\n\treadonly _serviceBrand: undefined;\n\n\tprivate static readonly AGENT_PREFIX = chatAgentLeader;\n\tprivate static readonly COMMAND_PREFIX = chatSubcommandLeader;\n\n\tprivate static readonly PHRASES_LOWER = {\n\t\t[this.AGENT_PREFIX]: 'at',\n\t\t[this.COMMAND_PREFIX]: 'slash'\n\t};\n\n\tprivate static readonly PHRASES_UPPER = {\n\t\t[this.AGENT_PREFIX]: 'At',\n\t\t[this.COMMAND_PREFIX]: 'Slash'\n\t};\n\n\tprivate static readonly CHAT_AGENT_ALIAS = new Map<string, string>([['vscode', 'code']]);\n\n\tprivate readonly voiceChatInProgress: IContextKey<boolean>;\n\tprivate activeVoiceChatSessions = 0;\n\n\tconstructor(\n\t\t@ISpeechService private readonly speechService: ISpeechService,\n\t\t@IChatAgentService private readonly chatAgentService: IChatAgentService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService\n\t) {\n\t\tsuper();\n\n\t\tthis.voiceChatInProgress = VoiceChatInProgress.bindTo(contextKeyService);\n\t}\n\n\tprivate createPhrases(model?: IChatModel): Map<string, IPhraseValue> {\n\t\tconst phrases = new Map<string, IPhraseValue>();\n\n\t\tfor (const agent of this.chatAgentService.getActivatedAgents()) {\n\t\t\tconst agentPhrase = `${VoiceChatService.PHRASES_LOWER[VoiceChatService.AGENT_PREFIX]} ${VoiceChatService.CHAT_AGENT_ALIAS.get(agent.name) ?? agent.name}`.toLowerCase();\n\t\t\tphrases.set(agentPhrase, { agent: agent.name });\n\n\t\t\tfor (const slashCommand of agent.slashCommands) {\n\t\t\t\tconst slashCommandPhrase = `${VoiceChatService.PHRASES_LOWER[VoiceChatService.COMMAND_PREFIX]} ${slashCommand.name}`.toLowerCase();\n\t\t\t\tphrases.set(slashCommandPhrase, { agent: agent.name, command: slashCommand.name });\n\n\t\t\t\tconst agentSlashCommandPhrase = `${agentPhrase} ${slashCommandPhrase}`.toLowerCase();\n\t\t\t\tphrases.set(agentSlashCommandPhrase, { agent: agent.name, command: slashCommand.name });\n\t\t\t}\n\t\t}\n\n\t\treturn phrases;\n\t}\n\n\tprivate toText(value: IPhraseValue, type: PhraseTextType): string {\n\t\tswitch (type) {\n\t\t\tcase PhraseTextType.AGENT:\n\t\t\t\treturn `${VoiceChatService.AGENT_PREFIX}${value.agent}`;\n\t\t\tcase PhraseTextType.COMMAND:\n\t\t\t\treturn `${VoiceChatService.COMMAND_PREFIX}${value.command}`;\n\t\t\tcase PhraseTextType.AGENT_AND_COMMAND:\n\t\t\t\treturn `${VoiceChatService.AGENT_PREFIX}${value.agent} ${VoiceChatService.COMMAND_PREFIX}${value.command}`;\n\t\t}\n\t}\n\n\tasync createVoiceChatSession(token: CancellationToken, options: IVoiceChatSessionOptions): Promise<IVoiceChatSession> {\n\t\tconst disposables = new DisposableStore();\n\n\t\tconst onSessionStoppedOrCanceled = (dispose: boolean) => {\n\t\t\tthis.activeVoiceChatSessions = Math.max(0, this.activeVoiceChatSessions - 1);\n\t\t\tif (this.activeVoiceChatSessions === 0) {\n\t\t\t\tthis.voiceChatInProgress.reset();\n\t\t\t}\n\n\t\t\tif (dispose) {\n\t\t\t\tdisposables.dispose();\n\t\t\t}\n\t\t};\n\n\t\tdisposables.add(token.onCancellationRequested(() => onSessionStoppedOrCanceled(true)));\n\n\t\tlet detectedAgent = false;\n\t\tlet detectedSlashCommand = false;\n\n\t\tconst emitter = disposables.add(new Emitter<IVoiceChatTextEvent>());\n\t\tconst session = await this.speechService.createSpeechToTextSession(token, 'chat');\n\n\t\tif (token.isCancellationRequested) {\n\t\t\tonSessionStoppedOrCanceled(true);\n\t\t}\n\n\t\tconst phrases = this.createPhrases(options.model);\n\t\tdisposables.add(session.onDidChange(e => {\n\t\t\tswitch (e.status) {\n\t\t\t\tcase SpeechToTextStatus.Recognizing:\n\t\t\t\tcase SpeechToTextStatus.Recognized: {\n\t\t\t\t\tlet massagedEvent: IVoiceChatTextEvent = e;\n\t\t\t\t\tif (e.text) {\n\t\t\t\t\t\tconst startsWithAgent = e.text.startsWith(VoiceChatService.PHRASES_UPPER[VoiceChatService.AGENT_PREFIX]) || e.text.startsWith(VoiceChatService.PHRASES_LOWER[VoiceChatService.AGENT_PREFIX]);\n\t\t\t\t\t\tconst startsWithSlashCommand = e.text.startsWith(VoiceChatService.PHRASES_UPPER[VoiceChatService.COMMAND_PREFIX]) || e.text.startsWith(VoiceChatService.PHRASES_LOWER[VoiceChatService.COMMAND_PREFIX]);\n\t\t\t\t\t\tif (startsWithAgent || startsWithSlashCommand) {\n\t\t\t\t\t\t\tconst originalWords = e.text.split(' ');\n\t\t\t\t\t\t\tlet transformedWords: string[] | undefined;\n\n\t\t\t\t\t\t\tlet waitingForInput = false;\n\n\t\t\t\t\t\t\t// Check for agent + slash command\n\t\t\t\t\t\t\tif (options.usesAgents && startsWithAgent && !detectedAgent && !detectedSlashCommand && originalWords.length >= 4) {\n\t\t\t\t\t\t\t\tconst phrase = phrases.get(originalWords.slice(0, 4).map(word => this.normalizeWord(word)).join(' '));\n\t\t\t\t\t\t\t\tif (phrase) {\n\t\t\t\t\t\t\t\t\ttransformedWords = [this.toText(phrase, PhraseTextType.AGENT_AND_COMMAND), ...originalWords.slice(4)];\n\n\t\t\t\t\t\t\t\t\twaitingForInput = originalWords.length === 4;\n\n\t\t\t\t\t\t\t\t\tif (e.status === SpeechToTextStatus.Recognized) {\n\t\t\t\t\t\t\t\t\t\tdetectedAgent = true;\n\t\t\t\t\t\t\t\t\t\tdetectedSlashCommand = true;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Check for agent (if not done already)\n\t\t\t\t\t\t\tif (options.usesAgents && startsWithAgent && !detectedAgent && !transformedWords && originalWords.length >= 2) {\n\t\t\t\t\t\t\t\tconst phrase = phrases.get(originalWords.slice(0, 2).map(word => this.normalizeWord(word)).join(' '));\n\t\t\t\t\t\t\t\tif (phrase) {\n\t\t\t\t\t\t\t\t\ttransformedWords = [this.toText(phrase, PhraseTextType.AGENT), ...originalWords.slice(2)];\n\n\t\t\t\t\t\t\t\t\twaitingForInput = originalWords.length === 2;\n\n\t\t\t\t\t\t\t\t\tif (e.status === SpeechToTextStatus.Recognized) {\n\t\t\t\t\t\t\t\t\t\tdetectedAgent = true;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t// Check for slash command (if not done already)\n\t\t\t\t\t\t\tif (startsWithSlashCommand && !detectedSlashCommand && !transformedWords && originalWords.length >= 2) {\n\t\t\t\t\t\t\t\tconst phrase = phrases.get(originalWords.slice(0, 2).map(word => this.normalizeWord(word)).join(' '));\n\t\t\t\t\t\t\t\tif (phrase) {\n\t\t\t\t\t\t\t\t\ttransformedWords = [this.toText(phrase, options.usesAgents && !detectedAgent ?\n\t\t\t\t\t\t\t\t\t\tPhraseTextType.AGENT_AND_COMMAND : \t// rewrite `/fix` to `@workspace /foo` in this case\n\t\t\t\t\t\t\t\t\t\tPhraseTextType.COMMAND\t\t\t\t// when we have not yet detected an agent before\n\t\t\t\t\t\t\t\t\t), ...originalWords.slice(2)];\n\n\t\t\t\t\t\t\t\t\twaitingForInput = originalWords.length === 2;\n\n\t\t\t\t\t\t\t\t\tif (e.status === SpeechToTextStatus.Recognized) {\n\t\t\t\t\t\t\t\t\t\tdetectedSlashCommand = true;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tmassagedEvent = {\n\t\t\t\t\t\t\t\tstatus: e.status,\n\t\t\t\t\t\t\t\ttext: (transformedWords ?? originalWords).join(' '),\n\t\t\t\t\t\t\t\twaitingForInput\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\temitter.fire(massagedEvent);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase SpeechToTextStatus.Started:\n\t\t\t\t\tthis.activeVoiceChatSessions++;\n\t\t\t\t\tthis.voiceChatInProgress.set(true);\n\t\t\t\t\temitter.fire(e);\n\t\t\t\t\tbreak;\n\t\t\t\tcase SpeechToTextStatus.Stopped:\n\t\t\t\t\tonSessionStoppedOrCanceled(false);\n\t\t\t\t\temitter.fire(e);\n\t\t\t\t\tbreak;\n\t\t\t\tcase SpeechToTextStatus.Error:\n\t\t\t\t\temitter.fire(e);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}));\n\n\t\treturn {\n\t\t\tonDidChange: emitter.event\n\t\t};\n\t}\n\n\tprivate normalizeWord(word: string): string {\n\t\tword = rtrim(word, '.');\n\t\tword = rtrim(word, ',');\n\t\tword = rtrim(word, '?');\n\n\t\treturn word.toLowerCase();\n\t}\n}\n"]}