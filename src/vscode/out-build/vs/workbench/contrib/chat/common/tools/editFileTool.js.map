{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/common/tools/editFileTool.ts","vs/workbench/contrib/chat/common/tools/editFileTool.ts"],"names":[],"mappings":"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","file":"editFileTool.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { MarkdownString } from '../../../../../base/common/htmlContent.js';\nimport { IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { autorun } from '../../../../../base/common/observable.js';\nimport { URI, UriComponents } from '../../../../../base/common/uri.js';\nimport { CellUri } from '../../../notebook/common/notebookCommon.js';\nimport { INotebookService } from '../../../notebook/common/notebookService.js';\nimport { ICodeMapperService } from '../../common/chatCodeMapperService.js';\nimport { ChatModel } from '../../common/chatModel.js';\nimport { IChatService } from '../../common/chatService.js';\nimport { CountTokensCallback, IPreparedToolInvocation, IToolData, IToolImpl, IToolInvocation, IToolInvocationPreparationContext, IToolResult, ToolDataSource, ToolInvocationPresentation, ToolProgress } from '../../common/languageModelToolsService.js';\nimport { LocalChatSessionUri } from '../chatUri.js';\n\nexport const ExtensionEditToolId = 'vscode_editFile';\nexport const InternalEditToolId = 'vscode_editFile_internal';\nexport const EditToolData: IToolData = {\n\tid: InternalEditToolId,\n\tdisplayName: '', // not used\n\tmodelDescription: '', // Not used\n\tsource: ToolDataSource.Internal,\n};\n\nexport interface EditToolParams {\n\turi: UriComponents;\n\texplanation: string;\n\tcode: string;\n}\n\nexport class EditTool implements IToolImpl {\n\n\tconstructor(\n\t\t@IChatService private readonly chatService: IChatService,\n\t\t@ICodeMapperService private readonly codeMapperService: ICodeMapperService,\n\t\t@INotebookService private readonly notebookService: INotebookService,\n\t) { }\n\n\tasync invoke(invocation: IToolInvocation, countTokens: CountTokensCallback, _progress: ToolProgress, token: CancellationToken): Promise<IToolResult> {\n\t\tif (!invocation.context) {\n\t\t\tthrow new Error('toolInvocationToken is required for this tool');\n\t\t}\n\n\t\tconst parameters = invocation.parameters as EditToolParams;\n\t\tconst fileUri = URI.revive(parameters.uri);\n\t\tconst uri = CellUri.parse(fileUri)?.notebook || fileUri;\n\n\t\tconst model = this.chatService.getSession(LocalChatSessionUri.forSession(invocation.context?.sessionId)) as ChatModel;\n\t\tconst request = model.getRequests().at(-1)!;\n\n\t\tmodel.acceptResponseProgress(request, {\n\t\t\tkind: 'markdownContent',\n\t\t\tcontent: new MarkdownString('\\n````\\n')\n\t\t});\n\t\tmodel.acceptResponseProgress(request, {\n\t\t\tkind: 'codeblockUri',\n\t\t\turi,\n\t\t\tisEdit: true\n\t\t});\n\t\tmodel.acceptResponseProgress(request, {\n\t\t\tkind: 'markdownContent',\n\t\t\tcontent: new MarkdownString('\\n````\\n')\n\t\t});\n\t\t// Signal start.\n\t\tif (this.notebookService.hasSupportedNotebooks(uri) && (this.notebookService.getNotebookTextModel(uri))) {\n\t\t\tmodel.acceptResponseProgress(request, {\n\t\t\t\tkind: 'notebookEdit',\n\t\t\t\tedits: [],\n\t\t\t\turi\n\t\t\t});\n\t\t} else {\n\t\t\tmodel.acceptResponseProgress(request, {\n\t\t\t\tkind: 'textEdit',\n\t\t\t\tedits: [],\n\t\t\t\turi\n\t\t\t});\n\t\t}\n\n\t\tconst editSession = model.editingSession;\n\t\tif (!editSession) {\n\t\t\tthrow new Error('This tool must be called from within an editing session');\n\t\t}\n\n\t\tconst result = await this.codeMapperService.mapCode({\n\t\t\tcodeBlocks: [{ code: parameters.code, resource: uri, markdownBeforeBlock: parameters.explanation }],\n\t\t\tlocation: 'tool',\n\t\t\tchatRequestId: invocation.chatRequestId,\n\t\t\tchatRequestModel: invocation.modelId,\n\t\t\tchatSessionId: invocation.context.sessionId,\n\t\t}, {\n\t\t\ttextEdit: (target, edits) => {\n\t\t\t\tmodel.acceptResponseProgress(request, { kind: 'textEdit', uri: target, edits });\n\t\t\t},\n\t\t\tnotebookEdit(target, edits) {\n\t\t\t\tmodel.acceptResponseProgress(request, { kind: 'notebookEdit', uri: target, edits });\n\t\t\t},\n\t\t}, token);\n\n\t\t// Signal end.\n\t\tif (this.notebookService.hasSupportedNotebooks(uri) && (this.notebookService.getNotebookTextModel(uri))) {\n\t\t\tmodel.acceptResponseProgress(request, { kind: 'notebookEdit', uri, edits: [], done: true });\n\t\t} else {\n\t\t\tmodel.acceptResponseProgress(request, { kind: 'textEdit', uri, edits: [], done: true });\n\t\t}\n\n\t\tif (result?.errorMessage) {\n\t\t\tthrow new Error(result.errorMessage);\n\t\t}\n\n\t\tlet dispose: IDisposable;\n\t\tawait new Promise((resolve) => {\n\t\t\t// The file will not be modified until the first edits start streaming in,\n\t\t\t// so wait until we see that it _was_ modified before waiting for it to be done.\n\t\t\tlet wasFileBeingModified = false;\n\n\t\t\tdispose = autorun((r) => {\n\n\t\t\t\tconst entries = editSession.entries.read(r);\n\t\t\t\tconst currentFile = entries?.find((e) => e.modifiedURI.toString() === uri.toString());\n\t\t\t\tif (currentFile) {\n\t\t\t\t\tif (currentFile.isCurrentlyBeingModifiedBy.read(r)) {\n\t\t\t\t\t\twasFileBeingModified = true;\n\t\t\t\t\t} else if (wasFileBeingModified) {\n\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}).finally(() => {\n\t\t\tdispose.dispose();\n\t\t});\n\n\t\treturn {\n\t\t\tcontent: [{ kind: 'text', value: 'The file was edited successfully' }]\n\t\t};\n\t}\n\n\tasync prepareToolInvocation(context: IToolInvocationPreparationContext, token: CancellationToken): Promise<IPreparedToolInvocation | undefined> {\n\t\treturn {\n\t\t\tpresentation: ToolInvocationPresentation.Hidden\n\t\t};\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { MarkdownString } from '../../../../../base/common/htmlContent.js';\nimport { IDisposable } from '../../../../../base/common/lifecycle.js';\nimport { autorun } from '../../../../../base/common/observable.js';\nimport { URI, UriComponents } from '../../../../../base/common/uri.js';\nimport { CellUri } from '../../../notebook/common/notebookCommon.js';\nimport { INotebookService } from '../../../notebook/common/notebookService.js';\nimport { ICodeMapperService } from '../../common/chatCodeMapperService.js';\nimport { ChatModel } from '../../common/chatModel.js';\nimport { IChatService } from '../../common/chatService.js';\nimport { CountTokensCallback, IPreparedToolInvocation, IToolData, IToolImpl, IToolInvocation, IToolInvocationPreparationContext, IToolResult, ToolDataSource, ToolInvocationPresentation, ToolProgress } from '../../common/languageModelToolsService.js';\nimport { LocalChatSessionUri } from '../chatUri.js';\n\nexport const ExtensionEditToolId = 'vscode_editFile';\nexport const InternalEditToolId = 'vscode_editFile_internal';\nexport const EditToolData: IToolData = {\n\tid: InternalEditToolId,\n\tdisplayName: '', // not used\n\tmodelDescription: '', // Not used\n\tsource: ToolDataSource.Internal,\n};\n\nexport interface EditToolParams {\n\turi: UriComponents;\n\texplanation: string;\n\tcode: string;\n}\n\nexport class EditTool implements IToolImpl {\n\n\tconstructor(\n\t\t@IChatService private readonly chatService: IChatService,\n\t\t@ICodeMapperService private readonly codeMapperService: ICodeMapperService,\n\t\t@INotebookService private readonly notebookService: INotebookService,\n\t) { }\n\n\tasync invoke(invocation: IToolInvocation, countTokens: CountTokensCallback, _progress: ToolProgress, token: CancellationToken): Promise<IToolResult> {\n\t\tif (!invocation.context) {\n\t\t\tthrow new Error('toolInvocationToken is required for this tool');\n\t\t}\n\n\t\tconst parameters = invocation.parameters as EditToolParams;\n\t\tconst fileUri = URI.revive(parameters.uri);\n\t\tconst uri = CellUri.parse(fileUri)?.notebook || fileUri;\n\n\t\tconst model = this.chatService.getSession(LocalChatSessionUri.forSession(invocation.context?.sessionId)) as ChatModel;\n\t\tconst request = model.getRequests().at(-1)!;\n\n\t\tmodel.acceptResponseProgress(request, {\n\t\t\tkind: 'markdownContent',\n\t\t\tcontent: new MarkdownString('\\n````\\n')\n\t\t});\n\t\tmodel.acceptResponseProgress(request, {\n\t\t\tkind: 'codeblockUri',\n\t\t\turi,\n\t\t\tisEdit: true\n\t\t});\n\t\tmodel.acceptResponseProgress(request, {\n\t\t\tkind: 'markdownContent',\n\t\t\tcontent: new MarkdownString('\\n````\\n')\n\t\t});\n\t\t// Signal start.\n\t\tif (this.notebookService.hasSupportedNotebooks(uri) && (this.notebookService.getNotebookTextModel(uri))) {\n\t\t\tmodel.acceptResponseProgress(request, {\n\t\t\t\tkind: 'notebookEdit',\n\t\t\t\tedits: [],\n\t\t\t\turi\n\t\t\t});\n\t\t} else {\n\t\t\tmodel.acceptResponseProgress(request, {\n\t\t\t\tkind: 'textEdit',\n\t\t\t\tedits: [],\n\t\t\t\turi\n\t\t\t});\n\t\t}\n\n\t\tconst editSession = model.editingSession;\n\t\tif (!editSession) {\n\t\t\tthrow new Error('This tool must be called from within an editing session');\n\t\t}\n\n\t\tconst result = await this.codeMapperService.mapCode({\n\t\t\tcodeBlocks: [{ code: parameters.code, resource: uri, markdownBeforeBlock: parameters.explanation }],\n\t\t\tlocation: 'tool',\n\t\t\tchatRequestId: invocation.chatRequestId,\n\t\t\tchatRequestModel: invocation.modelId,\n\t\t\tchatSessionId: invocation.context.sessionId,\n\t\t}, {\n\t\t\ttextEdit: (target, edits) => {\n\t\t\t\tmodel.acceptResponseProgress(request, { kind: 'textEdit', uri: target, edits });\n\t\t\t},\n\t\t\tnotebookEdit(target, edits) {\n\t\t\t\tmodel.acceptResponseProgress(request, { kind: 'notebookEdit', uri: target, edits });\n\t\t\t},\n\t\t}, token);\n\n\t\t// Signal end.\n\t\tif (this.notebookService.hasSupportedNotebooks(uri) && (this.notebookService.getNotebookTextModel(uri))) {\n\t\t\tmodel.acceptResponseProgress(request, { kind: 'notebookEdit', uri, edits: [], done: true });\n\t\t} else {\n\t\t\tmodel.acceptResponseProgress(request, { kind: 'textEdit', uri, edits: [], done: true });\n\t\t}\n\n\t\tif (result?.errorMessage) {\n\t\t\tthrow new Error(result.errorMessage);\n\t\t}\n\n\t\tlet dispose: IDisposable;\n\t\tawait new Promise((resolve) => {\n\t\t\t// The file will not be modified until the first edits start streaming in,\n\t\t\t// so wait until we see that it _was_ modified before waiting for it to be done.\n\t\t\tlet wasFileBeingModified = false;\n\n\t\t\tdispose = autorun((r) => {\n\n\t\t\t\tconst entries = editSession.entries.read(r);\n\t\t\t\tconst currentFile = entries?.find((e) => e.modifiedURI.toString() === uri.toString());\n\t\t\t\tif (currentFile) {\n\t\t\t\t\tif (currentFile.isCurrentlyBeingModifiedBy.read(r)) {\n\t\t\t\t\t\twasFileBeingModified = true;\n\t\t\t\t\t} else if (wasFileBeingModified) {\n\t\t\t\t\t\tresolve(true);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}).finally(() => {\n\t\t\tdispose.dispose();\n\t\t});\n\n\t\treturn {\n\t\t\tcontent: [{ kind: 'text', value: 'The file was edited successfully' }]\n\t\t};\n\t}\n\n\tasync prepareToolInvocation(context: IToolInvocationPreparationContext, token: CancellationToken): Promise<IPreparedToolInvocation | undefined> {\n\t\treturn {\n\t\t\tpresentation: ToolInvocationPresentation.Hidden\n\t\t};\n\t}\n}\n"]}