{"version":3,"sources":["vs/workbench/contrib/chat/common/promptSyntax/languageProviders/promptCodeActions.ts"],"names":[],"mappings":"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","file":"promptCodeActions.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from '../../../../../../base/common/cancellation.js';\nimport { Range } from '../../../../../../editor/common/core/range.js';\nimport { CodeAction, CodeActionContext, CodeActionList, CodeActionProvider, IWorkspaceFileEdit, IWorkspaceTextEdit, TextEdit } from '../../../../../../editor/common/languages.js';\nimport { ITextModel } from '../../../../../../editor/common/model.js';\nimport { localize } from '../../../../../../nls.js';\nimport { ILanguageModelToolsService } from '../../languageModelToolsService.js';\nimport { getPromptsTypeForLanguageId, PromptsType } from '../promptTypes.js';\nimport { IPromptsService } from '../service/promptsService.js';\nimport { ParsedPromptFile, PromptHeaderAttributes } from '../promptFileParser.js';\nimport { Selection } from '../../../../../../editor/common/core/selection.js';\nimport { Lazy } from '../../../../../../base/common/lazy.js';\nimport { LEGACY_MODE_FILE_EXTENSION } from '../config/promptFileLocations.js';\nimport { IFileService } from '../../../../../../platform/files/common/files.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { isGithubTarget } from './promptValidator.js';\n\nexport class PromptCodeActionProvider implements CodeActionProvider {\n\t/**\n\t * Debug display name for this provider.\n\t */\n\tpublic readonly _debugDisplayName: string = 'PromptCodeActionProvider';\n\n\tconstructor(\n\t\t@IPromptsService private readonly promptsService: IPromptsService,\n\t\t@ILanguageModelToolsService private readonly languageModelToolsService: ILanguageModelToolsService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t) {\n\t}\n\n\tasync provideCodeActions(model: ITextModel, range: Range | Selection, context: CodeActionContext, token: CancellationToken): Promise<CodeActionList | undefined> {\n\t\tconst promptType = getPromptsTypeForLanguageId(model.getLanguageId());\n\t\tif (!promptType || promptType === PromptsType.instructions) {\n\t\t\t// if the model is not a prompt, we don't provide any code actions\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst result: CodeAction[] = [];\n\n\t\tconst promptAST = this.promptsService.getParsedPromptFile(model);\n\t\tswitch (promptType) {\n\t\t\tcase PromptsType.agent:\n\t\t\t\tthis.getUpdateToolsCodeActions(promptAST, promptType, model, range, result);\n\t\t\t\tawait this.getMigrateModeFileCodeActions(model.uri, result);\n\t\t\t\tbreak;\n\t\t\tcase PromptsType.prompt:\n\t\t\t\tthis.getUpdateModeCodeActions(promptAST, model, range, result);\n\t\t\t\tthis.getUpdateToolsCodeActions(promptAST, promptType, model, range, result);\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (result.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn {\n\t\t\tactions: result,\n\t\t\tdispose: () => { }\n\t\t};\n\n\t}\n\n\tprivate getUpdateModeCodeActions(promptFile: ParsedPromptFile, model: ITextModel, range: Range, result: CodeAction[]): void {\n\t\tconst modeAttr = promptFile.header?.getAttribute(PromptHeaderAttributes.mode);\n\t\tif (!modeAttr?.range.containsRange(range)) {\n\t\t\treturn;\n\t\t}\n\t\tconst keyRange = new Range(modeAttr.range.startLineNumber, modeAttr.range.startColumn, modeAttr.range.startLineNumber, modeAttr.range.startColumn + modeAttr.key.length);\n\t\tresult.push({\n\t\t\ttitle: localize('renameToAgent', \"Rename to 'agent'\"),\n\t\t\tedit: {\n\t\t\t\tedits: [asWorkspaceTextEdit(model, { range: keyRange, text: 'agent' })]\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate async getMigrateModeFileCodeActions(uri: URI, result: CodeAction[]): Promise<void> {\n\t\tif (uri.path.endsWith(LEGACY_MODE_FILE_EXTENSION)) {\n\t\t\tconst location = this.promptsService.getAgentFileURIFromModeFile(uri);\n\t\t\tif (location && await this.fileService.canMove(uri, location)) {\n\t\t\t\tconst edit: IWorkspaceFileEdit = { oldResource: uri, newResource: location, options: { overwrite: false, copy: false } };\n\t\t\t\tresult.push({\n\t\t\t\t\ttitle: localize('migrateToAgent', \"Migrate to custom agent file\"),\n\t\t\t\t\tedit: {\n\t\t\t\t\t\tedits: [edit]\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate getUpdateToolsCodeActions(promptFile: ParsedPromptFile, promptType: PromptsType, model: ITextModel, range: Range, result: CodeAction[]): void {\n\t\tconst toolsAttr = promptFile.header?.getAttribute(PromptHeaderAttributes.tools);\n\t\tif (toolsAttr?.value.type !== 'array' || !toolsAttr.value.range.containsRange(range)) {\n\t\t\treturn;\n\t\t}\n\t\tif (isGithubTarget(promptType, promptFile.header?.target)) {\n\t\t\t// Puku AI custom agents use a fixed set of tool names that are not deprecated\n\t\t\treturn;\n\t\t}\n\n\t\tconst values = toolsAttr.value.items;\n\t\tconst deprecatedNames = new Lazy(() => this.languageModelToolsService.getDeprecatedQualifiedToolNames());\n\t\tconst edits: TextEdit[] = [];\n\t\tfor (const item of values) {\n\t\t\tif (item.type !== 'string') {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst newNames = deprecatedNames.value.get(item.value);\n\t\t\tif (newNames && newNames.size > 0) {\n\t\t\t\tconst quote = model.getValueInRange(new Range(item.range.startLineNumber, item.range.startColumn, item.range.endLineNumber, item.range.startColumn + 1));\n\n\t\t\t\tif (newNames.size === 1) {\n\t\t\t\t\tconst newName = Array.from(newNames)[0];\n\t\t\t\t\tconst text = (quote === `'` || quote === '\"') ? (quote + newName + quote) : newName;\n\t\t\t\t\tconst edit = { range: item.range, text };\n\t\t\t\t\tedits.push(edit);\n\n\t\t\t\t\tif (item.range.containsRange(range)) {\n\t\t\t\t\t\tresult.push({\n\t\t\t\t\t\t\ttitle: localize('updateToolName', \"Update to '{0}'\", newName),\n\t\t\t\t\t\t\tedit: {\n\t\t\t\t\t\t\t\tedits: [asWorkspaceTextEdit(model, edit)]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// Multiple new names - expand to include all of them\n\t\t\t\t\tconst newNamesArray = Array.from(newNames).sort((a, b) => a.localeCompare(b));\n\t\t\t\t\tconst separator = model.getValueInRange(new Range(item.range.startLineNumber, item.range.endColumn, item.range.endLineNumber, item.range.endColumn + 2));\n\t\t\t\t\tconst useCommaSpace = separator.includes(',');\n\t\t\t\t\tconst delimiterText = useCommaSpace ? ', ' : ',';\n\n\t\t\t\t\tconst newNamesText = newNamesArray.map(name =>\n\t\t\t\t\t\t(quote === `'` || quote === '\"') ? (quote + name + quote) : name\n\t\t\t\t\t).join(delimiterText);\n\n\t\t\t\t\tconst edit = { range: item.range, text: newNamesText };\n\t\t\t\t\tedits.push(edit);\n\n\t\t\t\t\tif (item.range.containsRange(range)) {\n\t\t\t\t\t\tresult.push({\n\t\t\t\t\t\t\ttitle: localize('expandToolNames', \"Expand to {0} tools\", newNames.size),\n\t\t\t\t\t\t\tedit: {\n\t\t\t\t\t\t\t\tedits: [asWorkspaceTextEdit(model, edit)]\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (edits.length && result.length === 0 || edits.length > 1) {\n\t\t\tresult.push({\n\t\t\t\ttitle: localize('updateAllToolNames', \"Update all tool names\"),\n\t\t\t\tedit: {\n\t\t\t\t\tedits: edits.map(edit => asWorkspaceTextEdit(model, edit))\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n}\nfunction asWorkspaceTextEdit(model: ITextModel, textEdit: TextEdit): IWorkspaceTextEdit {\n\treturn {\n\t\tversionId: model.getVersionId(),\n\t\tresource: model.uri,\n\t\ttextEdit\n\t};\n}\n"]}