{"version":3,"sources":["vs/workbench/contrib/chat/common/chatModel.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;;AAEhG,OAAO,EAAE,OAAO,EAAE,MAAM,mCAAmC,CAAC;AAC5D,OAAO,EAAE,eAAe,EAAE,MAAM,mCAAmC,CAAC;AACpE,OAAO,EAAE,kBAAkB,EAAE,MAAM,mCAAmC,CAAC;AACvE,OAAO,EAAE,OAAO,EAAS,MAAM,kCAAkC,CAAC;AAClE,OAAO,EAAmB,cAAc,EAAE,gBAAgB,EAAE,MAAM,wCAAwC,CAAC;AAC3G,OAAO,EAAE,UAAU,EAAe,MAAM,sCAAsC,CAAC;AAC/E,OAAO,EAAE,WAAW,EAAE,MAAM,gCAAgC,CAAC;AAC7D,OAAO,EAAE,MAAM,EAAE,MAAM,wCAAwC,CAAC;AAChE,OAAO,EAAE,OAAO,EAAE,MAAM,oCAAoC,CAAC;AAC7D,OAAO,EAAE,MAAM,EAAE,MAAM,oCAAoC,CAAC;AAC5D,OAAO,EAAe,OAAO,EAAE,qBAAqB,EAAE,OAAO,EAAE,mBAAmB,EAAE,yBAAyB,EAAE,eAAe,EAAE,mBAAmB,EAAE,MAAM,uCAAuC,CAAC;AACnM,OAAO,EAAE,QAAQ,EAAE,OAAO,EAAE,MAAM,sCAAsC,CAAC;AAGzE,OAAO,EAAE,GAAG,EAAyB,eAAe,EAAE,MAAM,gCAAgC,CAAC;AAC7F,OAAO,EAAE,YAAY,EAAE,MAAM,iCAAiC,CAAC;AAE/D,OAAO,EAAE,WAAW,EAAE,MAAM,sDAAsD,CAAC;AAEnF,OAAO,EAAE,QAAQ,EAAE,MAAM,wCAAwC,CAAC;AAElE,OAAO,EAAE,QAAQ,EAAE,MAAM,oBAAoB,CAAC;AAC9C,OAAO,EAAE,WAAW,EAAE,MAAM,wCAAwC,CAAC;AACrE,OAAO,EAAE,OAAO,EAAsB,MAAM,yCAAyC,CAAC;AACtF,OAAO,EAAE,qCAAqC,EAAE,MAAM,WAAW,CAAC;AAClE,OAAO,EAAuD,iBAAiB,EAAqB,qBAAqB,EAAE,MAAM,iBAAiB,CAAC;AACnJ,OAAO,EAAE,mBAAmB,EAAuB,MAAM,yBAAyB,CAAC;AACnF,OAAO,EAAE,mBAAmB,EAAsB,uBAAuB,EAAE,MAAM,sBAAsB,CAAC;AACxG,OAAO,EAAmD,+CAA+C,EAAgrB,mBAAmB,EAAsG,cAAc,EAAE,MAAM,kBAAkB,CAAC;AAC37B,OAAO,EAAE,mBAAmB,EAAE,MAAM,cAAc,CAAC;AAEnD,OAAO,EAAE,iBAAiB,EAAE,YAAY,EAAE,MAAM,gBAAgB,CAAC;AAIjE,MAAM,CAAC,MAAM,gCAAgC,GAA2B;IACvE,GAAG,EAAE,WAAW;IAChB,GAAG,EAAE,YAAY;IACjB,IAAI,EAAE,YAAY;IAClB,GAAG,EAAE,WAAW;IAChB,IAAI,EAAE,YAAY;CAClB,CAAC;AAEF,MAAM,UAAU,2BAA2B,CAAC,QAAgB;IAC3D,OAAO,MAAM,CAAC,OAAO,CAAC,gCAAgC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,EAAE,EAAE,CAAC,KAAK,KAAK,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;AACvG,CAAC;AA4CD,MAAM,UAAU,uBAAuB,CAAC,KAAc;IACrD,MAAM,SAAS,GAAG,KAA+B,CAAC;IAClD,OAAO,CAAC,CAAC,SAAS,IAAI,CAAC,CAAC,SAAS,CAAC,IAAI,IAAI,CAAC,CAAC,SAAS,CAAC,GAAG,IAAI,GAAG,CAAC,KAAK,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;AACvF,CAAC;AAED,MAAM,UAAU,4BAA4B,CAAC,KAAsD;IAClG,OAAO,KAAK,CAAC,IAAI,CAAC,uBAAuB,CAAC,CAAC;AAC5C,CAAC;AAqDD,MAAM,eAAe,GAAG,IAAI,GAAG,CAAC,CAAC,gBAAgB,EAAE,0BAA0B,EAAE,UAAU,EAAE,uBAAuB,CAAC,CAAC,CAAC;AACrH,SAAS,oCAAoC,CAAC,OAAqC;IAClF,OAAO,CAAC,eAAe,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;AAC3C,CAAC;AAED,MAAM,UAAU,oBAAoB,CAAC,OAAoD;IACxF,OAAO,OAAO,CAAC,MAAM,CAAC,oCAAoC,CAAC,CAAC;AAC7D,CAAC;AA0ED,MAAM,CAAC,MAAM,oCAAoC,GAAkC,EAAE,MAAM,EAAE,OAAO,EAAE,CAAC;AAkCvG,MAAM,OAAO,gBAAgB;IAqB5B,IAAW,OAAO;QACjB,OAAO,IAAI,CAAC,QAAQ,CAAC;IACtB,CAAC;IAED,IAAW,OAAO;QACjB,OAAO,IAAI,CAAC,QAAQ,CAAC;IACtB,CAAC;IAED,IAAW,YAAY;QACtB,OAAO,IAAI,CAAC,aAAa,CAAC;IAC3B,CAAC;IAED,IAAW,YAAY,CAAC,CAA2B;QAClD,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC;IACxB,CAAC;IAED,IAAW,YAAY;QACtB,OAAO,IAAI,CAAC,aAAa,CAAC;IAC3B,CAAC;IAED,IAAW,YAAY;QACtB,OAAO,IAAI,CAAC,aAAa,CAAC;IAC3B,CAAC;IAED,IAAW,eAAe;QACzB,OAAO,IAAI,CAAC,gBAAgB,CAAC;IAC9B,CAAC;IAED,IAAW,gBAAgB;QAC1B,OAAO,IAAI,CAAC,iBAAiB,CAAC;IAC/B,CAAC;IAED,YAAY,MAAmC;QA1CxC,oBAAe,GAAY,KAAK,CAAC;QA2CvC,IAAI,CAAC,QAAQ,GAAG,MAAM,CAAC,OAAO,CAAC;QAC/B,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC;QAC9B,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,SAAS,GAAG,MAAM,CAAC,SAAS,CAAC;QAClC,IAAI,CAAC,QAAQ,GAAG,MAAM,CAAC,OAAO,IAAI,CAAC,CAAC;QACpC,IAAI,CAAC,QAAQ,GAAG,MAAM,CAAC,QAAQ,CAAC;QAChC,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,gBAAgB,GAAG,MAAM,CAAC,eAAe,CAAC;QAC/C,IAAI,CAAC,sBAAsB,GAAG,MAAM,CAAC,sBAAsB,IAAI,KAAK,CAAC;QACrE,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC,OAAO,CAAC;QAC9B,IAAI,CAAC,EAAE,GAAG,MAAM,CAAC,UAAU,IAAI,UAAU,GAAG,YAAY,EAAE,CAAC;QAC3D,IAAI,CAAC,iBAAiB,GAAG,MAAM,CAAC,gBAAgB,CAAC;QACjD,IAAI,CAAC,iBAAiB,GAAG,MAAM,CAAC,iBAAiB,CAAC;IACnD,CAAC;IAED,OAAO,CAAC,OAAkB;QACzB,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;IACzB,CAAC;CACD;AAED,MAAM,gBAAgB;IAarB,IAAI,KAAK;QACR,OAAO,IAAI,CAAC,cAAc,CAAC;IAC5B,CAAC;IAED,YAAY,KAAqC;QAdjD;;WAEG;QACO,kBAAa,GAAG,EAAE,CAAC;QAE7B;;WAEG;QACO,qBAAgB,GAAG,EAAE,CAAC;QAO/B,IAAI,CAAC,cAAc,GAAG,KAAK,CAAC;QAC5B,IAAI,CAAC,WAAW,EAAE,CAAC;IACpB,CAAC;IAED,QAAQ;QACP,OAAO,IAAI,CAAC,aAAa,CAAC;IAC3B,CAAC;IAED;;OAEG;IACH,WAAW;QACV,OAAO,IAAI,CAAC,gBAAgB,CAAC;IAC9B,CAAC;IAES,WAAW;QACpB,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QAE3D,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE;YACtD,IAAI,IAAI,CAAC,IAAI,KAAK,iBAAiB,EAAE,CAAC;gBACrC,OAAO,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;YACnC,CAAC;iBAAM,IAAI,IAAI,CAAC,IAAI,KAAK,iBAAiB,IAAI,IAAI,CAAC,IAAI,KAAK,cAAc,EAAE,CAAC;gBAC5E,OAAO,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC;YAC3B,CAAC;iBAAM,CAAC;gBACP,OAAO,EAAE,CAAC;YACX,CAAC;QACF,CAAC,CAAC;aACA,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC;aACzB,IAAI,CAAC,EAAE,CAAC,CAAC;IACZ,CAAC;IAEO,WAAW,CAAC,KAA8C;QACjE,MAAM,MAAM,GAAa,EAAE,CAAC;QAC5B,IAAI,oBAAoB,GAAa,EAAE,CAAC;QACxC,IAAI,2BAA2B,GAAG,KAAK,CAAC;QAExC,KAAK,MAAM,IAAI,IAAI,KAAK,EAAE,CAAC;YAC1B,IAAI,OAAwD,CAAC;YAC7D,QAAQ,IAAI,CAAC,IAAI,EAAE,CAAC;gBACnB,KAAK,+BAA+B;oBACnC,oBAAoB,GAAG,EAAE,CAAC;oBAC1B,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC;oBAClB,2BAA2B,GAAG,KAAK,CAAC,CAAC,uCAAuC;oBAC5E,SAAS;gBACV,KAAK,UAAU,CAAC;gBAChB,KAAK,iBAAiB,CAAC;gBACvB,KAAK,cAAc,CAAC;gBACpB,KAAK,YAAY,CAAC;gBAClB,KAAK,aAAa,CAAC;gBACnB,KAAK,UAAU,CAAC;gBAChB,KAAK,uBAAuB,CAAC;gBAC7B,KAAK,cAAc,CAAC;gBACpB,KAAK,uBAAuB,CAAC;gBAC7B,KAAK,UAAU,CAAC;gBAChB,KAAK,eAAe,CAAC;gBACrB,KAAK,oBAAoB;oBACxB,SAAS;oBACT,SAAS;gBACV,KAAK,gBAAgB,CAAC;gBACtB,KAAK,0BAA0B;oBAC9B,4CAA4C;oBAC5C,OAAO,GAAG,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,CAAC;oBAC3C,MAAM;gBACP,KAAK,iBAAiB;oBACrB,OAAO,GAAG,EAAE,IAAI,EAAE,IAAI,CAAC,eAAe,CAAC,IAAI,CAAC,EAAE,CAAC;oBAC/C,MAAM;gBACP,KAAK,SAAS;oBACb,OAAO,GAAG,EAAE,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;oBACtD,MAAM;gBACP,KAAK,eAAe,CAAC;gBACrB,KAAK,mBAAmB;oBACvB,qDAAqD;oBACrD,2BAA2B,GAAG,IAAI,CAAC;oBACnC,mDAAmD;oBACnD,SAAS;gBACV,KAAK,cAAc;oBAClB,IAAI,IAAI,CAAC,OAAO,YAAY,cAAc,EAAE,CAAC;wBAC5C,OAAO,GAAG,EAAE,IAAI,EAAE,GAAG,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;wBAC1E,MAAM;oBACP,CAAC;oBACD,OAAO,GAAG,EAAE,IAAI,EAAE,GAAG,IAAI,CAAC,KAAK,KAAK,IAAI,CAAC,OAAO,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;oBACpE,MAAM;gBACP,KAAK,iBAAiB,CAAC;gBACvB,KAAK,cAAc,CAAC;gBACpB,KAAK,cAAc,CAAC;gBACpB,KAAK,wBAAwB,CAAC;gBAC9B,KAAK,SAAS;oBACb,OAAO,GAAG,EAAE,IAAI,EAAE,IAAI,CAAC,OAAO,CAAC,KAAK,EAAE,CAAC;oBACvC,MAAM;gBACP;oBACC,sEAAsE;oBACtE,eAAe,CAAC,IAAI,CAAC,CAAC;oBACtB,SAAS;YACX,CAAC;YAED,IAAI,OAAO,CAAC,OAAO,EAAE,CAAC;gBACrB,IAAI,oBAAoB,CAAC,MAAM,EAAE,CAAC;oBACjC,MAAM,CAAC,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC;oBAC3C,oBAAoB,GAAG,EAAE,CAAC;gBAC3B,CAAC;gBACD,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YAC3B,CAAC;iBAAM,CAAC;gBACP,oBAAoB,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YACzC,CAAC;QACF,CAAC;QAED,IAAI,oBAAoB,CAAC,MAAM,EAAE,CAAC;YACjC,MAAM,CAAC,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC;QAC5C,CAAC;QAED,8FAA8F;QAC9F,IAAI,2BAA2B,EAAE,CAAC;YACjC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAc,EAAE,IAAe,CAAC,CAAC,CAAC;QACxD,CAAC;QAED,OAAO,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;IAC5B,CAAC;IAEO,eAAe,CAAC,IAAiC;QACxD,IAAI,KAAK,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;YACnC,OAAO,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC;QACjD,CAAC;QAED,OAAO,MAAM,IAAI,IAAI,CAAC,eAAe;YACpC,CAAC,CAAC,GAAG,GAAG,IAAI,CAAC,eAAe,CAAC,IAAI,GAAG,GAAG;YACvC,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;IACzC,CAAC;IAEO,qBAAqB,CAAC,cAAmE;QAChG,wCAAwC;QACxC,IAAI,OAAO,GAAG,EAAE,CAAC;QACjB,IAAI,KAAK,GAAG,EAAE,CAAC;QAEf,IAAI,cAAc,CAAC,gBAAgB,EAAE,CAAC;YACrC,OAAO,GAAG,OAAO,cAAc,CAAC,gBAAgB,KAAK,QAAQ;gBAC5D,CAAC,CAAC,cAAc,CAAC,gBAAgB;gBACjC,CAAC,CAAC,cAAc,CAAC,gBAAgB,CAAC,KAAK,CAAC;QAC1C,CAAC;aAAM,CAAC;YACP,OAAO,GAAG,OAAO,cAAc,CAAC,iBAAiB,KAAK,QAAQ;gBAC7D,CAAC,CAAC,cAAc,CAAC,iBAAiB;gBAClC,CAAC,CAAC,cAAc,CAAC,iBAAiB,CAAC,KAAK,CAAC;QAC3C,CAAC;QAED,6CAA6C;QAC7C,IAAI,cAAc,CAAC,gBAAgB,EAAE,CAAC;YACrC,IAAI,cAAc,CAAC,gBAAgB,CAAC,IAAI,KAAK,UAAU,EAAE,CAAC;gBACzD,OAAO,GAAG,sBAAsB,CAAC;gBACjC,MAAM,YAAY,GAAG,qCAAqC,CAAC,cAAc,CAAC,gBAAgB,CAAC,CAAC;gBAC5F,KAAK,GAAG,YAAY,CAAC,WAAW,CAAC,UAAU,IAAI,YAAY,CAAC,WAAW,CAAC,UAAU,IAAI,YAAY,CAAC,WAAW,CAAC,QAAQ,CAAC;YACzH,CAAC;QACF,CAAC;QAED,kCAAkC;QAClC,IAAI,IAAI,GAAG,OAAO,CAAC;QACnB,IAAI,KAAK,EAAE,CAAC;YACX,IAAI,IAAI,KAAK,KAAK,EAAE,CAAC;QACtB,CAAC;QAED,+EAA+E;QAC/E,IAAI,cAAc,CAAC,IAAI,KAAK,0BAA0B,IAAI,CAAC,cAAc,CAAC,IAAI,KAAK,gBAAgB,IAAI,mBAAmB,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC,EAAE,CAAC;YACxJ,MAAM,aAAa,GAAG,mBAAmB,CAAC,aAAa,CAAC,cAAc,CAAC,CAAC;YACxE,IAAI,aAAa,IAAI,OAAO,IAAI,aAAa,EAAE,CAAC;gBAC/C,MAAM,YAAY,GAAG,cAAc,CAAC,IAAI,KAAK,0BAA0B,IAAI,mBAAmB,CAAC,UAAU,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,SAAS,CAAC;gBACpJ,IAAI,IAAI,KAAK,YAAY,gBAAgB,aAAa,CAAC,KAAK,EAAE,CAAC;YAChE,CAAC;QACF,CAAC;QAED,OAAO,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;IAChC,CAAC;IAEO,SAAS,CAAC,GAAQ;QACzB,IAAI,GAAG,CAAC,MAAM,KAAK,OAAO,CAAC,IAAI,IAAI,GAAG,CAAC,MAAM,KAAK,OAAO,CAAC,KAAK,EAAE,CAAC;YACjE,OAAO,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;QAC5B,CAAC;QAED,OAAO,QAAQ,CAAC,GAAG,CAAC,CAAC;IACtB,CAAC;CACD;AAED,uCAAuC;AACvC,MAAM,YAAa,SAAQ,gBAAgB;IAC1C,YACC,SAAoB,EACJ,QAAgB;QAEhC,IAAI,GAAG,GAAG,SAAS,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,UAAU,IAAI,CAAC,CAAC,EAAE,KAAK,QAAQ,CAAC,CAAC;QACrF,4EAA4E;QAC5E,sEAAsE;QACtE,uEAAuE;QACvE,IAAI,SAAS,CAAC,KAAK,CAAC,GAAG,GAAG,CAAC,CAAC,EAAE,IAAI,KAAK,cAAc,IAAI,SAAS,CAAC,KAAK,CAAC,GAAG,GAAG,CAAC,CAAC,EAAE,IAAI,KAAK,iBAAiB,EAAE,CAAC;YAC/G,GAAG,EAAE,CAAC;QACP,CAAC;QAED,KAAK,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC;QAV5D,aAAQ,GAAR,QAAQ,CAAQ;IAWjC,CAAC;CACD;AAED,MAAM,OAAO,QAAS,SAAQ,gBAAgB;IAE7C,IAAW,gBAAgB;QAC1B,OAAO,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC;IACrC,CAAC;IAKD,YAAY,KAA0N;QACrO,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAC/B,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YAChB,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,OAAO,EAAE,CAAC,EAAE,IAAI,EAAE,iBAAiB,EAAiC,CAAC,CAAC;gBAC7F,EAAE,IAAI,EAAE,UAAU,EAAE,QAAQ,EAAE,CAAC,EAAE,CACnC,CAAC,CAAC,CAAC;QAbG,sBAAiB,GAAG,IAAI,OAAO,EAAQ,CAAC;QAKxC,eAAU,GAAwB,EAAE,CAAC;IAS7C,CAAC;IAED,OAAO;QACN,IAAI,CAAC,iBAAiB,CAAC,OAAO,EAAE,CAAC;IAClC,CAAC;IAGD,KAAK;QACJ,IAAI,CAAC,cAAc,GAAG,EAAE,CAAC;QACzB,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;IACxB,CAAC;IAED,6BAA6B,CAAC,OAAgB;QAC7C,iHAAiH;QACjH,IAAI,uBAAuB,GAAG,CAAC,CAAC,CAAC;QACjC,KAAK,IAAI,CAAC,GAAG,IAAI,CAAC,cAAc,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;YAC1D,MAAM,IAAI,GAAG,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC;YACpC,IAAI,IAAI,CAAC,IAAI,KAAK,gBAAgB,IAAI,IAAI,CAAC,IAAI,KAAK,0BAA0B,EAAE,CAAC;gBAChF,uBAAuB,GAAG,CAAC,CAAC;gBAC5B,MAAM;YACP,CAAC;QACF,CAAC;QACD,IAAI,uBAAuB,KAAK,CAAC,CAAC,EAAE,CAAC;YACpC,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC,EAAE,uBAAuB,GAAG,CAAC,CAAC,CAAC;QACjF,CAAC;aAAM,CAAC;YACP,IAAI,CAAC,cAAc,GAAG,EAAE,CAAC;QAC1B,CAAC;QACD,IAAI,OAAO,EAAE,CAAC;YACb,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,OAAO,EAAE,IAAI,cAAc,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QACrF,CAAC;QACD,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;IACxB,CAAC;IAED,aAAa,CAAC,QAAsF,EAAE,KAAe;QACpH,IAAI,QAAQ,CAAC,IAAI,KAAK,+BAA+B,EAAE,CAAC;YACvD,IAAI,QAAQ,CAAC,MAAM,KAAK,+CAA+C,CAAC,qBAAqB,EAAE,CAAC;gBAC/F,IAAI,CAAC,6BAA6B,CAAC,QAAQ,CAAC,IAAuB,EAAE,IAAuF,CAAC,CAAC,CAAC;YAChK,CAAC;iBAAM,IAAI,QAAQ,CAAC,MAAM,KAAK,+CAA+C,CAAC,oBAAoB,EAAE,CAAC;gBACrG,IAAI,CAAC,6BAA6B,CAAC,QAAQ,CAAC,IAAsB,EAAE,IAAgF,CAAC,CAAC,CAAC;YACxJ,CAAC;iBAAM,CAAC;gBACP,IAAI,CAAC,6BAA6B,EAAE,CAAC;YACtC,CAAC;YACD,OAAO;QACR,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,iBAAiB,EAAE,CAAC;YAEhD,iHAAiH;YACjH,mFAAmF;YACnF,MAAM,gBAAgB,GAAG,IAAI,CAAC,cAAc;iBAC1C,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,eAAe,CAAC;iBACvC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;YAET,IAAI,CAAC,gBAAgB,IAAI,gBAAgB,CAAC,IAAI,KAAK,iBAAiB,IAAI,CAAC,uBAAuB,CAAC,gBAAgB,CAAC,OAAO,EAAE,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;gBAC9I,2FAA2F;gBAC3F,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACpC,CAAC;iBAAM,CAAC;gBACP,2EAA2E;gBAC3E,MAAM,GAAG,GAAG,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;gBAC1D,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,gBAAgB,EAAE,OAAO,EAAE,oBAAoB,CAAC,gBAAgB,CAAC,OAAO,EAAE,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC;YAC/H,CAAC;YACD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QACzB,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,UAAU,EAAE,CAAC;YAEzC,oGAAoG;YACpG,MAAM,gBAAgB,GAAG,IAAI,CAAC,cAAc;iBAC1C,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,eAAe,CAAC;iBACvC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;YAET,MAAM,QAAQ,GAAG,gBAAgB,IAAI,gBAAgB,CAAC,IAAI,KAAK,UAAU;gBACxE,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,gBAAgB,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,gBAAgB,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC;gBAC5G,CAAC,CAAC,EAAE,CAAC;YACN,MAAM,QAAQ,GAAG,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,IAAI,EAAE,CAAC,CAAC;YAClG,MAAM,OAAO,GAAG,CAAC,CAAS,EAAE,EAAE,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC,MAAM,KAAK,CAAC,CAAC;YAErD,qGAAqG;YACrG,IAAI,CAAC,gBAAgB;mBACjB,gBAAgB,CAAC,IAAI,KAAK,UAAU;mBACpC,OAAO,CAAC,QAAQ,CAAC;mBACjB,OAAO,CAAC,QAAQ,CAAC;mBACjB,CAAC,uBAAuB,CAAC,IAAI,cAAc,CAAC,QAAQ,CAAC,EAAE,IAAI,cAAc,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC;gBAC1F,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACpC,CAAC;iBAAM,CAAC;gBACP,MAAM,GAAG,GAAG,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;gBAC1D,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,GAAG;oBAC1B,GAAG,gBAAgB;oBACnB,KAAK,EAAE,oBAAoB,CAAC,IAAI,cAAc,CAAC,QAAQ,CAAC,EAAE,IAAI,cAAc,CAAC,QAAQ,CAAC,CAAC,CAAC,KAAK;iBAC7F,CAAC;YACH,CAAC;YACD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QACzB,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,UAAU,IAAI,QAAQ,CAAC,IAAI,KAAK,cAAc,EAAE,CAAC;YAC7E,+EAA+E;YAC/E,wHAAwH;YACxH,MAAM,+BAA+B,GAAG,QAAQ,CAAC,GAAG,CAAC,MAAM,KAAK,OAAO,CAAC,kBAAkB,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,mBAAmB,CAAC,CAAC;YACnK,4DAA4D;YAC5D,MAAM,WAAW,GAAG,+BAA+B,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,OAAO,CAAC,KAAK,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,QAAQ,CAAC;YACxG,MAAM,GAAG,GAAG,WAAW,IAAI,QAAQ,CAAC,GAAG,CAAC;YACxC,IAAI,KAAK,GAAG,KAAK,CAAC;YAClB,MAAM,SAAS,GAAG,QAAQ,CAAC,IAAI,KAAK,UAAU,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,mBAAmB,CAAC;YACvG,MAAM,KAAK,GAAQ,SAAS,KAAK,eAAe,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE,GAAG,EAAE,QAAQ,CAAC,GAAG,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;YAC/J,MAAM,cAAc,GAAG,QAAQ,CAAC,cAAc,CAAC;YAC/C,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,KAAK,IAAI,CAAC,GAAG,IAAI,CAAC,cAAc,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;gBAC/D,MAAM,SAAS,GAAG,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC;gBACzC,IAAI,SAAS,CAAC,IAAI,KAAK,SAAS,IAAI,CAAC,SAAS,CAAC,IAAI,IAAI,OAAO,CAAC,SAAS,CAAC,GAAG,EAAE,GAAG,CAAC,EAAE,CAAC;oBACpF,SAAS,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;oBAC5B,SAAS,CAAC,IAAI,GAAG,QAAQ,CAAC,IAAI,CAAC;oBAC/B,KAAK,GAAG,IAAI,CAAC;gBACd,CAAC;YACF,CAAC;YACD,IAAI,CAAC,KAAK,EAAE,CAAC;gBACZ,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC;oBACxB,IAAI,EAAE,SAAS;oBACf,GAAG;oBACH,KAAK,EAAE,SAAS,KAAK,eAAe,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK;oBACtD,IAAI,EAAE,QAAQ,CAAC,IAAI;oBACnB,cAAc;iBACd,CAAC,CAAC;YACJ,CAAC;YACD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QACzB,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,cAAc,EAAE,CAAC;YAC7C,2BAA2B;YAC3B,MAAM,gBAAgB,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC;YAChE,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YAExB,MAAM,IAAI,GAAG,QAAQ,CAAC,gBAAgB,CAAC,GAAG,EAAE;gBAC3C,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YACzB,CAAC,CAAC,CAAC;YAEH,QAAQ,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,EAAE;gBAClC,4DAA4D;gBAC5D,IAAI,CAAC,OAAO,EAAE,CAAC;gBAEf,kEAAkE;gBAClE,IAAI,OAAO,OAAO,KAAK,QAAQ,EAAE,CAAC;oBAChC,IAAI,CAAC,cAAc,CAAC,gBAAgB,CAAe,CAAC,OAAO,GAAG,IAAI,cAAc,CAAC,OAAO,CAAC,CAAC;gBAC5F,CAAC;gBACD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YACzB,CAAC,CAAC,CAAC;QAEJ,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,gBAAgB,EAAE,CAAC;YAC/C,qBAAqB,CAAC,MAAM,CAAC,EAAE;gBAC9B,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,iCAAiC;gBAC9D,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;gBAExB,IAAI,mBAAmB,CAAC,UAAU,CAAC,QAAQ,EAAE,MAAM,CAAC,EAAE,CAAC;oBACtD,MAAM,CAAC,OAAO,EAAE,CAAC;gBAClB,CAAC;YACF,CAAC,CAAC,CAAC;YACH,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACnC,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QACzB,CAAC;aAAM,CAAC;YACP,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACnC,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QACzB,CAAC;IACF,CAAC;IAEM,WAAW,CAAC,QAA2B;QAC7C,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC/B,IAAI,CAAC,WAAW,EAAE,CAAC;IACpB,CAAC;IAEkB,WAAW,CAAC,KAAe;QAC7C,KAAK,CAAC,WAAW,EAAE,CAAC;QACpB,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAC7B,OAAO,CAAC,iCAAiC;QAC1C,CAAC;QAED,IAAI,CAAC,aAAa,IAAI,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM,GAAG,uBAAuB,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;QAEtG,IAAI,CAAC,KAAK,EAAE,CAAC;YACZ,IAAI,CAAC,iBAAiB,CAAC,IAAI,EAAE,CAAC;QAC/B,CAAC;IACF,CAAC;CACD;AAyBD,IAAW,kBAIV;AAJD,WAAW,kBAAkB;IAC5B,iEAAO,CAAA;IACP,mEAAQ,CAAA;IACR,qEAAS,CAAA;AACV,CAAC,EAJU,kBAAkB,KAAlB,kBAAkB,QAI5B;AAMD,MAAM,OAAO,iBAAkB,SAAQ,UAAU;IAqBhD,IAAW,eAAe;QACzB,OAAO,IAAI,CAAC,gBAAgB,CAAC;IAC9B,CAAC;IAED,IAAW,OAAO;QACjB,OAAO,IAAI,CAAC,OAAO,CAAC,WAAW,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,KAAK,IAAI,CAAC,SAAS,CAAC,CAAC;IACtE,CAAC;IAED,IAAW,OAAO;QACjB,OAAO,IAAI,CAAC,QAAQ,CAAC;IACtB,CAAC;IAED,IAAW,qBAAqB;QAC/B,OAAO,IAAI,CAAC,sBAAsB,CAAC;IACpC,CAAC;IAED,IAAW,UAAU;QACpB,OAAO,IAAI,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC,KAAK,uCAA+B,CAAC;IACpE,CAAC;IAED,IAAW,SAAS;QACnB,OAAO,IAAI,CAAC,UAAU,CAAC;IACxB,CAAC;IAED,IAAW,qBAAqB,CAAC,WAAgD;QAChF,IAAI,CAAC,sBAAsB,GAAG,WAAW,CAAC;QAC1C,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IAC9D,CAAC;IAED,IAAW,UAAU;QACpB,OAAO,IAAI,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC,KAAK,yCAAiC,CAAC;IACtE,CAAC;IAED,IAAW,WAAW;QACrB,MAAM,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC;QACrC,IAAI,KAAK,CAAC,KAAK,wCAAgC,IAAI,KAAK,CAAC,KAAK,yCAAiC,EAAE,CAAC;YACjG,OAAO,KAAK,CAAC,WAAW,CAAC;QAC1B,CAAC;QACD,OAAO,SAAS,CAAC;IAClB,CAAC;IAED,IAAW,IAAI;QACd,OAAO,IAAI,CAAC,KAAK,CAAC;IACnB,CAAC;IAED,IAAW,cAAc;QACxB,OAAO,IAAI,CAAC,eAAe,CAAC;IAC7B,CAAC;IAED,IAAW,SAAS;QACnB,OAAO,IAAI,CAAC,UAAU,CAAC;IACxB,CAAC;IAID,IAAW,cAAc;QACxB,OAAO,IAAI,CAAC,kBAAkB,IAAI,IAAI,CAAC,SAAS,CAAC;IAClD,CAAC;IAED,IAAW,MAAM;QAChB,OAAO,IAAI,CAAC,OAAO,CAAC;IACrB,CAAC;IAED,IAAW,QAAQ;QAClB,OAAO,IAAI,CAAC,OAAO,CAAC,iBAAiB,CAAC;IACvC,CAAC;IAED,IAAW,UAAU;QACpB,OAAO,IAAI,CAAC,OAAO,CAAC,mBAAmB,CAAC;IACzC,CAAC;IAID,IAAW,KAAK;QACf,OAAO,IAAI,CAAC,MAAM,CAAC;IACpB,CAAC;IAED,IAAW,YAAY;QACtB,OAAO,IAAI,CAAC,aAAa,CAAC;IAC3B,CAAC;IAGD,IAAW,2BAA2B;QACrC,OAAO,IAAI,CAAC,4BAA4B,IAAI,KAAK,CAAC;IACnD,CAAC;IAGD,IAAW,WAAW;QACrB,OAAO,IAAI,CAAC,YAAY,CAAC;IAC1B,CAAC;IAGD,IAAW,iBAAiB;QAC3B,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC;IAC5C,CAAC;IAGD,IAAW,aAAa;QACvB,OAAO,IAAI,CAAC,cAAc,CAAC;IAC5B,CAAC;IAGD,IAAW,gBAAgB;QAC1B,OAAO,IAAI,CAAC,iBAAiB,CAAC;IAC/B,CAAC;IAGD,IAAW,OAAO;QACjB,OAAO,IAAI,CAAC,QAAQ,CAAC;IACtB,CAAC;IAQD,IAAW,QAAQ;QAClB,MAAM,QAAQ,GAAG,IAAI,CAAC,sBAAsB,EAAE,aAAa,CAAC;QAC5D,IAAI,CAAC,QAAQ,EAAE,CAAC;YACf,OAAO,IAAI,CAAC,kBAAkB,IAAI,IAAI,CAAC,SAAS,CAAC;QAClD,CAAC;QAED,IAAI,IAAI,CAAC,aAAa,EAAE,QAAQ,KAAK,QAAQ,EAAE,CAAC;YAC/C,IAAI,CAAC,aAAa,GAAG,IAAI,YAAY,CAAC,IAAI,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC;QACjE,CAAC;QAED,OAAO,IAAI,CAAC,aAAa,CAAC;IAC3B,CAAC;IAGD,IAAW,cAAc;QACxB,OAAO,IAAI,CAAC,eAAe,CAAC;IAC7B,CAAC;IAED,YAAY,MAAoC;QAC/C,KAAK,EAAE,CAAC;QA5JQ,iBAAY,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,OAAO,EAAiC,CAAC,CAAC;QACpF,gBAAW,GAAG,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC;QAOvC,gBAAW,GAAG,eAAe,CAAsB,IAAI,EAAE,EAAE,KAAK,oCAA4B,EAAE,CAAC,CAAC;QAMhG,qBAAgB,GAAY,KAAK,CAAC;QAiGzB,uBAAkB,GAA4B,EAAE,CAAC;QAKjD,mBAAc,GAAwB,EAAE,CAAC;QAKzC,sBAAiB,GAA2B,EAAE,CAAC;QAKxD,aAAQ,GAAY,KAAK,CAAC;QAgCjC,IAAI,CAAC,QAAQ,GAAG,MAAM,CAAC,OAAO,CAAC;QAC/B,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC,KAAK,CAAC;QAC3B,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,SAAS,GAAG,MAAM,CAAC,SAAS,CAAC;QAClC,IAAI,CAAC,UAAU,GAAG,MAAM,CAAC,SAAS,IAAI,IAAI,CAAC,GAAG,EAAE,CAAC;QACjD,IAAI,MAAM,CAAC,UAAU,EAAE,CAAC;YACvB,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,UAAU,EAAE,SAAS,CAAC,CAAC;QACpD,CAAC;QACD,IAAI,CAAC,4BAA4B,GAAG,MAAM,CAAC,gBAAgB,IAAI,CAAC,CAAC;QACjE,IAAI,CAAC,KAAK,GAAG,MAAM,CAAC,IAAI,CAAC;QACzB,IAAI,CAAC,eAAe,GAAG,MAAM,CAAC,cAAc,CAAC;QAC7C,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC,MAAM,CAAC;QAC7B,IAAI,CAAC,UAAU,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;QACvE,IAAI,CAAC,sBAAsB,GAAG,MAAM,CAAC,sBAAsB,IAAI,KAAK,CAAC;QACrE,IAAI,CAAC,sBAAsB,GAAG,MAAM,CAAC,qBAAqB,CAAC;QAC3D,IAAI,CAAC,gBAAgB,GAAG,MAAM,CAAC,eAAe,IAAI,KAAK,CAAC;QAExD,8EAA8E;QAC9E,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,eAAe,CAAC,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,MAAM,KAAK,CAAC,IAAI,gBAAgB,CAAC,MAAM,CAAC,eAAe,CAAC,IAAI,MAAM,CAAC,eAAe,CAAC,KAAK,CAAC,MAAM,KAAK,CAAC,CAAC,CAAC;QAExL,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,QAAQ,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC,CAAC;QACtE,IAAI,CAAC,eAAe,GAAG,MAAM,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;QAEtF,MAAM,MAAM,GAAG,yBAAyB,CAAC,IAAI,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;QAEjE,MAAM,cAAc,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YAE/C,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YAEf,OAAO,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,CACvC,IAAI,CAAC,IAAI,KAAK,gBAAgB,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,iEAAyD;mBAC/G,IAAI,CAAC,IAAI,KAAK,cAAc,IAAI,IAAI,CAAC,MAAM,KAAK,KAAK;mBACrD,IAAI,CAAC,IAAI,KAAK,cAAc,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,6CAA6B,CAClF,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,qBAAqB,GAAG,cAAc,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,gBAAgB,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC;QAEnH,IAAI,CAAC,YAAY,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YAE5C,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YAEf,OAAO,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,CAAC;mBAC1B,CAAC,IAAI,CAAC,qBAAqB;mBAC3B,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,KAAK,uCAA+B,CAAC;QACnE,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,gBAAgB,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC,CAAC,CAAC;QACpH,IAAI,CAAC,EAAE,GAAG,MAAM,CAAC,UAAU,IAAI,WAAW,GAAG,YAAY,EAAE,CAAC;QAE5D,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC,CAAC,EAAE,EAAE;YAC9C,IAAI,CAAC,CAAC,IAAI,KAAK,eAAe,EAAE,CAAC;gBAChC,MAAM,UAAU,GAAG,CAAC,CAAC,mBAAmB,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;gBACtD,MAAM,SAAS,GAAG,IAAI,CAAC,gBAAgB,KAAK,UAAU,CAAC;gBACvD,IAAI,CAAC,gBAAgB,GAAG,UAAU,CAAC;gBACnC,IAAI,SAAS,EAAE,CAAC;oBACf,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;gBAC9D,CAAC;YACF,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;QAEJ,IAAI,oBAAoB,GAAuB,SAAS,CAAC;QACzD,IAAI,CAAC,6BAA6B,GAAG,OAAO,CAAC,MAAM,CAAC,EAAE;YACrD,MAAM,OAAO,GAAG,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACxD,IAAI,OAAO,IAAI,CAAC,oBAAoB,EAAE,CAAC;gBACtC,oBAAoB,GAAG,OAAO,CAAC,gBAAgB,CAAC;YACjD,CAAC;iBAAM,IAAI,CAAC,OAAO,IAAI,oBAAoB,EAAE,CAAC;gBAC7C,IAAI,CAAC,4BAA4B,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,oBAAoB,CAAC;gBACvE,oBAAoB,GAAG,SAAS,CAAC;YAClC,CAAC;YAED,OAAO,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,4BAA4B,CAAC;QAC5D,CAAC,CAAC,CAAC,6BAA6B,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;IAC/C,CAAC;IAED,wBAAwB,CAAC,aAA+B;QACvD,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;YAC1B,MAAM,IAAI,kBAAkB,CAAC,gDAAgD,CAAC,CAAC;QAChF,CAAC;QACD,IAAI,CAAC,eAAe,GAAG,CAAC,GAAG,aAAa,CAAC,CAAC;IAC3C,CAAC;IAED;;OAEG;IACH,aAAa,CAAC,YAA8E,EAAE,KAAe;QAC5G,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,YAAY,EAAE,KAAK,CAAC,CAAC;IACnD,CAAC;IAED;;OAEG;IACH,WAAW,CAAC,QAAuB;QAClC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,EAAE,EAAE,QAAQ,CAAC,EAAE,EAAE,CAAC,CAAC;QAChE,IAAI,CAAC,SAAS,CAAC,aAAa,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC;IAC9C,CAAC;IAED;;OAEG;IACH,cAAc,CAAC,QAAkD;QAChE,IAAI,QAAQ,CAAC,IAAI,KAAK,aAAa,EAAE,CAAC;YACrC,IAAI,CAAC,YAAY,GAAG,QAAQ,CAAC;QAC9B,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,WAAW,EAAE,CAAC;YAC1C,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YACvC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;QAC9D,CAAC;IACF,CAAC;IAED,iBAAiB,CAAC,QAA2B;QAC5C,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACnC,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,QAAQ,CAAC,CAAC;QACrC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IAC9D,CAAC;IAED,QAAQ,CAAC,KAAqB,EAAE,YAAgC;QAC/D,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACpB,IAAI,CAAC,aAAa,GAAG,YAAY,CAAC;QAClC,IAAI,CAAC,4BAA4B,GAAG,CAAC,KAAK,CAAC,SAAS,IAAI,CAAC,CAAC,YAAY,CAAC;QACvE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IAC9D,CAAC;IAED,SAAS,CAAC,MAAwB;QACjC,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC;QACtB,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IAC9D,CAAC;IAED,QAAQ;QACP,IAAI,IAAI,CAAC,OAAO,EAAE,YAAY,EAAE,kBAAkB,EAAE,CAAC;YACpD,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC;QACxB,CAAC;QAED,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,KAAK,qCAA6B,EAAE,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,EAAE,SAAS,CAAC,CAAC;QACjG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,kBAAkB,EAAE,CAAC,CAAC;IACxD,CAAC;IAED,MAAM;QACL,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,EAAE,KAAK,sCAA8B,EAAE,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,EAAE,SAAS,CAAC,CAAC;QAClG,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,kBAAkB,EAAE,CAAC,CAAC;IACxD,CAAC;IAED,YAAY,CAAC,SAAsC;QAClD,IAAI,CAAC,UAAU,GAAG,SAAS,CAAC;QAC5B,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC,CAAC,yDAAyD;IACxH,CAAC;IAED,OAAO,CAAC,IAA4B;QACnC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;QAClB,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IAC9D,CAAC;IAED,iBAAiB,CAAC,MAA2C;QAC5D,IAAI,CAAC,eAAe,GAAG,MAAM,CAAC;QAC9B,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IAC9D,CAAC;IAED,cAAc,CAAC,IAAwB,EAAE,SAAiB;QACzD,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE,CAAC;YACzC,OAAO,KAAK,CAAC;QACd,CAAC;QACD,IAAI,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC;YACjB,OAAO,KAAK,CAAC;QACd,CAAC;QACD,IAAI,CAAC,KAAK,CAAC,OAAO,GAAG,SAAS,CAAC,CAAC,gCAAgC;QAChE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;QAC7D,OAAO,IAAI,CAAC;IACb,CAAC;IAED,OAAO,CAAC,OAAkB;QACzB,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,oCAAoC,CAAC,CAAC;IAC9D,CAAC;IAGD,iBAAiB;QAChB,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC,QAAQ,CAAC;QACxC,IAAI,CAAC,aAAa,GAAG,SAAS,CAAC;QAC/B,IAAI,CAAC,sBAAsB,GAAG,SAAS,CAAC;IACzC,CAAC;IAED,MAAM;QACL,MAAM,UAAU,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,EAAE,CAAC;QAC1C,MAAM,mBAAmB,GAAG,IAAI,CAAC,qBAAqB,CAAC,GAAG,EAAE,CAAC;QAE7D,OAAO;YACN,UAAU,EAAE,IAAI,CAAC,EAAE;YACnB,MAAM,EAAE,IAAI,CAAC,MAAM;YACnB,oBAAoB,EAAE,IAAI,CAAC,cAAc,EAAE,GAAG,CAA4B,IAAI,CAAC,EAAE,CAAC,CAAC,EAAE,YAAY,EAAE,IAAI,CAAC,YAAY,EAAE,CAAC,CAAC;YACxH,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,UAAU,EAAE,UAAU,CAAC,KAAK,uCAA+B,CAAC,CAAC,CAAC,EAAE,KAAK,sCAA8B,EAAE,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,CAAC,UAAU;YAC3I,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,cAAc,EAAE,IAAI,CAAC,cAAc;YACnC,YAAY,EAAE,IAAI,CAAC,YAAY;YAC/B,WAAW,EAAE,IAAI,CAAC,WAAW;YAC7B,iBAAiB,EAAE,IAAI,CAAC,iBAAiB;YACzC,aAAa,EAAE,IAAI,CAAC,aAAa;YACjC,SAAS,EAAE,IAAI,CAAC,UAAU;YAC1B,gBAAgB,EAAE,CAAC,mBAAmB,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,mBAAmB,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,4BAA4B;SACzE,CAAC;IAC7D,CAAC;CACD;AA0MD;;;GAGG;AACH,MAAM,UAAU,6BAA6B,CAAC,GAA4B;IACzE,kBAAkB,CAAC,GAAG,CAAC,CAAC;IAExB,IAAI,CAAC,CAAC,SAAS,IAAI,GAAG,CAAC,EAAE,CAAC;QACzB,OAAO;YACN,OAAO,EAAE,CAAC;YACV,GAAG,GAAG;YACN,eAAe,EAAE,GAAG,CAAC,YAAY;YACjC,WAAW,EAAE,SAAS;SACtB,CAAC;IACH,CAAC;IAED,IAAI,GAAG,CAAC,OAAO,KAAK,CAAC,EAAE,CAAC;QACvB,OAAO;YACN,GAAG,GAAG;YACN,OAAO,EAAE,CAAC;YACV,WAAW,EAAE,GAAG,CAAC,aAAa;SAC9B,CAAC;IACH,CAAC;IAED,OAAO,GAAG,CAAC;AACZ,CAAC;AAED,SAAS,kBAAkB,CAAC,GAA4B;IACvD,wDAAwD;IACxD,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,CAAC;QACpB,GAAG,CAAC,SAAS,GAAG,YAAY,EAAE,CAAC;IAChC,CAAC;IAED,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC;QACvB,GAAG,CAAC,YAAY,GAAG,eAAe,EAAE,CAAC;IACtC,CAAC;IAED,IAAI,SAAS,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,OAAO,KAAK,CAAC,IAAI,GAAG,CAAC,OAAO,KAAK,CAAC,CAAC,EAAE,CAAC;QAClE,IAAI,CAAC,GAAG,CAAC,eAAe,EAAE,CAAC;YAC1B,qHAAqH;YACrH,GAAG,CAAC,eAAe,GAAG,eAAe,EAAE,CAAC;QACzC,CAAC;IACF,CAAC;IAED,mDAAmD;IACnD,IAAK,GAAG,CAAC,eAAuB,KAAK,iBAAiB,EAAE,CAAC;QACxD,GAAG,CAAC,eAAe,GAAG,iBAAiB,CAAC,IAAI,CAAC;IAC9C,CAAC;AACF,CAAC;AAED,SAAS,eAAe;IACvB,MAAM,YAAY,GAAG,IAAI,IAAI,EAAE,CAAC;IAChC,YAAY,CAAC,WAAW,CAAC,YAAY,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC,CAAC;IACzD,OAAO,YAAY,CAAC,OAAO,EAAE,CAAC;AAC/B,CAAC;AAED,MAAM,UAAU,uBAAuB,CAAC,GAAY;IACnD,MAAM,IAAI,GAAG,GAA0B,CAAC;IACxC,OAAO,OAAO,IAAI,KAAK,QAAQ,CAAC;AACjC,CAAC;AAED,MAAM,UAAU,yBAAyB,CAAC,GAAY;IACrD,MAAM,IAAI,GAAG,GAA4B,CAAC;IAC1C,OAAO,uBAAuB,CAAC,GAAG,CAAC;QAClC,OAAO,IAAI,CAAC,YAAY,KAAK,QAAQ;QACrC,OAAO,IAAI,CAAC,SAAS,KAAK,QAAQ;QAClC,GAAG,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,OAAqC,EAAE,EAAE,CAC5D,CAAC,OAAO,CAAC,WAAW,CAAC,mDAAmD,IAAI,cAAc,CAAC,OAAO,CAAC,WAAW,CAAC,CAC/G,CAAC;AACJ,CAAC;AAwCD,MAAM,CAAN,IAAkB,wBAejB;AAfD,WAAkB,wBAAwB;IACzC;;OAEG;IACH,6EAAO,CAAA;IAEP;;OAEG;IACH,2EAAM,CAAA;IAEN;;OAEG;IACH,+EAAQ,CAAA;AACT,CAAC,EAfiB,wBAAwB,KAAxB,wBAAwB,QAezC;AAkCD;;GAEG;AACH,MAAM,UAAU;IAIf,YAAY,YAA8C;QACzD,IAAI,CAAC,MAAM,GAAG,mBAAmB,CAAC,EAAE,SAAS,EAAE,iBAAiB,EAAE,QAAQ,EAAE,MAAM,EAAE,EAAE,YAAY,CAAC,CAAC;QACpG,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC;IAC1B,CAAC;IAED,QAAQ,CAAC,KAAoC;QAC5C,MAAM,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC;QAClC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC;YACf,gEAAgE;YAChE,WAAW,EAAE,EAAE;YACf,IAAI,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,YAAY,CAAC,KAAK,EAAE;YAC/C,aAAa,EAAE,SAAS;YACxB,SAAS,EAAE,EAAE;YACb,UAAU,EAAE,EAAE;YACd,OAAO,EAAE,EAAE;YACX,GAAG,OAAO;YACV,GAAG,KAAK;SACR,EAAE,SAAS,CAAC,CAAC;IACf,CAAC;IAED,UAAU;QACT,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,SAAS,EAAE,SAAS,CAAC,CAAC;IACvC,CAAC;CACD;AAEM,IAAM,SAAS,iBAAf,MAAM,SAAU,SAAQ,UAAU;IACxC,MAAM,CAAC,eAAe,CAAC,QAA8D;QACpF,MAAM,mBAAmB,GAAG,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,OAAO,IAAI,EAAE,CAAC;QAC1D,MAAM,OAAO,GAAG,OAAO,mBAAmB,KAAK,QAAQ,CAAC,CAAC;YACxD,mBAAmB,CAAC,CAAC;YACrB,mBAAmB,CAAC,IAAI,CAAC;QAC1B,OAAO,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC;IACjD,CAAC;IAWD,IAAW,sBAAsB;QAChC,OAAO,IAAI,CAAC,uBAAuB,CAAC;IACrC,CAAC;IACM,yBAAyB,CAAC,OAAwC;QACxE,IAAI,CAAC,uBAAuB,GAAG,OAAO,CAAC;IACxC,CAAC;IAKD,sDAAsD;IACtD,IAAI,SAAS;QACZ,OAAO,IAAI,CAAC,UAAU,CAAC;IACxB,CAAC;IAGD,IAAI,eAAe;QAClB,OAAO,IAAI,CAAC,gBAAgB,CAAC;IAC9B,CAAC;IAQD,IAAI,WAAW;QACd,OAAO,IAAI,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC;IAClC,CAAC;IAED,IAAI,WAAW;QACd,OAAO,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;IAC9B,CAAC;IAGD,IAAI,SAAS;QACZ,OAAO,IAAI,CAAC,UAAU,CAAC;IACxB,CAAC;IAGD,IAAI,eAAe;QAClB,OAAO,IAAI,CAAC,gBAAgB,CAAC;IAC9B,CAAC;IAED,IAAY,aAAa;QACxB,OAAO,IAAI,CAAC,gBAAgB,CAAC,eAAe,CAAC,iBAAiB,CAAC,IAAI,EAAE,YAAY,CAAC,GAAG,CAAC,CAAC;IACxF,CAAC;IAGD,IAAI,iBAAiB;QACpB,OAAO,IAAI,CAAC,aAAa,EAAE,QAAQ;YAClC,IAAI,CAAC,yBAAyB,IAAI,EAAE,CAAC;IACvC,CAAC;IAGD,IAAI,mBAAmB;QACtB,OAAO,IAAI,CAAC,aAAa,EAAE,QAAQ,CAAC,SAAS;YAC5C,IAAI,CAAC,8BAA8B,CAAC;IACtC,CAAC;IAGD,IAAI,UAAU;QACb,OAAO,IAAI,CAAC,WAAW,CAAC;IACzB,CAAC;IAGD,IAAI,WAAW;QACd,OAAO,IAAI,CAAC,YAAY,CAAC;IAC1B,CAAC;IAED,IAAI,KAAK;QACR,OAAO,IAAI,CAAC,YAAY,IAAI,WAAS,CAAC,eAAe,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;IACvE,CAAC;IAED,IAAI,cAAc;QACjB,OAAO,IAAI,CAAC,YAAY,KAAK,SAAS,CAAC;IACxC,CAAC;IAID,IAAI,cAAc;QACjB,OAAO,IAAI,CAAC,eAAe,CAAC;IAC7B,CAAC;IAGD,IAAI,eAAe;QAClB,OAAO,IAAI,CAAC,gBAAgB,CAAC;IAC9B,CAAC;IAGD,IAAI,WAAW;QACd,OAAO,IAAI,CAAC,YAAY,CAAC;IAC1B,CAAC;IAED,YACC,WAAoE,EACpE,iBAA+F,EAClF,UAAwC,EAClC,gBAAoD,EAClD,kBAAwD;QAE7E,KAAK,EAAE,CAAC;QAJsB,eAAU,GAAV,UAAU,CAAa;QACjB,qBAAgB,GAAhB,gBAAgB,CAAmB;QACjC,uBAAkB,GAAlB,kBAAkB,CAAqB;QA5G7D,kBAAa,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,OAAO,EAAQ,CAAC,CAAC;QAC5D,iBAAY,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC;QAEhC,iBAAY,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,OAAO,EAAoB,CAAC,CAAC;QACvE,gBAAW,GAAG,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC;QAiEvC,gBAAW,GAAG,KAAK,CAAC;QA6BX,iBAAY,GAAY,IAAI,CAAC;QAsFtC,4BAAuB,GAAG,IAAI,WAAW,EAA6B,CAAC;QA2KvE,gBAAW,GAAiC,SAAS,CAAC;QAnP7D,MAAM,OAAO,GAAG,yBAAyB,CAAC,WAAW,CAAC,CAAC;QACvD,IAAI,WAAW,IAAI,CAAC,OAAO,EAAE,CAAC;YAC7B,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,yDAAyD,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;QAC9G,CAAC;QAED,IAAI,CAAC,WAAW,GAAG,CAAC,CAAC,CAAC,WAAW,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,WAAW,EAAE,UAAU,IAAI,KAAK,CAAC,CAAC;QACrF,IAAI,CAAC,UAAU,GAAG,CAAC,OAAO,IAAI,WAAW,CAAC,SAAS,CAAC,IAAI,YAAY,EAAE,CAAC;QACvE,IAAI,CAAC,gBAAgB,GAAG,iBAAiB,CAAC,QAAQ,IAAI,mBAAmB,CAAC,UAAU,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAEtG,IAAI,CAAC,SAAS,GAAG,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;QACnE,IAAI,CAAC,UAAU,GAAG,CAAC,OAAO,IAAI,WAAW,CAAC,YAAY,CAAC,IAAI,IAAI,CAAC,GAAG,EAAE,CAAC;QACtE,IAAI,CAAC,gBAAgB,GAAG,CAAC,OAAO,IAAI,WAAW,CAAC,eAAe,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC;QACpF,IAAI,CAAC,YAAY,GAAG,OAAO,CAAC,CAAC,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC,CAAC,SAAS,CAAC;QAElE,wEAAwE;QACxE,MAAM,oBAAoB,GAAG,OAAO,IAAI,WAAW,CAAC,UAAU,CAAC,CAAC,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC,CAAC,SAAS,CAAC;QACpG,IAAI,CAAC,UAAU,GAAG,IAAI,UAAU,CAAC,oBAAoB,IAAI;YACxD,WAAW,EAAE,oBAAoB,CAAC,WAAW;YAC7C,IAAI,EAAE,oBAAoB,CAAC,IAAI;YAC/B,aAAa,EAAE,oBAAoB,CAAC,aAAa,IAAI;gBACpD,UAAU,EAAE,oBAAoB,CAAC,aAAa,CAAC,UAAU;gBACzD,QAAQ,EAAE,oBAAoB,CAAC,aAAa,CAAC,QAAQ;aACrD;YACD,OAAO,EAAE,oBAAoB,CAAC,OAAO;YACrC,SAAS,EAAE,oBAAoB,CAAC,SAAS;YACzC,UAAU,EAAE,oBAAoB,CAAC,UAAU;SAC3C,CAAC,CAAC;QAEH,IAAI,CAAC,yBAAyB,GAAG,WAAW,EAAE,iBAAiB,CAAC;QAChE,IAAI,CAAC,8BAA8B,GAAG,eAAe,CAAC,WAAW,EAAE,sBAAsB,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,WAAW,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC,WAAW,EAAE,sBAAsB,CAAC;QAElL,IAAI,CAAC,gBAAgB,GAAG,WAAW,EAAE,eAAe,IAAI,iBAAiB,CAAC,eAAe,CAAC;QAC1F,IAAI,CAAC,YAAY,GAAG,iBAAiB,CAAC,WAAW,CAAC;QAElD,MAAM,WAAW,GAAG,mBAAmB,CAAC,IAAI,EAAE,IAAI,CAAC,WAAW,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAE7F,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YAC/B,MAAM,OAAO,GAAG,WAAW,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YACzC,IAAI,CAAC,OAAO,EAAE,QAAQ,EAAE,CAAC;gBACxB,OAAO;YACR,CAAC;YAED,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE,CAAC,EAAE;gBAClD,IAAI,EAAE,CAAC,MAAM,KAAK,kBAAkB,EAAE,CAAC;oBACtC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,kBAAkB,EAAE,OAAO,EAAE,CAAC,CAAC;gBAC/D,CAAC;YACF,CAAC,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC,CAAC;QAEJ,IAAI,CAAC,iBAAiB,GAAG,WAAW,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,CAAC,EAAE,EAAE;YACvD,OAAO,OAAO,EAAE,QAAQ,EAAE,YAAY,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,KAAK,CAAC;QACzD,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,iBAAiB,GAAG,WAAW,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,CAAC,EAAE,EAAE;YACvD,OAAO,CAAC,CAAC,OAAO,EAAE,QAAQ,EAAE,qBAAqB,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAC3D,CAAC,CAAC,CAAC;IACJ,CAAC;IAED,mBAAmB,CAAC,sBAAgC,EAAE,mBAAyC;QAC9F,MAAM,OAAO,GAAG,IAAI,CAAC,eAAe,KAAK,IAAI,CAAC,SAAS,CACtD,mBAAmB;YAClB,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,sBAAsB,CAAC,IAAI,EAAE,mBAAmB,CAAC;YAC3E,CAAC,CAAC,sBAAsB;gBACvB,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,mCAAmC,CAAC,IAAI,CAAC;gBACnE,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,oBAAoB,CAAC,IAAI,CAAC,CACtD,CAAC;QAEF,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,MAAM,CAAC,EAAE;YAC/B,IAAI,CAAC,oBAAoB,CAAC,OAAO,CAAC,kBAAkB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;QACpE,CAAC,CAAC,CAAC,CAAC;IACL,CAAC;IAGD,mBAAmB,CAAC,MAAiC;QACpD,MAAM,KAAK,GAAG,MAAM,CAAC,OAAO,KAAK,UAAU,CAAC,CAAC,CAAC,8BAA8B,CAAC,IAAI,CAAC,CAAC;YAClF,MAAM,CAAC,OAAO,KAAK,UAAU,CAAC,CAAC,CAAC,8BAA8B,CAAC,IAAI,CAAC,CAAC;gBACpE,MAAM,CAAC,OAAO,KAAK,cAAc,CAAC,CAAC,CAAC,8BAA8B,CAAC,gBAAgB,CAAC,CAAC,CAAC,IAAI,CAAC;QAC7F,IAAI,KAAK,KAAK,IAAI,EAAE,CAAC;YACpB,OAAO;QACR,CAAC;QAED,IAAI,CAAC,IAAI,CAAC,uBAAuB,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,IAAI,CAAC,uBAAuB,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,SAAS,KAAK,8BAA8B,CAAC,IAAI,EAAE,CAAC;YACtJ,IAAI,CAAC,uBAAuB,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,EAAE,EAAE,SAAS,EAAE,KAAK,EAAE,GAAG,EAAE,MAAM,CAAC,GAAG,EAAE,CAAC,CAAC;QACrF,CAAC;IACF,CAAC;IAEO,YAAY,CAAC,GAAwB;QAC5C,MAAM,QAAQ,GAAG,GAAG,CAAC,QAAQ,CAAC;QAC9B,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC;YAC9B,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,oCAAoC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YACjF,OAAO,EAAE,CAAC;QACX,CAAC;QAED,IAAI,CAAC;YACJ,OAAO,QAAQ,CAAC,GAAG,CAAC,CAAC,GAAiC,EAAE,EAAE;gBACzD,MAAM,aAAa,GAClB,OAAO,GAAG,CAAC,OAAO,KAAK,QAAQ;oBAC9B,CAAC,CAAC,IAAI,CAAC,0BAA0B,CAAC,GAAG,CAAC,OAAO,CAAC;oBAC9C,CAAC,CAAC,uBAAuB,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;gBAEzC,kFAAkF;gBAClF,MAAM,YAAY,GAA6B,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;gBACzF,MAAM,OAAO,GAAG,IAAI,gBAAgB,CAAC;oBACpC,OAAO,EAAE,IAAI;oBACb,OAAO,EAAE,aAAa;oBACtB,YAAY;oBACZ,SAAS,EAAE,GAAG,CAAC,SAAS,IAAI,CAAC,CAAC;oBAC9B,UAAU,EAAE,GAAG,CAAC,SAAS;oBACzB,YAAY,EAAE,GAAG,CAAC,YAAY;oBAC9B,gBAAgB,EAAE,GAAG,CAAC,gBAAgB;oBACtC,OAAO,EAAE,GAAG,CAAC,OAAO;iBACpB,CAAC,CAAC;gBACH,OAAO,CAAC,qBAAqB,GAAG,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,SAAS,EAAE,GAAG,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,qBAAqB,CAAC;gBACxG,mDAAmD;gBACnD,IAAI,GAAG,CAAC,QAAQ,IAAI,GAAG,CAAC,MAAM,IAAK,GAAW,CAAC,oBAAoB,EAAE,CAAC;oBACrE,MAAM,KAAK,GAAG,CAAC,GAAG,CAAC,KAAK,IAAI,UAAU,IAAI,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,6DAA6D;wBACnH,qBAAqB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC;oBAE9C,+BAA+B;oBAC/B,MAAM,MAAM,GAAG,sBAAsB,IAAI,GAAG,CAAC,CAAC;wBAC7C,mEAAmE;wBACnE,EAAE,YAAY,EAAE,GAAG,CAAC,oBAAoB,EAAsB,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC;oBAC7E,OAAO,CAAC,QAAQ,GAAG,IAAI,iBAAiB,CAAC;wBACxC,eAAe,EAAE,GAAG,CAAC,QAAQ,IAAI,CAAC,IAAI,cAAc,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;wBACnE,OAAO,EAAE,IAAI;wBACb,KAAK;wBACL,YAAY,EAAE,GAAG,CAAC,YAAY;wBAC9B,SAAS,EAAE,OAAO,CAAC,EAAE;wBACrB,UAAU,EAAE,GAAG,CAAC,UAAU,IAAI,EAAE,KAAK,EAAE,GAAG,CAAC,UAAU,CAAC,CAAC,sCAA8B,CAAC,oCAA4B,EAAE,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE;wBAC7I,IAAI,EAAE,GAAG,CAAC,IAAI;wBACd,SAAS,EAAE,GAAG,CAAC,SAAS;wBACxB,cAAc,EAAE,GAAG,CAAC,cAAc;wBAClC,MAAM;wBACN,SAAS,EAAE,GAAG,CAAC,SAAS;wBACxB,UAAU,EAAE,GAAG,CAAC,UAAU;wBAC1B,gBAAgB,EAAE,GAAG,CAAC,gBAAgB;wBACtC,eAAe,EAAE,OAAO,CAAC,eAAe;wBACxC,cAAc,EAAE,GAAG,CAAC,oBAAoB,EAAE,GAAG,CAAiB,IAAI,CAAC,EAAE,CAAC,CAAC,EAAE,YAAY,EAAE,IAAI,CAAC,YAAY,EAAE,CAAC,CAAC;qBAC5G,CAAC,CAAC;oBACH,OAAO,CAAC,QAAQ,CAAC,qBAAqB,GAAG,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAE,SAAS,EAAE,GAAG,CAAC,SAAS,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,qBAAqB,CAAC;oBACjH,IAAI,GAAG,CAAC,WAAW,EAAE,CAAC,CAAC,kFAAkF;wBACxG,OAAO,CAAC,QAAQ,CAAC,cAAc,CAAC,MAAM,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC;oBAC1D,CAAC;oBAED,GAAG,CAAC,iBAAiB,EAAE,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,OAAO,CAAC,QAAS,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;oBACjF,GAAG,CAAC,aAAa,EAAE,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,OAAO,CAAC,QAAS,CAAC,iBAAiB,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;gBACjF,CAAC;gBACD,OAAO,OAAO,CAAC;YAChB,CAAC,CAAC,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YAChB,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,2BAA2B,EAAE,KAAK,CAAC,CAAC;YAC1D,OAAO,EAAE,CAAC;QACX,CAAC;IACF,CAAC;IAEO,kBAAkB,CAAC,GAA6B;QACvD,MAAM,YAAY,GAAG,GAAG,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC;YACvD,CAAC,CAAC,GAAG,CAAC,CAAC;YACP,EAAE,SAAS,EAAE,EAAE,EAAE,CAAC;QAEnB,YAAY,CAAC,SAAS,GAAG,YAAY,CAAC,SAAS,CAAC,GAAG,CAA4B,CAAC,CAAC,EAA6B,EAAE;YAC/G,uBAAuB;YACvB,IAAI,CAAC,IAAI,QAAQ,IAAI,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC;gBACnD,OAAO;oBACN,IAAI,EAAE,SAAS;oBACf,EAAE,EAAE,CAAC,CAAC,EAAE,IAAI,EAAE;oBACd,IAAI,EAAE,CAAC,CAAC,IAAI;oBACZ,KAAK,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK;oBACzB,KAAK,EAAE,CAAC,CAAC,KAAK;oBACd,gBAAgB,EAAE,CAAC,CAAC,gBAAgB;oBACpC,UAAU,EAAE,CAAC,CAAC,UAAU;iBACxB,CAAC;YACH,CAAC;iBAAM,CAAC;gBACP,OAAO,CAAC,CAAC;YACV,CAAC;QACF,CAAC,CAAC,CAAC;QAEH,OAAO,YAAY,CAAC;IACrB,CAAC;IAEO,0BAA0B,CAAC,OAAe;QACjD,2FAA2F;QAC3F,MAAM,KAAK,GAAG,CAAC,IAAI,mBAAmB,CAAC,IAAI,WAAW,CAAC,CAAC,EAAE,OAAO,CAAC,MAAM,CAAC,EAAE,EAAE,WAAW,EAAE,CAAC,EAAE,eAAe,EAAE,CAAC,EAAE,SAAS,EAAE,CAAC,EAAE,aAAa,EAAE,CAAC,EAAE,EAAE,OAAO,CAAC,CAAC,CAAC;QAC7J,OAAO;YACN,IAAI,EAAE,OAAO;YACb,KAAK;SACL,CAAC;IACH,CAAC;IAID,WAAW;QACV,OAAO,IAAI,CAAC,SAAS,CAAC;IACvB,CAAC;IAED,eAAe;QACd,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACtC,OAAO,CAAC,eAAe,GAAG,KAAK,CAAC;QACjC,CAAC;IACF,CAAC;IAED,aAAa,CAAC,SAA6B;QAC1C,IAAI,UAAwC,CAAC;QAC7C,IAAI,eAAe,GAAG,CAAC,CAAC,CAAC;QACzB,IAAI,SAAS,KAAK,SAAS,EAAE,CAAC;YAC7B,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,OAAO,EAAE,KAAK,EAAE,EAAE;gBACzC,IAAI,OAAO,CAAC,EAAE,KAAK,SAAS,EAAE,CAAC;oBAC9B,eAAe,GAAG,KAAK,CAAC;oBACxB,UAAU,GAAG,OAAO,CAAC;oBACrB,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC;gBAChC,CAAC;YACF,CAAC,CAAC,CAAC;YAEH,IAAI,CAAC,UAAU,EAAE,CAAC;gBACjB,OAAO,CAAC,qBAAqB;YAC9B,CAAC;QACF,CAAC;QAED,MAAM,kBAAkB,GAAG,IAAI,GAAG,EAAU,CAAC;QAC7C,MAAM,mBAAmB,GAAG,IAAI,GAAG,EAAU,CAAC;QAC9C,KAAK,IAAI,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC;YACxD,MAAM,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;YAClC,IAAI,IAAI,CAAC,WAAW,IAAI,CAAC,UAAU,EAAE,CAAC;gBACrC,OAAO,CAAC,eAAe,GAAG,KAAK,CAAC;YACjC,CAAC;iBAAM,IAAI,UAAU,IAAI,CAAC,IAAI,eAAe,EAAE,CAAC;gBAC/C,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC;gBAC/B,kBAAkB,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;gBACnC,IAAI,OAAO,CAAC,QAAQ,EAAE,CAAC;oBACtB,mBAAmB,CAAC,GAAG,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;gBAC9C,CAAC;YACF,CAAC;iBAAM,IAAI,UAAU,IAAI,CAAC,GAAG,eAAe,EAAE,CAAC;gBAC9C,OAAO,CAAC,eAAe,GAAG,KAAK,CAAC;YACjC,CAAC;QACF,CAAC;QAED,IAAI,CAAC,WAAW,GAAG,UAAU,CAAC;QAC9B,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC;YACtB,IAAI,EAAE,eAAe;YACrB,kBAAkB;YAClB,mBAAmB;SACnB,CAAC,CAAC;IACJ,CAAC;IAGD,IAAW,UAAU;QACpB,OAAO,IAAI,CAAC,WAAW,CAAC;IACzB,CAAC;IAEO,oBAAoB,CAAC,UAAqC;QACjE,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAClC,MAAM,qBAAqB,GAAG,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,SAAS,KAAK,OAAO,CAAC,EAAE,CAAC,CAAC;YAC/E,OAAO,CAAC,qBAAqB,GAAG,qBAAqB,CAAC;YACtD,IAAI,OAAO,CAAC,QAAQ,EAAE,CAAC;gBACtB,OAAO,CAAC,QAAQ,CAAC,qBAAqB,GAAG,qBAAqB,CAAC;YAChE,CAAC;QACF,CAAC,CAAC,CAAC;QAEH,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,WAAW,EAAE,CAAC,CAAC;IAC/C,CAAC;IAED,UAAU,CAAC,OAA2B,EAAE,YAAsC,EAAE,OAAe,EAAE,QAA+B,EAAE,SAA0B,EAAE,YAAgC,EAAE,YAAqB,EAAE,YAAgC,EAAE,WAAyC,EAAE,sBAAgC,EAAE,OAAgB,EAAE,iBAAqC;QAC5X,MAAM,gBAAgB,GAAG,CAAC,GAAG,IAAI,CAAC,uBAAuB,CAAC,MAAM,EAAE,CAAC,CAAC;QACpE,IAAI,CAAC,uBAAuB,CAAC,KAAK,EAAE,CAAC;QACrC,MAAM,OAAO,GAAG,IAAI,gBAAgB,CAAC;YACpC,OAAO,EAAE,IAAI;YACb,OAAO;YACP,YAAY;YACZ,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,OAAO;YACP,QAAQ;YACR,YAAY;YACZ,YAAY;YACZ,eAAe,EAAE,WAAW;YAC5B,sBAAsB;YACtB,OAAO;YACP,gBAAgB,EAAE,gBAAgB,CAAC,MAAM,CAAC,CAAC,CAAC,gBAAgB,CAAC,CAAC,CAAC,SAAS;YACxE,iBAAiB;SACjB,CAAC,CAAC;QACH,OAAO,CAAC,QAAQ,GAAG,IAAI,iBAAiB,CAAC;YACxC,eAAe,EAAE,EAAE;YACnB,OAAO,EAAE,IAAI;YACb,KAAK,EAAE,SAAS;YAChB,YAAY;YACZ,SAAS,EAAE,OAAO,CAAC,EAAE;YACrB,sBAAsB;YACtB,cAAc,EAAE,SAAS;SACzB,CAAC,CAAC;QAEH,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC7B,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACnC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,YAAY,EAAE,OAAO,EAAE,CAAC,CAAC;QACxD,OAAO,OAAO,CAAC;IAChB,CAAC;IAEM,cAAc,CAAC,KAAa;QAClC,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;QAC1B,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,gBAAgB,EAAE,KAAK,EAAE,CAAC,CAAC;IAC3D,CAAC;IAED,aAAa,CAAC,OAAyB,EAAE,YAAsC;QAC9E,OAAO,CAAC,YAAY,GAAG,YAAY,CAAC;QACpC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,gBAAgB,EAAE,OAAO,EAAE,CAAC,CAAC;IAC7D,CAAC;IAED,YAAY,CAAC,OAAyB;QACrC,kFAAkF;QAClF,MAAM,QAAQ,GAAG,OAAO,CAAC,OAAO,CAAC;QACjC,MAAM,KAAK,GAAG,QAAQ,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,SAA2B,EAAE,EAAE,CAAC,SAAS,CAAC,EAAE,KAAK,OAAO,CAAC,EAAE,CAAC,CAAC;QAEzG,IAAI,KAAK,KAAK,CAAC,CAAC,EAAE,CAAC;YAClB,OAAO;QACR,CAAC;QAED,QAAQ,CAAC,SAAS,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;QAEpC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QACtB,OAAO,CAAC,QAAQ,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;QAChC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAE7B,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,eAAe,EAAE,SAAS,EAAE,OAAO,CAAC,EAAE,EAAE,UAAU,EAAE,OAAO,CAAC,QAAQ,EAAE,EAAE,EAAE,MAAM,2CAAmC,EAAE,CAAC,CAAC;QAC1J,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,YAAY,EAAE,OAAO,EAAE,CAAC,CAAC;IACzD,CAAC;IAED,sBAAsB,CAAC,OAAyB,EAAE,QAAuB,EAAE,KAAe;QACzF,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;YACvB,OAAO,CAAC,QAAQ,GAAG,IAAI,iBAAiB,CAAC;gBACxC,eAAe,EAAE,EAAE;gBACnB,OAAO,EAAE,IAAI;gBACb,SAAS,EAAE,OAAO,CAAC,EAAE;gBACrB,cAAc,EAAE,SAAS;aACzB,CAAC,CAAC;QACJ,CAAC;QAED,IAAI,OAAO,CAAC,QAAQ,CAAC,UAAU,EAAE,CAAC;YACjC,MAAM,IAAI,KAAK,CAAC,iEAAiE,CAAC,CAAC;QACpF,CAAC;QAED,IAAI,QAAQ,CAAC,IAAI,KAAK,aAAa,IAAI,QAAQ,CAAC,IAAI,KAAK,WAAW,EAAE,CAAC;YACtE,OAAO,CAAC,QAAQ,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;QAC3C,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,cAAc,EAAE,CAAC;YAC7C,OAAO,CAAC,QAAQ,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;QAC9C,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,MAAM,EAAE,CAAC;YACrC,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,CAAC,GAAG,EAAE,KAAK,EAAE,QAAQ,CAAC,KAAK,EAAE,CAAC,CAAC;QACvF,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,cAAc,IAAI,QAAQ,CAAC,MAAM,EAAE,CAAC;YAChE,OAAO,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE,EAAE,EAAE,YAAY,EAAE,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC,CAAC;YACvE,OAAO,CAAC,QAAQ,CAAC,aAAa,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;QACjD,CAAC;aAAM,IAAI,QAAQ,CAAC,IAAI,KAAK,oBAAoB,EAAE,CAAC;YACnD,uDAAuD;YACvD,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,6BAA6B,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;QAChF,CAAC;aAAM,CAAC;YACP,OAAO,CAAC,QAAQ,CAAC,aAAa,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;QACjD,CAAC;IACF,CAAC;IAED,aAAa,CAAC,EAAU,EAAE,iDAAmE;QAC5F,MAAM,KAAK,GAAG,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC;QACrE,MAAM,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QAEtC,IAAI,KAAK,KAAK,CAAC,CAAC,EAAE,CAAC;YAClB,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,eAAe,EAAE,SAAS,EAAE,OAAO,CAAC,EAAE,EAAE,UAAU,EAAE,OAAO,CAAC,QAAQ,EAAE,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC;YACnH,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC;YAChC,OAAO,CAAC,QAAQ,EAAE,OAAO,EAAE,CAAC;QAC7B,CAAC;IACF,CAAC;IAED,aAAa,CAAC,OAAyB;QACtC,IAAI,OAAO,CAAC,QAAQ,EAAE,CAAC;YACtB,OAAO,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC;QAC3B,CAAC;IACF,CAAC;IAED,WAAW,CAAC,OAAyB,EAAE,MAAwB;QAC9D,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;YACvB,OAAO,CAAC,QAAQ,GAAG,IAAI,iBAAiB,CAAC;gBACxC,eAAe,EAAE,EAAE;gBACnB,OAAO,EAAE,IAAI;gBACb,SAAS,EAAE,OAAO,CAAC,EAAE;gBACrB,cAAc,EAAE,SAAS;aACzB,CAAC,CAAC;QACJ,CAAC;QAED,OAAO,CAAC,QAAQ,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;IACpC,CAAC;IAED,YAAY,CAAC,OAAyB,EAAE,SAAsC;QAC7E,IAAI,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;YACvB,8BAA8B;YAC9B,OAAO;QACR,CAAC;QAED,OAAO,CAAC,QAAQ,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;IAC1C,CAAC;IAED,gBAAgB,CAAC,OAAyB,EAAE,QAA2B;QACtE,OAAO,CAAC,QAAQ,GAAG,QAAQ,CAAC;QAC5B,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,aAAa,EAAE,QAAQ,EAAE,CAAC,CAAC;IAC3D,CAAC;IAED,QAAQ;QACP,OAAO;YACN,iBAAiB,EAAE,IAAI,CAAC,iBAAiB;YACzC,sBAAsB,EAAE,IAAI,CAAC,mBAAmB;YAChD,eAAe,EAAE,IAAI,CAAC,eAAe;YACrC,QAAQ,EAAE,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAgC,EAAE;gBAChE,MAAM,OAAO,GAAG;oBACf,GAAG,CAAC,CAAC,OAAO;oBACZ,KAAK,EAAE,CAAC,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAM,EAAE,EAAE,CAAC,CAAC,IAAI,QAAQ,IAAI,CAAC,CAAC,CAAC,CAAE,CAAC,CAAC,MAAmB,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;iBACzF,CAAC;gBACF,MAAM,KAAK,GAAG,CAAC,CAAC,QAAQ,EAAE,KAAK,CAAC;gBAChC,MAAM,SAAS,GAAG,KAAK,IAAI,QAAQ,IAAI,KAAK,CAAC,CAAC,CAAE,KAAK,CAAC,MAAmB,EAAE,CAAC,CAAC;oBAC5E,KAAK,CAAC,CAAC,CAAC,EAAE,GAAG,KAAK,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC;gBAClC,OAAO;oBACN,SAAS,EAAE,CAAC,CAAC,EAAE;oBACf,OAAO;oBACP,YAAY,EAAE,CAAC,CAAC,YAAY;oBAC5B,QAAQ,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC;wBACrB,CAAC,CAAC,QAAQ,CAAC,cAAc,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE;4BAC1C,mEAAmE;4BACnE,IAAI,IAAI,CAAC,IAAI,KAAK,UAAU,EAAE,CAAC;gCAC9B,OAAO,IAAI,CAAC,QAAQ,CAAC;4BACtB,CAAC;iCAAM,IAAI,IAAI,CAAC,IAAI,KAAK,iBAAiB,EAAE,CAAC;gCAC5C,OAAO,IAAI,CAAC,OAAO,CAAC;4BACrB,CAAC;iCAAM,IAAI,IAAI,CAAC,IAAI,KAAK,UAAU,EAAE,CAAC;gCACrC,OAAO;oCACN,IAAI,EAAE,UAAU;oCAChB,KAAK,EAAE,IAAI,CAAC,KAAK;oCACjB,EAAE,EAAE,IAAI,CAAC,EAAE;oCACX,QAAQ,EAAE,IAAI,CAAC,QAAQ;iCACvB,CAAC;4BACH,CAAC;iCAAM,IAAI,IAAI,CAAC,IAAI,KAAK,cAAc,EAAE,CAAC;gCACzC,OAAO,EAAE,GAAG,IAAI,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC;4BACnC,CAAC;iCAAM,CAAC;gCACP,mDAAmD;gCACnD,OAAO,IAAW,CAAC,CAAC,OAAO;4BAC5B,CAAC;wBACF,CAAC,CAAC;wBACF,CAAC,CAAC,SAAS;oBACZ,qBAAqB,EAAE,CAAC,CAAC,qBAAqB;oBAC9C,KAAK,EAAE,SAAS;oBAChB,SAAS,EAAE,CAAC,CAAC,SAAS;oBACtB,YAAY,EAAE,CAAC,CAAC,YAAY;oBAC5B,gBAAgB,EAAE,CAAC,CAAC,gBAAgB;oBACpC,OAAO,EAAE,CAAC,CAAC,OAAO;oBAClB,GAAG,CAAC,CAAC,QAAQ,EAAE,MAAM,EAAE;iBACvB,CAAC;YACH,CAAC,CAAC;SACF,CAAC;IACH,CAAC;IAED,MAAM;QACL,MAAM,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;QAC/C,OAAO;YACN,OAAO,EAAE,CAAC;YACV,GAAG,IAAI,CAAC,QAAQ,EAAE;YAClB,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,YAAY,EAAE,IAAI,CAAC,UAAU;YAC7B,UAAU,EAAE,IAAI,CAAC,WAAW;YAC5B,eAAe,EAAE,IAAI,CAAC,gBAAgB;YACtC,WAAW,EAAE,IAAI,CAAC,YAAY;YAC9B,6CAA6C;YAC7C,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC;gBAChB,UAAU,EAAE;oBACX,OAAO,EAAE,UAAU,CAAC,OAAO;oBAC3B,WAAW,EAAE,UAAU,CAAC,WAAW;oBACnC,IAAI,EAAE,UAAU,CAAC,IAAI;oBACrB,aAAa,EAAE,UAAU,CAAC,aAAa,CAAC,CAAC,CAAC;wBACzC,UAAU,EAAE,UAAU,CAAC,aAAa,CAAC,UAAU;wBAC/C,QAAQ,EAAE,UAAU,CAAC,aAAa,CAAC,QAAQ;qBAC3C,CAAC,CAAC,CAAC,SAAS;oBACb,SAAS,EAAE,UAAU,CAAC,SAAS;oBAC/B,UAAU,EAAE,UAAU,CAAC,UAAU;iBACjC;aACD,CAAC,CAAC,CAAC,EAAE,CAAC;SACP,CAAC;IACH,CAAC;IAEQ,OAAO;QACf,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,QAAQ,EAAE,OAAO,EAAE,CAAC,CAAC;QACnD,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,CAAC;QAE1B,KAAK,CAAC,OAAO,EAAE,CAAC;IACjB,CAAC;CACD,CAAA;AA3lBY,SAAS;IAmHnB,WAAA,WAAW,CAAA;IACX,WAAA,iBAAiB,CAAA;IACjB,WAAA,mBAAmB,CAAA;GArHT,SAAS,CA2lBrB;;AAED,MAAM,UAAU,YAAY,CAAC,YAAsC,EAAE,IAAY;IAChF,OAAO;QACN,SAAS,EAAE,YAAY,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC;YAC3C,GAAG,CAAC;YACJ,KAAK,EAAE,CAAC,CAAC,KAAK,IAAI;gBACjB,KAAK,EAAE,CAAC,CAAC,KAAK,CAAC,KAAK,GAAG,IAAI;gBAC3B,YAAY,EAAE,CAAC,CAAC,KAAK,CAAC,YAAY,GAAG,IAAI;aACzC;SACD,CAAC,CAAC;KACH,CAAC;AACH,CAAC;AAED,MAAM,UAAU,uBAAuB,CAAC,GAAoB,EAAE,GAAoB;IACjF,IAAI,GAAG,CAAC,OAAO,IAAI,GAAG,CAAC,OAAO,EAAE,CAAC;QAChC,MAAM,aAAa,GAAG,GAAG,CAAC,OAAO,CAAC,MAAM,KAAK,GAAG,CAAC,OAAO,CAAC,MAAM;eAC3D,GAAG,CAAC,OAAO,CAAC,SAAS,KAAK,GAAG,CAAC,OAAO,CAAC,SAAS;eAC/C,GAAG,CAAC,OAAO,CAAC,IAAI,KAAK,GAAG,CAAC,OAAO,CAAC,IAAI;eACrC,GAAG,CAAC,OAAO,CAAC,KAAK,KAAK,GAAG,CAAC,OAAO,CAAC,KAAK;eACvC,GAAG,CAAC,OAAO,CAAC,QAAQ,KAAK,GAAG,CAAC,OAAO,CAAC,QAAQ,CAAC;QAClD,IAAI,CAAC,aAAa,EAAE,CAAC;YACpB,OAAO,KAAK,CAAC;QACd,CAAC;IACF,CAAC;SAAM,IAAI,GAAG,CAAC,OAAO,IAAI,GAAG,CAAC,OAAO,EAAE,CAAC;QACvC,OAAO,KAAK,CAAC;IACd,CAAC;IAED,OAAO,MAAM,CAAC,GAAG,CAAC,SAAS,EAAE,GAAG,CAAC,SAAS,CAAC;QAC1C,GAAG,CAAC,WAAW,KAAK,GAAG,CAAC,WAAW;QACnC,GAAG,CAAC,iBAAiB,KAAK,GAAG,CAAC,iBAAiB,CAAC;AAClD,CAAC;AAED,MAAM,UAAU,oBAAoB,CAAC,GAAoB,EAAE,GAA6B;IACvF,MAAM,aAAa,GAAG,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC;IAChE,OAAO;QACN,KAAK,EAAE,GAAG,CAAC,KAAK,GAAG,aAAa;QAChC,SAAS,EAAE,GAAG,CAAC,SAAS;QACxB,iBAAiB,EAAE,GAAG,CAAC,iBAAiB;QACxC,WAAW,EAAE,GAAG,CAAC,WAAW;QAC5B,OAAO,EAAE,GAAG,CAAC,OAAO;KACpB,CAAC;AACH,CAAC;AAED,MAAM,UAAU,uBAAuB,CAAC,SAA2C;IAClF,IAAI,SAAS,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QAC5B,OAAO,EAAE,CAAC;IACX,CAAC;IAED,MAAM,YAAY,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,OAAO,CAAC,EAAE,IAAI,GAAG,EAAU,CAAC,CAAC;IACzF,MAAM,KAAK,GAAG,YAAY,CAAC,IAAI,KAAK,CAAC,CAAC,CAAC;QACtC,QAAQ,CAAC,IAAc,EAAE,IAAwC,EAAE,YAAY,CAAC,IAAI,CAAC,CAAC,CAAC;QACvF,QAAQ,CAAC,IAAe,EAAE,IAA2C,EAAE,YAAY,CAAC,IAAI,CAAC,CAAC;IAC3F,OAAO,KAAK,CAAC;AACd,CAAC;AAED,MAAM,CAAN,IAAY,8BAIX;AAJD,WAAY,8BAA8B;IACzC,mFAAQ,CAAA;IACR,mFAAQ,CAAA;IACR,2GAAoB,CAAA;AACrB,CAAC,EAJW,8BAA8B,KAA9B,8BAA8B,QAIzC;AAOD,6DAA6D;AAC7D,MAAM,KAAW,oBAAoB,CAgCpC;AAhCD,WAAiB,oBAAoB;IACvB,2BAAM,GAAG,+BAA+B,CAAC;IAEtD,SAAgB,SAAS,CAAC,SAAiB,EAAE,UAAkB,EAAE,KAAa,EAAE,QAAiB;QAChG,OAAO,GAAG,CAAC,IAAI,CAAC;YACf,MAAM,EAAE,oBAAoB,CAAC,MAAM;YACnC,SAAS,EAAE,SAAS;YACpB,IAAI,EAAE,SAAS,UAAU,IAAI,KAAK,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,QAAQ,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;SACvE,CAAC,CAAC;IACJ,CAAC;IANe,8BAAS,YAMxB,CAAA;IAED,SAAgB,QAAQ,CAAC,GAAQ;QAChC,IAAI,GAAG,CAAC,MAAM,KAAK,oBAAoB,CAAC,MAAM,EAAE,CAAC;YAChD,OAAO,SAAS,CAAC;QAClB,CAAC;QAED,MAAM,KAAK,GAAG,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAClC,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YACtB,OAAO,SAAS,CAAC;QAClB,CAAC;QAED,MAAM,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,KAAK,CAAC,GAAG,KAAK,CAAC;QAC1C,IAAI,IAAI,KAAK,MAAM,EAAE,CAAC;YACrB,OAAO,SAAS,CAAC;QAClB,CAAC;QAED,OAAO;YACN,SAAS,EAAE,GAAG,CAAC,SAAS;YACxB,UAAU,EAAE,UAAU;YACtB,KAAK,EAAE,MAAM,CAAC,KAAK,CAAC;SACpB,CAAC;IACH,CAAC;IApBe,6BAAQ,WAoBvB,CAAA;AACF,CAAC,EAhCgB,oBAAoB,KAApB,oBAAoB,QAgCpC","file":"chatModel.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { asArray } from '../../../../base/common/arrays.js';\nimport { softAssertNever } from '../../../../base/common/assert.js';\nimport { BugIndicatingError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { IMarkdownString, MarkdownString, isMarkdownString } from '../../../../base/common/htmlContent.js';\nimport { Disposable, IDisposable } from '../../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../../base/common/map.js';\nimport { revive } from '../../../../base/common/marshalling.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { equals } from '../../../../base/common/objects.js';\nimport { IObservable, autorun, autorunSelfDisposable, derived, observableFromEvent, observableSignalFromEvent, observableValue, observableValueOpts } from '../../../../base/common/observable.js';\nimport { basename, isEqual } from '../../../../base/common/resources.js';\nimport { ThemeIcon } from '../../../../base/common/themables.js';\nimport { WithDefinedProps } from '../../../../base/common/types.js';\nimport { URI, UriComponents, UriDto, isUriComponents } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { IRange } from '../../../../editor/common/core/range.js';\nimport { OffsetRange } from '../../../../editor/common/core/ranges/offsetRange.js';\nimport { ISelection } from '../../../../editor/common/core/selection.js';\nimport { TextEdit } from '../../../../editor/common/languages.js';\nimport { EditSuggestionId } from '../../../../editor/common/textModelEditSource.js';\nimport { localize } from '../../../../nls.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { CellUri, ICellEditOperation } from '../../notebook/common/notebookCommon.js';\nimport { migrateLegacyTerminalToolSpecificData } from './chat.js';\nimport { IChatAgentCommand, IChatAgentData, IChatAgentResult, IChatAgentService, UserSelectedTools, reviveSerializedAgent } from './chatAgents.js';\nimport { IChatEditingService, IChatEditingSession } from './chatEditingService.js';\nimport { ChatRequestTextPart, IParsedChatRequest, reviveParsedChatRequest } from './chatParserTypes.js';\nimport { ChatAgentVoteDirection, ChatAgentVoteDownReason, ChatResponseClearToPreviousToolInvocationReason, ElicitationState, IChatAgentMarkdownContentWithVulnerability, IChatClearToPreviousToolInvocation, IChatCodeCitation, IChatCommandButton, IChatConfirmation, IChatContentInlineReference, IChatContentReference, IChatEditingSessionAction, IChatElicitationRequest, IChatElicitationRequestSerialized, IChatExtensionsContent, IChatFollowup, IChatLocationData, IChatMarkdownContent, IChatMcpServersStarting, IChatMultiDiffData, IChatNotebookEdit, IChatPrepareToolInvocationPart, IChatProgress, IChatProgressMessage, IChatPullRequestContent, IChatResponseCodeblockUriPart, IChatResponseProgressFileTreeData, IChatSessionContext, IChatTask, IChatTaskSerialized, IChatTextEdit, IChatThinkingPart, IChatToolInvocation, IChatToolInvocationSerialized, IChatTreeData, IChatUndoStop, IChatUsedContext, IChatWarningMessage, isIUsedContext } from './chatService.js';\nimport { LocalChatSessionUri } from './chatUri.js';\nimport { ChatRequestToolReferenceEntry, IChatRequestVariableEntry } from './chatVariableEntries.js';\nimport { ChatAgentLocation, ChatModeKind } from './constants.js';\nimport { ILanguageModelChatMetadata, ILanguageModelChatMetadataAndIdentifier } from './languageModels.js';\n\n\nexport const CHAT_ATTACHABLE_IMAGE_MIME_TYPES: Record<string, string> = {\n\tpng: 'image/png',\n\tjpg: 'image/jpeg',\n\tjpeg: 'image/jpeg',\n\tgif: 'image/gif',\n\twebp: 'image/webp',\n};\n\nexport function getAttachableImageExtension(mimeType: string): string | undefined {\n\treturn Object.entries(CHAT_ATTACHABLE_IMAGE_MIME_TYPES).find(([_, value]) => value === mimeType)?.[0];\n}\n\nexport interface IChatRequestVariableData {\n\tvariables: IChatRequestVariableEntry[];\n}\n\nexport interface IChatRequestModel {\n\treadonly id: string;\n\treadonly timestamp: number;\n\treadonly modeInfo?: IChatRequestModeInfo;\n\treadonly session: IChatModel;\n\treadonly message: IParsedChatRequest;\n\treadonly attempt: number;\n\treadonly variableData: IChatRequestVariableData;\n\treadonly confirmation?: string;\n\treadonly locationData?: IChatLocationData;\n\treadonly attachedContext?: IChatRequestVariableEntry[];\n\treadonly isCompleteAddedRequest: boolean;\n\treadonly response?: IChatResponseModel;\n\treadonly editedFileEvents?: IChatAgentEditedFileEvent[];\n\tshouldBeRemovedOnSend: IChatRequestDisablement | undefined;\n\tshouldBeBlocked: boolean;\n\treadonly modelId?: string;\n\treadonly userSelectedTools?: UserSelectedTools;\n}\n\nexport interface ICodeBlockInfo {\n\treadonly suggestionId: EditSuggestionId;\n}\n\nexport interface IChatTextEditGroupState {\n\tsha1: string;\n\tapplied: number;\n}\n\nexport interface IChatTextEditGroup {\n\turi: URI;\n\tedits: TextEdit[][];\n\tstate?: IChatTextEditGroupState;\n\tkind: 'textEditGroup';\n\tdone: boolean | undefined;\n\tisExternalEdit?: boolean;\n}\n\nexport function isCellTextEditOperation(value: unknown): value is ICellTextEditOperation {\n\tconst candidate = value as ICellTextEditOperation;\n\treturn !!candidate && !!candidate.edit && !!candidate.uri && URI.isUri(candidate.uri);\n}\n\nexport function isCellTextEditOperationArray(value: ICellTextEditOperation[] | ICellEditOperation[]): value is ICellTextEditOperation[] {\n\treturn value.some(isCellTextEditOperation);\n}\n\nexport interface ICellTextEditOperation {\n\tedit: TextEdit;\n\turi: URI;\n}\n\nexport interface IChatNotebookEditGroup {\n\turi: URI;\n\tedits: (ICellTextEditOperation[] | ICellEditOperation[])[];\n\tstate?: IChatTextEditGroupState;\n\tkind: 'notebookEditGroup';\n\tdone: boolean | undefined;\n\tisExternalEdit?: boolean;\n}\n\n/**\n * Progress kinds that are included in the history of a response.\n * Excludes \"internal\" types that are included in history.\n */\nexport type IChatProgressHistoryResponseContent =\n\t| IChatMarkdownContent\n\t| IChatAgentMarkdownContentWithVulnerability\n\t| IChatResponseCodeblockUriPart\n\t| IChatTreeData\n\t| IChatMultiDiffData\n\t| IChatContentInlineReference\n\t| IChatProgressMessage\n\t| IChatCommandButton\n\t| IChatWarningMessage\n\t| IChatTask\n\t| IChatTaskSerialized\n\t| IChatTextEditGroup\n\t| IChatNotebookEditGroup\n\t| IChatConfirmation\n\t| IChatExtensionsContent\n\t| IChatThinkingPart\n\t| IChatPullRequestContent;\n\n/**\n * \"Normal\" progress kinds that are rendered as parts of the stream of content.\n */\nexport type IChatProgressResponseContent =\n\t| IChatProgressHistoryResponseContent\n\t| IChatToolInvocation\n\t| IChatToolInvocationSerialized\n\t| IChatUndoStop\n\t| IChatPrepareToolInvocationPart\n\t| IChatElicitationRequest\n\t| IChatElicitationRequestSerialized\n\t| IChatClearToPreviousToolInvocation\n\t| IChatMcpServersStarting;\n\nconst nonHistoryKinds = new Set(['toolInvocation', 'toolInvocationSerialized', 'undoStop', 'prepareToolInvocation']);\nfunction isChatProgressHistoryResponseContent(content: IChatProgressResponseContent): content is IChatProgressHistoryResponseContent {\n\treturn !nonHistoryKinds.has(content.kind);\n}\n\nexport function toChatHistoryContent(content: ReadonlyArray<IChatProgressResponseContent>): IChatProgressHistoryResponseContent[] {\n\treturn content.filter(isChatProgressHistoryResponseContent);\n}\n\nexport type IChatProgressRenderableResponseContent = Exclude<IChatProgressResponseContent, IChatContentInlineReference | IChatAgentMarkdownContentWithVulnerability | IChatResponseCodeblockUriPart>;\n\nexport interface IResponse {\n\treadonly value: ReadonlyArray<IChatProgressResponseContent>;\n\tgetMarkdown(): string;\n\ttoString(): string;\n}\n\nexport interface IChatResponseModel {\n\treadonly onDidChange: Event<ChatResponseModelChangeReason>;\n\treadonly id: string;\n\treadonly requestId: string;\n\treadonly request: IChatRequestModel | undefined;\n\treadonly username: string;\n\treadonly avatarIcon?: ThemeIcon | URI;\n\treadonly session: IChatModel;\n\treadonly agent?: IChatAgentData;\n\treadonly usedContext: IChatUsedContext | undefined;\n\treadonly contentReferences: ReadonlyArray<IChatContentReference>;\n\treadonly codeCitations: ReadonlyArray<IChatCodeCitation>;\n\treadonly progressMessages: ReadonlyArray<IChatProgressMessage>;\n\treadonly slashCommand?: IChatAgentCommand;\n\treadonly agentOrSlashCommandDetected: boolean;\n\t/** View of the response shown to the user, may have parts omitted from undo stops. */\n\treadonly response: IResponse;\n\t/** Entire response from the model. */\n\treadonly entireResponse: IResponse;\n\t/** Milliseconds timestamp when this chat response was created. */\n\treadonly timestamp: number;\n\t/** Milliseconds timestamp when this chat response was completed or cancelled. */\n\treadonly completedAt?: number;\n\t/**\n\t * Adjusted millisecond timestamp that excludes the duration during which\n\t * the model was pending user confirmation. `Date.now() - confirmationAdjustedTimestamp`\n\t * will return the amount of time the response was busy generating content.\n\t * This is updated only when `isPendingConfirmation` changes state.\n\t */\n\treadonly confirmationAdjustedTimestamp: IObservable<number>;\n\treadonly isComplete: boolean;\n\treadonly isCanceled: boolean;\n\treadonly isPendingConfirmation: IObservable<{ startedWaitingAt: number } | undefined>;\n\treadonly isInProgress: IObservable<boolean>;\n\treadonly shouldBeRemovedOnSend: IChatRequestDisablement | undefined;\n\tshouldBeBlocked: boolean;\n\treadonly isCompleteAddedRequest: boolean;\n\t/** A stale response is one that has been persisted and rehydrated, so e.g. Commands that have their arguments stored in the EH are gone. */\n\treadonly isStale: boolean;\n\treadonly vote: ChatAgentVoteDirection | undefined;\n\treadonly voteDownReason: ChatAgentVoteDownReason | undefined;\n\treadonly followups?: IChatFollowup[] | undefined;\n\treadonly result?: IChatAgentResult;\n\treadonly codeBlockInfos: ICodeBlockInfo[] | undefined;\n\n\tinitializeCodeBlockInfos(codeBlockInfo: ICodeBlockInfo[]): void;\n\taddUndoStop(undoStop: IChatUndoStop): void;\n\tsetVote(vote: ChatAgentVoteDirection): void;\n\tsetVoteDownReason(reason: ChatAgentVoteDownReason | undefined): void;\n\tsetEditApplied(edit: IChatTextEditGroup, editCount: number): boolean;\n\t/**\n\t * Adopts any partially-undo {@link response} as the {@link entireResponse}.\n\t * Only valid when {@link isComplete}. This is needed because otherwise an\n\t * undone and then diverged state would start showing old data because the\n\t * undo stops would no longer exist in the model.\n\t */\n\tfinalizeUndoState(): void;\n}\n\nexport type ChatResponseModelChangeReason =\n\t| { reason: 'other' }\n\t| { reason: 'completedRequest' }\n\t| { reason: 'undoStop'; id: string };\n\nexport const defaultChatResponseModelChangeReason: ChatResponseModelChangeReason = { reason: 'other' };\n\nexport interface IChatRequestModeInfo {\n\tkind: ChatModeKind | undefined; // is undefined in case of modeId == 'apply'\n\tisBuiltin: boolean;\n\tmodeInstructions: IChatRequestModeInstructions | undefined;\n\tmodeId: 'ask' | 'agent' | 'edit' | 'custom' | 'applyCodeBlock' | undefined;\n\tapplyCodeBlockSuggestionId: EditSuggestionId | undefined;\n}\n\nexport interface IChatRequestModeInstructions {\n\treadonly name: string;\n\treadonly content: string;\n\treadonly toolReferences: readonly ChatRequestToolReferenceEntry[];\n\treadonly metadata?: Record<string, boolean | string | number>;\n}\n\nexport interface IChatRequestModelParameters {\n\tsession: ChatModel;\n\tmessage: IParsedChatRequest;\n\tvariableData: IChatRequestVariableData;\n\ttimestamp: number;\n\tattempt?: number;\n\tmodeInfo?: IChatRequestModeInfo;\n\tconfirmation?: string;\n\tlocationData?: IChatLocationData;\n\tattachedContext?: IChatRequestVariableEntry[];\n\tisCompleteAddedRequest?: boolean;\n\tmodelId?: string;\n\trestoredId?: string;\n\teditedFileEvents?: IChatAgentEditedFileEvent[];\n\tuserSelectedTools?: UserSelectedTools;\n}\n\nexport class ChatRequestModel implements IChatRequestModel {\n\tpublic readonly id: string;\n\tpublic response: ChatResponseModel | undefined;\n\tpublic shouldBeRemovedOnSend: IChatRequestDisablement | undefined;\n\tpublic readonly timestamp: number;\n\tpublic readonly message: IParsedChatRequest;\n\tpublic readonly isCompleteAddedRequest: boolean;\n\tpublic readonly modelId?: string;\n\tpublic readonly modeInfo?: IChatRequestModeInfo;\n\tpublic readonly userSelectedTools?: UserSelectedTools;\n\n\tpublic shouldBeBlocked: boolean = false;\n\n\tprivate _session: ChatModel;\n\tprivate readonly _attempt: number;\n\tprivate _variableData: IChatRequestVariableData;\n\tprivate readonly _confirmation?: string;\n\tprivate readonly _locationData?: IChatLocationData;\n\tprivate readonly _attachedContext?: IChatRequestVariableEntry[];\n\tprivate readonly _editedFileEvents?: IChatAgentEditedFileEvent[];\n\n\tpublic get session(): ChatModel {\n\t\treturn this._session;\n\t}\n\n\tpublic get attempt(): number {\n\t\treturn this._attempt;\n\t}\n\n\tpublic get variableData(): IChatRequestVariableData {\n\t\treturn this._variableData;\n\t}\n\n\tpublic set variableData(v: IChatRequestVariableData) {\n\t\tthis._variableData = v;\n\t}\n\n\tpublic get confirmation(): string | undefined {\n\t\treturn this._confirmation;\n\t}\n\n\tpublic get locationData(): IChatLocationData | undefined {\n\t\treturn this._locationData;\n\t}\n\n\tpublic get attachedContext(): IChatRequestVariableEntry[] | undefined {\n\t\treturn this._attachedContext;\n\t}\n\n\tpublic get editedFileEvents(): IChatAgentEditedFileEvent[] | undefined {\n\t\treturn this._editedFileEvents;\n\t}\n\n\tconstructor(params: IChatRequestModelParameters) {\n\t\tthis._session = params.session;\n\t\tthis.message = params.message;\n\t\tthis._variableData = params.variableData;\n\t\tthis.timestamp = params.timestamp;\n\t\tthis._attempt = params.attempt ?? 0;\n\t\tthis.modeInfo = params.modeInfo;\n\t\tthis._confirmation = params.confirmation;\n\t\tthis._locationData = params.locationData;\n\t\tthis._attachedContext = params.attachedContext;\n\t\tthis.isCompleteAddedRequest = params.isCompleteAddedRequest ?? false;\n\t\tthis.modelId = params.modelId;\n\t\tthis.id = params.restoredId ?? 'request_' + generateUuid();\n\t\tthis._editedFileEvents = params.editedFileEvents;\n\t\tthis.userSelectedTools = params.userSelectedTools;\n\t}\n\n\tadoptTo(session: ChatModel) {\n\t\tthis._session = session;\n\t}\n}\n\nclass AbstractResponse implements IResponse {\n\tprotected _responseParts: IChatProgressResponseContent[];\n\n\t/**\n\t * A stringified representation of response data which might be presented to a screenreader or used when copying a response.\n\t */\n\tprotected _responseRepr = '';\n\n\t/**\n\t * Just the markdown content of the response, used for determining the rendering rate of markdown\n\t */\n\tprotected _markdownContent = '';\n\n\tget value(): IChatProgressResponseContent[] {\n\t\treturn this._responseParts;\n\t}\n\n\tconstructor(value: IChatProgressResponseContent[]) {\n\t\tthis._responseParts = value;\n\t\tthis._updateRepr();\n\t}\n\n\ttoString(): string {\n\t\treturn this._responseRepr;\n\t}\n\n\t/**\n\t * _Just_ the content of markdown parts in the response\n\t */\n\tgetMarkdown(): string {\n\t\treturn this._markdownContent;\n\t}\n\n\tprotected _updateRepr() {\n\t\tthis._responseRepr = this.partsToRepr(this._responseParts);\n\n\t\tthis._markdownContent = this._responseParts.map(part => {\n\t\t\tif (part.kind === 'inlineReference') {\n\t\t\t\treturn this.inlineRefToRepr(part);\n\t\t\t} else if (part.kind === 'markdownContent' || part.kind === 'markdownVuln') {\n\t\t\t\treturn part.content.value;\n\t\t\t} else {\n\t\t\t\treturn '';\n\t\t\t}\n\t\t})\n\t\t\t.filter(s => s.length > 0)\n\t\t\t.join('');\n\t}\n\n\tprivate partsToRepr(parts: readonly IChatProgressResponseContent[]): string {\n\t\tconst blocks: string[] = [];\n\t\tlet currentBlockSegments: string[] = [];\n\t\tlet hasEditGroupsAfterLastClear = false;\n\n\t\tfor (const part of parts) {\n\t\t\tlet segment: { text: string; isBlock?: boolean } | undefined;\n\t\t\tswitch (part.kind) {\n\t\t\t\tcase 'clearToPreviousToolInvocation':\n\t\t\t\t\tcurrentBlockSegments = [];\n\t\t\t\t\tblocks.length = 0;\n\t\t\t\t\thasEditGroupsAfterLastClear = false; // Reset edit groups flag when clearing\n\t\t\t\t\tcontinue;\n\t\t\t\tcase 'treeData':\n\t\t\t\tcase 'progressMessage':\n\t\t\t\tcase 'codeblockUri':\n\t\t\t\tcase 'extensions':\n\t\t\t\tcase 'pullRequest':\n\t\t\t\tcase 'undoStop':\n\t\t\t\tcase 'prepareToolInvocation':\n\t\t\t\tcase 'elicitation2':\n\t\t\t\tcase 'elicitationSerialized':\n\t\t\t\tcase 'thinking':\n\t\t\t\tcase 'multiDiffData':\n\t\t\t\tcase 'mcpServersStarting':\n\t\t\t\t\t// Ignore\n\t\t\t\t\tcontinue;\n\t\t\t\tcase 'toolInvocation':\n\t\t\t\tcase 'toolInvocationSerialized':\n\t\t\t\t\t// Include tool invocations in the copy text\n\t\t\t\t\tsegment = this.getToolInvocationText(part);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'inlineReference':\n\t\t\t\t\tsegment = { text: this.inlineRefToRepr(part) };\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'command':\n\t\t\t\t\tsegment = { text: part.command.title, isBlock: true };\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'textEditGroup':\n\t\t\t\tcase 'notebookEditGroup':\n\t\t\t\t\t// Mark that we have edit groups after the last clear\n\t\t\t\t\thasEditGroupsAfterLastClear = true;\n\t\t\t\t\t// Skip individual edit groups to avoid duplication\n\t\t\t\t\tcontinue;\n\t\t\t\tcase 'confirmation':\n\t\t\t\t\tif (part.message instanceof MarkdownString) {\n\t\t\t\t\t\tsegment = { text: `${part.title}\\n${part.message.value}`, isBlock: true };\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tsegment = { text: `${part.title}\\n${part.message}`, isBlock: true };\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'markdownContent':\n\t\t\t\tcase 'markdownVuln':\n\t\t\t\tcase 'progressTask':\n\t\t\t\tcase 'progressTaskSerialized':\n\t\t\t\tcase 'warning':\n\t\t\t\t\tsegment = { text: part.content.value };\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\t// Ignore any unknown/obsolete parts, but assert that all are handled:\n\t\t\t\t\tsoftAssertNever(part);\n\t\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (segment.isBlock) {\n\t\t\t\tif (currentBlockSegments.length) {\n\t\t\t\t\tblocks.push(currentBlockSegments.join(''));\n\t\t\t\t\tcurrentBlockSegments = [];\n\t\t\t\t}\n\t\t\t\tblocks.push(segment.text);\n\t\t\t} else {\n\t\t\t\tcurrentBlockSegments.push(segment.text);\n\t\t\t}\n\t\t}\n\n\t\tif (currentBlockSegments.length) {\n\t\t\tblocks.push(currentBlockSegments.join(''));\n\t\t}\n\n\t\t// Add consolidated edit summary at the end if there were any edit groups after the last clear\n\t\tif (hasEditGroupsAfterLastClear) {\n\t\t\tblocks.push(localize('editsSummary', \"Made changes.\"));\n\t\t}\n\n\t\treturn blocks.join('\\n\\n');\n\t}\n\n\tprivate inlineRefToRepr(part: IChatContentInlineReference) {\n\t\tif ('uri' in part.inlineReference) {\n\t\t\treturn this.uriToRepr(part.inlineReference.uri);\n\t\t}\n\n\t\treturn 'name' in part.inlineReference\n\t\t\t? '`' + part.inlineReference.name + '`'\n\t\t\t: this.uriToRepr(part.inlineReference);\n\t}\n\n\tprivate getToolInvocationText(toolInvocation: IChatToolInvocation | IChatToolInvocationSerialized): { text: string; isBlock?: boolean } {\n\t\t// Extract the message and input details\n\t\tlet message = '';\n\t\tlet input = '';\n\n\t\tif (toolInvocation.pastTenseMessage) {\n\t\t\tmessage = typeof toolInvocation.pastTenseMessage === 'string'\n\t\t\t\t? toolInvocation.pastTenseMessage\n\t\t\t\t: toolInvocation.pastTenseMessage.value;\n\t\t} else {\n\t\t\tmessage = typeof toolInvocation.invocationMessage === 'string'\n\t\t\t\t? toolInvocation.invocationMessage\n\t\t\t\t: toolInvocation.invocationMessage.value;\n\t\t}\n\n\t\t// Handle different types of tool invocations\n\t\tif (toolInvocation.toolSpecificData) {\n\t\t\tif (toolInvocation.toolSpecificData.kind === 'terminal') {\n\t\t\t\tmessage = 'Ran terminal command';\n\t\t\t\tconst terminalData = migrateLegacyTerminalToolSpecificData(toolInvocation.toolSpecificData);\n\t\t\t\tinput = terminalData.commandLine.userEdited ?? terminalData.commandLine.toolEdited ?? terminalData.commandLine.original;\n\t\t\t}\n\t\t}\n\n\t\t// Format the tool invocation text\n\t\tlet text = message;\n\t\tif (input) {\n\t\t\ttext += `: ${input}`;\n\t\t}\n\n\t\t// For completed tool invocations, also include the result details if available\n\t\tif (toolInvocation.kind === 'toolInvocationSerialized' || (toolInvocation.kind === 'toolInvocation' && IChatToolInvocation.isComplete(toolInvocation))) {\n\t\t\tconst resultDetails = IChatToolInvocation.resultDetails(toolInvocation);\n\t\t\tif (resultDetails && 'input' in resultDetails) {\n\t\t\t\tconst resultPrefix = toolInvocation.kind === 'toolInvocationSerialized' || IChatToolInvocation.isComplete(toolInvocation) ? 'Completed' : 'Errored';\n\t\t\t\ttext += `\\n${resultPrefix} with input: ${resultDetails.input}`;\n\t\t\t}\n\t\t}\n\n\t\treturn { text, isBlock: true };\n\t}\n\n\tprivate uriToRepr(uri: URI): string {\n\t\tif (uri.scheme === Schemas.http || uri.scheme === Schemas.https) {\n\t\t\treturn uri.toString(false);\n\t\t}\n\n\t\treturn basename(uri);\n\t}\n}\n\n/** A view of a subset of a response */\nclass ResponseView extends AbstractResponse {\n\tconstructor(\n\t\t_response: IResponse,\n\t\tpublic readonly undoStop: string,\n\t) {\n\t\tlet idx = _response.value.findIndex(v => v.kind === 'undoStop' && v.id === undoStop);\n\t\t// Undo stops are inserted before `codeblockUri`'s, which are preceeded by a\n\t\t// markdownContent containing the opening code fence. Adjust the index\n\t\t// backwards to avoid a buggy response if it looked like this happened.\n\t\tif (_response.value[idx + 1]?.kind === 'codeblockUri' && _response.value[idx - 1]?.kind === 'markdownContent') {\n\t\t\tidx--;\n\t\t}\n\n\t\tsuper(idx === -1 ? _response.value.slice() : _response.value.slice(0, idx));\n\t}\n}\n\nexport class Response extends AbstractResponse implements IDisposable {\n\tprivate _onDidChangeValue = new Emitter<void>();\n\tpublic get onDidChangeValue() {\n\t\treturn this._onDidChangeValue.event;\n\t}\n\n\tprivate _citations: IChatCodeCitation[] = [];\n\n\n\tconstructor(value: IMarkdownString | ReadonlyArray<IMarkdownString | IChatResponseProgressFileTreeData | IChatContentInlineReference | IChatAgentMarkdownContentWithVulnerability | IChatResponseCodeblockUriPart | IChatThinkingPart>) {\n\t\tsuper(asArray(value).map((v) => (\n\t\t\t'kind' in v ? v :\n\t\t\t\tisMarkdownString(v) ? { content: v, kind: 'markdownContent' } satisfies IChatMarkdownContent :\n\t\t\t\t\t{ kind: 'treeData', treeData: v }\n\t\t)));\n\t}\n\n\tdispose(): void {\n\t\tthis._onDidChangeValue.dispose();\n\t}\n\n\n\tclear(): void {\n\t\tthis._responseParts = [];\n\t\tthis._updateRepr(true);\n\t}\n\n\tclearToPreviousToolInvocation(message?: string): void {\n\t\t// look through the response parts and find the last tool invocation, then slice the response parts to that point\n\t\tlet lastToolInvocationIndex = -1;\n\t\tfor (let i = this._responseParts.length - 1; i >= 0; i--) {\n\t\t\tconst part = this._responseParts[i];\n\t\t\tif (part.kind === 'toolInvocation' || part.kind === 'toolInvocationSerialized') {\n\t\t\t\tlastToolInvocationIndex = i;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (lastToolInvocationIndex !== -1) {\n\t\t\tthis._responseParts = this._responseParts.slice(0, lastToolInvocationIndex + 1);\n\t\t} else {\n\t\t\tthis._responseParts = [];\n\t\t}\n\t\tif (message) {\n\t\t\tthis._responseParts.push({ kind: 'warning', content: new MarkdownString(message) });\n\t\t}\n\t\tthis._updateRepr(true);\n\t}\n\n\tupdateContent(progress: IChatProgressResponseContent | IChatTextEdit | IChatNotebookEdit | IChatTask, quiet?: boolean): void {\n\t\tif (progress.kind === 'clearToPreviousToolInvocation') {\n\t\t\tif (progress.reason === ChatResponseClearToPreviousToolInvocationReason.CopyrightContentRetry) {\n\t\t\t\tthis.clearToPreviousToolInvocation(localize('copyrightContentRetry', \"Response cleared due to possible match to public code, retrying with modified prompt.\"));\n\t\t\t} else if (progress.reason === ChatResponseClearToPreviousToolInvocationReason.FilteredContentRetry) {\n\t\t\t\tthis.clearToPreviousToolInvocation(localize('filteredContentRetry', \"Response cleared due to content safety filters, retrying with modified prompt.\"));\n\t\t\t} else {\n\t\t\t\tthis.clearToPreviousToolInvocation();\n\t\t\t}\n\t\t\treturn;\n\t\t} else if (progress.kind === 'markdownContent') {\n\n\t\t\t// last response which is NOT a text edit group because we do want to support heterogenous streaming but not have\n\t\t\t// the MD be chopped up by text edit groups (and likely other non-renderable parts)\n\t\t\tconst lastResponsePart = this._responseParts\n\t\t\t\t.filter(p => p.kind !== 'textEditGroup')\n\t\t\t\t.at(-1);\n\n\t\t\tif (!lastResponsePart || lastResponsePart.kind !== 'markdownContent' || !canMergeMarkdownStrings(lastResponsePart.content, progress.content)) {\n\t\t\t\t// The last part can't be merged with- not markdown, or markdown with different permissions\n\t\t\t\tthis._responseParts.push(progress);\n\t\t\t} else {\n\t\t\t\t// Don't modify the current object, since it's being diffed by the renderer\n\t\t\t\tconst idx = this._responseParts.indexOf(lastResponsePart);\n\t\t\t\tthis._responseParts[idx] = { ...lastResponsePart, content: appendMarkdownString(lastResponsePart.content, progress.content) };\n\t\t\t}\n\t\t\tthis._updateRepr(quiet);\n\t\t} else if (progress.kind === 'thinking') {\n\n\t\t\t// tries to split thinking chunks if it is an array. only while certain models give us array chunks.\n\t\t\tconst lastResponsePart = this._responseParts\n\t\t\t\t.filter(p => p.kind !== 'textEditGroup')\n\t\t\t\t.at(-1);\n\n\t\t\tconst lastText = lastResponsePart && lastResponsePart.kind === 'thinking'\n\t\t\t\t? (Array.isArray(lastResponsePart.value) ? lastResponsePart.value.join('') : (lastResponsePart.value || ''))\n\t\t\t\t: '';\n\t\t\tconst currText = Array.isArray(progress.value) ? progress.value.join('') : (progress.value || '');\n\t\t\tconst isEmpty = (s: string) => s.trim().length === 0;\n\n\t\t\t// Do not merge if either the current or last thinking chunk is empty; empty chunks separate thinking\n\t\t\tif (!lastResponsePart\n\t\t\t\t|| lastResponsePart.kind !== 'thinking'\n\t\t\t\t|| isEmpty(currText)\n\t\t\t\t|| isEmpty(lastText)\n\t\t\t\t|| !canMergeMarkdownStrings(new MarkdownString(lastText), new MarkdownString(currText))) {\n\t\t\t\tthis._responseParts.push(progress);\n\t\t\t} else {\n\t\t\t\tconst idx = this._responseParts.indexOf(lastResponsePart);\n\t\t\t\tthis._responseParts[idx] = {\n\t\t\t\t\t...lastResponsePart,\n\t\t\t\t\tvalue: appendMarkdownString(new MarkdownString(lastText), new MarkdownString(currText)).value\n\t\t\t\t};\n\t\t\t}\n\t\t\tthis._updateRepr(quiet);\n\t\t} else if (progress.kind === 'textEdit' || progress.kind === 'notebookEdit') {\n\t\t\t// If the progress.uri is a cell Uri, its possible its part of the inline chat.\n\t\t\t// Old approach of notebook inline chat would not start and end with notebook Uri, so we need to check for old approach.\n\t\t\tconst useOldApproachForInlineNotebook = progress.uri.scheme === Schemas.vscodeNotebookCell && !this._responseParts.find(part => part.kind === 'notebookEditGroup');\n\t\t\t// merge edits for the same file no matter when they come in\n\t\t\tconst notebookUri = useOldApproachForInlineNotebook ? undefined : CellUri.parse(progress.uri)?.notebook;\n\t\t\tconst uri = notebookUri ?? progress.uri;\n\t\t\tlet found = false;\n\t\t\tconst groupKind = progress.kind === 'textEdit' && !notebookUri ? 'textEditGroup' : 'notebookEditGroup';\n\t\t\tconst edits: any = groupKind === 'textEditGroup' ? progress.edits : progress.edits.map(edit => TextEdit.isTextEdit(edit) ? { uri: progress.uri, edit } : edit);\n\t\t\tconst isExternalEdit = progress.isExternalEdit;\n\t\t\tfor (let i = 0; !found && i < this._responseParts.length; i++) {\n\t\t\t\tconst candidate = this._responseParts[i];\n\t\t\t\tif (candidate.kind === groupKind && !candidate.done && isEqual(candidate.uri, uri)) {\n\t\t\t\t\tcandidate.edits.push(edits);\n\t\t\t\t\tcandidate.done = progress.done;\n\t\t\t\t\tfound = true;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!found) {\n\t\t\t\tthis._responseParts.push({\n\t\t\t\t\tkind: groupKind,\n\t\t\t\t\turi,\n\t\t\t\t\tedits: groupKind === 'textEditGroup' ? [edits] : edits,\n\t\t\t\t\tdone: progress.done,\n\t\t\t\t\tisExternalEdit,\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis._updateRepr(quiet);\n\t\t} else if (progress.kind === 'progressTask') {\n\t\t\t// Add a new resolving part\n\t\t\tconst responsePosition = this._responseParts.push(progress) - 1;\n\t\t\tthis._updateRepr(quiet);\n\n\t\t\tconst disp = progress.onDidAddProgress(() => {\n\t\t\t\tthis._updateRepr(false);\n\t\t\t});\n\n\t\t\tprogress.task?.().then((content) => {\n\t\t\t\t// Stop listening for progress updates once the task settles\n\t\t\t\tdisp.dispose();\n\n\t\t\t\t// Replace the resolving part's content with the resolved response\n\t\t\t\tif (typeof content === 'string') {\n\t\t\t\t\t(this._responseParts[responsePosition] as IChatTask).content = new MarkdownString(content);\n\t\t\t\t}\n\t\t\t\tthis._updateRepr(false);\n\t\t\t});\n\n\t\t} else if (progress.kind === 'toolInvocation') {\n\t\t\tautorunSelfDisposable(reader => {\n\t\t\t\tprogress.state.read(reader); // update repr when state changes\n\t\t\t\tthis._updateRepr(false);\n\n\t\t\t\tif (IChatToolInvocation.isComplete(progress, reader)) {\n\t\t\t\t\treader.dispose();\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis._responseParts.push(progress);\n\t\t\tthis._updateRepr(quiet);\n\t\t} else {\n\t\t\tthis._responseParts.push(progress);\n\t\t\tthis._updateRepr(quiet);\n\t\t}\n\t}\n\n\tpublic addCitation(citation: IChatCodeCitation) {\n\t\tthis._citations.push(citation);\n\t\tthis._updateRepr();\n\t}\n\n\tprotected override _updateRepr(quiet?: boolean) {\n\t\tsuper._updateRepr();\n\t\tif (!this._onDidChangeValue) {\n\t\t\treturn; // called from parent constructor\n\t\t}\n\n\t\tthis._responseRepr += this._citations.length ? '\\n\\n' + getCodeCitationsMessage(this._citations) : '';\n\n\t\tif (!quiet) {\n\t\t\tthis._onDidChangeValue.fire();\n\t\t}\n\t}\n}\n\nexport interface IChatResponseModelParameters {\n\tresponseContent: IMarkdownString | ReadonlyArray<IMarkdownString | IChatResponseProgressFileTreeData | IChatContentInlineReference | IChatAgentMarkdownContentWithVulnerability | IChatResponseCodeblockUriPart | IChatThinkingPart>;\n\tsession: ChatModel;\n\tagent?: IChatAgentData;\n\tslashCommand?: IChatAgentCommand;\n\trequestId: string;\n\ttimestamp?: number;\n\tvote?: ChatAgentVoteDirection;\n\tvoteDownReason?: ChatAgentVoteDownReason;\n\tresult?: IChatAgentResult;\n\tfollowups?: ReadonlyArray<IChatFollowup>;\n\tisCompleteAddedRequest?: boolean;\n\tshouldBeRemovedOnSend?: IChatRequestDisablement;\n\tshouldBeBlocked?: boolean;\n\trestoredId?: string;\n\tmodelState?: ResponseModelStateT;\n\ttimeSpentWaiting?: number;\n\t/**\n\t * undefined means it will be set later.\n\t*/\n\tcodeBlockInfos: ICodeBlockInfo[] | undefined;\n}\n\nconst enum ResponseModelState {\n\tPending,\n\tComplete,\n\tCancelled,\n}\n\ntype ResponseModelStateT =\n\t| { value: ResponseModelState.Pending }\n\t| { value: ResponseModelState.Complete | ResponseModelState.Cancelled; completedAt: number };\n\nexport class ChatResponseModel extends Disposable implements IChatResponseModel {\n\tprivate readonly _onDidChange = this._register(new Emitter<ChatResponseModelChangeReason>());\n\treadonly onDidChange = this._onDidChange.event;\n\n\tpublic readonly id: string;\n\tpublic readonly requestId: string;\n\tprivate _session: ChatModel;\n\tprivate _agent: IChatAgentData | undefined;\n\tprivate _slashCommand: IChatAgentCommand | undefined;\n\tprivate _modelState = observableValue<ResponseModelStateT>(this, { value: ResponseModelState.Pending });\n\tprivate _vote?: ChatAgentVoteDirection;\n\tprivate _voteDownReason?: ChatAgentVoteDownReason;\n\tprivate _result?: IChatAgentResult;\n\tprivate _shouldBeRemovedOnSend: IChatRequestDisablement | undefined;\n\tpublic readonly isCompleteAddedRequest: boolean;\n\tprivate _shouldBeBlocked: boolean = false;\n\tprivate readonly _timestamp: number;\n\tprivate _timeSpentWaitingAccumulator: number;\n\n\tpublic confirmationAdjustedTimestamp: IObservable<number>;\n\n\tpublic get shouldBeBlocked() {\n\t\treturn this._shouldBeBlocked;\n\t}\n\n\tpublic get request(): IChatRequestModel | undefined {\n\t\treturn this.session.getRequests().find(r => r.id === this.requestId);\n\t}\n\n\tpublic get session() {\n\t\treturn this._session;\n\t}\n\n\tpublic get shouldBeRemovedOnSend() {\n\t\treturn this._shouldBeRemovedOnSend;\n\t}\n\n\tpublic get isComplete(): boolean {\n\t\treturn this._modelState.get().value !== ResponseModelState.Pending;\n\t}\n\n\tpublic get timestamp(): number {\n\t\treturn this._timestamp;\n\t}\n\n\tpublic set shouldBeRemovedOnSend(disablement: IChatRequestDisablement | undefined) {\n\t\tthis._shouldBeRemovedOnSend = disablement;\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t}\n\n\tpublic get isCanceled(): boolean {\n\t\treturn this._modelState.get().value === ResponseModelState.Cancelled;\n\t}\n\n\tpublic get completedAt(): number | undefined {\n\t\tconst state = this._modelState.get();\n\t\tif (state.value === ResponseModelState.Complete || state.value === ResponseModelState.Cancelled) {\n\t\t\treturn state.completedAt;\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tpublic get vote(): ChatAgentVoteDirection | undefined {\n\t\treturn this._vote;\n\t}\n\n\tpublic get voteDownReason(): ChatAgentVoteDownReason | undefined {\n\t\treturn this._voteDownReason;\n\t}\n\n\tpublic get followups(): IChatFollowup[] | undefined {\n\t\treturn this._followups;\n\t}\n\n\tprivate _response: Response;\n\tprivate _finalizedResponse?: IResponse;\n\tpublic get entireResponse(): IResponse {\n\t\treturn this._finalizedResponse || this._response;\n\t}\n\n\tpublic get result(): IChatAgentResult | undefined {\n\t\treturn this._result;\n\t}\n\n\tpublic get username(): string {\n\t\treturn this.session.responderUsername;\n\t}\n\n\tpublic get avatarIcon(): ThemeIcon | URI | undefined {\n\t\treturn this.session.responderAvatarIcon;\n\t}\n\n\tprivate _followups?: IChatFollowup[];\n\n\tpublic get agent(): IChatAgentData | undefined {\n\t\treturn this._agent;\n\t}\n\n\tpublic get slashCommand(): IChatAgentCommand | undefined {\n\t\treturn this._slashCommand;\n\t}\n\n\tprivate _agentOrSlashCommandDetected: boolean | undefined;\n\tpublic get agentOrSlashCommandDetected(): boolean {\n\t\treturn this._agentOrSlashCommandDetected ?? false;\n\t}\n\n\tprivate _usedContext: IChatUsedContext | undefined;\n\tpublic get usedContext(): IChatUsedContext | undefined {\n\t\treturn this._usedContext;\n\t}\n\n\tprivate readonly _contentReferences: IChatContentReference[] = [];\n\tpublic get contentReferences(): ReadonlyArray<IChatContentReference> {\n\t\treturn Array.from(this._contentReferences);\n\t}\n\n\tprivate readonly _codeCitations: IChatCodeCitation[] = [];\n\tpublic get codeCitations(): ReadonlyArray<IChatCodeCitation> {\n\t\treturn this._codeCitations;\n\t}\n\n\tprivate readonly _progressMessages: IChatProgressMessage[] = [];\n\tpublic get progressMessages(): ReadonlyArray<IChatProgressMessage> {\n\t\treturn this._progressMessages;\n\t}\n\n\tprivate _isStale: boolean = false;\n\tpublic get isStale(): boolean {\n\t\treturn this._isStale;\n\t}\n\n\n\treadonly isPendingConfirmation: IObservable<{ startedWaitingAt: number } | undefined>;\n\n\treadonly isInProgress: IObservable<boolean>;\n\n\tprivate _responseView?: ResponseView;\n\tpublic get response(): IResponse {\n\t\tconst undoStop = this._shouldBeRemovedOnSend?.afterUndoStop;\n\t\tif (!undoStop) {\n\t\t\treturn this._finalizedResponse || this._response;\n\t\t}\n\n\t\tif (this._responseView?.undoStop !== undoStop) {\n\t\t\tthis._responseView = new ResponseView(this._response, undoStop);\n\t\t}\n\n\t\treturn this._responseView;\n\t}\n\n\tprivate _codeBlockInfos: ICodeBlockInfo[] | undefined;\n\tpublic get codeBlockInfos(): ICodeBlockInfo[] | undefined {\n\t\treturn this._codeBlockInfos;\n\t}\n\n\tconstructor(params: IChatResponseModelParameters) {\n\t\tsuper();\n\n\t\tthis._session = params.session;\n\t\tthis._agent = params.agent;\n\t\tthis._slashCommand = params.slashCommand;\n\t\tthis.requestId = params.requestId;\n\t\tthis._timestamp = params.timestamp || Date.now();\n\t\tif (params.modelState) {\n\t\t\tthis._modelState.set(params.modelState, undefined);\n\t\t}\n\t\tthis._timeSpentWaitingAccumulator = params.timeSpentWaiting || 0;\n\t\tthis._vote = params.vote;\n\t\tthis._voteDownReason = params.voteDownReason;\n\t\tthis._result = params.result;\n\t\tthis._followups = params.followups ? [...params.followups] : undefined;\n\t\tthis.isCompleteAddedRequest = params.isCompleteAddedRequest ?? false;\n\t\tthis._shouldBeRemovedOnSend = params.shouldBeRemovedOnSend;\n\t\tthis._shouldBeBlocked = params.shouldBeBlocked ?? false;\n\n\t\t// If we are creating a response with some existing content, consider it stale\n\t\tthis._isStale = Array.isArray(params.responseContent) && (params.responseContent.length !== 0 || isMarkdownString(params.responseContent) && params.responseContent.value.length !== 0);\n\n\t\tthis._response = this._register(new Response(params.responseContent));\n\t\tthis._codeBlockInfos = params.codeBlockInfos ? [...params.codeBlockInfos] : undefined;\n\n\t\tconst signal = observableSignalFromEvent(this, this.onDidChange);\n\n\t\tconst _isPendingBool = signal.map((_value, r) => {\n\n\t\t\tsignal.read(r);\n\n\t\t\treturn this._response.value.some(part =>\n\t\t\t\tpart.kind === 'toolInvocation' && part.state.read(r).type === IChatToolInvocation.StateKind.WaitingForConfirmation\n\t\t\t\t|| part.kind === 'confirmation' && part.isUsed === false\n\t\t\t\t|| part.kind === 'elicitation2' && part.state.read(r) === ElicitationState.Pending\n\t\t\t);\n\t\t});\n\n\t\tthis.isPendingConfirmation = _isPendingBool.map(pending => pending ? { startedWaitingAt: Date.now() } : undefined);\n\n\t\tthis.isInProgress = signal.map((_value, r) => {\n\n\t\t\tsignal.read(r);\n\n\t\t\treturn !_isPendingBool.read(r)\n\t\t\t\t&& !this.shouldBeRemovedOnSend\n\t\t\t\t&& this._modelState.read(r).value === ResponseModelState.Pending;\n\t\t});\n\n\t\tthis._register(this._response.onDidChangeValue(() => this._onDidChange.fire(defaultChatResponseModelChangeReason)));\n\t\tthis.id = params.restoredId ?? 'response_' + generateUuid();\n\n\t\tthis._register(this._session.onDidChange((e) => {\n\t\t\tif (e.kind === 'setCheckpoint') {\n\t\t\t\tconst isDisabled = e.disabledResponseIds.has(this.id);\n\t\t\t\tconst didChange = this._shouldBeBlocked === isDisabled;\n\t\t\t\tthis._shouldBeBlocked = isDisabled;\n\t\t\t\tif (didChange) {\n\t\t\t\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tlet lastStartedWaitingAt: number | undefined = undefined;\n\t\tthis.confirmationAdjustedTimestamp = derived(reader => {\n\t\t\tconst pending = this.isPendingConfirmation.read(reader);\n\t\t\tif (pending && !lastStartedWaitingAt) {\n\t\t\t\tlastStartedWaitingAt = pending.startedWaitingAt;\n\t\t\t} else if (!pending && lastStartedWaitingAt) {\n\t\t\t\tthis._timeSpentWaitingAccumulator += Date.now() - lastStartedWaitingAt;\n\t\t\t\tlastStartedWaitingAt = undefined;\n\t\t\t}\n\n\t\t\treturn this._timestamp + this._timeSpentWaitingAccumulator;\n\t\t}).recomputeInitiallyAndOnChange(this._store);\n\t}\n\n\tinitializeCodeBlockInfos(codeBlockInfo: ICodeBlockInfo[]): void {\n\t\tif (this._codeBlockInfos) {\n\t\t\tthrow new BugIndicatingError('Code block infos have already been initialized');\n\t\t}\n\t\tthis._codeBlockInfos = [...codeBlockInfo];\n\t}\n\n\t/**\n\t * Apply a progress update to the actual response content.\n\t */\n\tupdateContent(responsePart: IChatProgressResponseContent | IChatTextEdit | IChatNotebookEdit, quiet?: boolean) {\n\t\tthis._response.updateContent(responsePart, quiet);\n\t}\n\n\t/**\n\t * Adds an undo stop at the current position in the stream.\n\t */\n\taddUndoStop(undoStop: IChatUndoStop) {\n\t\tthis._onDidChange.fire({ reason: 'undoStop', id: undoStop.id });\n\t\tthis._response.updateContent(undoStop, true);\n\t}\n\n\t/**\n\t * Apply one of the progress updates that are not part of the actual response content.\n\t */\n\tapplyReference(progress: IChatUsedContext | IChatContentReference) {\n\t\tif (progress.kind === 'usedContext') {\n\t\t\tthis._usedContext = progress;\n\t\t} else if (progress.kind === 'reference') {\n\t\t\tthis._contentReferences.push(progress);\n\t\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t\t}\n\t}\n\n\tapplyCodeCitation(progress: IChatCodeCitation) {\n\t\tthis._codeCitations.push(progress);\n\t\tthis._response.addCitation(progress);\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t}\n\n\tsetAgent(agent: IChatAgentData, slashCommand?: IChatAgentCommand) {\n\t\tthis._agent = agent;\n\t\tthis._slashCommand = slashCommand;\n\t\tthis._agentOrSlashCommandDetected = !agent.isDefault || !!slashCommand;\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t}\n\n\tsetResult(result: IChatAgentResult): void {\n\t\tthis._result = result;\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t}\n\n\tcomplete(): void {\n\t\tif (this._result?.errorDetails?.responseIsRedacted) {\n\t\t\tthis._response.clear();\n\t\t}\n\n\t\tthis._modelState.set({ value: ResponseModelState.Complete, completedAt: Date.now() }, undefined);\n\t\tthis._onDidChange.fire({ reason: 'completedRequest' });\n\t}\n\n\tcancel(): void {\n\t\tthis._modelState.set({ value: ResponseModelState.Cancelled, completedAt: Date.now() }, undefined);\n\t\tthis._onDidChange.fire({ reason: 'completedRequest' });\n\t}\n\n\tsetFollowups(followups: IChatFollowup[] | undefined): void {\n\t\tthis._followups = followups;\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason); // Fire so that command followups get rendered on the row\n\t}\n\n\tsetVote(vote: ChatAgentVoteDirection): void {\n\t\tthis._vote = vote;\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t}\n\n\tsetVoteDownReason(reason: ChatAgentVoteDownReason | undefined): void {\n\t\tthis._voteDownReason = reason;\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t}\n\n\tsetEditApplied(edit: IChatTextEditGroup, editCount: number): boolean {\n\t\tif (!this.response.value.includes(edit)) {\n\t\t\treturn false;\n\t\t}\n\t\tif (!edit.state) {\n\t\t\treturn false;\n\t\t}\n\t\tedit.state.applied = editCount; // must not be edit.edits.length\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t\treturn true;\n\t}\n\n\tadoptTo(session: ChatModel) {\n\t\tthis._session = session;\n\t\tthis._onDidChange.fire(defaultChatResponseModelChangeReason);\n\t}\n\n\n\tfinalizeUndoState(): void {\n\t\tthis._finalizedResponse = this.response;\n\t\tthis._responseView = undefined;\n\t\tthis._shouldBeRemovedOnSend = undefined;\n\t}\n\n\ttoJSON(): ISerializableChatResponseData {\n\t\tconst modelState = this._modelState.get();\n\t\tconst pendingConfirmation = this.isPendingConfirmation.get();\n\n\t\treturn {\n\t\t\tresponseId: this.id,\n\t\t\tresult: this.result,\n\t\t\tresponseMarkdownInfo: this.codeBlockInfos?.map<ISerializableMarkdownInfo>(info => ({ suggestionId: info.suggestionId })),\n\t\t\tfollowups: this.followups,\n\t\t\tmodelState: modelState.value === ResponseModelState.Pending ? { value: ResponseModelState.Cancelled, completedAt: Date.now() } : modelState,\n\t\t\tvote: this.vote,\n\t\t\tvoteDownReason: this.voteDownReason,\n\t\t\tslashCommand: this.slashCommand,\n\t\t\tusedContext: this.usedContext,\n\t\t\tcontentReferences: this.contentReferences,\n\t\t\tcodeCitations: this.codeCitations,\n\t\t\ttimestamp: this._timestamp,\n\t\t\ttimeSpentWaiting: (pendingConfirmation ? Date.now() - pendingConfirmation.startedWaitingAt : 0) + this._timeSpentWaitingAccumulator,\n\t\t} satisfies WithDefinedProps<ISerializableChatResponseData>;\n\t}\n}\n\n\nexport interface IChatRequestDisablement {\n\trequestId: string;\n\tafterUndoStop?: string;\n}\n\nexport interface IChatModel extends IDisposable {\n\treadonly onDidDispose: Event<void>;\n\treadonly onDidChange: Event<IChatChangeEvent>;\n\t/** @deprecated Use {@link sessionResource} instead */\n\treadonly sessionId: string;\n\t/** Milliseconds timestamp this chat model was created. */\n\treadonly timestamp: number;\n\treadonly sessionResource: URI;\n\treadonly initialLocation: ChatAgentLocation;\n\treadonly title: string;\n\treadonly hasCustomTitle: boolean;\n\t/** True whenever a request is currently running */\n\treadonly requestInProgress: IObservable<boolean>;\n\t/** True whenever a request needs user interaction to continue */\n\treadonly requestNeedsInput: IObservable<boolean>;\n\treadonly inputPlaceholder?: string;\n\treadonly editingSession?: IChatEditingSession | undefined;\n\treadonly checkpoint: IChatRequestModel | undefined;\n\t/** Input model for managing input state */\n\treadonly inputModel: IInputModel;\n\tgetRequests(): IChatRequestModel[];\n\tsetCheckpoint(requestId: string | undefined): void;\n\n\ttoExport(): IExportableChatData;\n\ttoJSON(): ISerializableChatData;\n\treadonly contributedChatSession: IChatSessionContext | undefined;\n}\n\nexport interface ISerializableChatsData {\n\t[sessionId: string]: ISerializableChatData;\n}\n\nexport type ISerializableChatAgentData = UriDto<IChatAgentData>;\n\ninterface ISerializableChatResponseData {\n\tresponseId?: string;\n\tresult?: IChatAgentResult; // Optional for backcompat\n\tresponseMarkdownInfo?: ISerializableMarkdownInfo[];\n\tfollowups?: ReadonlyArray<IChatFollowup>;\n\tmodelState?: ResponseModelStateT;\n\tvote?: ChatAgentVoteDirection;\n\tvoteDownReason?: ChatAgentVoteDownReason;\n\ttimestamp?: number;\n\tslashCommand?: IChatAgentCommand;\n\t/** For backward compat: should be optional */\n\tusedContext?: IChatUsedContext;\n\tcontentReferences?: ReadonlyArray<IChatContentReference>;\n\tcodeCitations?: ReadonlyArray<IChatCodeCitation>;\n\ttimeSpentWaiting?: number;\n}\n\nexport interface ISerializableChatRequestData extends ISerializableChatResponseData {\n\trequestId: string;\n\tmessage: string | IParsedChatRequest; // string => old format\n\t/** Is really like \"prompt data\". This is the message in the format in which the agent gets it + variable values. */\n\tvariableData: IChatRequestVariableData;\n\tresponse: ReadonlyArray<IMarkdownString | IChatResponseProgressFileTreeData | IChatContentInlineReference | IChatAgentMarkdownContentWithVulnerability | IChatThinkingPart> | undefined;\n\n\t/**Old, persisted name for shouldBeRemovedOnSend */\n\tisHidden?: boolean;\n\tshouldBeRemovedOnSend?: IChatRequestDisablement;\n\tagent?: ISerializableChatAgentData;\n\tworkingSet?: UriComponents[];\n\t// responseErrorDetails: IChatResponseErrorDetails | undefined;\n\t/** @deprecated modelState is used instead now */\n\tisCanceled?: boolean;\n\ttimestamp?: number;\n\tconfirmation?: string;\n\teditedFileEvents?: IChatAgentEditedFileEvent[];\n\tmodelId?: string;\n}\n\nexport interface ISerializableMarkdownInfo {\n\treadonly suggestionId: EditSuggestionId;\n}\n\nexport interface IExportableChatData {\n\tinitialLocation: ChatAgentLocation | undefined;\n\trequests: ISerializableChatRequestData[];\n\tresponderUsername: string;\n\tresponderAvatarIconUri: ThemeIcon | UriComponents | undefined; // Keeping Uri name for backcompat\n}\n\n/*\n\tNOTE: every time the serialized data format is updated, we need to create a new interface, because we may need to handle any old data format when parsing.\n*/\n\nexport interface ISerializableChatData1 extends IExportableChatData {\n\tsessionId: string;\n\tcreationDate: number;\n\tisImported: boolean;\n\n\t/** Indicates that this session was created in this window. Is cleared after the chat has been written to storage once. Needed to sync chat creations/deletions between empty windows. */\n\tisNew?: boolean;\n}\n\nexport interface ISerializableChatData2 extends ISerializableChatData1 {\n\tversion: 2;\n\tlastMessageDate: number;\n\tcomputedTitle: string | undefined;\n}\n\nexport interface ISerializableChatData3 extends Omit<ISerializableChatData2, 'version' | 'computedTitle'> {\n\tversion: 3;\n\tcustomTitle: string | undefined;\n\t/** Current draft input state (added later, fully backwards compatible) */\n\tinputState?: ISerializableChatModelInputState;\n}\n\n/**\n * Input model for managing chat input state independently from the chat model.\n * This keeps display logic separated from the core chat model.\n *\n * The input model:\n * - Manages the current draft state (text, attachments, mode, model selection, cursor/selection)\n * - Provides an observable interface for reactive UI updates\n * - Automatically persists through the chat model's serialization\n * - Enables bidirectional sync between the UI (ChatInputPart) and the model\n * - Uses `undefined` state to indicate no persisted state (new/empty chat)\n *\n * This architecture ensures that:\n * - Input state is preserved when moving chats between editor/sidebar/window\n * - No manual state transfer is needed when switching contexts\n * - The UI stays in sync with the persisted state\n * - New chats use UI defaults (persisted preferences) instead of hardcoded values\n */\nexport interface IInputModel {\n\t/** Observable for current input state (undefined for new/uninitialized chats) */\n\treadonly state: IObservable<IChatModelInputState | undefined>;\n\n\t/** Update the input state (partial update) */\n\tsetState(state: Partial<IChatModelInputState>): void;\n\n\t/** Clear input state (after sending or clearing) */\n\tclearState(): void;\n}\n\n/**\n * Represents the current state of the chat input that hasn't been sent yet.\n * This is the \"draft\" state that should be preserved across sessions.\n */\nexport interface IChatModelInputState {\n\t/** Current attachments in the input */\n\tattachments: readonly IChatRequestVariableEntry[];\n\n\t/** Currently selected chat mode */\n\tmode: {\n\t\t/** Mode ID (e.g., 'ask', 'edit', 'agent', or custom mode ID) */\n\t\tid: string;\n\t\t/** Mode kind for builtin modes */\n\t\tkind: ChatModeKind | undefined;\n\t};\n\n\t/** Currently selected language model, if any */\n\tselectedModel: ILanguageModelChatMetadataAndIdentifier | undefined;\n\n\t/** Current input text */\n\tinputText: string;\n\n\t/** Current selection ranges */\n\tselections: ISelection[];\n\n\t/** Contributed stored state */\n\tcontrib: Record<string, unknown>;\n}\n\n/**\n * Serializable version of IChatModelInputState\n */\nexport interface ISerializableChatModelInputState {\n\tattachments: readonly IChatRequestVariableEntry[];\n\tmode: {\n\t\tid: string;\n\t\tkind: ChatModeKind | undefined;\n\t};\n\tselectedModel: {\n\t\tidentifier: string;\n\t\tmetadata: ILanguageModelChatMetadata;\n\t} | undefined;\n\tinputText: string;\n\tselections: ISelection[];\n\tcontrib: Record<string, unknown>;\n}\n\n/**\n* Chat data that has been parsed and normalized to the current format.\n*/\nexport type ISerializableChatData = ISerializableChatData3;\n\n/**\n * Chat data that has been loaded but not normalized, and could be any format\n */\nexport type ISerializableChatDataIn = ISerializableChatData1 | ISerializableChatData2 | ISerializableChatData3;\n\n/**\n * Normalize chat data from storage to the current format.\n * TODO- ChatModel#_deserialize and reviveSerializedAgent also still do some normalization and maybe that should be done in here too.\n */\nexport function normalizeSerializableChatData(raw: ISerializableChatDataIn): ISerializableChatData {\n\tnormalizeOldFields(raw);\n\n\tif (!('version' in raw)) {\n\t\treturn {\n\t\t\tversion: 3,\n\t\t\t...raw,\n\t\t\tlastMessageDate: raw.creationDate,\n\t\t\tcustomTitle: undefined,\n\t\t};\n\t}\n\n\tif (raw.version === 2) {\n\t\treturn {\n\t\t\t...raw,\n\t\t\tversion: 3,\n\t\t\tcustomTitle: raw.computedTitle\n\t\t};\n\t}\n\n\treturn raw;\n}\n\nfunction normalizeOldFields(raw: ISerializableChatDataIn): void {\n\t// Fill in fields that very old chat data may be missing\n\tif (!raw.sessionId) {\n\t\traw.sessionId = generateUuid();\n\t}\n\n\tif (!raw.creationDate) {\n\t\traw.creationDate = getLastYearDate();\n\t}\n\n\tif ('version' in raw && (raw.version === 2 || raw.version === 3)) {\n\t\tif (!raw.lastMessageDate) {\n\t\t\t// A bug led to not porting creationDate properly, and that was copied to lastMessageDate, so fix that up if missing.\n\t\t\traw.lastMessageDate = getLastYearDate();\n\t\t}\n\t}\n\n\t// eslint-disable-next-line local/code-no-any-casts\n\tif ((raw.initialLocation as any) === 'editing-session') {\n\t\traw.initialLocation = ChatAgentLocation.Chat;\n\t}\n}\n\nfunction getLastYearDate(): number {\n\tconst lastYearDate = new Date();\n\tlastYearDate.setFullYear(lastYearDate.getFullYear() - 1);\n\treturn lastYearDate.getTime();\n}\n\nexport function isExportableSessionData(obj: unknown): obj is IExportableChatData {\n\tconst data = obj as IExportableChatData;\n\treturn typeof data === 'object';\n}\n\nexport function isSerializableSessionData(obj: unknown): obj is ISerializableChatData {\n\tconst data = obj as ISerializableChatData;\n\treturn isExportableSessionData(obj) &&\n\t\ttypeof data.creationDate === 'number' &&\n\t\ttypeof data.sessionId === 'string' &&\n\t\tobj.requests.every((request: ISerializableChatRequestData) =>\n\t\t\t!request.usedContext /* for backward compat allow missing usedContext */ || isIUsedContext(request.usedContext)\n\t\t);\n}\n\nexport type IChatChangeEvent =\n\t| IChatInitEvent\n\t| IChatAddRequestEvent | IChatChangedRequestEvent | IChatRemoveRequestEvent\n\t| IChatAddResponseEvent\n\t| IChatSetAgentEvent\n\t| IChatMoveEvent\n\t| IChatSetHiddenEvent\n\t| IChatCompletedRequestEvent\n\t| IChatSetCheckpointEvent\n\t| IChatSetCustomTitleEvent\n\t;\n\nexport interface IChatAddRequestEvent {\n\tkind: 'addRequest';\n\trequest: IChatRequestModel;\n}\n\nexport interface IChatSetCheckpointEvent {\n\tkind: 'setCheckpoint';\n\tdisabledRequestIds: Set<string>;\n\tdisabledResponseIds: Set<string>;\n}\n\nexport interface IChatChangedRequestEvent {\n\tkind: 'changedRequest';\n\trequest: IChatRequestModel;\n}\n\nexport interface IChatCompletedRequestEvent {\n\tkind: 'completedRequest';\n\trequest: IChatRequestModel;\n}\n\nexport interface IChatAddResponseEvent {\n\tkind: 'addResponse';\n\tresponse: IChatResponseModel;\n}\n\nexport const enum ChatRequestRemovalReason {\n\t/**\n\t * \"Normal\" remove\n\t */\n\tRemoval,\n\n\t/**\n\t * Removed because the request will be resent\n\t */\n\tResend,\n\n\t/**\n\t * Remove because the request is moving to another model\n\t */\n\tAdoption\n}\n\nexport interface IChatRemoveRequestEvent {\n\tkind: 'removeRequest';\n\trequestId: string;\n\tresponseId?: string;\n\treason: ChatRequestRemovalReason;\n}\n\nexport interface IChatSetHiddenEvent {\n\tkind: 'setHidden';\n}\n\nexport interface IChatMoveEvent {\n\tkind: 'move';\n\ttarget: URI;\n\trange: IRange;\n}\n\nexport interface IChatSetAgentEvent {\n\tkind: 'setAgent';\n\tagent: IChatAgentData;\n\tcommand?: IChatAgentCommand;\n}\n\nexport interface IChatSetCustomTitleEvent {\n\tkind: 'setCustomTitle';\n\ttitle: string;\n}\n\nexport interface IChatInitEvent {\n\tkind: 'initialize';\n}\n\n/**\n * Internal implementation of IInputModel\n */\nclass InputModel implements IInputModel {\n\tprivate readonly _state: ReturnType<typeof observableValue<IChatModelInputState | undefined>>;\n\treadonly state: IObservable<IChatModelInputState | undefined>;\n\n\tconstructor(initialState: IChatModelInputState | undefined) {\n\t\tthis._state = observableValueOpts({ debugName: 'inputModelState', equalsFn: equals }, initialState);\n\t\tthis.state = this._state;\n\t}\n\n\tsetState(state: Partial<IChatModelInputState>): void {\n\t\tconst current = this._state.get();\n\t\tthis._state.set({\n\t\t\t// If current is undefined, provide defaults for required fields\n\t\t\tattachments: [],\n\t\t\tmode: { id: 'agent', kind: ChatModeKind.Agent },\n\t\t\tselectedModel: undefined,\n\t\t\tinputText: '',\n\t\t\tselections: [],\n\t\t\tcontrib: {},\n\t\t\t...current,\n\t\t\t...state\n\t\t}, undefined);\n\t}\n\n\tclearState(): void {\n\t\tthis._state.set(undefined, undefined);\n\t}\n}\n\nexport class ChatModel extends Disposable implements IChatModel {\n\tstatic getDefaultTitle(requests: (ISerializableChatRequestData | IChatRequestModel)[]): string {\n\t\tconst firstRequestMessage = requests.at(0)?.message ?? '';\n\t\tconst message = typeof firstRequestMessage === 'string' ?\n\t\t\tfirstRequestMessage :\n\t\t\tfirstRequestMessage.text;\n\t\treturn message.split('\\n')[0].substring(0, 200);\n\t}\n\n\tprivate readonly _onDidDispose = this._register(new Emitter<void>());\n\treadonly onDidDispose = this._onDidDispose.event;\n\n\tprivate readonly _onDidChange = this._register(new Emitter<IChatChangeEvent>());\n\treadonly onDidChange = this._onDidChange.event;\n\n\tprivate _requests: ChatRequestModel[];\n\n\tprivate _contributedChatSession: IChatSessionContext | undefined;\n\tpublic get contributedChatSession(): IChatSessionContext | undefined {\n\t\treturn this._contributedChatSession;\n\t}\n\tpublic setContributedChatSession(session: IChatSessionContext | undefined) {\n\t\tthis._contributedChatSession = session;\n\t}\n\n\t// TODO to be clear, this is not the same as the id from the session object, which belongs to the provider.\n\t// It's easier to be able to identify this model before its async initialization is complete\n\tprivate readonly _sessionId: string;\n\t/** @deprecated Use {@link sessionResource} instead */\n\tget sessionId(): string {\n\t\treturn this._sessionId;\n\t}\n\n\tprivate readonly _sessionResource: URI;\n\tget sessionResource(): URI {\n\t\treturn this._sessionResource;\n\t}\n\n\treadonly requestInProgress: IObservable<boolean>;\n\treadonly requestNeedsInput: IObservable<boolean>;\n\n\t/** Input model for managing input state */\n\treadonly inputModel: InputModel;\n\n\tget hasRequests(): boolean {\n\t\treturn this._requests.length > 0;\n\t}\n\n\tget lastRequest(): ChatRequestModel | undefined {\n\t\treturn this._requests.at(-1);\n\t}\n\n\tprivate _timestamp: number;\n\tget timestamp(): number {\n\t\treturn this._timestamp;\n\t}\n\n\tprivate _lastMessageDate: number;\n\tget lastMessageDate(): number {\n\t\treturn this._lastMessageDate;\n\t}\n\n\tprivate get _defaultAgent() {\n\t\treturn this.chatAgentService.getDefaultAgent(ChatAgentLocation.Chat, ChatModeKind.Ask);\n\t}\n\n\tprivate readonly _initialResponderUsername: string | undefined;\n\tget responderUsername(): string {\n\t\treturn this._defaultAgent?.fullName ??\n\t\t\tthis._initialResponderUsername ?? '';\n\t}\n\n\tprivate readonly _initialResponderAvatarIconUri: ThemeIcon | URI | undefined;\n\tget responderAvatarIcon(): ThemeIcon | URI | undefined {\n\t\treturn this._defaultAgent?.metadata.themeIcon ??\n\t\t\tthis._initialResponderAvatarIconUri;\n\t}\n\n\tprivate _isImported = false;\n\tget isImported(): boolean {\n\t\treturn this._isImported;\n\t}\n\n\tprivate _customTitle: string | undefined;\n\tget customTitle(): string | undefined {\n\t\treturn this._customTitle;\n\t}\n\n\tget title(): string {\n\t\treturn this._customTitle || ChatModel.getDefaultTitle(this._requests);\n\t}\n\n\tget hasCustomTitle(): boolean {\n\t\treturn this._customTitle !== undefined;\n\t}\n\n\tprivate _editingSession: IChatEditingSession | undefined;\n\n\tget editingSession(): IChatEditingSession | undefined {\n\t\treturn this._editingSession;\n\t}\n\n\tprivate readonly _initialLocation: ChatAgentLocation;\n\tget initialLocation(): ChatAgentLocation {\n\t\treturn this._initialLocation;\n\t}\n\n\tprivate readonly _canUseTools: boolean = true;\n\tget canUseTools(): boolean {\n\t\treturn this._canUseTools;\n\t}\n\n\tconstructor(\n\t\tinitialData: ISerializableChatData | IExportableChatData | undefined,\n\t\tinitialModelProps: { initialLocation: ChatAgentLocation; canUseTools: boolean; resource?: URI },\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IChatAgentService private readonly chatAgentService: IChatAgentService,\n\t\t@IChatEditingService private readonly chatEditingService: IChatEditingService,\n\t) {\n\t\tsuper();\n\n\t\tconst isValid = isSerializableSessionData(initialData);\n\t\tif (initialData && !isValid) {\n\t\t\tthis.logService.warn(`ChatModel#constructor: Loaded malformed session data: ${JSON.stringify(initialData)}`);\n\t\t}\n\n\t\tthis._isImported = (!!initialData && !isValid) || (initialData?.isImported ?? false);\n\t\tthis._sessionId = (isValid && initialData.sessionId) || generateUuid();\n\t\tthis._sessionResource = initialModelProps.resource ?? LocalChatSessionUri.forSession(this._sessionId);\n\n\t\tthis._requests = initialData ? this._deserialize(initialData) : [];\n\t\tthis._timestamp = (isValid && initialData.creationDate) || Date.now();\n\t\tthis._lastMessageDate = (isValid && initialData.lastMessageDate) || this._timestamp;\n\t\tthis._customTitle = isValid ? initialData.customTitle : undefined;\n\n\t\t// Initialize input model from serialized data (undefined for new chats)\n\t\tconst serializedInputState = isValid && initialData.inputState ? initialData.inputState : undefined;\n\t\tthis.inputModel = new InputModel(serializedInputState && {\n\t\t\tattachments: serializedInputState.attachments,\n\t\t\tmode: serializedInputState.mode,\n\t\t\tselectedModel: serializedInputState.selectedModel && {\n\t\t\t\tidentifier: serializedInputState.selectedModel.identifier,\n\t\t\t\tmetadata: serializedInputState.selectedModel.metadata\n\t\t\t},\n\t\t\tcontrib: serializedInputState.contrib,\n\t\t\tinputText: serializedInputState.inputText,\n\t\t\tselections: serializedInputState.selections\n\t\t});\n\n\t\tthis._initialResponderUsername = initialData?.responderUsername;\n\t\tthis._initialResponderAvatarIconUri = isUriComponents(initialData?.responderAvatarIconUri) ? URI.revive(initialData.responderAvatarIconUri) : initialData?.responderAvatarIconUri;\n\n\t\tthis._initialLocation = initialData?.initialLocation ?? initialModelProps.initialLocation;\n\t\tthis._canUseTools = initialModelProps.canUseTools;\n\n\t\tconst lastRequest = observableFromEvent(this, this.onDidChange, () => this._requests.at(-1));\n\n\t\tthis._register(autorun(reader => {\n\t\t\tconst request = lastRequest.read(reader);\n\t\t\tif (!request?.response) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treader.store.add(request.response.onDidChange(ev => {\n\t\t\t\tif (ev.reason === 'completedRequest') {\n\t\t\t\t\tthis._onDidChange.fire({ kind: 'completedRequest', request });\n\t\t\t\t}\n\t\t\t}));\n\t\t}));\n\n\t\tthis.requestInProgress = lastRequest.map((request, r) => {\n\t\t\treturn request?.response?.isInProgress.read(r) ?? false;\n\t\t});\n\n\t\tthis.requestNeedsInput = lastRequest.map((request, r) => {\n\t\t\treturn !!request?.response?.isPendingConfirmation.read(r);\n\t\t});\n\t}\n\n\tstartEditingSession(isGlobalEditingSession?: boolean, transferFromSession?: IChatEditingSession): void {\n\t\tconst session = this._editingSession ??= this._register(\n\t\t\ttransferFromSession\n\t\t\t\t? this.chatEditingService.transferEditingSession(this, transferFromSession)\n\t\t\t\t: isGlobalEditingSession\n\t\t\t\t\t? this.chatEditingService.startOrContinueGlobalEditingSession(this)\n\t\t\t\t\t: this.chatEditingService.createEditingSession(this)\n\t\t);\n\n\t\tthis._register(autorun(reader => {\n\t\t\tthis._setDisabledRequests(session.requestDisablement.read(reader));\n\t\t}));\n\t}\n\n\tprivate currentEditedFileEvents = new ResourceMap<IChatAgentEditedFileEvent>();\n\tnotifyEditingAction(action: IChatEditingSessionAction): void {\n\t\tconst state = action.outcome === 'accepted' ? ChatRequestEditedFileEventKind.Keep :\n\t\t\taction.outcome === 'rejected' ? ChatRequestEditedFileEventKind.Undo :\n\t\t\t\taction.outcome === 'userModified' ? ChatRequestEditedFileEventKind.UserModification : null;\n\t\tif (state === null) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.currentEditedFileEvents.has(action.uri) || this.currentEditedFileEvents.get(action.uri)?.eventKind === ChatRequestEditedFileEventKind.Keep) {\n\t\t\tthis.currentEditedFileEvents.set(action.uri, { eventKind: state, uri: action.uri });\n\t\t}\n\t}\n\n\tprivate _deserialize(obj: IExportableChatData): ChatRequestModel[] {\n\t\tconst requests = obj.requests;\n\t\tif (!Array.isArray(requests)) {\n\t\t\tthis.logService.error(`Ignoring malformed session data: ${JSON.stringify(obj)}`);\n\t\t\treturn [];\n\t\t}\n\n\t\ttry {\n\t\t\treturn requests.map((raw: ISerializableChatRequestData) => {\n\t\t\t\tconst parsedRequest =\n\t\t\t\t\ttypeof raw.message === 'string'\n\t\t\t\t\t\t? this.getParsedRequestFromString(raw.message)\n\t\t\t\t\t\t: reviveParsedChatRequest(raw.message);\n\n\t\t\t\t// Old messages don't have variableData, or have it in the wrong (non-array) shape\n\t\t\t\tconst variableData: IChatRequestVariableData = this.reviveVariableData(raw.variableData);\n\t\t\t\tconst request = new ChatRequestModel({\n\t\t\t\t\tsession: this,\n\t\t\t\t\tmessage: parsedRequest,\n\t\t\t\t\tvariableData,\n\t\t\t\t\ttimestamp: raw.timestamp ?? -1,\n\t\t\t\t\trestoredId: raw.requestId,\n\t\t\t\t\tconfirmation: raw.confirmation,\n\t\t\t\t\teditedFileEvents: raw.editedFileEvents,\n\t\t\t\t\tmodelId: raw.modelId,\n\t\t\t\t});\n\t\t\t\trequest.shouldBeRemovedOnSend = raw.isHidden ? { requestId: raw.requestId } : raw.shouldBeRemovedOnSend;\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\tif (raw.response || raw.result || (raw as any).responseErrorDetails) {\n\t\t\t\t\tconst agent = (raw.agent && 'metadata' in raw.agent) ? // Check for the new format, ignore entries in the old format\n\t\t\t\t\t\treviveSerializedAgent(raw.agent) : undefined;\n\n\t\t\t\t\t// Port entries from old format\n\t\t\t\t\tconst result = 'responseErrorDetails' in raw ?\n\t\t\t\t\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\t\t\t\t\t{ errorDetails: raw.responseErrorDetails } as IChatAgentResult : raw.result;\n\t\t\t\t\trequest.response = new ChatResponseModel({\n\t\t\t\t\t\tresponseContent: raw.response ?? [new MarkdownString(raw.response)],\n\t\t\t\t\t\tsession: this,\n\t\t\t\t\t\tagent,\n\t\t\t\t\t\tslashCommand: raw.slashCommand,\n\t\t\t\t\t\trequestId: request.id,\n\t\t\t\t\t\tmodelState: raw.modelState || { value: raw.isCanceled ? ResponseModelState.Cancelled : ResponseModelState.Complete, completedAt: Date.now() },\n\t\t\t\t\t\tvote: raw.vote,\n\t\t\t\t\t\ttimestamp: raw.timestamp,\n\t\t\t\t\t\tvoteDownReason: raw.voteDownReason,\n\t\t\t\t\t\tresult,\n\t\t\t\t\t\tfollowups: raw.followups,\n\t\t\t\t\t\trestoredId: raw.responseId,\n\t\t\t\t\t\ttimeSpentWaiting: raw.timeSpentWaiting,\n\t\t\t\t\t\tshouldBeBlocked: request.shouldBeBlocked,\n\t\t\t\t\t\tcodeBlockInfos: raw.responseMarkdownInfo?.map<ICodeBlockInfo>(info => ({ suggestionId: info.suggestionId })),\n\t\t\t\t\t});\n\t\t\t\t\trequest.response.shouldBeRemovedOnSend = raw.isHidden ? { requestId: raw.requestId } : raw.shouldBeRemovedOnSend;\n\t\t\t\t\tif (raw.usedContext) { // @ulugbekna: if this's a new vscode sessions, doc versions are incorrect anyway?\n\t\t\t\t\t\trequest.response.applyReference(revive(raw.usedContext));\n\t\t\t\t\t}\n\n\t\t\t\t\traw.contentReferences?.forEach(r => request.response!.applyReference(revive(r)));\n\t\t\t\t\traw.codeCitations?.forEach(c => request.response!.applyCodeCitation(revive(c)));\n\t\t\t\t}\n\t\t\t\treturn request;\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tthis.logService.error('Failed to parse chat data', error);\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tprivate reviveVariableData(raw: IChatRequestVariableData): IChatRequestVariableData {\n\t\tconst variableData = raw && Array.isArray(raw.variables)\n\t\t\t? raw :\n\t\t\t{ variables: [] };\n\n\t\tvariableData.variables = variableData.variables.map<IChatRequestVariableEntry>((v): IChatRequestVariableEntry => {\n\t\t\t// Old variables format\n\t\t\tif (v && 'values' in v && Array.isArray(v.values)) {\n\t\t\t\treturn {\n\t\t\t\t\tkind: 'generic',\n\t\t\t\t\tid: v.id ?? '',\n\t\t\t\t\tname: v.name,\n\t\t\t\t\tvalue: v.values[0]?.value,\n\t\t\t\t\trange: v.range,\n\t\t\t\t\tmodelDescription: v.modelDescription,\n\t\t\t\t\treferences: v.references\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\treturn v;\n\t\t\t}\n\t\t});\n\n\t\treturn variableData;\n\t}\n\n\tprivate getParsedRequestFromString(message: string): IParsedChatRequest {\n\t\t// TODO These offsets won't be used, but chat replies need to go through the parser as well\n\t\tconst parts = [new ChatRequestTextPart(new OffsetRange(0, message.length), { startColumn: 1, startLineNumber: 1, endColumn: 1, endLineNumber: 1 }, message)];\n\t\treturn {\n\t\t\ttext: message,\n\t\t\tparts\n\t\t};\n\t}\n\n\n\n\tgetRequests(): ChatRequestModel[] {\n\t\treturn this._requests;\n\t}\n\n\tresetCheckpoint(): void {\n\t\tfor (const request of this._requests) {\n\t\t\trequest.shouldBeBlocked = false;\n\t\t}\n\t}\n\n\tsetCheckpoint(requestId: string | undefined) {\n\t\tlet checkpoint: ChatRequestModel | undefined;\n\t\tlet checkpointIndex = -1;\n\t\tif (requestId !== undefined) {\n\t\t\tthis._requests.forEach((request, index) => {\n\t\t\t\tif (request.id === requestId) {\n\t\t\t\t\tcheckpointIndex = index;\n\t\t\t\t\tcheckpoint = request;\n\t\t\t\t\trequest.shouldBeBlocked = true;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (!checkpoint) {\n\t\t\t\treturn; // Invalid request ID\n\t\t\t}\n\t\t}\n\n\t\tconst disabledRequestIds = new Set<string>();\n\t\tconst disabledResponseIds = new Set<string>();\n\t\tfor (let i = this._requests.length - 1; i >= 0; i -= 1) {\n\t\t\tconst request = this._requests[i];\n\t\t\tif (this._checkpoint && !checkpoint) {\n\t\t\t\trequest.shouldBeBlocked = false;\n\t\t\t} else if (checkpoint && i >= checkpointIndex) {\n\t\t\t\trequest.shouldBeBlocked = true;\n\t\t\t\tdisabledRequestIds.add(request.id);\n\t\t\t\tif (request.response) {\n\t\t\t\t\tdisabledResponseIds.add(request.response.id);\n\t\t\t\t}\n\t\t\t} else if (checkpoint && i < checkpointIndex) {\n\t\t\t\trequest.shouldBeBlocked = false;\n\t\t\t}\n\t\t}\n\n\t\tthis._checkpoint = checkpoint;\n\t\tthis._onDidChange.fire({\n\t\t\tkind: 'setCheckpoint',\n\t\t\tdisabledRequestIds,\n\t\t\tdisabledResponseIds\n\t\t});\n\t}\n\n\tprivate _checkpoint: ChatRequestModel | undefined = undefined;\n\tpublic get checkpoint() {\n\t\treturn this._checkpoint;\n\t}\n\n\tprivate _setDisabledRequests(requestIds: IChatRequestDisablement[]) {\n\t\tthis._requests.forEach((request) => {\n\t\t\tconst shouldBeRemovedOnSend = requestIds.find(r => r.requestId === request.id);\n\t\t\trequest.shouldBeRemovedOnSend = shouldBeRemovedOnSend;\n\t\t\tif (request.response) {\n\t\t\t\trequest.response.shouldBeRemovedOnSend = shouldBeRemovedOnSend;\n\t\t\t}\n\t\t});\n\n\t\tthis._onDidChange.fire({ kind: 'setHidden' });\n\t}\n\n\taddRequest(message: IParsedChatRequest, variableData: IChatRequestVariableData, attempt: number, modeInfo?: IChatRequestModeInfo, chatAgent?: IChatAgentData, slashCommand?: IChatAgentCommand, confirmation?: string, locationData?: IChatLocationData, attachments?: IChatRequestVariableEntry[], isCompleteAddedRequest?: boolean, modelId?: string, userSelectedTools?: UserSelectedTools): ChatRequestModel {\n\t\tconst editedFileEvents = [...this.currentEditedFileEvents.values()];\n\t\tthis.currentEditedFileEvents.clear();\n\t\tconst request = new ChatRequestModel({\n\t\t\tsession: this,\n\t\t\tmessage,\n\t\t\tvariableData,\n\t\t\ttimestamp: Date.now(),\n\t\t\tattempt,\n\t\t\tmodeInfo,\n\t\t\tconfirmation,\n\t\t\tlocationData,\n\t\t\tattachedContext: attachments,\n\t\t\tisCompleteAddedRequest,\n\t\t\tmodelId,\n\t\t\teditedFileEvents: editedFileEvents.length ? editedFileEvents : undefined,\n\t\t\tuserSelectedTools,\n\t\t});\n\t\trequest.response = new ChatResponseModel({\n\t\t\tresponseContent: [],\n\t\t\tsession: this,\n\t\t\tagent: chatAgent,\n\t\t\tslashCommand,\n\t\t\trequestId: request.id,\n\t\t\tisCompleteAddedRequest,\n\t\t\tcodeBlockInfos: undefined,\n\t\t});\n\n\t\tthis._requests.push(request);\n\t\tthis._lastMessageDate = Date.now();\n\t\tthis._onDidChange.fire({ kind: 'addRequest', request });\n\t\treturn request;\n\t}\n\n\tpublic setCustomTitle(title: string): void {\n\t\tthis._customTitle = title;\n\t\tthis._onDidChange.fire({ kind: 'setCustomTitle', title });\n\t}\n\n\tupdateRequest(request: ChatRequestModel, variableData: IChatRequestVariableData) {\n\t\trequest.variableData = variableData;\n\t\tthis._onDidChange.fire({ kind: 'changedRequest', request });\n\t}\n\n\tadoptRequest(request: ChatRequestModel): void {\n\t\t// this doesn't use `removeRequest` because it must not dispose the request object\n\t\tconst oldOwner = request.session;\n\t\tconst index = oldOwner._requests.findIndex((candidate: ChatRequestModel) => candidate.id === request.id);\n\n\t\tif (index === -1) {\n\t\t\treturn;\n\t\t}\n\n\t\toldOwner._requests.splice(index, 1);\n\n\t\trequest.adoptTo(this);\n\t\trequest.response?.adoptTo(this);\n\t\tthis._requests.push(request);\n\n\t\toldOwner._onDidChange.fire({ kind: 'removeRequest', requestId: request.id, responseId: request.response?.id, reason: ChatRequestRemovalReason.Adoption });\n\t\tthis._onDidChange.fire({ kind: 'addRequest', request });\n\t}\n\n\tacceptResponseProgress(request: ChatRequestModel, progress: IChatProgress, quiet?: boolean): void {\n\t\tif (!request.response) {\n\t\t\trequest.response = new ChatResponseModel({\n\t\t\t\tresponseContent: [],\n\t\t\t\tsession: this,\n\t\t\t\trequestId: request.id,\n\t\t\t\tcodeBlockInfos: undefined,\n\t\t\t});\n\t\t}\n\n\t\tif (request.response.isComplete) {\n\t\t\tthrow new Error('acceptResponseProgress: Adding progress to a completed response');\n\t\t}\n\n\t\tif (progress.kind === 'usedContext' || progress.kind === 'reference') {\n\t\t\trequest.response.applyReference(progress);\n\t\t} else if (progress.kind === 'codeCitation') {\n\t\t\trequest.response.applyCodeCitation(progress);\n\t\t} else if (progress.kind === 'move') {\n\t\t\tthis._onDidChange.fire({ kind: 'move', target: progress.uri, range: progress.range });\n\t\t} else if (progress.kind === 'codeblockUri' && progress.isEdit) {\n\t\t\trequest.response.addUndoStop({ id: generateUuid(), kind: 'undoStop' });\n\t\t\trequest.response.updateContent(progress, quiet);\n\t\t} else if (progress.kind === 'progressTaskResult') {\n\t\t\t// Should have been handled upstream, not sent to model\n\t\t\tthis.logService.error(`Couldn't handle progress: ${JSON.stringify(progress)}`);\n\t\t} else {\n\t\t\trequest.response.updateContent(progress, quiet);\n\t\t}\n\t}\n\n\tremoveRequest(id: string, reason: ChatRequestRemovalReason = ChatRequestRemovalReason.Removal): void {\n\t\tconst index = this._requests.findIndex(request => request.id === id);\n\t\tconst request = this._requests[index];\n\n\t\tif (index !== -1) {\n\t\t\tthis._onDidChange.fire({ kind: 'removeRequest', requestId: request.id, responseId: request.response?.id, reason });\n\t\t\tthis._requests.splice(index, 1);\n\t\t\trequest.response?.dispose();\n\t\t}\n\t}\n\n\tcancelRequest(request: ChatRequestModel): void {\n\t\tif (request.response) {\n\t\t\trequest.response.cancel();\n\t\t}\n\t}\n\n\tsetResponse(request: ChatRequestModel, result: IChatAgentResult): void {\n\t\tif (!request.response) {\n\t\t\trequest.response = new ChatResponseModel({\n\t\t\t\tresponseContent: [],\n\t\t\t\tsession: this,\n\t\t\t\trequestId: request.id,\n\t\t\t\tcodeBlockInfos: undefined,\n\t\t\t});\n\t\t}\n\n\t\trequest.response.setResult(result);\n\t}\n\n\tsetFollowups(request: ChatRequestModel, followups: IChatFollowup[] | undefined): void {\n\t\tif (!request.response) {\n\t\t\t// Maybe something went wrong?\n\t\t\treturn;\n\t\t}\n\n\t\trequest.response.setFollowups(followups);\n\t}\n\n\tsetResponseModel(request: ChatRequestModel, response: ChatResponseModel): void {\n\t\trequest.response = response;\n\t\tthis._onDidChange.fire({ kind: 'addResponse', response });\n\t}\n\n\ttoExport(): IExportableChatData {\n\t\treturn {\n\t\t\tresponderUsername: this.responderUsername,\n\t\t\tresponderAvatarIconUri: this.responderAvatarIcon,\n\t\t\tinitialLocation: this.initialLocation,\n\t\t\trequests: this._requests.map((r): ISerializableChatRequestData => {\n\t\t\t\tconst message = {\n\t\t\t\t\t...r.message,\n\t\t\t\t\tparts: r.message.parts.map((p: any) => p && 'toJSON' in p ? (p.toJSON as Function)() : p)\n\t\t\t\t};\n\t\t\t\tconst agent = r.response?.agent;\n\t\t\t\tconst agentJson = agent && 'toJSON' in agent ? (agent.toJSON as Function)() :\n\t\t\t\t\tagent ? { ...agent } : undefined;\n\t\t\t\treturn {\n\t\t\t\t\trequestId: r.id,\n\t\t\t\t\tmessage,\n\t\t\t\t\tvariableData: r.variableData,\n\t\t\t\t\tresponse: r.response ?\n\t\t\t\t\t\tr.response.entireResponse.value.map(item => {\n\t\t\t\t\t\t\t// Keeping the shape of the persisted data the same for back compat\n\t\t\t\t\t\t\tif (item.kind === 'treeData') {\n\t\t\t\t\t\t\t\treturn item.treeData;\n\t\t\t\t\t\t\t} else if (item.kind === 'markdownContent') {\n\t\t\t\t\t\t\t\treturn item.content;\n\t\t\t\t\t\t\t} else if (item.kind === 'thinking') {\n\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\tkind: 'thinking',\n\t\t\t\t\t\t\t\t\tvalue: item.value,\n\t\t\t\t\t\t\t\t\tid: item.id,\n\t\t\t\t\t\t\t\t\tmetadata: item.metadata\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t} else if (item.kind === 'confirmation') {\n\t\t\t\t\t\t\t\treturn { ...item, isLive: false };\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\t\t\t\treturn item as any; // TODO\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t: undefined,\n\t\t\t\t\tshouldBeRemovedOnSend: r.shouldBeRemovedOnSend,\n\t\t\t\t\tagent: agentJson,\n\t\t\t\t\ttimestamp: r.timestamp,\n\t\t\t\t\tconfirmation: r.confirmation,\n\t\t\t\t\teditedFileEvents: r.editedFileEvents,\n\t\t\t\t\tmodelId: r.modelId,\n\t\t\t\t\t...r.response?.toJSON(),\n\t\t\t\t};\n\t\t\t}),\n\t\t};\n\t}\n\n\ttoJSON(): ISerializableChatData {\n\t\tconst inputState = this.inputModel.state.get();\n\t\treturn {\n\t\t\tversion: 3,\n\t\t\t...this.toExport(),\n\t\t\tsessionId: this.sessionId,\n\t\t\tcreationDate: this._timestamp,\n\t\t\tisImported: this._isImported,\n\t\t\tlastMessageDate: this._lastMessageDate,\n\t\t\tcustomTitle: this._customTitle,\n\t\t\t// Only include inputState if it has been set\n\t\t\t...(inputState ? {\n\t\t\t\tinputState: {\n\t\t\t\t\tcontrib: inputState.contrib,\n\t\t\t\t\tattachments: inputState.attachments,\n\t\t\t\t\tmode: inputState.mode,\n\t\t\t\t\tselectedModel: inputState.selectedModel ? {\n\t\t\t\t\t\tidentifier: inputState.selectedModel.identifier,\n\t\t\t\t\t\tmetadata: inputState.selectedModel.metadata\n\t\t\t\t\t} : undefined,\n\t\t\t\t\tinputText: inputState.inputText,\n\t\t\t\t\tselections: inputState.selections\n\t\t\t\t}\n\t\t\t} : {})\n\t\t};\n\t}\n\n\toverride dispose() {\n\t\tthis._requests.forEach(r => r.response?.dispose());\n\t\tthis._onDidDispose.fire();\n\n\t\tsuper.dispose();\n\t}\n}\n\nexport function updateRanges(variableData: IChatRequestVariableData, diff: number): IChatRequestVariableData {\n\treturn {\n\t\tvariables: variableData.variables.map(v => ({\n\t\t\t...v,\n\t\t\trange: v.range && {\n\t\t\t\tstart: v.range.start - diff,\n\t\t\t\tendExclusive: v.range.endExclusive - diff\n\t\t\t}\n\t\t}))\n\t};\n}\n\nexport function canMergeMarkdownStrings(md1: IMarkdownString, md2: IMarkdownString): boolean {\n\tif (md1.baseUri && md2.baseUri) {\n\t\tconst baseUriEquals = md1.baseUri.scheme === md2.baseUri.scheme\n\t\t\t&& md1.baseUri.authority === md2.baseUri.authority\n\t\t\t&& md1.baseUri.path === md2.baseUri.path\n\t\t\t&& md1.baseUri.query === md2.baseUri.query\n\t\t\t&& md1.baseUri.fragment === md2.baseUri.fragment;\n\t\tif (!baseUriEquals) {\n\t\t\treturn false;\n\t\t}\n\t} else if (md1.baseUri || md2.baseUri) {\n\t\treturn false;\n\t}\n\n\treturn equals(md1.isTrusted, md2.isTrusted) &&\n\t\tmd1.supportHtml === md2.supportHtml &&\n\t\tmd1.supportThemeIcons === md2.supportThemeIcons;\n}\n\nexport function appendMarkdownString(md1: IMarkdownString, md2: IMarkdownString | string): IMarkdownString {\n\tconst appendedValue = typeof md2 === 'string' ? md2 : md2.value;\n\treturn {\n\t\tvalue: md1.value + appendedValue,\n\t\tisTrusted: md1.isTrusted,\n\t\tsupportThemeIcons: md1.supportThemeIcons,\n\t\tsupportHtml: md1.supportHtml,\n\t\tbaseUri: md1.baseUri\n\t};\n}\n\nexport function getCodeCitationsMessage(citations: ReadonlyArray<IChatCodeCitation>): string {\n\tif (citations.length === 0) {\n\t\treturn '';\n\t}\n\n\tconst licenseTypes = citations.reduce((set, c) => set.add(c.license), new Set<string>());\n\tconst label = licenseTypes.size === 1 ?\n\t\tlocalize('codeCitation', \"Similar code found with 1 license type\", licenseTypes.size) :\n\t\tlocalize('codeCitations', \"Similar code found with {0} license types\", licenseTypes.size);\n\treturn label;\n}\n\nexport enum ChatRequestEditedFileEventKind {\n\tKeep = 1,\n\tUndo = 2,\n\tUserModification = 3,\n}\n\nexport interface IChatAgentEditedFileEvent {\n\treadonly uri: URI;\n\treadonly eventKind: ChatRequestEditedFileEventKind;\n}\n\n/** URI for a resource embedded in a chat request/response */\nexport namespace ChatResponseResource {\n\texport const scheme = 'vscode-chat-response-resource';\n\n\texport function createUri(sessionId: string, toolCallId: string, index: number, basename?: string): URI {\n\t\treturn URI.from({\n\t\t\tscheme: ChatResponseResource.scheme,\n\t\t\tauthority: sessionId,\n\t\t\tpath: `/tool/${toolCallId}/${index}` + (basename ? `/${basename}` : ''),\n\t\t});\n\t}\n\n\texport function parseUri(uri: URI): undefined | { sessionId: string; toolCallId: string; index: number } {\n\t\tif (uri.scheme !== ChatResponseResource.scheme) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst parts = uri.path.split('/');\n\t\tif (parts.length < 5) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst [, kind, toolCallId, index] = parts;\n\t\tif (kind !== 'tool') {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn {\n\t\t\tsessionId: uri.authority,\n\t\t\ttoolCallId: toolCallId,\n\t\t\tindex: Number(index),\n\t\t};\n\t}\n}\n"]}