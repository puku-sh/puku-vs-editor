{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/common/promptSyntax/languageProviders/promptBodyAutocompletion.ts","vs/workbench/contrib/chat/common/promptSyntax/languageProviders/promptBodyAutocompletion.ts"],"names":[],"mappings":"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","file":"promptBodyAutocompletion.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { dirname, extUri } from '../../../../../../base/common/resources.js';\nimport { ITextModel } from '../../../../../../editor/common/model.js';\nimport { getPromptsTypeForLanguageId, PromptsType } from '../promptTypes.js';\nimport { Position } from '../../../../../../editor/common/core/position.js';\nimport { IFileService } from '../../../../../../platform/files/common/files.js';\nimport { CancellationToken } from '../../../../../../base/common/cancellation.js';\nimport { CompletionContext, CompletionItem, CompletionItemKind, CompletionItemProvider, CompletionList } from '../../../../../../editor/common/languages.js';\nimport { Range } from '../../../../../../editor/common/core/range.js';\nimport { CharCode } from '../../../../../../base/common/charCode.js';\nimport { getWordAtText } from '../../../../../../editor/common/core/wordHelper.js';\nimport { chatVariableLeader } from '../../chatParserTypes.js';\nimport { ILanguageModelToolsService } from '../../languageModelToolsService.js';\n\n/**\n * Provides autocompletion for the variables inside prompt bodies.\n * - #file: paths to files and folders in the workspace\n * - # tool names\n */\nexport class PromptBodyAutocompletion implements CompletionItemProvider {\n\t/**\n\t * Debug display name for this provider.\n\t */\n\tpublic readonly _debugDisplayName: string = 'PromptBodyAutocompletion';\n\n\t/**\n\t * List of trigger characters handled by this provider.\n\t */\n\tpublic readonly triggerCharacters = [':', '.', '/', '\\\\'];\n\n\tconstructor(\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@ILanguageModelToolsService private readonly languageModelToolsService: ILanguageModelToolsService,\n\t) {\n\t}\n\n\t/**\n\t * The main function of this provider that calculates\n\t * completion items based on the provided arguments.\n\t */\n\tpublic async provideCompletionItems(model: ITextModel, position: Position, context: CompletionContext, token: CancellationToken): Promise<CompletionList | undefined> {\n\t\tconst promptsType = getPromptsTypeForLanguageId(model.getLanguageId());\n\t\tif (!promptsType) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst reference = await this.findVariableReference(model, position, token);\n\t\tif (!reference) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst suggestions: CompletionItem[] = [];\n\t\tswitch (reference.type) {\n\t\t\tcase 'file':\n\t\t\t\tif (reference.contentRange.containsPosition(position)) {\n\t\t\t\t\t// inside the link range\n\t\t\t\t\tawait this.collectFilePathCompletions(model, position, reference.contentRange, suggestions);\n\t\t\t\t} else {\n\t\t\t\t\tawait this.collectDefaultCompletions(model, reference.range, promptsType, suggestions);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'tool':\n\t\t\t\tif (reference.contentRange.containsPosition(position)) {\n\t\t\t\t\tif (promptsType === PromptsType.agent || promptsType === PromptsType.prompt) {\n\t\t\t\t\t\tawait this.collectToolCompletions(model, position, reference.contentRange, suggestions);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tawait this.collectDefaultCompletions(model, reference.range, promptsType, suggestions);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tawait this.collectDefaultCompletions(model, reference.range, promptsType, suggestions);\n\t\t}\n\t\treturn { suggestions };\n\t}\n\n\tprivate async collectToolCompletions(model: ITextModel, position: Position, toolRange: Range, suggestions: CompletionItem[]): Promise<void> {\n\t\tfor (const toolName of this.languageModelToolsService.getQualifiedToolNames()) {\n\t\t\tsuggestions.push({\n\t\t\t\tlabel: toolName,\n\t\t\t\tkind: CompletionItemKind.Value,\n\t\t\t\tfilterText: toolName,\n\t\t\t\tinsertText: toolName,\n\t\t\t\trange: toolRange,\n\t\t\t});\n\t\t}\n\t}\n\n\n\tprivate async collectFilePathCompletions(model: ITextModel, position: Position, pathRange: Range, suggestions: CompletionItem[]): Promise<void> {\n\t\tconst pathUntilPosition = model.getValueInRange(pathRange.setEndPosition(position.lineNumber, position.column));\n\t\tconst pathSeparator = pathUntilPosition.includes('/') || !pathUntilPosition.includes('\\\\') ? '/' : '\\\\';\n\t\tlet parentFolderPath: string;\n\t\tif (pathUntilPosition.match(/[^\\/]\\.\\.$/i)) { // ends with `..`\n\t\t\tparentFolderPath = pathUntilPosition + pathSeparator;\n\t\t} else {\n\t\t\tlet i = pathUntilPosition.length - 1;\n\t\t\twhile (i >= 0 && ![CharCode.Slash, CharCode.Backslash].includes(pathUntilPosition.charCodeAt(i))) {\n\t\t\t\ti--;\n\t\t\t}\n\t\t\tparentFolderPath = pathUntilPosition.substring(0, i + 1); // the segment up to the `/` or `\\` before the position\n\t\t}\n\n\t\tconst retriggerCommand = { id: 'editor.action.triggerSuggest', title: 'Suggest' };\n\n\t\ttry {\n\t\t\tconst currentFolder = extUri.resolvePath(dirname(model.uri), parentFolderPath);\n\t\t\tconst { children } = await this.fileService.resolve(currentFolder);\n\t\t\tif (children) {\n\t\t\t\tfor (const child of children) {\n\t\t\t\t\tconst insertText = (parentFolderPath || ('.' + pathSeparator)) + child.name;\n\t\t\t\t\tsuggestions.push({\n\t\t\t\t\t\tlabel: child.name + (child.isDirectory ? pathSeparator : ''),\n\t\t\t\t\t\tkind: child.isDirectory ? CompletionItemKind.Folder : CompletionItemKind.File,\n\t\t\t\t\t\trange: pathRange,\n\t\t\t\t\t\tinsertText: insertText + (child.isDirectory ? pathSeparator : ''),\n\t\t\t\t\t\tfilterText: insertText,\n\t\t\t\t\t\tcommand: child.isDirectory ? retriggerCommand : undefined\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t// ignore errors accessing the folder location\n\t\t}\n\n\t\tsuggestions.push({\n\t\t\tlabel: '..',\n\t\t\tkind: CompletionItemKind.Folder,\n\t\t\tinsertText: parentFolderPath + '..' + pathSeparator,\n\t\t\trange: pathRange,\n\t\t\tfilterText: parentFolderPath + '..',\n\t\t\tcommand: retriggerCommand\n\t\t});\n\t}\n\n\t/**\n\t * Finds a file reference that suites the provided `position`.\n\t */\n\tprivate async findVariableReference(model: ITextModel, position: Position, token: CancellationToken): Promise<{ contentRange: Range; type: string; range: Range } | undefined> {\n\t\tif (model.getLineContent(1).trimEnd() === '---') {\n\t\t\tlet i = 2;\n\t\t\twhile (i <= model.getLineCount() && model.getLineContent(i).trimEnd() !== '---') {\n\t\t\t\ti++;\n\t\t\t}\n\t\t\tif (i >= position.lineNumber) {\n\t\t\t\t// inside front matter\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t}\n\n\t\tconst reg = new RegExp(`${chatVariableLeader}[^\\\\s#]*`, 'g');\n\t\tconst varWord = getWordAtText(position.column, reg, model.getLineContent(position.lineNumber), 0);\n\t\tif (!varWord) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst range = new Range(position.lineNumber, varWord.startColumn + 1, position.lineNumber, varWord.endColumn);\n\t\tconst nameMatch = varWord.word.match(/^#(\\w+:)?/);\n\t\tif (nameMatch) {\n\t\t\tconst contentCol = varWord.startColumn + nameMatch[0].length;\n\t\t\tif (nameMatch[1] === 'file:') {\n\t\t\t\treturn { type: 'file', contentRange: new Range(position.lineNumber, contentCol, position.lineNumber, varWord.endColumn), range };\n\t\t\t} else if (nameMatch[1] === 'tool:') {\n\t\t\t\treturn { type: 'tool', contentRange: new Range(position.lineNumber, contentCol, position.lineNumber, varWord.endColumn), range };\n\t\t\t}\n\t\t}\n\t\treturn { type: '', contentRange: range, range };\n\t}\n\n\tprivate async collectDefaultCompletions(model: ITextModel, range: Range, promptFileType: PromptsType, suggestions: CompletionItem[]): Promise<void> {\n\t\tconst labels = promptFileType === PromptsType.instructions ? ['file'] : ['file', 'tool'];\n\t\tlabels.forEach(label => {\n\t\t\tsuggestions.push({\n\t\t\t\tlabel: `${label}:`,\n\t\t\t\tkind: CompletionItemKind.Keyword,\n\t\t\t\tinsertText: `${label}:`,\n\t\t\t\trange: range,\n\t\t\t\tcommand: { id: 'editor.action.triggerSuggest', title: 'Suggest' }\n\t\t\t});\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { dirname, extUri } from '../../../../../../base/common/resources.js';\nimport { ITextModel } from '../../../../../../editor/common/model.js';\nimport { getPromptsTypeForLanguageId, PromptsType } from '../promptTypes.js';\nimport { Position } from '../../../../../../editor/common/core/position.js';\nimport { IFileService } from '../../../../../../platform/files/common/files.js';\nimport { CancellationToken } from '../../../../../../base/common/cancellation.js';\nimport { CompletionContext, CompletionItem, CompletionItemKind, CompletionItemProvider, CompletionList } from '../../../../../../editor/common/languages.js';\nimport { Range } from '../../../../../../editor/common/core/range.js';\nimport { CharCode } from '../../../../../../base/common/charCode.js';\nimport { getWordAtText } from '../../../../../../editor/common/core/wordHelper.js';\nimport { chatVariableLeader } from '../../chatParserTypes.js';\nimport { ILanguageModelToolsService } from '../../languageModelToolsService.js';\n\n/**\n * Provides autocompletion for the variables inside prompt bodies.\n * - #file: paths to files and folders in the workspace\n * - # tool names\n */\nexport class PromptBodyAutocompletion implements CompletionItemProvider {\n\t/**\n\t * Debug display name for this provider.\n\t */\n\tpublic readonly _debugDisplayName: string = 'PromptBodyAutocompletion';\n\n\t/**\n\t * List of trigger characters handled by this provider.\n\t */\n\tpublic readonly triggerCharacters = [':', '.', '/', '\\\\'];\n\n\tconstructor(\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@ILanguageModelToolsService private readonly languageModelToolsService: ILanguageModelToolsService,\n\t) {\n\t}\n\n\t/**\n\t * The main function of this provider that calculates\n\t * completion items based on the provided arguments.\n\t */\n\tpublic async provideCompletionItems(model: ITextModel, position: Position, context: CompletionContext, token: CancellationToken): Promise<CompletionList | undefined> {\n\t\tconst promptsType = getPromptsTypeForLanguageId(model.getLanguageId());\n\t\tif (!promptsType) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst reference = await this.findVariableReference(model, position, token);\n\t\tif (!reference) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst suggestions: CompletionItem[] = [];\n\t\tswitch (reference.type) {\n\t\t\tcase 'file':\n\t\t\t\tif (reference.contentRange.containsPosition(position)) {\n\t\t\t\t\t// inside the link range\n\t\t\t\t\tawait this.collectFilePathCompletions(model, position, reference.contentRange, suggestions);\n\t\t\t\t} else {\n\t\t\t\t\tawait this.collectDefaultCompletions(model, reference.range, promptsType, suggestions);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'tool':\n\t\t\t\tif (reference.contentRange.containsPosition(position)) {\n\t\t\t\t\tif (promptsType === PromptsType.agent || promptsType === PromptsType.prompt) {\n\t\t\t\t\t\tawait this.collectToolCompletions(model, position, reference.contentRange, suggestions);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tawait this.collectDefaultCompletions(model, reference.range, promptsType, suggestions);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tawait this.collectDefaultCompletions(model, reference.range, promptsType, suggestions);\n\t\t}\n\t\treturn { suggestions };\n\t}\n\n\tprivate async collectToolCompletions(model: ITextModel, position: Position, toolRange: Range, suggestions: CompletionItem[]): Promise<void> {\n\t\tfor (const toolName of this.languageModelToolsService.getQualifiedToolNames()) {\n\t\t\tsuggestions.push({\n\t\t\t\tlabel: toolName,\n\t\t\t\tkind: CompletionItemKind.Value,\n\t\t\t\tfilterText: toolName,\n\t\t\t\tinsertText: toolName,\n\t\t\t\trange: toolRange,\n\t\t\t});\n\t\t}\n\t}\n\n\n\tprivate async collectFilePathCompletions(model: ITextModel, position: Position, pathRange: Range, suggestions: CompletionItem[]): Promise<void> {\n\t\tconst pathUntilPosition = model.getValueInRange(pathRange.setEndPosition(position.lineNumber, position.column));\n\t\tconst pathSeparator = pathUntilPosition.includes('/') || !pathUntilPosition.includes('\\\\') ? '/' : '\\\\';\n\t\tlet parentFolderPath: string;\n\t\tif (pathUntilPosition.match(/[^\\/]\\.\\.$/i)) { // ends with `..`\n\t\t\tparentFolderPath = pathUntilPosition + pathSeparator;\n\t\t} else {\n\t\t\tlet i = pathUntilPosition.length - 1;\n\t\t\twhile (i >= 0 && ![CharCode.Slash, CharCode.Backslash].includes(pathUntilPosition.charCodeAt(i))) {\n\t\t\t\ti--;\n\t\t\t}\n\t\t\tparentFolderPath = pathUntilPosition.substring(0, i + 1); // the segment up to the `/` or `\\` before the position\n\t\t}\n\n\t\tconst retriggerCommand = { id: 'editor.action.triggerSuggest', title: 'Suggest' };\n\n\t\ttry {\n\t\t\tconst currentFolder = extUri.resolvePath(dirname(model.uri), parentFolderPath);\n\t\t\tconst { children } = await this.fileService.resolve(currentFolder);\n\t\t\tif (children) {\n\t\t\t\tfor (const child of children) {\n\t\t\t\t\tconst insertText = (parentFolderPath || ('.' + pathSeparator)) + child.name;\n\t\t\t\t\tsuggestions.push({\n\t\t\t\t\t\tlabel: child.name + (child.isDirectory ? pathSeparator : ''),\n\t\t\t\t\t\tkind: child.isDirectory ? CompletionItemKind.Folder : CompletionItemKind.File,\n\t\t\t\t\t\trange: pathRange,\n\t\t\t\t\t\tinsertText: insertText + (child.isDirectory ? pathSeparator : ''),\n\t\t\t\t\t\tfilterText: insertText,\n\t\t\t\t\t\tcommand: child.isDirectory ? retriggerCommand : undefined\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t// ignore errors accessing the folder location\n\t\t}\n\n\t\tsuggestions.push({\n\t\t\tlabel: '..',\n\t\t\tkind: CompletionItemKind.Folder,\n\t\t\tinsertText: parentFolderPath + '..' + pathSeparator,\n\t\t\trange: pathRange,\n\t\t\tfilterText: parentFolderPath + '..',\n\t\t\tcommand: retriggerCommand\n\t\t});\n\t}\n\n\t/**\n\t * Finds a file reference that suites the provided `position`.\n\t */\n\tprivate async findVariableReference(model: ITextModel, position: Position, token: CancellationToken): Promise<{ contentRange: Range; type: string; range: Range } | undefined> {\n\t\tif (model.getLineContent(1).trimEnd() === '---') {\n\t\t\tlet i = 2;\n\t\t\twhile (i <= model.getLineCount() && model.getLineContent(i).trimEnd() !== '---') {\n\t\t\t\ti++;\n\t\t\t}\n\t\t\tif (i >= position.lineNumber) {\n\t\t\t\t// inside front matter\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t}\n\n\t\tconst reg = new RegExp(`${chatVariableLeader}[^\\\\s#]*`, 'g');\n\t\tconst varWord = getWordAtText(position.column, reg, model.getLineContent(position.lineNumber), 0);\n\t\tif (!varWord) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst range = new Range(position.lineNumber, varWord.startColumn + 1, position.lineNumber, varWord.endColumn);\n\t\tconst nameMatch = varWord.word.match(/^#(\\w+:)?/);\n\t\tif (nameMatch) {\n\t\t\tconst contentCol = varWord.startColumn + nameMatch[0].length;\n\t\t\tif (nameMatch[1] === 'file:') {\n\t\t\t\treturn { type: 'file', contentRange: new Range(position.lineNumber, contentCol, position.lineNumber, varWord.endColumn), range };\n\t\t\t} else if (nameMatch[1] === 'tool:') {\n\t\t\t\treturn { type: 'tool', contentRange: new Range(position.lineNumber, contentCol, position.lineNumber, varWord.endColumn), range };\n\t\t\t}\n\t\t}\n\t\treturn { type: '', contentRange: range, range };\n\t}\n\n\tprivate async collectDefaultCompletions(model: ITextModel, range: Range, promptFileType: PromptsType, suggestions: CompletionItem[]): Promise<void> {\n\t\tconst labels = promptFileType === PromptsType.instructions ? ['file'] : ['file', 'tool'];\n\t\tlabels.forEach(label => {\n\t\t\tsuggestions.push({\n\t\t\t\tlabel: `${label}:`,\n\t\t\t\tkind: CompletionItemKind.Keyword,\n\t\t\t\tinsertText: `${label}:`,\n\t\t\t\trange: range,\n\t\t\t\tcommand: { id: 'editor.action.triggerSuggest', title: 'Suggest' }\n\t\t\t});\n\t\t});\n\t}\n}\n"]}