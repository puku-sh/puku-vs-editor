{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/common/chatViewModel.ts","vs/workbench/contrib/chat/common/chatViewModel.ts"],"names":[],"mappings":"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","file":"chatViewModel.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { hash } from '../../../../base/common/hash.js';\nimport { IMarkdownString } from '../../../../base/common/htmlContent.js';\nimport { Disposable, dispose } from '../../../../base/common/lifecycle.js';\nimport * as marked from '../../../../base/common/marked/marked.js';\nimport { ThemeIcon } from '../../../../base/common/themables.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { annotateVulnerabilitiesInText } from './annotations.js';\nimport { getFullyQualifiedId, IChatAgentCommand, IChatAgentData, IChatAgentNameService, IChatAgentResult } from './chatAgents.js';\nimport { IChatModel, IChatProgressRenderableResponseContent, IChatRequestDisablement, IChatRequestModel, IChatResponseModel, IChatTextEditGroup, IResponse } from './chatModel.js';\nimport { IChatRequestVariableEntry } from './chatVariableEntries.js';\nimport { IParsedChatRequest } from './chatParserTypes.js';\nimport { ChatAgentVoteDirection, ChatAgentVoteDownReason, IChatChangesSummary, IChatCodeCitation, IChatContentReference, IChatFollowup, IChatMcpServersStarting, IChatProgressMessage, IChatResponseErrorDetails, IChatTask, IChatUsedContext } from './chatService.js';\nimport { countWords } from './chatWordCounter.js';\nimport { CodeBlockModelCollection } from './codeBlockModelCollection.js';\nimport { Codicon } from '../../../../base/common/codicons.js';\n\nexport function isRequestVM(item: unknown): item is IChatRequestViewModel {\n\treturn !!item && typeof item === 'object' && 'message' in item;\n}\n\nexport function isResponseVM(item: unknown): item is IChatResponseViewModel {\n\treturn !!item && typeof (item as IChatResponseViewModel).setVote !== 'undefined';\n}\n\nexport function isChatTreeItem(item: unknown): item is IChatRequestViewModel | IChatResponseViewModel {\n\treturn isRequestVM(item) || isResponseVM(item);\n}\n\nexport function assertIsResponseVM(item: unknown): asserts item is IChatResponseViewModel {\n\tif (!isResponseVM(item)) {\n\t\tthrow new Error('Expected item to be IChatResponseViewModel');\n\t}\n}\n\nexport type IChatViewModelChangeEvent = IChatAddRequestEvent | IChangePlaceholderEvent | IChatSessionInitEvent | IChatSetHiddenEvent | IChatSetCheckpointEvent | null;\n\nexport interface IChatAddRequestEvent {\n\tkind: 'addRequest';\n}\n\nexport interface IChangePlaceholderEvent {\n\tkind: 'changePlaceholder';\n}\n\nexport interface IChatSessionInitEvent {\n\tkind: 'initialize';\n}\n\nexport interface IChatSetHiddenEvent {\n\tkind: 'setHidden';\n}\n\nexport interface IChatSetCheckpointEvent {\n\tkind: 'setCheckpoint';\n}\n\nexport interface IChatViewModel {\n\treadonly model: IChatModel;\n\treadonly sessionResource: URI;\n\treadonly onDidDisposeModel: Event<void>;\n\treadonly onDidChange: Event<IChatViewModelChangeEvent>;\n\treadonly inputPlaceholder?: string;\n\tgetItems(): (IChatRequestViewModel | IChatResponseViewModel)[];\n\tsetInputPlaceholder(text: string): void;\n\tresetInputPlaceholder(): void;\n\tediting?: IChatRequestViewModel;\n\tsetEditing(editing: IChatRequestViewModel): void;\n}\n\nexport interface IChatRequestViewModel {\n\treadonly id: string;\n\t/** @deprecated */\n\treadonly sessionId: string;\n\treadonly sessionResource: URI;\n\t/** This ID updates every time the underlying data changes */\n\treadonly dataId: string;\n\treadonly username: string;\n\treadonly avatarIcon?: URI | ThemeIcon;\n\treadonly message: IParsedChatRequest | IChatFollowup;\n\treadonly messageText: string;\n\treadonly attempt: number;\n\treadonly variables: IChatRequestVariableEntry[];\n\tcurrentRenderedHeight: number | undefined;\n\treadonly contentReferences?: ReadonlyArray<IChatContentReference>;\n\treadonly confirmation?: string;\n\treadonly shouldBeRemovedOnSend: IChatRequestDisablement | undefined;\n\treadonly isComplete: boolean;\n\treadonly isCompleteAddedRequest: boolean;\n\treadonly slashCommand: IChatAgentCommand | undefined;\n\treadonly agentOrSlashCommandDetected: boolean;\n\treadonly shouldBeBlocked?: boolean;\n\treadonly modelId?: string;\n}\n\nexport interface IChatResponseMarkdownRenderData {\n\trenderedWordCount: number;\n\tlastRenderTime: number;\n\tisFullyRendered: boolean;\n\toriginalMarkdown: IMarkdownString;\n}\n\nexport interface IChatResponseMarkdownRenderData2 {\n\trenderedWordCount: number;\n\tlastRenderTime: number;\n\tisFullyRendered: boolean;\n\toriginalMarkdown: IMarkdownString;\n}\n\nexport interface IChatProgressMessageRenderData {\n\tprogressMessage: IChatProgressMessage;\n\n\t/**\n\t * Indicates whether this is part of a group of progress messages that are at the end of the response.\n\t * (Not whether this particular item is the very last one in the response).\n\t * Need to re-render and add to partsToRender when this changes.\n\t */\n\tisAtEndOfResponse: boolean;\n\n\t/**\n\t * Whether this progress message the very last item in the response.\n\t * Need to re-render to update spinner vs check when this changes.\n\t */\n\tisLast: boolean;\n}\n\nexport interface IChatTaskRenderData {\n\ttask: IChatTask;\n\tisSettled: boolean;\n\tprogressLength: number;\n}\n\nexport interface IChatResponseRenderData {\n\trenderedParts: IChatRendererContent[];\n\n\trenderedWordCount: number;\n\tlastRenderTime: number;\n}\n\n/**\n * Content type for references used during rendering, not in the model\n */\nexport interface IChatReferences {\n\treferences: ReadonlyArray<IChatContentReference>;\n\tkind: 'references';\n}\n\n/**\n * Content type for the \"Working\" progress message\n */\nexport interface IChatWorkingProgress {\n\tkind: 'working';\n}\n\n\n/**\n * Content type for citations used during rendering, not in the model\n */\nexport interface IChatCodeCitations {\n\tcitations: ReadonlyArray<IChatCodeCitation>;\n\tkind: 'codeCitations';\n}\n\nexport interface IChatErrorDetailsPart {\n\tkind: 'errorDetails';\n\terrorDetails: IChatResponseErrorDetails;\n\tisLast: boolean;\n}\n\nexport interface IChatChangesSummaryPart {\n\treadonly kind: 'changesSummary';\n\treadonly fileChanges: ReadonlyArray<IChatChangesSummary>;\n}\n\n/**\n * Type for content parts rendered by IChatListRenderer (not necessarily in the model)\n */\nexport type IChatRendererContent = IChatProgressRenderableResponseContent | IChatReferences | IChatCodeCitations | IChatErrorDetailsPart | IChatChangesSummaryPart | IChatWorkingProgress | IChatMcpServersStarting;\n\nexport interface IChatLiveUpdateData {\n\ttotalTime: number;\n\tlastUpdateTime: number;\n\timpliedWordLoadRate: number;\n\tlastWordCount: number;\n}\n\nexport interface IChatResponseViewModel {\n\treadonly model: IChatResponseModel;\n\treadonly id: string;\n\treadonly session: IChatViewModel;\n\t/** @deprecated */\n\treadonly sessionId: string;\n\treadonly sessionResource: URI;\n\t/** This ID updates every time the underlying data changes */\n\treadonly dataId: string;\n\t/** The ID of the associated IChatRequestViewModel */\n\treadonly requestId: string;\n\treadonly username: string;\n\treadonly avatarIcon?: URI | ThemeIcon;\n\treadonly agent?: IChatAgentData;\n\treadonly slashCommand?: IChatAgentCommand;\n\treadonly agentOrSlashCommandDetected: boolean;\n\treadonly response: IResponse;\n\treadonly usedContext: IChatUsedContext | undefined;\n\treadonly contentReferences: ReadonlyArray<IChatContentReference>;\n\treadonly codeCitations: ReadonlyArray<IChatCodeCitation>;\n\treadonly progressMessages: ReadonlyArray<IChatProgressMessage>;\n\treadonly isComplete: boolean;\n\treadonly isCanceled: boolean;\n\treadonly isStale: boolean;\n\treadonly vote: ChatAgentVoteDirection | undefined;\n\treadonly voteDownReason: ChatAgentVoteDownReason | undefined;\n\treadonly replyFollowups?: IChatFollowup[];\n\treadonly errorDetails?: IChatResponseErrorDetails;\n\treadonly result?: IChatAgentResult;\n\treadonly contentUpdateTimings?: IChatLiveUpdateData;\n\treadonly shouldBeRemovedOnSend: IChatRequestDisablement | undefined;\n\treadonly isCompleteAddedRequest: boolean;\n\trenderData?: IChatResponseRenderData;\n\tcurrentRenderedHeight: number | undefined;\n\tsetVote(vote: ChatAgentVoteDirection): void;\n\tsetVoteDownReason(reason: ChatAgentVoteDownReason | undefined): void;\n\tusedReferencesExpanded?: boolean;\n\tvulnerabilitiesListExpanded: boolean;\n\tsetEditApplied(edit: IChatTextEditGroup, editCount: number): void;\n\treadonly shouldBeBlocked: boolean;\n}\n\nexport class ChatViewModel extends Disposable implements IChatViewModel {\n\n\tprivate readonly _onDidDisposeModel = this._register(new Emitter<void>());\n\treadonly onDidDisposeModel = this._onDidDisposeModel.event;\n\n\tprivate readonly _onDidChange = this._register(new Emitter<IChatViewModelChangeEvent>());\n\treadonly onDidChange = this._onDidChange.event;\n\n\tprivate readonly _items: (ChatRequestViewModel | ChatResponseViewModel)[] = [];\n\n\tprivate _inputPlaceholder: string | undefined = undefined;\n\tget inputPlaceholder(): string | undefined {\n\t\treturn this._inputPlaceholder;\n\t}\n\n\tget model(): IChatModel {\n\t\treturn this._model;\n\t}\n\n\tsetInputPlaceholder(text: string): void {\n\t\tthis._inputPlaceholder = text;\n\t\tthis._onDidChange.fire({ kind: 'changePlaceholder' });\n\t}\n\n\tresetInputPlaceholder(): void {\n\t\tthis._inputPlaceholder = undefined;\n\t\tthis._onDidChange.fire({ kind: 'changePlaceholder' });\n\t}\n\n\tget sessionResource(): URI {\n\t\treturn this._model.sessionResource;\n\t}\n\n\tconstructor(\n\t\tprivate readonly _model: IChatModel,\n\t\tpublic readonly codeBlockModelCollection: CodeBlockModelCollection,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\t_model.getRequests().forEach((request, i) => {\n\t\t\tconst requestModel = this.instantiationService.createInstance(ChatRequestViewModel, request);\n\t\t\tthis._items.push(requestModel);\n\t\t\tthis.updateCodeBlockTextModels(requestModel);\n\n\t\t\tif (request.response) {\n\t\t\t\tthis.onAddResponse(request.response);\n\t\t\t}\n\t\t});\n\n\t\tthis._register(_model.onDidDispose(() => this._onDidDisposeModel.fire()));\n\t\tthis._register(_model.onDidChange(e => {\n\t\t\tif (e.kind === 'addRequest') {\n\t\t\t\tconst requestModel = this.instantiationService.createInstance(ChatRequestViewModel, e.request);\n\t\t\t\tthis._items.push(requestModel);\n\t\t\t\tthis.updateCodeBlockTextModels(requestModel);\n\n\t\t\t\tif (e.request.response) {\n\t\t\t\t\tthis.onAddResponse(e.request.response);\n\t\t\t\t}\n\t\t\t} else if (e.kind === 'addResponse') {\n\t\t\t\tthis.onAddResponse(e.response);\n\t\t\t} else if (e.kind === 'removeRequest') {\n\t\t\t\tconst requestIdx = this._items.findIndex(item => isRequestVM(item) && item.id === e.requestId);\n\t\t\t\tif (requestIdx >= 0) {\n\t\t\t\t\tthis._items.splice(requestIdx, 1);\n\t\t\t\t}\n\n\t\t\t\tconst responseIdx = e.responseId && this._items.findIndex(item => isResponseVM(item) && item.id === e.responseId);\n\t\t\t\tif (typeof responseIdx === 'number' && responseIdx >= 0) {\n\t\t\t\t\tconst items = this._items.splice(responseIdx, 1);\n\t\t\t\t\tconst item = items[0];\n\t\t\t\t\tif (item instanceof ChatResponseViewModel) {\n\t\t\t\t\t\titem.dispose();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst modelEventToVmEvent: IChatViewModelChangeEvent =\n\t\t\t\te.kind === 'addRequest' ? { kind: 'addRequest' }\n\t\t\t\t\t: e.kind === 'initialize' ? { kind: 'initialize' }\n\t\t\t\t\t\t: e.kind === 'setHidden' ? { kind: 'setHidden' }\n\t\t\t\t\t\t\t: null;\n\t\t\tthis._onDidChange.fire(modelEventToVmEvent);\n\t\t}));\n\t}\n\n\tprivate onAddResponse(responseModel: IChatResponseModel) {\n\t\tconst response = this.instantiationService.createInstance(ChatResponseViewModel, responseModel, this);\n\t\tthis._register(response.onDidChange(() => {\n\t\t\tif (response.isComplete) {\n\t\t\t\tthis.updateCodeBlockTextModels(response);\n\t\t\t}\n\t\t\treturn this._onDidChange.fire(null);\n\t\t}));\n\t\tthis._items.push(response);\n\t\tthis.updateCodeBlockTextModels(response);\n\t}\n\n\tgetItems(): (IChatRequestViewModel | IChatResponseViewModel)[] {\n\t\treturn this._items.filter((item) => !item.shouldBeRemovedOnSend || item.shouldBeRemovedOnSend.afterUndoStop);\n\t}\n\n\n\tprivate _editing: IChatRequestViewModel | undefined = undefined;\n\tget editing(): IChatRequestViewModel | undefined {\n\t\treturn this._editing;\n\t}\n\n\tsetEditing(editing: IChatRequestViewModel | undefined): void {\n\t\tif (this.editing && editing && this.editing.id === editing.id) {\n\t\t\treturn; // already editing this request\n\t\t}\n\n\t\tthis._editing = editing;\n\t}\n\n\toverride dispose() {\n\t\tsuper.dispose();\n\t\tdispose(this._items.filter((item): item is ChatResponseViewModel => item instanceof ChatResponseViewModel));\n\t}\n\n\tupdateCodeBlockTextModels(model: IChatRequestViewModel | IChatResponseViewModel) {\n\t\tlet content: string;\n\t\tif (isRequestVM(model)) {\n\t\t\tcontent = model.messageText;\n\t\t} else {\n\t\t\tcontent = annotateVulnerabilitiesInText(model.response.value).map(x => x.content.value).join('');\n\t\t}\n\n\t\tlet codeBlockIndex = 0;\n\t\tmarked.walkTokens(marked.lexer(content), token => {\n\t\t\tif (token.type === 'code') {\n\t\t\t\tconst lang = token.lang || '';\n\t\t\t\tconst text = token.text;\n\t\t\t\tthis.codeBlockModelCollection.update(this._model.sessionResource, model, codeBlockIndex++, { text, languageId: lang, isComplete: true });\n\t\t\t}\n\t\t});\n\t}\n}\n\nexport class ChatRequestViewModel implements IChatRequestViewModel {\n\tget id() {\n\t\treturn this._model.id;\n\t}\n\n\tget dataId() {\n\t\treturn this.id + `_${hash(this.variables)}_${hash(this.isComplete)}`;\n\t}\n\n\t/** @deprecated */\n\tget sessionId() {\n\t\treturn this._model.session.sessionId;\n\t}\n\n\tget sessionResource() {\n\t\treturn this._model.session.sessionResource;\n\t}\n\n\tget username() {\n\t\treturn 'User';\n\t}\n\n\tget avatarIcon(): ThemeIcon {\n\t\treturn Codicon.account;\n\t}\n\n\tget message() {\n\t\treturn this._model.message;\n\t}\n\n\tget messageText() {\n\t\treturn this.message.text;\n\t}\n\n\tget attempt() {\n\t\treturn this._model.attempt;\n\t}\n\n\tget variables() {\n\t\treturn this._model.variableData.variables;\n\t}\n\n\tget contentReferences() {\n\t\treturn this._model.response?.contentReferences;\n\t}\n\n\tget confirmation() {\n\t\treturn this._model.confirmation;\n\t}\n\n\tget isComplete() {\n\t\treturn this._model.response?.isComplete ?? false;\n\t}\n\n\tget isCompleteAddedRequest() {\n\t\treturn this._model.isCompleteAddedRequest;\n\t}\n\n\tget shouldBeRemovedOnSend() {\n\t\treturn this._model.shouldBeRemovedOnSend;\n\t}\n\n\tget shouldBeBlocked() {\n\t\treturn this._model.shouldBeBlocked;\n\t}\n\n\tget slashCommand(): IChatAgentCommand | undefined {\n\t\treturn this._model.response?.slashCommand;\n\t}\n\n\tget agentOrSlashCommandDetected(): boolean {\n\t\treturn this._model.response?.agentOrSlashCommandDetected ?? false;\n\t}\n\n\tcurrentRenderedHeight: number | undefined;\n\n\tget modelId() {\n\t\treturn this._model.modelId;\n\t}\n\n\tconstructor(\n\t\tprivate readonly _model: IChatRequestModel,\n\t) { }\n}\n\nexport class ChatResponseViewModel extends Disposable implements IChatResponseViewModel {\n\tprivate _modelChangeCount = 0;\n\n\tprivate readonly _onDidChange = this._register(new Emitter<void>());\n\treadonly onDidChange = this._onDidChange.event;\n\n\tget model() {\n\t\treturn this._model;\n\t}\n\n\tget id() {\n\t\treturn this._model.id;\n\t}\n\n\tget dataId() {\n\t\treturn this._model.id +\n\t\t\t`_${this._modelChangeCount}` +\n\t\t\t(this.isLast ? '_last' : '');\n\t}\n\n\t/** @deprecated */\n\tget sessionId() {\n\t\treturn this._model.session.sessionId;\n\t}\n\n\tget sessionResource(): URI {\n\t\treturn this._model.session.sessionResource;\n\t}\n\n\tget username() {\n\t\tif (this.agent) {\n\t\t\tconst isAllowed = this.chatAgentNameService.getAgentNameRestriction(this.agent);\n\t\t\tif (isAllowed) {\n\t\t\t\treturn this.agent.fullName || this.agent.name;\n\t\t\t} else {\n\t\t\t\treturn getFullyQualifiedId(this.agent);\n\t\t\t}\n\t\t}\n\n\t\treturn this._model.username;\n\t}\n\n\tget avatarIcon() {\n\t\treturn this._model.avatarIcon;\n\t}\n\n\tget agent() {\n\t\treturn this._model.agent;\n\t}\n\n\tget slashCommand() {\n\t\treturn this._model.slashCommand;\n\t}\n\n\tget agentOrSlashCommandDetected() {\n\t\treturn this._model.agentOrSlashCommandDetected;\n\t}\n\n\tget response(): IResponse {\n\t\treturn this._model.response;\n\t}\n\n\tget usedContext(): IChatUsedContext | undefined {\n\t\treturn this._model.usedContext;\n\t}\n\n\tget contentReferences(): ReadonlyArray<IChatContentReference> {\n\t\treturn this._model.contentReferences;\n\t}\n\n\tget codeCitations(): ReadonlyArray<IChatCodeCitation> {\n\t\treturn this._model.codeCitations;\n\t}\n\n\tget progressMessages(): ReadonlyArray<IChatProgressMessage> {\n\t\treturn this._model.progressMessages;\n\t}\n\n\tget isComplete() {\n\t\treturn this._model.isComplete;\n\t}\n\n\tget isCanceled() {\n\t\treturn this._model.isCanceled;\n\t}\n\n\tget shouldBeBlocked() {\n\t\treturn this._model.shouldBeBlocked;\n\t}\n\n\tget shouldBeRemovedOnSend() {\n\t\treturn this._model.shouldBeRemovedOnSend;\n\t}\n\n\tget isCompleteAddedRequest() {\n\t\treturn this._model.isCompleteAddedRequest;\n\t}\n\n\tget replyFollowups() {\n\t\treturn this._model.followups?.filter((f): f is IChatFollowup => f.kind === 'reply');\n\t}\n\n\tget result() {\n\t\treturn this._model.result;\n\t}\n\n\tget errorDetails(): IChatResponseErrorDetails | undefined {\n\t\treturn this.result?.errorDetails;\n\t}\n\n\tget vote() {\n\t\treturn this._model.vote;\n\t}\n\n\tget voteDownReason() {\n\t\treturn this._model.voteDownReason;\n\t}\n\n\tget requestId() {\n\t\treturn this._model.requestId;\n\t}\n\n\tget isStale() {\n\t\treturn this._model.isStale;\n\t}\n\n\tget isLast(): boolean {\n\t\treturn this.session.getItems().at(-1) === this;\n\t}\n\n\trenderData: IChatResponseRenderData | undefined = undefined;\n\tcurrentRenderedHeight: number | undefined;\n\n\tprivate _usedReferencesExpanded: boolean | undefined;\n\tget usedReferencesExpanded(): boolean | undefined {\n\t\tif (typeof this._usedReferencesExpanded === 'boolean') {\n\t\t\treturn this._usedReferencesExpanded;\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tset usedReferencesExpanded(v: boolean) {\n\t\tthis._usedReferencesExpanded = v;\n\t}\n\n\tprivate _vulnerabilitiesListExpanded: boolean = false;\n\tget vulnerabilitiesListExpanded(): boolean {\n\t\treturn this._vulnerabilitiesListExpanded;\n\t}\n\n\tset vulnerabilitiesListExpanded(v: boolean) {\n\t\tthis._vulnerabilitiesListExpanded = v;\n\t}\n\n\tprivate _contentUpdateTimings: IChatLiveUpdateData | undefined = undefined;\n\tget contentUpdateTimings(): IChatLiveUpdateData | undefined {\n\t\treturn this._contentUpdateTimings;\n\t}\n\n\n\tconstructor(\n\t\tprivate readonly _model: IChatResponseModel,\n\t\tpublic readonly session: IChatViewModel,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IChatAgentNameService private readonly chatAgentNameService: IChatAgentNameService,\n\t) {\n\t\tsuper();\n\n\t\tif (!_model.isComplete) {\n\t\t\tthis._contentUpdateTimings = {\n\t\t\t\ttotalTime: 0,\n\t\t\t\tlastUpdateTime: Date.now(),\n\t\t\t\timpliedWordLoadRate: 0,\n\t\t\t\tlastWordCount: 0,\n\t\t\t};\n\t\t}\n\n\t\tthis._register(_model.onDidChange(() => {\n\t\t\t// This is set when the response is loading, but the model can change later for other reasons\n\t\t\tif (this._contentUpdateTimings) {\n\t\t\t\tconst now = Date.now();\n\t\t\t\tconst wordCount = countWords(_model.entireResponse.getMarkdown());\n\n\t\t\t\tif (wordCount === this._contentUpdateTimings.lastWordCount) {\n\t\t\t\t\tthis.trace('onDidChange', `Update- no new words`);\n\t\t\t\t} else {\n\t\t\t\t\tif (this._contentUpdateTimings.lastWordCount === 0) {\n\t\t\t\t\t\tthis._contentUpdateTimings.lastUpdateTime = now;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst timeDiff = Math.min(now - this._contentUpdateTimings.lastUpdateTime, 500);\n\t\t\t\t\tconst newTotalTime = Math.max(this._contentUpdateTimings.totalTime + timeDiff, 250);\n\t\t\t\t\tconst impliedWordLoadRate = wordCount / (newTotalTime / 1000);\n\t\t\t\t\tthis.trace('onDidChange', `Update- got ${wordCount} words over last ${newTotalTime}ms = ${impliedWordLoadRate} words/s`);\n\t\t\t\t\tthis._contentUpdateTimings = {\n\t\t\t\t\t\ttotalTime: this._contentUpdateTimings.totalTime !== 0 || this.response.value.some(v => v.kind === 'markdownContent') ?\n\t\t\t\t\t\t\tnewTotalTime :\n\t\t\t\t\t\t\tthis._contentUpdateTimings.totalTime,\n\t\t\t\t\t\tlastUpdateTime: now,\n\t\t\t\t\t\timpliedWordLoadRate,\n\t\t\t\t\t\tlastWordCount: wordCount\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// new data -> new id, new content to render\n\t\t\tthis._modelChangeCount++;\n\n\t\t\tthis._onDidChange.fire();\n\t\t}));\n\t}\n\n\tprivate trace(tag: string, message: string) {\n\t\tthis.logService.trace(`ChatResponseViewModel#${tag}: ${message}`);\n\t}\n\n\tsetVote(vote: ChatAgentVoteDirection): void {\n\t\tthis._modelChangeCount++;\n\t\tthis._model.setVote(vote);\n\t}\n\n\tsetVoteDownReason(reason: ChatAgentVoteDownReason | undefined): void {\n\t\tthis._modelChangeCount++;\n\t\tthis._model.setVoteDownReason(reason);\n\t}\n\n\tsetEditApplied(edit: IChatTextEditGroup, editCount: number) {\n\t\tthis._modelChangeCount++;\n\t\tthis._model.setEditApplied(edit, editCount);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { hash } from '../../../../base/common/hash.js';\nimport { IMarkdownString } from '../../../../base/common/htmlContent.js';\nimport { Disposable, dispose } from '../../../../base/common/lifecycle.js';\nimport * as marked from '../../../../base/common/marked/marked.js';\nimport { ThemeIcon } from '../../../../base/common/themables.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { annotateVulnerabilitiesInText } from './annotations.js';\nimport { getFullyQualifiedId, IChatAgentCommand, IChatAgentData, IChatAgentNameService, IChatAgentResult } from './chatAgents.js';\nimport { IChatModel, IChatProgressRenderableResponseContent, IChatRequestDisablement, IChatRequestModel, IChatResponseModel, IChatTextEditGroup, IResponse } from './chatModel.js';\nimport { IChatRequestVariableEntry } from './chatVariableEntries.js';\nimport { IParsedChatRequest } from './chatParserTypes.js';\nimport { ChatAgentVoteDirection, ChatAgentVoteDownReason, IChatChangesSummary, IChatCodeCitation, IChatContentReference, IChatFollowup, IChatMcpServersStarting, IChatProgressMessage, IChatResponseErrorDetails, IChatTask, IChatUsedContext } from './chatService.js';\nimport { countWords } from './chatWordCounter.js';\nimport { CodeBlockModelCollection } from './codeBlockModelCollection.js';\nimport { Codicon } from '../../../../base/common/codicons.js';\n\nexport function isRequestVM(item: unknown): item is IChatRequestViewModel {\n\treturn !!item && typeof item === 'object' && 'message' in item;\n}\n\nexport function isResponseVM(item: unknown): item is IChatResponseViewModel {\n\treturn !!item && typeof (item as IChatResponseViewModel).setVote !== 'undefined';\n}\n\nexport function isChatTreeItem(item: unknown): item is IChatRequestViewModel | IChatResponseViewModel {\n\treturn isRequestVM(item) || isResponseVM(item);\n}\n\nexport function assertIsResponseVM(item: unknown): asserts item is IChatResponseViewModel {\n\tif (!isResponseVM(item)) {\n\t\tthrow new Error('Expected item to be IChatResponseViewModel');\n\t}\n}\n\nexport type IChatViewModelChangeEvent = IChatAddRequestEvent | IChangePlaceholderEvent | IChatSessionInitEvent | IChatSetHiddenEvent | IChatSetCheckpointEvent | null;\n\nexport interface IChatAddRequestEvent {\n\tkind: 'addRequest';\n}\n\nexport interface IChangePlaceholderEvent {\n\tkind: 'changePlaceholder';\n}\n\nexport interface IChatSessionInitEvent {\n\tkind: 'initialize';\n}\n\nexport interface IChatSetHiddenEvent {\n\tkind: 'setHidden';\n}\n\nexport interface IChatSetCheckpointEvent {\n\tkind: 'setCheckpoint';\n}\n\nexport interface IChatViewModel {\n\treadonly model: IChatModel;\n\treadonly sessionResource: URI;\n\treadonly onDidDisposeModel: Event<void>;\n\treadonly onDidChange: Event<IChatViewModelChangeEvent>;\n\treadonly inputPlaceholder?: string;\n\tgetItems(): (IChatRequestViewModel | IChatResponseViewModel)[];\n\tsetInputPlaceholder(text: string): void;\n\tresetInputPlaceholder(): void;\n\tediting?: IChatRequestViewModel;\n\tsetEditing(editing: IChatRequestViewModel): void;\n}\n\nexport interface IChatRequestViewModel {\n\treadonly id: string;\n\t/** @deprecated */\n\treadonly sessionId: string;\n\treadonly sessionResource: URI;\n\t/** This ID updates every time the underlying data changes */\n\treadonly dataId: string;\n\treadonly username: string;\n\treadonly avatarIcon?: URI | ThemeIcon;\n\treadonly message: IParsedChatRequest | IChatFollowup;\n\treadonly messageText: string;\n\treadonly attempt: number;\n\treadonly variables: IChatRequestVariableEntry[];\n\tcurrentRenderedHeight: number | undefined;\n\treadonly contentReferences?: ReadonlyArray<IChatContentReference>;\n\treadonly confirmation?: string;\n\treadonly shouldBeRemovedOnSend: IChatRequestDisablement | undefined;\n\treadonly isComplete: boolean;\n\treadonly isCompleteAddedRequest: boolean;\n\treadonly slashCommand: IChatAgentCommand | undefined;\n\treadonly agentOrSlashCommandDetected: boolean;\n\treadonly shouldBeBlocked?: boolean;\n\treadonly modelId?: string;\n}\n\nexport interface IChatResponseMarkdownRenderData {\n\trenderedWordCount: number;\n\tlastRenderTime: number;\n\tisFullyRendered: boolean;\n\toriginalMarkdown: IMarkdownString;\n}\n\nexport interface IChatResponseMarkdownRenderData2 {\n\trenderedWordCount: number;\n\tlastRenderTime: number;\n\tisFullyRendered: boolean;\n\toriginalMarkdown: IMarkdownString;\n}\n\nexport interface IChatProgressMessageRenderData {\n\tprogressMessage: IChatProgressMessage;\n\n\t/**\n\t * Indicates whether this is part of a group of progress messages that are at the end of the response.\n\t * (Not whether this particular item is the very last one in the response).\n\t * Need to re-render and add to partsToRender when this changes.\n\t */\n\tisAtEndOfResponse: boolean;\n\n\t/**\n\t * Whether this progress message the very last item in the response.\n\t * Need to re-render to update spinner vs check when this changes.\n\t */\n\tisLast: boolean;\n}\n\nexport interface IChatTaskRenderData {\n\ttask: IChatTask;\n\tisSettled: boolean;\n\tprogressLength: number;\n}\n\nexport interface IChatResponseRenderData {\n\trenderedParts: IChatRendererContent[];\n\n\trenderedWordCount: number;\n\tlastRenderTime: number;\n}\n\n/**\n * Content type for references used during rendering, not in the model\n */\nexport interface IChatReferences {\n\treferences: ReadonlyArray<IChatContentReference>;\n\tkind: 'references';\n}\n\n/**\n * Content type for the \"Working\" progress message\n */\nexport interface IChatWorkingProgress {\n\tkind: 'working';\n}\n\n\n/**\n * Content type for citations used during rendering, not in the model\n */\nexport interface IChatCodeCitations {\n\tcitations: ReadonlyArray<IChatCodeCitation>;\n\tkind: 'codeCitations';\n}\n\nexport interface IChatErrorDetailsPart {\n\tkind: 'errorDetails';\n\terrorDetails: IChatResponseErrorDetails;\n\tisLast: boolean;\n}\n\nexport interface IChatChangesSummaryPart {\n\treadonly kind: 'changesSummary';\n\treadonly fileChanges: ReadonlyArray<IChatChangesSummary>;\n}\n\n/**\n * Type for content parts rendered by IChatListRenderer (not necessarily in the model)\n */\nexport type IChatRendererContent = IChatProgressRenderableResponseContent | IChatReferences | IChatCodeCitations | IChatErrorDetailsPart | IChatChangesSummaryPart | IChatWorkingProgress | IChatMcpServersStarting;\n\nexport interface IChatLiveUpdateData {\n\ttotalTime: number;\n\tlastUpdateTime: number;\n\timpliedWordLoadRate: number;\n\tlastWordCount: number;\n}\n\nexport interface IChatResponseViewModel {\n\treadonly model: IChatResponseModel;\n\treadonly id: string;\n\treadonly session: IChatViewModel;\n\t/** @deprecated */\n\treadonly sessionId: string;\n\treadonly sessionResource: URI;\n\t/** This ID updates every time the underlying data changes */\n\treadonly dataId: string;\n\t/** The ID of the associated IChatRequestViewModel */\n\treadonly requestId: string;\n\treadonly username: string;\n\treadonly avatarIcon?: URI | ThemeIcon;\n\treadonly agent?: IChatAgentData;\n\treadonly slashCommand?: IChatAgentCommand;\n\treadonly agentOrSlashCommandDetected: boolean;\n\treadonly response: IResponse;\n\treadonly usedContext: IChatUsedContext | undefined;\n\treadonly contentReferences: ReadonlyArray<IChatContentReference>;\n\treadonly codeCitations: ReadonlyArray<IChatCodeCitation>;\n\treadonly progressMessages: ReadonlyArray<IChatProgressMessage>;\n\treadonly isComplete: boolean;\n\treadonly isCanceled: boolean;\n\treadonly isStale: boolean;\n\treadonly vote: ChatAgentVoteDirection | undefined;\n\treadonly voteDownReason: ChatAgentVoteDownReason | undefined;\n\treadonly replyFollowups?: IChatFollowup[];\n\treadonly errorDetails?: IChatResponseErrorDetails;\n\treadonly result?: IChatAgentResult;\n\treadonly contentUpdateTimings?: IChatLiveUpdateData;\n\treadonly shouldBeRemovedOnSend: IChatRequestDisablement | undefined;\n\treadonly isCompleteAddedRequest: boolean;\n\trenderData?: IChatResponseRenderData;\n\tcurrentRenderedHeight: number | undefined;\n\tsetVote(vote: ChatAgentVoteDirection): void;\n\tsetVoteDownReason(reason: ChatAgentVoteDownReason | undefined): void;\n\tusedReferencesExpanded?: boolean;\n\tvulnerabilitiesListExpanded: boolean;\n\tsetEditApplied(edit: IChatTextEditGroup, editCount: number): void;\n\treadonly shouldBeBlocked: boolean;\n}\n\nexport class ChatViewModel extends Disposable implements IChatViewModel {\n\n\tprivate readonly _onDidDisposeModel = this._register(new Emitter<void>());\n\treadonly onDidDisposeModel = this._onDidDisposeModel.event;\n\n\tprivate readonly _onDidChange = this._register(new Emitter<IChatViewModelChangeEvent>());\n\treadonly onDidChange = this._onDidChange.event;\n\n\tprivate readonly _items: (ChatRequestViewModel | ChatResponseViewModel)[] = [];\n\n\tprivate _inputPlaceholder: string | undefined = undefined;\n\tget inputPlaceholder(): string | undefined {\n\t\treturn this._inputPlaceholder;\n\t}\n\n\tget model(): IChatModel {\n\t\treturn this._model;\n\t}\n\n\tsetInputPlaceholder(text: string): void {\n\t\tthis._inputPlaceholder = text;\n\t\tthis._onDidChange.fire({ kind: 'changePlaceholder' });\n\t}\n\n\tresetInputPlaceholder(): void {\n\t\tthis._inputPlaceholder = undefined;\n\t\tthis._onDidChange.fire({ kind: 'changePlaceholder' });\n\t}\n\n\tget sessionResource(): URI {\n\t\treturn this._model.sessionResource;\n\t}\n\n\tconstructor(\n\t\tprivate readonly _model: IChatModel,\n\t\tpublic readonly codeBlockModelCollection: CodeBlockModelCollection,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\t_model.getRequests().forEach((request, i) => {\n\t\t\tconst requestModel = this.instantiationService.createInstance(ChatRequestViewModel, request);\n\t\t\tthis._items.push(requestModel);\n\t\t\tthis.updateCodeBlockTextModels(requestModel);\n\n\t\t\tif (request.response) {\n\t\t\t\tthis.onAddResponse(request.response);\n\t\t\t}\n\t\t});\n\n\t\tthis._register(_model.onDidDispose(() => this._onDidDisposeModel.fire()));\n\t\tthis._register(_model.onDidChange(e => {\n\t\t\tif (e.kind === 'addRequest') {\n\t\t\t\tconst requestModel = this.instantiationService.createInstance(ChatRequestViewModel, e.request);\n\t\t\t\tthis._items.push(requestModel);\n\t\t\t\tthis.updateCodeBlockTextModels(requestModel);\n\n\t\t\t\tif (e.request.response) {\n\t\t\t\t\tthis.onAddResponse(e.request.response);\n\t\t\t\t}\n\t\t\t} else if (e.kind === 'addResponse') {\n\t\t\t\tthis.onAddResponse(e.response);\n\t\t\t} else if (e.kind === 'removeRequest') {\n\t\t\t\tconst requestIdx = this._items.findIndex(item => isRequestVM(item) && item.id === e.requestId);\n\t\t\t\tif (requestIdx >= 0) {\n\t\t\t\t\tthis._items.splice(requestIdx, 1);\n\t\t\t\t}\n\n\t\t\t\tconst responseIdx = e.responseId && this._items.findIndex(item => isResponseVM(item) && item.id === e.responseId);\n\t\t\t\tif (typeof responseIdx === 'number' && responseIdx >= 0) {\n\t\t\t\t\tconst items = this._items.splice(responseIdx, 1);\n\t\t\t\t\tconst item = items[0];\n\t\t\t\t\tif (item instanceof ChatResponseViewModel) {\n\t\t\t\t\t\titem.dispose();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst modelEventToVmEvent: IChatViewModelChangeEvent =\n\t\t\t\te.kind === 'addRequest' ? { kind: 'addRequest' }\n\t\t\t\t\t: e.kind === 'initialize' ? { kind: 'initialize' }\n\t\t\t\t\t\t: e.kind === 'setHidden' ? { kind: 'setHidden' }\n\t\t\t\t\t\t\t: null;\n\t\t\tthis._onDidChange.fire(modelEventToVmEvent);\n\t\t}));\n\t}\n\n\tprivate onAddResponse(responseModel: IChatResponseModel) {\n\t\tconst response = this.instantiationService.createInstance(ChatResponseViewModel, responseModel, this);\n\t\tthis._register(response.onDidChange(() => {\n\t\t\tif (response.isComplete) {\n\t\t\t\tthis.updateCodeBlockTextModels(response);\n\t\t\t}\n\t\t\treturn this._onDidChange.fire(null);\n\t\t}));\n\t\tthis._items.push(response);\n\t\tthis.updateCodeBlockTextModels(response);\n\t}\n\n\tgetItems(): (IChatRequestViewModel | IChatResponseViewModel)[] {\n\t\treturn this._items.filter((item) => !item.shouldBeRemovedOnSend || item.shouldBeRemovedOnSend.afterUndoStop);\n\t}\n\n\n\tprivate _editing: IChatRequestViewModel | undefined = undefined;\n\tget editing(): IChatRequestViewModel | undefined {\n\t\treturn this._editing;\n\t}\n\n\tsetEditing(editing: IChatRequestViewModel | undefined): void {\n\t\tif (this.editing && editing && this.editing.id === editing.id) {\n\t\t\treturn; // already editing this request\n\t\t}\n\n\t\tthis._editing = editing;\n\t}\n\n\toverride dispose() {\n\t\tsuper.dispose();\n\t\tdispose(this._items.filter((item): item is ChatResponseViewModel => item instanceof ChatResponseViewModel));\n\t}\n\n\tupdateCodeBlockTextModels(model: IChatRequestViewModel | IChatResponseViewModel) {\n\t\tlet content: string;\n\t\tif (isRequestVM(model)) {\n\t\t\tcontent = model.messageText;\n\t\t} else {\n\t\t\tcontent = annotateVulnerabilitiesInText(model.response.value).map(x => x.content.value).join('');\n\t\t}\n\n\t\tlet codeBlockIndex = 0;\n\t\tmarked.walkTokens(marked.lexer(content), token => {\n\t\t\tif (token.type === 'code') {\n\t\t\t\tconst lang = token.lang || '';\n\t\t\t\tconst text = token.text;\n\t\t\t\tthis.codeBlockModelCollection.update(this._model.sessionResource, model, codeBlockIndex++, { text, languageId: lang, isComplete: true });\n\t\t\t}\n\t\t});\n\t}\n}\n\nexport class ChatRequestViewModel implements IChatRequestViewModel {\n\tget id() {\n\t\treturn this._model.id;\n\t}\n\n\tget dataId() {\n\t\treturn this.id + `_${hash(this.variables)}_${hash(this.isComplete)}`;\n\t}\n\n\t/** @deprecated */\n\tget sessionId() {\n\t\treturn this._model.session.sessionId;\n\t}\n\n\tget sessionResource() {\n\t\treturn this._model.session.sessionResource;\n\t}\n\n\tget username() {\n\t\treturn 'User';\n\t}\n\n\tget avatarIcon(): ThemeIcon {\n\t\treturn Codicon.account;\n\t}\n\n\tget message() {\n\t\treturn this._model.message;\n\t}\n\n\tget messageText() {\n\t\treturn this.message.text;\n\t}\n\n\tget attempt() {\n\t\treturn this._model.attempt;\n\t}\n\n\tget variables() {\n\t\treturn this._model.variableData.variables;\n\t}\n\n\tget contentReferences() {\n\t\treturn this._model.response?.contentReferences;\n\t}\n\n\tget confirmation() {\n\t\treturn this._model.confirmation;\n\t}\n\n\tget isComplete() {\n\t\treturn this._model.response?.isComplete ?? false;\n\t}\n\n\tget isCompleteAddedRequest() {\n\t\treturn this._model.isCompleteAddedRequest;\n\t}\n\n\tget shouldBeRemovedOnSend() {\n\t\treturn this._model.shouldBeRemovedOnSend;\n\t}\n\n\tget shouldBeBlocked() {\n\t\treturn this._model.shouldBeBlocked;\n\t}\n\n\tget slashCommand(): IChatAgentCommand | undefined {\n\t\treturn this._model.response?.slashCommand;\n\t}\n\n\tget agentOrSlashCommandDetected(): boolean {\n\t\treturn this._model.response?.agentOrSlashCommandDetected ?? false;\n\t}\n\n\tcurrentRenderedHeight: number | undefined;\n\n\tget modelId() {\n\t\treturn this._model.modelId;\n\t}\n\n\tconstructor(\n\t\tprivate readonly _model: IChatRequestModel,\n\t) { }\n}\n\nexport class ChatResponseViewModel extends Disposable implements IChatResponseViewModel {\n\tprivate _modelChangeCount = 0;\n\n\tprivate readonly _onDidChange = this._register(new Emitter<void>());\n\treadonly onDidChange = this._onDidChange.event;\n\n\tget model() {\n\t\treturn this._model;\n\t}\n\n\tget id() {\n\t\treturn this._model.id;\n\t}\n\n\tget dataId() {\n\t\treturn this._model.id +\n\t\t\t`_${this._modelChangeCount}` +\n\t\t\t(this.isLast ? '_last' : '');\n\t}\n\n\t/** @deprecated */\n\tget sessionId() {\n\t\treturn this._model.session.sessionId;\n\t}\n\n\tget sessionResource(): URI {\n\t\treturn this._model.session.sessionResource;\n\t}\n\n\tget username() {\n\t\tif (this.agent) {\n\t\t\tconst isAllowed = this.chatAgentNameService.getAgentNameRestriction(this.agent);\n\t\t\tif (isAllowed) {\n\t\t\t\treturn this.agent.fullName || this.agent.name;\n\t\t\t} else {\n\t\t\t\treturn getFullyQualifiedId(this.agent);\n\t\t\t}\n\t\t}\n\n\t\treturn this._model.username;\n\t}\n\n\tget avatarIcon() {\n\t\treturn this._model.avatarIcon;\n\t}\n\n\tget agent() {\n\t\treturn this._model.agent;\n\t}\n\n\tget slashCommand() {\n\t\treturn this._model.slashCommand;\n\t}\n\n\tget agentOrSlashCommandDetected() {\n\t\treturn this._model.agentOrSlashCommandDetected;\n\t}\n\n\tget response(): IResponse {\n\t\treturn this._model.response;\n\t}\n\n\tget usedContext(): IChatUsedContext | undefined {\n\t\treturn this._model.usedContext;\n\t}\n\n\tget contentReferences(): ReadonlyArray<IChatContentReference> {\n\t\treturn this._model.contentReferences;\n\t}\n\n\tget codeCitations(): ReadonlyArray<IChatCodeCitation> {\n\t\treturn this._model.codeCitations;\n\t}\n\n\tget progressMessages(): ReadonlyArray<IChatProgressMessage> {\n\t\treturn this._model.progressMessages;\n\t}\n\n\tget isComplete() {\n\t\treturn this._model.isComplete;\n\t}\n\n\tget isCanceled() {\n\t\treturn this._model.isCanceled;\n\t}\n\n\tget shouldBeBlocked() {\n\t\treturn this._model.shouldBeBlocked;\n\t}\n\n\tget shouldBeRemovedOnSend() {\n\t\treturn this._model.shouldBeRemovedOnSend;\n\t}\n\n\tget isCompleteAddedRequest() {\n\t\treturn this._model.isCompleteAddedRequest;\n\t}\n\n\tget replyFollowups() {\n\t\treturn this._model.followups?.filter((f): f is IChatFollowup => f.kind === 'reply');\n\t}\n\n\tget result() {\n\t\treturn this._model.result;\n\t}\n\n\tget errorDetails(): IChatResponseErrorDetails | undefined {\n\t\treturn this.result?.errorDetails;\n\t}\n\n\tget vote() {\n\t\treturn this._model.vote;\n\t}\n\n\tget voteDownReason() {\n\t\treturn this._model.voteDownReason;\n\t}\n\n\tget requestId() {\n\t\treturn this._model.requestId;\n\t}\n\n\tget isStale() {\n\t\treturn this._model.isStale;\n\t}\n\n\tget isLast(): boolean {\n\t\treturn this.session.getItems().at(-1) === this;\n\t}\n\n\trenderData: IChatResponseRenderData | undefined = undefined;\n\tcurrentRenderedHeight: number | undefined;\n\n\tprivate _usedReferencesExpanded: boolean | undefined;\n\tget usedReferencesExpanded(): boolean | undefined {\n\t\tif (typeof this._usedReferencesExpanded === 'boolean') {\n\t\t\treturn this._usedReferencesExpanded;\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tset usedReferencesExpanded(v: boolean) {\n\t\tthis._usedReferencesExpanded = v;\n\t}\n\n\tprivate _vulnerabilitiesListExpanded: boolean = false;\n\tget vulnerabilitiesListExpanded(): boolean {\n\t\treturn this._vulnerabilitiesListExpanded;\n\t}\n\n\tset vulnerabilitiesListExpanded(v: boolean) {\n\t\tthis._vulnerabilitiesListExpanded = v;\n\t}\n\n\tprivate _contentUpdateTimings: IChatLiveUpdateData | undefined = undefined;\n\tget contentUpdateTimings(): IChatLiveUpdateData | undefined {\n\t\treturn this._contentUpdateTimings;\n\t}\n\n\n\tconstructor(\n\t\tprivate readonly _model: IChatResponseModel,\n\t\tpublic readonly session: IChatViewModel,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IChatAgentNameService private readonly chatAgentNameService: IChatAgentNameService,\n\t) {\n\t\tsuper();\n\n\t\tif (!_model.isComplete) {\n\t\t\tthis._contentUpdateTimings = {\n\t\t\t\ttotalTime: 0,\n\t\t\t\tlastUpdateTime: Date.now(),\n\t\t\t\timpliedWordLoadRate: 0,\n\t\t\t\tlastWordCount: 0,\n\t\t\t};\n\t\t}\n\n\t\tthis._register(_model.onDidChange(() => {\n\t\t\t// This is set when the response is loading, but the model can change later for other reasons\n\t\t\tif (this._contentUpdateTimings) {\n\t\t\t\tconst now = Date.now();\n\t\t\t\tconst wordCount = countWords(_model.entireResponse.getMarkdown());\n\n\t\t\t\tif (wordCount === this._contentUpdateTimings.lastWordCount) {\n\t\t\t\t\tthis.trace('onDidChange', `Update- no new words`);\n\t\t\t\t} else {\n\t\t\t\t\tif (this._contentUpdateTimings.lastWordCount === 0) {\n\t\t\t\t\t\tthis._contentUpdateTimings.lastUpdateTime = now;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst timeDiff = Math.min(now - this._contentUpdateTimings.lastUpdateTime, 500);\n\t\t\t\t\tconst newTotalTime = Math.max(this._contentUpdateTimings.totalTime + timeDiff, 250);\n\t\t\t\t\tconst impliedWordLoadRate = wordCount / (newTotalTime / 1000);\n\t\t\t\t\tthis.trace('onDidChange', `Update- got ${wordCount} words over last ${newTotalTime}ms = ${impliedWordLoadRate} words/s`);\n\t\t\t\t\tthis._contentUpdateTimings = {\n\t\t\t\t\t\ttotalTime: this._contentUpdateTimings.totalTime !== 0 || this.response.value.some(v => v.kind === 'markdownContent') ?\n\t\t\t\t\t\t\tnewTotalTime :\n\t\t\t\t\t\t\tthis._contentUpdateTimings.totalTime,\n\t\t\t\t\t\tlastUpdateTime: now,\n\t\t\t\t\t\timpliedWordLoadRate,\n\t\t\t\t\t\tlastWordCount: wordCount\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// new data -> new id, new content to render\n\t\t\tthis._modelChangeCount++;\n\n\t\t\tthis._onDidChange.fire();\n\t\t}));\n\t}\n\n\tprivate trace(tag: string, message: string) {\n\t\tthis.logService.trace(`ChatResponseViewModel#${tag}: ${message}`);\n\t}\n\n\tsetVote(vote: ChatAgentVoteDirection): void {\n\t\tthis._modelChangeCount++;\n\t\tthis._model.setVote(vote);\n\t}\n\n\tsetVoteDownReason(reason: ChatAgentVoteDownReason | undefined): void {\n\t\tthis._modelChangeCount++;\n\t\tthis._model.setVoteDownReason(reason);\n\t}\n\n\tsetEditApplied(edit: IChatTextEditGroup, editCount: number) {\n\t\tthis._modelChangeCount++;\n\t\tthis._model.setEditApplied(edit, editCount);\n\t}\n}\n"]}