{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/common/codeBlockModelCollection.ts","vs/workbench/contrib/chat/common/codeBlockModelCollection.ts"],"names":[],"mappings":"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","file":"codeBlockModelCollection.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { encodeBase64, VSBuffer } from '../../../../base/common/buffer.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { Disposable, IReference } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { Range } from '../../../../editor/common/core/range.js';\nimport { ILanguageService } from '../../../../editor/common/languages/language.js';\nimport { PLAINTEXT_LANGUAGE_ID } from '../../../../editor/common/languages/modesRegistry.js';\nimport { EndOfLinePreference, ITextModel } from '../../../../editor/common/model.js';\nimport { IResolvedTextEditorModel, ITextModelService } from '../../../../editor/common/services/resolverService.js';\nimport { extractCodeblockUrisFromText, extractVulnerabilitiesFromText, IMarkdownVulnerability } from './annotations.js';\nimport { IChatRequestViewModel, IChatResponseViewModel, isResponseVM } from './chatViewModel.js';\n\n\ninterface CodeBlockContent {\n\treadonly text: string;\n\treadonly languageId?: string;\n\treadonly isComplete: boolean;\n}\n\nexport interface CodeBlockEntry {\n\treadonly model: Promise<ITextModel>;\n\treadonly vulns: readonly IMarkdownVulnerability[];\n\treadonly codemapperUri?: URI;\n\treadonly isEdit?: boolean;\n}\n\nexport class CodeBlockModelCollection extends Disposable {\n\n\tprivate readonly _models = new Map<string, {\n\t\tmodel: Promise<IReference<IResolvedTextEditorModel>>;\n\t\tvulns: readonly IMarkdownVulnerability[];\n\t\tinLanguageId: string | undefined;\n\t\tcodemapperUri?: URI;\n\t\tisEdit?: boolean;\n\t}>();\n\n\t/**\n\t * Max number of models to keep in memory.\n\t *\n\t * Currently always maintains the most recently created models.\n\t */\n\tprivate readonly maxModelCount = 100;\n\n\tconstructor(\n\t\tprivate readonly tag: string | undefined,\n\t\t@ILanguageService private readonly languageService: ILanguageService,\n\t\t@ITextModelService private readonly textModelService: ITextModelService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(this.languageService.onDidChange(async () => {\n\t\t\tfor (const entry of this._models.values()) {\n\t\t\t\tif (!entry.inLanguageId) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst model = (await entry.model).object;\n\t\t\t\tconst existingLanguageId = model.getLanguageId();\n\t\t\t\tif (!existingLanguageId || existingLanguageId === PLAINTEXT_LANGUAGE_ID) {\n\t\t\t\t\tthis.trySetTextModelLanguage(entry.inLanguageId, model.textEditorModel);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tpublic override dispose(): void {\n\t\tsuper.dispose();\n\t\tthis.clear();\n\t}\n\n\tget(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number): CodeBlockEntry | undefined {\n\t\tconst entry = this._models.get(this.getKey(sessionResource, chat, codeBlockIndex));\n\t\tif (!entry) {\n\t\t\treturn;\n\t\t}\n\t\treturn {\n\t\t\tmodel: entry.model.then(ref => ref.object.textEditorModel),\n\t\t\tvulns: entry.vulns,\n\t\t\tcodemapperUri: entry.codemapperUri,\n\t\t\tisEdit: entry.isEdit,\n\t\t};\n\t}\n\n\tgetOrCreate(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number): CodeBlockEntry {\n\t\tconst existing = this.get(sessionResource, chat, codeBlockIndex);\n\t\tif (existing) {\n\t\t\treturn existing;\n\t\t}\n\n\t\tconst uri = this.getCodeBlockUri(sessionResource, chat, codeBlockIndex);\n\t\tconst model = this.textModelService.createModelReference(uri);\n\t\tthis._models.set(this.getKey(sessionResource, chat, codeBlockIndex), {\n\t\t\tmodel: model,\n\t\t\tvulns: [],\n\t\t\tinLanguageId: undefined,\n\t\t\tcodemapperUri: undefined,\n\t\t});\n\n\t\twhile (this._models.size > this.maxModelCount) {\n\t\t\tconst first = Iterable.first(this._models.keys());\n\t\t\tif (!first) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tthis.delete(first);\n\t\t}\n\n\t\treturn { model: model.then(x => x.object.textEditorModel), vulns: [], codemapperUri: undefined };\n\t}\n\n\tprivate delete(key: string) {\n\t\tconst entry = this._models.get(key);\n\t\tif (!entry) {\n\t\t\treturn;\n\t\t}\n\n\t\tentry.model.then(ref => ref.dispose());\n\t\tthis._models.delete(key);\n\t}\n\n\tclear(): void {\n\t\tthis._models.forEach(async entry => await entry.model.then(ref => ref.dispose()));\n\t\tthis._models.clear();\n\t}\n\n\tupdateSync(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number, content: CodeBlockContent): CodeBlockEntry {\n\t\tconst entry = this.getOrCreate(sessionResource, chat, codeBlockIndex);\n\n\t\tthis.updateInternalCodeBlockEntry(content, sessionResource, chat, codeBlockIndex);\n\n\t\treturn this.get(sessionResource, chat, codeBlockIndex) ?? entry;\n\t}\n\n\tmarkCodeBlockCompleted(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number): void {\n\t\tconst entry = this._models.get(this.getKey(sessionResource, chat, codeBlockIndex));\n\t\tif (!entry) {\n\t\t\treturn;\n\t\t}\n\t\t// TODO: fill this in once we've implemented https://github.com/microsoft/vscode/issues/232538\n\t}\n\n\tasync update(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number, content: CodeBlockContent): Promise<CodeBlockEntry> {\n\t\tconst entry = this.getOrCreate(sessionResource, chat, codeBlockIndex);\n\n\t\tconst newText = this.updateInternalCodeBlockEntry(content, sessionResource, chat, codeBlockIndex);\n\n\t\tconst textModel = await entry.model;\n\t\tif (!textModel || textModel.isDisposed()) {\n\t\t\t// Somehow we get an undefined textModel sometimes - #237782\n\t\t\treturn entry;\n\t\t}\n\n\t\tif (content.languageId) {\n\t\t\tthis.trySetTextModelLanguage(content.languageId, textModel);\n\t\t}\n\n\t\tconst currentText = textModel.getValue(EndOfLinePreference.LF);\n\t\tif (newText === currentText) {\n\t\t\treturn entry;\n\t\t}\n\n\t\tif (newText.startsWith(currentText)) {\n\t\t\tconst text = newText.slice(currentText.length);\n\t\t\tconst lastLine = textModel.getLineCount();\n\t\t\tconst lastCol = textModel.getLineMaxColumn(lastLine);\n\t\t\ttextModel.applyEdits([{ range: new Range(lastLine, lastCol, lastLine, lastCol), text }]);\n\t\t} else {\n\t\t\t// console.log(`Failed to optimize setText`);\n\t\t\ttextModel.setValue(newText);\n\t\t}\n\n\t\treturn entry;\n\t}\n\n\tprivate updateInternalCodeBlockEntry(content: CodeBlockContent, sessionResource: URI, chat: IChatResponseViewModel | IChatRequestViewModel, codeBlockIndex: number) {\n\t\tconst entry = this._models.get(this.getKey(sessionResource, chat, codeBlockIndex));\n\t\tif (entry) {\n\t\t\tentry.inLanguageId = content.languageId;\n\t\t}\n\n\t\tconst extractedVulns = extractVulnerabilitiesFromText(content.text);\n\t\tlet newText = fixCodeText(extractedVulns.newText, content.languageId);\n\t\tif (entry) {\n\t\t\tentry.vulns = extractedVulns.vulnerabilities;\n\t\t}\n\n\t\tconst codeblockUri = extractCodeblockUrisFromText(newText);\n\t\tif (codeblockUri) {\n\t\t\tif (entry) {\n\t\t\t\tentry.codemapperUri = codeblockUri.uri;\n\t\t\t\tentry.isEdit = codeblockUri.isEdit;\n\t\t\t}\n\n\t\t\tnewText = codeblockUri.textWithoutResult;\n\t\t}\n\n\t\tif (content.isComplete) {\n\t\t\tthis.markCodeBlockCompleted(sessionResource, chat, codeBlockIndex);\n\t\t}\n\n\t\treturn newText;\n\t}\n\n\tprivate trySetTextModelLanguage(inLanguageId: string, textModel: ITextModel) {\n\t\tconst vscodeLanguageId = this.languageService.getLanguageIdByLanguageName(inLanguageId);\n\t\tif (vscodeLanguageId && vscodeLanguageId !== textModel.getLanguageId()) {\n\t\t\ttextModel.setLanguage(vscodeLanguageId);\n\t\t}\n\t}\n\n\tprivate getKey(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, index: number): string {\n\t\treturn `${sessionResource.toString()}/${chat.id}/${index}`;\n\t}\n\n\tprivate getCodeBlockUri(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, index: number): URI {\n\t\tconst metadata = this.getUriMetaData(chat);\n\t\tconst indexPart = this.tag ? `${this.tag}-${index}` : `${index}`;\n\t\tconst encodedSessionId = encodeBase64(VSBuffer.wrap(new TextEncoder().encode(sessionResource.toString())), false, true);\n\t\treturn URI.from({\n\t\t\tscheme: Schemas.vscodeChatCodeBlock,\n\t\t\tauthority: encodedSessionId,\n\t\t\tpath: `/${chat.id}/${indexPart}`,\n\t\t\tfragment: metadata ? JSON.stringify(metadata) : undefined,\n\t\t});\n\t}\n\n\tprivate getUriMetaData(chat: IChatRequestViewModel | IChatResponseViewModel) {\n\t\tif (!isResponseVM(chat)) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn {\n\t\t\treferences: chat.contentReferences.map(ref => {\n\t\t\t\tif (typeof ref.reference === 'string') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst uriOrLocation = 'variableName' in ref.reference ?\n\t\t\t\t\tref.reference.value :\n\t\t\t\t\tref.reference;\n\t\t\t\tif (!uriOrLocation) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (URI.isUri(uriOrLocation)) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\turi: uriOrLocation.toJSON()\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\turi: uriOrLocation.uri.toJSON(),\n\t\t\t\t\trange: uriOrLocation.range,\n\t\t\t\t};\n\t\t\t})\n\t\t};\n\t}\n}\n\nfunction fixCodeText(text: string, languageId: string | undefined): string {\n\tif (languageId === 'php') {\n\t\t// <?php or short tag version <?\n\t\tif (!text.trim().startsWith('<?')) {\n\t\t\treturn `<?php\\n${text}`;\n\t\t}\n\t}\n\n\treturn text;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { encodeBase64, VSBuffer } from '../../../../base/common/buffer.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { Disposable, IReference } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { Range } from '../../../../editor/common/core/range.js';\nimport { ILanguageService } from '../../../../editor/common/languages/language.js';\nimport { PLAINTEXT_LANGUAGE_ID } from '../../../../editor/common/languages/modesRegistry.js';\nimport { EndOfLinePreference, ITextModel } from '../../../../editor/common/model.js';\nimport { IResolvedTextEditorModel, ITextModelService } from '../../../../editor/common/services/resolverService.js';\nimport { extractCodeblockUrisFromText, extractVulnerabilitiesFromText, IMarkdownVulnerability } from './annotations.js';\nimport { IChatRequestViewModel, IChatResponseViewModel, isResponseVM } from './chatViewModel.js';\n\n\ninterface CodeBlockContent {\n\treadonly text: string;\n\treadonly languageId?: string;\n\treadonly isComplete: boolean;\n}\n\nexport interface CodeBlockEntry {\n\treadonly model: Promise<ITextModel>;\n\treadonly vulns: readonly IMarkdownVulnerability[];\n\treadonly codemapperUri?: URI;\n\treadonly isEdit?: boolean;\n}\n\nexport class CodeBlockModelCollection extends Disposable {\n\n\tprivate readonly _models = new Map<string, {\n\t\tmodel: Promise<IReference<IResolvedTextEditorModel>>;\n\t\tvulns: readonly IMarkdownVulnerability[];\n\t\tinLanguageId: string | undefined;\n\t\tcodemapperUri?: URI;\n\t\tisEdit?: boolean;\n\t}>();\n\n\t/**\n\t * Max number of models to keep in memory.\n\t *\n\t * Currently always maintains the most recently created models.\n\t */\n\tprivate readonly maxModelCount = 100;\n\n\tconstructor(\n\t\tprivate readonly tag: string | undefined,\n\t\t@ILanguageService private readonly languageService: ILanguageService,\n\t\t@ITextModelService private readonly textModelService: ITextModelService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(this.languageService.onDidChange(async () => {\n\t\t\tfor (const entry of this._models.values()) {\n\t\t\t\tif (!entry.inLanguageId) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst model = (await entry.model).object;\n\t\t\t\tconst existingLanguageId = model.getLanguageId();\n\t\t\t\tif (!existingLanguageId || existingLanguageId === PLAINTEXT_LANGUAGE_ID) {\n\t\t\t\t\tthis.trySetTextModelLanguage(entry.inLanguageId, model.textEditorModel);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tpublic override dispose(): void {\n\t\tsuper.dispose();\n\t\tthis.clear();\n\t}\n\n\tget(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number): CodeBlockEntry | undefined {\n\t\tconst entry = this._models.get(this.getKey(sessionResource, chat, codeBlockIndex));\n\t\tif (!entry) {\n\t\t\treturn;\n\t\t}\n\t\treturn {\n\t\t\tmodel: entry.model.then(ref => ref.object.textEditorModel),\n\t\t\tvulns: entry.vulns,\n\t\t\tcodemapperUri: entry.codemapperUri,\n\t\t\tisEdit: entry.isEdit,\n\t\t};\n\t}\n\n\tgetOrCreate(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number): CodeBlockEntry {\n\t\tconst existing = this.get(sessionResource, chat, codeBlockIndex);\n\t\tif (existing) {\n\t\t\treturn existing;\n\t\t}\n\n\t\tconst uri = this.getCodeBlockUri(sessionResource, chat, codeBlockIndex);\n\t\tconst model = this.textModelService.createModelReference(uri);\n\t\tthis._models.set(this.getKey(sessionResource, chat, codeBlockIndex), {\n\t\t\tmodel: model,\n\t\t\tvulns: [],\n\t\t\tinLanguageId: undefined,\n\t\t\tcodemapperUri: undefined,\n\t\t});\n\n\t\twhile (this._models.size > this.maxModelCount) {\n\t\t\tconst first = Iterable.first(this._models.keys());\n\t\t\tif (!first) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tthis.delete(first);\n\t\t}\n\n\t\treturn { model: model.then(x => x.object.textEditorModel), vulns: [], codemapperUri: undefined };\n\t}\n\n\tprivate delete(key: string) {\n\t\tconst entry = this._models.get(key);\n\t\tif (!entry) {\n\t\t\treturn;\n\t\t}\n\n\t\tentry.model.then(ref => ref.dispose());\n\t\tthis._models.delete(key);\n\t}\n\n\tclear(): void {\n\t\tthis._models.forEach(async entry => await entry.model.then(ref => ref.dispose()));\n\t\tthis._models.clear();\n\t}\n\n\tupdateSync(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number, content: CodeBlockContent): CodeBlockEntry {\n\t\tconst entry = this.getOrCreate(sessionResource, chat, codeBlockIndex);\n\n\t\tthis.updateInternalCodeBlockEntry(content, sessionResource, chat, codeBlockIndex);\n\n\t\treturn this.get(sessionResource, chat, codeBlockIndex) ?? entry;\n\t}\n\n\tmarkCodeBlockCompleted(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number): void {\n\t\tconst entry = this._models.get(this.getKey(sessionResource, chat, codeBlockIndex));\n\t\tif (!entry) {\n\t\t\treturn;\n\t\t}\n\t\t// TODO: fill this in once we've implemented https://github.com/microsoft/vscode/issues/232538\n\t}\n\n\tasync update(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, codeBlockIndex: number, content: CodeBlockContent): Promise<CodeBlockEntry> {\n\t\tconst entry = this.getOrCreate(sessionResource, chat, codeBlockIndex);\n\n\t\tconst newText = this.updateInternalCodeBlockEntry(content, sessionResource, chat, codeBlockIndex);\n\n\t\tconst textModel = await entry.model;\n\t\tif (!textModel || textModel.isDisposed()) {\n\t\t\t// Somehow we get an undefined textModel sometimes - #237782\n\t\t\treturn entry;\n\t\t}\n\n\t\tif (content.languageId) {\n\t\t\tthis.trySetTextModelLanguage(content.languageId, textModel);\n\t\t}\n\n\t\tconst currentText = textModel.getValue(EndOfLinePreference.LF);\n\t\tif (newText === currentText) {\n\t\t\treturn entry;\n\t\t}\n\n\t\tif (newText.startsWith(currentText)) {\n\t\t\tconst text = newText.slice(currentText.length);\n\t\t\tconst lastLine = textModel.getLineCount();\n\t\t\tconst lastCol = textModel.getLineMaxColumn(lastLine);\n\t\t\ttextModel.applyEdits([{ range: new Range(lastLine, lastCol, lastLine, lastCol), text }]);\n\t\t} else {\n\t\t\t// console.log(`Failed to optimize setText`);\n\t\t\ttextModel.setValue(newText);\n\t\t}\n\n\t\treturn entry;\n\t}\n\n\tprivate updateInternalCodeBlockEntry(content: CodeBlockContent, sessionResource: URI, chat: IChatResponseViewModel | IChatRequestViewModel, codeBlockIndex: number) {\n\t\tconst entry = this._models.get(this.getKey(sessionResource, chat, codeBlockIndex));\n\t\tif (entry) {\n\t\t\tentry.inLanguageId = content.languageId;\n\t\t}\n\n\t\tconst extractedVulns = extractVulnerabilitiesFromText(content.text);\n\t\tlet newText = fixCodeText(extractedVulns.newText, content.languageId);\n\t\tif (entry) {\n\t\t\tentry.vulns = extractedVulns.vulnerabilities;\n\t\t}\n\n\t\tconst codeblockUri = extractCodeblockUrisFromText(newText);\n\t\tif (codeblockUri) {\n\t\t\tif (entry) {\n\t\t\t\tentry.codemapperUri = codeblockUri.uri;\n\t\t\t\tentry.isEdit = codeblockUri.isEdit;\n\t\t\t}\n\n\t\t\tnewText = codeblockUri.textWithoutResult;\n\t\t}\n\n\t\tif (content.isComplete) {\n\t\t\tthis.markCodeBlockCompleted(sessionResource, chat, codeBlockIndex);\n\t\t}\n\n\t\treturn newText;\n\t}\n\n\tprivate trySetTextModelLanguage(inLanguageId: string, textModel: ITextModel) {\n\t\tconst vscodeLanguageId = this.languageService.getLanguageIdByLanguageName(inLanguageId);\n\t\tif (vscodeLanguageId && vscodeLanguageId !== textModel.getLanguageId()) {\n\t\t\ttextModel.setLanguage(vscodeLanguageId);\n\t\t}\n\t}\n\n\tprivate getKey(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, index: number): string {\n\t\treturn `${sessionResource.toString()}/${chat.id}/${index}`;\n\t}\n\n\tprivate getCodeBlockUri(sessionResource: URI, chat: IChatRequestViewModel | IChatResponseViewModel, index: number): URI {\n\t\tconst metadata = this.getUriMetaData(chat);\n\t\tconst indexPart = this.tag ? `${this.tag}-${index}` : `${index}`;\n\t\tconst encodedSessionId = encodeBase64(VSBuffer.wrap(new TextEncoder().encode(sessionResource.toString())), false, true);\n\t\treturn URI.from({\n\t\t\tscheme: Schemas.vscodeChatCodeBlock,\n\t\t\tauthority: encodedSessionId,\n\t\t\tpath: `/${chat.id}/${indexPart}`,\n\t\t\tfragment: metadata ? JSON.stringify(metadata) : undefined,\n\t\t});\n\t}\n\n\tprivate getUriMetaData(chat: IChatRequestViewModel | IChatResponseViewModel) {\n\t\tif (!isResponseVM(chat)) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn {\n\t\t\treferences: chat.contentReferences.map(ref => {\n\t\t\t\tif (typeof ref.reference === 'string') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst uriOrLocation = 'variableName' in ref.reference ?\n\t\t\t\t\tref.reference.value :\n\t\t\t\t\tref.reference;\n\t\t\t\tif (!uriOrLocation) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (URI.isUri(uriOrLocation)) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\turi: uriOrLocation.toJSON()\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\turi: uriOrLocation.uri.toJSON(),\n\t\t\t\t\trange: uriOrLocation.range,\n\t\t\t\t};\n\t\t\t})\n\t\t};\n\t}\n}\n\nfunction fixCodeText(text: string, languageId: string | undefined): string {\n\tif (languageId === 'php') {\n\t\t// <?php or short tag version <?\n\t\tif (!text.trim().startsWith('<?')) {\n\t\t\treturn `<?php\\n${text}`;\n\t\t}\n\t}\n\n\treturn text;\n}\n"]}