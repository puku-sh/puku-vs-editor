{"version":3,"sources":["vs/workbench/contrib/chat/common/tools/runSubagentTool.ts"],"names":[],"mappings":"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","file":"runSubagentTool.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Codicon } from '../../../../../base/common/codicons.js';\nimport { MarkdownString } from '../../../../../base/common/htmlContent.js';\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { ThemeIcon } from '../../../../../base/common/themables.js';\nimport { localize } from '../../../../../nls.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { ILogService } from '../../../../../platform/log/common/log.js';\nimport { IChatAgentRequest, IChatAgentService } from '../chatAgents.js';\nimport { ChatModel, IChatRequestModeInstructions } from '../chatModel.js';\nimport { IChatModeService } from '../chatModes.js';\nimport { IChatProgress, IChatService } from '../chatService.js';\nimport { ChatAgentLocation, ChatConfiguration, ChatModeKind } from '../constants.js';\nimport { ILanguageModelChatMetadata, ILanguageModelsService } from '../languageModels.js';\nimport {\n\tCountTokensCallback,\n\tILanguageModelToolsService,\n\tIPreparedToolInvocation,\n\tIToolData,\n\tIToolImpl,\n\tIToolInvocation,\n\tIToolInvocationPreparationContext,\n\tIToolResult,\n\tToolDataSource,\n\tToolProgress,\n\tToolSet,\n\tVSCodeToolReference\n} from '../languageModelToolsService.js';\nimport { ManageTodoListToolToolId } from './manageTodoListTool.js';\nimport { createToolSimpleTextResult } from './toolHelpers.js';\n\nexport const RunSubagentToolId = 'runSubagent';\n\nconst BaseModelDescription = `Launch a new agent to handle complex, multi-step tasks autonomously. This tool is good at researching complex questions, searching for code, and executing multi-step tasks. When you are searching for a keyword or file and are not confident that you will find the right match in the first few tries, use this agent to perform the search for you.\n\n- Agents do not run async or in the background, you will wait for the agent\\'s result.\n- When the agent is done, it will return a single message back to you. The result returned by the agent is not visible to the user. To show the user the result, you should send a text message back to the user with a concise summary of the result.\n- Each agent invocation is stateless. You will not be able to send additional messages to the agent, nor will the agent be able to communicate with you outside of its final report. Therefore, your prompt should contain a highly detailed task description for the agent to perform autonomously and you should specify exactly what information the agent should return back to you in its final and only message to you.\n- The agent's outputs should generally be trusted\n- Clearly tell the agent whether you expect it to write code or just to do research (search, file reads, web fetches, etc.), since it is not aware of the user\\'s intent`;\n\ninterface IRunSubagentToolInputParams {\n\tprompt: string;\n\tdescription: string;\n\tsubagentType?: string;\n}\n\nexport class RunSubagentTool extends Disposable implements IToolImpl {\n\n\tconstructor(\n\t\t@IChatAgentService private readonly chatAgentService: IChatAgentService,\n\t\t@IChatService private readonly chatService: IChatService,\n\t\t@IChatModeService private readonly chatModeService: IChatModeService,\n\t\t@ILanguageModelToolsService private readonly languageModelToolsService: ILanguageModelToolsService,\n\t\t@ILanguageModelsService private readonly languageModelsService: ILanguageModelsService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@ILanguageModelToolsService private readonly toolsService: ILanguageModelToolsService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t) {\n\t\tsuper();\n\t}\n\n\tgetToolData(): IToolData {\n\t\tconst runSubagentToolData: IToolData = {\n\t\t\tid: RunSubagentToolId,\n\t\t\ttoolReferenceName: VSCodeToolReference.runSubagent,\n\t\t\tlegacyToolReferenceFullNames: ['runSubagent'],\n\t\t\ticon: ThemeIcon.fromId(Codicon.organization.id),\n\t\t\tdisplayName: localize('tool.runSubagent.displayName', 'Run Subagent'),\n\t\t\tuserDescription: localize('tool.runSubagent.userDescription', 'Run a task within an isolated subagent context to enable efficient organization of tasks and context window management.'),\n\t\t\tmodelDescription: BaseModelDescription,\n\t\t\tsource: ToolDataSource.Internal,\n\t\t\tinputSchema: {\n\t\t\t\ttype: 'object',\n\t\t\t\tproperties: {\n\t\t\t\t\tprompt: {\n\t\t\t\t\t\ttype: 'string',\n\t\t\t\t\t\tdescription: 'A detailed description of the task for the agent to perform'\n\t\t\t\t\t},\n\t\t\t\t\tdescription: {\n\t\t\t\t\t\ttype: 'string',\n\t\t\t\t\t\tdescription: 'A short (3-5 word) description of the task'\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\trequired: ['prompt', 'description']\n\t\t\t}\n\t\t};\n\n\t\tif (this.configurationService.getValue(ChatConfiguration.SubagentToolCustomAgents)) {\n\t\t\trunSubagentToolData.inputSchema!.properties!['subagentType'] = {\n\t\t\t\ttype: 'string',\n\t\t\t\tdescription: 'Optional ID of a specific agent to invoke. If not provided, uses the current agent.'\n\t\t\t};\n\t\t\trunSubagentToolData.modelDescription += `\\n- If the user asks for a certain agent by name, you MUST provide that EXACT subagentType (case-sensitive) to invoke that specific agent.`;\n\t\t}\n\n\n\n\t\treturn runSubagentToolData;\n\t}\n\n\tasync invoke(invocation: IToolInvocation, _countTokens: CountTokensCallback, _progress: ToolProgress, token: CancellationToken): Promise<IToolResult> {\n\t\tconst args = invocation.parameters as IRunSubagentToolInputParams;\n\n\t\tthis.logService.debug(`RunSubagentTool: Invoking with prompt: ${args.prompt.substring(0, 100)}...`);\n\n\t\tif (!invocation.context) {\n\t\t\tthrow new Error('toolInvocationToken is required for this tool');\n\t\t}\n\n\t\t// Get the chat model and request for writing progress\n\t\tconst model = this.chatService.getSession(invocation.context.sessionResource) as ChatModel | undefined;\n\t\tif (!model) {\n\t\t\tthrow new Error('Chat model not found for session');\n\t\t}\n\n\t\tconst request = model.getRequests().at(-1)!;\n\n\t\ttry {\n\t\t\t// Get the default agent\n\t\t\tconst defaultAgent = this.chatAgentService.getDefaultAgent(ChatAgentLocation.Chat, ChatModeKind.Agent);\n\t\t\tif (!defaultAgent) {\n\t\t\t\treturn createToolSimpleTextResult('Error: No default agent available');\n\t\t\t}\n\n\t\t\t// Resolve mode-specific configuration if subagentId is provided\n\t\t\tlet modeModelId = invocation.modelId;\n\t\t\tlet modeTools = invocation.userSelectedTools;\n\t\t\tlet modeInstructions: IChatRequestModeInstructions | undefined;\n\n\t\t\tif (args.subagentType) {\n\t\t\t\tconst mode = this.chatModeService.findModeByName(args.subagentType);\n\t\t\t\tif (mode) {\n\t\t\t\t\t// Use mode-specific model if available\n\t\t\t\t\tconst modeModelQualifiedName = mode.model?.get();\n\t\t\t\t\tif (modeModelQualifiedName) {\n\t\t\t\t\t\t// Find the actual model identifier from the qualified name\n\t\t\t\t\t\tconst modelIds = this.languageModelsService.getLanguageModelIds();\n\t\t\t\t\t\tfor (const modelId of modelIds) {\n\t\t\t\t\t\t\tconst metadata = this.languageModelsService.lookupLanguageModel(modelId);\n\t\t\t\t\t\t\tif (metadata && ILanguageModelChatMetadata.matchesQualifiedName(modeModelQualifiedName, metadata)) {\n\t\t\t\t\t\t\t\tmodeModelId = modelId;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Use mode-specific tools if available\n\t\t\t\t\tconst modeCustomTools = mode.customTools?.get();\n\t\t\t\t\tif (modeCustomTools) {\n\t\t\t\t\t\t// Convert the mode's custom tools (array of qualified names) to UserSelectedTools format\n\t\t\t\t\t\tconst enablementMap = this.languageModelToolsService.toToolAndToolSetEnablementMap(modeCustomTools, mode.target?.get());\n\t\t\t\t\t\t// Convert enablement map to UserSelectedTools (Record<string, boolean>)\n\t\t\t\t\t\tmodeTools = {};\n\t\t\t\t\t\tfor (const [tool, enabled] of enablementMap) {\n\t\t\t\t\t\t\tif (!(tool instanceof ToolSet)) {\n\t\t\t\t\t\t\t\tmodeTools[tool.id] = enabled;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst instructions = mode.modeInstructions?.get();\n\t\t\t\t\tmodeInstructions = instructions && {\n\t\t\t\t\t\tname: mode.name.get(),\n\t\t\t\t\t\tcontent: instructions.content,\n\t\t\t\t\t\ttoolReferences: this.toolsService.toToolReferences(instructions.toolReferences),\n\t\t\t\t\t\tmetadata: instructions.metadata,\n\t\t\t\t\t};\n\t\t\t\t} else {\n\t\t\t\t\tthis.logService.warn(`RunSubagentTool: Agent '${args.subagentType}' not found, using current configuration`);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Track whether we should collect markdown (after the last prepare tool invocation)\n\t\t\tconst markdownParts: string[] = [];\n\n\t\t\tlet inEdit = false;\n\t\t\tconst progressCallback = (parts: IChatProgress[]) => {\n\t\t\t\tfor (const part of parts) {\n\t\t\t\t\t// Write certain parts immediately to the model\n\t\t\t\t\tif (part.kind === 'prepareToolInvocation' || part.kind === 'textEdit' || part.kind === 'notebookEdit' || part.kind === 'codeblockUri') {\n\t\t\t\t\t\tif (part.kind === 'codeblockUri' && !inEdit) {\n\t\t\t\t\t\t\tinEdit = true;\n\t\t\t\t\t\t\tmodel.acceptResponseProgress(request, { kind: 'markdownContent', content: new MarkdownString('```\\n'), fromSubagent: true });\n\t\t\t\t\t\t}\n\t\t\t\t\t\tmodel.acceptResponseProgress(request, part);\n\n\t\t\t\t\t\t// When we see a prepare tool invocation, reset markdown collection\n\t\t\t\t\t\tif (part.kind === 'prepareToolInvocation') {\n\t\t\t\t\t\t\tmarkdownParts.length = 0; // Clear previously collected markdown\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (part.kind === 'markdownContent') {\n\t\t\t\t\t\tif (inEdit) {\n\t\t\t\t\t\t\tmodel.acceptResponseProgress(request, { kind: 'markdownContent', content: new MarkdownString('\\n```\\n\\n'), fromSubagent: true });\n\t\t\t\t\t\t\tinEdit = false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Collect markdown content for the tool result\n\t\t\t\t\t\tmarkdownParts.push(part.content.value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (modeTools) {\n\t\t\t\tmodeTools[RunSubagentToolId] = false;\n\t\t\t\tmodeTools[ManageTodoListToolToolId] = false;\n\t\t\t}\n\n\t\t\t// Build the agent request\n\t\t\tconst agentRequest: IChatAgentRequest = {\n\t\t\t\tsessionId: invocation.context.sessionId,\n\t\t\t\tsessionResource: invocation.context.sessionResource,\n\t\t\t\trequestId: invocation.callId ?? `subagent-${Date.now()}`,\n\t\t\t\tagentId: defaultAgent.id,\n\t\t\t\tmessage: args.prompt,\n\t\t\t\tvariables: { variables: [] },\n\t\t\t\tlocation: ChatAgentLocation.Chat,\n\t\t\t\tisSubagent: true,\n\t\t\t\tuserSelectedModelId: modeModelId,\n\t\t\t\tuserSelectedTools: modeTools,\n\t\t\t\tmodeInstructions,\n\t\t\t};\n\n\t\t\t// Invoke the agent\n\t\t\tconst result = await this.chatAgentService.invokeAgent(\n\t\t\t\tdefaultAgent.id,\n\t\t\t\tagentRequest,\n\t\t\t\tprogressCallback,\n\t\t\t\t[],\n\t\t\t\ttoken\n\t\t\t);\n\n\t\t\t// Check for errors\n\t\t\tif (result.errorDetails) {\n\t\t\t\treturn createToolSimpleTextResult(`Agent error: ${result.errorDetails.message}`);\n\t\t\t}\n\n\t\t\treturn createToolSimpleTextResult(markdownParts.join('') || 'Agent completed with no output');\n\n\t\t} catch (error) {\n\t\t\tconst errorMessage = `Error invoking subagent: ${error instanceof Error ? error.message : 'Unknown error'}`;\n\t\t\tthis.logService.error(errorMessage, error);\n\t\t\treturn createToolSimpleTextResult(errorMessage);\n\t\t}\n\t}\n\n\tasync prepareToolInvocation(context: IToolInvocationPreparationContext, _token: CancellationToken): Promise<IPreparedToolInvocation | undefined> {\n\t\tconst args = context.parameters as IRunSubagentToolInputParams;\n\n\t\treturn {\n\t\t\tinvocationMessage: args.description,\n\t\t};\n\t}\n}\n"]}