{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/common/chatWidgetHistoryService.ts","vs/workbench/contrib/chat/common/chatWidgetHistoryService.ts"],"names":[],"mappings":"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","file":"chatWidgetHistoryService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { Memento } from '../../../common/memento.js';\nimport { IChatModelInputState } from './chatModel.js';\nimport { CHAT_PROVIDER_ID } from './chatParticipantContribTypes.js';\nimport { IChatRequestVariableEntry } from './chatVariableEntries.js';\nimport { ChatAgentLocation, ChatModeKind } from './constants.js';\n\ninterface IChatHistoryEntry {\n\ttext: string;\n\tstate?: IChatInputState;\n}\n\n/** The collected input state for chat history entries */\ninterface IChatInputState {\n\t[key: string]: any;\n\tchatContextAttachments?: ReadonlyArray<IChatRequestVariableEntry>;\n\n\t/**\n\t * This should be a mode id (ChatMode | string).\n\t * { id: string } is the old IChatMode. This is deprecated but may still be in persisted data.\n\t */\n\tchatMode?: ChatModeKind | string | { id: string };\n}\n\nexport const IChatWidgetHistoryService = createDecorator<IChatWidgetHistoryService>('IChatWidgetHistoryService');\nexport interface IChatWidgetHistoryService {\n\t_serviceBrand: undefined;\n\n\treadonly onDidClearHistory: Event<void>;\n\n\tclearHistory(): void;\n\tgetHistory(location: ChatAgentLocation): IChatModelInputState[];\n\tsaveHistory(location: ChatAgentLocation, history: IChatModelInputState[]): void;\n}\n\ninterface IChatHistory {\n\thistory?: { [providerId: string]: IChatModelInputState[] };\n}\n\nexport const ChatInputHistoryMaxEntries = 40;\n\nexport class ChatWidgetHistoryService implements IChatWidgetHistoryService {\n\t_serviceBrand: undefined;\n\n\tprivate memento: Memento<IChatHistory>;\n\tprivate viewState: IChatHistory;\n\n\tprivate readonly _onDidClearHistory = new Emitter<void>();\n\treadonly onDidClearHistory: Event<void> = this._onDidClearHistory.event;\n\n\tconstructor(\n\t\t@IStorageService storageService: IStorageService\n\t) {\n\t\tthis.memento = new Memento<IChatHistory>('interactive-session', storageService);\n\t\tconst loadedState = this.memento.getMemento(StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\tthis.viewState = loadedState;\n\t}\n\n\tgetHistory(location: ChatAgentLocation): IChatModelInputState[] {\n\t\tconst key = this.getKey(location);\n\t\tconst history = this.viewState.history?.[key] ?? [];\n\n\t\t// Migrate old IChatHistoryEntry format to IChatModelInputState\n\t\treturn history.map(entry => this.migrateHistoryEntry(entry));\n\t}\n\n\tprivate migrateHistoryEntry(entry: any): IChatModelInputState {\n\t\t// If it's already in the new format (has 'inputText' property), return as-is\n\t\tif (entry.inputText !== undefined) {\n\t\t\treturn entry as IChatModelInputState;\n\t\t}\n\n\t\t// Otherwise, it's an old IChatHistoryEntry with 'text' and 'state' properties\n\t\tconst oldEntry = entry as IChatHistoryEntry;\n\t\tconst oldState = oldEntry.state ?? {};\n\n\t\t// Migrate chatMode to the new mode structure\n\t\tlet modeId: string;\n\t\tlet modeKind: ChatModeKind | undefined;\n\t\tif (oldState.chatMode) {\n\t\t\tif (typeof oldState.chatMode === 'string') {\n\t\t\t\tmodeId = oldState.chatMode;\n\t\t\t\tmodeKind = Object.values(ChatModeKind).includes(oldState.chatMode as ChatModeKind)\n\t\t\t\t\t? oldState.chatMode as ChatModeKind\n\t\t\t\t\t: undefined;\n\t\t\t} else if (typeof oldState.chatMode === 'object' && oldState.chatMode !== null) {\n\t\t\t\t// Old format: { id: string }\n\t\t\t\tconst oldMode = oldState.chatMode as { id?: string };\n\t\t\t\tmodeId = oldMode.id ?? ChatModeKind.Ask;\n\t\t\t\tmodeKind = oldMode.id && Object.values(ChatModeKind).includes(oldMode.id as ChatModeKind)\n\t\t\t\t\t? oldMode.id as ChatModeKind\n\t\t\t\t\t: undefined;\n\t\t\t} else {\n\t\t\t\tmodeId = ChatModeKind.Ask;\n\t\t\t\tmodeKind = ChatModeKind.Ask;\n\t\t\t}\n\t\t} else {\n\t\t\tmodeId = ChatModeKind.Ask;\n\t\t\tmodeKind = ChatModeKind.Ask;\n\t\t}\n\n\t\treturn {\n\t\t\tinputText: oldEntry.text ?? '',\n\t\t\tattachments: oldState.chatContextAttachments ?? [],\n\t\t\tmode: {\n\t\t\t\tid: modeId,\n\t\t\t\tkind: modeKind\n\t\t\t},\n\t\t\tcontrib: oldEntry.state || {},\n\t\t\tselectedModel: undefined,\n\t\t\tselections: []\n\t\t};\n\t}\n\n\tprivate getKey(location: ChatAgentLocation): string {\n\t\t// Preserve history for panel by continuing to use the same old provider id. Use the location as a key for other chat locations.\n\t\treturn location === ChatAgentLocation.Chat ? CHAT_PROVIDER_ID : location;\n\t}\n\n\tsaveHistory(location: ChatAgentLocation, history: IChatModelInputState[]): void {\n\t\tif (!this.viewState.history) {\n\t\t\tthis.viewState.history = {};\n\t\t}\n\n\t\tconst key = this.getKey(location);\n\t\tthis.viewState.history[key] = history.slice(-ChatInputHistoryMaxEntries);\n\t\tthis.memento.saveMemento();\n\t}\n\n\tclearHistory(): void {\n\t\tthis.viewState.history = {};\n\t\tthis.memento.saveMemento();\n\t\tthis._onDidClearHistory.fire();\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { Memento } from '../../../common/memento.js';\nimport { IChatModelInputState } from './chatModel.js';\nimport { CHAT_PROVIDER_ID } from './chatParticipantContribTypes.js';\nimport { IChatRequestVariableEntry } from './chatVariableEntries.js';\nimport { ChatAgentLocation, ChatModeKind } from './constants.js';\n\ninterface IChatHistoryEntry {\n\ttext: string;\n\tstate?: IChatInputState;\n}\n\n/** The collected input state for chat history entries */\ninterface IChatInputState {\n\t[key: string]: any;\n\tchatContextAttachments?: ReadonlyArray<IChatRequestVariableEntry>;\n\n\t/**\n\t * This should be a mode id (ChatMode | string).\n\t * { id: string } is the old IChatMode. This is deprecated but may still be in persisted data.\n\t */\n\tchatMode?: ChatModeKind | string | { id: string };\n}\n\nexport const IChatWidgetHistoryService = createDecorator<IChatWidgetHistoryService>('IChatWidgetHistoryService');\nexport interface IChatWidgetHistoryService {\n\t_serviceBrand: undefined;\n\n\treadonly onDidClearHistory: Event<void>;\n\n\tclearHistory(): void;\n\tgetHistory(location: ChatAgentLocation): IChatModelInputState[];\n\tsaveHistory(location: ChatAgentLocation, history: IChatModelInputState[]): void;\n}\n\ninterface IChatHistory {\n\thistory?: { [providerId: string]: IChatModelInputState[] };\n}\n\nexport const ChatInputHistoryMaxEntries = 40;\n\nexport class ChatWidgetHistoryService implements IChatWidgetHistoryService {\n\t_serviceBrand: undefined;\n\n\tprivate memento: Memento<IChatHistory>;\n\tprivate viewState: IChatHistory;\n\n\tprivate readonly _onDidClearHistory = new Emitter<void>();\n\treadonly onDidClearHistory: Event<void> = this._onDidClearHistory.event;\n\n\tconstructor(\n\t\t@IStorageService storageService: IStorageService\n\t) {\n\t\tthis.memento = new Memento<IChatHistory>('interactive-session', storageService);\n\t\tconst loadedState = this.memento.getMemento(StorageScope.WORKSPACE, StorageTarget.MACHINE);\n\t\tthis.viewState = loadedState;\n\t}\n\n\tgetHistory(location: ChatAgentLocation): IChatModelInputState[] {\n\t\tconst key = this.getKey(location);\n\t\tconst history = this.viewState.history?.[key] ?? [];\n\n\t\t// Migrate old IChatHistoryEntry format to IChatModelInputState\n\t\treturn history.map(entry => this.migrateHistoryEntry(entry));\n\t}\n\n\tprivate migrateHistoryEntry(entry: any): IChatModelInputState {\n\t\t// If it's already in the new format (has 'inputText' property), return as-is\n\t\tif (entry.inputText !== undefined) {\n\t\t\treturn entry as IChatModelInputState;\n\t\t}\n\n\t\t// Otherwise, it's an old IChatHistoryEntry with 'text' and 'state' properties\n\t\tconst oldEntry = entry as IChatHistoryEntry;\n\t\tconst oldState = oldEntry.state ?? {};\n\n\t\t// Migrate chatMode to the new mode structure\n\t\tlet modeId: string;\n\t\tlet modeKind: ChatModeKind | undefined;\n\t\tif (oldState.chatMode) {\n\t\t\tif (typeof oldState.chatMode === 'string') {\n\t\t\t\tmodeId = oldState.chatMode;\n\t\t\t\tmodeKind = Object.values(ChatModeKind).includes(oldState.chatMode as ChatModeKind)\n\t\t\t\t\t? oldState.chatMode as ChatModeKind\n\t\t\t\t\t: undefined;\n\t\t\t} else if (typeof oldState.chatMode === 'object' && oldState.chatMode !== null) {\n\t\t\t\t// Old format: { id: string }\n\t\t\t\tconst oldMode = oldState.chatMode as { id?: string };\n\t\t\t\tmodeId = oldMode.id ?? ChatModeKind.Ask;\n\t\t\t\tmodeKind = oldMode.id && Object.values(ChatModeKind).includes(oldMode.id as ChatModeKind)\n\t\t\t\t\t? oldMode.id as ChatModeKind\n\t\t\t\t\t: undefined;\n\t\t\t} else {\n\t\t\t\tmodeId = ChatModeKind.Ask;\n\t\t\t\tmodeKind = ChatModeKind.Ask;\n\t\t\t}\n\t\t} else {\n\t\t\tmodeId = ChatModeKind.Ask;\n\t\t\tmodeKind = ChatModeKind.Ask;\n\t\t}\n\n\t\treturn {\n\t\t\tinputText: oldEntry.text ?? '',\n\t\t\tattachments: oldState.chatContextAttachments ?? [],\n\t\t\tmode: {\n\t\t\t\tid: modeId,\n\t\t\t\tkind: modeKind\n\t\t\t},\n\t\t\tcontrib: oldEntry.state || {},\n\t\t\tselectedModel: undefined,\n\t\t\tselections: []\n\t\t};\n\t}\n\n\tprivate getKey(location: ChatAgentLocation): string {\n\t\t// Preserve history for panel by continuing to use the same old provider id. Use the location as a key for other chat locations.\n\t\treturn location === ChatAgentLocation.Chat ? CHAT_PROVIDER_ID : location;\n\t}\n\n\tsaveHistory(location: ChatAgentLocation, history: IChatModelInputState[]): void {\n\t\tif (!this.viewState.history) {\n\t\t\tthis.viewState.history = {};\n\t\t}\n\n\t\tconst key = this.getKey(location);\n\t\tthis.viewState.history[key] = history.slice(-ChatInputHistoryMaxEntries);\n\t\tthis.memento.saveMemento();\n\t}\n\n\tclearHistory(): void {\n\t\tthis.viewState.history = {};\n\t\tthis.memento.saveMemento();\n\t\tthis._onDidClearHistory.fire();\n\t}\n}\n"]}