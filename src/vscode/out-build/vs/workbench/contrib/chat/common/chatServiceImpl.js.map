{"version":3,"sources":["vs/workbench/contrib/chat/common/chatServiceImpl.ts"],"names":[],"mappings":"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","file":"chatServiceImpl.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DeferredPromise } from '../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { toErrorMessage } from '../../../../base/common/errorMessage.js';\nimport { BugIndicatingError, ErrorNoTelemetry } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { MarkdownString } from '../../../../base/common/htmlContent.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { Disposable, DisposableMap, DisposableStore, IDisposable, MutableDisposable } from '../../../../base/common/lifecycle.js';\nimport { revive } from '../../../../base/common/marshalling.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { autorun, derived, IObservable, ObservableMap } from '../../../../base/common/observable.js';\nimport { StopWatch } from '../../../../base/common/stopwatch.js';\nimport { isDefined } from '../../../../base/common/types.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { OffsetRange } from '../../../../editor/common/core/ranges/offsetRange.js';\nimport { localize } from '../../../../nls.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { Progress } from '../../../../platform/progress/common/progress.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { IWorkspaceContextService } from '../../../../platform/workspace/common/workspace.js';\nimport { IExtensionService } from '../../../services/extensions/common/extensions.js';\nimport { IMcpService } from '../../mcp/common/mcpTypes.js';\nimport { IChatAgentCommand, IChatAgentData, IChatAgentHistoryEntry, IChatAgentRequest, IChatAgentResult, IChatAgentService } from './chatAgents.js';\nimport { IChatEditingSession } from './chatEditingService.js';\nimport { ChatModel, ChatRequestModel, ChatRequestRemovalReason, IChatModel, IChatRequestModel, IChatRequestVariableData, IChatResponseModel, IExportableChatData, ISerializableChatData, ISerializableChatDataIn, ISerializableChatsData, normalizeSerializableChatData, toChatHistoryContent, updateRanges } from './chatModel.js';\nimport { chatAgentLeader, ChatRequestAgentPart, ChatRequestAgentSubcommandPart, ChatRequestSlashCommandPart, ChatRequestTextPart, chatSubcommandLeader, getPromptText, IParsedChatRequest } from './chatParserTypes.js';\nimport { ChatRequestParser } from './chatRequestParser.js';\nimport { ChatMcpServersStarting, IChatCompleteResponse, IChatDetail, IChatFollowup, IChatProgress, IChatSendRequestData, IChatSendRequestOptions, IChatSendRequestResponseState, IChatService, IChatSessionContext, IChatTransferredSessionData, IChatUserActionEvent } from './chatService.js';\nimport { ChatRequestTelemetry, ChatServiceTelemetry } from './chatServiceTelemetry.js';\nimport { IChatSessionsService } from './chatSessionsService.js';\nimport { ChatSessionStore, IChatTransfer2 } from './chatSessionStore.js';\nimport { IChatSlashCommandService } from './chatSlashCommands.js';\nimport { IChatTransferService } from './chatTransferService.js';\nimport { LocalChatSessionUri } from './chatUri.js';\nimport { IChatRequestVariableEntry } from './chatVariableEntries.js';\nimport { ChatAgentLocation, ChatConfiguration, ChatModeKind } from './constants.js';\nimport { ChatMessageRole, IChatMessage } from './languageModels.js';\nimport { ILanguageModelToolsService } from './languageModelToolsService.js';\n\nconst serializedChatKey = 'interactive.sessions';\n\nconst TransferredGlobalChatKey = 'chat.workspaceTransfer';\n\nconst SESSION_TRANSFER_EXPIRATION_IN_MILLISECONDS = 1000 * 60;\n\nclass CancellableRequest implements IDisposable {\n\tconstructor(\n\t\tpublic readonly cancellationTokenSource: CancellationTokenSource,\n\t\tpublic requestId: string | undefined,\n\t\t@ILanguageModelToolsService private readonly toolsService: ILanguageModelToolsService\n\t) { }\n\n\tdispose() {\n\t\tthis.cancellationTokenSource.dispose();\n\t}\n\n\tcancel() {\n\t\tif (this.requestId) {\n\t\t\tthis.toolsService.cancelToolCallsForRequest(this.requestId);\n\t\t}\n\n\t\tthis.cancellationTokenSource.cancel();\n\t}\n}\n\nclass ChatModelStore {\n\tprivate readonly _models = new ObservableMap<string, ChatModel>();\n\n\tpublic get observable() {\n\t\treturn this._models.observable;\n\t}\n\n\tpublic values(): Iterable<ChatModel> {\n\t\treturn this._models.values();\n\t}\n\n\tpublic get(uri: URI): ChatModel | undefined {\n\t\treturn this._models.get(this.toKey(uri));\n\t}\n\n\tpublic has(uri: URI): boolean {\n\t\treturn this._models.has(this.toKey(uri));\n\t}\n\n\tpublic set(uri: URI, value: ChatModel): void {\n\t\tthis._models.set(this.toKey(uri), value);\n\t}\n\n\tpublic delete(uri: URI): boolean {\n\t\treturn this._models.delete(this.toKey(uri));\n\t}\n\n\tprivate toKey(uri: URI): string {\n\t\treturn uri.toString();\n\t}\n}\n\nclass DisposableResourceMap<T extends IDisposable> extends Disposable {\n\n\tprivate readonly _map = this._register(new DisposableMap<string, T>());\n\n\tget(sessionResource: URI) {\n\t\treturn this._map.get(this.toKey(sessionResource));\n\t}\n\n\tset(sessionResource: URI, value: T) {\n\t\tthis._map.set(this.toKey(sessionResource), value);\n\t}\n\n\thas(sessionResource: URI) {\n\t\treturn this._map.has(this.toKey(sessionResource));\n\t}\n\n\tdeleteAndLeak(sessionResource: URI) {\n\t\treturn this._map.deleteAndLeak(this.toKey(sessionResource));\n\t}\n\n\tdeleteAndDispose(sessionResource: URI) {\n\t\tthis._map.deleteAndDispose(this.toKey(sessionResource));\n\t}\n\n\tprivate toKey(uri: URI): string {\n\t\treturn uri.toString();\n\t}\n}\n\n\nexport class ChatService extends Disposable implements IChatService {\n\tdeclare _serviceBrand: undefined;\n\n\tprivate readonly _sessionModels = new ChatModelStore();\n\tprivate readonly _contentProviderSessionModels = this._register(new DisposableResourceMap<{ readonly model: IChatModel } & IDisposable>());\n\tprivate readonly _pendingRequests = this._register(new DisposableResourceMap<CancellableRequest>());\n\tprivate _persistedSessions: ISerializableChatsData;\n\n\tprivate _transferredSessionData: IChatTransferredSessionData | undefined;\n\tpublic get transferredSessionData(): IChatTransferredSessionData | undefined {\n\t\treturn this._transferredSessionData;\n\t}\n\n\tprivate readonly _onDidSubmitRequest = this._register(new Emitter<{ readonly chatSessionResource: URI }>());\n\tpublic readonly onDidSubmitRequest = this._onDidSubmitRequest.event;\n\n\tprivate readonly _onDidPerformUserAction = this._register(new Emitter<IChatUserActionEvent>());\n\tpublic readonly onDidPerformUserAction: Event<IChatUserActionEvent> = this._onDidPerformUserAction.event;\n\n\tprivate readonly _onDidDisposeSession = this._register(new Emitter<{ readonly sessionResource: URI; reason: 'cleared' }>());\n\tpublic readonly onDidDisposeSession = this._onDidDisposeSession.event;\n\n\tprivate readonly _sessionFollowupCancelTokens = this._register(new DisposableResourceMap<CancellationTokenSource>());\n\tprivate readonly _chatServiceTelemetry: ChatServiceTelemetry;\n\tprivate readonly _chatSessionStore: ChatSessionStore;\n\n\treadonly requestInProgressObs: IObservable<boolean>;\n\n\tpublic get edits2Enabled(): boolean {\n\t\treturn this.configurationService.getValue(ChatConfiguration.Edits2Enabled);\n\t}\n\n\tprivate get isEmptyWindow(): boolean {\n\t\tconst workspace = this.workspaceContextService.getWorkspace();\n\t\treturn !workspace.configuration && workspace.folders.length === 0;\n\t}\n\n\tconstructor(\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IExtensionService private readonly extensionService: IExtensionService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IWorkspaceContextService private readonly workspaceContextService: IWorkspaceContextService,\n\t\t@IChatSlashCommandService private readonly chatSlashCommandService: IChatSlashCommandService,\n\t\t@IChatAgentService private readonly chatAgentService: IChatAgentService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IChatTransferService private readonly chatTransferService: IChatTransferService,\n\t\t@IChatSessionsService private readonly chatSessionService: IChatSessionsService,\n\t\t@IMcpService private readonly mcpService: IMcpService,\n\t) {\n\t\tsuper();\n\n\t\tthis._chatServiceTelemetry = this.instantiationService.createInstance(ChatServiceTelemetry);\n\n\t\tconst sessionData = storageService.get(serializedChatKey, this.isEmptyWindow ? StorageScope.APPLICATION : StorageScope.WORKSPACE, '');\n\t\tif (sessionData) {\n\t\t\tthis._persistedSessions = this.deserializeChats(sessionData);\n\t\t\tconst countsForLog = Object.keys(this._persistedSessions).length;\n\t\t\tif (countsForLog > 0) {\n\t\t\t\tthis.trace('constructor', `Restored ${countsForLog} persisted sessions`);\n\t\t\t}\n\t\t} else {\n\t\t\tthis._persistedSessions = {};\n\t\t}\n\n\t\tconst transferredData = this.getTransferredSessionData();\n\t\tconst transferredChat = transferredData?.chat;\n\t\tif (transferredChat) {\n\t\t\tthis.trace('constructor', `Transferred session ${transferredChat.sessionId}`);\n\t\t\tthis._persistedSessions[transferredChat.sessionId] = transferredChat;\n\t\t\tthis._transferredSessionData = {\n\t\t\t\tsessionId: transferredChat.sessionId,\n\t\t\t\tlocation: transferredData.location,\n\t\t\t\tinputState: transferredData.inputState\n\t\t\t};\n\t\t}\n\n\t\tthis._chatSessionStore = this._register(this.instantiationService.createInstance(ChatSessionStore));\n\t\tthis._chatSessionStore.migrateDataIfNeeded(() => this._persistedSessions);\n\n\t\t// When using file storage, populate _persistedSessions with session metadata from the index\n\t\t// This ensures that getPersistedSessionTitle() can find titles for inactive sessions\n\t\tthis.initializePersistedSessionsFromFileStorage();\n\n\t\tthis._register(storageService.onWillSaveState(() => this.saveState()));\n\n\t\tthis.requestInProgressObs = derived(reader => {\n\t\t\tconst models = this._sessionModels.observable.read(reader).values();\n\t\t\treturn Iterable.some(models, model => model.requestInProgress.read(reader));\n\t\t});\n\t}\n\n\tpublic get editingSessions() {\n\t\treturn [...this._sessionModels.values()].map(v => v.editingSession).filter(isDefined);\n\t}\n\n\tisEnabled(location: ChatAgentLocation): boolean {\n\t\treturn this.chatAgentService.getContributedDefaultAgent(location) !== undefined;\n\t}\n\n\tprivate saveState(): void {\n\t\tconst liveChats = Array.from(this._sessionModels.values())\n\t\t\t.filter(session => {\n\t\t\t\tif (!LocalChatSessionUri.parseLocalSessionId(session.sessionResource)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\treturn session.initialLocation === ChatAgentLocation.Chat;\n\t\t\t});\n\n\t\tthis._chatSessionStore.storeSessions(liveChats);\n\t}\n\n\tnotifyUserAction(action: IChatUserActionEvent): void {\n\t\tthis._chatServiceTelemetry.notifyUserAction(action);\n\t\tthis._onDidPerformUserAction.fire(action);\n\t\tif (action.action.kind === 'chatEditingSessionAction') {\n\t\t\tconst model = this._sessionModels.get(action.sessionResource);\n\t\t\tif (model) {\n\t\t\t\tmodel.notifyEditingAction(action.action);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync setChatSessionTitle(sessionResource: URI, title: string): Promise<void> {\n\t\tconst sessionId = this.toLocalSessionId(sessionResource);\n\t\tconst model = this._sessionModels.get(sessionResource);\n\t\tif (model) {\n\t\t\tmodel.setCustomTitle(title);\n\t\t}\n\n\t\t// Update the title in the file storage\n\t\tawait this._chatSessionStore.setSessionTitle(sessionId, title);\n\t\t// Trigger immediate save to ensure consistency\n\t\tthis.saveState();\n\t}\n\n\tprivate trace(method: string, message?: string): void {\n\t\tif (message) {\n\t\t\tthis.logService.trace(`ChatService#${method}: ${message}`);\n\t\t} else {\n\t\t\tthis.logService.trace(`ChatService#${method}`);\n\t\t}\n\t}\n\n\tprivate error(method: string, message: string): void {\n\t\tthis.logService.error(`ChatService#${method} ${message}`);\n\t}\n\n\tprivate deserializeChats(sessionData: string): ISerializableChatsData {\n\t\ttry {\n\t\t\tconst arrayOfSessions: ISerializableChatDataIn[] = revive(JSON.parse(sessionData)); // Revive serialized URIs in session data\n\t\t\tif (!Array.isArray(arrayOfSessions)) {\n\t\t\t\tthrow new Error('Expected array');\n\t\t\t}\n\n\t\t\tconst sessions = arrayOfSessions.reduce<ISerializableChatsData>((acc, session) => {\n\t\t\t\t// Revive serialized markdown strings in response data\n\t\t\t\tfor (const request of session.requests) {\n\t\t\t\t\tif (Array.isArray(request.response)) {\n\t\t\t\t\t\trequest.response = request.response.map((response) => {\n\t\t\t\t\t\t\tif (typeof response === 'string') {\n\t\t\t\t\t\t\t\treturn new MarkdownString(response);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn response;\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (typeof request.response === 'string') {\n\t\t\t\t\t\trequest.response = [new MarkdownString(request.response)];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tacc[session.sessionId] = normalizeSerializableChatData(session);\n\t\t\t\treturn acc;\n\t\t\t}, {});\n\t\t\treturn sessions;\n\t\t} catch (err) {\n\t\t\tthis.error('deserializeChats', `Malformed session data: ${err}. [${sessionData.substring(0, 20)}${sessionData.length > 20 ? '...' : ''}]`);\n\t\t\treturn {};\n\t\t}\n\t}\n\n\tprivate getTransferredSessionData(): IChatTransfer2 | undefined {\n\t\tconst data: IChatTransfer2[] = this.storageService.getObject(TransferredGlobalChatKey, StorageScope.PROFILE, []);\n\t\tconst workspaceUri = this.workspaceContextService.getWorkspace().folders[0]?.uri;\n\t\tif (!workspaceUri) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst thisWorkspace = workspaceUri.toString();\n\t\tconst currentTime = Date.now();\n\t\t// Only use transferred data if it was created recently\n\t\tconst transferred = data.find(item => URI.revive(item.toWorkspace).toString() === thisWorkspace && (currentTime - item.timestampInMilliseconds < SESSION_TRANSFER_EXPIRATION_IN_MILLISECONDS));\n\t\t// Keep data that isn't for the current workspace and that hasn't expired yet\n\t\tconst filtered = data.filter(item => URI.revive(item.toWorkspace).toString() !== thisWorkspace && (currentTime - item.timestampInMilliseconds < SESSION_TRANSFER_EXPIRATION_IN_MILLISECONDS));\n\t\tthis.storageService.store(TransferredGlobalChatKey, JSON.stringify(filtered), StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\treturn transferred;\n\t}\n\n\tprivate async initializePersistedSessionsFromFileStorage(): Promise<void> {\n\n\t\tconst index = await this._chatSessionStore.getIndex();\n\t\tconst sessionIds = Object.keys(index);\n\n\t\tfor (const sessionId of sessionIds) {\n\t\t\tconst metadata = index[sessionId];\n\t\t\tif (metadata && !this._persistedSessions[sessionId]) {\n\t\t\t\t// Create a minimal session entry with the title information\n\t\t\t\t// This allows getPersistedSessionTitle() to find the title without loading the full session\n\t\t\t\tconst minimalSession: ISerializableChatData = {\n\t\t\t\t\tversion: 3,\n\t\t\t\t\tsessionId: sessionId,\n\t\t\t\t\tcustomTitle: metadata.title,\n\t\t\t\t\tcreationDate: Date.now(), // Use current time as fallback\n\t\t\t\t\tlastMessageDate: metadata.lastMessageDate,\n\t\t\t\t\tisImported: metadata.isImported || false,\n\t\t\t\t\tinitialLocation: metadata.initialLocation,\n\t\t\t\t\trequests: [], // Empty requests array - this is just for title lookup\n\t\t\t\t\tresponderUsername: '',\n\t\t\t\t\tresponderAvatarIconUri: undefined,\n\t\t\t\t};\n\n\t\t\t\tthis._persistedSessions[sessionId] = minimalSession;\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Returns an array of chat details for all persisted chat sessions that have at least one request.\n\t * Chat sessions that have already been loaded into the chat view are excluded from the result.\n\t * Imported chat sessions are also excluded from the result.\n\t */\n\tasync getLocalSessionHistory(): Promise<IChatDetail[]> {\n\t\tconst liveSessionItems = this.getLiveSessionItems();\n\t\tconst historySessionItems = await this.getHistorySessionItems();\n\n\t\treturn [...liveSessionItems, ...historySessionItems];\n\t}\n\n\t/**\n\t * Returns an array of chat details for all local live chat sessions.\n\t */\n\tgetLiveSessionItems(): IChatDetail[] {\n\t\treturn Array.from(this._sessionModels.values())\n\t\t\t.filter(session => this.shouldBeInHistory(session))\n\t\t\t.map((session): IChatDetail => {\n\t\t\t\tconst title = session.title || localize('newChat', \"New Chat\");\n\t\t\t\treturn {\n\t\t\t\t\tsessionResource: session.sessionResource,\n\t\t\t\t\ttitle,\n\t\t\t\t\tlastMessageDate: session.lastMessageDate,\n\t\t\t\t\tisActive: true,\n\t\t\t\t};\n\t\t\t});\n\t}\n\n\t/**\n\t * Returns an array of chat details for all local chat sessions in history (not currently loaded).\n\t */\n\tasync getHistorySessionItems(): Promise<IChatDetail[]> {\n\t\tconst index = await this._chatSessionStore.getIndex();\n\t\treturn Object.values(index)\n\t\t\t.filter(entry => !this._sessionModels.has(LocalChatSessionUri.forSession(entry.sessionId)) && this.shouldBeInHistory(entry) && !entry.isEmpty)\n\t\t\t.map((entry): IChatDetail => {\n\t\t\t\tconst sessionResource = LocalChatSessionUri.forSession(entry.sessionId);\n\t\t\t\treturn ({\n\t\t\t\t\t...entry,\n\t\t\t\t\tsessionResource,\n\t\t\t\t\tisActive: this._sessionModels.has(sessionResource),\n\t\t\t\t});\n\t\t\t});\n\t}\n\n\tprivate shouldBeInHistory(entry: Partial<ChatModel>) {\n\t\tif (entry.sessionResource) {\n\t\t\treturn !entry.isImported && LocalChatSessionUri.parseLocalSessionId(entry.sessionResource) && entry.initialLocation === ChatAgentLocation.Chat;\n\t\t}\n\t\treturn !entry.isImported && entry.initialLocation === ChatAgentLocation.Chat;\n\t}\n\n\tasync removeHistoryEntry(sessionResource: URI): Promise<void> {\n\t\tawait this._chatSessionStore.deleteSession(this.toLocalSessionId(sessionResource));\n\t}\n\n\tasync clearAllHistoryEntries(): Promise<void> {\n\t\tawait this._chatSessionStore.clearAllSessions();\n\t}\n\n\tstartSession(location: ChatAgentLocation, token: CancellationToken, options?: { canUseTools?: boolean }): ChatModel {\n\t\tthis.trace('startSession');\n\t\treturn this._startSession(undefined, location, token, options);\n\t}\n\n\tprivate _startSession(someSessionHistory: IExportableChatData | ISerializableChatData | undefined, location: ChatAgentLocation, token: CancellationToken, options?: { sessionResource?: URI; canUseTools?: boolean }, transferEditingSession?: IChatEditingSession): ChatModel {\n\t\tconst model = this.instantiationService.createInstance(ChatModel, someSessionHistory, { initialLocation: location, canUseTools: options?.canUseTools ?? true, resource: options?.sessionResource });\n\t\tif (location === ChatAgentLocation.Chat) {\n\t\t\tmodel.startEditingSession(true, transferEditingSession);\n\t\t}\n\n\t\tthis._sessionModels.set(model.sessionResource, model);\n\t\tthis.initializeSession(model, token);\n\t\treturn model;\n\t}\n\n\tprivate initializeSession(model: ChatModel, token: CancellationToken): void {\n\t\tthis.trace('initializeSession', `Initialize session ${model.sessionResource}`);\n\n\t\t// Activate the default extension provided agent but do not wait\n\t\t// for it to be ready so that the session can be used immediately\n\t\t// without having to wait for the agent to be ready.\n\t\tthis.activateDefaultAgent(model.initialLocation).catch(e => this.logService.error(e));\n\t}\n\n\tasync activateDefaultAgent(location: ChatAgentLocation): Promise<void> {\n\t\tawait this.extensionService.whenInstalledExtensionsRegistered();\n\n\t\tconst defaultAgentData = this.chatAgentService.getContributedDefaultAgent(location) ?? this.chatAgentService.getContributedDefaultAgent(ChatAgentLocation.Chat);\n\t\tif (!defaultAgentData) {\n\t\t\tthrow new ErrorNoTelemetry('No default agent contributed');\n\t\t}\n\n\t\t// Await activation of the extension provided agent\n\t\t// Using `activateById` as workaround for the issue\n\t\t// https://github.com/microsoft/vscode/issues/250590\n\t\tif (!defaultAgentData.isCore) {\n\t\t\tawait this.extensionService.activateById(defaultAgentData.extensionId, {\n\t\t\t\tactivationEvent: `onChatParticipant:${defaultAgentData.id}`,\n\t\t\t\textensionId: defaultAgentData.extensionId,\n\t\t\t\tstartup: false\n\t\t\t});\n\t\t}\n\n\t\tconst defaultAgent = this.chatAgentService.getActivatedAgents().find(agent => agent.id === defaultAgentData.id);\n\t\tif (!defaultAgent) {\n\t\t\tthrow new ErrorNoTelemetry('No default agent registered');\n\t\t}\n\t}\n\n\tgetSession(sessionResource: URI): IChatModel | undefined {\n\t\treturn this._sessionModels.get(sessionResource);\n\t}\n\n\tasync getOrRestoreSession(sessionResource: URI): Promise<ChatModel | undefined> {\n\t\tthis.trace('getOrRestoreSession', `${sessionResource}`);\n\t\tconst model = this._sessionModels.get(sessionResource);\n\t\tif (model) {\n\t\t\treturn model;\n\t\t}\n\n\t\tconst sessionId = LocalChatSessionUri.parseLocalSessionId(sessionResource);\n\t\tif (!sessionId) {\n\t\t\tthrow new Error(`Cannot restore non-local session ${sessionResource}`);\n\t\t}\n\n\t\tlet sessionData: ISerializableChatData | undefined;\n\t\tif (this.transferredSessionData?.sessionId === sessionId) {\n\t\t\tsessionData = revive(this._persistedSessions[sessionId]);\n\t\t} else {\n\t\t\tsessionData = revive(await this._chatSessionStore.readSession(sessionId));\n\t\t}\n\n\t\tif (!sessionData) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst session = this._startSession(sessionData, sessionData.initialLocation ?? ChatAgentLocation.Chat, CancellationToken.None, { canUseTools: true, sessionResource });\n\n\t\tconst isTransferred = this.transferredSessionData?.sessionId === sessionId;\n\t\tif (isTransferred) {\n\t\t\tthis._transferredSessionData = undefined;\n\t\t}\n\n\t\treturn session;\n\t}\n\n\t/**\n\t * This is really just for migrating data from the edit session location to the panel.\n\t */\n\tisPersistedSessionEmpty(sessionResource: URI): boolean {\n\t\tconst sessionId = LocalChatSessionUri.parseLocalSessionId(sessionResource);\n\t\tif (!sessionId) {\n\t\t\tthrow new Error(`Cannot restore non-local session ${sessionResource}`);\n\t\t}\n\n\t\tconst session = this._persistedSessions[sessionId];\n\t\tif (session) {\n\t\t\treturn session.requests.length === 0;\n\t\t}\n\n\t\treturn this._chatSessionStore.isSessionEmpty(sessionId);\n\t}\n\n\tgetPersistedSessionTitle(sessionResource: URI): string | undefined {\n\t\tconst sessionId = LocalChatSessionUri.parseLocalSessionId(sessionResource);\n\t\tif (!sessionId) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\t// First check the memory cache (_persistedSessions)\n\t\tconst session = this._persistedSessions[sessionId];\n\t\tif (session) {\n\t\t\tconst title = session.customTitle || ChatModel.getDefaultTitle(session.requests);\n\t\t\treturn title;\n\t\t}\n\n\t\t// Try to read directly from file storage index\n\t\t// This handles the case where getName() is called before initialization completes\n\t\t// Access the internal synchronous index method via reflection\n\t\t// This is a workaround for the timing issue where initialization hasn't completed\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tconst internalGetIndex = (this._chatSessionStore as any).internalGetIndex;\n\t\tif (typeof internalGetIndex === 'function') {\n\t\t\tconst indexData = internalGetIndex.call(this._chatSessionStore);\n\t\t\tconst metadata = indexData.entries[sessionId];\n\t\t\tif (metadata && metadata.title) {\n\t\t\t\treturn metadata.title;\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tloadSessionFromContent(data: IExportableChatData | ISerializableChatData): IChatModel | undefined {\n\t\treturn this._startSession(data, data.initialLocation ?? ChatAgentLocation.Chat, CancellationToken.None);\n\t}\n\n\tasync loadSessionForResource(chatSessionResource: URI, location: ChatAgentLocation, token: CancellationToken): Promise<IChatModel | undefined> {\n\t\t// TODO: Move this into a new ChatModelService\n\n\t\tif (chatSessionResource.scheme === Schemas.vscodeLocalChatSession) {\n\t\t\treturn this.getOrRestoreSession(chatSessionResource);\n\t\t}\n\n\t\tconst existing = this._contentProviderSessionModels.get(chatSessionResource);\n\t\tif (existing) {\n\t\t\treturn existing.model;\n\t\t}\n\n\t\tconst providedSession = await this.chatSessionService.getOrCreateChatSession(chatSessionResource, CancellationToken.None);\n\t\tconst chatSessionType = chatSessionResource.scheme;\n\n\t\t// Contributed sessions do not use UI tools\n\t\tconst model = this._startSession(undefined, location, CancellationToken.None, { sessionResource: chatSessionResource, canUseTools: false }, providedSession.initialEditingSession);\n\t\tmodel.setContributedChatSession({\n\t\t\tchatSessionResource,\n\t\t\tchatSessionType,\n\t\t\tisUntitled: chatSessionResource.path.startsWith('/untitled-')  //TODO(jospicer)\n\t\t});\n\n\t\tconst disposables = new DisposableStore();\n\t\tthis._contentProviderSessionModels.set(chatSessionResource, { model, dispose: () => disposables.dispose() });\n\n\t\tdisposables.add(model.onDidDispose(() => {\n\t\t\tthis._contentProviderSessionModels.deleteAndDispose(chatSessionResource);\n\t\t\tprovidedSession.dispose();\n\t\t}));\n\n\t\tlet lastRequest: ChatRequestModel | undefined;\n\t\tfor (const message of providedSession.history) {\n\t\t\tif (message.type === 'request') {\n\t\t\t\tif (lastRequest) {\n\t\t\t\t\tlastRequest.response?.complete();\n\t\t\t\t}\n\n\t\t\t\tconst requestText = message.prompt;\n\n\t\t\t\tconst parsedRequest: IParsedChatRequest = {\n\t\t\t\t\ttext: requestText,\n\t\t\t\t\tparts: [new ChatRequestTextPart(\n\t\t\t\t\t\tnew OffsetRange(0, requestText.length),\n\t\t\t\t\t\t{ startLineNumber: 1, startColumn: 1, endLineNumber: 1, endColumn: requestText.length + 1 },\n\t\t\t\t\t\trequestText\n\t\t\t\t\t)]\n\t\t\t\t};\n\t\t\t\tconst agent =\n\t\t\t\t\tmessage.participant\n\t\t\t\t\t\t? this.chatAgentService.getAgent(message.participant) // TODO(jospicer): Remove and always hardcode?\n\t\t\t\t\t\t: this.chatAgentService.getAgent(chatSessionType);\n\t\t\t\tlastRequest = model.addRequest(parsedRequest,\n\t\t\t\t\tmessage.variableData ?? { variables: [] },\n\t\t\t\t\t0, // attempt\n\t\t\t\t\tundefined,\n\t\t\t\t\tagent,\n\t\t\t\t\tundefined, // slashCommand\n\t\t\t\t\tundefined, // confirmation\n\t\t\t\t\tundefined, // locationData\n\t\t\t\t\tundefined, // attachments\n\t\t\t\t\ttrue // isCompleteAddedRequest - this indicates it's a complete request, not user input\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\t// response\n\t\t\t\tif (lastRequest) {\n\t\t\t\t\tfor (const part of message.parts) {\n\t\t\t\t\t\tmodel.acceptResponseProgress(lastRequest, part);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (providedSession.progressObs && lastRequest && providedSession.interruptActiveResponseCallback) {\n\t\t\tconst initialCancellationRequest = this.instantiationService.createInstance(CancellableRequest, new CancellationTokenSource(), undefined);\n\t\t\tthis._pendingRequests.set(model.sessionResource, initialCancellationRequest);\n\t\t\tconst cancellationListener = disposables.add(new MutableDisposable());\n\n\t\t\tconst createCancellationListener = (token: CancellationToken) => {\n\t\t\t\treturn token.onCancellationRequested(() => {\n\t\t\t\t\tprovidedSession.interruptActiveResponseCallback?.().then(userConfirmedInterruption => {\n\t\t\t\t\t\tif (!userConfirmedInterruption) {\n\t\t\t\t\t\t\t// User cancelled the interruption\n\t\t\t\t\t\t\tconst newCancellationRequest = this.instantiationService.createInstance(CancellableRequest, new CancellationTokenSource(), undefined);\n\t\t\t\t\t\t\tthis._pendingRequests.set(model.sessionResource, newCancellationRequest);\n\t\t\t\t\t\t\tcancellationListener.value = createCancellationListener(newCancellationRequest.cancellationTokenSource.token);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tcancellationListener.value = createCancellationListener(initialCancellationRequest.cancellationTokenSource.token);\n\n\t\t\tlet lastProgressLength = 0;\n\t\t\tdisposables.add(autorun(reader => {\n\t\t\t\tconst progressArray = providedSession.progressObs?.read(reader) ?? [];\n\t\t\t\tconst isComplete = providedSession.isCompleteObs?.read(reader) ?? false;\n\n\t\t\t\t// Process only new progress items\n\t\t\t\tif (progressArray.length > lastProgressLength) {\n\t\t\t\t\tconst newProgress = progressArray.slice(lastProgressLength);\n\t\t\t\t\tfor (const progress of newProgress) {\n\t\t\t\t\t\tmodel?.acceptResponseProgress(lastRequest, progress);\n\t\t\t\t\t}\n\t\t\t\t\tlastProgressLength = progressArray.length;\n\t\t\t\t}\n\n\t\t\t\t// Handle completion\n\t\t\t\tif (isComplete) {\n\t\t\t\t\tlastRequest.response?.complete();\n\t\t\t\t\tcancellationListener.clear();\n\t\t\t\t}\n\t\t\t}));\n\t\t} else {\n\t\t\tif (lastRequest) {\n\t\t\t\tlastRequest.response?.complete();\n\t\t\t}\n\t\t}\n\n\t\treturn model;\n\t}\n\n\tgetChatSessionFromInternalUri(sessionResource: URI): IChatSessionContext | undefined {\n\t\tconst model = this._sessionModels.get(sessionResource);\n\t\tif (!model) {\n\t\t\treturn;\n\t\t}\n\t\tconst { contributedChatSession } = model;\n\t\treturn contributedChatSession;\n\t}\n\n\tasync resendRequest(request: IChatRequestModel, options?: IChatSendRequestOptions): Promise<void> {\n\t\tconst model = this._sessionModels.get(request.session.sessionResource);\n\t\tif (!model && model !== request.session) {\n\t\t\tthrow new Error(`Unknown session: ${request.session.sessionResource}`);\n\t\t}\n\n\t\tconst cts = this._pendingRequests.get(request.session.sessionResource);\n\t\tif (cts) {\n\t\t\tthis.trace('resendRequest', `Session ${request.session.sessionResource} already has a pending request, cancelling...`);\n\t\t\tcts.cancel();\n\t\t}\n\n\t\tconst location = options?.location ?? model.initialLocation;\n\t\tconst attempt = options?.attempt ?? 0;\n\t\tconst enableCommandDetection = !options?.noCommandDetection;\n\t\tconst defaultAgent = this.chatAgentService.getDefaultAgent(location, options?.modeInfo?.kind)!;\n\n\t\tmodel.removeRequest(request.id, ChatRequestRemovalReason.Resend);\n\n\t\tconst resendOptions: IChatSendRequestOptions = {\n\t\t\t...options,\n\t\t\tlocationData: request.locationData,\n\t\t\tattachedContext: request.attachedContext,\n\t\t};\n\t\tawait this._sendRequestAsync(model, model.sessionResource, request.message, attempt, enableCommandDetection, defaultAgent, location, resendOptions).responseCompletePromise;\n\t}\n\n\tasync sendRequest(sessionResource: URI, request: string, options?: IChatSendRequestOptions): Promise<IChatSendRequestData | undefined> {\n\t\tthis.trace('sendRequest', `sessionResource: ${sessionResource.toString()}, message: ${request.substring(0, 20)}${request.length > 20 ? '[...]' : ''}}`);\n\n\n\t\tif (!request.trim() && !options?.slashCommand && !options?.agentId && !options?.agentIdSilent) {\n\t\t\tthis.trace('sendRequest', 'Rejected empty message');\n\t\t\treturn;\n\t\t}\n\n\t\tconst model = this._sessionModels.get(sessionResource);\n\t\tif (!model) {\n\t\t\tthrow new Error(`Unknown session: ${sessionResource}`);\n\t\t}\n\n\t\tif (this._pendingRequests.has(sessionResource)) {\n\t\t\tthis.trace('sendRequest', `Session ${sessionResource} already has a pending request`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst requests = model.getRequests();\n\t\tfor (let i = requests.length - 1; i >= 0; i -= 1) {\n\t\t\tconst request = requests[i];\n\t\t\tif (request.shouldBeRemovedOnSend) {\n\t\t\t\tif (request.shouldBeRemovedOnSend.afterUndoStop) {\n\t\t\t\t\trequest.response?.finalizeUndoState();\n\t\t\t\t} else {\n\t\t\t\t\tawait this.removeRequest(sessionResource, request.id);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst location = options?.location ?? model.initialLocation;\n\t\tconst attempt = options?.attempt ?? 0;\n\t\tconst defaultAgent = this.chatAgentService.getDefaultAgent(location, options?.modeInfo?.kind)!;\n\n\t\tconst parsedRequest = this.parseChatRequest(sessionResource, request, location, options);\n\t\tconst silentAgent = options?.agentIdSilent ? this.chatAgentService.getAgent(options.agentIdSilent) : undefined;\n\t\tconst agent = silentAgent ?? parsedRequest.parts.find((r): r is ChatRequestAgentPart => r instanceof ChatRequestAgentPart)?.agent ?? defaultAgent;\n\t\tconst agentSlashCommandPart = parsedRequest.parts.find((r): r is ChatRequestAgentSubcommandPart => r instanceof ChatRequestAgentSubcommandPart);\n\n\t\t// This method is only returning whether the request was accepted - don't block on the actual request\n\t\treturn {\n\t\t\t...this._sendRequestAsync(model, sessionResource, parsedRequest, attempt, !options?.noCommandDetection, silentAgent ?? defaultAgent, location, options),\n\t\t\tagent,\n\t\t\tslashCommand: agentSlashCommandPart?.command,\n\t\t};\n\t}\n\n\tprivate parseChatRequest(sessionResource: URI, request: string, location: ChatAgentLocation, options: IChatSendRequestOptions | undefined): IParsedChatRequest {\n\t\tlet parserContext = options?.parserContext;\n\t\tif (options?.agentId) {\n\t\t\tconst agent = this.chatAgentService.getAgent(options.agentId);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Error(`Unknown agent: ${options.agentId}`);\n\t\t\t}\n\t\t\tparserContext = { selectedAgent: agent, mode: options.modeInfo?.kind };\n\t\t\tconst commandPart = options.slashCommand ? ` ${chatSubcommandLeader}${options.slashCommand}` : '';\n\t\t\trequest = `${chatAgentLeader}${agent.name}${commandPart} ${request}`;\n\t\t}\n\n\t\tconst parsedRequest = this.instantiationService.createInstance(ChatRequestParser).parseChatRequest(sessionResource, request, location, parserContext);\n\t\treturn parsedRequest;\n\t}\n\n\tprivate refreshFollowupsCancellationToken(sessionResource: URI): CancellationToken {\n\t\tthis._sessionFollowupCancelTokens.get(sessionResource)?.cancel();\n\t\tconst newTokenSource = new CancellationTokenSource();\n\t\tthis._sessionFollowupCancelTokens.set(sessionResource, newTokenSource);\n\n\t\treturn newTokenSource.token;\n\t}\n\n\tprivate _sendRequestAsync(model: ChatModel, sessionResource: URI, parsedRequest: IParsedChatRequest, attempt: number, enableCommandDetection: boolean, defaultAgent: IChatAgentData, location: ChatAgentLocation, options?: IChatSendRequestOptions): IChatSendRequestResponseState {\n\t\tconst followupsCancelToken = this.refreshFollowupsCancellationToken(sessionResource);\n\t\tlet request: ChatRequestModel;\n\t\tconst agentPart = 'kind' in parsedRequest ? undefined : parsedRequest.parts.find((r): r is ChatRequestAgentPart => r instanceof ChatRequestAgentPart);\n\t\tconst agentSlashCommandPart = 'kind' in parsedRequest ? undefined : parsedRequest.parts.find((r): r is ChatRequestAgentSubcommandPart => r instanceof ChatRequestAgentSubcommandPart);\n\t\tconst commandPart = 'kind' in parsedRequest ? undefined : parsedRequest.parts.find((r): r is ChatRequestSlashCommandPart => r instanceof ChatRequestSlashCommandPart);\n\t\tconst requests = [...model.getRequests()];\n\t\tconst requestTelemetry = this.instantiationService.createInstance(ChatRequestTelemetry, {\n\t\t\tagent: agentPart?.agent ?? defaultAgent,\n\t\t\tagentSlashCommandPart,\n\t\t\tcommandPart,\n\t\t\tsessionId: model.sessionId,\n\t\t\tlocation: model.initialLocation,\n\t\t\toptions,\n\t\t\tenableCommandDetection\n\t\t});\n\n\t\tlet gotProgress = false;\n\t\tconst requestType = commandPart ? 'slashCommand' : 'string';\n\n\t\tconst responseCreated = new DeferredPromise<IChatResponseModel>();\n\t\tlet responseCreatedComplete = false;\n\t\tfunction completeResponseCreated(): void {\n\t\t\tif (!responseCreatedComplete && request?.response) {\n\t\t\t\tresponseCreated.complete(request.response);\n\t\t\t\tresponseCreatedComplete = true;\n\t\t\t}\n\t\t}\n\n\t\tconst store = new DisposableStore();\n\t\tconst source = store.add(new CancellationTokenSource());\n\t\tconst token = source.token;\n\t\tconst sendRequestInternal = async () => {\n\t\t\tconst progressCallback = (progress: IChatProgress[]) => {\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tgotProgress = true;\n\n\t\t\t\tfor (let i = 0; i < progress.length; i++) {\n\t\t\t\t\tconst isLast = i === progress.length - 1;\n\t\t\t\t\tconst progressItem = progress[i];\n\n\t\t\t\t\tif (progressItem.kind === 'markdownContent') {\n\t\t\t\t\t\tthis.trace('sendRequest', `Provider returned progress for session ${model.sessionResource}, ${progressItem.content.value.length} chars`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.trace('sendRequest', `Provider returned progress: ${JSON.stringify(progressItem)}`);\n\t\t\t\t\t}\n\n\t\t\t\t\tmodel.acceptResponseProgress(request, progressItem, !isLast);\n\t\t\t\t}\n\t\t\t\tcompleteResponseCreated();\n\t\t\t};\n\n\t\t\tlet detectedAgent: IChatAgentData | undefined;\n\t\t\tlet detectedCommand: IChatAgentCommand | undefined;\n\n\t\t\tconst stopWatch = new StopWatch(false);\n\t\t\tstore.add(token.onCancellationRequested(() => {\n\t\t\t\tthis.trace('sendRequest', `Request for session ${model.sessionResource} was cancelled`);\n\t\t\t\tif (!request) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\trequestTelemetry.complete({\n\t\t\t\t\ttimeToFirstProgress: undefined,\n\t\t\t\t\tresult: 'cancelled',\n\t\t\t\t\t// Normally timings happen inside the EH around the actual provider. For cancellation we can measure how long the user waited before cancelling\n\t\t\t\t\ttotalTime: stopWatch.elapsed(),\n\t\t\t\t\trequestType,\n\t\t\t\t\tdetectedAgent,\n\t\t\t\t\trequest,\n\t\t\t\t});\n\n\t\t\t\tmodel.cancelRequest(request);\n\t\t\t}));\n\n\t\t\ttry {\n\t\t\t\tlet rawResult: IChatAgentResult | null | undefined;\n\t\t\t\tlet agentOrCommandFollowups: Promise<IChatFollowup[] | undefined> | undefined = undefined;\n\t\t\t\tlet chatTitlePromise: Promise<string | undefined> | undefined;\n\n\t\t\t\tif (agentPart || (defaultAgent && !commandPart)) {\n\t\t\t\t\tconst prepareChatAgentRequest = (agent: IChatAgentData, command?: IChatAgentCommand, enableCommandDetection?: boolean, chatRequest?: ChatRequestModel, isParticipantDetected?: boolean): IChatAgentRequest => {\n\t\t\t\t\t\tconst initVariableData: IChatRequestVariableData = { variables: [] };\n\t\t\t\t\t\trequest = chatRequest ?? model.addRequest(parsedRequest, initVariableData, attempt, options?.modeInfo, agent, command, options?.confirmation, options?.locationData, options?.attachedContext, undefined, options?.userSelectedModelId, options?.userSelectedTools?.get());\n\n\t\t\t\t\t\tlet variableData: IChatRequestVariableData;\n\t\t\t\t\t\tlet message: string;\n\t\t\t\t\t\tif (chatRequest) {\n\t\t\t\t\t\t\tvariableData = chatRequest.variableData;\n\t\t\t\t\t\t\tmessage = getPromptText(request.message).message;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvariableData = { variables: this.prepareContext(request.attachedContext) };\n\t\t\t\t\t\t\tmodel.updateRequest(request, variableData);\n\n\t\t\t\t\t\t\tconst promptTextResult = getPromptText(request.message);\n\t\t\t\t\t\t\tvariableData = updateRanges(variableData, promptTextResult.diff); // TODO bit of a hack\n\t\t\t\t\t\t\tmessage = promptTextResult.message;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst agentRequest: IChatAgentRequest = {\n\t\t\t\t\t\t\tsessionId: model.sessionId,\n\t\t\t\t\t\t\tsessionResource: model.sessionResource,\n\t\t\t\t\t\t\trequestId: request.id,\n\t\t\t\t\t\t\tagentId: agent.id,\n\t\t\t\t\t\t\tmessage,\n\t\t\t\t\t\t\tcommand: command?.name,\n\t\t\t\t\t\t\tvariables: variableData,\n\t\t\t\t\t\t\tenableCommandDetection,\n\t\t\t\t\t\t\tisParticipantDetected,\n\t\t\t\t\t\t\tattempt,\n\t\t\t\t\t\t\tlocation,\n\t\t\t\t\t\t\tlocationData: request.locationData,\n\t\t\t\t\t\t\tacceptedConfirmationData: options?.acceptedConfirmationData,\n\t\t\t\t\t\t\trejectedConfirmationData: options?.rejectedConfirmationData,\n\t\t\t\t\t\t\tuserSelectedModelId: options?.userSelectedModelId,\n\t\t\t\t\t\t\tuserSelectedTools: options?.userSelectedTools?.get(),\n\t\t\t\t\t\t\tmodeInstructions: options?.modeInfo?.modeInstructions,\n\t\t\t\t\t\t\teditedFileEvents: request.editedFileEvents,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tlet isInitialTools = true;\n\n\t\t\t\t\t\tstore.add(autorun(reader => {\n\t\t\t\t\t\t\tconst tools = options?.userSelectedTools?.read(reader);\n\t\t\t\t\t\t\tif (isInitialTools) {\n\t\t\t\t\t\t\t\tisInitialTools = false;\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (tools) {\n\t\t\t\t\t\t\t\tthis.chatAgentService.setRequestTools(agent.id, request.id, tools);\n\t\t\t\t\t\t\t\t// in case the request has not been sent out yet:\n\t\t\t\t\t\t\t\tagentRequest.userSelectedTools = tools;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}));\n\n\t\t\t\t\t\treturn agentRequest;\n\t\t\t\t\t};\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tthis.configurationService.getValue('chat.detectParticipant.enabled') !== false &&\n\t\t\t\t\t\tthis.chatAgentService.hasChatParticipantDetectionProviders() &&\n\t\t\t\t\t\t!agentPart &&\n\t\t\t\t\t\t!commandPart &&\n\t\t\t\t\t\t!agentSlashCommandPart &&\n\t\t\t\t\t\tenableCommandDetection &&\n\t\t\t\t\t\tlocation !== ChatAgentLocation.EditorInline &&\n\t\t\t\t\t\toptions?.modeInfo?.kind !== ChatModeKind.Agent &&\n\t\t\t\t\t\toptions?.modeInfo?.kind !== ChatModeKind.Edit &&\n\t\t\t\t\t\t!options?.agentIdSilent\n\t\t\t\t\t) {\n\t\t\t\t\t\t// We have no agent or command to scope history with, pass the full history to the participant detection provider\n\t\t\t\t\t\tconst defaultAgentHistory = this.getHistoryEntriesFromModel(requests, model.sessionId, location, defaultAgent.id);\n\n\t\t\t\t\t\t// Prepare the request object that we will send to the participant detection provider\n\t\t\t\t\t\tconst chatAgentRequest = prepareChatAgentRequest(defaultAgent, undefined, enableCommandDetection, undefined, false);\n\n\t\t\t\t\t\tconst result = await this.chatAgentService.detectAgentOrCommand(chatAgentRequest, defaultAgentHistory, { location }, token);\n\t\t\t\t\t\tif (result && this.chatAgentService.getAgent(result.agent.id)?.locations?.includes(location)) {\n\t\t\t\t\t\t\t// Update the response in the ChatModel to reflect the detected agent and command\n\t\t\t\t\t\t\trequest.response?.setAgent(result.agent, result.command);\n\t\t\t\t\t\t\tdetectedAgent = result.agent;\n\t\t\t\t\t\t\tdetectedCommand = result.command;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst agent = (detectedAgent ?? agentPart?.agent ?? defaultAgent)!;\n\t\t\t\t\tconst command = detectedCommand ?? agentSlashCommandPart?.command;\n\n\t\t\t\t\tawait this.extensionService.activateByEvent(`onChatParticipant:${agent.id}`);\n\n\t\t\t\t\t// Recompute history in case the agent or command changed\n\t\t\t\t\tconst history = this.getHistoryEntriesFromModel(requests, model.sessionId, location, agent.id);\n\t\t\t\t\tconst requestProps = prepareChatAgentRequest(agent, command, enableCommandDetection, request /* Reuse the request object if we already created it for participant detection */, !!detectedAgent);\n\t\t\t\t\tconst pendingRequest = this._pendingRequests.get(sessionResource);\n\t\t\t\t\tif (pendingRequest && !pendingRequest.requestId) {\n\t\t\t\t\t\tpendingRequest.requestId = requestProps.requestId;\n\t\t\t\t\t}\n\t\t\t\t\tcompleteResponseCreated();\n\n\t\t\t\t\t// MCP autostart: only run for native VS Code sessions (sidebar, new editors) but not for extension contributed sessions that have inputType set.\n\t\t\t\t\tif (model.canUseTools) {\n\t\t\t\t\t\tconst autostartResult = new ChatMcpServersStarting(this.mcpService.autostart(token));\n\t\t\t\t\t\tif (!autostartResult.isEmpty) {\n\t\t\t\t\t\t\tprogressCallback([autostartResult]);\n\t\t\t\t\t\t\tawait autostartResult.wait();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tconst agentResult = await this.chatAgentService.invokeAgent(agent.id, requestProps, progressCallback, history, token);\n\t\t\t\t\trawResult = agentResult;\n\t\t\t\t\tagentOrCommandFollowups = this.chatAgentService.getFollowups(agent.id, requestProps, agentResult, history, followupsCancelToken);\n\n\t\t\t\t\t// Use LLM to generate the chat title\n\t\t\t\t\tif (model.getRequests().length === 1 && !model.customTitle) {\n\t\t\t\t\t\tconst chatHistory = this.getHistoryEntriesFromModel(model.getRequests(), model.sessionId, location, agent.id);\n\t\t\t\t\t\tchatTitlePromise = this.chatAgentService.getChatTitle(agent.id, chatHistory, CancellationToken.None).then(\n\t\t\t\t\t\t\t(title) => {\n\t\t\t\t\t\t\t\t// Since not every chat agent implements title generation, we can fallback to the default agent\n\t\t\t\t\t\t\t\t// which supports it\n\t\t\t\t\t\t\t\tif (title === undefined) {\n\t\t\t\t\t\t\t\t\tconst defaultAgentForTitle = this.chatAgentService.getDefaultAgent(location);\n\t\t\t\t\t\t\t\t\tif (defaultAgentForTitle) {\n\t\t\t\t\t\t\t\t\t\treturn this.chatAgentService.getChatTitle(defaultAgentForTitle.id, chatHistory, CancellationToken.None);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\treturn title;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else if (commandPart && this.chatSlashCommandService.hasCommand(commandPart.slashCommand.command)) {\n\t\t\t\t\tif (commandPart.slashCommand.silent !== true) {\n\t\t\t\t\t\trequest = model.addRequest(parsedRequest, { variables: [] }, attempt, options?.modeInfo);\n\t\t\t\t\t\tcompleteResponseCreated();\n\t\t\t\t\t}\n\t\t\t\t\t// contributed slash commands\n\t\t\t\t\t// TODO: spell this out in the UI\n\t\t\t\t\tconst history: IChatMessage[] = [];\n\t\t\t\t\tfor (const modelRequest of model.getRequests()) {\n\t\t\t\t\t\tif (!modelRequest.response) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\thistory.push({ role: ChatMessageRole.User, content: [{ type: 'text', value: modelRequest.message.text }] });\n\t\t\t\t\t\thistory.push({ role: ChatMessageRole.Assistant, content: [{ type: 'text', value: modelRequest.response.response.toString() }] });\n\t\t\t\t\t}\n\t\t\t\t\tconst message = parsedRequest.text;\n\t\t\t\t\tconst commandResult = await this.chatSlashCommandService.executeCommand(commandPart.slashCommand.command, message.substring(commandPart.slashCommand.command.length + 1).trimStart(), new Progress<IChatProgress>(p => {\n\t\t\t\t\t\tprogressCallback([p]);\n\t\t\t\t\t}), history, location, token);\n\t\t\t\t\tagentOrCommandFollowups = Promise.resolve(commandResult?.followUp);\n\t\t\t\t\trawResult = {};\n\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error(`Cannot handle request`);\n\t\t\t\t}\n\n\t\t\t\tif (token.isCancellationRequested && !rawResult) {\n\t\t\t\t\treturn;\n\t\t\t\t} else {\n\t\t\t\t\tif (!rawResult) {\n\t\t\t\t\t\tthis.trace('sendRequest', `Provider returned no response for session ${model.sessionResource}`);\n\t\t\t\t\t\trawResult = { errorDetails: { message: localize('emptyResponse', \"Provider returned null response\") } };\n\t\t\t\t\t}\n\n\t\t\t\t\tconst result = rawResult.errorDetails?.responseIsFiltered ? 'filtered' :\n\t\t\t\t\t\trawResult.errorDetails && gotProgress ? 'errorWithOutput' :\n\t\t\t\t\t\t\trawResult.errorDetails ? 'error' :\n\t\t\t\t\t\t\t\t'success';\n\n\t\t\t\t\trequestTelemetry.complete({\n\t\t\t\t\t\ttimeToFirstProgress: rawResult.timings?.firstProgress,\n\t\t\t\t\t\ttotalTime: rawResult.timings?.totalElapsed,\n\t\t\t\t\t\tresult,\n\t\t\t\t\t\trequestType,\n\t\t\t\t\t\tdetectedAgent,\n\t\t\t\t\t\trequest,\n\t\t\t\t\t});\n\n\t\t\t\t\tmodel.setResponse(request, rawResult);\n\t\t\t\t\tcompleteResponseCreated();\n\t\t\t\t\tthis.trace('sendRequest', `Provider returned response for session ${model.sessionResource}`);\n\n\t\t\t\t\trequest.response?.complete();\n\t\t\t\t\tif (agentOrCommandFollowups) {\n\t\t\t\t\t\tagentOrCommandFollowups.then(followups => {\n\t\t\t\t\t\t\tmodel.setFollowups(request, followups);\n\t\t\t\t\t\t\tconst commandForTelemetry = agentSlashCommandPart ? agentSlashCommandPart.command.name : commandPart?.slashCommand.command;\n\t\t\t\t\t\t\tthis._chatServiceTelemetry.retrievedFollowups(agentPart?.agent.id ?? '', commandForTelemetry, followups?.length ?? 0);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tchatTitlePromise?.then(title => {\n\t\t\t\t\t\tif (title) {\n\t\t\t\t\t\t\tmodel.setCustomTitle(title);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\tthis.logService.error(`Error while handling chat request: ${toErrorMessage(err, true)}`);\n\t\t\t\trequestTelemetry.complete({\n\t\t\t\t\ttimeToFirstProgress: undefined,\n\t\t\t\t\ttotalTime: undefined,\n\t\t\t\t\tresult: 'error',\n\t\t\t\t\trequestType,\n\t\t\t\t\tdetectedAgent,\n\t\t\t\t\trequest,\n\t\t\t\t});\n\t\t\t\tif (request) {\n\t\t\t\t\t// Puku Editor: Suppress PukuLoginRequired error - auth flow will handle sign-in\n\t\t\t\t\tif (err instanceof Error && err.name === 'PukuLoginRequired') {\n\t\t\t\t\t\t// Don't show error to user, just complete the request\n\t\t\t\t\t\t// Sign-in flow will be triggered by chat entitlement service\n\t\t\t\t\t\tcompleteResponseCreated();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst rawResult: IChatAgentResult = { errorDetails: { message: err.message } };\n\t\t\t\t\tmodel.setResponse(request, rawResult);\n\t\t\t\t\tcompleteResponseCreated();\n\t\t\t\t\trequest.response?.complete();\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tstore.dispose();\n\t\t\t}\n\t\t};\n\t\tconst rawResponsePromise = sendRequestInternal();\n\t\t// Note- requestId is not known at this point, assigned later\n\t\tthis._pendingRequests.set(model.sessionResource, this.instantiationService.createInstance(CancellableRequest, source, undefined));\n\t\trawResponsePromise.finally(() => {\n\t\t\tthis._pendingRequests.deleteAndDispose(model.sessionResource);\n\t\t});\n\t\tthis._onDidSubmitRequest.fire({ chatSessionResource: model.sessionResource });\n\t\treturn {\n\t\t\tresponseCreatedPromise: responseCreated.p,\n\t\t\tresponseCompletePromise: rawResponsePromise,\n\t\t};\n\t}\n\n\tprivate prepareContext(attachedContextVariables: IChatRequestVariableEntry[] | undefined): IChatRequestVariableEntry[] {\n\t\tattachedContextVariables ??= [];\n\n\t\t// \"reverse\", high index first so that replacement is simple\n\t\tattachedContextVariables.sort((a, b) => {\n\t\t\t// If either range is undefined, sort it to the back\n\t\t\tif (!a.range && !b.range) {\n\t\t\t\treturn 0; // Keep relative order if both ranges are undefined\n\t\t\t}\n\t\t\tif (!a.range) {\n\t\t\t\treturn 1; // a goes after b\n\t\t\t}\n\t\t\tif (!b.range) {\n\t\t\t\treturn -1; // a goes before b\n\t\t\t}\n\t\t\treturn b.range.start - a.range.start;\n\t\t});\n\n\t\treturn attachedContextVariables;\n\t}\n\n\tprivate getHistoryEntriesFromModel(requests: IChatRequestModel[], sessionId: string, location: ChatAgentLocation, forAgentId: string): IChatAgentHistoryEntry[] {\n\t\tconst history: IChatAgentHistoryEntry[] = [];\n\t\tconst agent = this.chatAgentService.getAgent(forAgentId);\n\t\tfor (const request of requests) {\n\t\t\tif (!request.response) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (forAgentId !== request.response.agent?.id && !agent?.isDefault && !agent?.canAccessPreviousChatHistory) {\n\t\t\t\t// An agent only gets to see requests that were sent to this agent.\n\t\t\t\t// The default agent (the undefined case), or agents with 'canAccessPreviousChatHistory', get to see all of them.\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Do not save to history inline completions\n\t\t\tif (location === ChatAgentLocation.EditorInline) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst promptTextResult = getPromptText(request.message);\n\t\t\tconst historyRequest: IChatAgentRequest = {\n\t\t\t\tsessionId: sessionId,\n\t\t\t\tsessionResource: request.session.sessionResource,\n\t\t\t\trequestId: request.id,\n\t\t\t\tagentId: request.response.agent?.id ?? '',\n\t\t\t\tmessage: promptTextResult.message,\n\t\t\t\tcommand: request.response.slashCommand?.name,\n\t\t\t\tvariables: updateRanges(request.variableData, promptTextResult.diff), // TODO bit of a hack\n\t\t\t\tlocation: ChatAgentLocation.Chat,\n\t\t\t\teditedFileEvents: request.editedFileEvents,\n\t\t\t};\n\t\t\thistory.push({ request: historyRequest, response: toChatHistoryContent(request.response.response.value), result: request.response.result ?? {} });\n\t\t}\n\n\t\treturn history;\n\t}\n\n\tasync removeRequest(sessionResource: URI, requestId: string): Promise<void> {\n\t\tconst model = this._sessionModels.get(sessionResource);\n\t\tif (!model) {\n\t\t\tthrow new Error(`Unknown session: ${sessionResource}`);\n\t\t}\n\n\t\tconst pendingRequest = this._pendingRequests.get(sessionResource);\n\t\tif (pendingRequest?.requestId === requestId) {\n\t\t\tpendingRequest.cancel();\n\t\t\tthis._pendingRequests.deleteAndDispose(sessionResource);\n\t\t}\n\n\t\tmodel.removeRequest(requestId);\n\t}\n\n\tasync adoptRequest(sessionResource: URI, request: IChatRequestModel) {\n\t\tif (!(request instanceof ChatRequestModel)) {\n\t\t\tthrow new TypeError('Can only adopt requests of type ChatRequestModel');\n\t\t}\n\t\tconst target = this._sessionModels.get(sessionResource);\n\t\tif (!target) {\n\t\t\tthrow new Error(`Unknown session: ${sessionResource}`);\n\t\t}\n\n\t\tconst oldOwner = request.session;\n\t\ttarget.adoptRequest(request);\n\n\t\tif (request.response && !request.response.isComplete) {\n\t\t\tconst cts = this._pendingRequests.deleteAndLeak(oldOwner.sessionResource);\n\t\t\tif (cts) {\n\t\t\t\tcts.requestId = request.id;\n\t\t\t\tthis._pendingRequests.set(target.sessionResource, cts);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync addCompleteRequest(sessionResource: URI, message: IParsedChatRequest | string, variableData: IChatRequestVariableData | undefined, attempt: number | undefined, response: IChatCompleteResponse): Promise<void> {\n\t\tthis.trace('addCompleteRequest', `message: ${message}`);\n\n\t\tconst model = this._sessionModels.get(sessionResource);\n\t\tif (!model) {\n\t\t\tthrow new Error(`Unknown session: ${sessionResource}`);\n\t\t}\n\n\t\tconst parsedRequest = typeof message === 'string' ?\n\t\t\tthis.instantiationService.createInstance(ChatRequestParser).parseChatRequest(sessionResource, message) :\n\t\t\tmessage;\n\t\tconst request = model.addRequest(parsedRequest, variableData || { variables: [] }, attempt ?? 0, undefined, undefined, undefined, undefined, undefined, undefined, true);\n\t\tif (typeof response.message === 'string') {\n\t\t\t// TODO is this possible?\n\t\t\tmodel.acceptResponseProgress(request, { content: new MarkdownString(response.message), kind: 'markdownContent' });\n\t\t} else {\n\t\t\tfor (const part of response.message) {\n\t\t\t\tmodel.acceptResponseProgress(request, part, true);\n\t\t\t}\n\t\t}\n\t\tmodel.setResponse(request, response.result || {});\n\t\tif (response.followups !== undefined) {\n\t\t\tmodel.setFollowups(request, response.followups);\n\t\t}\n\t\trequest.response?.complete();\n\t}\n\n\tcancelCurrentRequestForSession(sessionResource: URI): void {\n\t\tthis.trace('cancelCurrentRequestForSession', `session: ${sessionResource}`);\n\t\tthis._pendingRequests.get(sessionResource)?.cancel();\n\t\tthis._pendingRequests.deleteAndDispose(sessionResource);\n\t}\n\n\tasync clearSession(sessionResource: URI): Promise<void> {\n\t\tthis.trace('clearSession', `session: ${sessionResource}`);\n\t\tconst model = this._sessionModels.get(sessionResource);\n\t\tif (!model) {\n\t\t\tthrow new Error(`Unknown session: ${sessionResource}`);\n\t\t}\n\n\t\tconst localSessionId = LocalChatSessionUri.parseLocalSessionId(sessionResource);\n\t\tif (localSessionId && (model.initialLocation === ChatAgentLocation.Chat)) {\n\t\t\t// Always preserve sessions that have custom titles, even if empty\n\t\t\tif (model.getRequests().length === 0 && !model.customTitle) {\n\t\t\t\tawait this._chatSessionStore.deleteSession(localSessionId);\n\t\t\t} else {\n\t\t\t\tawait this._chatSessionStore.storeSessions([model]);\n\t\t\t}\n\t\t}\n\n\t\tthis._sessionModels.delete(sessionResource);\n\t\tmodel.dispose();\n\t\tthis._pendingRequests.get(sessionResource)?.cancel();\n\t\tthis._pendingRequests.deleteAndDispose(sessionResource);\n\t\tthis._onDidDisposeSession.fire({ sessionResource, reason: 'cleared' });\n\t}\n\n\tpublic hasSessions(): boolean {\n\t\treturn this._chatSessionStore.hasSessions();\n\t}\n\n\ttransferChatSession(transferredSessionData: IChatTransferredSessionData, toWorkspace: URI): void {\n\t\tconst model = Iterable.find(this._sessionModels.values(), model => model.sessionId === transferredSessionData.sessionId);\n\t\tif (!model) {\n\t\t\tthrow new Error(`Failed to transfer session. Unknown session ID: ${transferredSessionData.sessionId}`);\n\t\t}\n\n\t\tconst existingRaw: IChatTransfer2[] = this.storageService.getObject(TransferredGlobalChatKey, StorageScope.PROFILE, []);\n\t\texistingRaw.push({\n\t\t\tchat: model.toJSON(),\n\t\t\ttimestampInMilliseconds: Date.now(),\n\t\t\ttoWorkspace: toWorkspace,\n\t\t\tinputState: transferredSessionData.inputState,\n\t\t\tlocation: transferredSessionData.location,\n\t\t});\n\n\t\tthis.storageService.store(TransferredGlobalChatKey, JSON.stringify(existingRaw), StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\tthis.chatTransferService.addWorkspaceToTransferred(toWorkspace);\n\t\tthis.trace('transferChatSession', `Transferred session ${model.sessionResource} to workspace ${toWorkspace.toString()}`);\n\t}\n\n\tgetChatStorageFolder(): URI {\n\t\treturn this._chatSessionStore.getChatStorageFolder();\n\t}\n\n\tlogChatIndex(): void {\n\t\tthis._chatSessionStore.logIndex();\n\t}\n\n\tsetTitle(sessionResource: URI, title: string): void {\n\t\tthis._sessionModels.get(sessionResource)?.setCustomTitle(title);\n\t}\n\n\tappendProgress(request: IChatRequestModel, progress: IChatProgress): void {\n\t\tconst model = this._sessionModels.get(request.session.sessionResource);\n\t\tif (!(request instanceof ChatRequestModel)) {\n\t\t\tthrow new BugIndicatingError('Can only append progress to requests of type ChatRequestModel');\n\t\t}\n\n\t\tmodel?.acceptResponseProgress(request, progress);\n\t}\n\n\tprivate toLocalSessionId(sessionResource: URI) {\n\t\tconst localSessionId = LocalChatSessionUri.parseLocalSessionId(sessionResource);\n\t\tif (!localSessionId) {\n\t\t\tthrow new Error(`Invalid local chat session resource: ${sessionResource}`);\n\t\t}\n\t\treturn localSessionId;\n\t}\n}\n"]}