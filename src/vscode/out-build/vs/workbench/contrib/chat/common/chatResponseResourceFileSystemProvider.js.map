{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/common/chatResponseResourceFileSystemProvider.ts","vs/workbench/contrib/chat/common/chatResponseResourceFileSystemProvider.ts"],"names":[],"mappings":"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","file":"chatResponseResourceFileSystemProvider.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { decodeBase64, VSBuffer } from '../../../../base/common/buffer.js';\nimport { Event } from '../../../../base/common/event.js';\nimport { Disposable, IDisposable } from '../../../../base/common/lifecycle.js';\nimport { newWriteableStream, ReadableStreamEvents } from '../../../../base/common/stream.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { createFileSystemProviderError, FileSystemProviderCapabilities, FileSystemProviderErrorCode, FileType, IFileService, IFileSystemProviderWithFileAtomicReadCapability, IFileSystemProviderWithFileReadStreamCapability, IFileSystemProviderWithFileReadWriteCapability, IStat } from '../../../../platform/files/common/files.js';\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { ChatResponseResource } from './chatModel.js';\nimport { IChatService, IChatToolInvocation, IChatToolInvocationSerialized } from './chatService.js';\nimport { LocalChatSessionUri } from './chatUri.js';\nimport { isToolResultInputOutputDetails } from './languageModelToolsService.js';\n\nexport class ChatResponseResourceFileSystemProvider extends Disposable implements\n\tIWorkbenchContribution,\n\tIFileSystemProviderWithFileReadWriteCapability,\n\tIFileSystemProviderWithFileAtomicReadCapability,\n\tIFileSystemProviderWithFileReadStreamCapability {\n\n\tpublic static readonly ID = 'workbench.contrib.chatResponseResourceFileSystemProvider';\n\n\tpublic readonly onDidChangeCapabilities = Event.None;\n\tpublic readonly onDidChangeFile = Event.None;\n\n\tpublic readonly capabilities: FileSystemProviderCapabilities = FileSystemProviderCapabilities.None\n\t\t| FileSystemProviderCapabilities.Readonly\n\t\t| FileSystemProviderCapabilities.PathCaseSensitive\n\t\t| FileSystemProviderCapabilities.FileReadStream\n\t\t| FileSystemProviderCapabilities.FileAtomicRead\n\t\t| FileSystemProviderCapabilities.FileReadWrite;\n\n\tconstructor(\n\t\t@IChatService private readonly chatService: IChatService,\n\t\t@IFileService private readonly _fileService: IFileService\n\t) {\n\t\tsuper();\n\t\tthis._register(this._fileService.registerProvider(ChatResponseResource.scheme, this));\n\t}\n\n\treadFile(resource: URI): Promise<Uint8Array> {\n\t\treturn Promise.resolve(this.lookupURI(resource));\n\t}\n\n\treadFileStream(resource: URI): ReadableStreamEvents<Uint8Array> {\n\t\tconst stream = newWriteableStream<Uint8Array>(data => VSBuffer.concat(data.map(data => VSBuffer.wrap(data))).buffer);\n\t\tPromise.resolve(this.lookupURI(resource)).then(v => stream.end(v));\n\t\treturn stream;\n\t}\n\n\tasync stat(resource: URI): Promise<IStat> {\n\t\tconst r = await this.lookupURI(resource);\n\t\treturn {\n\t\t\ttype: FileType.File,\n\t\t\tctime: 0,\n\t\t\tmtime: 0,\n\t\t\tsize: r.length,\n\t\t};\n\t}\n\n\tdelete(): Promise<void> {\n\t\tthrow createFileSystemProviderError('fs is readonly', FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\twatch(): IDisposable {\n\t\treturn Disposable.None;\n\t}\n\n\tmkdir(): Promise<void> {\n\t\tthrow createFileSystemProviderError('fs is readonly', FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\treaddir(): Promise<[string, FileType][]> {\n\t\treturn Promise.resolve([]);\n\t}\n\n\trename(): Promise<void> {\n\t\tthrow createFileSystemProviderError('fs is readonly', FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\twriteFile(): Promise<void> {\n\t\tthrow createFileSystemProviderError('fs is readonly', FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\tprivate findMatchingInvocation(uri: URI) {\n\t\tconst parsed = ChatResponseResource.parseUri(uri);\n\t\tif (!parsed) {\n\t\t\tthrow createFileSystemProviderError(`File not found`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\t\tconst { sessionId, toolCallId, index } = parsed;\n\t\tconst session = this.chatService.getSession(LocalChatSessionUri.forSession(sessionId));\n\t\tif (!session) {\n\t\t\tthrow createFileSystemProviderError(`File not found`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst requests = session.getRequests();\n\t\tfor (let k = requests.length - 1; k >= 0; k--) {\n\t\t\tconst req = requests[k];\n\t\t\tconst tc = req.response?.entireResponse.value.find((r): r is IChatToolInvocation | IChatToolInvocationSerialized => (r.kind === 'toolInvocation' || r.kind === 'toolInvocationSerialized') && r.toolCallId === toolCallId);\n\t\t\tif (tc) {\n\t\t\t\treturn { result: tc, index };\n\t\t\t}\n\t\t}\n\n\t\tthrow createFileSystemProviderError(`File not found`, FileSystemProviderErrorCode.FileNotFound);\n\t}\n\n\tprivate lookupURI(uri: URI): Uint8Array | Promise<Uint8Array> {\n\t\tconst { result, index } = this.findMatchingInvocation(uri);\n\t\tconst details = IChatToolInvocation.resultDetails(result);\n\t\tif (!isToolResultInputOutputDetails(details)) {\n\t\t\tthrow createFileSystemProviderError(`Tool does not have I/O`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst part = details.output.at(index);\n\t\tif (!part) {\n\t\t\tthrow createFileSystemProviderError(`Tool does not have part`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tif (part.type === 'ref') {\n\t\t\treturn this._fileService.readFile(part.uri).then(r => r.value.buffer);\n\t\t}\n\n\t\treturn part.isText ? new TextEncoder().encode(part.value) : decodeBase64(part.value).buffer;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { decodeBase64, VSBuffer } from '../../../../base/common/buffer.js';\nimport { Event } from '../../../../base/common/event.js';\nimport { Disposable, IDisposable } from '../../../../base/common/lifecycle.js';\nimport { newWriteableStream, ReadableStreamEvents } from '../../../../base/common/stream.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { createFileSystemProviderError, FileSystemProviderCapabilities, FileSystemProviderErrorCode, FileType, IFileService, IFileSystemProviderWithFileAtomicReadCapability, IFileSystemProviderWithFileReadStreamCapability, IFileSystemProviderWithFileReadWriteCapability, IStat } from '../../../../platform/files/common/files.js';\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { ChatResponseResource } from './chatModel.js';\nimport { IChatService, IChatToolInvocation, IChatToolInvocationSerialized } from './chatService.js';\nimport { LocalChatSessionUri } from './chatUri.js';\nimport { isToolResultInputOutputDetails } from './languageModelToolsService.js';\n\nexport class ChatResponseResourceFileSystemProvider extends Disposable implements\n\tIWorkbenchContribution,\n\tIFileSystemProviderWithFileReadWriteCapability,\n\tIFileSystemProviderWithFileAtomicReadCapability,\n\tIFileSystemProviderWithFileReadStreamCapability {\n\n\tpublic static readonly ID = 'workbench.contrib.chatResponseResourceFileSystemProvider';\n\n\tpublic readonly onDidChangeCapabilities = Event.None;\n\tpublic readonly onDidChangeFile = Event.None;\n\n\tpublic readonly capabilities: FileSystemProviderCapabilities = FileSystemProviderCapabilities.None\n\t\t| FileSystemProviderCapabilities.Readonly\n\t\t| FileSystemProviderCapabilities.PathCaseSensitive\n\t\t| FileSystemProviderCapabilities.FileReadStream\n\t\t| FileSystemProviderCapabilities.FileAtomicRead\n\t\t| FileSystemProviderCapabilities.FileReadWrite;\n\n\tconstructor(\n\t\t@IChatService private readonly chatService: IChatService,\n\t\t@IFileService private readonly _fileService: IFileService\n\t) {\n\t\tsuper();\n\t\tthis._register(this._fileService.registerProvider(ChatResponseResource.scheme, this));\n\t}\n\n\treadFile(resource: URI): Promise<Uint8Array> {\n\t\treturn Promise.resolve(this.lookupURI(resource));\n\t}\n\n\treadFileStream(resource: URI): ReadableStreamEvents<Uint8Array> {\n\t\tconst stream = newWriteableStream<Uint8Array>(data => VSBuffer.concat(data.map(data => VSBuffer.wrap(data))).buffer);\n\t\tPromise.resolve(this.lookupURI(resource)).then(v => stream.end(v));\n\t\treturn stream;\n\t}\n\n\tasync stat(resource: URI): Promise<IStat> {\n\t\tconst r = await this.lookupURI(resource);\n\t\treturn {\n\t\t\ttype: FileType.File,\n\t\t\tctime: 0,\n\t\t\tmtime: 0,\n\t\t\tsize: r.length,\n\t\t};\n\t}\n\n\tdelete(): Promise<void> {\n\t\tthrow createFileSystemProviderError('fs is readonly', FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\twatch(): IDisposable {\n\t\treturn Disposable.None;\n\t}\n\n\tmkdir(): Promise<void> {\n\t\tthrow createFileSystemProviderError('fs is readonly', FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\treaddir(): Promise<[string, FileType][]> {\n\t\treturn Promise.resolve([]);\n\t}\n\n\trename(): Promise<void> {\n\t\tthrow createFileSystemProviderError('fs is readonly', FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\twriteFile(): Promise<void> {\n\t\tthrow createFileSystemProviderError('fs is readonly', FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\tprivate findMatchingInvocation(uri: URI) {\n\t\tconst parsed = ChatResponseResource.parseUri(uri);\n\t\tif (!parsed) {\n\t\t\tthrow createFileSystemProviderError(`File not found`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\t\tconst { sessionId, toolCallId, index } = parsed;\n\t\tconst session = this.chatService.getSession(LocalChatSessionUri.forSession(sessionId));\n\t\tif (!session) {\n\t\t\tthrow createFileSystemProviderError(`File not found`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst requests = session.getRequests();\n\t\tfor (let k = requests.length - 1; k >= 0; k--) {\n\t\t\tconst req = requests[k];\n\t\t\tconst tc = req.response?.entireResponse.value.find((r): r is IChatToolInvocation | IChatToolInvocationSerialized => (r.kind === 'toolInvocation' || r.kind === 'toolInvocationSerialized') && r.toolCallId === toolCallId);\n\t\t\tif (tc) {\n\t\t\t\treturn { result: tc, index };\n\t\t\t}\n\t\t}\n\n\t\tthrow createFileSystemProviderError(`File not found`, FileSystemProviderErrorCode.FileNotFound);\n\t}\n\n\tprivate lookupURI(uri: URI): Uint8Array | Promise<Uint8Array> {\n\t\tconst { result, index } = this.findMatchingInvocation(uri);\n\t\tconst details = IChatToolInvocation.resultDetails(result);\n\t\tif (!isToolResultInputOutputDetails(details)) {\n\t\t\tthrow createFileSystemProviderError(`Tool does not have I/O`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst part = details.output.at(index);\n\t\tif (!part) {\n\t\t\tthrow createFileSystemProviderError(`Tool does not have part`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tif (part.type === 'ref') {\n\t\t\treturn this._fileService.readFile(part.uri).then(r => r.value.buffer);\n\t\t}\n\n\t\treturn part.isText ? new TextEncoder().encode(part.value) : decodeBase64(part.value).buffer;\n\t}\n}\n"]}