{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/browser/chatEditing/chatEditingTextModelChangeService.ts","vs/workbench/contrib/chat/browser/chatEditing/chatEditingTextModelChangeService.ts"],"names":[],"mappings":"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","file":"chatEditingTextModelChangeService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { addDisposableListener, getWindow } from '../../../../../base/browser/dom.js';\nimport { assert } from '../../../../../base/common/assert.js';\nimport { DeferredPromise, RunOnceScheduler, timeout } from '../../../../../base/common/async.js';\nimport { Emitter } from '../../../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { autorun, IObservable, observableValue } from '../../../../../base/common/observable.js';\nimport { isEqual } from '../../../../../base/common/resources.js';\nimport { themeColorFromId } from '../../../../../base/common/themables.js';\nimport { assertType } from '../../../../../base/common/types.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { EditOperation, ISingleEditOperation } from '../../../../../editor/common/core/editOperation.js';\nimport { StringEdit } from '../../../../../editor/common/core/edits/stringEdit.js';\nimport { IRange, Range } from '../../../../../editor/common/core/range.js';\nimport { LineRange } from '../../../../../editor/common/core/ranges/lineRange.js';\nimport { IDocumentDiff, nullDocumentDiff } from '../../../../../editor/common/diff/documentDiffProvider.js';\nimport { DetailedLineRangeMapping } from '../../../../../editor/common/diff/rangeMapping.js';\nimport { TextEdit, VersionedExtensionId } from '../../../../../editor/common/languages.js';\nimport { IModelDeltaDecoration, ITextModel, ITextSnapshot, MinimapPosition, OverviewRulerLane } from '../../../../../editor/common/model.js';\nimport { ModelDecorationOptions } from '../../../../../editor/common/model/textModel.js';\nimport { offsetEditFromContentChanges, offsetEditFromLineRangeMapping, offsetEditToEditOperations } from '../../../../../editor/common/model/textModelStringEdit.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { EditSources, TextModelEditSource } from '../../../../../editor/common/textModelEditSource.js';\nimport { IModelContentChangedEvent } from '../../../../../editor/common/textModelEvents.js';\nimport { AccessibilitySignal, IAccessibilitySignalService } from '../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js';\nimport { editorSelectionBackground } from '../../../../../platform/theme/common/colorRegistry.js';\nimport { ICellEditOperation } from '../../../notebook/common/notebookCommon.js';\nimport { ModifiedFileEntryState } from '../../common/chatEditingService.js';\nimport { IChatResponseModel } from '../../common/chatModel.js';\nimport { ChatAgentLocation } from '../../common/constants.js';\nimport { IDocumentDiff2 } from './chatEditingCodeEditorIntegration.js';\nimport { pendingRewriteMinimap } from './chatEditingModifiedFileEntry.js';\n\ntype affectedLines = { linesAdded: number; linesRemoved: number; lineCount: number; hasRemainingEdits: boolean };\ntype acceptedOrRejectedLines = affectedLines & { state: 'accepted' | 'rejected' };\n\nexport class ChatEditingTextModelChangeService extends Disposable {\n\n\tprivate static readonly _lastEditDecorationOptions = ModelDecorationOptions.register({\n\t\tisWholeLine: true,\n\t\tdescription: 'chat-last-edit',\n\t\tclassName: 'chat-editing-last-edit-line',\n\t\tmarginClassName: 'chat-editing-last-edit',\n\t\toverviewRuler: {\n\t\t\tposition: OverviewRulerLane.Full,\n\t\t\tcolor: themeColorFromId(editorSelectionBackground)\n\t\t},\n\t});\n\n\tprivate static readonly _pendingEditDecorationOptions = ModelDecorationOptions.register({\n\t\tisWholeLine: true,\n\t\tdescription: 'chat-pending-edit',\n\t\tclassName: 'chat-editing-pending-edit',\n\t\tminimap: {\n\t\t\tposition: MinimapPosition.Inline,\n\t\t\tcolor: themeColorFromId(pendingRewriteMinimap)\n\t\t}\n\t});\n\n\tprivate static readonly _atomicEditDecorationOptions = ModelDecorationOptions.register({\n\t\tisWholeLine: true,\n\t\tdescription: 'chat-atomic-edit',\n\t\tclassName: 'chat-editing-atomic-edit',\n\t\tminimap: {\n\t\t\tposition: MinimapPosition.Inline,\n\t\t\tcolor: themeColorFromId(pendingRewriteMinimap)\n\t\t}\n\t});\n\n\tprivate _isEditFromUs: boolean = false;\n\tpublic get isEditFromUs() {\n\t\treturn this._isEditFromUs;\n\t}\n\tprivate _allEditsAreFromUs: boolean = true;\n\tpublic get allEditsAreFromUs() {\n\t\treturn this._allEditsAreFromUs;\n\t}\n\tprivate _isExternalEditInProgress: (() => boolean) | undefined;\n\tprivate _diffOperation: Promise<IDocumentDiff | undefined> | undefined;\n\tprivate _diffOperationIds: number = 0;\n\n\tprivate readonly _diffInfo = observableValue<IDocumentDiff>(this, nullDocumentDiff);\n\tpublic get diffInfo() {\n\t\treturn this._diffInfo.map(value => {\n\t\t\treturn {\n\t\t\t\t...value,\n\t\t\t\toriginalModel: this.originalModel,\n\t\t\t\tmodifiedModel: this.modifiedModel,\n\t\t\t\tkeep: changes => this._keepHunk(changes),\n\t\t\t\tundo: changes => this._undoHunk(changes)\n\t\t\t} satisfies IDocumentDiff2;\n\t\t});\n\t}\n\n\tprivate readonly _editDecorationClear = this._register(new RunOnceScheduler(() => { this._editDecorations = this.modifiedModel.deltaDecorations(this._editDecorations, []); }, 500));\n\tprivate _editDecorations: string[] = [];\n\n\tprivate readonly _didAcceptOrRejectAllHunks = this._register(new Emitter<ModifiedFileEntryState.Accepted | ModifiedFileEntryState.Rejected>());\n\tpublic readonly onDidAcceptOrRejectAllHunks = this._didAcceptOrRejectAllHunks.event;\n\n\tprivate readonly _didAcceptOrRejectLines = this._register(new Emitter<acceptedOrRejectedLines>());\n\tpublic readonly onDidAcceptOrRejectLines = this._didAcceptOrRejectLines.event;\n\n\tprivate notifyHunkAction(state: 'accepted' | 'rejected', affectedLines: affectedLines) {\n\t\tif (affectedLines.lineCount > 0) {\n\t\t\tthis._didAcceptOrRejectLines.fire({ state, ...affectedLines });\n\t\t}\n\t}\n\n\tprivate _didUserEditModelFired = false;\n\tprivate readonly _didUserEditModel = this._register(new Emitter<void>());\n\tpublic readonly onDidUserEditModel = this._didUserEditModel.event;\n\n\tprivate _originalToModifiedEdit: StringEdit = StringEdit.empty;\n\n\tprivate lineChangeCount: number = 0;\n\tprivate linesAdded: number = 0;\n\tprivate linesRemoved: number = 0;\n\n\tconstructor(\n\t\tprivate readonly originalModel: ITextModel,\n\t\tprivate readonly modifiedModel: ITextModel,\n\t\tprivate readonly state: IObservable<ModifiedFileEntryState>,\n\t\tisExternalEditInProgress: (() => boolean) | undefined,\n\t\t@IEditorWorkerService private readonly _editorWorkerService: IEditorWorkerService,\n\t\t@IAccessibilitySignalService private readonly _accessibilitySignalService: IAccessibilitySignalService,\n\t) {\n\t\tsuper();\n\t\tthis._isExternalEditInProgress = isExternalEditInProgress;\n\t\tthis._register(this.modifiedModel.onDidChangeContent(e => {\n\t\t\tthis._mirrorEdits(e);\n\t\t}));\n\n\t\tthis._register(toDisposable(() => {\n\t\t\tthis.clearCurrentEditLineDecoration();\n\t\t}));\n\n\t\tthis._register(autorun(r => this.updateLineChangeCount(this._diffInfo.read(r))));\n\n\t\tif (!originalModel.equalsTextBuffer(modifiedModel.getTextBuffer())) {\n\t\t\tthis._updateDiffInfoSeq();\n\t\t}\n\t}\n\n\tprivate updateLineChangeCount(diff: IDocumentDiff) {\n\t\tthis.lineChangeCount = 0;\n\t\tthis.linesAdded = 0;\n\t\tthis.linesRemoved = 0;\n\n\t\tfor (const change of diff.changes) {\n\t\t\tconst modifiedRange = change.modified.endLineNumberExclusive - change.modified.startLineNumber;\n\t\t\tthis.linesAdded += Math.max(0, modifiedRange);\n\t\t\tconst originalRange = change.original.endLineNumberExclusive - change.original.startLineNumber;\n\t\t\tthis.linesRemoved += Math.max(0, originalRange);\n\n\t\t\tthis.lineChangeCount += Math.max(modifiedRange, originalRange);\n\t\t}\n\t}\n\n\tpublic clearCurrentEditLineDecoration() {\n\t\tif (!this.modifiedModel.isDisposed()) {\n\t\t\tthis._editDecorations = this.modifiedModel.deltaDecorations(this._editDecorations, []);\n\t\t}\n\t}\n\n\tpublic async areOriginalAndModifiedIdentical(): Promise<boolean> {\n\t\tconst diff = await this._diffOperation;\n\t\treturn diff ? diff.identical : false;\n\t}\n\n\tasync acceptAgentEdits(resource: URI, textEdits: (TextEdit | ICellEditOperation)[], isLastEdits: boolean, responseModel: IChatResponseModel | undefined): Promise<{ rewriteRatio: number; maxLineNumber: number }> {\n\n\t\tassertType(textEdits.every(TextEdit.isTextEdit), 'INVALID args, can only handle text edits');\n\t\tassert(isEqual(resource, this.modifiedModel.uri), ' INVALID args, can only edit THIS document');\n\n\t\tconst isAtomicEdits = textEdits.length > 0 && isLastEdits;\n\t\tlet maxLineNumber = 0;\n\t\tlet rewriteRatio = 0;\n\n\t\tconst source = this._createEditSource(responseModel);\n\n\t\tif (isAtomicEdits) {\n\t\t\t// EDIT and DONE\n\t\t\tconst minimalEdits = await this._editorWorkerService.computeMoreMinimalEdits(this.modifiedModel.uri, textEdits) ?? textEdits;\n\t\t\tconst ops = minimalEdits.map(TextEdit.asEditOperation);\n\t\t\tconst undoEdits = this._applyEdits(ops, source);\n\n\t\t\tif (undoEdits.length > 0) {\n\t\t\t\tlet range: Range | undefined;\n\t\t\t\tfor (let i = 0; i < undoEdits.length; i++) {\n\t\t\t\t\tconst op = undoEdits[i];\n\t\t\t\t\tif (!range) {\n\t\t\t\t\t\trange = Range.lift(op.range);\n\t\t\t\t\t} else {\n\t\t\t\t\t\trange = Range.plusRange(range, op.range);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (range) {\n\n\t\t\t\t\tconst defer = new DeferredPromise<void>();\n\t\t\t\t\tconst listener = addDisposableListener(getWindow(undefined), 'animationend', e => {\n\t\t\t\t\t\tif (e.animationName === 'kf-chat-editing-atomic-edit') { // CHECK with chat.css\n\t\t\t\t\t\t\tdefer.complete();\n\t\t\t\t\t\t\tlistener.dispose();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tthis._editDecorations = this.modifiedModel.deltaDecorations(this._editDecorations, [{\n\t\t\t\t\t\toptions: ChatEditingTextModelChangeService._atomicEditDecorationOptions,\n\t\t\t\t\t\trange\n\t\t\t\t\t}]);\n\n\t\t\t\t\tawait Promise.any([defer.p, timeout(500)]); // wait for animation to finish but also time-cap it\n\t\t\t\t\tlistener.dispose();\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t} else {\n\t\t\t// EDIT a bit, then DONE\n\t\t\tconst ops = textEdits.map(TextEdit.asEditOperation);\n\t\t\tconst undoEdits = this._applyEdits(ops, source);\n\t\t\tmaxLineNumber = undoEdits.reduce((max, op) => Math.max(max, op.range.startLineNumber), 0);\n\t\t\trewriteRatio = Math.min(1, maxLineNumber / this.modifiedModel.getLineCount());\n\n\t\t\tconst newDecorations: IModelDeltaDecoration[] = [\n\t\t\t\t// decorate pending edit (region)\n\t\t\t\t{\n\t\t\t\t\toptions: ChatEditingTextModelChangeService._pendingEditDecorationOptions,\n\t\t\t\t\trange: new Range(maxLineNumber + 1, 1, Number.MAX_SAFE_INTEGER, Number.MAX_SAFE_INTEGER)\n\t\t\t\t}\n\t\t\t];\n\n\t\t\tif (maxLineNumber > 0) {\n\t\t\t\t// decorate last edit\n\t\t\t\tnewDecorations.push({\n\t\t\t\t\toptions: ChatEditingTextModelChangeService._lastEditDecorationOptions,\n\t\t\t\t\trange: new Range(maxLineNumber, 1, maxLineNumber, Number.MAX_SAFE_INTEGER)\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis._editDecorations = this.modifiedModel.deltaDecorations(this._editDecorations, newDecorations);\n\n\t\t}\n\n\t\tif (isLastEdits) {\n\t\t\tthis._updateDiffInfoSeq();\n\t\t\tthis._editDecorationClear.schedule();\n\t\t}\n\n\t\treturn { rewriteRatio, maxLineNumber };\n\t}\n\n\tprivate _createEditSource(responseModel: IChatResponseModel | undefined) {\n\n\t\tif (!responseModel) {\n\t\t\treturn EditSources.unknown({ name: 'editSessionUndoRedo' });\n\t\t}\n\n\t\tconst sessionId = responseModel.session.sessionId;\n\t\tconst request = responseModel.session.getRequests().at(-1);\n\t\tconst languageId = this.modifiedModel.getLanguageId();\n\t\tconst agent = responseModel.agent;\n\t\tconst extensionId = VersionedExtensionId.tryCreate(agent?.extensionId.value, agent?.extensionVersion);\n\n\t\tif (responseModel.request?.locationData?.type === ChatAgentLocation.EditorInline) {\n\n\t\t\treturn EditSources.inlineChatApplyEdit({\n\t\t\t\tmodelId: request?.modelId,\n\t\t\t\trequestId: request?.id,\n\t\t\t\tsessionId,\n\t\t\t\tlanguageId,\n\t\t\t\textensionId,\n\t\t\t});\n\t\t}\n\n\t\treturn EditSources.chatApplyEdits({\n\t\t\tmodelId: request?.modelId,\n\t\t\trequestId: request?.id,\n\t\t\tsessionId,\n\t\t\tlanguageId,\n\t\t\tmode: request?.modeInfo?.modeId,\n\t\t\textensionId,\n\t\t\tcodeBlockSuggestionId: request?.modeInfo?.applyCodeBlockSuggestionId,\n\t\t});\n\t}\n\n\tprivate _applyEdits(edits: ISingleEditOperation[], source: TextModelEditSource) {\n\n\t\tif (edits.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\ttry {\n\t\t\tthis._isEditFromUs = true;\n\t\t\t// make the actual edit\n\t\t\tlet result: ISingleEditOperation[] = [];\n\n\t\t\tthis.modifiedModel.pushEditOperations(null, edits, (undoEdits) => {\n\t\t\t\tresult = undoEdits;\n\t\t\t\treturn null;\n\t\t\t}, undefined, source);\n\n\t\t\treturn result;\n\t\t} finally {\n\t\t\tthis._isEditFromUs = false;\n\t\t}\n\t}\n\n\t/**\n\t * Keeps the current modified document as the final contents.\n\t */\n\tpublic keep() {\n\t\tthis.notifyHunkAction('accepted', { linesAdded: this.linesAdded, linesRemoved: this.linesRemoved, lineCount: this.lineChangeCount, hasRemainingEdits: false });\n\t\tthis.originalModel.setValue(this.modifiedModel.createSnapshot());\n\t\tthis._reset();\n\t}\n\n\t/**\n\t * Undoes the current modified document as the final contents.\n\t */\n\tpublic undo() {\n\t\tthis.notifyHunkAction('rejected', { linesAdded: this.linesAdded, linesRemoved: this.linesRemoved, lineCount: this.lineChangeCount, hasRemainingEdits: false });\n\t\tthis.modifiedModel.pushStackElement();\n\t\tthis._applyEdits([(EditOperation.replace(this.modifiedModel.getFullModelRange(), this.originalModel.getValue()))], EditSources.chatUndoEdits());\n\t\tthis.modifiedModel.pushStackElement();\n\t\tthis._reset();\n\t}\n\n\tprivate _reset() {\n\t\tthis._originalToModifiedEdit = StringEdit.empty;\n\t\tthis._diffInfo.set(nullDocumentDiff, undefined);\n\t\tthis._didUserEditModelFired = false;\n\t}\n\n\tpublic async resetDocumentValues(newOriginal: string | ITextSnapshot | undefined, newModified: string | undefined): Promise<void> {\n\t\tlet didChange = false;\n\t\tif (newOriginal !== undefined) {\n\t\t\tthis.originalModel.setValue(newOriginal);\n\t\t\tdidChange = true;\n\t\t}\n\t\tif (newModified !== undefined && this.modifiedModel.getValue() !== newModified) {\n\t\t\t// NOTE that this isn't done via `setValue` so that the undo stack is preserved\n\t\t\tthis.modifiedModel.pushStackElement();\n\t\t\tthis._applyEdits([(EditOperation.replace(this.modifiedModel.getFullModelRange(), newModified))], EditSources.chatReset());\n\t\t\tthis.modifiedModel.pushStackElement();\n\t\t\tdidChange = true;\n\t\t}\n\t\tif (didChange) {\n\t\t\tawait this._updateDiffInfoSeq();\n\t\t}\n\t}\n\n\tprivate _mirrorEdits(event: IModelContentChangedEvent) {\n\t\tconst edit = offsetEditFromContentChanges(event.changes);\n\t\tconst isExternalEdit = this._isExternalEditInProgress?.();\n\n\t\tif (this._isEditFromUs || isExternalEdit) {\n\t\t\tconst e_sum = this._originalToModifiedEdit;\n\t\t\tconst e_ai = edit;\n\t\t\tthis._originalToModifiedEdit = e_sum.compose(e_ai);\n\t\t\tif (isExternalEdit) {\n\t\t\t\tthis._updateDiffInfoSeq();\n\t\t\t}\n\t\t} else {\n\n\t\t\t//           e_ai\n\t\t\t//   d0 ---------------> s0\n\t\t\t//   |                   |\n\t\t\t//   |                   |\n\t\t\t//   | e_user_r          | e_user\n\t\t\t//   |                   |\n\t\t\t//   |                   |\n\t\t\t//   v       e_ai_r      v\n\t\t\t///  d1 ---------------> s1\n\t\t\t//\n\t\t\t// d0 - document snapshot\n\t\t\t// s0 - document\n\t\t\t// e_ai - ai edits\n\t\t\t// e_user - user edits\n\t\t\t//\n\t\t\tconst e_ai = this._originalToModifiedEdit;\n\t\t\tconst e_user = edit;\n\n\t\t\tconst e_user_r = e_user.tryRebase(e_ai.inverse(this.originalModel.getValue()));\n\n\t\t\tif (e_user_r === undefined) {\n\t\t\t\t// user edits overlaps/conflicts with AI edits\n\t\t\t\tthis._originalToModifiedEdit = e_ai.compose(e_user);\n\t\t\t} else {\n\t\t\t\tconst edits = offsetEditToEditOperations(e_user_r, this.originalModel);\n\t\t\t\tthis.originalModel.applyEdits(edits);\n\t\t\t\tthis._originalToModifiedEdit = e_ai.rebaseSkipConflicting(e_user_r);\n\t\t\t}\n\n\t\t\tthis._allEditsAreFromUs = false;\n\t\t\tthis._updateDiffInfoSeq();\n\t\t\tif (!this._didUserEditModelFired) {\n\t\t\t\tthis._didUserEditModelFired = true;\n\t\t\t\tthis._didUserEditModel.fire();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async _keepHunk(change: DetailedLineRangeMapping): Promise<boolean> {\n\t\tif (!this._diffInfo.get().changes.includes(change)) {\n\t\t\t// diffInfo should have model version ids and check them (instead of the caller doing that)\n\t\t\treturn false;\n\t\t}\n\t\tconst edits: ISingleEditOperation[] = [];\n\t\tfor (const edit of change.innerChanges ?? []) {\n\t\t\tconst newText = this.modifiedModel.getValueInRange(edit.modifiedRange);\n\t\t\tedits.push(EditOperation.replace(edit.originalRange, newText));\n\t\t}\n\t\tthis.originalModel.pushEditOperations(null, edits, _ => null);\n\t\tawait this._updateDiffInfoSeq('accepted');\n\t\tif (this._diffInfo.get().identical) {\n\t\t\tthis._didAcceptOrRejectAllHunks.fire(ModifiedFileEntryState.Accepted);\n\t\t}\n\t\tthis._accessibilitySignalService.playSignal(AccessibilitySignal.editsKept, { allowManyInParallel: true });\n\t\treturn true;\n\t}\n\n\tprivate async _undoHunk(change: DetailedLineRangeMapping): Promise<boolean> {\n\t\tif (!this._diffInfo.get().changes.includes(change)) {\n\t\t\treturn false;\n\t\t}\n\t\tconst edits: ISingleEditOperation[] = [];\n\t\tfor (const edit of change.innerChanges ?? []) {\n\t\t\tconst newText = this.originalModel.getValueInRange(edit.originalRange);\n\t\t\tedits.push(EditOperation.replace(edit.modifiedRange, newText));\n\t\t}\n\t\tthis.modifiedModel.pushEditOperations(null, edits, _ => null);\n\t\tawait this._updateDiffInfoSeq('rejected');\n\t\tif (this._diffInfo.get().identical) {\n\t\t\tthis._didAcceptOrRejectAllHunks.fire(ModifiedFileEntryState.Rejected);\n\t\t}\n\t\tthis._accessibilitySignalService.playSignal(AccessibilitySignal.editsUndone, { allowManyInParallel: true });\n\t\treturn true;\n\t}\n\n\n\tprivate async _updateDiffInfoSeq(notifyAction: 'accepted' | 'rejected' | undefined = undefined) {\n\t\tconst myDiffOperationId = ++this._diffOperationIds;\n\t\tawait Promise.resolve(this._diffOperation);\n\t\tconst previousCount = this.lineChangeCount;\n\t\tconst previousAdded = this.linesAdded;\n\t\tconst previousRemoved = this.linesRemoved;\n\t\tif (this._diffOperationIds === myDiffOperationId) {\n\t\t\tconst thisDiffOperation = this._updateDiffInfo();\n\t\t\tthis._diffOperation = thisDiffOperation;\n\t\t\tawait thisDiffOperation;\n\t\t\tif (notifyAction) {\n\t\t\t\tconst affectedLines = {\n\t\t\t\t\tlinesAdded: previousAdded - this.linesAdded,\n\t\t\t\t\tlinesRemoved: previousRemoved - this.linesRemoved,\n\t\t\t\t\tlineCount: previousCount - this.lineChangeCount,\n\t\t\t\t\thasRemainingEdits: this.lineChangeCount > 0\n\t\t\t\t};\n\t\t\t\tthis.notifyHunkAction(notifyAction, affectedLines);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic hasHunkAt(range: IRange) {\n\t\t// return true if the range overlaps a diff range\n\t\treturn this._diffInfo.get().changes.some(c => c.modified.intersectsStrict(LineRange.fromRangeInclusive(range)));\n\t}\n\n\tprivate async _updateDiffInfo(): Promise<IDocumentDiff | undefined> {\n\n\t\tif (this.originalModel.isDisposed() || this.modifiedModel.isDisposed() || this._store.isDisposed) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (this.state.get() !== ModifiedFileEntryState.Modified) {\n\t\t\tthis._diffInfo.set(nullDocumentDiff, undefined);\n\t\t\tthis._originalToModifiedEdit = StringEdit.empty;\n\t\t\treturn nullDocumentDiff;\n\t\t}\n\n\t\tconst docVersionNow = this.modifiedModel.getVersionId();\n\t\tconst snapshotVersionNow = this.originalModel.getVersionId();\n\n\t\tconst diff = await this._editorWorkerService.computeDiff(\n\t\t\tthis.originalModel.uri,\n\t\t\tthis.modifiedModel.uri,\n\t\t\t{\n\t\t\t\tignoreTrimWhitespace: false, // NEVER ignore whitespace so that undo/accept edits are correct and so that all changes (1 of 2) are spelled out\n\t\t\t\tcomputeMoves: false,\n\t\t\t\tmaxComputationTimeMs: 3000\n\t\t\t},\n\t\t\t'advanced'\n\t\t);\n\n\t\tif (this.originalModel.isDisposed() || this.modifiedModel.isDisposed() || this._store.isDisposed) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\t// only update the diff if the documents didn't change in the meantime\n\t\tif (this.modifiedModel.getVersionId() === docVersionNow && this.originalModel.getVersionId() === snapshotVersionNow) {\n\t\t\tconst diff2 = diff ?? nullDocumentDiff;\n\t\t\tthis._diffInfo.set(diff2, undefined);\n\t\t\tthis._originalToModifiedEdit = offsetEditFromLineRangeMapping(this.originalModel, this.modifiedModel, diff2.changes);\n\t\t\treturn diff2;\n\t\t}\n\t\treturn undefined;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { addDisposableListener, getWindow } from '../../../../../base/browser/dom.js';\nimport { assert } from '../../../../../base/common/assert.js';\nimport { DeferredPromise, RunOnceScheduler, timeout } from '../../../../../base/common/async.js';\nimport { Emitter } from '../../../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { autorun, IObservable, observableValue } from '../../../../../base/common/observable.js';\nimport { isEqual } from '../../../../../base/common/resources.js';\nimport { themeColorFromId } from '../../../../../base/common/themables.js';\nimport { assertType } from '../../../../../base/common/types.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { EditOperation, ISingleEditOperation } from '../../../../../editor/common/core/editOperation.js';\nimport { StringEdit } from '../../../../../editor/common/core/edits/stringEdit.js';\nimport { IRange, Range } from '../../../../../editor/common/core/range.js';\nimport { LineRange } from '../../../../../editor/common/core/ranges/lineRange.js';\nimport { IDocumentDiff, nullDocumentDiff } from '../../../../../editor/common/diff/documentDiffProvider.js';\nimport { DetailedLineRangeMapping } from '../../../../../editor/common/diff/rangeMapping.js';\nimport { TextEdit, VersionedExtensionId } from '../../../../../editor/common/languages.js';\nimport { IModelDeltaDecoration, ITextModel, ITextSnapshot, MinimapPosition, OverviewRulerLane } from '../../../../../editor/common/model.js';\nimport { ModelDecorationOptions } from '../../../../../editor/common/model/textModel.js';\nimport { offsetEditFromContentChanges, offsetEditFromLineRangeMapping, offsetEditToEditOperations } from '../../../../../editor/common/model/textModelStringEdit.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { EditSources, TextModelEditSource } from '../../../../../editor/common/textModelEditSource.js';\nimport { IModelContentChangedEvent } from '../../../../../editor/common/textModelEvents.js';\nimport { AccessibilitySignal, IAccessibilitySignalService } from '../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js';\nimport { editorSelectionBackground } from '../../../../../platform/theme/common/colorRegistry.js';\nimport { ICellEditOperation } from '../../../notebook/common/notebookCommon.js';\nimport { ModifiedFileEntryState } from '../../common/chatEditingService.js';\nimport { IChatResponseModel } from '../../common/chatModel.js';\nimport { ChatAgentLocation } from '../../common/constants.js';\nimport { IDocumentDiff2 } from './chatEditingCodeEditorIntegration.js';\nimport { pendingRewriteMinimap } from './chatEditingModifiedFileEntry.js';\n\ntype affectedLines = { linesAdded: number; linesRemoved: number; lineCount: number; hasRemainingEdits: boolean };\ntype acceptedOrRejectedLines = affectedLines & { state: 'accepted' | 'rejected' };\n\nexport class ChatEditingTextModelChangeService extends Disposable {\n\n\tprivate static readonly _lastEditDecorationOptions = ModelDecorationOptions.register({\n\t\tisWholeLine: true,\n\t\tdescription: 'chat-last-edit',\n\t\tclassName: 'chat-editing-last-edit-line',\n\t\tmarginClassName: 'chat-editing-last-edit',\n\t\toverviewRuler: {\n\t\t\tposition: OverviewRulerLane.Full,\n\t\t\tcolor: themeColorFromId(editorSelectionBackground)\n\t\t},\n\t});\n\n\tprivate static readonly _pendingEditDecorationOptions = ModelDecorationOptions.register({\n\t\tisWholeLine: true,\n\t\tdescription: 'chat-pending-edit',\n\t\tclassName: 'chat-editing-pending-edit',\n\t\tminimap: {\n\t\t\tposition: MinimapPosition.Inline,\n\t\t\tcolor: themeColorFromId(pendingRewriteMinimap)\n\t\t}\n\t});\n\n\tprivate static readonly _atomicEditDecorationOptions = ModelDecorationOptions.register({\n\t\tisWholeLine: true,\n\t\tdescription: 'chat-atomic-edit',\n\t\tclassName: 'chat-editing-atomic-edit',\n\t\tminimap: {\n\t\t\tposition: MinimapPosition.Inline,\n\t\t\tcolor: themeColorFromId(pendingRewriteMinimap)\n\t\t}\n\t});\n\n\tprivate _isEditFromUs: boolean = false;\n\tpublic get isEditFromUs() {\n\t\treturn this._isEditFromUs;\n\t}\n\tprivate _allEditsAreFromUs: boolean = true;\n\tpublic get allEditsAreFromUs() {\n\t\treturn this._allEditsAreFromUs;\n\t}\n\tprivate _isExternalEditInProgress: (() => boolean) | undefined;\n\tprivate _diffOperation: Promise<IDocumentDiff | undefined> | undefined;\n\tprivate _diffOperationIds: number = 0;\n\n\tprivate readonly _diffInfo = observableValue<IDocumentDiff>(this, nullDocumentDiff);\n\tpublic get diffInfo() {\n\t\treturn this._diffInfo.map(value => {\n\t\t\treturn {\n\t\t\t\t...value,\n\t\t\t\toriginalModel: this.originalModel,\n\t\t\t\tmodifiedModel: this.modifiedModel,\n\t\t\t\tkeep: changes => this._keepHunk(changes),\n\t\t\t\tundo: changes => this._undoHunk(changes)\n\t\t\t} satisfies IDocumentDiff2;\n\t\t});\n\t}\n\n\tprivate readonly _editDecorationClear = this._register(new RunOnceScheduler(() => { this._editDecorations = this.modifiedModel.deltaDecorations(this._editDecorations, []); }, 500));\n\tprivate _editDecorations: string[] = [];\n\n\tprivate readonly _didAcceptOrRejectAllHunks = this._register(new Emitter<ModifiedFileEntryState.Accepted | ModifiedFileEntryState.Rejected>());\n\tpublic readonly onDidAcceptOrRejectAllHunks = this._didAcceptOrRejectAllHunks.event;\n\n\tprivate readonly _didAcceptOrRejectLines = this._register(new Emitter<acceptedOrRejectedLines>());\n\tpublic readonly onDidAcceptOrRejectLines = this._didAcceptOrRejectLines.event;\n\n\tprivate notifyHunkAction(state: 'accepted' | 'rejected', affectedLines: affectedLines) {\n\t\tif (affectedLines.lineCount > 0) {\n\t\t\tthis._didAcceptOrRejectLines.fire({ state, ...affectedLines });\n\t\t}\n\t}\n\n\tprivate _didUserEditModelFired = false;\n\tprivate readonly _didUserEditModel = this._register(new Emitter<void>());\n\tpublic readonly onDidUserEditModel = this._didUserEditModel.event;\n\n\tprivate _originalToModifiedEdit: StringEdit = StringEdit.empty;\n\n\tprivate lineChangeCount: number = 0;\n\tprivate linesAdded: number = 0;\n\tprivate linesRemoved: number = 0;\n\n\tconstructor(\n\t\tprivate readonly originalModel: ITextModel,\n\t\tprivate readonly modifiedModel: ITextModel,\n\t\tprivate readonly state: IObservable<ModifiedFileEntryState>,\n\t\tisExternalEditInProgress: (() => boolean) | undefined,\n\t\t@IEditorWorkerService private readonly _editorWorkerService: IEditorWorkerService,\n\t\t@IAccessibilitySignalService private readonly _accessibilitySignalService: IAccessibilitySignalService,\n\t) {\n\t\tsuper();\n\t\tthis._isExternalEditInProgress = isExternalEditInProgress;\n\t\tthis._register(this.modifiedModel.onDidChangeContent(e => {\n\t\t\tthis._mirrorEdits(e);\n\t\t}));\n\n\t\tthis._register(toDisposable(() => {\n\t\t\tthis.clearCurrentEditLineDecoration();\n\t\t}));\n\n\t\tthis._register(autorun(r => this.updateLineChangeCount(this._diffInfo.read(r))));\n\n\t\tif (!originalModel.equalsTextBuffer(modifiedModel.getTextBuffer())) {\n\t\t\tthis._updateDiffInfoSeq();\n\t\t}\n\t}\n\n\tprivate updateLineChangeCount(diff: IDocumentDiff) {\n\t\tthis.lineChangeCount = 0;\n\t\tthis.linesAdded = 0;\n\t\tthis.linesRemoved = 0;\n\n\t\tfor (const change of diff.changes) {\n\t\t\tconst modifiedRange = change.modified.endLineNumberExclusive - change.modified.startLineNumber;\n\t\t\tthis.linesAdded += Math.max(0, modifiedRange);\n\t\t\tconst originalRange = change.original.endLineNumberExclusive - change.original.startLineNumber;\n\t\t\tthis.linesRemoved += Math.max(0, originalRange);\n\n\t\t\tthis.lineChangeCount += Math.max(modifiedRange, originalRange);\n\t\t}\n\t}\n\n\tpublic clearCurrentEditLineDecoration() {\n\t\tif (!this.modifiedModel.isDisposed()) {\n\t\t\tthis._editDecorations = this.modifiedModel.deltaDecorations(this._editDecorations, []);\n\t\t}\n\t}\n\n\tpublic async areOriginalAndModifiedIdentical(): Promise<boolean> {\n\t\tconst diff = await this._diffOperation;\n\t\treturn diff ? diff.identical : false;\n\t}\n\n\tasync acceptAgentEdits(resource: URI, textEdits: (TextEdit | ICellEditOperation)[], isLastEdits: boolean, responseModel: IChatResponseModel | undefined): Promise<{ rewriteRatio: number; maxLineNumber: number }> {\n\n\t\tassertType(textEdits.every(TextEdit.isTextEdit), 'INVALID args, can only handle text edits');\n\t\tassert(isEqual(resource, this.modifiedModel.uri), ' INVALID args, can only edit THIS document');\n\n\t\tconst isAtomicEdits = textEdits.length > 0 && isLastEdits;\n\t\tlet maxLineNumber = 0;\n\t\tlet rewriteRatio = 0;\n\n\t\tconst source = this._createEditSource(responseModel);\n\n\t\tif (isAtomicEdits) {\n\t\t\t// EDIT and DONE\n\t\t\tconst minimalEdits = await this._editorWorkerService.computeMoreMinimalEdits(this.modifiedModel.uri, textEdits) ?? textEdits;\n\t\t\tconst ops = minimalEdits.map(TextEdit.asEditOperation);\n\t\t\tconst undoEdits = this._applyEdits(ops, source);\n\n\t\t\tif (undoEdits.length > 0) {\n\t\t\t\tlet range: Range | undefined;\n\t\t\t\tfor (let i = 0; i < undoEdits.length; i++) {\n\t\t\t\t\tconst op = undoEdits[i];\n\t\t\t\t\tif (!range) {\n\t\t\t\t\t\trange = Range.lift(op.range);\n\t\t\t\t\t} else {\n\t\t\t\t\t\trange = Range.plusRange(range, op.range);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (range) {\n\n\t\t\t\t\tconst defer = new DeferredPromise<void>();\n\t\t\t\t\tconst listener = addDisposableListener(getWindow(undefined), 'animationend', e => {\n\t\t\t\t\t\tif (e.animationName === 'kf-chat-editing-atomic-edit') { // CHECK with chat.css\n\t\t\t\t\t\t\tdefer.complete();\n\t\t\t\t\t\t\tlistener.dispose();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tthis._editDecorations = this.modifiedModel.deltaDecorations(this._editDecorations, [{\n\t\t\t\t\t\toptions: ChatEditingTextModelChangeService._atomicEditDecorationOptions,\n\t\t\t\t\t\trange\n\t\t\t\t\t}]);\n\n\t\t\t\t\tawait Promise.any([defer.p, timeout(500)]); // wait for animation to finish but also time-cap it\n\t\t\t\t\tlistener.dispose();\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t} else {\n\t\t\t// EDIT a bit, then DONE\n\t\t\tconst ops = textEdits.map(TextEdit.asEditOperation);\n\t\t\tconst undoEdits = this._applyEdits(ops, source);\n\t\t\tmaxLineNumber = undoEdits.reduce((max, op) => Math.max(max, op.range.startLineNumber), 0);\n\t\t\trewriteRatio = Math.min(1, maxLineNumber / this.modifiedModel.getLineCount());\n\n\t\t\tconst newDecorations: IModelDeltaDecoration[] = [\n\t\t\t\t// decorate pending edit (region)\n\t\t\t\t{\n\t\t\t\t\toptions: ChatEditingTextModelChangeService._pendingEditDecorationOptions,\n\t\t\t\t\trange: new Range(maxLineNumber + 1, 1, Number.MAX_SAFE_INTEGER, Number.MAX_SAFE_INTEGER)\n\t\t\t\t}\n\t\t\t];\n\n\t\t\tif (maxLineNumber > 0) {\n\t\t\t\t// decorate last edit\n\t\t\t\tnewDecorations.push({\n\t\t\t\t\toptions: ChatEditingTextModelChangeService._lastEditDecorationOptions,\n\t\t\t\t\trange: new Range(maxLineNumber, 1, maxLineNumber, Number.MAX_SAFE_INTEGER)\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis._editDecorations = this.modifiedModel.deltaDecorations(this._editDecorations, newDecorations);\n\n\t\t}\n\n\t\tif (isLastEdits) {\n\t\t\tthis._updateDiffInfoSeq();\n\t\t\tthis._editDecorationClear.schedule();\n\t\t}\n\n\t\treturn { rewriteRatio, maxLineNumber };\n\t}\n\n\tprivate _createEditSource(responseModel: IChatResponseModel | undefined) {\n\n\t\tif (!responseModel) {\n\t\t\treturn EditSources.unknown({ name: 'editSessionUndoRedo' });\n\t\t}\n\n\t\tconst sessionId = responseModel.session.sessionId;\n\t\tconst request = responseModel.session.getRequests().at(-1);\n\t\tconst languageId = this.modifiedModel.getLanguageId();\n\t\tconst agent = responseModel.agent;\n\t\tconst extensionId = VersionedExtensionId.tryCreate(agent?.extensionId.value, agent?.extensionVersion);\n\n\t\tif (responseModel.request?.locationData?.type === ChatAgentLocation.EditorInline) {\n\n\t\t\treturn EditSources.inlineChatApplyEdit({\n\t\t\t\tmodelId: request?.modelId,\n\t\t\t\trequestId: request?.id,\n\t\t\t\tsessionId,\n\t\t\t\tlanguageId,\n\t\t\t\textensionId,\n\t\t\t});\n\t\t}\n\n\t\treturn EditSources.chatApplyEdits({\n\t\t\tmodelId: request?.modelId,\n\t\t\trequestId: request?.id,\n\t\t\tsessionId,\n\t\t\tlanguageId,\n\t\t\tmode: request?.modeInfo?.modeId,\n\t\t\textensionId,\n\t\t\tcodeBlockSuggestionId: request?.modeInfo?.applyCodeBlockSuggestionId,\n\t\t});\n\t}\n\n\tprivate _applyEdits(edits: ISingleEditOperation[], source: TextModelEditSource) {\n\n\t\tif (edits.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\ttry {\n\t\t\tthis._isEditFromUs = true;\n\t\t\t// make the actual edit\n\t\t\tlet result: ISingleEditOperation[] = [];\n\n\t\t\tthis.modifiedModel.pushEditOperations(null, edits, (undoEdits) => {\n\t\t\t\tresult = undoEdits;\n\t\t\t\treturn null;\n\t\t\t}, undefined, source);\n\n\t\t\treturn result;\n\t\t} finally {\n\t\t\tthis._isEditFromUs = false;\n\t\t}\n\t}\n\n\t/**\n\t * Keeps the current modified document as the final contents.\n\t */\n\tpublic keep() {\n\t\tthis.notifyHunkAction('accepted', { linesAdded: this.linesAdded, linesRemoved: this.linesRemoved, lineCount: this.lineChangeCount, hasRemainingEdits: false });\n\t\tthis.originalModel.setValue(this.modifiedModel.createSnapshot());\n\t\tthis._reset();\n\t}\n\n\t/**\n\t * Undoes the current modified document as the final contents.\n\t */\n\tpublic undo() {\n\t\tthis.notifyHunkAction('rejected', { linesAdded: this.linesAdded, linesRemoved: this.linesRemoved, lineCount: this.lineChangeCount, hasRemainingEdits: false });\n\t\tthis.modifiedModel.pushStackElement();\n\t\tthis._applyEdits([(EditOperation.replace(this.modifiedModel.getFullModelRange(), this.originalModel.getValue()))], EditSources.chatUndoEdits());\n\t\tthis.modifiedModel.pushStackElement();\n\t\tthis._reset();\n\t}\n\n\tprivate _reset() {\n\t\tthis._originalToModifiedEdit = StringEdit.empty;\n\t\tthis._diffInfo.set(nullDocumentDiff, undefined);\n\t\tthis._didUserEditModelFired = false;\n\t}\n\n\tpublic async resetDocumentValues(newOriginal: string | ITextSnapshot | undefined, newModified: string | undefined): Promise<void> {\n\t\tlet didChange = false;\n\t\tif (newOriginal !== undefined) {\n\t\t\tthis.originalModel.setValue(newOriginal);\n\t\t\tdidChange = true;\n\t\t}\n\t\tif (newModified !== undefined && this.modifiedModel.getValue() !== newModified) {\n\t\t\t// NOTE that this isn't done via `setValue` so that the undo stack is preserved\n\t\t\tthis.modifiedModel.pushStackElement();\n\t\t\tthis._applyEdits([(EditOperation.replace(this.modifiedModel.getFullModelRange(), newModified))], EditSources.chatReset());\n\t\t\tthis.modifiedModel.pushStackElement();\n\t\t\tdidChange = true;\n\t\t}\n\t\tif (didChange) {\n\t\t\tawait this._updateDiffInfoSeq();\n\t\t}\n\t}\n\n\tprivate _mirrorEdits(event: IModelContentChangedEvent) {\n\t\tconst edit = offsetEditFromContentChanges(event.changes);\n\t\tconst isExternalEdit = this._isExternalEditInProgress?.();\n\n\t\tif (this._isEditFromUs || isExternalEdit) {\n\t\t\tconst e_sum = this._originalToModifiedEdit;\n\t\t\tconst e_ai = edit;\n\t\t\tthis._originalToModifiedEdit = e_sum.compose(e_ai);\n\t\t\tif (isExternalEdit) {\n\t\t\t\tthis._updateDiffInfoSeq();\n\t\t\t}\n\t\t} else {\n\n\t\t\t//           e_ai\n\t\t\t//   d0 ---------------> s0\n\t\t\t//   |                   |\n\t\t\t//   |                   |\n\t\t\t//   | e_user_r          | e_user\n\t\t\t//   |                   |\n\t\t\t//   |                   |\n\t\t\t//   v       e_ai_r      v\n\t\t\t///  d1 ---------------> s1\n\t\t\t//\n\t\t\t// d0 - document snapshot\n\t\t\t// s0 - document\n\t\t\t// e_ai - ai edits\n\t\t\t// e_user - user edits\n\t\t\t//\n\t\t\tconst e_ai = this._originalToModifiedEdit;\n\t\t\tconst e_user = edit;\n\n\t\t\tconst e_user_r = e_user.tryRebase(e_ai.inverse(this.originalModel.getValue()));\n\n\t\t\tif (e_user_r === undefined) {\n\t\t\t\t// user edits overlaps/conflicts with AI edits\n\t\t\t\tthis._originalToModifiedEdit = e_ai.compose(e_user);\n\t\t\t} else {\n\t\t\t\tconst edits = offsetEditToEditOperations(e_user_r, this.originalModel);\n\t\t\t\tthis.originalModel.applyEdits(edits);\n\t\t\t\tthis._originalToModifiedEdit = e_ai.rebaseSkipConflicting(e_user_r);\n\t\t\t}\n\n\t\t\tthis._allEditsAreFromUs = false;\n\t\t\tthis._updateDiffInfoSeq();\n\t\t\tif (!this._didUserEditModelFired) {\n\t\t\t\tthis._didUserEditModelFired = true;\n\t\t\t\tthis._didUserEditModel.fire();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async _keepHunk(change: DetailedLineRangeMapping): Promise<boolean> {\n\t\tif (!this._diffInfo.get().changes.includes(change)) {\n\t\t\t// diffInfo should have model version ids and check them (instead of the caller doing that)\n\t\t\treturn false;\n\t\t}\n\t\tconst edits: ISingleEditOperation[] = [];\n\t\tfor (const edit of change.innerChanges ?? []) {\n\t\t\tconst newText = this.modifiedModel.getValueInRange(edit.modifiedRange);\n\t\t\tedits.push(EditOperation.replace(edit.originalRange, newText));\n\t\t}\n\t\tthis.originalModel.pushEditOperations(null, edits, _ => null);\n\t\tawait this._updateDiffInfoSeq('accepted');\n\t\tif (this._diffInfo.get().identical) {\n\t\t\tthis._didAcceptOrRejectAllHunks.fire(ModifiedFileEntryState.Accepted);\n\t\t}\n\t\tthis._accessibilitySignalService.playSignal(AccessibilitySignal.editsKept, { allowManyInParallel: true });\n\t\treturn true;\n\t}\n\n\tprivate async _undoHunk(change: DetailedLineRangeMapping): Promise<boolean> {\n\t\tif (!this._diffInfo.get().changes.includes(change)) {\n\t\t\treturn false;\n\t\t}\n\t\tconst edits: ISingleEditOperation[] = [];\n\t\tfor (const edit of change.innerChanges ?? []) {\n\t\t\tconst newText = this.originalModel.getValueInRange(edit.originalRange);\n\t\t\tedits.push(EditOperation.replace(edit.modifiedRange, newText));\n\t\t}\n\t\tthis.modifiedModel.pushEditOperations(null, edits, _ => null);\n\t\tawait this._updateDiffInfoSeq('rejected');\n\t\tif (this._diffInfo.get().identical) {\n\t\t\tthis._didAcceptOrRejectAllHunks.fire(ModifiedFileEntryState.Rejected);\n\t\t}\n\t\tthis._accessibilitySignalService.playSignal(AccessibilitySignal.editsUndone, { allowManyInParallel: true });\n\t\treturn true;\n\t}\n\n\n\tprivate async _updateDiffInfoSeq(notifyAction: 'accepted' | 'rejected' | undefined = undefined) {\n\t\tconst myDiffOperationId = ++this._diffOperationIds;\n\t\tawait Promise.resolve(this._diffOperation);\n\t\tconst previousCount = this.lineChangeCount;\n\t\tconst previousAdded = this.linesAdded;\n\t\tconst previousRemoved = this.linesRemoved;\n\t\tif (this._diffOperationIds === myDiffOperationId) {\n\t\t\tconst thisDiffOperation = this._updateDiffInfo();\n\t\t\tthis._diffOperation = thisDiffOperation;\n\t\t\tawait thisDiffOperation;\n\t\t\tif (notifyAction) {\n\t\t\t\tconst affectedLines = {\n\t\t\t\t\tlinesAdded: previousAdded - this.linesAdded,\n\t\t\t\t\tlinesRemoved: previousRemoved - this.linesRemoved,\n\t\t\t\t\tlineCount: previousCount - this.lineChangeCount,\n\t\t\t\t\thasRemainingEdits: this.lineChangeCount > 0\n\t\t\t\t};\n\t\t\t\tthis.notifyHunkAction(notifyAction, affectedLines);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic hasHunkAt(range: IRange) {\n\t\t// return true if the range overlaps a diff range\n\t\treturn this._diffInfo.get().changes.some(c => c.modified.intersectsStrict(LineRange.fromRangeInclusive(range)));\n\t}\n\n\tprivate async _updateDiffInfo(): Promise<IDocumentDiff | undefined> {\n\n\t\tif (this.originalModel.isDisposed() || this.modifiedModel.isDisposed() || this._store.isDisposed) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (this.state.get() !== ModifiedFileEntryState.Modified) {\n\t\t\tthis._diffInfo.set(nullDocumentDiff, undefined);\n\t\t\tthis._originalToModifiedEdit = StringEdit.empty;\n\t\t\treturn nullDocumentDiff;\n\t\t}\n\n\t\tconst docVersionNow = this.modifiedModel.getVersionId();\n\t\tconst snapshotVersionNow = this.originalModel.getVersionId();\n\n\t\tconst diff = await this._editorWorkerService.computeDiff(\n\t\t\tthis.originalModel.uri,\n\t\t\tthis.modifiedModel.uri,\n\t\t\t{\n\t\t\t\tignoreTrimWhitespace: false, // NEVER ignore whitespace so that undo/accept edits are correct and so that all changes (1 of 2) are spelled out\n\t\t\t\tcomputeMoves: false,\n\t\t\t\tmaxComputationTimeMs: 3000\n\t\t\t},\n\t\t\t'advanced'\n\t\t);\n\n\t\tif (this.originalModel.isDisposed() || this.modifiedModel.isDisposed() || this._store.isDisposed) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\t// only update the diff if the documents didn't change in the meantime\n\t\tif (this.modifiedModel.getVersionId() === docVersionNow && this.originalModel.getVersionId() === snapshotVersionNow) {\n\t\t\tconst diff2 = diff ?? nullDocumentDiff;\n\t\t\tthis._diffInfo.set(diff2, undefined);\n\t\t\tthis._originalToModifiedEdit = offsetEditFromLineRangeMapping(this.originalModel, this.modifiedModel, diff2.changes);\n\t\t\treturn diff2;\n\t\t}\n\t\treturn undefined;\n\t}\n}\n"]}