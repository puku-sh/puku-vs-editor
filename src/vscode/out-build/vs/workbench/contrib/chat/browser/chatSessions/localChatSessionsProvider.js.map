{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/browser/chatSessions/localChatSessionsProvider.ts","vs/workbench/contrib/chat/browser/chatSessions/localChatSessionsProvider.ts"],"names":[],"mappings":"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","file":"localChatSessionsProvider.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Codicon } from '../../../../../base/common/codicons.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { ResourceSet } from '../../../../../base/common/map.js';\nimport { IObservable } from '../../../../../base/common/observable.js';\nimport { IWorkbenchContribution } from '../../../../common/contributions.js';\nimport { ModifiedFileEntryState } from '../../common/chatEditingService.js';\nimport { IChatModel } from '../../common/chatModel.js';\nimport { IChatService } from '../../common/chatService.js';\nimport { ChatSessionStatus, IChatSessionItem, IChatSessionItemProvider, IChatSessionsService, localChatSessionType } from '../../common/chatSessionsService.js';\nimport { ChatAgentLocation } from '../../common/constants.js';\nimport { IChatWidget, IChatWidgetService, isIChatViewViewContext } from '../chat.js';\nimport { ChatSessionItemWithProvider } from './common.js';\n\nexport class LocalChatSessionsProvider extends Disposable implements IChatSessionItemProvider, IWorkbenchContribution {\n\tstatic readonly ID = 'workbench.contrib.localChatSessionsProvider';\n\tstatic readonly CHAT_WIDGET_VIEW_ID = 'workbench.panel.chat.view.copilot';\n\treadonly chatSessionType = localChatSessionType;\n\n\tprivate readonly _onDidChange = this._register(new Emitter<void>());\n\treadonly onDidChange: Event<void> = this._onDidChange.event;\n\n\treadonly _onDidChangeChatSessionItems = this._register(new Emitter<void>());\n\tpublic get onDidChangeChatSessionItems() { return this._onDidChangeChatSessionItems.event; }\n\n\tconstructor(\n\t\t@IChatWidgetService private readonly chatWidgetService: IChatWidgetService,\n\t\t@IChatService private readonly chatService: IChatService,\n\t\t@IChatSessionsService private readonly chatSessionsService: IChatSessionsService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(this.chatSessionsService.registerChatSessionItemProvider(this));\n\n\t\tthis.registerWidgetListeners();\n\n\t\tthis._register(this.chatService.onDidDisposeSession(() => {\n\t\t\tthis._onDidChange.fire();\n\t\t}));\n\n\t\t// Listen for global session items changes for our session type\n\t\tthis._register(this.chatSessionsService.onDidChangeSessionItems((sessionType) => {\n\t\t\tif (sessionType === this.chatSessionType) {\n\t\t\t\tthis._onDidChange.fire();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate registerWidgetListeners(): void {\n\t\t// Listen for new chat widgets being added/removed\n\t\tthis._register(this.chatWidgetService.onDidAddWidget(widget => {\n\t\t\t// Only fire for chat view instance\n\t\t\tif (widget.location === ChatAgentLocation.Chat &&\n\t\t\t\tisIChatViewViewContext(widget.viewContext) &&\n\t\t\t\twidget.viewContext.viewId === LocalChatSessionsProvider.CHAT_WIDGET_VIEW_ID) {\n\t\t\t\tthis._onDidChange.fire();\n\t\t\t\tthis._registerWidgetModelListeners(widget);\n\t\t\t}\n\t\t}));\n\n\t\t// Check for existing chat widgets and register listeners\n\t\tconst existingWidgets = this.chatWidgetService.getWidgetsByLocations(ChatAgentLocation.Chat)\n\t\t\t.filter(widget => isIChatViewViewContext(widget.viewContext) && widget.viewContext.viewId === LocalChatSessionsProvider.CHAT_WIDGET_VIEW_ID);\n\n\t\texistingWidgets.forEach(widget => {\n\t\t\tthis._registerWidgetModelListeners(widget);\n\t\t});\n\t}\n\n\tprivate _registerWidgetModelListeners(widget: IChatWidget): void {\n\t\tconst register = () => {\n\t\t\tthis.registerModelTitleListener(widget);\n\t\t\tif (widget.viewModel) {\n\t\t\t\tthis.registerProgressListener(widget.viewModel.model.requestInProgress);\n\t\t\t}\n\t\t};\n\t\t// Listen for view model changes on this widget\n\t\tthis._register(widget.onDidChangeViewModel(() => {\n\t\t\tregister();\n\t\t\tthis._onDidChangeChatSessionItems.fire();\n\t\t}));\n\n\t\tregister();\n\t}\n\tprivate registerProgressListener(observable: IObservable<boolean>) {\n\t\tconst progressEvent = Event.fromObservableLight(observable);\n\t\tthis._register(progressEvent(() => {\n\t\t\tthis._onDidChangeChatSessionItems.fire();\n\t\t}));\n\t}\n\n\tprivate registerModelTitleListener(widget: IChatWidget): void {\n\t\tconst model = widget.viewModel?.model;\n\t\tif (model) {\n\t\t\t// Listen for model changes, specifically for title changes via setCustomTitle\n\t\t\tthis._register(model.onDidChange((e) => {\n\t\t\t\t// Fire change events for all title-related changes to refresh the tree\n\t\t\t\tif (!e || e.kind === 'setCustomTitle') {\n\t\t\t\t\tthis._onDidChange.fire();\n\t\t\t\t}\n\t\t\t}));\n\t\t}\n\t}\n\n\tprivate modelToStatus(model: IChatModel): ChatSessionStatus | undefined {\n\t\tif (model.requestInProgress.get()) {\n\t\t\treturn ChatSessionStatus.InProgress;\n\t\t} else {\n\t\t\tconst requests = model.getRequests();\n\t\t\tif (requests.length > 0) {\n\t\t\t\t// Check if the last request was completed successfully or failed\n\t\t\t\tconst lastRequest = requests[requests.length - 1];\n\t\t\t\tif (lastRequest?.response) {\n\t\t\t\t\tif (lastRequest.response.isCanceled || lastRequest.response.result?.errorDetails) {\n\t\t\t\t\t\treturn ChatSessionStatus.Failed;\n\t\t\t\t\t} else if (lastRequest.response.isComplete) {\n\t\t\t\t\t\treturn ChatSessionStatus.Completed;\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn ChatSessionStatus.InProgress;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\tasync provideChatSessionItems(token: CancellationToken): Promise<IChatSessionItem[]> {\n\t\tconst sessions: ChatSessionItemWithProvider[] = [];\n\t\tconst sessionsByResource = new ResourceSet();\n\t\tthis.chatService.getLiveSessionItems().forEach(sessionDetail => {\n\t\t\tlet status: ChatSessionStatus | undefined;\n\t\t\tlet startTime: number | undefined;\n\t\t\tlet endTime: number | undefined;\n\t\t\tconst model = this.chatService.getSession(sessionDetail.sessionResource);\n\t\t\tif (model) {\n\t\t\t\tstatus = this.modelToStatus(model);\n\t\t\t\tstartTime = model.timestamp;\n\n\t\t\t\tconst lastResponse = model.getRequests().at(-1)?.response;\n\t\t\t\tif (lastResponse) {\n\t\t\t\t\tendTime = lastResponse.completedAt ?? lastResponse.timestamp;\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst statistics = model ? this.getSessionStatistics(model) : undefined;\n\t\t\tconst editorSession: ChatSessionItemWithProvider = {\n\t\t\t\tresource: sessionDetail.sessionResource,\n\t\t\t\tlabel: sessionDetail.title,\n\t\t\t\ticonPath: Codicon.chatSparkle,\n\t\t\t\tstatus,\n\t\t\t\tprovider: this,\n\t\t\t\ttiming: {\n\t\t\t\t\tstartTime: startTime ?? Date.now(), // TODO@osortega this is not so good\n\t\t\t\t\tendTime\n\t\t\t\t},\n\t\t\t\tstatistics\n\t\t\t};\n\t\t\tsessionsByResource.add(sessionDetail.sessionResource);\n\t\t\tsessions.push(editorSession);\n\t\t});\n\t\tconst history = await this.getHistoryItems();\n\t\tsessions.push(...history.filter(h => !sessionsByResource.has(h.resource)));\n\n\t\treturn sessions;\n\t}\n\n\tprivate async getHistoryItems(): Promise<ChatSessionItemWithProvider[]> {\n\t\ttry {\n\t\t\tconst allHistory = await this.chatService.getHistorySessionItems();\n\t\t\tconst historyItems = allHistory.map((historyDetail): ChatSessionItemWithProvider => {\n\t\t\t\tconst model = this.chatService.getSession(historyDetail.sessionResource);\n\t\t\t\tconst statistics = model ? this.getSessionStatistics(model) : undefined;\n\t\t\t\treturn {\n\t\t\t\t\tresource: historyDetail.sessionResource,\n\t\t\t\t\tlabel: historyDetail.title,\n\t\t\t\t\ticonPath: Codicon.chatSparkle,\n\t\t\t\t\tprovider: this,\n\t\t\t\t\ttiming: {\n\t\t\t\t\t\tstartTime: historyDetail.lastMessageDate ?? Date.now()\n\t\t\t\t\t},\n\t\t\t\t\tarchived: true,\n\t\t\t\t\tstatistics\n\t\t\t\t};\n\t\t\t});\n\t\t\treturn historyItems;\n\n\t\t} catch (error) {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tprivate getSessionStatistics(chatModel: IChatModel) {\n\t\tlet linesAdded = 0;\n\t\tlet linesRemoved = 0;\n\t\tconst modifiedFiles = new ResourceSet();\n\t\tconst currentEdits = chatModel.editingSession?.entries.get();\n\t\tif (currentEdits) {\n\t\t\tconst uncommittedEdits = currentEdits.filter((edit) => edit.state.get() === ModifiedFileEntryState.Modified);\n\t\t\tuncommittedEdits.forEach(edit => {\n\t\t\t\tlinesAdded += edit.linesAdded?.get() ?? 0;\n\t\t\t\tlinesRemoved += edit.linesRemoved?.get() ?? 0;\n\t\t\t\tmodifiedFiles.add(edit.modifiedURI);\n\t\t\t});\n\t\t}\n\t\treturn {\n\t\t\tfiles: modifiedFiles.size,\n\t\t\tinsertions: linesAdded,\n\t\t\tdeletions: linesRemoved,\n\t\t};\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Codicon } from '../../../../../base/common/codicons.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { ResourceSet } from '../../../../../base/common/map.js';\nimport { IObservable } from '../../../../../base/common/observable.js';\nimport { IWorkbenchContribution } from '../../../../common/contributions.js';\nimport { ModifiedFileEntryState } from '../../common/chatEditingService.js';\nimport { IChatModel } from '../../common/chatModel.js';\nimport { IChatService } from '../../common/chatService.js';\nimport { ChatSessionStatus, IChatSessionItem, IChatSessionItemProvider, IChatSessionsService, localChatSessionType } from '../../common/chatSessionsService.js';\nimport { ChatAgentLocation } from '../../common/constants.js';\nimport { IChatWidget, IChatWidgetService, isIChatViewViewContext } from '../chat.js';\nimport { ChatSessionItemWithProvider } from './common.js';\n\nexport class LocalChatSessionsProvider extends Disposable implements IChatSessionItemProvider, IWorkbenchContribution {\n\tstatic readonly ID = 'workbench.contrib.localChatSessionsProvider';\n\tstatic readonly CHAT_WIDGET_VIEW_ID = 'workbench.panel.chat.view.copilot';\n\treadonly chatSessionType = localChatSessionType;\n\n\tprivate readonly _onDidChange = this._register(new Emitter<void>());\n\treadonly onDidChange: Event<void> = this._onDidChange.event;\n\n\treadonly _onDidChangeChatSessionItems = this._register(new Emitter<void>());\n\tpublic get onDidChangeChatSessionItems() { return this._onDidChangeChatSessionItems.event; }\n\n\tconstructor(\n\t\t@IChatWidgetService private readonly chatWidgetService: IChatWidgetService,\n\t\t@IChatService private readonly chatService: IChatService,\n\t\t@IChatSessionsService private readonly chatSessionsService: IChatSessionsService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(this.chatSessionsService.registerChatSessionItemProvider(this));\n\n\t\tthis.registerWidgetListeners();\n\n\t\tthis._register(this.chatService.onDidDisposeSession(() => {\n\t\t\tthis._onDidChange.fire();\n\t\t}));\n\n\t\t// Listen for global session items changes for our session type\n\t\tthis._register(this.chatSessionsService.onDidChangeSessionItems((sessionType) => {\n\t\t\tif (sessionType === this.chatSessionType) {\n\t\t\t\tthis._onDidChange.fire();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate registerWidgetListeners(): void {\n\t\t// Listen for new chat widgets being added/removed\n\t\tthis._register(this.chatWidgetService.onDidAddWidget(widget => {\n\t\t\t// Only fire for chat view instance\n\t\t\tif (widget.location === ChatAgentLocation.Chat &&\n\t\t\t\tisIChatViewViewContext(widget.viewContext) &&\n\t\t\t\twidget.viewContext.viewId === LocalChatSessionsProvider.CHAT_WIDGET_VIEW_ID) {\n\t\t\t\tthis._onDidChange.fire();\n\t\t\t\tthis._registerWidgetModelListeners(widget);\n\t\t\t}\n\t\t}));\n\n\t\t// Check for existing chat widgets and register listeners\n\t\tconst existingWidgets = this.chatWidgetService.getWidgetsByLocations(ChatAgentLocation.Chat)\n\t\t\t.filter(widget => isIChatViewViewContext(widget.viewContext) && widget.viewContext.viewId === LocalChatSessionsProvider.CHAT_WIDGET_VIEW_ID);\n\n\t\texistingWidgets.forEach(widget => {\n\t\t\tthis._registerWidgetModelListeners(widget);\n\t\t});\n\t}\n\n\tprivate _registerWidgetModelListeners(widget: IChatWidget): void {\n\t\tconst register = () => {\n\t\t\tthis.registerModelTitleListener(widget);\n\t\t\tif (widget.viewModel) {\n\t\t\t\tthis.registerProgressListener(widget.viewModel.model.requestInProgress);\n\t\t\t}\n\t\t};\n\t\t// Listen for view model changes on this widget\n\t\tthis._register(widget.onDidChangeViewModel(() => {\n\t\t\tregister();\n\t\t\tthis._onDidChangeChatSessionItems.fire();\n\t\t}));\n\n\t\tregister();\n\t}\n\tprivate registerProgressListener(observable: IObservable<boolean>) {\n\t\tconst progressEvent = Event.fromObservableLight(observable);\n\t\tthis._register(progressEvent(() => {\n\t\t\tthis._onDidChangeChatSessionItems.fire();\n\t\t}));\n\t}\n\n\tprivate registerModelTitleListener(widget: IChatWidget): void {\n\t\tconst model = widget.viewModel?.model;\n\t\tif (model) {\n\t\t\t// Listen for model changes, specifically for title changes via setCustomTitle\n\t\t\tthis._register(model.onDidChange((e) => {\n\t\t\t\t// Fire change events for all title-related changes to refresh the tree\n\t\t\t\tif (!e || e.kind === 'setCustomTitle') {\n\t\t\t\t\tthis._onDidChange.fire();\n\t\t\t\t}\n\t\t\t}));\n\t\t}\n\t}\n\n\tprivate modelToStatus(model: IChatModel): ChatSessionStatus | undefined {\n\t\tif (model.requestInProgress.get()) {\n\t\t\treturn ChatSessionStatus.InProgress;\n\t\t} else {\n\t\t\tconst requests = model.getRequests();\n\t\t\tif (requests.length > 0) {\n\t\t\t\t// Check if the last request was completed successfully or failed\n\t\t\t\tconst lastRequest = requests[requests.length - 1];\n\t\t\t\tif (lastRequest?.response) {\n\t\t\t\t\tif (lastRequest.response.isCanceled || lastRequest.response.result?.errorDetails) {\n\t\t\t\t\t\treturn ChatSessionStatus.Failed;\n\t\t\t\t\t} else if (lastRequest.response.isComplete) {\n\t\t\t\t\t\treturn ChatSessionStatus.Completed;\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn ChatSessionStatus.InProgress;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn;\n\t}\n\n\tasync provideChatSessionItems(token: CancellationToken): Promise<IChatSessionItem[]> {\n\t\tconst sessions: ChatSessionItemWithProvider[] = [];\n\t\tconst sessionsByResource = new ResourceSet();\n\t\tthis.chatService.getLiveSessionItems().forEach(sessionDetail => {\n\t\t\tlet status: ChatSessionStatus | undefined;\n\t\t\tlet startTime: number | undefined;\n\t\t\tlet endTime: number | undefined;\n\t\t\tconst model = this.chatService.getSession(sessionDetail.sessionResource);\n\t\t\tif (model) {\n\t\t\t\tstatus = this.modelToStatus(model);\n\t\t\t\tstartTime = model.timestamp;\n\n\t\t\t\tconst lastResponse = model.getRequests().at(-1)?.response;\n\t\t\t\tif (lastResponse) {\n\t\t\t\t\tendTime = lastResponse.completedAt ?? lastResponse.timestamp;\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst statistics = model ? this.getSessionStatistics(model) : undefined;\n\t\t\tconst editorSession: ChatSessionItemWithProvider = {\n\t\t\t\tresource: sessionDetail.sessionResource,\n\t\t\t\tlabel: sessionDetail.title,\n\t\t\t\ticonPath: Codicon.chatSparkle,\n\t\t\t\tstatus,\n\t\t\t\tprovider: this,\n\t\t\t\ttiming: {\n\t\t\t\t\tstartTime: startTime ?? Date.now(), // TODO@osortega this is not so good\n\t\t\t\t\tendTime\n\t\t\t\t},\n\t\t\t\tstatistics\n\t\t\t};\n\t\t\tsessionsByResource.add(sessionDetail.sessionResource);\n\t\t\tsessions.push(editorSession);\n\t\t});\n\t\tconst history = await this.getHistoryItems();\n\t\tsessions.push(...history.filter(h => !sessionsByResource.has(h.resource)));\n\n\t\treturn sessions;\n\t}\n\n\tprivate async getHistoryItems(): Promise<ChatSessionItemWithProvider[]> {\n\t\ttry {\n\t\t\tconst allHistory = await this.chatService.getHistorySessionItems();\n\t\t\tconst historyItems = allHistory.map((historyDetail): ChatSessionItemWithProvider => {\n\t\t\t\tconst model = this.chatService.getSession(historyDetail.sessionResource);\n\t\t\t\tconst statistics = model ? this.getSessionStatistics(model) : undefined;\n\t\t\t\treturn {\n\t\t\t\t\tresource: historyDetail.sessionResource,\n\t\t\t\t\tlabel: historyDetail.title,\n\t\t\t\t\ticonPath: Codicon.chatSparkle,\n\t\t\t\t\tprovider: this,\n\t\t\t\t\ttiming: {\n\t\t\t\t\t\tstartTime: historyDetail.lastMessageDate ?? Date.now()\n\t\t\t\t\t},\n\t\t\t\t\tarchived: true,\n\t\t\t\t\tstatistics\n\t\t\t\t};\n\t\t\t});\n\t\t\treturn historyItems;\n\n\t\t} catch (error) {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tprivate getSessionStatistics(chatModel: IChatModel) {\n\t\tlet linesAdded = 0;\n\t\tlet linesRemoved = 0;\n\t\tconst modifiedFiles = new ResourceSet();\n\t\tconst currentEdits = chatModel.editingSession?.entries.get();\n\t\tif (currentEdits) {\n\t\t\tconst uncommittedEdits = currentEdits.filter((edit) => edit.state.get() === ModifiedFileEntryState.Modified);\n\t\t\tuncommittedEdits.forEach(edit => {\n\t\t\t\tlinesAdded += edit.linesAdded?.get() ?? 0;\n\t\t\t\tlinesRemoved += edit.linesRemoved?.get() ?? 0;\n\t\t\t\tmodifiedFiles.add(edit.modifiedURI);\n\t\t\t});\n\t\t}\n\t\treturn {\n\t\t\tfiles: modifiedFiles.size,\n\t\t\tinsertions: linesAdded,\n\t\t\tdeletions: linesRemoved,\n\t\t};\n\t}\n}\n"]}