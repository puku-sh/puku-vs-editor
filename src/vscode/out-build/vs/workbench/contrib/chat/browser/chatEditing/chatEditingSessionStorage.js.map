{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/browser/chatEditing/chatEditingSessionStorage.ts","vs/workbench/contrib/chat/browser/chatEditing/chatEditingSessionStorage.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;AAEhG,OAAO,EAAE,QAAQ,EAAE,MAAM,sCAAsC,CAAC;AAChE,OAAO,EAAE,SAAS,EAAE,MAAM,oCAAoC,CAAC;AAC/D,OAAO,EAAE,WAAW,EAAE,MAAM,mCAAmC,CAAC;AAChE,OAAO,EAAE,MAAM,EAAE,MAAM,2CAA2C,CAAC;AACnE,OAAO,EAAE,QAAQ,EAAE,MAAM,yCAAyC,CAAC;AACnE,OAAO,EAAE,GAAG,EAAE,MAAM,mCAAmC,CAAC;AAExD,OAAO,EAAE,mBAAmB,EAAE,MAAM,2DAA2D,CAAC;AAChG,OAAO,EAAE,YAAY,EAAE,MAAM,+CAA+C,CAAC;AAC7E,OAAO,EAAE,WAAW,EAAE,MAAM,2CAA2C,CAAC;AACxE,OAAO,EAAE,wBAAwB,EAAE,MAAM,uDAAuD,CAAC;AAGjG,OAAO,EAAE,4BAA4B,EAA6B,MAAM,4BAA4B,CAAC;AAErG,MAAM,uBAAuB,GAAG,UAAU,CAAC;AAC3C,MAAM,kBAAkB,GAAG,YAAY,CAAC;AAQjC,IAAM,yBAAyB,GAA/B,MAAM,yBAAyB;IAErC,YACkB,oBAAyB,EACX,YAA0B,EACnB,mBAAwC,EAChD,WAAwB,EACX,wBAAkD;QAJ5E,yBAAoB,GAApB,oBAAoB,CAAK;QACX,iBAAY,GAAZ,YAAY,CAAc;QACnB,wBAAmB,GAAnB,mBAAmB,CAAqB;QAChD,gBAAW,GAAX,WAAW,CAAa;QACX,6BAAwB,GAAxB,wBAAwB,CAA0B;QAE7F,IAAI,CAAC,UAAU,GAAG,4BAA4B,CAAC,oBAAoB,CAAC,CAAC;IACtE,CAAC;IAES,mBAAmB;QAC5B,MAAM,WAAW,GAAG,IAAI,CAAC,wBAAwB,CAAC,YAAY,EAAE,CAAC,EAAE,CAAC;QACpE,OAAO,QAAQ,CAAC,IAAI,CAAC,mBAAmB,CAAC,oBAAoB,EAAE,WAAW,EAAE,qBAAqB,EAAE,IAAI,CAAC,UAAU,CAAC,CAAC;IACrH,CAAC;IAEM,KAAK,CAAC,YAAY;QACxB,MAAM,eAAe,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACnD,MAAM,YAAY,GAAG,IAAI,GAAG,EAA2B,CAAC;QACxD,MAAM,cAAc,GAAG,CAAC,IAAY,EAAE,EAAE;YACvC,IAAI,WAAW,GAAG,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACzC,IAAI,CAAC,WAAW,EAAE,CAAC;gBAClB,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,QAAQ,CAAC,eAAe,EAAE,uBAAuB,EAAE,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,QAAQ,EAAE,CAAC,CAAC;gBAC7I,YAAY,CAAC,GAAG,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC;YACrC,CAAC;YACD,OAAO,WAAW,CAAC;QACpB,CAAC,CAAC;QACF,MAAM,6BAA6B,GAAG,KAAK,EAAE,UAA+B,EAAwC,EAAE;YACrH,MAAM,OAAO,GAAG,IAAI,WAAW,EAAkB,CAAC;YAClD,KAAK,MAAM,QAAQ,IAAI,UAAU,EAAE,CAAC;gBACnC,MAAM,KAAK,GAAG,MAAM,wBAAwB,CAAC,QAAQ,CAAC,CAAC;gBACvD,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,QAAQ,EAAE,KAAK,CAAC,CAAC;YACpC,CAAC;YACD,OAAO,OAAO,CAAC;QAChB,CAAC,CAAC;QACF,MAAM,6BAA6B,GAAG,KAAK,EAAE,OAAoE,EAAoC,EAAE;YACtJ,MAAM,OAAO,GAAG,MAAM,6BAA6B,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;YACrE,OAAO,EAAE,MAAM,EAAE,QAAQ,IAAI,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,SAAS,EAAE,OAAO,EAAE,CAAC;QAC9E,CAAC,CAAC;QACF,MAAM,wBAAwB,GAAG,KAAK,EAAE,KAAwB,EAAE,EAAE;YACnE,OAAO;gBACN,QAAQ,EAAE,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,QAAQ,CAAC;gBACnC,UAAU,EAAE,KAAK,CAAC,UAAU;gBAC5B,QAAQ,EAAE,MAAM,cAAc,CAAC,KAAK,CAAC,YAAY,CAAC;gBAClD,OAAO,EAAE,MAAM,cAAc,CAAC,KAAK,CAAC,WAAW,CAAC;gBAChD,KAAK,EAAE,KAAK,CAAC,KAAK;gBAClB,WAAW,EAAE,GAAG,CAAC,KAAK,CAAC,KAAK,CAAC,WAAW,CAAC;gBACzC,aAAa,EAAE;oBACd,SAAS,EAAE,KAAK,CAAC,aAAa,CAAC,SAAS;oBACxC,OAAO,EAAE,KAAK,CAAC,aAAa,CAAC,OAAO;oBACpC,OAAO,EAAE,KAAK,CAAC,aAAa,CAAC,OAAO;oBACpC,eAAe,EAAE,IAAI,CAAC,oBAAoB;oBAC1C,MAAM,EAAE,SAAS;oBACjB,OAAO,EAAE,KAAK,CAAC,aAAa,CAAC,OAAO;oBACpC,MAAM,EAAE,KAAK,CAAC,aAAa,CAAC,MAAM;oBAClC,0BAA0B,EAAE,KAAK,CAAC,aAAa,CAAC,0BAA0B;oBAC1E,OAAO,EAAE,KAAK,CAAC,aAAa,CAAC,OAAO;iBACpC;aACwB,CAAC;QAC5B,CAAC,CAAC;QACF,IAAI,CAAC;YACJ,MAAM,aAAa,GAAG,QAAQ,CAAC,eAAe,EAAE,kBAAkB,CAAC,CAAC;YACpE,IAAI,CAAE,MAAM,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,aAAa,CAAC,EAAE,CAAC;gBACrD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,yDAAyD,aAAa,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;gBAC5G,OAAO,SAAS,CAAC;YAClB,CAAC;YACD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,oDAAoD,aAAa,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;YACvG,MAAM,gBAAgB,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAC;YACzE,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,gBAAgB,CAAC,KAAK,CAAC,QAAQ,EAAE,CAA2B,CAAC;YACrF,IAAI,CAAC,2BAA2B,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC;gBACzD,OAAO,SAAS,CAAC;YAClB,CAAC;YAED,MAAM,mBAAmB,GAAG,IAAI,WAAW,EAAU,CAAC;YACtD,KAAK,MAAM,cAAc,IAAI,IAAI,CAAC,mBAAmB,EAAE,CAAC;gBACvD,mBAAmB,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,EAAE,MAAM,cAAc,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YAChG,CAAC;YACD,MAAM,cAAc,GAAG,MAAM,6BAA6B,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;YAEhF,OAAO;gBACN,mBAAmB;gBACnB,cAAc;gBACd,QAAQ,EAAE,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC;aAC/B,CAAC;QACH,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACZ,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,6CAA6C,eAAe,CAAC,QAAQ,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC;QACtG,CAAC;QACD,OAAO,SAAS,CAAC;IAClB,CAAC;IAEM,KAAK,CAAC,UAAU,CAAC,KAAyB;QAChD,MAAM,aAAa,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACjD,MAAM,cAAc,GAAG,GAAG,CAAC,QAAQ,CAAC,aAAa,EAAE,uBAAuB,CAAC,CAAC;QAE5E,6BAA6B;QAC7B,MAAM,gBAAgB,GAAG,IAAI,GAAG,EAAU,CAAC;QAC3C,IAAI,CAAC;YACJ,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;YAC7D,IAAI,CAAC,QAAQ,EAAE,OAAO,CAAC,KAAK,CAAC,EAAE;gBAC9B,IAAI,KAAK,CAAC,MAAM,EAAE,CAAC;oBAClB,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBAClC,CAAC;YACF,CAAC,CAAC,CAAC;QACJ,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACZ,IAAI,CAAC;gBACJ,yBAAyB;gBACzB,MAAM,IAAI,CAAC,YAAY,CAAC,YAAY,CAAC,cAAc,CAAC,CAAC;YACtD,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACZ,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,sDAAsD,cAAc,CAAC,QAAQ,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC;gBAC7G,OAAO;YACR,CAAC;QACF,CAAC;QAED,MAAM,oBAAoB,GAAG,IAAI,GAAG,EAA2B,CAAC;QAEhE,sEAAsE;QACtE,6CAA6C;QAC7C,MAAM,YAAY,GAAG,KAAK,EAAE,OAAe,EAAmB,EAAE;YAC/D,MAAM,MAAM,GAAG,QAAQ,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;YAC5C,MAAM,IAAI,GAAG,CAAC,MAAM,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YACvD,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC;gBACjC,MAAM,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,QAAQ,CAAC,cAAc,EAAE,IAAI,CAAC,EAAE,MAAM,CAAC,CAAC;YAC3E,CAAC;YACD,OAAO,IAAI,CAAC;QACb,CAAC,CAAC;QACF,MAAM,cAAc,GAAG,KAAK,EAAE,OAAe,EAAmB,EAAE;YACjE,IAAI,iBAAiB,GAAG,oBAAoB,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;YAC1D,IAAI,CAAC,iBAAiB,EAAE,CAAC;gBACxB,iBAAiB,GAAG,YAAY,CAAC,OAAO,CAAC,CAAC;gBAC1C,oBAAoB,CAAC,GAAG,CAAC,OAAO,EAAE,iBAAiB,CAAC,CAAC;YACtD,CAAC;YACD,OAAO,iBAAiB,CAAC;QAC1B,CAAC,CAAC;QACF,MAAM,oBAAoB,GAAG,KAAK,EAAQ,WAA2B,EAAE,SAAmC,EAA8B,EAAE;YACzI,OAAO,MAAM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC,CAAC,GAAG,CAAC,KAAK,EAAE,CAAC,WAAW,EAAE,KAAK,CAAC,EAAE,EAAE,CAAC,CAAC,WAAW,CAAC,QAAQ,EAAE,EAAE,MAAM,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;QACnJ,CAAC,CAAC;QACF,MAAM,+BAA+B,GAAG,KAAK,EAAE,IAA6B,EAAuC,EAAE;YACpH,OAAO;gBACN,MAAM,EAAE,IAAI,CAAC,MAAM;gBACnB,OAAO,EAAE,MAAM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,GAAG,CAAC,sBAAsB,CAAC,CAAC;aACzF,CAAC;QACH,CAAC,CAAC;QACF,MAAM,sBAAsB,GAAG,KAAK,EAAE,KAAqB,EAA8B,EAAE;YAC1F,OAAO;gBACN,QAAQ,EAAE,KAAK,CAAC,QAAQ,CAAC,QAAQ,EAAE;gBACnC,UAAU,EAAE,KAAK,CAAC,UAAU;gBAC5B,YAAY,EAAE,MAAM,cAAc,CAAC,KAAK,CAAC,QAAQ,CAAC;gBAClD,WAAW,EAAE,MAAM,cAAc,CAAC,KAAK,CAAC,OAAO,CAAC;gBAChD,KAAK,EAAE,KAAK,CAAC,KAAK;gBAClB,WAAW,EAAE,KAAK,CAAC,WAAW,CAAC,QAAQ,EAAE;gBACzC,aAAa,EAAE,EAAE,SAAS,EAAE,KAAK,CAAC,aAAa,CAAC,SAAS,EAAE,OAAO,EAAE,KAAK,CAAC,aAAa,CAAC,OAAO,EAAE,OAAO,EAAE,KAAK,CAAC,aAAa,CAAC,OAAO,EAAE,OAAO,EAAE,KAAK,CAAC,aAAa,CAAC,OAAO,EAAE,MAAM,EAAE,KAAK,CAAC,aAAa,CAAC,MAAM,EAAE;aACjN,CAAC;QACH,CAAC,CAAC;QAEF,IAAI,CAAC;YACJ,MAAM,IAAI,GAA2B;gBACpC,OAAO,EAAE,eAAe;gBACxB,mBAAmB,EAAE,MAAM,oBAAoB,CAAC,KAAK,CAAC,mBAAmB,EAAE,KAAK,CAAC,EAAE,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;gBAC1G,QAAQ,EAAE,KAAK,CAAC,QAAQ;gBACxB,cAAc,EAAE,MAAM,+BAA+B,CAAC,KAAK,CAAC,cAAc,CAAC;aAC3E,CAAC;YAEF,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,kDAAkD,aAAa,CAAC,QAAQ,EAAE,KAAK,oBAAoB,CAAC,IAAI,QAAQ,CAAC,CAAC;YAEzI,MAAM,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,QAAQ,CAAC,aAAa,EAAE,kBAAkB,CAAC,EAAE,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAC3H,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACZ,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,yCAAyC,aAAa,CAAC,QAAQ,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC;QAChG,CAAC;IACF,CAAC;IAEM,KAAK,CAAC,UAAU;QACtB,MAAM,aAAa,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACjD,IAAI,MAAM,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,aAAa,CAAC,EAAE,CAAC;YACnD,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,mDAAmD,aAAa,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;YACtG,IAAI,CAAC;gBACJ,MAAM,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,aAAa,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;YACjE,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACZ,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,4CAA4C,aAAa,CAAC,QAAQ,EAAE,EAAE,EAAE,CAAC,CAAC,CAAC;YACnG,CAAC;QACF,CAAC;IACF,CAAC;CACD,CAAA;AAtLY,yBAAyB;IAInC,WAAA,YAAY,CAAA;IACZ,WAAA,mBAAmB,CAAA;IACnB,WAAA,WAAW,CAAA;IACX,WAAA,wBAAwB,CAAA;GAPd,yBAAyB,CAsLrC;;AA6DD,MAAM,2BAA2B,GAAG,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;AAC3C,MAAM,eAAe,GAAG,CAAC,CAAC","file":"chatEditingSessionStorage.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer } from '../../../../../base/common/buffer.js';\nimport { hashAsync } from '../../../../../base/common/hash.js';\nimport { ResourceMap } from '../../../../../base/common/map.js';\nimport { revive } from '../../../../../base/common/marshalling.js';\nimport { joinPath } from '../../../../../base/common/resources.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { EditSuggestionId } from '../../../../../editor/common/textModelEditSource.js';\nimport { IEnvironmentService } from '../../../../../platform/environment/common/environment.js';\nimport { IFileService } from '../../../../../platform/files/common/files.js';\nimport { ILogService } from '../../../../../platform/log/common/log.js';\nimport { IWorkspaceContextService } from '../../../../../platform/workspace/common/workspace.js';\nimport { Dto } from '../../../../services/extensions/common/proxyIdentifier.js';\nimport { ISnapshotEntry, ModifiedFileEntryState, WorkingSetDisplayMetadata } from '../../common/chatEditingService.js';\nimport { getKeyForChatSessionResource, IChatEditingTimelineState } from './chatEditingOperations.js';\n\nconst STORAGE_CONTENTS_FOLDER = 'contents';\nconst STORAGE_STATE_FILE = 'state.json';\n\nexport interface StoredSessionState {\n\treadonly initialFileContents: ResourceMap<string>;\n\treadonly recentSnapshot: IChatEditingSessionStop;\n\treadonly timeline: IChatEditingTimelineState | undefined;\n}\n\nexport class ChatEditingSessionStorage {\n\tprivate readonly storageKey: string;\n\tconstructor(\n\t\tprivate readonly _chatSessionResource: URI,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@IEnvironmentService private readonly _environmentService: IEnvironmentService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IWorkspaceContextService private readonly _workspaceContextService: IWorkspaceContextService,\n\t) {\n\t\tthis.storageKey = getKeyForChatSessionResource(_chatSessionResource);\n\t}\n\n\tprotected _getStorageLocation(): URI {\n\t\tconst workspaceId = this._workspaceContextService.getWorkspace().id;\n\t\treturn joinPath(this._environmentService.workspaceStorageHome, workspaceId, 'chatEditingSessions', this.storageKey);\n\t}\n\n\tpublic async restoreState(): Promise<StoredSessionState | undefined> {\n\t\tconst storageLocation = this._getStorageLocation();\n\t\tconst fileContents = new Map<string, Promise<string>>();\n\t\tconst getFileContent = (hash: string) => {\n\t\t\tlet readPromise = fileContents.get(hash);\n\t\t\tif (!readPromise) {\n\t\t\t\treadPromise = this._fileService.readFile(joinPath(storageLocation, STORAGE_CONTENTS_FOLDER, hash)).then(content => content.value.toString());\n\t\t\t\tfileContents.set(hash, readPromise);\n\t\t\t}\n\t\t\treturn readPromise;\n\t\t};\n\t\tconst deserializeSnapshotEntriesDTO = async (dtoEntries: ISnapshotEntryDTO[]): Promise<ResourceMap<ISnapshotEntry>> => {\n\t\t\tconst entries = new ResourceMap<ISnapshotEntry>();\n\t\t\tfor (const entryDTO of dtoEntries) {\n\t\t\t\tconst entry = await deserializeSnapshotEntry(entryDTO);\n\t\t\t\tentries.set(entry.resource, entry);\n\t\t\t}\n\t\t\treturn entries;\n\t\t};\n\t\tconst deserializeChatEditingStopDTO = async (stopDTO: IChatEditingSessionStopDTO | IChatEditingSessionSnapshotDTO): Promise<IChatEditingSessionStop> => {\n\t\t\tconst entries = await deserializeSnapshotEntriesDTO(stopDTO.entries);\n\t\t\treturn { stopId: 'stopId' in stopDTO ? stopDTO.stopId : undefined, entries };\n\t\t};\n\t\tconst deserializeSnapshotEntry = async (entry: ISnapshotEntryDTO) => {\n\t\t\treturn {\n\t\t\t\tresource: URI.parse(entry.resource),\n\t\t\t\tlanguageId: entry.languageId,\n\t\t\t\toriginal: await getFileContent(entry.originalHash),\n\t\t\t\tcurrent: await getFileContent(entry.currentHash),\n\t\t\t\tstate: entry.state,\n\t\t\t\tsnapshotUri: URI.parse(entry.snapshotUri),\n\t\t\t\ttelemetryInfo: {\n\t\t\t\t\trequestId: entry.telemetryInfo.requestId,\n\t\t\t\t\tagentId: entry.telemetryInfo.agentId,\n\t\t\t\t\tcommand: entry.telemetryInfo.command,\n\t\t\t\t\tsessionResource: this._chatSessionResource,\n\t\t\t\t\tresult: undefined,\n\t\t\t\t\tmodelId: entry.telemetryInfo.modelId,\n\t\t\t\t\tmodeId: entry.telemetryInfo.modeId,\n\t\t\t\t\tapplyCodeBlockSuggestionId: entry.telemetryInfo.applyCodeBlockSuggestionId,\n\t\t\t\t\tfeature: entry.telemetryInfo.feature,\n\t\t\t\t}\n\t\t\t} satisfies ISnapshotEntry;\n\t\t};\n\t\ttry {\n\t\t\tconst stateFilePath = joinPath(storageLocation, STORAGE_STATE_FILE);\n\t\t\tif (! await this._fileService.exists(stateFilePath)) {\n\t\t\t\tthis._logService.debug(`chatEditingSession: No editing session state found at ${stateFilePath.toString()}`);\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tthis._logService.debug(`chatEditingSession: Restoring editing session at ${stateFilePath.toString()}`);\n\t\t\tconst stateFileContent = await this._fileService.readFile(stateFilePath);\n\t\t\tconst data = JSON.parse(stateFileContent.value.toString()) as IChatEditingSessionDTO;\n\t\t\tif (!COMPATIBLE_STORAGE_VERSIONS.includes(data.version)) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tconst initialFileContents = new ResourceMap<string>();\n\t\t\tfor (const fileContentDTO of data.initialFileContents) {\n\t\t\t\tinitialFileContents.set(URI.parse(fileContentDTO[0]), await getFileContent(fileContentDTO[1]));\n\t\t\t}\n\t\t\tconst recentSnapshot = await deserializeChatEditingStopDTO(data.recentSnapshot);\n\n\t\t\treturn {\n\t\t\t\tinitialFileContents,\n\t\t\t\trecentSnapshot,\n\t\t\t\ttimeline: revive(data.timeline),\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tthis._logService.error(`Error restoring chat editing session from ${storageLocation.toString()}`, e);\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tpublic async storeState(state: StoredSessionState): Promise<void> {\n\t\tconst storageFolder = this._getStorageLocation();\n\t\tconst contentsFolder = URI.joinPath(storageFolder, STORAGE_CONTENTS_FOLDER);\n\n\t\t// prepare the content folder\n\t\tconst existingContents = new Set<string>();\n\t\ttry {\n\t\t\tconst stat = await this._fileService.resolve(contentsFolder);\n\t\t\tstat.children?.forEach(child => {\n\t\t\t\tif (child.isFile) {\n\t\t\t\t\texistingContents.add(child.name);\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (e) {\n\t\t\ttry {\n\t\t\t\t// does not exist, create\n\t\t\t\tawait this._fileService.createFolder(contentsFolder);\n\t\t\t} catch (e) {\n\t\t\t\tthis._logService.error(`Error creating chat editing session content folder ${contentsFolder.toString()}`, e);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst contentWritePromises = new Map<string, Promise<string>>();\n\n\t\t// saves a file content under a path containing a hash of the content.\n\t\t// Returns the hash to represent the content.\n\t\tconst writeContent = async (content: string): Promise<string> => {\n\t\t\tconst buffer = VSBuffer.fromString(content);\n\t\t\tconst hash = (await hashAsync(buffer)).substring(0, 7);\n\t\t\tif (!existingContents.has(hash)) {\n\t\t\t\tawait this._fileService.writeFile(joinPath(contentsFolder, hash), buffer);\n\t\t\t}\n\t\t\treturn hash;\n\t\t};\n\t\tconst addFileContent = async (content: string): Promise<string> => {\n\t\t\tlet storedContentHash = contentWritePromises.get(content);\n\t\t\tif (!storedContentHash) {\n\t\t\t\tstoredContentHash = writeContent(content);\n\t\t\t\tcontentWritePromises.set(content, storedContentHash);\n\t\t\t}\n\t\t\treturn storedContentHash;\n\t\t};\n\t\tconst serializeResourceMap = async <T, U>(resourceMap: ResourceMap<T>, serialize: (value: T) => Promise<U>): Promise<ResourceMapDTO<U>> => {\n\t\t\treturn await Promise.all(Array.from(resourceMap.entries()).map(async ([resourceURI, value]) => [resourceURI.toString(), await serialize(value)]));\n\t\t};\n\t\tconst serializeChatEditingSessionStop = async (stop: IChatEditingSessionStop): Promise<IChatEditingSessionStopDTO> => {\n\t\t\treturn {\n\t\t\t\tstopId: stop.stopId,\n\t\t\t\tentries: await Promise.all(Array.from(stop.entries.values()).map(serializeSnapshotEntry))\n\t\t\t};\n\t\t};\n\t\tconst serializeSnapshotEntry = async (entry: ISnapshotEntry): Promise<ISnapshotEntryDTO> => {\n\t\t\treturn {\n\t\t\t\tresource: entry.resource.toString(),\n\t\t\t\tlanguageId: entry.languageId,\n\t\t\t\toriginalHash: await addFileContent(entry.original),\n\t\t\t\tcurrentHash: await addFileContent(entry.current),\n\t\t\t\tstate: entry.state,\n\t\t\t\tsnapshotUri: entry.snapshotUri.toString(),\n\t\t\t\ttelemetryInfo: { requestId: entry.telemetryInfo.requestId, agentId: entry.telemetryInfo.agentId, command: entry.telemetryInfo.command, modelId: entry.telemetryInfo.modelId, modeId: entry.telemetryInfo.modeId }\n\t\t\t};\n\t\t};\n\n\t\ttry {\n\t\t\tconst data: IChatEditingSessionDTO = {\n\t\t\t\tversion: STORAGE_VERSION,\n\t\t\t\tinitialFileContents: await serializeResourceMap(state.initialFileContents, value => addFileContent(value)),\n\t\t\t\ttimeline: state.timeline,\n\t\t\t\trecentSnapshot: await serializeChatEditingSessionStop(state.recentSnapshot),\n\t\t\t};\n\n\t\t\tthis._logService.debug(`chatEditingSession: Storing editing session at ${storageFolder.toString()}: ${contentWritePromises.size} files`);\n\n\t\t\tawait this._fileService.writeFile(joinPath(storageFolder, STORAGE_STATE_FILE), VSBuffer.fromString(JSON.stringify(data)));\n\t\t} catch (e) {\n\t\t\tthis._logService.debug(`Error storing chat editing session to ${storageFolder.toString()}`, e);\n\t\t}\n\t}\n\n\tpublic async clearState(): Promise<void> {\n\t\tconst storageFolder = this._getStorageLocation();\n\t\tif (await this._fileService.exists(storageFolder)) {\n\t\t\tthis._logService.debug(`chatEditingSession: Clearing editing session at ${storageFolder.toString()}`);\n\t\t\ttry {\n\t\t\t\tawait this._fileService.del(storageFolder, { recursive: true });\n\t\t\t} catch (e) {\n\t\t\t\tthis._logService.debug(`Error clearing chat editing session from ${storageFolder.toString()}`, e);\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport interface IChatEditingSessionSnapshot {\n\t/**\n\t * Index of this session in the linear history. It's the sum of the lengths\n\t * of all {@link stops} prior this one.\n\t */\n\treadonly startIndex: number;\n\n\treadonly requestId: string | undefined;\n\t/**\n\t * Edit stops in the request. Always initially populatd with stopId: undefind\n\t * for th request's initial state.\n\t *\n\t * Invariant: never empty.\n\t */\n\treadonly stops: IChatEditingSessionStop[];\n}\n\nexport interface IChatEditingSessionStop {\n\t/** Edit stop ID, first for a request is always undefined. */\n\tstopId: string | undefined;\n\n\treadonly entries: ResourceMap<ISnapshotEntry>;\n}\n\ninterface IChatEditingSessionStopDTO {\n\treadonly stopId: string | undefined;\n\treadonly entries: ISnapshotEntryDTO[];\n}\n\n\ninterface IChatEditingSessionSnapshotDTO {\n\treadonly requestId: string | undefined;\n\treadonly workingSet: ResourceMapDTO<WorkingSetDisplayMetadata>;\n\treadonly entries: ISnapshotEntryDTO[];\n}\n\ninterface ISnapshotEntryDTO {\n\treadonly resource: string;\n\treadonly languageId: string;\n\treadonly originalHash: string;\n\treadonly currentHash: string;\n\treadonly state: ModifiedFileEntryState;\n\treadonly snapshotUri: string;\n\treadonly telemetryInfo: IModifiedEntryTelemetryInfoDTO;\n}\n\ninterface IModifiedEntryTelemetryInfoDTO {\n\treadonly requestId: string;\n\treadonly agentId?: string;\n\treadonly command?: string;\n\n\treadonly modelId?: string;\n\treadonly modeId?: 'ask' | 'edit' | 'agent' | 'custom' | 'applyCodeBlock' | undefined;\n\treadonly applyCodeBlockSuggestionId?: EditSuggestionId | undefined;\n\treadonly feature?: 'sideBarChat' | 'inlineChat' | undefined;\n}\n\ntype ResourceMapDTO<T> = [string, T][];\n\nconst COMPATIBLE_STORAGE_VERSIONS = [1, 2];\nconst STORAGE_VERSION = 2;\n\n/** Old history uses IChatEditingSessionSnapshotDTO, new history uses IChatEditingSessionSnapshotDTO. */\ninterface IChatEditingSessionDTO {\n\treadonly version: number;\n\treadonly recentSnapshot: (IChatEditingSessionStopDTO | IChatEditingSessionSnapshotDTO);\n\treadonly timeline: Dto<IChatEditingTimelineState> | undefined;\n\treadonly initialFileContents: ResourceMapDTO<string>;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer } from '../../../../../base/common/buffer.js';\nimport { hashAsync } from '../../../../../base/common/hash.js';\nimport { ResourceMap } from '../../../../../base/common/map.js';\nimport { revive } from '../../../../../base/common/marshalling.js';\nimport { joinPath } from '../../../../../base/common/resources.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { EditSuggestionId } from '../../../../../editor/common/textModelEditSource.js';\nimport { IEnvironmentService } from '../../../../../platform/environment/common/environment.js';\nimport { IFileService } from '../../../../../platform/files/common/files.js';\nimport { ILogService } from '../../../../../platform/log/common/log.js';\nimport { IWorkspaceContextService } from '../../../../../platform/workspace/common/workspace.js';\nimport { Dto } from '../../../../services/extensions/common/proxyIdentifier.js';\nimport { ISnapshotEntry, ModifiedFileEntryState, WorkingSetDisplayMetadata } from '../../common/chatEditingService.js';\nimport { getKeyForChatSessionResource, IChatEditingTimelineState } from './chatEditingOperations.js';\n\nconst STORAGE_CONTENTS_FOLDER = 'contents';\nconst STORAGE_STATE_FILE = 'state.json';\n\nexport interface StoredSessionState {\n\treadonly initialFileContents: ResourceMap<string>;\n\treadonly recentSnapshot: IChatEditingSessionStop;\n\treadonly timeline: IChatEditingTimelineState | undefined;\n}\n\nexport class ChatEditingSessionStorage {\n\tprivate readonly storageKey: string;\n\tconstructor(\n\t\tprivate readonly _chatSessionResource: URI,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@IEnvironmentService private readonly _environmentService: IEnvironmentService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IWorkspaceContextService private readonly _workspaceContextService: IWorkspaceContextService,\n\t) {\n\t\tthis.storageKey = getKeyForChatSessionResource(_chatSessionResource);\n\t}\n\n\tprotected _getStorageLocation(): URI {\n\t\tconst workspaceId = this._workspaceContextService.getWorkspace().id;\n\t\treturn joinPath(this._environmentService.workspaceStorageHome, workspaceId, 'chatEditingSessions', this.storageKey);\n\t}\n\n\tpublic async restoreState(): Promise<StoredSessionState | undefined> {\n\t\tconst storageLocation = this._getStorageLocation();\n\t\tconst fileContents = new Map<string, Promise<string>>();\n\t\tconst getFileContent = (hash: string) => {\n\t\t\tlet readPromise = fileContents.get(hash);\n\t\t\tif (!readPromise) {\n\t\t\t\treadPromise = this._fileService.readFile(joinPath(storageLocation, STORAGE_CONTENTS_FOLDER, hash)).then(content => content.value.toString());\n\t\t\t\tfileContents.set(hash, readPromise);\n\t\t\t}\n\t\t\treturn readPromise;\n\t\t};\n\t\tconst deserializeSnapshotEntriesDTO = async (dtoEntries: ISnapshotEntryDTO[]): Promise<ResourceMap<ISnapshotEntry>> => {\n\t\t\tconst entries = new ResourceMap<ISnapshotEntry>();\n\t\t\tfor (const entryDTO of dtoEntries) {\n\t\t\t\tconst entry = await deserializeSnapshotEntry(entryDTO);\n\t\t\t\tentries.set(entry.resource, entry);\n\t\t\t}\n\t\t\treturn entries;\n\t\t};\n\t\tconst deserializeChatEditingStopDTO = async (stopDTO: IChatEditingSessionStopDTO | IChatEditingSessionSnapshotDTO): Promise<IChatEditingSessionStop> => {\n\t\t\tconst entries = await deserializeSnapshotEntriesDTO(stopDTO.entries);\n\t\t\treturn { stopId: 'stopId' in stopDTO ? stopDTO.stopId : undefined, entries };\n\t\t};\n\t\tconst deserializeSnapshotEntry = async (entry: ISnapshotEntryDTO) => {\n\t\t\treturn {\n\t\t\t\tresource: URI.parse(entry.resource),\n\t\t\t\tlanguageId: entry.languageId,\n\t\t\t\toriginal: await getFileContent(entry.originalHash),\n\t\t\t\tcurrent: await getFileContent(entry.currentHash),\n\t\t\t\tstate: entry.state,\n\t\t\t\tsnapshotUri: URI.parse(entry.snapshotUri),\n\t\t\t\ttelemetryInfo: {\n\t\t\t\t\trequestId: entry.telemetryInfo.requestId,\n\t\t\t\t\tagentId: entry.telemetryInfo.agentId,\n\t\t\t\t\tcommand: entry.telemetryInfo.command,\n\t\t\t\t\tsessionResource: this._chatSessionResource,\n\t\t\t\t\tresult: undefined,\n\t\t\t\t\tmodelId: entry.telemetryInfo.modelId,\n\t\t\t\t\tmodeId: entry.telemetryInfo.modeId,\n\t\t\t\t\tapplyCodeBlockSuggestionId: entry.telemetryInfo.applyCodeBlockSuggestionId,\n\t\t\t\t\tfeature: entry.telemetryInfo.feature,\n\t\t\t\t}\n\t\t\t} satisfies ISnapshotEntry;\n\t\t};\n\t\ttry {\n\t\t\tconst stateFilePath = joinPath(storageLocation, STORAGE_STATE_FILE);\n\t\t\tif (! await this._fileService.exists(stateFilePath)) {\n\t\t\t\tthis._logService.debug(`chatEditingSession: No editing session state found at ${stateFilePath.toString()}`);\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tthis._logService.debug(`chatEditingSession: Restoring editing session at ${stateFilePath.toString()}`);\n\t\t\tconst stateFileContent = await this._fileService.readFile(stateFilePath);\n\t\t\tconst data = JSON.parse(stateFileContent.value.toString()) as IChatEditingSessionDTO;\n\t\t\tif (!COMPATIBLE_STORAGE_VERSIONS.includes(data.version)) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\tconst initialFileContents = new ResourceMap<string>();\n\t\t\tfor (const fileContentDTO of data.initialFileContents) {\n\t\t\t\tinitialFileContents.set(URI.parse(fileContentDTO[0]), await getFileContent(fileContentDTO[1]));\n\t\t\t}\n\t\t\tconst recentSnapshot = await deserializeChatEditingStopDTO(data.recentSnapshot);\n\n\t\t\treturn {\n\t\t\t\tinitialFileContents,\n\t\t\t\trecentSnapshot,\n\t\t\t\ttimeline: revive(data.timeline),\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tthis._logService.error(`Error restoring chat editing session from ${storageLocation.toString()}`, e);\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tpublic async storeState(state: StoredSessionState): Promise<void> {\n\t\tconst storageFolder = this._getStorageLocation();\n\t\tconst contentsFolder = URI.joinPath(storageFolder, STORAGE_CONTENTS_FOLDER);\n\n\t\t// prepare the content folder\n\t\tconst existingContents = new Set<string>();\n\t\ttry {\n\t\t\tconst stat = await this._fileService.resolve(contentsFolder);\n\t\t\tstat.children?.forEach(child => {\n\t\t\t\tif (child.isFile) {\n\t\t\t\t\texistingContents.add(child.name);\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (e) {\n\t\t\ttry {\n\t\t\t\t// does not exist, create\n\t\t\t\tawait this._fileService.createFolder(contentsFolder);\n\t\t\t} catch (e) {\n\t\t\t\tthis._logService.error(`Error creating chat editing session content folder ${contentsFolder.toString()}`, e);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst contentWritePromises = new Map<string, Promise<string>>();\n\n\t\t// saves a file content under a path containing a hash of the content.\n\t\t// Returns the hash to represent the content.\n\t\tconst writeContent = async (content: string): Promise<string> => {\n\t\t\tconst buffer = VSBuffer.fromString(content);\n\t\t\tconst hash = (await hashAsync(buffer)).substring(0, 7);\n\t\t\tif (!existingContents.has(hash)) {\n\t\t\t\tawait this._fileService.writeFile(joinPath(contentsFolder, hash), buffer);\n\t\t\t}\n\t\t\treturn hash;\n\t\t};\n\t\tconst addFileContent = async (content: string): Promise<string> => {\n\t\t\tlet storedContentHash = contentWritePromises.get(content);\n\t\t\tif (!storedContentHash) {\n\t\t\t\tstoredContentHash = writeContent(content);\n\t\t\t\tcontentWritePromises.set(content, storedContentHash);\n\t\t\t}\n\t\t\treturn storedContentHash;\n\t\t};\n\t\tconst serializeResourceMap = async <T, U>(resourceMap: ResourceMap<T>, serialize: (value: T) => Promise<U>): Promise<ResourceMapDTO<U>> => {\n\t\t\treturn await Promise.all(Array.from(resourceMap.entries()).map(async ([resourceURI, value]) => [resourceURI.toString(), await serialize(value)]));\n\t\t};\n\t\tconst serializeChatEditingSessionStop = async (stop: IChatEditingSessionStop): Promise<IChatEditingSessionStopDTO> => {\n\t\t\treturn {\n\t\t\t\tstopId: stop.stopId,\n\t\t\t\tentries: await Promise.all(Array.from(stop.entries.values()).map(serializeSnapshotEntry))\n\t\t\t};\n\t\t};\n\t\tconst serializeSnapshotEntry = async (entry: ISnapshotEntry): Promise<ISnapshotEntryDTO> => {\n\t\t\treturn {\n\t\t\t\tresource: entry.resource.toString(),\n\t\t\t\tlanguageId: entry.languageId,\n\t\t\t\toriginalHash: await addFileContent(entry.original),\n\t\t\t\tcurrentHash: await addFileContent(entry.current),\n\t\t\t\tstate: entry.state,\n\t\t\t\tsnapshotUri: entry.snapshotUri.toString(),\n\t\t\t\ttelemetryInfo: { requestId: entry.telemetryInfo.requestId, agentId: entry.telemetryInfo.agentId, command: entry.telemetryInfo.command, modelId: entry.telemetryInfo.modelId, modeId: entry.telemetryInfo.modeId }\n\t\t\t};\n\t\t};\n\n\t\ttry {\n\t\t\tconst data: IChatEditingSessionDTO = {\n\t\t\t\tversion: STORAGE_VERSION,\n\t\t\t\tinitialFileContents: await serializeResourceMap(state.initialFileContents, value => addFileContent(value)),\n\t\t\t\ttimeline: state.timeline,\n\t\t\t\trecentSnapshot: await serializeChatEditingSessionStop(state.recentSnapshot),\n\t\t\t};\n\n\t\t\tthis._logService.debug(`chatEditingSession: Storing editing session at ${storageFolder.toString()}: ${contentWritePromises.size} files`);\n\n\t\t\tawait this._fileService.writeFile(joinPath(storageFolder, STORAGE_STATE_FILE), VSBuffer.fromString(JSON.stringify(data)));\n\t\t} catch (e) {\n\t\t\tthis._logService.debug(`Error storing chat editing session to ${storageFolder.toString()}`, e);\n\t\t}\n\t}\n\n\tpublic async clearState(): Promise<void> {\n\t\tconst storageFolder = this._getStorageLocation();\n\t\tif (await this._fileService.exists(storageFolder)) {\n\t\t\tthis._logService.debug(`chatEditingSession: Clearing editing session at ${storageFolder.toString()}`);\n\t\t\ttry {\n\t\t\t\tawait this._fileService.del(storageFolder, { recursive: true });\n\t\t\t} catch (e) {\n\t\t\t\tthis._logService.debug(`Error clearing chat editing session from ${storageFolder.toString()}`, e);\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport interface IChatEditingSessionSnapshot {\n\t/**\n\t * Index of this session in the linear history. It's the sum of the lengths\n\t * of all {@link stops} prior this one.\n\t */\n\treadonly startIndex: number;\n\n\treadonly requestId: string | undefined;\n\t/**\n\t * Edit stops in the request. Always initially populatd with stopId: undefind\n\t * for th request's initial state.\n\t *\n\t * Invariant: never empty.\n\t */\n\treadonly stops: IChatEditingSessionStop[];\n}\n\nexport interface IChatEditingSessionStop {\n\t/** Edit stop ID, first for a request is always undefined. */\n\tstopId: string | undefined;\n\n\treadonly entries: ResourceMap<ISnapshotEntry>;\n}\n\ninterface IChatEditingSessionStopDTO {\n\treadonly stopId: string | undefined;\n\treadonly entries: ISnapshotEntryDTO[];\n}\n\n\ninterface IChatEditingSessionSnapshotDTO {\n\treadonly requestId: string | undefined;\n\treadonly workingSet: ResourceMapDTO<WorkingSetDisplayMetadata>;\n\treadonly entries: ISnapshotEntryDTO[];\n}\n\ninterface ISnapshotEntryDTO {\n\treadonly resource: string;\n\treadonly languageId: string;\n\treadonly originalHash: string;\n\treadonly currentHash: string;\n\treadonly state: ModifiedFileEntryState;\n\treadonly snapshotUri: string;\n\treadonly telemetryInfo: IModifiedEntryTelemetryInfoDTO;\n}\n\ninterface IModifiedEntryTelemetryInfoDTO {\n\treadonly requestId: string;\n\treadonly agentId?: string;\n\treadonly command?: string;\n\n\treadonly modelId?: string;\n\treadonly modeId?: 'ask' | 'edit' | 'agent' | 'custom' | 'applyCodeBlock' | undefined;\n\treadonly applyCodeBlockSuggestionId?: EditSuggestionId | undefined;\n\treadonly feature?: 'sideBarChat' | 'inlineChat' | undefined;\n}\n\ntype ResourceMapDTO<T> = [string, T][];\n\nconst COMPATIBLE_STORAGE_VERSIONS = [1, 2];\nconst STORAGE_VERSION = 2;\n\n/** Old history uses IChatEditingSessionSnapshotDTO, new history uses IChatEditingSessionSnapshotDTO. */\ninterface IChatEditingSessionDTO {\n\treadonly version: number;\n\treadonly recentSnapshot: (IChatEditingSessionStopDTO | IChatEditingSessionSnapshotDTO);\n\treadonly timeline: Dto<IChatEditingTimelineState> | undefined;\n\treadonly initialFileContents: ResourceMapDTO<string>;\n}\n"]}