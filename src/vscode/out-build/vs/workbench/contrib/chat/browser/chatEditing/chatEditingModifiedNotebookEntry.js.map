{"version":3,"sources":["vs/workbench/contrib/chat/browser/chatEditing/chatEditingModifiedNotebookEntry.ts"],"names":[],"mappings":"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","file":"chatEditingModifiedNotebookEntry.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { streamToBuffer } from '../../../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { StringSHA1 } from '../../../../../base/common/hash.js';\nimport { DisposableStore, IReference, thenRegisterOrDispose } from '../../../../../base/common/lifecycle.js';\nimport { ResourceMap, ResourceSet } from '../../../../../base/common/map.js';\nimport { Schemas } from '../../../../../base/common/network.js';\nimport { ITransaction, IObservable, observableValue, autorun, transaction, ObservablePromise } from '../../../../../base/common/observable.js';\nimport { isEqual } from '../../../../../base/common/resources.js';\nimport { assertType } from '../../../../../base/common/types.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../../base/common/uuid.js';\nimport { LineRange } from '../../../../../editor/common/core/ranges/lineRange.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { nullDocumentDiff } from '../../../../../editor/common/diff/documentDiffProvider.js';\nimport { DetailedLineRangeMapping, RangeMapping } from '../../../../../editor/common/diff/rangeMapping.js';\nimport { Location, TextEdit } from '../../../../../editor/common/languages.js';\nimport { ITextModel } from '../../../../../editor/common/model.js';\nimport { IModelService } from '../../../../../editor/common/services/model.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { localize } from '../../../../../nls.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { IFileService } from '../../../../../platform/files/common/files.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IUndoRedoElement, IUndoRedoService, UndoRedoElementType } from '../../../../../platform/undoRedo/common/undoRedo.js';\nimport { IEditorPane, SaveReason } from '../../../../common/editor.js';\nimport { IFilesConfigurationService } from '../../../../services/filesConfiguration/common/filesConfigurationService.js';\nimport { SnapshotContext } from '../../../../services/workingCopy/common/fileWorkingCopy.js';\nimport { NotebookTextDiffEditor } from '../../../notebook/browser/diff/notebookDiffEditor.js';\nimport { INotebookTextDiffEditor } from '../../../notebook/browser/diff/notebookDiffEditorBrowser.js';\nimport { CellDiffInfo } from '../../../notebook/browser/diff/notebookDiffViewModel.js';\nimport { getNotebookEditorFromEditorPane } from '../../../notebook/browser/notebookBrowser.js';\nimport { NotebookCellTextModel } from '../../../notebook/common/model/notebookCellTextModel.js';\nimport { NotebookTextModel } from '../../../notebook/common/model/notebookTextModel.js';\nimport { CellEditType, ICellDto2, ICellEditOperation, ICellReplaceEdit, IResolvedNotebookEditorModel, NotebookCellsChangeType, NotebookSetting, NotebookTextModelChangedEvent, TransientOptions } from '../../../notebook/common/notebookCommon.js';\nimport { computeDiff } from '../../../notebook/common/notebookDiff.js';\nimport { INotebookEditorModelResolverService } from '../../../notebook/common/notebookEditorModelResolverService.js';\nimport { INotebookLoggingService } from '../../../notebook/common/notebookLoggingService.js';\nimport { INotebookService } from '../../../notebook/common/notebookService.js';\nimport { INotebookEditorWorkerService } from '../../../notebook/common/services/notebookWorkerService.js';\nimport { ChatEditKind, IModifiedEntryTelemetryInfo, IModifiedFileEntryEditorIntegration, ISnapshotEntry, ModifiedFileEntryState } from '../../common/chatEditingService.js';\nimport { IChatResponseModel } from '../../common/chatModel.js';\nimport { IChatService } from '../../common/chatService.js';\nimport { AbstractChatEditingModifiedFileEntry } from './chatEditingModifiedFileEntry.js';\nimport { createSnapshot, deserializeSnapshot, getNotebookSnapshotFileURI, restoreSnapshot, SnapshotComparer } from './notebook/chatEditingModifiedNotebookSnapshot.js';\nimport { ChatEditingNewNotebookContentEdits } from './notebook/chatEditingNewNotebookContentEdits.js';\nimport { ChatEditingNotebookCellEntry } from './notebook/chatEditingNotebookCellEntry.js';\nimport { ChatEditingNotebookDiffEditorIntegration, ChatEditingNotebookEditorIntegration } from './notebook/chatEditingNotebookEditorIntegration.js';\nimport { ChatEditingNotebookFileSystemProvider } from './notebook/chatEditingNotebookFileSystemProvider.js';\nimport { adjustCellDiffAndOriginalModelBasedOnCellAddDelete, adjustCellDiffAndOriginalModelBasedOnCellMovements, adjustCellDiffForKeepingAnInsertedCell, adjustCellDiffForRevertingADeletedCell, adjustCellDiffForRevertingAnInsertedCell, calculateNotebookRewriteRatio, getCorrespondingOriginalCellIndex, isTransientIPyNbExtensionEvent } from './notebook/helpers.js';\nimport { countChanges, ICellDiffInfo, sortCellChanges } from './notebook/notebookCellChanges.js';\nimport { IAiEditTelemetryService } from '../../../editTelemetry/browser/telemetry/aiEditTelemetry/aiEditTelemetryService.js';\n\n\nconst SnapshotLanguageId = 'VSCodeChatNotebookSnapshotLanguage';\n\nexport class ChatEditingModifiedNotebookEntry extends AbstractChatEditingModifiedFileEntry {\n\tstatic NewModelCounter: number = 0;\n\tprivate readonly modifiedModel: NotebookTextModel;\n\tprivate readonly originalModel: NotebookTextModel;\n\toverride originalURI: URI;\n\t/**\n\t * JSON stringified version of the original notebook.\n\t */\n\toverride initialContent: string;\n\t/**\n\t * Whether we're still generating diffs from a response.\n\t */\n\tprivate _isProcessingResponse = observableValue<boolean>('isProcessingResponse', false);\n\tget isProcessingResponse(): IObservable<boolean> {\n\t\treturn this._isProcessingResponse;\n\t}\n\tprivate _isEditFromUs: boolean = false;\n\t/**\n\t * Whether all edits are from us, e.g. is possible a user has made edits, then this will be false.\n\t */\n\tprivate _allEditsAreFromUs: boolean = true;\n\tprivate readonly _changesCount = observableValue<number>(this, 0);\n\toverride changesCount: IObservable<number> = this._changesCount;\n\n\tprivate readonly cellEntryMap = new ResourceMap<ChatEditingNotebookCellEntry>();\n\tprivate modifiedToOriginalCell = new ResourceMap<URI>();\n\tprivate readonly _cellsDiffInfo = observableValue<ICellDiffInfo[]>('diffInfo', []);\n\n\tget cellsDiffInfo(): IObservable<ICellDiffInfo[]> {\n\t\treturn this._cellsDiffInfo;\n\t}\n\n\tget viewType() {\n\t\treturn this.modifiedModel.viewType;\n\t}\n\n\t/**\n\t * List of Cell URIs that are edited,\n\t * Will be cleared once all edits have been accepted.\n\t * I.e. this will only contain URIS while acceptAgentEdits is being called & before `isLastEdit` is sent.\n\t * I.e. this is populated only when edits are being streamed.\n\t */\n\tprivate readonly editedCells = new ResourceSet();\n\n\tpublic static async create(uri: URI, _multiDiffEntryDelegate: { collapse: (transaction: ITransaction | undefined) => void }, telemetryInfo: IModifiedEntryTelemetryInfo, chatKind: ChatEditKind, initialContent: string | undefined, instantiationService: IInstantiationService): Promise<AbstractChatEditingModifiedFileEntry> {\n\t\treturn instantiationService.invokeFunction(async accessor => {\n\t\t\tconst notebookService = accessor.get(INotebookService);\n\t\t\tconst resolver = accessor.get(INotebookEditorModelResolverService);\n\t\t\tconst configurationServie = accessor.get(IConfigurationService);\n\t\t\tconst resourceRef: IReference<IResolvedNotebookEditorModel> = await resolver.resolve(uri);\n\t\t\tconst notebook = resourceRef.object.notebook;\n\t\t\tconst originalUri = getNotebookSnapshotFileURI(telemetryInfo.sessionResource, telemetryInfo.requestId, generateUuid(), notebook.uri.scheme === Schemas.untitled ? `/${notebook.uri.path}` : notebook.uri.path, notebook.viewType);\n\t\t\tconst [options, buffer] = await Promise.all([\n\t\t\t\tnotebookService.withNotebookDataProvider(resourceRef.object.notebook.notebookType),\n\t\t\t\tnotebookService.createNotebookTextDocumentSnapshot(notebook.uri, SnapshotContext.Backup, CancellationToken.None).then(s => streamToBuffer(s))\n\t\t\t]);\n\t\t\tconst disposables = new DisposableStore();\n\t\t\t// Register so that we can load this from file system.\n\t\t\tdisposables.add(ChatEditingNotebookFileSystemProvider.registerFile(originalUri, buffer));\n\t\t\tconst originalRef = await resolver.resolve(originalUri, notebook.viewType);\n\t\t\tif (initialContent !== undefined) {\n\t\t\t\ttry {\n\t\t\t\t\trestoreSnapshot(originalRef.object.notebook, initialContent);\n\t\t\t\t} catch (ex) {\n\t\t\t\t\tconsole.error(`Error restoring snapshot: ${initialContent}`, ex);\n\t\t\t\t\tinitialContent = createSnapshot(notebook, options.serializer.options, configurationServie);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tinitialContent = createSnapshot(notebook, options.serializer.options, configurationServie);\n\t\t\t\t// Both models are the same, ensure the cell ids are the same, this way we get a perfect diffing.\n\t\t\t\t// No need to generate edits for this.\n\t\t\t\t// We want to ensure they are identitcal, possible original notebook was open and got modified.\n\t\t\t\t// Or something gets changed between serialization & deserialization of the snapshot into the original.\n\t\t\t\t// E.g. in jupyter notebooks the metadata contains transient data that gets updated after deserialization.\n\t\t\t\trestoreSnapshot(originalRef.object.notebook, initialContent);\n\t\t\t\tconst edits: ICellEditOperation[] = [];\n\t\t\t\tnotebook.cells.forEach((cell, index) => {\n\t\t\t\t\tconst internalId = generateCellHash(cell.uri);\n\t\t\t\t\tedits.push({ editType: CellEditType.PartialInternalMetadata, index, internalMetadata: { internalId } });\n\t\t\t\t});\n\t\t\t\tresourceRef.object.notebook.applyEdits(edits, true, undefined, () => undefined, undefined, false);\n\t\t\t\toriginalRef.object.notebook.applyEdits(edits, true, undefined, () => undefined, undefined, false);\n\t\t\t}\n\t\t\tconst instance = instantiationService.createInstance(ChatEditingModifiedNotebookEntry, resourceRef, originalRef, _multiDiffEntryDelegate, options.serializer.options, telemetryInfo, chatKind, initialContent);\n\t\t\tinstance._register(disposables);\n\t\t\treturn instance;\n\t\t});\n\t}\n\n\tpublic static canHandleSnapshotContent(initialContent: string | undefined): boolean {\n\t\tif (!initialContent) {\n\t\t\treturn false;\n\t\t}\n\n\t\ttry {\n\t\t\tdeserializeSnapshot(initialContent);\n\t\t\treturn true;\n\t\t} catch (ex) {\n\t\t\t// not a valid snapshot\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tpublic static canHandleSnapshot(snapshot: ISnapshotEntry): boolean {\n\t\tif (snapshot.languageId === SnapshotLanguageId && ChatEditingModifiedNotebookEntry.canHandleSnapshotContent(snapshot.current)) {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate readonly initialContentComparer: SnapshotComparer;\n\n\tconstructor(\n\t\tprivate readonly modifiedResourceRef: IReference<IResolvedNotebookEditorModel>,\n\t\toriginalResourceRef: IReference<IResolvedNotebookEditorModel>,\n\t\tprivate readonly _multiDiffEntryDelegate: { collapse: (transaction: ITransaction | undefined) => void },\n\t\tprivate readonly transientOptions: TransientOptions | undefined,\n\t\ttelemetryInfo: IModifiedEntryTelemetryInfo,\n\t\tkind: ChatEditKind,\n\t\tinitialContent: string,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IFilesConfigurationService fileConfigService: IFilesConfigurationService,\n\t\t@IChatService chatService: IChatService,\n\t\t@IFileService fileService: IFileService,\n\t\t@IInstantiationService instantiationService: IInstantiationService,\n\t\t@ITextModelService private readonly textModelService: ITextModelService,\n\t\t@IModelService private readonly modelService: IModelService,\n\t\t@IUndoRedoService undoRedoService: IUndoRedoService,\n\t\t@INotebookEditorWorkerService private readonly notebookEditorWorkerService: INotebookEditorWorkerService,\n\t\t@INotebookLoggingService private readonly loggingService: INotebookLoggingService,\n\t\t@INotebookEditorModelResolverService private readonly notebookResolver: INotebookEditorModelResolverService,\n\t\t@IAiEditTelemetryService aiEditTelemetryService: IAiEditTelemetryService,\n\t) {\n\t\tsuper(modifiedResourceRef.object.notebook.uri, telemetryInfo, kind, configurationService, fileConfigService, chatService, fileService, undoRedoService, instantiationService, aiEditTelemetryService);\n\t\tthis.initialContentComparer = new SnapshotComparer(initialContent);\n\t\tthis.modifiedModel = this._register(modifiedResourceRef).object.notebook;\n\t\tthis.originalModel = this._register(originalResourceRef).object.notebook;\n\t\tthis.originalURI = this.originalModel.uri;\n\t\tthis.initialContent = initialContent;\n\t\tthis.initializeModelsFromDiff();\n\t\tthis._register(this.modifiedModel.onDidChangeContent(this.mirrorNotebookEdits, this));\n\t}\n\n\tpublic override hasModificationAt(location: Location): boolean {\n\t\treturn this.cellEntryMap.get(location.uri)?.hasModificationAt(location.range) ?? false;\n\t}\n\n\tinitializeModelsFromDiffImpl(cellsDiffInfo: CellDiffInfo[]) {\n\t\tthis.cellEntryMap.forEach(entry => entry.dispose());\n\t\tthis.cellEntryMap.clear();\n\t\tconst diffs = cellsDiffInfo.map((cellDiff, i) => {\n\t\t\tswitch (cellDiff.type) {\n\t\t\t\tcase 'delete':\n\t\t\t\t\treturn this.createDeleteCellDiffInfo(cellDiff.originalCellIndex);\n\t\t\t\tcase 'insert':\n\t\t\t\t\treturn this.createInsertedCellDiffInfo(cellDiff.modifiedCellIndex);\n\t\t\t\tdefault:\n\t\t\t\t\treturn this.createModifiedCellDiffInfo(cellDiff.modifiedCellIndex, cellDiff.originalCellIndex);\n\t\t\t}\n\t\t});\n\t\tthis._cellsDiffInfo.set(diffs, undefined);\n\t\tthis._changesCount.set(countChanges(diffs), undefined);\n\t}\n\n\tgetIndexOfCellHandle(handle: number) {\n\t\treturn this.modifiedModel.cells.findIndex(c => c.handle === handle);\n\t}\n\n\tprivate computeRequestId: number = 0;\n\tasync initializeModelsFromDiff() {\n\t\tconst id = ++this.computeRequestId;\n\t\tif (this._areOriginalAndModifiedIdenticalImpl()) {\n\t\t\tconst cellsDiffInfo: CellDiffInfo[] = this.modifiedModel.cells.map((_, index) => {\n\t\t\t\treturn { type: 'unchanged', originalCellIndex: index, modifiedCellIndex: index } satisfies CellDiffInfo;\n\t\t\t});\n\t\t\tthis.initializeModelsFromDiffImpl(cellsDiffInfo);\n\t\t\treturn;\n\t\t}\n\t\tconst cellsDiffInfo: CellDiffInfo[] = [];\n\t\ttry {\n\t\t\tthis._isProcessingResponse.set(true, undefined);\n\t\t\tconst notebookDiff = await this.notebookEditorWorkerService.computeDiff(this.originalURI, this.modifiedURI);\n\t\t\tif (id !== this.computeRequestId || this._store.isDisposed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst result = computeDiff(this.originalModel, this.modifiedModel, notebookDiff);\n\t\t\tif (result.cellDiffInfo.length) {\n\t\t\t\tcellsDiffInfo.push(...result.cellDiffInfo);\n\t\t\t}\n\t\t} catch (ex) {\n\t\t\tthis.loggingService.error('Notebook Chat', 'Error computing diff:\\n' + ex);\n\t\t} finally {\n\t\t\tthis._isProcessingResponse.set(false, undefined);\n\t\t}\n\t\tthis.initializeModelsFromDiffImpl(cellsDiffInfo);\n\t}\n\tupdateCellDiffInfo(cellsDiffInfo: ICellDiffInfo[], transcation: ITransaction | undefined) {\n\t\tthis._cellsDiffInfo.set(sortCellChanges(cellsDiffInfo), transcation);\n\t\tthis._changesCount.set(countChanges(cellsDiffInfo), transcation);\n\t}\n\n\tmirrorNotebookEdits(e: NotebookTextModelChangedEvent) {\n\t\tif (this._isEditFromUs || this._isExternalEditInProgress || Array.from(this.cellEntryMap.values()).some(entry => entry.isEditFromUs)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Possible user reverted the changes from SCM or the like.\n\t\t// Or user just reverted the changes made via edits (e.g. edit made a change in a cell and user undid that change either by typing over or other).\n\t\t// Computing snapshot is too slow, as this event gets triggered for every key stroke in a cell,\n\t\t// const didResetToOriginalContent = createSnapshot(this.modifiedModel, this.transientOptions, this.configurationService) === this.initialContent;\n\t\tlet didResetToOriginalContent = this.initialContentComparer.isEqual(this.modifiedModel);\n\t\tconst currentState = this._stateObs.get();\n\t\tif (currentState === ModifiedFileEntryState.Modified && didResetToOriginalContent) {\n\t\t\tthis._stateObs.set(ModifiedFileEntryState.Rejected, undefined);\n\t\t\tthis.updateCellDiffInfo([], undefined);\n\t\t\tthis.initializeModelsFromDiff();\n\t\t\tthis._notifySessionAction('rejected');\n\t\t\treturn;\n\t\t}\n\n\t\tif (!e.rawEvents.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (currentState === ModifiedFileEntryState.Rejected) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (isTransientIPyNbExtensionEvent(this.modifiedModel.notebookType, e)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._allEditsAreFromUs = false;\n\t\tthis._userEditScheduler.schedule();\n\n\t\t// Changes to cell text is sync'ed and handled separately.\n\t\t// See ChatEditingNotebookCellEntry._mirrorEdits\n\t\tfor (const event of e.rawEvents.filter(event => event.kind !== NotebookCellsChangeType.ChangeCellContent)) {\n\t\t\tswitch (event.kind) {\n\t\t\t\tcase NotebookCellsChangeType.ChangeDocumentMetadata: {\n\t\t\t\t\tconst edit: ICellEditOperation = {\n\t\t\t\t\t\teditType: CellEditType.DocumentMetadata,\n\t\t\t\t\t\tmetadata: this.modifiedModel.metadata\n\t\t\t\t\t};\n\t\t\t\t\tthis.originalModel.applyEdits([edit], true, undefined, () => undefined, undefined, false);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase NotebookCellsChangeType.ModelChange: {\n\t\t\t\t\tlet cellDiffs = sortCellChanges(this._cellsDiffInfo.get());\n\t\t\t\t\t// Ensure the new notebook cells have internalIds\n\t\t\t\t\tthis._applyEditsSync(() => {\n\t\t\t\t\t\tevent.changes.forEach(change => {\n\t\t\t\t\t\t\tchange[2].forEach((cell, i) => {\n\t\t\t\t\t\t\t\tif (cell.internalMetadata.internalId) {\n\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tconst index = change[0] + i;\n\t\t\t\t\t\t\t\tconst internalId = generateCellHash(cell.uri);\n\t\t\t\t\t\t\t\tconst edits: ICellEditOperation[] = [{ editType: CellEditType.PartialInternalMetadata, index, internalMetadata: { internalId } }];\n\t\t\t\t\t\t\t\tthis.modifiedModel.applyEdits(edits, true, undefined, () => undefined, undefined, false);\n\t\t\t\t\t\t\t\tcell.internalMetadata ??= {};\n\t\t\t\t\t\t\t\tcell.internalMetadata.internalId = internalId;\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t\tevent.changes.forEach(change => {\n\t\t\t\t\t\tcellDiffs = adjustCellDiffAndOriginalModelBasedOnCellAddDelete(change,\n\t\t\t\t\t\t\tcellDiffs,\n\t\t\t\t\t\t\tthis.modifiedModel.cells.length,\n\t\t\t\t\t\t\tthis.originalModel.cells.length,\n\t\t\t\t\t\t\tthis.originalModel.applyEdits.bind(this.originalModel),\n\t\t\t\t\t\t\tthis.createModifiedCellDiffInfo.bind(this));\n\t\t\t\t\t});\n\t\t\t\t\tthis.updateCellDiffInfo(cellDiffs, undefined);\n\t\t\t\t\tthis.disposeDeletedCellEntries();\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase NotebookCellsChangeType.ChangeCellLanguage: {\n\t\t\t\t\tconst index = getCorrespondingOriginalCellIndex(event.index, this._cellsDiffInfo.get());\n\t\t\t\t\tif (typeof index === 'number') {\n\t\t\t\t\t\tconst edit: ICellEditOperation = {\n\t\t\t\t\t\t\teditType: CellEditType.CellLanguage,\n\t\t\t\t\t\t\tindex,\n\t\t\t\t\t\t\tlanguage: event.language\n\t\t\t\t\t\t};\n\t\t\t\t\t\tthis.originalModel.applyEdits([edit], true, undefined, () => undefined, undefined, false);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase NotebookCellsChangeType.ChangeCellMetadata: {\n\t\t\t\t\t// ipynb and other extensions can alter metadata, ensure we update the original model in the corresponding cell.\n\t\t\t\t\tconst index = getCorrespondingOriginalCellIndex(event.index, this._cellsDiffInfo.get());\n\t\t\t\t\tif (typeof index === 'number') {\n\t\t\t\t\t\tconst edit: ICellEditOperation = {\n\t\t\t\t\t\t\teditType: CellEditType.Metadata,\n\t\t\t\t\t\t\tindex,\n\t\t\t\t\t\t\tmetadata: event.metadata\n\t\t\t\t\t\t};\n\t\t\t\t\t\tthis.originalModel.applyEdits([edit], true, undefined, () => undefined, undefined, false);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase NotebookCellsChangeType.ChangeCellMime:\n\t\t\t\t\tbreak;\n\t\t\t\tcase NotebookCellsChangeType.ChangeCellInternalMetadata: {\n\t\t\t\t\tconst index = getCorrespondingOriginalCellIndex(event.index, this._cellsDiffInfo.get());\n\t\t\t\t\tif (typeof index === 'number') {\n\t\t\t\t\t\tconst edit: ICellEditOperation = {\n\t\t\t\t\t\t\teditType: CellEditType.PartialInternalMetadata,\n\t\t\t\t\t\t\tindex,\n\t\t\t\t\t\t\tinternalMetadata: event.internalMetadata\n\t\t\t\t\t\t};\n\t\t\t\t\t\tthis.originalModel.applyEdits([edit], true, undefined, () => undefined, undefined, false);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase NotebookCellsChangeType.Output: {\n\t\t\t\t\t// User can run cells.\n\t\t\t\t\tconst index = getCorrespondingOriginalCellIndex(event.index, this._cellsDiffInfo.get());\n\t\t\t\t\tif (typeof index === 'number') {\n\t\t\t\t\t\tconst edit: ICellEditOperation = {\n\t\t\t\t\t\t\teditType: CellEditType.Output,\n\t\t\t\t\t\t\tindex,\n\t\t\t\t\t\t\tappend: event.append,\n\t\t\t\t\t\t\toutputs: event.outputs\n\t\t\t\t\t\t};\n\t\t\t\t\t\tthis.originalModel.applyEdits([edit], true, undefined, () => undefined, undefined, false);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase NotebookCellsChangeType.OutputItem: {\n\t\t\t\t\tconst index = getCorrespondingOriginalCellIndex(event.index, this._cellsDiffInfo.get());\n\t\t\t\t\tif (typeof index === 'number') {\n\t\t\t\t\t\tconst edit: ICellEditOperation = {\n\t\t\t\t\t\t\teditType: CellEditType.OutputItems,\n\t\t\t\t\t\t\toutputId: event.outputId,\n\t\t\t\t\t\t\tappend: event.append,\n\t\t\t\t\t\t\titems: event.outputItems\n\t\t\t\t\t\t};\n\t\t\t\t\t\tthis.originalModel.applyEdits([edit], true, undefined, () => undefined, undefined, false);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase NotebookCellsChangeType.Move: {\n\t\t\t\t\tconst result = adjustCellDiffAndOriginalModelBasedOnCellMovements(event, this._cellsDiffInfo.get().slice());\n\t\t\t\t\tif (result) {\n\t\t\t\t\t\tthis.originalModel.applyEdits(result[1], true, undefined, () => undefined, undefined, false);\n\t\t\t\t\t\tthis._cellsDiffInfo.set(result[0], undefined);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault: {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tdidResetToOriginalContent = this.initialContentComparer.isEqual(this.modifiedModel);\n\t\tif (currentState === ModifiedFileEntryState.Modified && didResetToOriginalContent) {\n\t\t\tthis._stateObs.set(ModifiedFileEntryState.Rejected, undefined);\n\t\t\tthis.updateCellDiffInfo([], undefined);\n\t\t\tthis.initializeModelsFromDiff();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tprotected override async _doAccept(): Promise<void> {\n\t\tthis.updateCellDiffInfo([], undefined);\n\t\tconst snapshot = createSnapshot(this.modifiedModel, this.transientOptions, this.configurationService);\n\t\trestoreSnapshot(this.originalModel, snapshot);\n\t\tthis.initializeModelsFromDiff();\n\t\tawait this._collapse(undefined);\n\n\t\tconst config = this._fileConfigService.getAutoSaveConfiguration(this.modifiedURI);\n\t\tif (this.modifiedModel.uri.scheme !== Schemas.untitled && (!config.autoSave || !this.notebookResolver.isDirty(this.modifiedURI))) {\n\t\t\t// SAVE after accept for manual-savers, for auto-savers\n\t\t\t// trigger explict save to get save participants going\n\t\t\tawait this._applyEdits(async () => {\n\t\t\t\ttry {\n\t\t\t\t\tawait this.modifiedResourceRef.object.save({\n\t\t\t\t\t\treason: SaveReason.EXPLICIT,\n\t\t\t\t\t\tforce: true,\n\t\t\t\t\t});\n\t\t\t\t} catch {\n\t\t\t\t\t// ignored\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tprotected override async _doReject(): Promise<void> {\n\t\tthis.updateCellDiffInfo([], undefined);\n\t\tif (this.createdInRequestId === this._telemetryInfo.requestId) {\n\t\t\tawait this._applyEdits(async () => {\n\t\t\t\tawait this.modifiedResourceRef.object.revert({ soft: true });\n\t\t\t\tawait this._fileService.del(this.modifiedURI);\n\t\t\t});\n\t\t\tthis._onDidDelete.fire();\n\t\t} else {\n\t\t\tawait this._applyEdits(async () => {\n\t\t\t\tconst snapshot = createSnapshot(this.originalModel, this.transientOptions, this.configurationService);\n\t\t\t\tthis.restoreSnapshotInModifiedModel(snapshot);\n\t\t\t\tif (this._allEditsAreFromUs && Array.from(this.cellEntryMap.values()).every(entry => entry.allEditsAreFromUs)) {\n\t\t\t\t\t// save the file after discarding so that the dirty indicator goes away\n\t\t\t\t\t// and so that an intermediate saved state gets reverted\n\t\t\t\t\tawait this.modifiedResourceRef.object.save({ reason: SaveReason.EXPLICIT, skipSaveParticipants: true });\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis.initializeModelsFromDiff();\n\t\t\tawait this._collapse(undefined);\n\t\t}\n\t}\n\n\tprivate async _collapse(transaction: ITransaction | undefined): Promise<void> {\n\t\tthis._multiDiffEntryDelegate.collapse(transaction);\n\t}\n\n\tprotected override _createEditorIntegration(editor: IEditorPane): IModifiedFileEntryEditorIntegration {\n\t\tconst notebookEditor = getNotebookEditorFromEditorPane(editor);\n\t\tif (!notebookEditor && editor.getId() === NotebookTextDiffEditor.ID) {\n\t\t\tconst diffEditor = (editor.getControl() as INotebookTextDiffEditor);\n\t\t\treturn this._instantiationService.createInstance(ChatEditingNotebookDiffEditorIntegration, diffEditor, this._cellsDiffInfo);\n\t\t}\n\t\tassertType(notebookEditor);\n\t\treturn this._instantiationService.createInstance(ChatEditingNotebookEditorIntegration, this, editor, this.modifiedModel, this.originalModel, this._cellsDiffInfo);\n\t}\n\n\tprotected override _resetEditsState(tx: ITransaction): void {\n\t\tsuper._resetEditsState(tx);\n\t\tthis.cellEntryMap.forEach(entry => !entry.isDisposed && entry.clearCurrentEditLineDecoration());\n\t}\n\n\tprotected override _createUndoRedoElement(response: IChatResponseModel): IUndoRedoElement | undefined {\n\t\tconst request = response.session.getRequests().find(req => req.id === response.requestId);\n\t\tconst label = request?.message.text ? localize('chatNotebookEdit1', \"Chat Edit: '{0}'\", request.message.text) : localize('chatNotebookEdit2', \"Chat Edit\");\n\t\tconst transientOptions = this.transientOptions;\n\t\tconst outputSizeLimit = this.configurationService.getValue<number>(NotebookSetting.outputBackupSizeLimit) * 1024;\n\n\t\t// create a snapshot of the current state of the model, before the next set of edits\n\t\tlet initial = createSnapshot(this.modifiedModel, transientOptions, outputSizeLimit);\n\t\tlet last = '';\n\t\tlet redoState = ModifiedFileEntryState.Rejected;\n\n\t\treturn {\n\t\t\ttype: UndoRedoElementType.Resource,\n\t\t\tresource: this.modifiedURI,\n\t\t\tlabel,\n\t\t\tcode: 'chat.edit',\n\t\t\tconfirmBeforeUndo: false,\n\t\t\tundo: async () => {\n\t\t\t\tlast = createSnapshot(this.modifiedModel, transientOptions, outputSizeLimit);\n\t\t\t\tthis._isEditFromUs = true;\n\t\t\t\ttry {\n\t\t\t\t\trestoreSnapshot(this.modifiedModel, initial);\n\t\t\t\t\trestoreSnapshot(this.originalModel, initial);\n\t\t\t\t} finally {\n\t\t\t\t\tthis._isEditFromUs = false;\n\t\t\t\t}\n\t\t\t\tredoState = this._stateObs.get() === ModifiedFileEntryState.Accepted ? ModifiedFileEntryState.Accepted : ModifiedFileEntryState.Rejected;\n\t\t\t\tthis._stateObs.set(ModifiedFileEntryState.Rejected, undefined);\n\t\t\t\tthis.updateCellDiffInfo([], undefined);\n\t\t\t\tthis.initializeModelsFromDiff();\n\t\t\t\tthis._notifySessionAction('userModified');\n\t\t\t},\n\t\t\tredo: async () => {\n\t\t\t\tinitial = createSnapshot(this.modifiedModel, transientOptions, outputSizeLimit);\n\t\t\t\tthis._isEditFromUs = true;\n\t\t\t\ttry {\n\t\t\t\t\trestoreSnapshot(this.modifiedModel, last);\n\t\t\t\t\trestoreSnapshot(this.originalModel, last);\n\t\t\t\t} finally {\n\t\t\t\t\tthis._isEditFromUs = false;\n\t\t\t\t}\n\t\t\t\tthis._stateObs.set(redoState, undefined);\n\t\t\t\tthis.updateCellDiffInfo([], undefined);\n\t\t\t\tthis.initializeModelsFromDiff();\n\t\t\t\tthis._notifySessionAction('userModified');\n\t\t\t}\n\t\t};\n\t}\n\n\tprotected override async _areOriginalAndModifiedIdentical(): Promise<boolean> {\n\t\treturn this._areOriginalAndModifiedIdenticalImpl();\n\t}\n\n\tprivate _areOriginalAndModifiedIdenticalImpl(): boolean {\n\t\tconst snapshot = createSnapshot(this.originalModel, this.transientOptions, this.configurationService);\n\t\treturn new SnapshotComparer(snapshot).isEqual(this.modifiedModel);\n\t}\n\n\tprivate newNotebookEditGenerator?: ChatEditingNewNotebookContentEdits;\n\toverride async acceptAgentEdits(resource: URI, edits: (TextEdit | ICellEditOperation)[], isLastEdits: boolean, responseModel: IChatResponseModel | undefined): Promise<void> {\n\t\tconst isCellUri = resource.scheme === Schemas.vscodeNotebookCell;\n\t\tconst cell = isCellUri && this.modifiedModel.cells.find(cell => isEqual(cell.uri, resource));\n\t\tlet cellEntry: ChatEditingNotebookCellEntry | undefined;\n\t\tif (cell) {\n\t\t\tconst index = this.modifiedModel.cells.indexOf(cell);\n\t\t\tconst entry = this._cellsDiffInfo.get().slice().find(entry => entry.modifiedCellIndex === index);\n\t\t\tif (!entry) {\n\t\t\t\t// Not possible.\n\t\t\t\tconsole.error('Original cell model not found');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcellEntry = this.getOrCreateModifiedTextFileEntryForCell(cell, await entry.modifiedModel.promise, await entry.originalModel.promise);\n\t\t}\n\n\t\t// For all cells that were edited, send the `isLastEdits` flag.\n\t\tconst finishPreviousCells = async () => {\n\t\t\tawait Promise.all(Array.from(this.editedCells).map(async (uri) => {\n\t\t\t\tconst cell = this.modifiedModel.cells.find(cell => isEqual(cell.uri, uri));\n\t\t\t\tconst cellEntry = cell && this.cellEntryMap.get(cell.uri);\n\t\t\t\tawait cellEntry?.acceptAgentEdits([], true, responseModel);\n\t\t\t}));\n\t\t\tthis.editedCells.clear();\n\t\t};\n\n\t\tawait this._applyEdits(async () => {\n\t\t\tawait Promise.all(edits.map(async (edit, idx) => {\n\t\t\t\tconst last = isLastEdits && idx === edits.length - 1;\n\t\t\t\tif (TextEdit.isTextEdit(edit)) {\n\t\t\t\t\t// Possible we're getting the raw content for the notebook.\n\t\t\t\t\tif (isEqual(resource, this.modifiedModel.uri)) {\n\t\t\t\t\t\tthis.newNotebookEditGenerator ??= this._instantiationService.createInstance(ChatEditingNewNotebookContentEdits, this.modifiedModel);\n\t\t\t\t\t\tthis.newNotebookEditGenerator.acceptTextEdits([edit]);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// If we get cell edits, its impossible to get text edits for the notebook uri.\n\t\t\t\t\t\tthis.newNotebookEditGenerator = undefined;\n\t\t\t\t\t\tif (!this.editedCells.has(resource)) {\n\t\t\t\t\t\t\tawait finishPreviousCells();\n\t\t\t\t\t\t\tthis.editedCells.add(resource);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tawait cellEntry?.acceptAgentEdits([edit], last, responseModel);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// If we notebook edits, its impossible to get text edits for the notebook uri.\n\t\t\t\t\tthis.newNotebookEditGenerator = undefined;\n\t\t\t\t\tthis.acceptNotebookEdit(edit);\n\t\t\t\t}\n\t\t\t}));\n\t\t});\n\n\t\t// If the last edit for a cell was sent, then handle it\n\t\tif (isLastEdits) {\n\t\t\tawait finishPreviousCells();\n\t\t}\n\n\t\t// isLastEdits can be true for cell Uris, but when its true for Cells edits.\n\t\t// It cannot be true for the notebook itself.\n\t\tisLastEdits = !isCellUri && isLastEdits;\n\n\t\t// If this is the last edit and & we got regular text edits for generating new notebook content\n\t\t// Then generate notebook edits from those text edits & apply those notebook edits.\n\t\tif (isLastEdits && this.newNotebookEditGenerator) {\n\t\t\tconst notebookEdits = await this.newNotebookEditGenerator.generateEdits();\n\t\t\tthis.newNotebookEditGenerator = undefined;\n\t\t\tnotebookEdits.forEach(edit => this.acceptNotebookEdit(edit));\n\t\t}\n\n\t\ttransaction((tx) => {\n\t\t\tthis._stateObs.set(ModifiedFileEntryState.Modified, tx);\n\t\t\tif (!isLastEdits) {\n\t\t\t\tconst newRewriteRation = Math.max(this._rewriteRatioObs.get(), calculateNotebookRewriteRatio(this._cellsDiffInfo.get(), this.originalModel, this.modifiedModel));\n\t\t\t\tthis._rewriteRatioObs.set(Math.min(1, newRewriteRation), tx);\n\t\t\t} else {\n\t\t\t\tthis.editedCells.clear();\n\t\t\t\tthis._resetEditsState(tx);\n\t\t\t\tthis._rewriteRatioObs.set(1, tx);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate disposeDeletedCellEntries() {\n\t\tconst cellsUris = new ResourceSet(this.modifiedModel.cells.map(cell => cell.uri));\n\t\tArray.from(this.cellEntryMap.keys()).forEach(uri => {\n\t\t\tif (cellsUris.has(uri)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.cellEntryMap.get(uri)?.dispose();\n\t\t\tthis.cellEntryMap.delete(uri);\n\t\t});\n\t}\n\n\tacceptNotebookEdit(edit: ICellEditOperation): void {\n\t\t// make the actual edit\n\t\tthis.modifiedModel.applyEdits([edit], true, undefined, () => undefined, undefined, false);\n\t\tthis.disposeDeletedCellEntries();\n\n\n\t\tif (edit.editType !== CellEditType.Replace) {\n\t\t\treturn;\n\t\t}\n\t\t// Ensure cells have internal Ids.\n\t\tedit.cells.forEach((_, i) => {\n\t\t\tconst index = edit.index + i;\n\t\t\tconst cell = this.modifiedModel.cells[index];\n\t\t\tif (cell.internalMetadata.internalId) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst internalId = generateCellHash(cell.uri);\n\t\t\tconst edits: ICellEditOperation[] = [{ editType: CellEditType.PartialInternalMetadata, index, internalMetadata: { internalId } }];\n\t\t\tthis.modifiedModel.applyEdits(edits, true, undefined, () => undefined, undefined, false);\n\t\t});\n\n\t\tlet diff: ICellDiffInfo[] = [];\n\t\tif (edit.count === 0) {\n\t\t\t// All existing indexes are shifted by number of cells added.\n\t\t\tdiff = sortCellChanges(this._cellsDiffInfo.get());\n\t\t\tdiff.forEach(d => {\n\t\t\t\tif (d.type !== 'delete' && d.modifiedCellIndex >= edit.index) {\n\t\t\t\t\td.modifiedCellIndex += edit.cells.length;\n\t\t\t\t}\n\t\t\t});\n\t\t\tconst diffInsert = edit.cells.map((_, i) => this.createInsertedCellDiffInfo(edit.index + i));\n\t\t\tdiff.splice(edit.index, 0, ...diffInsert);\n\t\t} else {\n\t\t\t// All existing indexes are shifted by number of cells removed.\n\t\t\t// And unchanged cells should be converted to deleted cells.\n\t\t\tdiff = sortCellChanges(this._cellsDiffInfo.get()).map((d) => {\n\t\t\t\tif (d.type === 'unchanged' && d.modifiedCellIndex >= edit.index && d.modifiedCellIndex <= (edit.index + edit.count - 1)) {\n\t\t\t\t\treturn this.createDeleteCellDiffInfo(d.originalCellIndex);\n\t\t\t\t}\n\t\t\t\tif (d.type !== 'delete' && d.modifiedCellIndex >= (edit.index + edit.count)) {\n\t\t\t\t\td.modifiedCellIndex -= edit.count;\n\t\t\t\t\treturn d;\n\t\t\t\t}\n\t\t\t\treturn d;\n\t\t\t});\n\t\t}\n\t\tthis.updateCellDiffInfo(diff, undefined);\n\t}\n\n\tprivate computeStateAfterAcceptingRejectingChanges(accepted: boolean) {\n\t\tconst currentSnapshot = createSnapshot(this.modifiedModel, this.transientOptions, this.configurationService);\n\t\tif (new SnapshotComparer(currentSnapshot).isEqual(this.originalModel)) {\n\t\t\tconst state = accepted ? ModifiedFileEntryState.Accepted : ModifiedFileEntryState.Rejected;\n\t\t\tthis._stateObs.set(state, undefined);\n\t\t\tthis._notifySessionAction(accepted ? 'accepted' : 'rejected');\n\t\t}\n\t}\n\n\tcreateModifiedCellDiffInfo(modifiedCellIndex: number, originalCellIndex: number): ICellDiffInfo {\n\t\tconst modifiedCell = this.modifiedModel.cells[modifiedCellIndex];\n\t\tconst originalCell = this.originalModel.cells[originalCellIndex];\n\t\tthis.modifiedToOriginalCell.set(modifiedCell.uri, originalCell.uri);\n\t\tconst modifiedCellModelPromise = this.resolveCellModel(modifiedCell.uri);\n\t\tconst originalCellModelPromise = this.resolveCellModel(originalCell.uri);\n\n\t\tPromise.all([modifiedCellModelPromise, originalCellModelPromise]).then(([modifiedCellModel, originalCellModel]) => {\n\t\t\tthis.getOrCreateModifiedTextFileEntryForCell(modifiedCell, modifiedCellModel, originalCellModel);\n\t\t});\n\n\t\tconst diff = observableValue('diff', nullDocumentDiff);\n\t\tconst unchangedCell: ICellDiffInfo = {\n\t\t\ttype: 'unchanged',\n\t\t\tmodifiedCellIndex,\n\t\t\toriginalCellIndex,\n\t\t\tkeep: async (changes: DetailedLineRangeMapping) => {\n\t\t\t\tconst [modifiedCellModel, originalCellModel] = await Promise.all([modifiedCellModelPromise, originalCellModelPromise]);\n\t\t\t\tconst entry = this.getOrCreateModifiedTextFileEntryForCell(modifiedCell, modifiedCellModel, originalCellModel);\n\t\t\t\treturn entry ? entry.keep(changes) : false;\n\t\t\t},\n\t\t\tundo: async (changes: DetailedLineRangeMapping) => {\n\t\t\t\tconst [modifiedCellModel, originalCellModel] = await Promise.all([modifiedCellModelPromise, originalCellModelPromise]);\n\t\t\t\tconst entry = this.getOrCreateModifiedTextFileEntryForCell(modifiedCell, modifiedCellModel, originalCellModel);\n\t\t\t\treturn entry ? entry.undo(changes) : false;\n\t\t\t},\n\t\t\tmodifiedModel: new ObservablePromise(modifiedCellModelPromise),\n\t\t\toriginalModel: new ObservablePromise(originalCellModelPromise),\n\t\t\tdiff\n\t\t};\n\n\t\treturn unchangedCell;\n\n\t}\n\tcreateInsertedCellDiffInfo(modifiedCellIndex: number): ICellDiffInfo {\n\t\tconst cell = this.modifiedModel.cells[modifiedCellIndex];\n\t\tconst lines = cell.getValue().split(/\\r?\\n/);\n\t\tconst originalRange = new Range(1, 0, 1, 0);\n\t\tconst modifiedRange = new Range(1, 0, lines.length, lines[lines.length - 1].length);\n\t\tconst innerChanges = new RangeMapping(originalRange, modifiedRange);\n\t\tconst changes = [new DetailedLineRangeMapping(new LineRange(1, 1), new LineRange(1, lines.length), [innerChanges])];\n\t\t// When a new cell is inserted, we use the ChatEditingCodeEditorIntegration to handle the edits.\n\t\t// & to also display undo/redo and decorations.\n\t\t// However that needs a modified and original model.\n\t\t// For inserted cells there's no original model, so we create a new empty text model and pass that as the original.\n\t\tconst originalModelUri = this.modifiedModel.uri.with({ query: (ChatEditingModifiedNotebookEntry.NewModelCounter++).toString(), scheme: 'emptyCell' });\n\t\tconst originalModel = this.modelService.getModel(originalModelUri) || this._register(this.modelService.createModel('', null, originalModelUri));\n\t\tthis.modifiedToOriginalCell.set(cell.uri, originalModelUri);\n\t\tconst keep = async () => {\n\t\t\tthis._applyEditsSync(() => this.keepPreviouslyInsertedCell(cell));\n\t\t\tthis.computeStateAfterAcceptingRejectingChanges(true);\n\t\t\treturn true;\n\t\t};\n\t\tconst undo = async () => {\n\t\t\tthis._applyEditsSync(() => this.undoPreviouslyInsertedCell(cell));\n\t\t\tthis.computeStateAfterAcceptingRejectingChanges(false);\n\t\t\treturn true;\n\t\t};\n\t\tthis.resolveCellModel(cell.uri).then(modifiedModel => {\n\t\t\tif (this._store.isDisposed) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// We want decorators for the cell just as we display decorators for modified cells.\n\t\t\t// This way we have the ability to accept/reject the entire cell.\n\t\t\tthis.getOrCreateModifiedTextFileEntryForCell(cell, modifiedModel, originalModel);\n\t\t});\n\t\treturn {\n\t\t\ttype: 'insert' as const,\n\t\t\toriginalCellIndex: undefined,\n\t\t\tmodifiedCellIndex: modifiedCellIndex,\n\t\t\tkeep,\n\t\t\tundo,\n\t\t\tmodifiedModel: new ObservablePromise(this.resolveCellModel(cell.uri)),\n\t\t\toriginalModel: new ObservablePromise(Promise.resolve(originalModel)),\n\t\t\tdiff: observableValue('deletedCellDiff', {\n\t\t\t\tchanges,\n\t\t\t\tidentical: false,\n\t\t\t\tmoves: [],\n\t\t\t\tquitEarly: false,\n\t\t\t})\n\t\t} satisfies ICellDiffInfo;\n\t}\n\tcreateDeleteCellDiffInfo(originalCellIndex: number): ICellDiffInfo {\n\t\tconst originalCell = this.originalModel.cells[originalCellIndex];\n\t\tconst lines = new Array(originalCell.textBuffer.getLineCount()).fill(0).map((_, i) => originalCell.textBuffer.getLineContent(i + 1));\n\t\tconst originalRange = new Range(1, 0, lines.length, lines[lines.length - 1].length);\n\t\tconst modifiedRange = new Range(1, 0, 1, 0);\n\t\tconst innerChanges = new RangeMapping(modifiedRange, originalRange);\n\t\tconst changes = [new DetailedLineRangeMapping(new LineRange(1, lines.length), new LineRange(1, 1), [innerChanges])];\n\t\tconst modifiedModelUri = this.modifiedModel.uri.with({ query: (ChatEditingModifiedNotebookEntry.NewModelCounter++).toString(), scheme: 'emptyCell' });\n\t\tconst modifiedModel = this.modelService.getModel(modifiedModelUri) || this._register(this.modelService.createModel('', null, modifiedModelUri));\n\t\tconst keep = async () => {\n\t\t\tthis._applyEditsSync(() => this.keepPreviouslyDeletedCell(this.originalModel.cells.indexOf(originalCell)));\n\t\t\tthis.computeStateAfterAcceptingRejectingChanges(true);\n\t\t\treturn true;\n\t\t};\n\t\tconst undo = async () => {\n\t\t\tthis._applyEditsSync(() => this.undoPreviouslyDeletedCell(this.originalModel.cells.indexOf(originalCell), originalCell));\n\t\t\tthis.computeStateAfterAcceptingRejectingChanges(false);\n\t\t\treturn true;\n\t\t};\n\n\t\t// This will be deleted.\n\t\treturn {\n\t\t\ttype: 'delete' as const,\n\t\t\tmodifiedCellIndex: undefined,\n\t\t\toriginalCellIndex,\n\t\t\toriginalModel: new ObservablePromise(this.resolveCellModel(originalCell.uri)),\n\t\t\tmodifiedModel: new ObservablePromise(Promise.resolve(modifiedModel)),\n\t\t\tkeep,\n\t\t\tundo,\n\t\t\tdiff: observableValue('cellDiff', {\n\t\t\t\tchanges,\n\t\t\t\tidentical: false,\n\t\t\t\tmoves: [],\n\t\t\t\tquitEarly: false,\n\t\t\t})\n\t\t} satisfies ICellDiffInfo;\n\t}\n\n\tprivate undoPreviouslyInsertedCell(cell: NotebookCellTextModel) {\n\t\tlet diffs: ICellDiffInfo[] = [];\n\t\tthis._applyEditsSync(() => {\n\t\t\tconst index = this.modifiedModel.cells.indexOf(cell);\n\t\t\tdiffs = adjustCellDiffForRevertingAnInsertedCell(index,\n\t\t\t\tthis._cellsDiffInfo.get(),\n\t\t\t\tthis.modifiedModel.applyEdits.bind(this.modifiedModel));\n\t\t});\n\t\tthis.disposeDeletedCellEntries();\n\t\tthis.updateCellDiffInfo(diffs, undefined);\n\t}\n\n\tprivate keepPreviouslyInsertedCell(cell: NotebookCellTextModel) {\n\t\tconst modifiedCellIndex = this.modifiedModel.cells.indexOf(cell);\n\t\tif (modifiedCellIndex === -1) {\n\t\t\t// Not possible.\n\t\t\treturn;\n\t\t}\n\t\tconst cellToInsert: ICellDto2 = {\n\t\t\tcellKind: cell.cellKind,\n\t\t\tlanguage: cell.language,\n\t\t\tmetadata: cell.metadata,\n\t\t\toutputs: cell.outputs,\n\t\t\tsource: cell.getValue(),\n\t\t\tmime: cell.mime,\n\t\t\tinternalMetadata: {\n\t\t\t\tinternalId: cell.internalMetadata.internalId\n\t\t\t}\n\t\t};\n\t\tthis.cellEntryMap.get(cell.uri)?.dispose();\n\t\tthis.cellEntryMap.delete(cell.uri);\n\t\tconst cellDiffs = adjustCellDiffForKeepingAnInsertedCell(\n\t\t\tmodifiedCellIndex,\n\t\t\tthis._cellsDiffInfo.get().slice(),\n\t\t\tcellToInsert,\n\t\t\tthis.originalModel.applyEdits.bind(this.originalModel),\n\t\t\tthis.createModifiedCellDiffInfo.bind(this)\n\t\t);\n\t\tthis.updateCellDiffInfo(cellDiffs, undefined);\n\t}\n\n\tprivate undoPreviouslyDeletedCell(deletedOriginalIndex: number, originalCell: NotebookCellTextModel) {\n\t\tconst cellToInsert: ICellDto2 = {\n\t\t\tcellKind: originalCell.cellKind,\n\t\t\tlanguage: originalCell.language,\n\t\t\tmetadata: originalCell.metadata,\n\t\t\toutputs: originalCell.outputs,\n\t\t\tsource: originalCell.getValue(),\n\t\t\tmime: originalCell.mime,\n\t\t\tinternalMetadata: {\n\t\t\t\tinternalId: originalCell.internalMetadata.internalId\n\t\t\t}\n\t\t};\n\t\tlet cellDiffs: ICellDiffInfo[] = [];\n\t\tthis._applyEditsSync(() => {\n\t\t\tcellDiffs = adjustCellDiffForRevertingADeletedCell(\n\t\t\t\tdeletedOriginalIndex,\n\t\t\t\tthis._cellsDiffInfo.get(),\n\t\t\t\tcellToInsert,\n\t\t\t\tthis.modifiedModel.applyEdits.bind(this.modifiedModel),\n\t\t\t\tthis.createModifiedCellDiffInfo.bind(this)\n\t\t\t);\n\t\t});\n\t\tthis.updateCellDiffInfo(cellDiffs, undefined);\n\t}\n\n\n\tprivate keepPreviouslyDeletedCell(deletedOriginalIndex: number) {\n\t\t// Delete this cell from original as well.\n\t\tconst edit: ICellReplaceEdit = { cells: [], count: 1, editType: CellEditType.Replace, index: deletedOriginalIndex, };\n\t\tthis.originalModel.applyEdits([edit], true, undefined, () => undefined, undefined, false);\n\t\tconst diffs = sortCellChanges(this._cellsDiffInfo.get())\n\t\t\t.filter(d => !(d.type === 'delete' && d.originalCellIndex === deletedOriginalIndex))\n\t\t\t.map(diff => {\n\t\t\t\tif (diff.type !== 'insert' && diff.originalCellIndex > deletedOriginalIndex) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...diff,\n\t\t\t\t\t\toriginalCellIndex: diff.originalCellIndex - 1,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t\treturn diff;\n\t\t\t});\n\t\tthis.updateCellDiffInfo(diffs, undefined);\n\t}\n\n\tprivate async _applyEdits(operation: () => Promise<void>) {\n\t\t// make the actual edit\n\t\tthis._isEditFromUs = true;\n\t\ttry {\n\t\t\tawait operation();\n\t\t} finally {\n\t\t\tthis._isEditFromUs = false;\n\t\t}\n\t}\n\n\tprivate _applyEditsSync(operation: () => void) {\n\t\t// make the actual edit\n\t\tthis._isEditFromUs = true;\n\t\ttry {\n\t\t\toperation();\n\t\t} finally {\n\t\t\tthis._isEditFromUs = false;\n\t\t}\n\t}\n\n\tpublic getCurrentSnapshot() {\n\t\treturn createSnapshot(this.modifiedModel, this.transientOptions, this.configurationService);\n\t}\n\n\toverride createSnapshot(chatSessionResource: URI, requestId: string | undefined, undoStop: string | undefined): ISnapshotEntry {\n\t\treturn {\n\t\t\tresource: this.modifiedURI,\n\t\t\tlanguageId: SnapshotLanguageId,\n\t\t\tsnapshotUri: getNotebookSnapshotFileURI(chatSessionResource, requestId, undoStop, this.modifiedURI.path, this.modifiedModel.viewType),\n\t\t\toriginal: createSnapshot(this.originalModel, this.transientOptions, this.configurationService),\n\t\t\tcurrent: createSnapshot(this.modifiedModel, this.transientOptions, this.configurationService),\n\t\t\tstate: this.state.get(),\n\t\t\ttelemetryInfo: this.telemetryInfo,\n\t\t};\n\t}\n\n\toverride equalsSnapshot(snapshot: ISnapshotEntry | undefined): boolean {\n\t\treturn !!snapshot &&\n\t\t\tisEqual(this.modifiedURI, snapshot.resource) &&\n\t\t\tthis.state.get() === snapshot.state &&\n\t\t\tnew SnapshotComparer(snapshot.original).isEqual(this.originalModel) &&\n\t\t\tnew SnapshotComparer(snapshot.current).isEqual(this.modifiedModel);\n\n\t}\n\n\toverride async restoreFromSnapshot(snapshot: ISnapshotEntry, restoreToDisk = true): Promise<void> {\n\t\tthis.updateCellDiffInfo([], undefined);\n\t\tthis._stateObs.set(snapshot.state, undefined);\n\t\trestoreSnapshot(this.originalModel, snapshot.original);\n\t\tif (restoreToDisk) {\n\t\t\tthis.restoreSnapshotInModifiedModel(snapshot.current);\n\t\t}\n\t\tthis.initializeModelsFromDiff();\n\t}\n\n\toverride async resetToInitialContent(): Promise<void> {\n\t\tthis.updateCellDiffInfo([], undefined);\n\t\tthis.restoreSnapshotInModifiedModel(this.initialContent);\n\t\tthis.initializeModelsFromDiff();\n\t}\n\n\tpublic restoreModifiedModelFromSnapshot(snapshot: string) {\n\t\tthis.restoreSnapshotInModifiedModel(snapshot);\n\t\treturn this.initializeModelsFromDiff();\n\t}\n\n\tprivate restoreSnapshotInModifiedModel(snapshot: string) {\n\t\tif (snapshot === createSnapshot(this.modifiedModel, this.transientOptions, this.configurationService)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._applyEditsSync(() => {\n\t\t\t// See private _setDocValue in chatEditingModifiedDocumentEntry.ts\n\t\t\tthis.modifiedModel.pushStackElement();\n\t\t\trestoreSnapshot(this.modifiedModel, snapshot);\n\t\t\tthis.modifiedModel.pushStackElement();\n\t\t});\n\t}\n\n\tprivate readonly cellTextModelMap = new ResourceMap<ITextModel>();\n\n\tprivate async resolveCellModel(cellURI: URI): Promise<ITextModel> {\n\t\tconst cell = this.originalModel.cells.concat(this.modifiedModel.cells).find(cell => isEqual(cell.uri, cellURI));\n\t\tif (!cell) {\n\t\t\tthrow new Error('Cell not found');\n\t\t}\n\t\tconst model = this.cellTextModelMap.get(cell.uri);\n\t\tif (model) {\n\t\t\tthis.cellTextModelMap.set(cell.uri, model);\n\t\t\treturn model;\n\t\t} else {\n\t\t\tconst textEditorModel = await thenRegisterOrDispose(this.textModelService.createModelReference(cell.uri), this._store);\n\t\t\tconst model = textEditorModel.object.textEditorModel;\n\t\t\tthis.cellTextModelMap.set(cell.uri, model);\n\t\t\treturn model;\n\t\t}\n\t}\n\n\tgetOrCreateModifiedTextFileEntryForCell(cell: NotebookCellTextModel, modifiedCellModel: ITextModel, originalCellModel: ITextModel): ChatEditingNotebookCellEntry | undefined {\n\t\tlet cellEntry = this.cellEntryMap.get(cell.uri);\n\t\tif (cellEntry) {\n\t\t\treturn cellEntry;\n\t\t}\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\tconst disposables = new DisposableStore();\n\t\tcellEntry = this._register(this._instantiationService.createInstance(ChatEditingNotebookCellEntry, this.modifiedResourceRef.object.resource, cell, modifiedCellModel, originalCellModel, () => this._isExternalEditInProgress, disposables));\n\t\tthis.cellEntryMap.set(cell.uri, cellEntry);\n\t\tdisposables.add(autorun(r => {\n\t\t\tif (this.modifiedModel.cells.indexOf(cell) === -1) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst diffs = this.cellsDiffInfo.read(undefined).slice();\n\t\t\tconst index = this.modifiedModel.cells.indexOf(cell);\n\t\t\tlet entry = diffs.find(entry => entry.modifiedCellIndex === index);\n\t\t\tif (!entry) {\n\t\t\t\t// Not possible.\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst entryIndex = diffs.indexOf(entry);\n\t\t\tentry.diff.set(cellEntry.diffInfo.read(r), undefined);\n\t\t\tif (cellEntry.diffInfo.read(undefined).identical && entry.type === 'modified') {\n\t\t\t\tentry = {\n\t\t\t\t\t...entry,\n\t\t\t\t\ttype: 'unchanged',\n\t\t\t\t};\n\t\t\t}\n\t\t\tif (!cellEntry.diffInfo.read(undefined).identical && entry.type === 'unchanged') {\n\t\t\t\tentry = {\n\t\t\t\t\t...entry,\n\t\t\t\t\ttype: 'modified',\n\t\t\t\t};\n\t\t\t}\n\t\t\tdiffs.splice(entryIndex, 1, { ...entry });\n\n\t\t\ttransaction(tx => {\n\t\t\t\tthis.updateCellDiffInfo(diffs, tx);\n\t\t\t});\n\t\t}));\n\n\t\tdisposables.add(autorun(r => {\n\t\t\tif (this.modifiedModel.cells.indexOf(cell) === -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst cellState = cellEntry.state.read(r);\n\t\t\tif (cellState === ModifiedFileEntryState.Accepted) {\n\t\t\t\tthis.computeStateAfterAcceptingRejectingChanges(true);\n\t\t\t} else if (cellState === ModifiedFileEntryState.Rejected) {\n\t\t\t\tthis.computeStateAfterAcceptingRejectingChanges(false);\n\t\t\t}\n\t\t}));\n\n\t\treturn cellEntry;\n\t}\n\n\tasync computeEditsFromSnapshots(beforeSnapshot: string, afterSnapshot: string): Promise<(TextEdit | ICellEditOperation)[]> {\n\t\t// For notebooks, we restore the snapshot and compute the cell-level edits\n\t\t// This is a simplified approach that replaces cells as needed\n\n\t\tconst beforeData = deserializeSnapshot(beforeSnapshot);\n\t\tconst afterData = deserializeSnapshot(afterSnapshot);\n\n\t\tconst edits: ICellEditOperation[] = [];\n\n\t\t// Simple approach: replace all cells\n\t\t// A more sophisticated approach would diff individual cells\n\t\tif (beforeData.data.cells.length > 0) {\n\t\t\tedits.push({\n\t\t\t\teditType: CellEditType.Replace,\n\t\t\t\tindex: 0,\n\t\t\t\tcount: beforeData.data.cells.length,\n\t\t\t\tcells: afterData.data.cells\n\t\t\t});\n\t\t} else if (afterData.data.cells.length > 0) {\n\t\t\tedits.push({\n\t\t\t\teditType: CellEditType.Replace,\n\t\t\t\tindex: 0,\n\t\t\t\tcount: 0,\n\t\t\t\tcells: afterData.data.cells\n\t\t\t});\n\t\t}\n\n\t\treturn edits;\n\t}\n\n\tasync save(): Promise<void> {\n\t\tif (this.modifiedModel.uri.scheme === Schemas.untitled) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Save the notebook if dirty\n\t\tif (this.notebookResolver.isDirty(this.modifiedModel.uri)) {\n\t\t\tawait this.modifiedResourceRef.object.save({\n\t\t\t\treason: SaveReason.EXPLICIT,\n\t\t\t\tskipSaveParticipants: true\n\t\t\t});\n\t\t}\n\t}\n\n\tasync revertToDisk(): Promise<void> {\n\t\tif (this.modifiedModel.uri.scheme === Schemas.untitled) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Revert to reload from disk\n\t\tawait this.modifiedResourceRef.object.revert({ soft: false });\n\t}\n}\n\n\nfunction generateCellHash(cellUri: URI) {\n\tconst hash = new StringSHA1();\n\thash.update(cellUri.toString());\n\treturn hash.digest().substring(0, 8);\n}\n"]}