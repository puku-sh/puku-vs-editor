{"version":3,"sources":["vs/workbench/contrib/chat/browser/contrib/chatInputRelatedFilesContrib.ts"],"names":[],"mappings":"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","file":"chatInputRelatedFilesContrib.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable, DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { ResourceMap, ResourceSet } from '../../../../../base/common/map.js';\nimport { autorun } from '../../../../../base/common/observable.js';\nimport { isEqual } from '../../../../../base/common/resources.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { localize } from '../../../../../nls.js';\nimport { IWorkbenchContribution } from '../../../../common/contributions.js';\nimport { IChatEditingService, IChatEditingSession } from '../../common/chatEditingService.js';\nimport { IChatWidget, IChatWidgetService } from '../chat.js';\n\nexport class ChatRelatedFilesContribution extends Disposable implements IWorkbenchContribution {\n\tstatic readonly ID = 'chat.relatedFilesWorkingSet';\n\n\tprivate readonly chatEditingSessionDisposables = new ResourceMap<DisposableStore>();\n\tprivate _currentRelatedFilesRetrievalOperation: Promise<void> | undefined;\n\n\tconstructor(\n\t\t@IChatEditingService private readonly chatEditingService: IChatEditingService,\n\t\t@IChatWidgetService private readonly chatWidgetService: IChatWidgetService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(autorun((reader) => {\n\t\t\tconst sessions = this.chatEditingService.editingSessionsObs.read(reader);\n\t\t\tsessions.forEach(session => {\n\t\t\t\tconst widget = this.chatWidgetService.getWidgetBySessionResource(session.chatSessionResource);\n\t\t\t\tif (widget && !this.chatEditingSessionDisposables.has(session.chatSessionResource)) {\n\t\t\t\t\tthis._handleNewEditingSession(session, widget);\n\t\t\t\t}\n\t\t\t});\n\t\t}));\n\t}\n\n\tprivate _updateRelatedFileSuggestions(currentEditingSession: IChatEditingSession, widget: IChatWidget) {\n\t\tif (this._currentRelatedFilesRetrievalOperation) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst workingSetEntries = currentEditingSession.entries.get();\n\t\tif (workingSetEntries.length > 0 || widget.attachmentModel.fileAttachments.length === 0) {\n\t\t\t// Do this only for the initial working set state\n\t\t\treturn;\n\t\t}\n\n\t\tthis._currentRelatedFilesRetrievalOperation = this.chatEditingService.getRelatedFiles(currentEditingSession.chatSessionResource, widget.getInput(), widget.attachmentModel.fileAttachments, CancellationToken.None)\n\t\t\t.then((files) => {\n\t\t\t\tif (!files?.length || !widget.viewModel || !widget.input.relatedFiles) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst currentEditingSession = this.chatEditingService.getEditingSession(widget.viewModel.sessionResource);\n\t\t\t\tif (!currentEditingSession || currentEditingSession.entries.get().length) {\n\t\t\t\t\treturn; // Might have disposed while we were calculating\n\t\t\t\t}\n\n\t\t\t\tconst existingFiles = new ResourceSet([...widget.attachmentModel.fileAttachments, ...widget.input.relatedFiles.removedFiles]);\n\t\t\t\tif (!existingFiles.size) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Pick up to 2 related files\n\t\t\t\tconst newSuggestions = new ResourceMap<string>();\n\t\t\t\tfor (const group of files) {\n\t\t\t\t\tfor (const file of group.files) {\n\t\t\t\t\t\tif (newSuggestions.size >= 2) {\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (existingFiles.has(file.uri)) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tnewSuggestions.set(file.uri, localize('relatedFile', \"{0} (Suggested)\", file.description));\n\t\t\t\t\t\texistingFiles.add(file.uri);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\twidget.input.relatedFiles.value = [...newSuggestions.entries()].map(([uri, description]) => ({ uri, description }));\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tthis._currentRelatedFilesRetrievalOperation = undefined;\n\t\t\t});\n\n\t}\n\n\tprivate _handleNewEditingSession(currentEditingSession: IChatEditingSession, widget: IChatWidget) {\n\t\tconst disposableStore = new DisposableStore();\n\t\tdisposableStore.add(currentEditingSession.onDidDispose(() => {\n\t\t\tdisposableStore.clear();\n\t\t}));\n\t\tthis._updateRelatedFileSuggestions(currentEditingSession, widget);\n\t\tconst onDebouncedType = Event.debounce(widget.inputEditor.onDidChangeModelContent, () => null, 3000);\n\t\tdisposableStore.add(onDebouncedType(() => {\n\t\t\tthis._updateRelatedFileSuggestions(currentEditingSession, widget);\n\t\t}));\n\t\tdisposableStore.add(widget.attachmentModel.onDidChange(() => {\n\t\t\tthis._updateRelatedFileSuggestions(currentEditingSession, widget);\n\t\t}));\n\t\tdisposableStore.add(currentEditingSession.onDidDispose(() => {\n\t\t\tdisposableStore.dispose();\n\t\t}));\n\t\tdisposableStore.add(widget.onDidAcceptInput(() => {\n\t\t\twidget.input.relatedFiles?.clear();\n\t\t\tthis._updateRelatedFileSuggestions(currentEditingSession, widget);\n\t\t}));\n\t\tthis.chatEditingSessionDisposables.set(currentEditingSession.chatSessionResource, disposableStore);\n\t}\n\n\toverride dispose() {\n\t\tfor (const store of this.chatEditingSessionDisposables.values()) {\n\t\t\tstore.dispose();\n\t\t}\n\t\tsuper.dispose();\n\t}\n}\n\nexport interface IChatRelatedFile {\n\turi: URI;\n\tdescription: string;\n}\nexport class ChatRelatedFiles extends Disposable {\n\n\tprivate readonly _onDidChange = this._register(new Emitter<void>());\n\treadonly onDidChange: Event<void> = this._onDidChange.event;\n\n\tprivate _removedFiles = new ResourceSet();\n\tget removedFiles() {\n\t\treturn this._removedFiles;\n\t}\n\n\tprivate _value: IChatRelatedFile[] = [];\n\tget value() {\n\t\treturn this._value;\n\t}\n\n\tset value(value: IChatRelatedFile[]) {\n\t\tthis._value = value;\n\t\tthis._onDidChange.fire();\n\t}\n\n\tremove(uri: URI) {\n\t\tthis._value = this._value.filter(file => !isEqual(file.uri, uri));\n\t\tthis._removedFiles.add(uri);\n\t\tthis._onDidChange.fire();\n\t}\n\n\tclearRemovedFiles() {\n\t\tthis._removedFiles.clear();\n\t}\n\n\tclear() {\n\t\tthis._value = [];\n\t\tthis._removedFiles.clear();\n\t\tthis._onDidChange.fire();\n\t}\n}\n"]}