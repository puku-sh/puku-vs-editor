{"version":3,"sources":["vs/workbench/contrib/chat/browser/chatOutputItemRenderer.ts"],"names":[],"mappings":"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","file":"chatOutputItemRenderer.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { getWindow } from '../../../../base/browser/dom.js';\nimport { raceCancellationError } from '../../../../base/common/async.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { matchesMimeType } from '../../../../base/common/dataTransfer.js';\nimport { CancellationError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { IJSONSchema, TypeFromJsonSchema } from '../../../../base/common/jsonSchema.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../../base/common/lifecycle.js';\nimport { autorun } from '../../../../base/common/observable.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport * as nls from '../../../../nls.js';\nimport { ExtensionIdentifier } from '../../../../platform/extensions/common/extensions.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IWebview, IWebviewService, WebviewContentPurpose } from '../../../contrib/webview/browser/webview.js';\nimport { IExtensionService, isProposedApiEnabled } from '../../../services/extensions/common/extensions.js';\nimport { ExtensionsRegistry, IExtensionPointUser } from '../../../services/extensions/common/extensionsRegistry.js';\n\nexport interface IChatOutputItemRenderer {\n\trenderOutputPart(mime: string, data: Uint8Array, webview: IWebview, token: CancellationToken): Promise<void>;\n}\n\ninterface RegisterOptions {\n\treadonly extension?: {\n\t\treadonly id: ExtensionIdentifier;\n\t\treadonly location: URI;\n\t};\n}\n\nexport const IChatOutputRendererService = createDecorator<IChatOutputRendererService>('chatOutputRendererService');\n\nexport interface IChatOutputRendererService {\n\treadonly _serviceBrand: undefined;\n\n\tregisterRenderer(mime: string, renderer: IChatOutputItemRenderer, options: RegisterOptions): IDisposable;\n\n\trenderOutputPart(mime: string, data: Uint8Array, parent: HTMLElement, webviewOptions: RenderOutputPartWebviewOptions, token: CancellationToken): Promise<RenderedOutputPart>;\n}\n\nexport interface RenderedOutputPart extends IDisposable {\n\treadonly onDidChangeHeight: Event<number>;\n\treadonly webview: IWebview;\n\n\treinitialize(): void;\n}\n\ninterface RenderOutputPartWebviewOptions {\n\treadonly origin?: string;\n}\n\n\ninterface RendererEntry {\n\treadonly renderer: IChatOutputItemRenderer;\n\treadonly options: RegisterOptions;\n}\n\nexport class ChatOutputRendererService extends Disposable implements IChatOutputRendererService {\n\t_serviceBrand: undefined;\n\n\tprivate readonly _contributions = new Map</*viewType*/ string, {\n\t\treadonly mimes: readonly string[];\n\t}>();\n\n\tprivate readonly _renderers = new Map</*viewType*/ string, RendererEntry>();\n\n\tconstructor(\n\t\t@IWebviewService private readonly _webviewService: IWebviewService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(chatOutputRenderContributionPoint.setHandler(extensions => {\n\t\t\tthis.updateContributions(extensions);\n\t\t}));\n\t}\n\n\tregisterRenderer(viewType: string, renderer: IChatOutputItemRenderer, options: RegisterOptions): IDisposable {\n\t\tthis._renderers.set(viewType, { renderer, options });\n\t\treturn {\n\t\t\tdispose: () => {\n\t\t\t\tthis._renderers.delete(viewType);\n\t\t\t}\n\t\t};\n\t}\n\n\tasync renderOutputPart(mime: string, data: Uint8Array, parent: HTMLElement, webviewOptions: RenderOutputPartWebviewOptions, token: CancellationToken): Promise<RenderedOutputPart> {\n\t\tconst rendererData = await this.getRenderer(mime, token);\n\t\tif (token.isCancellationRequested) {\n\t\t\tthrow new CancellationError();\n\t\t}\n\n\t\tif (!rendererData) {\n\t\t\tthrow new Error(`No renderer registered found for mime type: ${mime}`);\n\t\t}\n\n\t\tconst store = new DisposableStore();\n\n\t\tconst webview = store.add(this._webviewService.createWebviewElement({\n\t\t\ttitle: '',\n\t\t\torigin: webviewOptions.origin ?? generateUuid(),\n\t\t\toptions: {\n\t\t\t\tenableFindWidget: false,\n\t\t\t\tpurpose: WebviewContentPurpose.ChatOutputItem,\n\t\t\t\ttryRestoreScrollPosition: false,\n\t\t\t},\n\t\t\tcontentOptions: {},\n\t\t\textension: rendererData.options.extension ? rendererData.options.extension : undefined,\n\t\t}));\n\n\t\tconst onDidChangeHeight = store.add(new Emitter<number>());\n\t\tstore.add(autorun(reader => {\n\t\t\tconst height = reader.readObservable(webview.intrinsicContentSize);\n\t\t\tif (height) {\n\t\t\t\tonDidChangeHeight.fire(height.height);\n\t\t\t\tparent.style.height = `${height.height}px`;\n\t\t\t}\n\t\t}));\n\n\t\twebview.mountTo(parent, getWindow(parent));\n\t\tawait rendererData.renderer.renderOutputPart(mime, data, webview, token);\n\n\t\treturn {\n\t\t\tget webview() { return webview; },\n\t\t\tonDidChangeHeight: onDidChangeHeight.event,\n\t\t\tdispose: () => {\n\t\t\t\tstore.dispose();\n\t\t\t},\n\t\t\treinitialize: () => {\n\t\t\t\twebview.reinitializeAfterDismount();\n\t\t\t},\n\t\t};\n\t}\n\n\tprivate async getRenderer(mime: string, token: CancellationToken): Promise<RendererEntry | undefined> {\n\t\tawait raceCancellationError(this._extensionService.whenInstalledExtensionsRegistered(), token);\n\t\tfor (const [id, value] of this._contributions) {\n\t\t\tif (value.mimes.some(m => matchesMimeType(m, [mime]))) {\n\t\t\t\tawait raceCancellationError(this._extensionService.activateByEvent(`onChatOutputRenderer:${id}`), token);\n\t\t\t\tconst rendererData = this._renderers.get(id);\n\t\t\t\tif (rendererData) {\n\t\t\t\t\treturn rendererData;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate updateContributions(extensions: readonly IExtensionPointUser<readonly IChatOutputRendererContribution[]>[]) {\n\t\tthis._contributions.clear();\n\t\tfor (const extension of extensions) {\n\t\t\tif (!isProposedApiEnabled(extension.description, 'chatOutputRenderer')) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tfor (const contribution of extension.value) {\n\t\t\t\tif (this._contributions.has(contribution.viewType)) {\n\t\t\t\t\textension.collector.error(`Chat output renderer with view type '${contribution.viewType}' already registered`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis._contributions.set(contribution.viewType, {\n\t\t\t\t\tmimes: contribution.mimeTypes,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n}\n\nconst chatOutputRendererContributionSchema = {\n\ttype: 'object',\n\tadditionalProperties: false,\n\trequired: ['viewType', 'mimeTypes'],\n\tproperties: {\n\t\tviewType: {\n\t\t\ttype: 'string',\n\t\t\tdescription: nls.localize('chatOutputRenderer.viewType', 'Unique identifier for the renderer.'),\n\t\t},\n\t\tmimeTypes: {\n\t\t\ttype: 'array',\n\t\t\tdescription: nls.localize('chatOutputRenderer.mimeTypes', 'MIME types that this renderer can handle'),\n\t\t\titems: {\n\t\t\t\ttype: 'string'\n\t\t\t}\n\t\t}\n\t}\n} as const satisfies IJSONSchema;\n\ntype IChatOutputRendererContribution = TypeFromJsonSchema<typeof chatOutputRendererContributionSchema>;\n\nconst chatOutputRenderContributionPoint = ExtensionsRegistry.registerExtensionPoint<IChatOutputRendererContribution[]>({\n\textensionPoint: 'chatOutputRenderers',\n\tactivationEventsGenerator: function* (contributions) {\n\t\tfor (const contrib of contributions) {\n\t\t\tyield `onChatOutputRenderer:${contrib.viewType}`;\n\t\t}\n\t},\n\tjsonSchema: {\n\t\tdescription: nls.localize('vscode.extension.contributes.chatOutputRenderer', 'Contributes a renderer for specific MIME types in chat outputs'),\n\t\ttype: 'array',\n\t\titems: chatOutputRendererContributionSchema,\n\t}\n});\n\n"]}