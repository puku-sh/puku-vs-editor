{"version":3,"sources":["vs/workbench/contrib/chat/browser/chatEditing/chatEditingSession.ts"],"names":[],"mappings":"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","file":"chatEditingSession.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DeferredPromise, ITask, Sequencer, SequencerByKey, timeout } from '../../../../../base/common/async.js';\nimport { VSBuffer } from '../../../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { BugIndicatingError } from '../../../../../base/common/errors.js';\nimport { Emitter } from '../../../../../base/common/event.js';\nimport { MarkdownString } from '../../../../../base/common/htmlContent.js';\nimport { Iterable } from '../../../../../base/common/iterator.js';\nimport { Disposable, DisposableStore, dispose } from '../../../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../../../base/common/map.js';\nimport { derived, IObservable, IReader, ITransaction, observableValue, transaction } from '../../../../../base/common/observable.js';\nimport { isEqual } from '../../../../../base/common/resources.js';\nimport { hasKey, Mutable } from '../../../../../base/common/types.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../../base/common/uuid.js';\nimport { IBulkEditService } from '../../../../../editor/browser/services/bulkEditService.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { TextEdit } from '../../../../../editor/common/languages.js';\nimport { ILanguageService } from '../../../../../editor/common/languages/language.js';\nimport { ITextModel } from '../../../../../editor/common/model.js';\nimport { IModelService } from '../../../../../editor/common/services/model.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { localize } from '../../../../../nls.js';\nimport { AccessibilitySignal, IAccessibilitySignalService } from '../../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { EditorActivation } from '../../../../../platform/editor/common/editor.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../../platform/log/common/log.js';\nimport { DiffEditorInput } from '../../../../common/editor/diffEditorInput.js';\nimport { IEditorGroupsService } from '../../../../services/editor/common/editorGroupsService.js';\nimport { IEditorService } from '../../../../services/editor/common/editorService.js';\nimport { MultiDiffEditor } from '../../../multiDiffEditor/browser/multiDiffEditor.js';\nimport { MultiDiffEditorInput } from '../../../multiDiffEditor/browser/multiDiffEditorInput.js';\nimport { CellUri, ICellEditOperation } from '../../../notebook/common/notebookCommon.js';\nimport { INotebookService } from '../../../notebook/common/notebookService.js';\nimport { chatEditingSessionIsReady, ChatEditingSessionState, ChatEditKind, getMultiDiffSourceUri, IChatEditingSession, IModifiedEntryTelemetryInfo, IModifiedFileEntry, ISnapshotEntry, IStreamingEdits, ModifiedFileEntryState } from '../../common/chatEditingService.js';\nimport { IChatResponseModel } from '../../common/chatModel.js';\nimport { IChatProgress } from '../../common/chatService.js';\nimport { ChatAgentLocation } from '../../common/constants.js';\nimport { IChatEditingCheckpointTimeline } from './chatEditingCheckpointTimeline.js';\nimport { ChatEditingCheckpointTimelineImpl, IChatEditingTimelineFsDelegate } from './chatEditingCheckpointTimelineImpl.js';\nimport { ChatEditingModifiedDocumentEntry } from './chatEditingModifiedDocumentEntry.js';\nimport { AbstractChatEditingModifiedFileEntry } from './chatEditingModifiedFileEntry.js';\nimport { ChatEditingModifiedNotebookEntry } from './chatEditingModifiedNotebookEntry.js';\nimport { FileOperation, FileOperationType } from './chatEditingOperations.js';\nimport { ChatEditingSessionStorage, IChatEditingSessionStop, StoredSessionState } from './chatEditingSessionStorage.js';\nimport { ChatEditingTextModelContentProvider } from './chatEditingTextModelContentProviders.js';\n\nconst enum NotExistBehavior {\n\tCreate,\n\tAbort,\n}\n\nclass ThrottledSequencer extends Sequencer {\n\n\tprivate _size = 0;\n\n\tconstructor(\n\t\tprivate readonly _minDuration: number,\n\t\tprivate readonly _maxOverallDelay: number\n\t) {\n\t\tsuper();\n\t}\n\n\toverride queue<T>(promiseTask: ITask<Promise<T>>): Promise<T> {\n\n\t\tthis._size += 1;\n\n\t\tconst noDelay = this._size * this._minDuration > this._maxOverallDelay;\n\n\t\treturn super.queue(async () => {\n\t\t\ttry {\n\t\t\t\tconst p1 = promiseTask();\n\t\t\t\tconst p2 = noDelay\n\t\t\t\t\t? Promise.resolve(undefined)\n\t\t\t\t\t: timeout(this._minDuration, CancellationToken.None);\n\n\t\t\t\tconst [result] = await Promise.all([p1, p2]);\n\t\t\t\treturn result;\n\n\t\t\t} finally {\n\t\t\t\tthis._size -= 1;\n\t\t\t}\n\t\t});\n\t}\n}\n\nfunction createOpeningEditCodeBlock(uri: URI, isNotebook: boolean): IChatProgress[] {\n\treturn [\n\t\t{\n\t\t\tkind: 'markdownContent',\n\t\t\tcontent: new MarkdownString('\\n````\\n')\n\t\t},\n\t\t{\n\t\t\tkind: 'codeblockUri',\n\t\t\turi,\n\t\t\tisEdit: true\n\t\t},\n\t\t{\n\t\t\tkind: 'markdownContent',\n\t\t\tcontent: new MarkdownString('\\n````\\n')\n\t\t},\n\t\tisNotebook\n\t\t\t? {\n\t\t\t\tkind: 'notebookEdit',\n\t\t\t\turi,\n\t\t\t\tedits: [],\n\t\t\t\tdone: false,\n\t\t\t\tisExternalEdit: true\n\t\t\t}\n\t\t\t: {\n\t\t\t\tkind: 'textEdit',\n\t\t\t\turi,\n\t\t\t\tedits: [],\n\t\t\t\tdone: false,\n\t\t\t\tisExternalEdit: true\n\t\t\t},\n\t];\n}\n\n\nexport class ChatEditingSession extends Disposable implements IChatEditingSession {\n\tprivate readonly _state = observableValue<ChatEditingSessionState>(this, ChatEditingSessionState.Initial);\n\tprivate readonly _timeline: IChatEditingCheckpointTimeline;\n\n\t/**\n\t * Contains the contents of a file when the AI first began doing edits to it.\n\t */\n\tprivate readonly _initialFileContents = new ResourceMap<string>();\n\n\tprivate readonly _baselineCreationLocks = new SequencerByKey</* URI.path */ string>();\n\tprivate readonly _streamingEditLocks = new SequencerByKey</* URI */ string>();\n\n\t/**\n\t * Tracks active external edit operations.\n\t * Key is operationId, value contains the operation state.\n\t */\n\tprivate readonly _externalEditOperations = new Map<number, {\n\t\tresponseModel: IChatResponseModel;\n\t\tsnapshots: ResourceMap<string | undefined>;\n\t\tundoStopId: string;\n\t\treleaseLocks: () => void;\n\t}>();\n\n\tprivate readonly _entriesObs = observableValue<readonly AbstractChatEditingModifiedFileEntry[]>(this, []);\n\tpublic readonly entries: IObservable<readonly IModifiedFileEntry[]> = derived(reader => {\n\t\tconst state = this._state.read(reader);\n\t\tif (state === ChatEditingSessionState.Disposed || state === ChatEditingSessionState.Initial) {\n\t\t\treturn [];\n\t\t} else {\n\t\t\treturn this._entriesObs.read(reader);\n\t\t}\n\t});\n\n\tprivate _editorPane: MultiDiffEditor | undefined;\n\n\tget state(): IObservable<ChatEditingSessionState> {\n\t\treturn this._state;\n\t}\n\n\tpublic readonly canUndo: IObservable<boolean>;\n\tpublic readonly canRedo: IObservable<boolean>;\n\n\tpublic get requestDisablement() {\n\t\treturn this._timeline.requestDisablement;\n\t}\n\n\tprivate readonly _onDidDispose = new Emitter<void>();\n\tget onDidDispose() {\n\t\tthis._assertNotDisposed();\n\t\treturn this._onDidDispose.event;\n\t}\n\n\tconstructor(\n\t\treadonly chatSessionResource: URI,\n\t\treadonly isGlobalEditingSession: boolean,\n\t\tprivate _lookupExternalEntry: (uri: URI) => AbstractChatEditingModifiedFileEntry | undefined,\n\t\ttransferFrom: IChatEditingSession | undefined,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IModelService private readonly _modelService: IModelService,\n\t\t@ILanguageService private readonly _languageService: ILanguageService,\n\t\t@ITextModelService private readonly _textModelService: ITextModelService,\n\t\t@IBulkEditService public readonly _bulkEditService: IBulkEditService,\n\t\t@IEditorGroupsService private readonly _editorGroupsService: IEditorGroupsService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@IAccessibilitySignalService private readonly _accessibilitySignalService: IAccessibilitySignalService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t) {\n\t\tsuper();\n\t\tthis._timeline = this._instantiationService.createInstance(\n\t\t\tChatEditingCheckpointTimelineImpl,\n\t\t\tchatSessionResource,\n\t\t\tthis._getTimelineDelegate(),\n\t\t);\n\t\tthis.canRedo = this._timeline.canRedo.map((hasHistory, reader) =>\n\t\t\thasHistory && this._state.read(reader) === ChatEditingSessionState.Idle);\n\t\tthis.canUndo = this._timeline.canUndo.map((hasHistory, reader) =>\n\t\t\thasHistory && this._state.read(reader) === ChatEditingSessionState.Idle);\n\n\t\tthis._init(transferFrom);\n\t}\n\n\tprivate _getTimelineDelegate(): IChatEditingTimelineFsDelegate {\n\t\treturn {\n\t\t\tcreateFile: (uri, content) => {\n\t\t\t\treturn this._bulkEditService.apply({\n\t\t\t\t\tedits: [{\n\t\t\t\t\t\tnewResource: uri,\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\toverwrite: true,\n\t\t\t\t\t\t\tcontents: content ? Promise.resolve(VSBuffer.fromString(content)) : undefined,\n\t\t\t\t\t\t},\n\t\t\t\t\t}],\n\t\t\t\t});\n\t\t\t},\n\t\t\tdeleteFile: async (uri) => {\n\t\t\t\tconst entries = this._entriesObs.get().filter(e => !isEqual(e.modifiedURI, uri));\n\t\t\t\tthis._entriesObs.set(entries, undefined);\n\t\t\t\tawait this._bulkEditService.apply({ edits: [{ oldResource: uri, options: { ignoreIfNotExists: true } }] });\n\t\t\t},\n\t\t\trenameFile: async (fromUri, toUri) => {\n\t\t\t\tconst entries = this._entriesObs.get();\n\t\t\t\tconst previousEntry = entries.find(e => isEqual(e.modifiedURI, fromUri));\n\t\t\t\tif (previousEntry) {\n\t\t\t\t\tconst newEntry = await this._getOrCreateModifiedFileEntry(toUri, NotExistBehavior.Create, previousEntry.telemetryInfo, this._getCurrentTextOrNotebookSnapshot(previousEntry));\n\t\t\t\t\tpreviousEntry.dispose();\n\t\t\t\t\tthis._entriesObs.set(entries.map(e => e === previousEntry ? newEntry : e), undefined);\n\t\t\t\t}\n\t\t\t},\n\t\t\tsetContents: async (uri, content, telemetryInfo) => {\n\t\t\t\tconst entry = await this._getOrCreateModifiedFileEntry(uri, NotExistBehavior.Create, telemetryInfo);\n\t\t\t\tif (entry instanceof ChatEditingModifiedNotebookEntry) {\n\t\t\t\t\tawait entry.restoreModifiedModelFromSnapshot(content);\n\t\t\t\t} else {\n\t\t\t\t\tawait entry.acceptAgentEdits(uri, [{ range: new Range(1, 1, Number.MAX_SAFE_INTEGER, Number.MAX_SAFE_INTEGER), text: content }], true, undefined);\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t}\n\n\tprivate async _init(transferFrom?: IChatEditingSession): Promise<void> {\n\t\tconst storage = this._instantiationService.createInstance(ChatEditingSessionStorage, this.chatSessionResource);\n\t\tlet restoredSessionState = await storage.restoreState().catch(err => {\n\t\t\tthis._logService.error(`Error restoring chat editing session state for ${this.chatSessionResource}`, err);\n\t\t});\n\n\t\tif (this._store.isDisposed) {\n\t\t\treturn; // disposed while restoring\n\t\t}\n\n\t\tif (!restoredSessionState && transferFrom instanceof ChatEditingSession) {\n\t\t\trestoredSessionState = transferFrom._getStoredState(this.chatSessionResource);\n\t\t}\n\n\t\tif (restoredSessionState) {\n\t\t\tfor (const [uri, content] of restoredSessionState.initialFileContents) {\n\t\t\t\tthis._initialFileContents.set(uri, content);\n\t\t\t}\n\t\t\tawait this._initEntries(restoredSessionState.recentSnapshot);\n\t\t\ttransaction(tx => {\n\t\t\t\tif (restoredSessionState.timeline) {\n\t\t\t\t\tthis._timeline.restoreFromState(restoredSessionState.timeline, tx);\n\t\t\t\t}\n\t\t\t\tthis._state.set(ChatEditingSessionState.Idle, tx);\n\t\t\t});\n\t\t} else {\n\t\t\tthis._state.set(ChatEditingSessionState.Idle, undefined);\n\t\t}\n\t}\n\n\tprivate _getEntry(uri: URI): AbstractChatEditingModifiedFileEntry | undefined {\n\t\turi = CellUri.parse(uri)?.notebook ?? uri;\n\t\treturn this._entriesObs.get().find(e => isEqual(e.modifiedURI, uri));\n\t}\n\n\tpublic getEntry(uri: URI): IModifiedFileEntry | undefined {\n\t\treturn this._getEntry(uri);\n\t}\n\n\tpublic readEntry(uri: URI, reader: IReader | undefined): IModifiedFileEntry | undefined {\n\t\turi = CellUri.parse(uri)?.notebook ?? uri;\n\t\treturn this._entriesObs.read(reader).find(e => isEqual(e.modifiedURI, uri));\n\t}\n\n\tpublic storeState(): Promise<void> {\n\t\tconst storage = this._instantiationService.createInstance(ChatEditingSessionStorage, this.chatSessionResource);\n\t\treturn storage.storeState(this._getStoredState());\n\t}\n\n\tprivate _getStoredState(sessionResource = this.chatSessionResource): StoredSessionState {\n\t\tconst entries = new ResourceMap<ISnapshotEntry>();\n\t\tfor (const entry of this._entriesObs.get()) {\n\t\t\tentries.set(entry.modifiedURI, entry.createSnapshot(sessionResource, undefined, undefined));\n\t\t}\n\n\t\tconst state: StoredSessionState = {\n\t\t\tinitialFileContents: this._initialFileContents,\n\t\t\ttimeline: this._timeline.getStateForPersistence(),\n\t\t\trecentSnapshot: { entries, stopId: undefined },\n\t\t};\n\n\t\treturn state;\n\t}\n\n\tpublic getEntryDiffBetweenStops(uri: URI, requestId: string | undefined, stopId: string | undefined) {\n\t\treturn this._timeline.getEntryDiffBetweenStops(uri, requestId, stopId);\n\t}\n\n\tpublic getEntryDiffBetweenRequests(uri: URI, startRequestId: string, stopRequestId: string) {\n\t\treturn this._timeline.getEntryDiffBetweenRequests(uri, startRequestId, stopRequestId);\n\t}\n\n\tpublic createSnapshot(requestId: string, undoStop: string | undefined): void {\n\t\tconst label = undoStop ? `Request ${requestId} - Stop ${undoStop}` : `Request ${requestId}`;\n\t\tthis._timeline.createCheckpoint(requestId, undoStop, label);\n\t}\n\n\tpublic async getSnapshotContents(requestId: string, uri: URI, stopId: string | undefined): Promise<VSBuffer | undefined> {\n\t\tconst content = await this._timeline.getContentAtStop(requestId, uri, stopId);\n\t\treturn typeof content === 'string' ? VSBuffer.fromString(content) : content;\n\t}\n\n\tpublic async getSnapshotModel(requestId: string, undoStop: string | undefined, snapshotUri: URI): Promise<ITextModel | null> {\n\t\tawait this._baselineCreationLocks.peek(snapshotUri.path);\n\n\t\tconst content = await this._timeline.getContentAtStop(requestId, snapshotUri, undoStop);\n\t\tif (content === undefined) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst contentStr = typeof content === 'string' ? content : content.toString();\n\t\tconst model = this._modelService.createModel(contentStr, this._languageService.createByFilepathOrFirstLine(snapshotUri), snapshotUri, false);\n\n\t\tconst store = new DisposableStore();\n\t\tstore.add(model.onWillDispose(() => store.dispose()));\n\t\tstore.add(this._timeline.onDidChangeContentsAtStop(requestId, snapshotUri, undoStop, c => model.setValue(c)));\n\n\t\treturn model;\n\t}\n\n\tpublic getSnapshotUri(requestId: string, uri: URI, stopId: string | undefined): URI | undefined {\n\t\treturn this._timeline.getContentURIAtStop(requestId, uri, stopId);\n\t}\n\n\tpublic async restoreSnapshot(requestId: string, stopId: string | undefined): Promise<void> {\n\t\tconst checkpointId = this._timeline.getCheckpointIdForRequest(requestId, stopId);\n\t\tif (checkpointId) {\n\t\t\tawait this._timeline.navigateToCheckpoint(checkpointId);\n\t\t}\n\t}\n\n\tprivate _assertNotDisposed(): void {\n\t\tif (this._state.get() === ChatEditingSessionState.Disposed) {\n\t\t\tthrow new BugIndicatingError(`Cannot access a disposed editing session`);\n\t\t}\n\t}\n\n\tasync accept(...uris: URI[]): Promise<void> {\n\t\tif (await this._operateEntry('accept', uris)) {\n\t\t\tthis._accessibilitySignalService.playSignal(AccessibilitySignal.editsKept, { allowManyInParallel: true });\n\t\t}\n\n\t}\n\n\tasync reject(...uris: URI[]): Promise<void> {\n\t\tif (await this._operateEntry('reject', uris)) {\n\t\t\tthis._accessibilitySignalService.playSignal(AccessibilitySignal.editsUndone, { allowManyInParallel: true });\n\t\t}\n\t}\n\n\tprivate async _operateEntry(action: 'accept' | 'reject', uris: URI[]): Promise<number> {\n\t\tthis._assertNotDisposed();\n\n\t\tconst applicableEntries = this._entriesObs.get()\n\t\t\t.filter(e => uris.length === 0 || uris.some(u => isEqual(u, e.modifiedURI)))\n\t\t\t.filter(e => !e.isCurrentlyBeingModifiedBy.get())\n\t\t\t.filter(e => e.state.get() === ModifiedFileEntryState.Modified);\n\n\t\tif (applicableEntries.length === 0) {\n\t\t\treturn 0;\n\t\t}\n\n\t\t// Perform all I/O operations in parallel, each resolving to a state transition callback\n\t\tconst method = action === 'accept' ? 'acceptDeferred' : 'rejectDeferred';\n\t\tconst transitionCallbacks = await Promise.all(\n\t\t\tapplicableEntries.map(entry => entry[method]().catch(err => {\n\t\t\t\tthis._logService.error(`Error calling ${method} on entry ${entry.modifiedURI}`, err);\n\t\t\t}))\n\t\t);\n\n\t\t// Execute all state transitions atomically in a single transaction\n\t\ttransaction(tx => {\n\t\t\ttransitionCallbacks.forEach(callback => callback?.(tx));\n\t\t});\n\n\t\treturn applicableEntries.length;\n\t}\n\n\tasync show(previousChanges?: boolean): Promise<void> {\n\t\tthis._assertNotDisposed();\n\t\tif (this._editorPane) {\n\t\t\tif (this._editorPane.isVisible()) {\n\t\t\t\treturn;\n\t\t\t} else if (this._editorPane.input) {\n\t\t\t\tawait this._editorGroupsService.activeGroup.openEditor(this._editorPane.input, { pinned: true, activation: EditorActivation.ACTIVATE });\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tconst input = MultiDiffEditorInput.fromResourceMultiDiffEditorInput({\n\t\t\tmultiDiffSource: getMultiDiffSourceUri(this, previousChanges),\n\t\t\tlabel: localize('multiDiffEditorInput.name', \"Suggested Edits\")\n\t\t}, this._instantiationService);\n\n\t\tthis._editorPane = await this._editorGroupsService.activeGroup.openEditor(input, { pinned: true, activation: EditorActivation.ACTIVATE }) as MultiDiffEditor | undefined;\n\t}\n\n\tprivate _stopPromise: Promise<void> | undefined;\n\n\tasync stop(clearState = false): Promise<void> {\n\t\tthis._stopPromise ??= Promise.allSettled([this._performStop(), this.storeState()]).then(() => { });\n\t\tawait this._stopPromise;\n\t\tif (clearState) {\n\t\t\tawait this._instantiationService.createInstance(ChatEditingSessionStorage, this.chatSessionResource).clearState();\n\t\t}\n\t}\n\n\tprivate async _performStop(): Promise<void> {\n\t\t// Close out all open files\n\t\tconst schemes = [AbstractChatEditingModifiedFileEntry.scheme, ChatEditingTextModelContentProvider.scheme];\n\t\tawait Promise.allSettled(this._editorGroupsService.groups.flatMap(async (g) => {\n\t\t\treturn g.editors.map(async (e) => {\n\t\t\t\tif ((e instanceof MultiDiffEditorInput && e.initialResources?.some(r => r.originalUri && schemes.indexOf(r.originalUri.scheme) !== -1))\n\t\t\t\t\t|| (e instanceof DiffEditorInput && e.original.resource && schemes.indexOf(e.original.resource.scheme) !== -1)) {\n\t\t\t\t\tawait g.closeEditor(e);\n\t\t\t\t}\n\t\t\t});\n\t\t}));\n\t}\n\n\toverride dispose() {\n\t\tthis._assertNotDisposed();\n\t\tdispose(this._entriesObs.get());\n\t\tsuper.dispose();\n\t\tthis._state.set(ChatEditingSessionState.Disposed, undefined);\n\t\tthis._onDidDispose.fire();\n\t\tthis._onDidDispose.dispose();\n\t}\n\n\tprivate get isDisposed() {\n\t\treturn this._state.get() === ChatEditingSessionState.Disposed;\n\t}\n\n\tstartStreamingEdits(resource: URI, responseModel: IChatResponseModel, inUndoStop: string | undefined): IStreamingEdits {\n\t\tconst completePromise = new DeferredPromise<void>();\n\t\tconst startPromise = new DeferredPromise<void>();\n\n\t\t// Sequence all edits made this this resource in this streaming edits instance,\n\t\t// and also sequence the resource overall in the rare (currently invalid?) case\n\t\t// that edits are made in parallel to the same resource,\n\t\tconst sequencer = new ThrottledSequencer(15, 1000);\n\t\tsequencer.queue(() => startPromise.p);\n\n\t\t// Lock around creating the baseline so we don't fail to resolve models\n\t\t// in the edit pills if they render quickly\n\t\tthis._baselineCreationLocks.queue(resource.path, () => startPromise.p);\n\n\t\tthis._streamingEditLocks.queue(resource.toString(), async () => {\n\t\t\tawait chatEditingSessionIsReady(this);\n\n\t\t\tif (!this.isDisposed) {\n\t\t\t\tawait this._acceptStreamingEditsStart(responseModel, inUndoStop, resource);\n\t\t\t}\n\n\t\t\tstartPromise.complete();\n\t\t\treturn completePromise.p;\n\t\t});\n\n\n\t\tlet didComplete = false;\n\n\t\treturn {\n\t\t\tpushText: (edits, isLastEdits) => {\n\t\t\t\tsequencer.queue(async () => {\n\t\t\t\t\tif (!this.isDisposed) {\n\t\t\t\t\t\tawait this._acceptEdits(resource, edits, isLastEdits, responseModel);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\tpushNotebookCellText: (cell, edits, isLastEdits) => {\n\t\t\t\tsequencer.queue(async () => {\n\t\t\t\t\tif (!this.isDisposed) {\n\t\t\t\t\t\tawait this._acceptEdits(cell, edits, isLastEdits, responseModel);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\tpushNotebook: (edits, isLastEdits) => {\n\t\t\t\tsequencer.queue(async () => {\n\t\t\t\t\tif (!this.isDisposed) {\n\t\t\t\t\t\tawait this._acceptEdits(resource, edits, isLastEdits, responseModel);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\tcomplete: () => {\n\t\t\t\tif (didComplete) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdidComplete = true;\n\t\t\t\tsequencer.queue(async () => {\n\t\t\t\t\tif (!this.isDisposed) {\n\t\t\t\t\t\tawait this._acceptEdits(resource, [], true, responseModel);\n\t\t\t\t\t\tawait this._resolve(responseModel.requestId, inUndoStop, resource);\n\t\t\t\t\t\tcompletePromise.complete();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t};\n\t}\n\n\tasync startExternalEdits(responseModel: IChatResponseModel, operationId: number, resources: URI[]): Promise<IChatProgress[]> {\n\t\tconst snapshots = new ResourceMap<string | undefined>();\n\t\tconst acquiredLockPromises: DeferredPromise<void>[] = [];\n\t\tconst releaseLockPromises: DeferredPromise<void>[] = [];\n\t\tconst undoStopId = generateUuid();\n\t\tconst progress: IChatProgress[] = [{\n\t\t\tkind: 'undoStop',\n\t\t\tid: undoStopId,\n\t\t}];\n\t\tconst telemetryInfo = this._getTelemetryInfoForModel(responseModel);\n\n\t\tawait chatEditingSessionIsReady(this);\n\n\t\t// Acquire locks for each resource and take snapshots\n\t\tfor (const resource of resources) {\n\t\t\tconst releaseLock = new DeferredPromise<void>();\n\t\t\treleaseLockPromises.push(releaseLock);\n\n\t\t\tconst acquiredLock = new DeferredPromise<void>();\n\t\t\tacquiredLockPromises.push(acquiredLock);\n\n\t\t\tthis._streamingEditLocks.queue(resource.toString(), async () => {\n\t\t\t\tif (this.isDisposed) {\n\t\t\t\t\tacquiredLock.complete();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst entry = await this._getOrCreateModifiedFileEntry(resource, NotExistBehavior.Abort, telemetryInfo);\n\t\t\t\tif (entry) {\n\t\t\t\t\tawait this._acceptStreamingEditsStart(responseModel, undoStopId, resource);\n\t\t\t\t}\n\n\n\t\t\t\tconst notebookUri = CellUri.parse(resource)?.notebook || resource;\n\t\t\t\tprogress.push(...createOpeningEditCodeBlock(resource, this._notebookService.hasSupportedNotebooks(notebookUri)));\n\n\t\t\t\t// Save to disk to ensure disk state is current before external edits\n\t\t\t\tawait entry?.save();\n\n\t\t\t\t// Take snapshot of current state\n\t\t\t\tsnapshots.set(resource, entry && this._getCurrentTextOrNotebookSnapshot(entry));\n\t\t\t\tentry?.startExternalEdit();\n\t\t\t\tacquiredLock.complete();\n\n\t\t\t\t// Wait for the lock to be released by stopExternalEdits\n\t\t\t\treturn releaseLock.p;\n\t\t\t});\n\t\t}\n\n\t\tawait Promise.all(acquiredLockPromises.map(p => p.p));\n\t\tthis.createSnapshot(responseModel.requestId, undoStopId);\n\n\t\t// Store the operation state\n\t\tthis._externalEditOperations.set(operationId, {\n\t\t\tresponseModel,\n\t\t\tsnapshots,\n\t\t\tundoStopId,\n\t\t\treleaseLocks: () => releaseLockPromises.forEach(p => p.complete())\n\t\t});\n\n\t\treturn progress;\n\t}\n\n\tasync stopExternalEdits(responseModel: IChatResponseModel, operationId: number): Promise<IChatProgress[]> {\n\t\tconst operation = this._externalEditOperations.get(operationId);\n\t\tif (!operation) {\n\t\t\tthis._logService.warn(`stopExternalEdits called for unknown operation ${operationId}`);\n\t\t\treturn [];\n\t\t}\n\n\t\tthis._externalEditOperations.delete(operationId);\n\n\t\tconst progress: IChatProgress[] = [];\n\n\t\ttry {\n\t\t\t// For each resource, compute the diff and create edit parts\n\t\t\tfor (const [resource, beforeSnapshot] of operation.snapshots) {\n\t\t\t\tlet entry = this._getEntry(resource);\n\n\t\t\t\t// Files that did not exist on disk before may not exist in our working\n\t\t\t\t// set yet. Create those if that's the case.\n\t\t\t\tif (!entry && beforeSnapshot === undefined) {\n\t\t\t\t\tentry = await this._getOrCreateModifiedFileEntry(resource, NotExistBehavior.Abort, this._getTelemetryInfoForModel(responseModel), '');\n\t\t\t\t\tif (entry) {\n\t\t\t\t\t\tentry.startExternalEdit();\n\t\t\t\t\t\tentry.acceptStreamingEditsStart(responseModel, operation.undoStopId, undefined);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!entry) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Reload from disk to ensure in-memory model is in sync with file system\n\t\t\t\tawait entry.revertToDisk();\n\n\t\t\t\t// Take new snapshot after external changes\n\t\t\t\tconst afterSnapshot = this._getCurrentTextOrNotebookSnapshot(entry);\n\n\t\t\t\t// Compute edits from the snapshots\n\t\t\t\tlet edits: (TextEdit | ICellEditOperation)[] = [];\n\t\t\t\tif (beforeSnapshot === undefined) {\n\t\t\t\t\tthis._timeline.recordFileOperation({\n\t\t\t\t\t\ttype: FileOperationType.Create,\n\t\t\t\t\t\turi: resource,\n\t\t\t\t\t\trequestId: responseModel.requestId,\n\t\t\t\t\t\tepoch: this._timeline.incrementEpoch(),\n\t\t\t\t\t\tinitialContent: afterSnapshot,\n\t\t\t\t\t\ttelemetryInfo: entry.telemetryInfo,\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tedits = await entry.computeEditsFromSnapshots(beforeSnapshot, afterSnapshot);\n\t\t\t\t\tthis._recordEditOperations(entry, resource, edits, responseModel);\n\t\t\t\t}\n\n\t\t\t\tprogress.push(entry instanceof ChatEditingModifiedNotebookEntry ? {\n\t\t\t\t\tkind: 'notebookEdit',\n\t\t\t\t\turi: resource,\n\t\t\t\t\tedits: edits as ICellEditOperation[],\n\t\t\t\t\tdone: true,\n\t\t\t\t\tisExternalEdit: true\n\t\t\t\t} : {\n\t\t\t\t\tkind: 'textEdit',\n\t\t\t\t\turi: resource,\n\t\t\t\t\tedits: edits as TextEdit[],\n\t\t\t\t\tdone: true,\n\t\t\t\t\tisExternalEdit: true\n\t\t\t\t});\n\n\t\t\t\t// Mark as no longer being modified\n\t\t\t\tawait entry.acceptStreamingEditsEnd();\n\n\t\t\t\t// Clear external edit mode\n\t\t\t\tentry.stopExternalEdit();\n\t\t\t}\n\t\t} finally {\n\t\t\t// Release all the locks\n\t\t\toperation.releaseLocks();\n\n\t\t\tconst hasOtherTasks = Iterable.some(this._streamingEditLocks.keys(), k => !operation.snapshots.has(URI.parse(k)));\n\t\t\tif (!hasOtherTasks) {\n\t\t\t\tthis._state.set(ChatEditingSessionState.Idle, undefined);\n\t\t\t}\n\t\t}\n\n\n\t\treturn progress;\n\t}\n\n\tasync undoInteraction(): Promise<void> {\n\t\tawait this._timeline.undoToLastCheckpoint();\n\t}\n\n\tasync redoInteraction(): Promise<void> {\n\t\tawait this._timeline.redoToNextCheckpoint();\n\t}\n\n\tprivate _recordEditOperations(entry: AbstractChatEditingModifiedFileEntry, resource: URI, edits: (TextEdit | ICellEditOperation)[], responseModel: IChatResponseModel): void {\n\t\t// Determine if these are text edits or notebook edits\n\t\tconst isNotebookEdits = edits.length > 0 && hasKey(edits[0], { cells: true });\n\n\t\tif (isNotebookEdits) {\n\t\t\t// Record notebook edit operation\n\t\t\tconst notebookEdits = edits as ICellEditOperation[];\n\t\t\tthis._timeline.recordFileOperation({\n\t\t\t\ttype: FileOperationType.NotebookEdit,\n\t\t\t\turi: resource,\n\t\t\t\trequestId: responseModel.requestId,\n\t\t\t\tepoch: this._timeline.incrementEpoch(),\n\t\t\t\tcellEdits: notebookEdits\n\t\t\t});\n\t\t} else {\n\t\t\tlet cellIndex: number | undefined;\n\t\t\tif (entry instanceof ChatEditingModifiedNotebookEntry) {\n\t\t\t\tconst cellUri = CellUri.parse(resource);\n\t\t\t\tif (cellUri) {\n\t\t\t\t\tconst i = entry.getIndexOfCellHandle(cellUri.handle);\n\t\t\t\t\tif (i !== -1) {\n\t\t\t\t\t\tcellIndex = i;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst textEdits = edits as TextEdit[];\n\t\t\tthis._timeline.recordFileOperation({\n\t\t\t\ttype: FileOperationType.TextEdit,\n\t\t\t\turi: resource,\n\t\t\t\trequestId: responseModel.requestId,\n\t\t\t\tepoch: this._timeline.incrementEpoch(),\n\t\t\t\tedits: textEdits,\n\t\t\t\tcellIndex,\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate _getCurrentTextOrNotebookSnapshot(entry: AbstractChatEditingModifiedFileEntry): string {\n\t\tif (entry instanceof ChatEditingModifiedNotebookEntry) {\n\t\t\treturn entry.getCurrentSnapshot();\n\t\t} else if (entry instanceof ChatEditingModifiedDocumentEntry) {\n\t\t\treturn entry.getCurrentContents();\n\t\t} else {\n\t\t\tthrow new Error(`unknown entry type for ${entry.modifiedURI}`);\n\t\t}\n\t}\n\n\tprivate async _acceptStreamingEditsStart(responseModel: IChatResponseModel, undoStop: string | undefined, resource: URI) {\n\t\tconst entry = await this._getOrCreateModifiedFileEntry(resource, NotExistBehavior.Create, this._getTelemetryInfoForModel(responseModel));\n\n\t\t// Record file baseline if this is the first edit for this file in this request\n\t\tif (!this._timeline.hasFileBaseline(resource, responseModel.requestId)) {\n\t\t\tthis._timeline.recordFileBaseline({\n\t\t\t\turi: resource,\n\t\t\t\trequestId: responseModel.requestId,\n\t\t\t\tcontent: this._getCurrentTextOrNotebookSnapshot(entry),\n\t\t\t\tepoch: this._timeline.incrementEpoch(),\n\t\t\t\ttelemetryInfo: entry.telemetryInfo,\n\t\t\t\tnotebookViewType: entry instanceof ChatEditingModifiedNotebookEntry ? entry.viewType : undefined,\n\t\t\t});\n\t\t}\n\n\t\ttransaction((tx) => {\n\t\t\tthis._state.set(ChatEditingSessionState.StreamingEdits, tx);\n\t\t\tentry.acceptStreamingEditsStart(responseModel, undoStop, tx);\n\t\t\t// Note: Individual edit operations will be recorded by the file entries\n\t\t});\n\n\t\treturn entry;\n\t}\n\n\tprivate async _initEntries({ entries }: IChatEditingSessionStop): Promise<void> {\n\t\t// Reset all the files which are modified in this session state\n\t\t// but which are not found in the snapshot\n\t\tfor (const entry of this._entriesObs.get()) {\n\t\t\tconst snapshotEntry = entries.get(entry.modifiedURI);\n\t\t\tif (!snapshotEntry) {\n\t\t\t\tawait entry.resetToInitialContent();\n\t\t\t\tentry.dispose();\n\t\t\t}\n\t\t}\n\n\t\tconst entriesArr: AbstractChatEditingModifiedFileEntry[] = [];\n\t\t// Restore all entries from the snapshot\n\t\tfor (const snapshotEntry of entries.values()) {\n\t\t\tconst entry = await this._getOrCreateModifiedFileEntry(snapshotEntry.resource, NotExistBehavior.Abort, snapshotEntry.telemetryInfo);\n\t\t\tif (entry) {\n\t\t\t\tconst restoreToDisk = snapshotEntry.state === ModifiedFileEntryState.Modified;\n\t\t\t\tawait entry.restoreFromSnapshot(snapshotEntry, restoreToDisk);\n\t\t\t\tentriesArr.push(entry);\n\t\t\t}\n\t\t}\n\n\t\tthis._entriesObs.set(entriesArr, undefined);\n\t}\n\n\tprivate async _acceptEdits(resource: URI, textEdits: (TextEdit | ICellEditOperation)[], isLastEdits: boolean, responseModel: IChatResponseModel): Promise<void> {\n\t\tconst entry = await this._getOrCreateModifiedFileEntry(resource, NotExistBehavior.Create, this._getTelemetryInfoForModel(responseModel));\n\n\t\t// Record edit operations in the timeline if there are actual edits\n\t\tif (textEdits.length > 0) {\n\t\t\tthis._recordEditOperations(entry, resource, textEdits, responseModel);\n\t\t}\n\n\t\tawait entry.acceptAgentEdits(resource, textEdits, isLastEdits, responseModel);\n\t}\n\n\tprivate _getTelemetryInfoForModel(responseModel: IChatResponseModel): IModifiedEntryTelemetryInfo {\n\t\t// Make these getters because the response result is not available when the file first starts to be edited\n\t\treturn new class implements IModifiedEntryTelemetryInfo {\n\t\t\tget agentId() { return responseModel.agent?.id; }\n\t\t\tget modelId() { return responseModel.request?.modelId; }\n\t\t\tget modeId() { return responseModel.request?.modeInfo?.modeId; }\n\t\t\tget command() { return responseModel.slashCommand?.name; }\n\t\t\tget sessionResource() { return responseModel.session.sessionResource; }\n\t\t\tget requestId() { return responseModel.requestId; }\n\t\t\tget result() { return responseModel.result; }\n\t\t\tget applyCodeBlockSuggestionId() { return responseModel.request?.modeInfo?.applyCodeBlockSuggestionId; }\n\n\t\t\tget feature(): 'sideBarChat' | 'inlineChat' | undefined {\n\t\t\t\tif (responseModel.session.initialLocation === ChatAgentLocation.Chat) {\n\t\t\t\t\treturn 'sideBarChat';\n\t\t\t\t} else if (responseModel.session.initialLocation === ChatAgentLocation.EditorInline) {\n\t\t\t\t\treturn 'inlineChat';\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t};\n\t}\n\n\tprivate async _resolve(requestId: string, undoStop: string | undefined, resource: URI): Promise<void> {\n\t\tconst hasOtherTasks = Iterable.some(this._streamingEditLocks.keys(), k => k !== resource.toString());\n\t\tif (!hasOtherTasks) {\n\t\t\tthis._state.set(ChatEditingSessionState.Idle, undefined);\n\t\t}\n\n\t\tconst entry = this._getEntry(resource);\n\t\tif (!entry) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Create checkpoint for this edit completion\n\t\tconst label = undoStop ? `Request ${requestId} - Stop ${undoStop}` : `Request ${requestId}`;\n\t\tthis._timeline.createCheckpoint(requestId, undoStop, label);\n\n\t\treturn entry.acceptStreamingEditsEnd();\n\t}\n\n\t/**\n\t * Retrieves or creates a modified file entry.\n\t *\n\t * @returns The modified file entry.\n\t */\n\tprivate async _getOrCreateModifiedFileEntry(resource: URI, ifNotExists: NotExistBehavior.Create, telemetryInfo: IModifiedEntryTelemetryInfo, initialContent?: string): Promise<AbstractChatEditingModifiedFileEntry>;\n\tprivate async _getOrCreateModifiedFileEntry(resource: URI, ifNotExists: NotExistBehavior, telemetryInfo: IModifiedEntryTelemetryInfo, initialContent?: string): Promise<AbstractChatEditingModifiedFileEntry | undefined>;\n\tprivate async _getOrCreateModifiedFileEntry(resource: URI, ifNotExists: NotExistBehavior, telemetryInfo: IModifiedEntryTelemetryInfo, _initialContent?: string): Promise<AbstractChatEditingModifiedFileEntry | undefined> {\n\n\t\tresource = CellUri.parse(resource)?.notebook ?? resource;\n\n\t\tconst existingEntry = this._entriesObs.get().find(e => isEqual(e.modifiedURI, resource));\n\t\tif (existingEntry) {\n\t\t\tif (telemetryInfo.requestId !== existingEntry.telemetryInfo.requestId) {\n\t\t\t\texistingEntry.updateTelemetryInfo(telemetryInfo);\n\t\t\t}\n\t\t\treturn existingEntry;\n\t\t}\n\n\t\tlet entry: AbstractChatEditingModifiedFileEntry;\n\t\tconst existingExternalEntry = this._lookupExternalEntry(resource);\n\t\tif (existingExternalEntry) {\n\t\t\tentry = existingExternalEntry;\n\n\t\t\tif (telemetryInfo.requestId !== entry.telemetryInfo.requestId) {\n\t\t\t\tentry.updateTelemetryInfo(telemetryInfo);\n\t\t\t}\n\t\t} else {\n\t\t\tconst initialContent = _initialContent ?? this._initialFileContents.get(resource);\n\t\t\t// This gets manually disposed in .dispose() or in .restoreSnapshot()\n\t\t\tconst maybeEntry = await this._createModifiedFileEntry(resource, telemetryInfo, ifNotExists, initialContent);\n\t\t\tif (!maybeEntry) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tentry = maybeEntry;\n\t\t\tif (initialContent === undefined) {\n\t\t\t\tthis._initialFileContents.set(resource, entry.initialContent);\n\t\t\t}\n\t\t}\n\n\t\t// If an entry is deleted e.g. reverting a created file,\n\t\t// remove it from the entries and don't show it in the working set anymore\n\t\t// so that it can be recreated e.g. through retry\n\t\tconst listener = entry.onDidDelete(() => {\n\t\t\tconst newEntries = this._entriesObs.get().filter(e => !isEqual(e.modifiedURI, entry.modifiedURI));\n\t\t\tthis._entriesObs.set(newEntries, undefined);\n\t\t\tthis._editorService.closeEditors(this._editorService.findEditors(entry.modifiedURI));\n\n\t\t\tif (!existingExternalEntry) {\n\t\t\t\t// don't dispose entries that are not yours!\n\t\t\t\tentry.dispose();\n\t\t\t}\n\n\t\t\tthis._store.delete(listener);\n\t\t});\n\t\tthis._store.add(listener);\n\n\t\tconst entriesArr = [...this._entriesObs.get(), entry];\n\t\tthis._entriesObs.set(entriesArr, undefined);\n\n\t\treturn entry;\n\t}\n\n\tprivate async _createModifiedFileEntry(resource: URI, telemetryInfo: IModifiedEntryTelemetryInfo, ifNotExists: NotExistBehavior.Create, initialContent: string | undefined): Promise<AbstractChatEditingModifiedFileEntry>;\n\tprivate async _createModifiedFileEntry(resource: URI, telemetryInfo: IModifiedEntryTelemetryInfo, ifNotExists: NotExistBehavior, initialContent: string | undefined): Promise<AbstractChatEditingModifiedFileEntry | undefined>;\n\n\tprivate async _createModifiedFileEntry(resource: URI, telemetryInfo: IModifiedEntryTelemetryInfo, ifNotExists: NotExistBehavior, initialContent: string | undefined): Promise<AbstractChatEditingModifiedFileEntry | undefined> {\n\t\tconst multiDiffEntryDelegate = {\n\t\t\tcollapse: (transaction: ITransaction | undefined) => this._collapse(resource, transaction),\n\t\t\trecordOperation: (operation: Mutable<FileOperation>) => {\n\t\t\t\toperation.epoch = this._timeline.incrementEpoch();\n\t\t\t\tthis._timeline.recordFileOperation(operation);\n\t\t\t},\n\t\t};\n\t\tconst notebookUri = CellUri.parse(resource)?.notebook || resource;\n\t\tconst doCreate = async (chatKind: ChatEditKind) => {\n\t\t\tif (this._notebookService.hasSupportedNotebooks(notebookUri)) {\n\t\t\t\treturn await ChatEditingModifiedNotebookEntry.create(notebookUri, multiDiffEntryDelegate, telemetryInfo, chatKind, initialContent, this._instantiationService);\n\t\t\t} else {\n\t\t\t\tconst ref = await this._textModelService.createModelReference(resource);\n\t\t\t\treturn this._instantiationService.createInstance(ChatEditingModifiedDocumentEntry, ref, multiDiffEntryDelegate, telemetryInfo, chatKind, initialContent);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\treturn await doCreate(ChatEditKind.Modified);\n\t\t} catch (err) {\n\t\t\tif (ifNotExists === NotExistBehavior.Abort) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\n\t\t\t// this file does not exist yet, create it and try again\n\t\t\tawait this._bulkEditService.apply({ edits: [{ newResource: resource }] });\n\t\t\tif (this.configurationService.getValue<boolean>('accessibility.openChatEditedFiles')) {\n\t\t\t\tthis._editorService.openEditor({ resource, options: { inactive: true, preserveFocus: true, pinned: true } });\n\t\t\t}\n\n\t\t\t// Record file creation operation\n\t\t\tthis._timeline.recordFileOperation({\n\t\t\t\ttype: FileOperationType.Create,\n\t\t\t\turi: resource,\n\t\t\t\trequestId: telemetryInfo.requestId,\n\t\t\t\tepoch: this._timeline.incrementEpoch(),\n\t\t\t\tinitialContent: initialContent || '',\n\t\t\t\ttelemetryInfo,\n\t\t\t});\n\n\t\t\tif (this._notebookService.hasSupportedNotebooks(notebookUri)) {\n\t\t\t\treturn await ChatEditingModifiedNotebookEntry.create(resource, multiDiffEntryDelegate, telemetryInfo, ChatEditKind.Created, initialContent, this._instantiationService);\n\t\t\t} else {\n\t\t\t\treturn await doCreate(ChatEditKind.Created);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _collapse(resource: URI, transaction: ITransaction | undefined) {\n\t\tconst multiDiffItem = this._editorPane?.findDocumentDiffItem(resource);\n\t\tif (multiDiffItem) {\n\t\t\tthis._editorPane?.viewModel?.items.get().find((documentDiffItem) =>\n\t\t\t\tisEqual(documentDiffItem.originalUri, multiDiffItem.originalUri) &&\n\t\t\t\tisEqual(documentDiffItem.modifiedUri, multiDiffItem.modifiedUri))\n\t\t\t\t?.collapsed.set(true, transaction);\n\t\t}\n\t}\n}\n"]}