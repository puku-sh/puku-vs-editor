{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/browser/contrib/chatDynamicVariables.ts","vs/workbench/contrib/chat/browser/contrib/chatDynamicVariables.ts"],"names":[],"mappings":"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","file":"chatDynamicVariables.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from '../../../../../base/common/arrays.js';\nimport { IMarkdownString, MarkdownString } from '../../../../../base/common/htmlContent.js';\nimport { Disposable, dispose, isDisposable } from '../../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { IRange, Range } from '../../../../../editor/common/core/range.js';\nimport { IDecorationOptions } from '../../../../../editor/common/editorCommon.js';\nimport { Command, isLocation } from '../../../../../editor/common/languages.js';\nimport { Action2, registerAction2 } from '../../../../../platform/actions/common/actions.js';\nimport { ICommandService } from '../../../../../platform/commands/common/commands.js';\nimport { ServicesAccessor } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { ILabelService } from '../../../../../platform/label/common/label.js';\nimport { IChatRequestVariableValue, IDynamicVariable } from '../../common/chatVariables.js';\nimport { IChatWidget } from '../chat.js';\nimport { IChatWidgetContrib } from '../chatWidget.js';\n\nexport const dynamicVariableDecorationType = 'chat-dynamic-variable';\n\n\n\nexport class ChatDynamicVariableModel extends Disposable implements IChatWidgetContrib {\n\tpublic static readonly ID = 'chatDynamicVariableModel';\n\n\tprivate _variables: IDynamicVariable[] = [];\n\n\tget variables(): ReadonlyArray<IDynamicVariable> {\n\t\treturn [...this._variables];\n\t}\n\n\tget id() {\n\t\treturn ChatDynamicVariableModel.ID;\n\t}\n\n\tprivate decorationData: { id: string; text: string }[] = [];\n\n\tconstructor(\n\t\tprivate readonly widget: IChatWidget,\n\t\t@ILabelService private readonly labelService: ILabelService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(widget.inputEditor.onDidChangeModelContent(e => {\n\n\t\t\tconst removed: IDynamicVariable[] = [];\n\t\t\tlet didChange = false;\n\n\t\t\t// Don't mutate entries in _variables, since they will be returned from the getter\n\t\t\tthis._variables = coalesce(this._variables.map((ref, idx): IDynamicVariable | null => {\n\t\t\t\tconst model = widget.inputEditor.getModel();\n\n\t\t\t\tif (!model) {\n\t\t\t\t\tremoved.push(ref);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst data = this.decorationData[idx];\n\t\t\t\tconst newRange = model.getDecorationRange(data.id);\n\n\t\t\t\tif (!newRange) {\n\t\t\t\t\t// gone\n\t\t\t\t\tremoved.push(ref);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst newText = model.getValueInRange(newRange);\n\t\t\t\tif (newText !== data.text) {\n\n\t\t\t\t\tthis.widget.inputEditor.executeEdits(this.id, [{\n\t\t\t\t\t\trange: newRange,\n\t\t\t\t\t\ttext: '',\n\t\t\t\t\t}]);\n\t\t\t\t\tthis.widget.refreshParsedInput();\n\n\t\t\t\t\tremoved.push(ref);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tif (newRange.equalsRange(ref.range)) {\n\t\t\t\t\t// all good\n\t\t\t\t\treturn ref;\n\t\t\t\t}\n\n\t\t\t\tdidChange = true;\n\n\t\t\t\treturn { ...ref, range: newRange };\n\t\t\t}));\n\n\t\t\t// cleanup disposable variables\n\t\t\tdispose(removed.filter(isDisposable));\n\n\t\t\tif (didChange || removed.length > 0) {\n\t\t\t\tthis.widget.refreshParsedInput();\n\t\t\t}\n\n\t\t\tthis.updateDecorations();\n\t\t}));\n\t}\n\n\tgetInputState(contrib: Record<string, unknown>): void {\n\t\tcontrib[ChatDynamicVariableModel.ID] = this.variables;\n\t}\n\n\tsetInputState(contrib: Readonly<Record<string, unknown>>): void {\n\t\tlet s = contrib[ChatDynamicVariableModel.ID] as unknown[];\n\t\tif (!Array.isArray(s)) {\n\t\t\ts = [];\n\t\t}\n\n\t\tthis.disposeVariables();\n\t\tthis._variables = [];\n\n\t\tfor (const variable of s) {\n\t\t\tif (!isDynamicVariable(variable)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tthis.addReference(variable);\n\t\t}\n\t}\n\n\taddReference(ref: IDynamicVariable): void {\n\t\tthis._variables.push(ref);\n\t\tthis.updateDecorations();\n\t\tthis.widget.refreshParsedInput();\n\t}\n\n\tprivate updateDecorations(): void {\n\n\t\tconst decorationIds = this.widget.inputEditor.setDecorationsByType('chat', dynamicVariableDecorationType, this._variables.map((r): IDecorationOptions => ({\n\t\t\trange: r.range,\n\t\t\thoverMessage: this.getHoverForReference(r)\n\t\t})));\n\n\t\tthis.decorationData = [];\n\t\tfor (let i = 0; i < decorationIds.length; i++) {\n\t\t\tthis.decorationData.push({\n\t\t\t\tid: decorationIds[i],\n\t\t\t\ttext: this.widget.inputEditor.getModel()!.getValueInRange(this._variables[i].range)\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate getHoverForReference(ref: IDynamicVariable): IMarkdownString | undefined {\n\t\tconst value = ref.data;\n\t\tif (URI.isUri(value)) {\n\t\t\treturn new MarkdownString(this.labelService.getUriLabel(value, { relative: true }));\n\t\t} else if (isLocation(value)) {\n\t\t\tconst prefix = ref.fullName ? ` ${ref.fullName}` : '';\n\t\t\tconst rangeString = `#${value.range.startLineNumber}-${value.range.endLineNumber}`;\n\t\t\treturn new MarkdownString(prefix + this.labelService.getUriLabel(value.uri, { relative: true }) + rangeString);\n\t\t} else {\n\t\t\treturn undefined;\n\t\t}\n\t}\n\n\t/**\n\t * Dispose all existing variables.\n\t */\n\tprivate disposeVariables(): void {\n\t\tfor (const variable of this._variables) {\n\t\t\tif (isDisposable(variable)) {\n\t\t\t\tvariable.dispose();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic override dispose() {\n\t\tthis.disposeVariables();\n\t\tsuper.dispose();\n\t}\n}\n\n/**\n * Loose check to filter objects that are obviously missing data\n */\nfunction isDynamicVariable(obj: any): obj is IDynamicVariable {\n\treturn obj &&\n\t\ttypeof obj.id === 'string' &&\n\t\tRange.isIRange(obj.range) &&\n\t\t'data' in obj;\n}\n\n\n\nexport interface IAddDynamicVariableContext {\n\tid: string;\n\twidget: IChatWidget;\n\trange: IRange;\n\tvariableData: IChatRequestVariableValue;\n\tcommand?: Command;\n}\n\nfunction isAddDynamicVariableContext(context: any): context is IAddDynamicVariableContext {\n\treturn 'widget' in context &&\n\t\t'range' in context &&\n\t\t'variableData' in context;\n}\n\nexport class AddDynamicVariableAction extends Action2 {\n\tstatic readonly ID = 'workbench.action.chat.addDynamicVariable';\n\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: AddDynamicVariableAction.ID,\n\t\t\ttitle: '' // not displayed\n\t\t});\n\t}\n\n\tasync run(accessor: ServicesAccessor, ...args: unknown[]) {\n\t\tconst context = args[0];\n\t\tif (!isAddDynamicVariableContext(context)) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet range = context.range;\n\t\tconst variableData = context.variableData;\n\n\t\tconst doCleanup = () => {\n\t\t\t// Failed, remove the dangling variable prefix\n\t\t\tcontext.widget.inputEditor.executeEdits('chatInsertDynamicVariableWithArguments', [{ range: context.range, text: `` }]);\n\t\t};\n\n\t\t// If this completion item has no command, return it directly\n\t\tif (context.command) {\n\t\t\t// Invoke the command on this completion item along with its args and return the result\n\t\t\tconst commandService = accessor.get(ICommandService);\n\t\t\tconst selection: string | undefined = await commandService.executeCommand(context.command.id, ...(context.command.arguments ?? []));\n\t\t\tif (!selection) {\n\t\t\t\tdoCleanup();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Compute new range and variableData\n\t\t\tconst insertText = ':' + selection;\n\t\t\tconst insertRange = new Range(range.startLineNumber, range.endColumn, range.endLineNumber, range.endColumn + insertText.length);\n\t\t\trange = new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn + insertText.length);\n\t\t\tconst editor = context.widget.inputEditor;\n\t\t\tconst success = editor.executeEdits('chatInsertDynamicVariableWithArguments', [{ range: insertRange, text: insertText + ' ' }]);\n\t\t\tif (!success) {\n\t\t\t\tdoCleanup();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tcontext.widget.getContrib<ChatDynamicVariableModel>(ChatDynamicVariableModel.ID)?.addReference({\n\t\t\tid: context.id,\n\t\t\trange: range,\n\t\t\tisFile: true,\n\t\t\tdata: variableData\n\t\t});\n\t}\n}\nregisterAction2(AddDynamicVariableAction);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from '../../../../../base/common/arrays.js';\nimport { IMarkdownString, MarkdownString } from '../../../../../base/common/htmlContent.js';\nimport { Disposable, dispose, isDisposable } from '../../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { IRange, Range } from '../../../../../editor/common/core/range.js';\nimport { IDecorationOptions } from '../../../../../editor/common/editorCommon.js';\nimport { Command, isLocation } from '../../../../../editor/common/languages.js';\nimport { Action2, registerAction2 } from '../../../../../platform/actions/common/actions.js';\nimport { ICommandService } from '../../../../../platform/commands/common/commands.js';\nimport { ServicesAccessor } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { ILabelService } from '../../../../../platform/label/common/label.js';\nimport { IChatRequestVariableValue, IDynamicVariable } from '../../common/chatVariables.js';\nimport { IChatWidget } from '../chat.js';\nimport { IChatWidgetContrib } from '../chatWidget.js';\n\nexport const dynamicVariableDecorationType = 'chat-dynamic-variable';\n\n\n\nexport class ChatDynamicVariableModel extends Disposable implements IChatWidgetContrib {\n\tpublic static readonly ID = 'chatDynamicVariableModel';\n\n\tprivate _variables: IDynamicVariable[] = [];\n\n\tget variables(): ReadonlyArray<IDynamicVariable> {\n\t\treturn [...this._variables];\n\t}\n\n\tget id() {\n\t\treturn ChatDynamicVariableModel.ID;\n\t}\n\n\tprivate decorationData: { id: string; text: string }[] = [];\n\n\tconstructor(\n\t\tprivate readonly widget: IChatWidget,\n\t\t@ILabelService private readonly labelService: ILabelService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(widget.inputEditor.onDidChangeModelContent(e => {\n\n\t\t\tconst removed: IDynamicVariable[] = [];\n\t\t\tlet didChange = false;\n\n\t\t\t// Don't mutate entries in _variables, since they will be returned from the getter\n\t\t\tthis._variables = coalesce(this._variables.map((ref, idx): IDynamicVariable | null => {\n\t\t\t\tconst model = widget.inputEditor.getModel();\n\n\t\t\t\tif (!model) {\n\t\t\t\t\tremoved.push(ref);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst data = this.decorationData[idx];\n\t\t\t\tconst newRange = model.getDecorationRange(data.id);\n\n\t\t\t\tif (!newRange) {\n\t\t\t\t\t// gone\n\t\t\t\t\tremoved.push(ref);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst newText = model.getValueInRange(newRange);\n\t\t\t\tif (newText !== data.text) {\n\n\t\t\t\t\tthis.widget.inputEditor.executeEdits(this.id, [{\n\t\t\t\t\t\trange: newRange,\n\t\t\t\t\t\ttext: '',\n\t\t\t\t\t}]);\n\t\t\t\t\tthis.widget.refreshParsedInput();\n\n\t\t\t\t\tremoved.push(ref);\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tif (newRange.equalsRange(ref.range)) {\n\t\t\t\t\t// all good\n\t\t\t\t\treturn ref;\n\t\t\t\t}\n\n\t\t\t\tdidChange = true;\n\n\t\t\t\treturn { ...ref, range: newRange };\n\t\t\t}));\n\n\t\t\t// cleanup disposable variables\n\t\t\tdispose(removed.filter(isDisposable));\n\n\t\t\tif (didChange || removed.length > 0) {\n\t\t\t\tthis.widget.refreshParsedInput();\n\t\t\t}\n\n\t\t\tthis.updateDecorations();\n\t\t}));\n\t}\n\n\tgetInputState(contrib: Record<string, unknown>): void {\n\t\tcontrib[ChatDynamicVariableModel.ID] = this.variables;\n\t}\n\n\tsetInputState(contrib: Readonly<Record<string, unknown>>): void {\n\t\tlet s = contrib[ChatDynamicVariableModel.ID] as unknown[];\n\t\tif (!Array.isArray(s)) {\n\t\t\ts = [];\n\t\t}\n\n\t\tthis.disposeVariables();\n\t\tthis._variables = [];\n\n\t\tfor (const variable of s) {\n\t\t\tif (!isDynamicVariable(variable)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tthis.addReference(variable);\n\t\t}\n\t}\n\n\taddReference(ref: IDynamicVariable): void {\n\t\tthis._variables.push(ref);\n\t\tthis.updateDecorations();\n\t\tthis.widget.refreshParsedInput();\n\t}\n\n\tprivate updateDecorations(): void {\n\n\t\tconst decorationIds = this.widget.inputEditor.setDecorationsByType('chat', dynamicVariableDecorationType, this._variables.map((r): IDecorationOptions => ({\n\t\t\trange: r.range,\n\t\t\thoverMessage: this.getHoverForReference(r)\n\t\t})));\n\n\t\tthis.decorationData = [];\n\t\tfor (let i = 0; i < decorationIds.length; i++) {\n\t\t\tthis.decorationData.push({\n\t\t\t\tid: decorationIds[i],\n\t\t\t\ttext: this.widget.inputEditor.getModel()!.getValueInRange(this._variables[i].range)\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate getHoverForReference(ref: IDynamicVariable): IMarkdownString | undefined {\n\t\tconst value = ref.data;\n\t\tif (URI.isUri(value)) {\n\t\t\treturn new MarkdownString(this.labelService.getUriLabel(value, { relative: true }));\n\t\t} else if (isLocation(value)) {\n\t\t\tconst prefix = ref.fullName ? ` ${ref.fullName}` : '';\n\t\t\tconst rangeString = `#${value.range.startLineNumber}-${value.range.endLineNumber}`;\n\t\t\treturn new MarkdownString(prefix + this.labelService.getUriLabel(value.uri, { relative: true }) + rangeString);\n\t\t} else {\n\t\t\treturn undefined;\n\t\t}\n\t}\n\n\t/**\n\t * Dispose all existing variables.\n\t */\n\tprivate disposeVariables(): void {\n\t\tfor (const variable of this._variables) {\n\t\t\tif (isDisposable(variable)) {\n\t\t\t\tvariable.dispose();\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic override dispose() {\n\t\tthis.disposeVariables();\n\t\tsuper.dispose();\n\t}\n}\n\n/**\n * Loose check to filter objects that are obviously missing data\n */\nfunction isDynamicVariable(obj: any): obj is IDynamicVariable {\n\treturn obj &&\n\t\ttypeof obj.id === 'string' &&\n\t\tRange.isIRange(obj.range) &&\n\t\t'data' in obj;\n}\n\n\n\nexport interface IAddDynamicVariableContext {\n\tid: string;\n\twidget: IChatWidget;\n\trange: IRange;\n\tvariableData: IChatRequestVariableValue;\n\tcommand?: Command;\n}\n\nfunction isAddDynamicVariableContext(context: any): context is IAddDynamicVariableContext {\n\treturn 'widget' in context &&\n\t\t'range' in context &&\n\t\t'variableData' in context;\n}\n\nexport class AddDynamicVariableAction extends Action2 {\n\tstatic readonly ID = 'workbench.action.chat.addDynamicVariable';\n\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: AddDynamicVariableAction.ID,\n\t\t\ttitle: '' // not displayed\n\t\t});\n\t}\n\n\tasync run(accessor: ServicesAccessor, ...args: unknown[]) {\n\t\tconst context = args[0];\n\t\tif (!isAddDynamicVariableContext(context)) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet range = context.range;\n\t\tconst variableData = context.variableData;\n\n\t\tconst doCleanup = () => {\n\t\t\t// Failed, remove the dangling variable prefix\n\t\t\tcontext.widget.inputEditor.executeEdits('chatInsertDynamicVariableWithArguments', [{ range: context.range, text: `` }]);\n\t\t};\n\n\t\t// If this completion item has no command, return it directly\n\t\tif (context.command) {\n\t\t\t// Invoke the command on this completion item along with its args and return the result\n\t\t\tconst commandService = accessor.get(ICommandService);\n\t\t\tconst selection: string | undefined = await commandService.executeCommand(context.command.id, ...(context.command.arguments ?? []));\n\t\t\tif (!selection) {\n\t\t\t\tdoCleanup();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Compute new range and variableData\n\t\t\tconst insertText = ':' + selection;\n\t\t\tconst insertRange = new Range(range.startLineNumber, range.endColumn, range.endLineNumber, range.endColumn + insertText.length);\n\t\t\trange = new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn + insertText.length);\n\t\t\tconst editor = context.widget.inputEditor;\n\t\t\tconst success = editor.executeEdits('chatInsertDynamicVariableWithArguments', [{ range: insertRange, text: insertText + ' ' }]);\n\t\t\tif (!success) {\n\t\t\t\tdoCleanup();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tcontext.widget.getContrib<ChatDynamicVariableModel>(ChatDynamicVariableModel.ID)?.addReference({\n\t\t\tid: context.id,\n\t\t\trange: range,\n\t\t\tisFile: true,\n\t\t\tdata: variableData\n\t\t});\n\t}\n}\nregisterAction2(AddDynamicVariableAction);\n"]}