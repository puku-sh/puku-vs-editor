{"version":3,"sources":["vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolOutputPart.ts"],"names":[],"mappings":"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","file":"chatToolOutputPart.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from '../../../../../../base/browser/dom.js';\nimport { renderMarkdown } from '../../../../../../base/browser/markdownRenderer.js';\nimport { decodeBase64 } from '../../../../../../base/common/buffer.js';\nimport { CancellationTokenSource } from '../../../../../../base/common/cancellation.js';\nimport { Codicon } from '../../../../../../base/common/codicons.js';\nimport { ThemeIcon } from '../../../../../../base/common/themables.js';\nimport { generateUuid } from '../../../../../../base/common/uuid.js';\nimport { localize } from '../../../../../../nls.js';\nimport { IInstantiationService } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { IChatToolInvocation, IChatToolInvocationSerialized, IToolResultOutputDetailsSerialized } from '../../../common/chatService.js';\nimport { IChatViewModel } from '../../../common/chatViewModel.js';\nimport { IToolResultOutputDetails } from '../../../common/languageModelToolsService.js';\nimport { IChatCodeBlockInfo, IChatWidgetService } from '../../chat.js';\nimport { IChatOutputRendererService } from '../../chatOutputItemRenderer.js';\nimport { IChatContentPartRenderContext } from '../chatContentParts.js';\nimport { ChatProgressSubPart } from '../chatProgressContentPart.js';\nimport { BaseChatToolInvocationSubPart } from './chatToolInvocationSubPart.js';\n\ninterface OutputState {\n\treadonly webviewOrigin: string;\n\theight: number;\n}\n\n// TODO: see if we can reuse existing types instead of adding ChatToolOutputSubPart\nexport class ChatToolOutputSubPart extends BaseChatToolInvocationSubPart {\n\n\t/** Remembers cached state on re-render */\n\tprivate static readonly _cachedStates = new WeakMap<IChatViewModel | IChatToolInvocationSerialized, Map<string, OutputState>>();\n\n\tpublic readonly domNode: HTMLElement;\n\n\tpublic override readonly codeblocks: IChatCodeBlockInfo[] = [];\n\n\tprivate readonly _disposeCts = this._register(new CancellationTokenSource());\n\n\tconstructor(\n\t\ttoolInvocation: IChatToolInvocation | IChatToolInvocationSerialized,\n\t\tprivate readonly context: IChatContentPartRenderContext,\n\t\t@IChatOutputRendererService private readonly chatOutputItemRendererService: IChatOutputRendererService,\n\t\t@IChatWidgetService private readonly chatWidgetService: IChatWidgetService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t) {\n\t\tsuper(toolInvocation);\n\n\t\tconst details: IToolResultOutputDetails = toolInvocation.kind === 'toolInvocation'\n\t\t\t? IChatToolInvocation.resultDetails(toolInvocation) as IToolResultOutputDetails\n\t\t\t: {\n\t\t\t\toutput: {\n\t\t\t\t\ttype: 'data',\n\t\t\t\t\tmimeType: (toolInvocation.resultDetails as IToolResultOutputDetailsSerialized).output.mimeType,\n\t\t\t\t\tvalue: decodeBase64((toolInvocation.resultDetails as IToolResultOutputDetailsSerialized).output.base64Data),\n\t\t\t\t},\n\t\t\t};\n\n\t\tthis.domNode = dom.$('div.tool-output-part');\n\n\t\tconst titleEl = dom.$('.output-title');\n\t\tthis.domNode.appendChild(titleEl);\n\t\tif (typeof toolInvocation.invocationMessage === 'string') {\n\t\t\ttitleEl.textContent = toolInvocation.invocationMessage;\n\t\t} else {\n\t\t\tconst md = this._register(renderMarkdown(toolInvocation.invocationMessage));\n\t\t\ttitleEl.appendChild(md.element);\n\t\t}\n\n\t\tthis.domNode.appendChild(this.createOutputPart(toolInvocation, details));\n\t}\n\n\tpublic override dispose(): void {\n\t\tthis._disposeCts.dispose(true);\n\t\tsuper.dispose();\n\t}\n\n\tprivate createOutputPart(toolInvocation: IChatToolInvocation | IChatToolInvocationSerialized, details: IToolResultOutputDetails): HTMLElement {\n\t\tconst vm = this.chatWidgetService.getWidgetBySessionResource(this.context.element.sessionResource)?.viewModel;\n\n\t\tconst parent = dom.$('div.webview-output');\n\t\tparent.style.maxHeight = '80vh';\n\n\t\tlet partState: OutputState = { height: 0, webviewOrigin: generateUuid() };\n\t\tif (vm) {\n\t\t\tlet allStates = ChatToolOutputSubPart._cachedStates.get(vm);\n\t\t\tif (!allStates) {\n\t\t\t\tallStates = new Map<string, OutputState>();\n\t\t\t\tChatToolOutputSubPart._cachedStates.set(vm, allStates);\n\t\t\t}\n\n\t\t\tconst cachedState = allStates.get(toolInvocation.toolCallId);\n\t\t\tif (cachedState) {\n\t\t\t\tpartState = cachedState;\n\t\t\t} else {\n\t\t\t\tallStates.set(toolInvocation.toolCallId, partState);\n\t\t\t}\n\t\t}\n\n\t\tif (partState.height) {\n\t\t\tparent.style.height = `${partState.height}px`;\n\t\t}\n\n\t\tconst progressMessage = dom.$('span');\n\t\tprogressMessage.textContent = localize('loading', 'Rendering tool output...');\n\t\tconst progressPart = this._register(this.instantiationService.createInstance(ChatProgressSubPart, progressMessage, ThemeIcon.modify(Codicon.loading, 'spin'), undefined));\n\t\tparent.appendChild(progressPart.domNode);\n\n\t\t// TODO: we also need to show the tool output in the UI\n\t\tthis.chatOutputItemRendererService.renderOutputPart(details.output.mimeType, details.output.value.buffer, parent, { origin: partState.webviewOrigin }, this._disposeCts.token).then((renderedItem) => {\n\t\t\tif (this._disposeCts.token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._register(renderedItem);\n\n\t\t\tprogressPart.domNode.remove();\n\n\t\t\tthis._onDidChangeHeight.fire();\n\t\t\tthis._register(renderedItem.onDidChangeHeight(newHeight => {\n\t\t\t\tthis._onDidChangeHeight.fire();\n\t\t\t\tpartState.height = newHeight;\n\t\t\t}));\n\n\t\t\tthis._register(renderedItem.webview.onDidWheel(e => {\n\t\t\t\tthis.chatWidgetService.getWidgetBySessionResource(this.context.element.sessionResource)?.delegateScrollFromMouseWheelEvent({\n\t\t\t\t\t...e,\n\t\t\t\t\tpreventDefault: () => { },\n\t\t\t\t\tstopPropagation: () => { }\n\t\t\t\t});\n\t\t\t}));\n\n\t\t\t// When the webview is disconnected from the DOM due to being hidden, we need to reload it when it is shown again.\n\t\t\tconst widget = this.chatWidgetService.getWidgetBySessionResource(this.context.element.sessionResource);\n\t\t\tif (widget) {\n\t\t\t\tthis._register(widget?.onDidShow(() => {\n\t\t\t\t\trenderedItem.reinitialize();\n\t\t\t\t}));\n\t\t\t}\n\t\t}, (error) => {\n\t\t\tconsole.error('Error rendering tool output:', error);\n\n\t\t\tconst errorNode = dom.$('.output-error');\n\n\t\t\tconst errorHeaderNode = dom.$('.output-error-header');\n\t\t\tdom.append(errorNode, errorHeaderNode);\n\n\t\t\tconst iconElement = dom.$('div');\n\t\t\ticonElement.classList.add(...ThemeIcon.asClassNameArray(Codicon.error));\n\t\t\terrorHeaderNode.append(iconElement);\n\n\t\t\tconst errorTitleNode = dom.$('.output-error-title');\n\t\t\terrorTitleNode.textContent = localize('chat.toolOutputError', \"Error rendering the tool output\");\n\t\t\terrorHeaderNode.append(errorTitleNode);\n\n\t\t\tconst errorMessageNode = dom.$('.output-error-details');\n\t\t\terrorMessageNode.textContent = error?.message || String(error);\n\t\t\terrorNode.append(errorMessageNode);\n\n\t\t\tprogressPart.domNode.replaceWith(errorNode);\n\t\t});\n\n\t\treturn parent;\n\t}\n}\n"]}