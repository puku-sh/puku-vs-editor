{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/browser/chatEditing/notebook/chatEditingNotebookCellEntry.ts","vs/workbench/contrib/chat/browser/chatEditing/notebook/chatEditingNotebookCellEntry.ts"],"names":[],"mappings":"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","file":"chatEditingNotebookCellEntry.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable, DisposableStore } from '../../../../../../base/common/lifecycle.js';\nimport { IObservable, observableValue, transaction } from '../../../../../../base/common/observable.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { IRange } from '../../../../../../editor/common/core/range.js';\nimport { IDocumentDiff } from '../../../../../../editor/common/diff/documentDiffProvider.js';\nimport { DetailedLineRangeMapping } from '../../../../../../editor/common/diff/rangeMapping.js';\nimport { TextEdit } from '../../../../../../editor/common/languages.js';\nimport { ITextModel } from '../../../../../../editor/common/model.js';\nimport { IInstantiationService } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { CellEditState } from '../../../../notebook/browser/notebookBrowser.js';\nimport { INotebookEditorService } from '../../../../notebook/browser/services/notebookEditorService.js';\nimport { NotebookCellTextModel } from '../../../../notebook/common/model/notebookCellTextModel.js';\nimport { CellKind } from '../../../../notebook/common/notebookCommon.js';\nimport { ModifiedFileEntryState } from '../../../common/chatEditingService.js';\nimport { IChatResponseModel } from '../../../common/chatModel.js';\nimport { ChatEditingTextModelChangeService } from '../chatEditingTextModelChangeService.js';\n\n\n/**\n * This is very closely similar to the ChatEditingModifiedDocumentEntry class.\n * Most of the code has been borrowed from there, as a cell is effectively a document.\n * Hence most of the same functionality applies.\n */\nexport class ChatEditingNotebookCellEntry extends Disposable {\n\tpublic get isDisposed(): boolean {\n\t\treturn this._store.isDisposed;\n\t}\n\n\tpublic get isEditFromUs(): boolean {\n\t\treturn this._textModelChangeService.isEditFromUs;\n\t}\n\n\tpublic get allEditsAreFromUs(): boolean {\n\t\treturn this._textModelChangeService.allEditsAreFromUs;\n\t}\n\tpublic get diffInfo(): IObservable<IDocumentDiff> {\n\t\treturn this._textModelChangeService.diffInfo;\n\t}\n\tprivate readonly _maxModifiedLineNumber = observableValue<number>(this, 0);\n\treadonly maxModifiedLineNumber = this._maxModifiedLineNumber;\n\n\tprotected readonly _stateObs = observableValue<ModifiedFileEntryState>(this, ModifiedFileEntryState.Modified);\n\treadonly state: IObservable<ModifiedFileEntryState> = this._stateObs;\n\tprivate readonly initialContent: string;\n\tprivate readonly _textModelChangeService: ChatEditingTextModelChangeService;\n\tconstructor(\n\t\tpublic readonly notebookUri: URI,\n\t\tpublic readonly cell: NotebookCellTextModel,\n\t\tprivate readonly modifiedModel: ITextModel,\n\t\tprivate readonly originalModel: ITextModel,\n\t\tisExternalEditInProgress: (() => boolean) | undefined,\n\t\tdisposables: DisposableStore,\n\t\t@INotebookEditorService private readonly notebookEditorService: INotebookEditorService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis.initialContent = this.originalModel.getValue();\n\t\tthis._register(disposables);\n\t\tthis._textModelChangeService = this._register(this.instantiationService.createInstance(ChatEditingTextModelChangeService, this.originalModel, this.modifiedModel, this.state, isExternalEditInProgress));\n\n\t\tthis._register(this._textModelChangeService.onDidAcceptOrRejectAllHunks(action => {\n\t\t\tthis.revertMarkdownPreviewState();\n\t\t\tthis._stateObs.set(action, undefined);\n\t\t}));\n\n\t\tthis._register(this._textModelChangeService.onDidUserEditModel(() => {\n\t\t\tconst didResetToOriginalContent = this.modifiedModel.getValue() === this.initialContent;\n\t\t\tif (this._stateObs.get() === ModifiedFileEntryState.Modified && didResetToOriginalContent) {\n\t\t\t\tthis._stateObs.set(ModifiedFileEntryState.Rejected, undefined);\n\t\t\t}\n\t\t}));\n\n\t}\n\n\tpublic hasModificationAt(range: IRange): boolean {\n\t\treturn this._textModelChangeService.hasHunkAt(range);\n\t}\n\n\tpublic clearCurrentEditLineDecoration() {\n\t\tif (this.modifiedModel.isDisposed()) {\n\t\t\treturn;\n\t\t}\n\t\tthis._textModelChangeService.clearCurrentEditLineDecoration();\n\t}\n\n\tasync acceptAgentEdits(textEdits: TextEdit[], isLastEdits: boolean, responseModel: IChatResponseModel | undefined): Promise<void> {\n\t\tconst { maxLineNumber } = await this._textModelChangeService.acceptAgentEdits(this.modifiedModel.uri, textEdits, isLastEdits, responseModel);\n\n\t\ttransaction((tx) => {\n\t\t\tif (!isLastEdits) {\n\t\t\t\tthis._stateObs.set(ModifiedFileEntryState.Modified, tx);\n\t\t\t\tthis._maxModifiedLineNumber.set(maxLineNumber, tx);\n\n\t\t\t} else {\n\t\t\t\tthis._maxModifiedLineNumber.set(0, tx);\n\t\t\t}\n\t\t});\n\t}\n\n\trevertMarkdownPreviewState(): void {\n\t\tif (this.cell.cellKind !== CellKind.Markup) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst notebookEditor = this.notebookEditorService.retrieveExistingWidgetFromURI(this.notebookUri)?.value;\n\t\tif (notebookEditor) {\n\t\t\tconst vm = notebookEditor.getCellByHandle(this.cell.handle);\n\t\t\tif (vm?.getEditState() === CellEditState.Editing &&\n\t\t\t\t(vm.editStateSource === 'chatEdit' || vm.editStateSource === 'chatEditNavigation')) {\n\t\t\t\tvm?.updateEditState(CellEditState.Preview, 'chatEdit');\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic async keep(change: DetailedLineRangeMapping): Promise<boolean> {\n\t\treturn this._textModelChangeService.diffInfo.get().keep(change);\n\t}\n\n\tpublic async undo(change: DetailedLineRangeMapping): Promise<boolean> {\n\t\treturn this._textModelChangeService.diffInfo.get().undo(change);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable, DisposableStore } from '../../../../../../base/common/lifecycle.js';\nimport { IObservable, observableValue, transaction } from '../../../../../../base/common/observable.js';\nimport { URI } from '../../../../../../base/common/uri.js';\nimport { IRange } from '../../../../../../editor/common/core/range.js';\nimport { IDocumentDiff } from '../../../../../../editor/common/diff/documentDiffProvider.js';\nimport { DetailedLineRangeMapping } from '../../../../../../editor/common/diff/rangeMapping.js';\nimport { TextEdit } from '../../../../../../editor/common/languages.js';\nimport { ITextModel } from '../../../../../../editor/common/model.js';\nimport { IInstantiationService } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { CellEditState } from '../../../../notebook/browser/notebookBrowser.js';\nimport { INotebookEditorService } from '../../../../notebook/browser/services/notebookEditorService.js';\nimport { NotebookCellTextModel } from '../../../../notebook/common/model/notebookCellTextModel.js';\nimport { CellKind } from '../../../../notebook/common/notebookCommon.js';\nimport { ModifiedFileEntryState } from '../../../common/chatEditingService.js';\nimport { IChatResponseModel } from '../../../common/chatModel.js';\nimport { ChatEditingTextModelChangeService } from '../chatEditingTextModelChangeService.js';\n\n\n/**\n * This is very closely similar to the ChatEditingModifiedDocumentEntry class.\n * Most of the code has been borrowed from there, as a cell is effectively a document.\n * Hence most of the same functionality applies.\n */\nexport class ChatEditingNotebookCellEntry extends Disposable {\n\tpublic get isDisposed(): boolean {\n\t\treturn this._store.isDisposed;\n\t}\n\n\tpublic get isEditFromUs(): boolean {\n\t\treturn this._textModelChangeService.isEditFromUs;\n\t}\n\n\tpublic get allEditsAreFromUs(): boolean {\n\t\treturn this._textModelChangeService.allEditsAreFromUs;\n\t}\n\tpublic get diffInfo(): IObservable<IDocumentDiff> {\n\t\treturn this._textModelChangeService.diffInfo;\n\t}\n\tprivate readonly _maxModifiedLineNumber = observableValue<number>(this, 0);\n\treadonly maxModifiedLineNumber = this._maxModifiedLineNumber;\n\n\tprotected readonly _stateObs = observableValue<ModifiedFileEntryState>(this, ModifiedFileEntryState.Modified);\n\treadonly state: IObservable<ModifiedFileEntryState> = this._stateObs;\n\tprivate readonly initialContent: string;\n\tprivate readonly _textModelChangeService: ChatEditingTextModelChangeService;\n\tconstructor(\n\t\tpublic readonly notebookUri: URI,\n\t\tpublic readonly cell: NotebookCellTextModel,\n\t\tprivate readonly modifiedModel: ITextModel,\n\t\tprivate readonly originalModel: ITextModel,\n\t\tisExternalEditInProgress: (() => boolean) | undefined,\n\t\tdisposables: DisposableStore,\n\t\t@INotebookEditorService private readonly notebookEditorService: INotebookEditorService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis.initialContent = this.originalModel.getValue();\n\t\tthis._register(disposables);\n\t\tthis._textModelChangeService = this._register(this.instantiationService.createInstance(ChatEditingTextModelChangeService, this.originalModel, this.modifiedModel, this.state, isExternalEditInProgress));\n\n\t\tthis._register(this._textModelChangeService.onDidAcceptOrRejectAllHunks(action => {\n\t\t\tthis.revertMarkdownPreviewState();\n\t\t\tthis._stateObs.set(action, undefined);\n\t\t}));\n\n\t\tthis._register(this._textModelChangeService.onDidUserEditModel(() => {\n\t\t\tconst didResetToOriginalContent = this.modifiedModel.getValue() === this.initialContent;\n\t\t\tif (this._stateObs.get() === ModifiedFileEntryState.Modified && didResetToOriginalContent) {\n\t\t\t\tthis._stateObs.set(ModifiedFileEntryState.Rejected, undefined);\n\t\t\t}\n\t\t}));\n\n\t}\n\n\tpublic hasModificationAt(range: IRange): boolean {\n\t\treturn this._textModelChangeService.hasHunkAt(range);\n\t}\n\n\tpublic clearCurrentEditLineDecoration() {\n\t\tif (this.modifiedModel.isDisposed()) {\n\t\t\treturn;\n\t\t}\n\t\tthis._textModelChangeService.clearCurrentEditLineDecoration();\n\t}\n\n\tasync acceptAgentEdits(textEdits: TextEdit[], isLastEdits: boolean, responseModel: IChatResponseModel | undefined): Promise<void> {\n\t\tconst { maxLineNumber } = await this._textModelChangeService.acceptAgentEdits(this.modifiedModel.uri, textEdits, isLastEdits, responseModel);\n\n\t\ttransaction((tx) => {\n\t\t\tif (!isLastEdits) {\n\t\t\t\tthis._stateObs.set(ModifiedFileEntryState.Modified, tx);\n\t\t\t\tthis._maxModifiedLineNumber.set(maxLineNumber, tx);\n\n\t\t\t} else {\n\t\t\t\tthis._maxModifiedLineNumber.set(0, tx);\n\t\t\t}\n\t\t});\n\t}\n\n\trevertMarkdownPreviewState(): void {\n\t\tif (this.cell.cellKind !== CellKind.Markup) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst notebookEditor = this.notebookEditorService.retrieveExistingWidgetFromURI(this.notebookUri)?.value;\n\t\tif (notebookEditor) {\n\t\t\tconst vm = notebookEditor.getCellByHandle(this.cell.handle);\n\t\t\tif (vm?.getEditState() === CellEditState.Editing &&\n\t\t\t\t(vm.editStateSource === 'chatEdit' || vm.editStateSource === 'chatEditNavigation')) {\n\t\t\t\tvm?.updateEditState(CellEditState.Preview, 'chatEdit');\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic async keep(change: DetailedLineRangeMapping): Promise<boolean> {\n\t\treturn this._textModelChangeService.diffInfo.get().keep(change);\n\t}\n\n\tpublic async undo(change: DetailedLineRangeMapping): Promise<boolean> {\n\t\treturn this._textModelChangeService.diffInfo.get().undo(change);\n\t}\n}\n"]}