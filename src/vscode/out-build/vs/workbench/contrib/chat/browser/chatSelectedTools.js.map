{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/browser/chatSelectedTools.ts","vs/workbench/contrib/chat/browser/chatSelectedTools.ts"],"names":[],"mappings":"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","file":"chatSelectedTools.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { derived, IObservable, observableFromEvent, ObservableMap } from '../../../../base/common/observable.js';\nimport { isObject } from '../../../../base/common/types.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ObservableMemento, observableMemento } from '../../../../platform/observable/common/observableMemento.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { UserSelectedTools } from '../common/chatAgents.js';\nimport { IChatMode } from '../common/chatModes.js';\nimport { ChatModeKind } from '../common/constants.js';\nimport { ILanguageModelToolsService, IToolAndToolSetEnablementMap, IToolData, ToolSet } from '../common/languageModelToolsService.js';\nimport { PromptsStorage } from '../common/promptSyntax/service/promptsService.js';\nimport { PromptFileRewriter } from './promptSyntax/promptFileRewriter.js';\n\n\ntype ToolEnablementStates = {\n\treadonly toolSets: ReadonlyMap<string, boolean>;\n\treadonly tools: ReadonlyMap<string, boolean>;\n};\n\ntype StoredDataV2 = {\n\treadonly version: 2;\n\treadonly toolSetEntries: [string, boolean][];\n\treadonly toolEntries: [string, boolean][];\n};\n\ntype StoredDataV1 = {\n\treadonly version: undefined;\n\treadonly disabledToolSets?: string[];\n\treadonly disabledTools?: string[];\n};\n\nnamespace ToolEnablementStates {\n\texport function fromMap(map: IToolAndToolSetEnablementMap): ToolEnablementStates {\n\t\tconst toolSets: Map<string, boolean> = new Map(), tools: Map<string, boolean> = new Map();\n\t\tfor (const [entry, enabled] of map.entries()) {\n\t\t\tif (entry instanceof ToolSet) {\n\t\t\t\ttoolSets.set(entry.id, enabled);\n\t\t\t} else {\n\t\t\t\ttools.set(entry.id, enabled);\n\t\t\t}\n\t\t}\n\t\treturn { toolSets, tools };\n\t}\n\n\tfunction isStoredDataV1(data: StoredDataV1 | StoredDataV2 | undefined): data is StoredDataV1 {\n\t\treturn isObject(data) && data.version === undefined\n\t\t\t&& (data.disabledTools === undefined || Array.isArray(data.disabledTools))\n\t\t\t&& (data.disabledToolSets === undefined || Array.isArray(data.disabledToolSets));\n\t}\n\n\tfunction isStoredDataV2(data: StoredDataV1 | StoredDataV2 | undefined): data is StoredDataV2 {\n\t\treturn isObject(data) && data.version === 2 && Array.isArray(data.toolSetEntries) && Array.isArray(data.toolEntries);\n\t}\n\n\texport function fromStorage(storage: string): ToolEnablementStates {\n\t\ttry {\n\t\t\tconst parsed = JSON.parse(storage);\n\t\t\tif (isStoredDataV2(parsed)) {\n\t\t\t\treturn { toolSets: new Map(parsed.toolSetEntries), tools: new Map(parsed.toolEntries) };\n\t\t\t} else if (isStoredDataV1(parsed)) {\n\t\t\t\tconst toolSetEntries = parsed.disabledToolSets?.map(id => [id, false] as [string, boolean]);\n\t\t\t\tconst toolEntries = parsed.disabledTools?.map(id => [id, false] as [string, boolean]);\n\t\t\t\treturn { toolSets: new Map(toolSetEntries), tools: new Map(toolEntries) };\n\t\t\t}\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t\t// invalid data\n\t\treturn { toolSets: new Map(), tools: new Map() };\n\t}\n\n\texport function toStorage(state: ToolEnablementStates): string {\n\t\tconst storageData: StoredDataV2 = {\n\t\t\tversion: 2,\n\t\t\ttoolSetEntries: Array.from(state.toolSets.entries()),\n\t\t\ttoolEntries: Array.from(state.tools.entries())\n\t\t};\n\t\treturn JSON.stringify(storageData);\n\t}\n}\n\nexport enum ToolsScope {\n\tGlobal,\n\tSession,\n\tAgent,\n\tAgent_ReadOnly,\n}\n\nexport class ChatSelectedTools extends Disposable {\n\n\tprivate readonly _globalState: ObservableMemento<ToolEnablementStates>;\n\n\tprivate readonly _sessionStates = new ObservableMap<string, ToolEnablementStates | undefined>();\n\n\tprivate readonly _allTools: IObservable<Readonly<IToolData>[]>;\n\n\tconstructor(\n\t\tprivate readonly _mode: IObservable<IChatMode>,\n\t\t@ILanguageModelToolsService private readonly _toolsService: ILanguageModelToolsService,\n\t\t@IStorageService _storageService: IStorageService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tconst globalStateMemento = observableMemento<ToolEnablementStates>({\n\t\t\tkey: 'chat/selectedTools',\n\t\t\tdefaultValue: { toolSets: new Map(), tools: new Map() },\n\t\t\tfromStorage: ToolEnablementStates.fromStorage,\n\t\t\ttoStorage: ToolEnablementStates.toStorage\n\t\t});\n\n\t\tthis._globalState = this._store.add(globalStateMemento(StorageScope.PROFILE, StorageTarget.MACHINE, _storageService));\n\t\tthis._allTools = observableFromEvent(_toolsService.onDidChangeTools, () => Array.from(_toolsService.getTools()));\n\t}\n\n\t/**\n\t * All tools and tool sets with their enabled state.\n\t */\n\tpublic readonly entriesMap: IObservable<IToolAndToolSetEnablementMap> = derived(r => {\n\t\tconst map = new Map<IToolData | ToolSet, boolean>();\n\n\t\t// look up the tools in the hierarchy: session > mode > global\n\t\tconst currentMode = this._mode.read(r);\n\t\tlet currentMap = this._sessionStates.observable.read(r).get(currentMode.id);\n\t\tif (!currentMap && currentMode.kind === ChatModeKind.Agent) {\n\t\t\tconst modeTools = currentMode.customTools?.read(r);\n\t\t\tif (modeTools) {\n\t\t\t\tconst target = currentMode.target?.read(r);\n\t\t\t\tcurrentMap = ToolEnablementStates.fromMap(this._toolsService.toToolAndToolSetEnablementMap(modeTools, target));\n\t\t\t}\n\t\t}\n\t\tif (!currentMap) {\n\t\t\tcurrentMap = this._globalState.read(r);\n\t\t}\n\t\tfor (const tool of this._allTools.read(r)) {\n\t\t\tif (tool.canBeReferencedInPrompt) {\n\t\t\t\tmap.set(tool, currentMap.tools.get(tool.id) !== false); // if unknown, it's enabled\n\t\t\t}\n\t\t}\n\t\tfor (const toolSet of this._toolsService.toolSets.read(r)) {\n\t\t\tconst toolSetEnabled = currentMap.toolSets.get(toolSet.id) !== false; // if unknown, it's enabled\n\t\t\tmap.set(toolSet, toolSetEnabled);\n\t\t\tfor (const tool of toolSet.getTools(r)) {\n\t\t\t\tmap.set(tool, toolSetEnabled || currentMap.tools.get(tool.id) === true); // if unknown, use toolSetEnabled\n\t\t\t}\n\t\t}\n\t\treturn map;\n\t});\n\n\tpublic readonly userSelectedTools: IObservable<UserSelectedTools> = derived(r => {\n\t\t// extract a map of tool ids\n\t\tconst result: UserSelectedTools = {};\n\t\tconst map = this.entriesMap.read(r);\n\t\tfor (const [item, enabled] of map) {\n\t\t\tif (!(item instanceof ToolSet)) {\n\t\t\t\tresult[item.id] = enabled;\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t});\n\n\tget entriesScope() {\n\t\tconst mode = this._mode.get();\n\t\tif (this._sessionStates.has(mode.id)) {\n\t\t\treturn ToolsScope.Session;\n\t\t}\n\t\tif (mode.kind === ChatModeKind.Agent && mode.customTools?.get() && mode.uri) {\n\t\t\treturn mode.source?.storage !== PromptsStorage.extension ? ToolsScope.Agent : ToolsScope.Agent_ReadOnly;\n\t\t}\n\t\treturn ToolsScope.Global;\n\t}\n\n\tget currentMode(): IChatMode {\n\t\treturn this._mode.get();\n\t}\n\n\tresetSessionEnablementState() {\n\t\tconst mode = this._mode.get();\n\t\tthis._sessionStates.delete(mode.id);\n\t}\n\n\tset(enablementMap: IToolAndToolSetEnablementMap, sessionOnly: boolean): void {\n\t\tconst mode = this._mode.get();\n\t\tif (sessionOnly || this._sessionStates.has(mode.id)) {\n\t\t\tthis._sessionStates.set(mode.id, ToolEnablementStates.fromMap(enablementMap));\n\t\t\treturn;\n\t\t}\n\t\tif (mode.kind === ChatModeKind.Agent && mode.customTools?.get() && mode.uri) {\n\t\t\tif (mode.source?.storage !== PromptsStorage.extension) {\n\t\t\t\t// apply directly to mode file.\n\t\t\t\tthis.updateCustomModeTools(mode.uri.get(), enablementMap);\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\t// can not write to extensions, store\n\t\t\t\tthis._sessionStates.set(mode.id, ToolEnablementStates.fromMap(enablementMap));\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tthis._globalState.set(ToolEnablementStates.fromMap(enablementMap), undefined);\n\t}\n\n\tprivate async updateCustomModeTools(uri: URI, enablementMap: IToolAndToolSetEnablementMap): Promise<void> {\n\t\tawait this._instantiationService.createInstance(PromptFileRewriter).openAndRewriteTools(uri, enablementMap, CancellationToken.None);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { derived, IObservable, observableFromEvent, ObservableMap } from '../../../../base/common/observable.js';\nimport { isObject } from '../../../../base/common/types.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ObservableMemento, observableMemento } from '../../../../platform/observable/common/observableMemento.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { UserSelectedTools } from '../common/chatAgents.js';\nimport { IChatMode } from '../common/chatModes.js';\nimport { ChatModeKind } from '../common/constants.js';\nimport { ILanguageModelToolsService, IToolAndToolSetEnablementMap, IToolData, ToolSet } from '../common/languageModelToolsService.js';\nimport { PromptsStorage } from '../common/promptSyntax/service/promptsService.js';\nimport { PromptFileRewriter } from './promptSyntax/promptFileRewriter.js';\n\n\ntype ToolEnablementStates = {\n\treadonly toolSets: ReadonlyMap<string, boolean>;\n\treadonly tools: ReadonlyMap<string, boolean>;\n};\n\ntype StoredDataV2 = {\n\treadonly version: 2;\n\treadonly toolSetEntries: [string, boolean][];\n\treadonly toolEntries: [string, boolean][];\n};\n\ntype StoredDataV1 = {\n\treadonly version: undefined;\n\treadonly disabledToolSets?: string[];\n\treadonly disabledTools?: string[];\n};\n\nnamespace ToolEnablementStates {\n\texport function fromMap(map: IToolAndToolSetEnablementMap): ToolEnablementStates {\n\t\tconst toolSets: Map<string, boolean> = new Map(), tools: Map<string, boolean> = new Map();\n\t\tfor (const [entry, enabled] of map.entries()) {\n\t\t\tif (entry instanceof ToolSet) {\n\t\t\t\ttoolSets.set(entry.id, enabled);\n\t\t\t} else {\n\t\t\t\ttools.set(entry.id, enabled);\n\t\t\t}\n\t\t}\n\t\treturn { toolSets, tools };\n\t}\n\n\tfunction isStoredDataV1(data: StoredDataV1 | StoredDataV2 | undefined): data is StoredDataV1 {\n\t\treturn isObject(data) && data.version === undefined\n\t\t\t&& (data.disabledTools === undefined || Array.isArray(data.disabledTools))\n\t\t\t&& (data.disabledToolSets === undefined || Array.isArray(data.disabledToolSets));\n\t}\n\n\tfunction isStoredDataV2(data: StoredDataV1 | StoredDataV2 | undefined): data is StoredDataV2 {\n\t\treturn isObject(data) && data.version === 2 && Array.isArray(data.toolSetEntries) && Array.isArray(data.toolEntries);\n\t}\n\n\texport function fromStorage(storage: string): ToolEnablementStates {\n\t\ttry {\n\t\t\tconst parsed = JSON.parse(storage);\n\t\t\tif (isStoredDataV2(parsed)) {\n\t\t\t\treturn { toolSets: new Map(parsed.toolSetEntries), tools: new Map(parsed.toolEntries) };\n\t\t\t} else if (isStoredDataV1(parsed)) {\n\t\t\t\tconst toolSetEntries = parsed.disabledToolSets?.map(id => [id, false] as [string, boolean]);\n\t\t\t\tconst toolEntries = parsed.disabledTools?.map(id => [id, false] as [string, boolean]);\n\t\t\t\treturn { toolSets: new Map(toolSetEntries), tools: new Map(toolEntries) };\n\t\t\t}\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t\t// invalid data\n\t\treturn { toolSets: new Map(), tools: new Map() };\n\t}\n\n\texport function toStorage(state: ToolEnablementStates): string {\n\t\tconst storageData: StoredDataV2 = {\n\t\t\tversion: 2,\n\t\t\ttoolSetEntries: Array.from(state.toolSets.entries()),\n\t\t\ttoolEntries: Array.from(state.tools.entries())\n\t\t};\n\t\treturn JSON.stringify(storageData);\n\t}\n}\n\nexport enum ToolsScope {\n\tGlobal,\n\tSession,\n\tAgent,\n\tAgent_ReadOnly,\n}\n\nexport class ChatSelectedTools extends Disposable {\n\n\tprivate readonly _globalState: ObservableMemento<ToolEnablementStates>;\n\n\tprivate readonly _sessionStates = new ObservableMap<string, ToolEnablementStates | undefined>();\n\n\tprivate readonly _allTools: IObservable<Readonly<IToolData>[]>;\n\n\tconstructor(\n\t\tprivate readonly _mode: IObservable<IChatMode>,\n\t\t@ILanguageModelToolsService private readonly _toolsService: ILanguageModelToolsService,\n\t\t@IStorageService _storageService: IStorageService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tconst globalStateMemento = observableMemento<ToolEnablementStates>({\n\t\t\tkey: 'chat/selectedTools',\n\t\t\tdefaultValue: { toolSets: new Map(), tools: new Map() },\n\t\t\tfromStorage: ToolEnablementStates.fromStorage,\n\t\t\ttoStorage: ToolEnablementStates.toStorage\n\t\t});\n\n\t\tthis._globalState = this._store.add(globalStateMemento(StorageScope.PROFILE, StorageTarget.MACHINE, _storageService));\n\t\tthis._allTools = observableFromEvent(_toolsService.onDidChangeTools, () => Array.from(_toolsService.getTools()));\n\t}\n\n\t/**\n\t * All tools and tool sets with their enabled state.\n\t */\n\tpublic readonly entriesMap: IObservable<IToolAndToolSetEnablementMap> = derived(r => {\n\t\tconst map = new Map<IToolData | ToolSet, boolean>();\n\n\t\t// look up the tools in the hierarchy: session > mode > global\n\t\tconst currentMode = this._mode.read(r);\n\t\tlet currentMap = this._sessionStates.observable.read(r).get(currentMode.id);\n\t\tif (!currentMap && currentMode.kind === ChatModeKind.Agent) {\n\t\t\tconst modeTools = currentMode.customTools?.read(r);\n\t\t\tif (modeTools) {\n\t\t\t\tconst target = currentMode.target?.read(r);\n\t\t\t\tcurrentMap = ToolEnablementStates.fromMap(this._toolsService.toToolAndToolSetEnablementMap(modeTools, target));\n\t\t\t}\n\t\t}\n\t\tif (!currentMap) {\n\t\t\tcurrentMap = this._globalState.read(r);\n\t\t}\n\t\tfor (const tool of this._allTools.read(r)) {\n\t\t\tif (tool.canBeReferencedInPrompt) {\n\t\t\t\tmap.set(tool, currentMap.tools.get(tool.id) !== false); // if unknown, it's enabled\n\t\t\t}\n\t\t}\n\t\tfor (const toolSet of this._toolsService.toolSets.read(r)) {\n\t\t\tconst toolSetEnabled = currentMap.toolSets.get(toolSet.id) !== false; // if unknown, it's enabled\n\t\t\tmap.set(toolSet, toolSetEnabled);\n\t\t\tfor (const tool of toolSet.getTools(r)) {\n\t\t\t\tmap.set(tool, toolSetEnabled || currentMap.tools.get(tool.id) === true); // if unknown, use toolSetEnabled\n\t\t\t}\n\t\t}\n\t\treturn map;\n\t});\n\n\tpublic readonly userSelectedTools: IObservable<UserSelectedTools> = derived(r => {\n\t\t// extract a map of tool ids\n\t\tconst result: UserSelectedTools = {};\n\t\tconst map = this.entriesMap.read(r);\n\t\tfor (const [item, enabled] of map) {\n\t\t\tif (!(item instanceof ToolSet)) {\n\t\t\t\tresult[item.id] = enabled;\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t});\n\n\tget entriesScope() {\n\t\tconst mode = this._mode.get();\n\t\tif (this._sessionStates.has(mode.id)) {\n\t\t\treturn ToolsScope.Session;\n\t\t}\n\t\tif (mode.kind === ChatModeKind.Agent && mode.customTools?.get() && mode.uri) {\n\t\t\treturn mode.source?.storage !== PromptsStorage.extension ? ToolsScope.Agent : ToolsScope.Agent_ReadOnly;\n\t\t}\n\t\treturn ToolsScope.Global;\n\t}\n\n\tget currentMode(): IChatMode {\n\t\treturn this._mode.get();\n\t}\n\n\tresetSessionEnablementState() {\n\t\tconst mode = this._mode.get();\n\t\tthis._sessionStates.delete(mode.id);\n\t}\n\n\tset(enablementMap: IToolAndToolSetEnablementMap, sessionOnly: boolean): void {\n\t\tconst mode = this._mode.get();\n\t\tif (sessionOnly || this._sessionStates.has(mode.id)) {\n\t\t\tthis._sessionStates.set(mode.id, ToolEnablementStates.fromMap(enablementMap));\n\t\t\treturn;\n\t\t}\n\t\tif (mode.kind === ChatModeKind.Agent && mode.customTools?.get() && mode.uri) {\n\t\t\tif (mode.source?.storage !== PromptsStorage.extension) {\n\t\t\t\t// apply directly to mode file.\n\t\t\t\tthis.updateCustomModeTools(mode.uri.get(), enablementMap);\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\t// can not write to extensions, store\n\t\t\t\tthis._sessionStates.set(mode.id, ToolEnablementStates.fromMap(enablementMap));\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tthis._globalState.set(ToolEnablementStates.fromMap(enablementMap), undefined);\n\t}\n\n\tprivate async updateCustomModeTools(uri: URI, enablementMap: IToolAndToolSetEnablementMap): Promise<void> {\n\t\tawait this._instantiationService.createInstance(PromptFileRewriter).openAndRewriteTools(uri, enablementMap, CancellationToken.None);\n\t}\n}\n"]}