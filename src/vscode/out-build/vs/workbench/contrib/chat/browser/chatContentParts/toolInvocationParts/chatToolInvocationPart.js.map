{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolInvocationPart.ts","vs/workbench/contrib/chat/browser/chatContentParts/toolInvocationParts/chatToolInvocationPart.ts"],"names":[],"mappings":"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","file":"chatToolInvocationPart.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from '../../../../../../base/browser/dom.js';\nimport { Emitter } from '../../../../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../../../../base/common/lifecycle.js';\nimport { autorun } from '../../../../../../base/common/observable.js';\nimport { IInstantiationService } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { IMarkdownRenderer } from '../../../../../../platform/markdown/browser/markdownRenderer.js';\nimport { IChatToolInvocation, IChatToolInvocationSerialized } from '../../../common/chatService.js';\nimport { IChatRendererContent } from '../../../common/chatViewModel.js';\nimport { CodeBlockModelCollection } from '../../../common/codeBlockModelCollection.js';\nimport { isToolResultInputOutputDetails, isToolResultOutputDetails, ToolInvocationPresentation } from '../../../common/languageModelToolsService.js';\nimport { ChatTreeItem, IChatCodeBlockInfo } from '../../chat.js';\nimport { EditorPool } from '../chatContentCodePools.js';\nimport { IChatContentPart, IChatContentPartRenderContext } from '../chatContentParts.js';\nimport { CollapsibleListPool } from '../chatReferencesContentPart.js';\nimport { ExtensionsInstallConfirmationWidgetSubPart } from './chatExtensionsInstallToolSubPart.js';\nimport { ChatInputOutputMarkdownProgressPart } from './chatInputOutputMarkdownProgressPart.js';\nimport { ChatResultListSubPart } from './chatResultListSubPart.js';\nimport { ChatTerminalToolConfirmationSubPart } from './chatTerminalToolConfirmationSubPart.js';\nimport { ChatTerminalToolProgressPart } from './chatTerminalToolProgressPart.js';\nimport { ToolConfirmationSubPart } from './chatToolConfirmationSubPart.js';\nimport { BaseChatToolInvocationSubPart } from './chatToolInvocationSubPart.js';\nimport { ChatToolOutputSubPart } from './chatToolOutputPart.js';\nimport { ChatToolPostExecuteConfirmationPart } from './chatToolPostExecuteConfirmationPart.js';\nimport { ChatToolProgressSubPart } from './chatToolProgressPart.js';\n\nexport class ChatToolInvocationPart extends Disposable implements IChatContentPart {\n\tpublic readonly domNode: HTMLElement;\n\n\tprivate _onDidChangeHeight = this._register(new Emitter<void>());\n\tpublic readonly onDidChangeHeight = this._onDidChangeHeight.event;\n\n\tpublic get codeblocks(): IChatCodeBlockInfo[] {\n\t\treturn this.subPart?.codeblocks ?? [];\n\t}\n\n\tpublic get codeblocksPartId(): string | undefined {\n\t\treturn this.subPart?.codeblocksPartId;\n\t}\n\n\tprivate subPart!: BaseChatToolInvocationSubPart;\n\n\tconstructor(\n\t\tprivate readonly toolInvocation: IChatToolInvocation | IChatToolInvocationSerialized,\n\t\tprivate readonly context: IChatContentPartRenderContext,\n\t\tprivate readonly renderer: IMarkdownRenderer,\n\t\tprivate readonly listPool: CollapsibleListPool,\n\t\tprivate readonly editorPool: EditorPool,\n\t\tprivate readonly currentWidthDelegate: () => number,\n\t\tprivate readonly codeBlockModelCollection: CodeBlockModelCollection,\n\t\tprivate readonly announcedToolProgressKeys: Set<string> | undefined,\n\t\tprivate readonly codeBlockStartIndex: number,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tthis.domNode = dom.$('.chat-tool-invocation-part');\n\t\tif (toolInvocation.fromSubAgent) {\n\t\t\tthis.domNode.classList.add('from-sub-agent');\n\t\t}\n\t\tif (toolInvocation.presentation === 'hidden') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (toolInvocation.kind === 'toolInvocation') {\n\t\t\tconst initialState = toolInvocation.state.get().type;\n\t\t\tthis._register(autorun(reader => {\n\t\t\t\tif (toolInvocation.state.read(reader).type !== initialState) {\n\t\t\t\t\trender();\n\t\t\t\t}\n\t\t\t}));\n\t\t}\n\n\t\t// This part is a bit different, since IChatToolInvocation is not an immutable model object. So this part is able to rerender itself.\n\t\t// If this turns out to be a typical pattern, we could come up with a more reusable pattern, like telling the list to rerender an element\n\t\t// when the model changes, or trying to make the model immutable and swap out one content part for a new one based on user actions in the view.\n\t\tconst partStore = this._register(new DisposableStore());\n\t\tconst render = () => {\n\t\t\tdom.clearNode(this.domNode);\n\t\t\tpartStore.clear();\n\n\t\t\tif (toolInvocation.presentation === ToolInvocationPresentation.HiddenAfterComplete && IChatToolInvocation.isComplete(toolInvocation)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.subPart = partStore.add(this.createToolInvocationSubPart());\n\t\t\tthis.domNode.appendChild(this.subPart.domNode);\n\t\t\tpartStore.add(this.subPart.onDidChangeHeight(() => this._onDidChangeHeight.fire()));\n\t\t\tpartStore.add(this.subPart.onNeedsRerender(render));\n\n\t\t\tthis._onDidChangeHeight.fire();\n\t\t};\n\t\trender();\n\t}\n\n\tprivate createToolInvocationSubPart(): BaseChatToolInvocationSubPart {\n\t\tif (this.toolInvocation.kind === 'toolInvocation') {\n\t\t\tif (this.toolInvocation.toolSpecificData?.kind === 'extensions') {\n\t\t\t\treturn this.instantiationService.createInstance(ExtensionsInstallConfirmationWidgetSubPart, this.toolInvocation, this.context);\n\t\t\t}\n\t\t\tconst state = this.toolInvocation.state.get();\n\t\t\tif (state.type === IChatToolInvocation.StateKind.WaitingForConfirmation) {\n\t\t\t\tif (this.toolInvocation.toolSpecificData?.kind === 'terminal') {\n\t\t\t\t\treturn this.instantiationService.createInstance(ChatTerminalToolConfirmationSubPart, this.toolInvocation, this.toolInvocation.toolSpecificData, this.context, this.renderer, this.editorPool, this.currentWidthDelegate, this.codeBlockModelCollection, this.codeBlockStartIndex);\n\t\t\t\t} else {\n\t\t\t\t\treturn this.instantiationService.createInstance(ToolConfirmationSubPart, this.toolInvocation, this.context, this.renderer, this.editorPool, this.currentWidthDelegate, this.codeBlockModelCollection, this.codeBlockStartIndex);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (state.type === IChatToolInvocation.StateKind.WaitingForPostApproval) {\n\t\t\t\treturn this.instantiationService.createInstance(ChatToolPostExecuteConfirmationPart, this.toolInvocation, this.context);\n\t\t\t}\n\t\t}\n\n\t\tif (this.toolInvocation.toolSpecificData?.kind === 'terminal') {\n\t\t\treturn this.instantiationService.createInstance(ChatTerminalToolProgressPart, this.toolInvocation, this.toolInvocation.toolSpecificData, this.context, this.renderer, this.editorPool, this.currentWidthDelegate, this.codeBlockStartIndex, this.codeBlockModelCollection);\n\t\t}\n\n\t\tconst resultDetails = IChatToolInvocation.resultDetails(this.toolInvocation);\n\t\tif (Array.isArray(resultDetails) && resultDetails.length) {\n\t\t\treturn this.instantiationService.createInstance(ChatResultListSubPart, this.toolInvocation, this.context, this.toolInvocation.pastTenseMessage ?? this.toolInvocation.invocationMessage, resultDetails, this.listPool);\n\t\t}\n\n\t\tif (isToolResultOutputDetails(resultDetails)) {\n\t\t\treturn this.instantiationService.createInstance(ChatToolOutputSubPart, this.toolInvocation, this.context);\n\t\t}\n\n\t\tif (isToolResultInputOutputDetails(resultDetails)) {\n\t\t\treturn this.instantiationService.createInstance(\n\t\t\t\tChatInputOutputMarkdownProgressPart,\n\t\t\t\tthis.toolInvocation,\n\t\t\t\tthis.context,\n\t\t\t\tthis.codeBlockStartIndex,\n\t\t\t\tthis.toolInvocation.pastTenseMessage ?? this.toolInvocation.invocationMessage,\n\t\t\t\tthis.toolInvocation.originMessage,\n\t\t\t\tresultDetails.input,\n\t\t\t\tresultDetails.output,\n\t\t\t\t!!resultDetails.isError,\n\t\t\t);\n\t\t}\n\n\t\tif (this.toolInvocation.kind === 'toolInvocation' && this.toolInvocation.toolSpecificData?.kind === 'input' && !IChatToolInvocation.isComplete(this.toolInvocation)) {\n\t\t\treturn this.instantiationService.createInstance(\n\t\t\t\tChatInputOutputMarkdownProgressPart,\n\t\t\t\tthis.toolInvocation,\n\t\t\t\tthis.context,\n\t\t\t\tthis.codeBlockStartIndex,\n\t\t\t\tthis.toolInvocation.invocationMessage,\n\t\t\t\tthis.toolInvocation.originMessage,\n\t\t\t\ttypeof this.toolInvocation.toolSpecificData.rawInput === 'string' ? this.toolInvocation.toolSpecificData.rawInput : JSON.stringify(this.toolInvocation.toolSpecificData.rawInput, null, 2),\n\t\t\t\tundefined,\n\t\t\t\tfalse,\n\t\t\t);\n\t\t}\n\n\t\treturn this.instantiationService.createInstance(ChatToolProgressSubPart, this.toolInvocation, this.context, this.renderer, this.announcedToolProgressKeys);\n\t}\n\n\thasSameContent(other: IChatRendererContent, followingContent: IChatRendererContent[], element: ChatTreeItem): boolean {\n\t\treturn (other.kind === 'toolInvocation' || other.kind === 'toolInvocationSerialized') && this.toolInvocation.toolCallId === other.toolCallId;\n\t}\n\n\taddDisposable(disposable: IDisposable): void {\n\t\tthis._register(disposable);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from '../../../../../../base/browser/dom.js';\nimport { Emitter } from '../../../../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable } from '../../../../../../base/common/lifecycle.js';\nimport { autorun } from '../../../../../../base/common/observable.js';\nimport { IInstantiationService } from '../../../../../../platform/instantiation/common/instantiation.js';\nimport { IMarkdownRenderer } from '../../../../../../platform/markdown/browser/markdownRenderer.js';\nimport { IChatToolInvocation, IChatToolInvocationSerialized } from '../../../common/chatService.js';\nimport { IChatRendererContent } from '../../../common/chatViewModel.js';\nimport { CodeBlockModelCollection } from '../../../common/codeBlockModelCollection.js';\nimport { isToolResultInputOutputDetails, isToolResultOutputDetails, ToolInvocationPresentation } from '../../../common/languageModelToolsService.js';\nimport { ChatTreeItem, IChatCodeBlockInfo } from '../../chat.js';\nimport { EditorPool } from '../chatContentCodePools.js';\nimport { IChatContentPart, IChatContentPartRenderContext } from '../chatContentParts.js';\nimport { CollapsibleListPool } from '../chatReferencesContentPart.js';\nimport { ExtensionsInstallConfirmationWidgetSubPart } from './chatExtensionsInstallToolSubPart.js';\nimport { ChatInputOutputMarkdownProgressPart } from './chatInputOutputMarkdownProgressPart.js';\nimport { ChatResultListSubPart } from './chatResultListSubPart.js';\nimport { ChatTerminalToolConfirmationSubPart } from './chatTerminalToolConfirmationSubPart.js';\nimport { ChatTerminalToolProgressPart } from './chatTerminalToolProgressPart.js';\nimport { ToolConfirmationSubPart } from './chatToolConfirmationSubPart.js';\nimport { BaseChatToolInvocationSubPart } from './chatToolInvocationSubPart.js';\nimport { ChatToolOutputSubPart } from './chatToolOutputPart.js';\nimport { ChatToolPostExecuteConfirmationPart } from './chatToolPostExecuteConfirmationPart.js';\nimport { ChatToolProgressSubPart } from './chatToolProgressPart.js';\n\nexport class ChatToolInvocationPart extends Disposable implements IChatContentPart {\n\tpublic readonly domNode: HTMLElement;\n\n\tprivate _onDidChangeHeight = this._register(new Emitter<void>());\n\tpublic readonly onDidChangeHeight = this._onDidChangeHeight.event;\n\n\tpublic get codeblocks(): IChatCodeBlockInfo[] {\n\t\treturn this.subPart?.codeblocks ?? [];\n\t}\n\n\tpublic get codeblocksPartId(): string | undefined {\n\t\treturn this.subPart?.codeblocksPartId;\n\t}\n\n\tprivate subPart!: BaseChatToolInvocationSubPart;\n\n\tconstructor(\n\t\tprivate readonly toolInvocation: IChatToolInvocation | IChatToolInvocationSerialized,\n\t\tprivate readonly context: IChatContentPartRenderContext,\n\t\tprivate readonly renderer: IMarkdownRenderer,\n\t\tprivate readonly listPool: CollapsibleListPool,\n\t\tprivate readonly editorPool: EditorPool,\n\t\tprivate readonly currentWidthDelegate: () => number,\n\t\tprivate readonly codeBlockModelCollection: CodeBlockModelCollection,\n\t\tprivate readonly announcedToolProgressKeys: Set<string> | undefined,\n\t\tprivate readonly codeBlockStartIndex: number,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tthis.domNode = dom.$('.chat-tool-invocation-part');\n\t\tif (toolInvocation.fromSubAgent) {\n\t\t\tthis.domNode.classList.add('from-sub-agent');\n\t\t}\n\t\tif (toolInvocation.presentation === 'hidden') {\n\t\t\treturn;\n\t\t}\n\n\t\tif (toolInvocation.kind === 'toolInvocation') {\n\t\t\tconst initialState = toolInvocation.state.get().type;\n\t\t\tthis._register(autorun(reader => {\n\t\t\t\tif (toolInvocation.state.read(reader).type !== initialState) {\n\t\t\t\t\trender();\n\t\t\t\t}\n\t\t\t}));\n\t\t}\n\n\t\t// This part is a bit different, since IChatToolInvocation is not an immutable model object. So this part is able to rerender itself.\n\t\t// If this turns out to be a typical pattern, we could come up with a more reusable pattern, like telling the list to rerender an element\n\t\t// when the model changes, or trying to make the model immutable and swap out one content part for a new one based on user actions in the view.\n\t\tconst partStore = this._register(new DisposableStore());\n\t\tconst render = () => {\n\t\t\tdom.clearNode(this.domNode);\n\t\t\tpartStore.clear();\n\n\t\t\tif (toolInvocation.presentation === ToolInvocationPresentation.HiddenAfterComplete && IChatToolInvocation.isComplete(toolInvocation)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.subPart = partStore.add(this.createToolInvocationSubPart());\n\t\t\tthis.domNode.appendChild(this.subPart.domNode);\n\t\t\tpartStore.add(this.subPart.onDidChangeHeight(() => this._onDidChangeHeight.fire()));\n\t\t\tpartStore.add(this.subPart.onNeedsRerender(render));\n\n\t\t\tthis._onDidChangeHeight.fire();\n\t\t};\n\t\trender();\n\t}\n\n\tprivate createToolInvocationSubPart(): BaseChatToolInvocationSubPart {\n\t\tif (this.toolInvocation.kind === 'toolInvocation') {\n\t\t\tif (this.toolInvocation.toolSpecificData?.kind === 'extensions') {\n\t\t\t\treturn this.instantiationService.createInstance(ExtensionsInstallConfirmationWidgetSubPart, this.toolInvocation, this.context);\n\t\t\t}\n\t\t\tconst state = this.toolInvocation.state.get();\n\t\t\tif (state.type === IChatToolInvocation.StateKind.WaitingForConfirmation) {\n\t\t\t\tif (this.toolInvocation.toolSpecificData?.kind === 'terminal') {\n\t\t\t\t\treturn this.instantiationService.createInstance(ChatTerminalToolConfirmationSubPart, this.toolInvocation, this.toolInvocation.toolSpecificData, this.context, this.renderer, this.editorPool, this.currentWidthDelegate, this.codeBlockModelCollection, this.codeBlockStartIndex);\n\t\t\t\t} else {\n\t\t\t\t\treturn this.instantiationService.createInstance(ToolConfirmationSubPart, this.toolInvocation, this.context, this.renderer, this.editorPool, this.currentWidthDelegate, this.codeBlockModelCollection, this.codeBlockStartIndex);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (state.type === IChatToolInvocation.StateKind.WaitingForPostApproval) {\n\t\t\t\treturn this.instantiationService.createInstance(ChatToolPostExecuteConfirmationPart, this.toolInvocation, this.context);\n\t\t\t}\n\t\t}\n\n\t\tif (this.toolInvocation.toolSpecificData?.kind === 'terminal') {\n\t\t\treturn this.instantiationService.createInstance(ChatTerminalToolProgressPart, this.toolInvocation, this.toolInvocation.toolSpecificData, this.context, this.renderer, this.editorPool, this.currentWidthDelegate, this.codeBlockStartIndex, this.codeBlockModelCollection);\n\t\t}\n\n\t\tconst resultDetails = IChatToolInvocation.resultDetails(this.toolInvocation);\n\t\tif (Array.isArray(resultDetails) && resultDetails.length) {\n\t\t\treturn this.instantiationService.createInstance(ChatResultListSubPart, this.toolInvocation, this.context, this.toolInvocation.pastTenseMessage ?? this.toolInvocation.invocationMessage, resultDetails, this.listPool);\n\t\t}\n\n\t\tif (isToolResultOutputDetails(resultDetails)) {\n\t\t\treturn this.instantiationService.createInstance(ChatToolOutputSubPart, this.toolInvocation, this.context);\n\t\t}\n\n\t\tif (isToolResultInputOutputDetails(resultDetails)) {\n\t\t\treturn this.instantiationService.createInstance(\n\t\t\t\tChatInputOutputMarkdownProgressPart,\n\t\t\t\tthis.toolInvocation,\n\t\t\t\tthis.context,\n\t\t\t\tthis.codeBlockStartIndex,\n\t\t\t\tthis.toolInvocation.pastTenseMessage ?? this.toolInvocation.invocationMessage,\n\t\t\t\tthis.toolInvocation.originMessage,\n\t\t\t\tresultDetails.input,\n\t\t\t\tresultDetails.output,\n\t\t\t\t!!resultDetails.isError,\n\t\t\t);\n\t\t}\n\n\t\tif (this.toolInvocation.kind === 'toolInvocation' && this.toolInvocation.toolSpecificData?.kind === 'input' && !IChatToolInvocation.isComplete(this.toolInvocation)) {\n\t\t\treturn this.instantiationService.createInstance(\n\t\t\t\tChatInputOutputMarkdownProgressPart,\n\t\t\t\tthis.toolInvocation,\n\t\t\t\tthis.context,\n\t\t\t\tthis.codeBlockStartIndex,\n\t\t\t\tthis.toolInvocation.invocationMessage,\n\t\t\t\tthis.toolInvocation.originMessage,\n\t\t\t\ttypeof this.toolInvocation.toolSpecificData.rawInput === 'string' ? this.toolInvocation.toolSpecificData.rawInput : JSON.stringify(this.toolInvocation.toolSpecificData.rawInput, null, 2),\n\t\t\t\tundefined,\n\t\t\t\tfalse,\n\t\t\t);\n\t\t}\n\n\t\treturn this.instantiationService.createInstance(ChatToolProgressSubPart, this.toolInvocation, this.context, this.renderer, this.announcedToolProgressKeys);\n\t}\n\n\thasSameContent(other: IChatRendererContent, followingContent: IChatRendererContent[], element: ChatTreeItem): boolean {\n\t\treturn (other.kind === 'toolInvocation' || other.kind === 'toolInvocationSerialized') && this.toolInvocation.toolCallId === other.toolCallId;\n\t}\n\n\taddDisposable(disposable: IDisposable): void {\n\t\tthis._register(disposable);\n\t}\n}\n"]}