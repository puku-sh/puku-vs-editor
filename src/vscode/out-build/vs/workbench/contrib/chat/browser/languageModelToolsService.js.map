{"version":3,"sources":["vs/workbench/contrib/chat/browser/languageModelToolsService.ts"],"names":[],"mappings":"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","file":"languageModelToolsService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { renderAsPlaintext } from '../../../../base/browser/markdownRenderer.js';\nimport { assertNever } from '../../../../base/common/assert.js';\nimport { RunOnceScheduler, timeout } from '../../../../base/common/async.js';\nimport { encodeBase64 } from '../../../../base/common/buffer.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { Codicon } from '../../../../base/common/codicons.js';\nimport { toErrorMessage } from '../../../../base/common/errorMessage.js';\nimport { CancellationError, isCancellationError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { createMarkdownCommandLink, MarkdownString } from '../../../../base/common/htmlContent.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { combinedDisposable, Disposable, DisposableStore, IDisposable, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { IObservable, ObservableSet } from '../../../../base/common/observable.js';\nimport Severity from '../../../../base/common/severity.js';\nimport { StopWatch } from '../../../../base/common/stopwatch.js';\nimport { ThemeIcon } from '../../../../base/common/themables.js';\nimport { localize, localize2 } from '../../../../nls.js';\nimport { IAccessibilityService } from '../../../../platform/accessibility/common/accessibility.js';\nimport { AccessibilitySignal, IAccessibilitySignalService } from '../../../../platform/accessibilitySignal/browser/accessibilitySignalService.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport * as JSONContributionRegistry from '../../../../platform/jsonschemas/common/jsonContributionRegistry.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { Registry } from '../../../../platform/registry/common/platform.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IExtensionService } from '../../../services/extensions/common/extensions.js';\nimport { ChatContextKeys } from '../common/chatContextKeys.js';\nimport { IVariableReference } from '../common/chatModes.js';\nimport { ChatToolInvocation } from '../common/chatProgressTypes/chatToolInvocation.js';\nimport { ConfirmedReason, IChatService, IChatToolInvocation, ToolConfirmKind } from '../common/chatService.js';\nimport { ChatRequestToolReferenceEntry, toToolSetVariableEntry, toToolVariableEntry } from '../common/chatVariableEntries.js';\nimport { ChatConfiguration } from '../common/constants.js';\nimport { ILanguageModelToolsConfirmationService } from '../common/languageModelToolsConfirmationService.js';\nimport { CountTokensCallback, createToolSchemaUri, GithubCopilotToolReference, ILanguageModelToolsService, IPreparedToolInvocation, IToolAndToolSetEnablementMap, IToolData, IToolImpl, IToolInvocation, IToolResult, IToolResultInputOutputDetails, stringifyPromptTsxPart, ToolDataSource, ToolSet, VSCodeToolReference } from '../common/languageModelToolsService.js';\nimport { Target } from '../common/promptSyntax/promptFileParser.js';\nimport { getToolConfirmationAlert } from './chatAccessibilityProvider.js';\n\nconst jsonSchemaRegistry = Registry.as<JSONContributionRegistry.IJSONContributionRegistry>(JSONContributionRegistry.Extensions.JSONContribution);\n\ninterface IToolEntry {\n\tdata: IToolData;\n\timpl?: IToolImpl;\n}\n\ninterface ITrackedCall {\n\tinvocation?: ChatToolInvocation;\n\tstore: IDisposable;\n}\n\nconst enum AutoApproveStorageKeys {\n\tGlobalAutoApproveOptIn = 'chat.tools.global.autoApprove.optIn'\n}\n\nconst SkipAutoApproveConfirmationKey = 'vscode.chat.tools.global.autoApprove.testMode';\n\nexport const globalAutoApproveDescription = localize2(\n\t{\n\t\tkey: 'autoApprove2.markdown',\n\t\tcomment: [\n\t\t\t'{Locked=\\'](https://github.com/features/codespaces)\\'}',\n\t\t\t'{Locked=\\'](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers)\\'}',\n\t\t\t'{Locked=\\'](https://code.visualstudio.com/docs/copilot/security)\\'}',\n\t\t\t'{Locked=\\'**\\'}',\n\t\t]\n\t},\n\t'Global auto approve also known as \"YOLO mode\" disables manual approval completely for _all tools in all workspaces_, allowing the agent to act fully autonomously. This is extremely dangerous and is *never* recommended, even containerized environments like [Codespaces](https://github.com/features/codespaces) and [Dev Containers](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers) have user keys forwarded into the container that could be compromised.\\n\\n**This feature disables [critical security protections](https://code.visualstudio.com/docs/copilot/security) and makes it much easier for an attacker to compromise the machine.**'\n);\n\nexport class LanguageModelToolsService extends Disposable implements ILanguageModelToolsService {\n\t_serviceBrand: undefined;\n\tvscodeToolSet: ToolSet;\n\tlaunchToolSet: ToolSet;\n\n\tprivate _onDidChangeTools = this._register(new Emitter<void>());\n\treadonly onDidChangeTools = this._onDidChangeTools.event;\n\tprivate _onDidPrepareToolCallBecomeUnresponsive = this._register(new Emitter<{ sessionId: string; toolData: IToolData }>());\n\treadonly onDidPrepareToolCallBecomeUnresponsive = this._onDidPrepareToolCallBecomeUnresponsive.event;\n\n\t/** Throttle tools updates because it sends all tools and runs on context key updates */\n\tprivate _onDidChangeToolsScheduler = new RunOnceScheduler(() => this._onDidChangeTools.fire(), 750);\n\n\tprivate _tools = new Map<string, IToolEntry>();\n\tprivate _toolContextKeys = new Set<string>();\n\tprivate readonly _ctxToolsCount: IContextKey<number>;\n\n\tprivate _callsByRequestId = new Map<string, ITrackedCall[]>();\n\n\tconstructor(\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService,\n\t\t@IContextKeyService private readonly _contextKeyService: IContextKeyService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IAccessibilityService private readonly _accessibilityService: IAccessibilityService,\n\t\t@IAccessibilitySignalService private readonly _accessibilitySignalService: IAccessibilitySignalService,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@ILanguageModelToolsConfirmationService private readonly _confirmationService: ILanguageModelToolsConfirmationService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(this._contextKeyService.onDidChangeContext(e => {\n\t\t\tif (e.affectsSome(this._toolContextKeys)) {\n\t\t\t\t// Not worth it to compute a delta here unless we have many tools changing often\n\t\t\t\tthis._onDidChangeToolsScheduler.schedule();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._configurationService.onDidChangeConfiguration(e => {\n\t\t\tif (e.affectsConfiguration(ChatConfiguration.ExtensionToolsEnabled)) {\n\t\t\t\tthis._onDidChangeToolsScheduler.schedule();\n\t\t\t}\n\t\t}));\n\n\t\t// Clear out warning accepted state if the setting is disabled\n\t\tthis._register(Event.runAndSubscribe(this._configurationService.onDidChangeConfiguration, e => {\n\t\t\tif (!e || e.affectsConfiguration(ChatConfiguration.GlobalAutoApprove)) {\n\t\t\t\tif (this._configurationService.getValue(ChatConfiguration.GlobalAutoApprove) !== true) {\n\t\t\t\t\tthis._storageService.remove(AutoApproveStorageKeys.GlobalAutoApproveOptIn, StorageScope.APPLICATION);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._ctxToolsCount = ChatContextKeys.Tools.toolsCount.bindTo(_contextKeyService);\n\n\t\t// Create the internal VS Code tool set\n\t\tthis.vscodeToolSet = this._register(this.createToolSet(\n\t\t\tToolDataSource.Internal,\n\t\t\t'vscode',\n\t\t\tVSCodeToolReference.vscode,\n\t\t\t{\n\t\t\t\ticon: ThemeIcon.fromId(Codicon.vscode.id),\n\t\t\t\tdescription: localize('copilot.toolSet.vscode.description', 'Use VS Code features'),\n\t\t\t}\n\t\t));\n\n\t\t// Create the internal Launch tool set\n\t\tthis.launchToolSet = this._register(this.createToolSet(\n\t\t\tToolDataSource.Internal,\n\t\t\t'launch',\n\t\t\tVSCodeToolReference.launch,\n\t\t\t{\n\t\t\t\ticon: ThemeIcon.fromId(Codicon.rocket.id),\n\t\t\t\tdescription: localize('copilot.toolSet.launch.description', 'Launch and run code, binaries or tests in the workspace'),\n\t\t\t}\n\t\t));\n\t}\n\toverride dispose(): void {\n\t\tsuper.dispose();\n\n\t\tthis._callsByRequestId.forEach(calls => calls.forEach(call => call.store.dispose()));\n\t\tthis._ctxToolsCount.reset();\n\t}\n\n\tregisterToolData(toolData: IToolData): IDisposable {\n\t\tif (this._tools.has(toolData.id)) {\n\t\t\tthrow new Error(`Tool \"${toolData.id}\" is already registered.`);\n\t\t}\n\n\t\tthis._tools.set(toolData.id, { data: toolData });\n\t\tthis._ctxToolsCount.set(this._tools.size);\n\t\tthis._onDidChangeToolsScheduler.schedule();\n\n\t\ttoolData.when?.keys().forEach(key => this._toolContextKeys.add(key));\n\n\t\tlet store: DisposableStore | undefined;\n\t\tif (toolData.inputSchema) {\n\t\t\tstore = new DisposableStore();\n\t\t\tconst schemaUrl = createToolSchemaUri(toolData.id).toString();\n\t\t\tjsonSchemaRegistry.registerSchema(schemaUrl, toolData.inputSchema, store);\n\t\t\tstore.add(jsonSchemaRegistry.registerSchemaAssociation(schemaUrl, `/lm/tool/${toolData.id}/tool_input.json`));\n\t\t}\n\n\t\treturn toDisposable(() => {\n\t\t\tstore?.dispose();\n\t\t\tthis._tools.delete(toolData.id);\n\t\t\tthis._ctxToolsCount.set(this._tools.size);\n\t\t\tthis._refreshAllToolContextKeys();\n\t\t\tthis._onDidChangeToolsScheduler.schedule();\n\t\t});\n\t}\n\n\tflushToolUpdates(): void {\n\t\tthis._onDidChangeToolsScheduler.flush();\n\t}\n\n\tprivate _refreshAllToolContextKeys() {\n\t\tthis._toolContextKeys.clear();\n\t\tfor (const tool of this._tools.values()) {\n\t\t\ttool.data.when?.keys().forEach(key => this._toolContextKeys.add(key));\n\t\t}\n\t}\n\n\tregisterToolImplementation(id: string, tool: IToolImpl): IDisposable {\n\t\tconst entry = this._tools.get(id);\n\t\tif (!entry) {\n\t\t\tthrow new Error(`Tool \"${id}\" was not contributed.`);\n\t\t}\n\n\t\tif (entry.impl) {\n\t\t\tthrow new Error(`Tool \"${id}\" already has an implementation.`);\n\t\t}\n\n\t\tentry.impl = tool;\n\t\treturn toDisposable(() => {\n\t\t\tentry.impl = undefined;\n\t\t});\n\t}\n\n\tregisterTool(toolData: IToolData, tool: IToolImpl): IDisposable {\n\t\treturn combinedDisposable(\n\t\t\tthis.registerToolData(toolData),\n\t\t\tthis.registerToolImplementation(toolData.id, tool)\n\t\t);\n\t}\n\n\tgetTools(includeDisabled?: boolean): Iterable<Readonly<IToolData>> {\n\t\tconst toolDatas = Iterable.map(this._tools.values(), i => i.data);\n\t\tconst extensionToolsEnabled = this._configurationService.getValue<boolean>(ChatConfiguration.ExtensionToolsEnabled);\n\t\treturn Iterable.filter(\n\t\t\ttoolDatas,\n\t\t\ttoolData => {\n\t\t\t\tconst satisfiesWhenClause = includeDisabled || !toolData.when || this._contextKeyService.contextMatchesRules(toolData.when);\n\t\t\t\tconst satisfiesExternalToolCheck = toolData.source.type !== 'extension' || !!extensionToolsEnabled;\n\t\t\t\treturn satisfiesWhenClause && satisfiesExternalToolCheck;\n\t\t\t});\n\t}\n\n\tgetTool(id: string): IToolData | undefined {\n\t\treturn this._getToolEntry(id)?.data;\n\t}\n\n\tprivate _getToolEntry(id: string): IToolEntry | undefined {\n\t\tconst entry = this._tools.get(id);\n\t\tif (entry && (!entry.data.when || this._contextKeyService.contextMatchesRules(entry.data.when))) {\n\t\t\treturn entry;\n\t\t} else {\n\t\t\treturn undefined;\n\t\t}\n\t}\n\n\tgetToolByName(name: string, includeDisabled?: boolean): IToolData | undefined {\n\t\tfor (const tool of this.getTools(!!includeDisabled)) {\n\t\t\tif (tool.toolReferenceName === name) {\n\t\t\t\treturn tool;\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tasync invokeTool(dto: IToolInvocation, countTokens: CountTokensCallback, token: CancellationToken): Promise<IToolResult> {\n\t\tthis._logService.trace(`[LanguageModelToolsService#invokeTool] Invoking tool ${dto.toolId} with parameters ${JSON.stringify(dto.parameters)}`);\n\n\t\t// When invoking a tool, don't validate the \"when\" clause. An extension may have invoked a tool just as it was becoming disabled, and just let it go through rather than throw and break the chat.\n\t\tlet tool = this._tools.get(dto.toolId);\n\t\tif (!tool) {\n\t\t\tthrow new Error(`Tool ${dto.toolId} was not contributed`);\n\t\t}\n\n\t\tif (!tool.impl) {\n\t\t\tawait this._extensionService.activateByEvent(`onLanguageModelTool:${dto.toolId}`);\n\n\t\t\t// Extension should activate and register the tool implementation\n\t\t\ttool = this._tools.get(dto.toolId);\n\t\t\tif (!tool?.impl) {\n\t\t\t\tthrow new Error(`Tool ${dto.toolId} does not have an implementation registered.`);\n\t\t\t}\n\t\t}\n\n\t\t// Shortcut to write to the model directly here, but could call all the way back to use the real stream.\n\t\tlet toolInvocation: ChatToolInvocation | undefined;\n\n\t\tlet requestId: string | undefined;\n\t\tlet store: DisposableStore | undefined;\n\t\tlet toolResult: IToolResult | undefined;\n\t\tlet prepareTimeWatch: StopWatch | undefined;\n\t\tlet invocationTimeWatch: StopWatch | undefined;\n\t\tlet preparedInvocation: IPreparedToolInvocation | undefined;\n\t\ttry {\n\t\t\tif (dto.context) {\n\t\t\t\tstore = new DisposableStore();\n\t\t\t\tconst model = this._chatService.getSession(dto.context.sessionResource);\n\t\t\t\tif (!model) {\n\t\t\t\t\tthrow new Error(`Tool called for unknown chat session`);\n\t\t\t\t}\n\n\t\t\t\tconst request = model.getRequests().at(-1)!;\n\t\t\t\trequestId = request.id;\n\t\t\t\tdto.modelId = request.modelId;\n\t\t\t\tdto.userSelectedTools = request.userSelectedTools;\n\n\t\t\t\t// Replace the token with a new token that we can cancel when cancelToolCallsForRequest is called\n\t\t\t\tif (!this._callsByRequestId.has(requestId)) {\n\t\t\t\t\tthis._callsByRequestId.set(requestId, []);\n\t\t\t\t}\n\t\t\t\tconst trackedCall: ITrackedCall = { store };\n\t\t\t\tthis._callsByRequestId.get(requestId)!.push(trackedCall);\n\n\t\t\t\tconst source = new CancellationTokenSource();\n\t\t\t\tstore.add(toDisposable(() => {\n\t\t\t\t\tsource.dispose(true);\n\t\t\t\t}));\n\t\t\t\tstore.add(token.onCancellationRequested(() => {\n\t\t\t\t\tIChatToolInvocation.confirmWith(toolInvocation, { type: ToolConfirmKind.Denied });\n\t\t\t\t\tsource.cancel();\n\t\t\t\t}));\n\t\t\t\tstore.add(source.token.onCancellationRequested(() => {\n\t\t\t\t\tIChatToolInvocation.confirmWith(toolInvocation, { type: ToolConfirmKind.Denied });\n\t\t\t\t}));\n\t\t\t\ttoken = source.token;\n\n\t\t\t\tprepareTimeWatch = StopWatch.create(true);\n\t\t\t\tpreparedInvocation = await this.prepareToolInvocation(tool, dto, token);\n\t\t\t\tprepareTimeWatch.stop();\n\n\t\t\t\ttoolInvocation = new ChatToolInvocation(preparedInvocation, tool.data, dto.callId, dto.fromSubAgent, dto.parameters);\n\t\t\t\ttrackedCall.invocation = toolInvocation;\n\t\t\t\tconst autoConfirmed = await this.shouldAutoConfirm(tool.data.id, tool.data.runsInWorkspace, tool.data.source, dto.parameters);\n\t\t\t\tif (autoConfirmed) {\n\t\t\t\t\tIChatToolInvocation.confirmWith(toolInvocation, autoConfirmed);\n\t\t\t\t}\n\n\t\t\t\tthis._chatService.appendProgress(request, toolInvocation);\n\n\t\t\t\tdto.toolSpecificData = toolInvocation?.toolSpecificData;\n\t\t\t\tif (preparedInvocation?.confirmationMessages?.title) {\n\t\t\t\t\tif (!IChatToolInvocation.executionConfirmedOrDenied(toolInvocation) && !autoConfirmed) {\n\t\t\t\t\t\tthis.playAccessibilitySignal([toolInvocation]);\n\t\t\t\t\t}\n\t\t\t\t\tconst userConfirmed = await IChatToolInvocation.awaitConfirmation(toolInvocation, token);\n\t\t\t\t\tif (userConfirmed.type === ToolConfirmKind.Denied) {\n\t\t\t\t\t\tthrow new CancellationError();\n\t\t\t\t\t}\n\t\t\t\t\tif (userConfirmed.type === ToolConfirmKind.Skipped) {\n\t\t\t\t\t\ttoolResult = {\n\t\t\t\t\t\t\tcontent: [{\n\t\t\t\t\t\t\t\tkind: 'text',\n\t\t\t\t\t\t\t\tvalue: 'The user chose to skip the tool call, they want to proceed without running it'\n\t\t\t\t\t\t\t}]\n\t\t\t\t\t\t};\n\t\t\t\t\t\treturn toolResult;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (dto.toolSpecificData?.kind === 'input') {\n\t\t\t\t\t\tdto.parameters = dto.toolSpecificData.rawInput;\n\t\t\t\t\t\tdto.toolSpecificData = undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tprepareTimeWatch = StopWatch.create(true);\n\t\t\t\tpreparedInvocation = await this.prepareToolInvocation(tool, dto, token);\n\t\t\t\tprepareTimeWatch.stop();\n\t\t\t\tif (preparedInvocation?.confirmationMessages?.title && !(await this.shouldAutoConfirm(tool.data.id, tool.data.runsInWorkspace, tool.data.source, dto.parameters))) {\n\t\t\t\t\tconst result = await this._dialogService.confirm({ message: renderAsPlaintext(preparedInvocation.confirmationMessages.title), detail: renderAsPlaintext(preparedInvocation.confirmationMessages.message!) });\n\t\t\t\t\tif (!result.confirmed) {\n\t\t\t\t\t\tthrow new CancellationError();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdto.toolSpecificData = preparedInvocation?.toolSpecificData;\n\t\t\t}\n\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\tthrow new CancellationError();\n\t\t\t}\n\n\t\t\tinvocationTimeWatch = StopWatch.create(true);\n\t\t\ttoolResult = await tool.impl.invoke(dto, countTokens, {\n\t\t\t\treport: step => {\n\t\t\t\t\ttoolInvocation?.acceptProgress(step);\n\t\t\t\t}\n\t\t\t}, token);\n\t\t\tinvocationTimeWatch.stop();\n\t\t\tthis.ensureToolDetails(dto, toolResult, tool.data);\n\n\t\t\tif (toolInvocation?.didExecuteTool(toolResult).type === IChatToolInvocation.StateKind.WaitingForPostApproval) {\n\t\t\t\tconst autoConfirmedPost = await this.shouldAutoConfirmPostExecution(tool.data.id, tool.data.runsInWorkspace, tool.data.source, dto.parameters);\n\t\t\t\tif (autoConfirmedPost) {\n\t\t\t\t\tIChatToolInvocation.confirmWith(toolInvocation, autoConfirmedPost);\n\t\t\t\t}\n\n\t\t\t\tconst postConfirm = await IChatToolInvocation.awaitPostConfirmation(toolInvocation, token);\n\t\t\t\tif (postConfirm.type === ToolConfirmKind.Denied) {\n\t\t\t\t\tthrow new CancellationError();\n\t\t\t\t}\n\t\t\t\tif (postConfirm.type === ToolConfirmKind.Skipped) {\n\t\t\t\t\ttoolResult = {\n\t\t\t\t\t\tcontent: [{\n\t\t\t\t\t\t\tkind: 'text',\n\t\t\t\t\t\t\tvalue: 'The tool executed but the user chose not to share the results'\n\t\t\t\t\t\t}]\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._telemetryService.publicLog2<LanguageModelToolInvokedEvent, LanguageModelToolInvokedClassification>(\n\t\t\t\t'languageModelToolInvoked',\n\t\t\t\t{\n\t\t\t\t\tresult: 'success',\n\t\t\t\t\tchatSessionId: dto.context?.sessionId,\n\t\t\t\t\ttoolId: tool.data.id,\n\t\t\t\t\ttoolExtensionId: tool.data.source.type === 'extension' ? tool.data.source.extensionId.value : undefined,\n\t\t\t\t\ttoolSourceKind: tool.data.source.type,\n\t\t\t\t\tprepareTimeMs: prepareTimeWatch?.elapsed(),\n\t\t\t\t\tinvocationTimeMs: invocationTimeWatch?.elapsed(),\n\t\t\t\t});\n\t\t\treturn toolResult;\n\t\t} catch (err) {\n\t\t\tconst result = isCancellationError(err) ? 'userCancelled' : 'error';\n\t\t\tthis._telemetryService.publicLog2<LanguageModelToolInvokedEvent, LanguageModelToolInvokedClassification>(\n\t\t\t\t'languageModelToolInvoked',\n\t\t\t\t{\n\t\t\t\t\tresult,\n\t\t\t\t\tchatSessionId: dto.context?.sessionId,\n\t\t\t\t\ttoolId: tool.data.id,\n\t\t\t\t\ttoolExtensionId: tool.data.source.type === 'extension' ? tool.data.source.extensionId.value : undefined,\n\t\t\t\t\ttoolSourceKind: tool.data.source.type,\n\t\t\t\t\tprepareTimeMs: prepareTimeWatch?.elapsed(),\n\t\t\t\t\tinvocationTimeMs: invocationTimeWatch?.elapsed(),\n\t\t\t\t});\n\t\t\tthis._logService.error(`[LanguageModelToolsService#invokeTool] Error from tool ${dto.toolId} with parameters ${JSON.stringify(dto.parameters)}:\\n${toErrorMessage(err, true)}`);\n\n\t\t\ttoolResult ??= { content: [] };\n\t\t\ttoolResult.toolResultError = err instanceof Error ? err.message : String(err);\n\t\t\tif (tool.data.alwaysDisplayInputOutput) {\n\t\t\t\ttoolResult.toolResultDetails = { input: this.formatToolInput(dto), output: [{ type: 'embed', isText: true, value: String(err) }], isError: true };\n\t\t\t}\n\n\t\t\tthrow err;\n\t\t} finally {\n\t\t\ttoolInvocation?.didExecuteTool(toolResult, true);\n\t\t\tif (store) {\n\t\t\t\tthis.cleanupCallDisposables(requestId, store);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async prepareToolInvocation(tool: IToolEntry, dto: IToolInvocation, token: CancellationToken): Promise<IPreparedToolInvocation | undefined> {\n\t\tlet prepared: IPreparedToolInvocation | undefined;\n\t\tif (tool.impl!.prepareToolInvocation) {\n\t\t\tconst preparePromise = tool.impl!.prepareToolInvocation({\n\t\t\t\tparameters: dto.parameters,\n\t\t\t\tchatRequestId: dto.chatRequestId,\n\t\t\t\tchatSessionId: dto.context?.sessionId,\n\t\t\t\tchatInteractionId: dto.chatInteractionId\n\t\t\t}, token);\n\n\t\t\tconst raceResult = await Promise.race([\n\t\t\t\ttimeout(3000, token).then(() => 'timeout'),\n\t\t\t\tpreparePromise\n\t\t\t]);\n\t\t\tif (raceResult === 'timeout') {\n\t\t\t\tthis._onDidPrepareToolCallBecomeUnresponsive.fire({\n\t\t\t\t\tsessionId: dto.context?.sessionId ?? '',\n\t\t\t\t\ttoolData: tool.data\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tprepared = await preparePromise;\n\t\t}\n\n\t\tconst isEligibleForAutoApproval = this.isToolEligibleForAutoApproval(tool.data);\n\n\t\t// Default confirmation messages if tool is not eligible for auto-approval\n\t\tif (!isEligibleForAutoApproval && !prepared?.confirmationMessages?.title) {\n\t\t\tif (!prepared) {\n\t\t\t\tprepared = {};\n\t\t\t}\n\t\t\tconst toolReferenceName = getToolReferenceFullName(tool.data);\n\n\t\t\t// TODO: This should be more detailed per tool.\n\t\t\tprepared.confirmationMessages = {\n\t\t\t\t...prepared.confirmationMessages,\n\t\t\t\ttitle: localize('defaultToolConfirmation.title', 'Allow tool to execute?'),\n\t\t\t\tmessage: localize('defaultToolConfirmation.message', 'Run the \\'{0}\\' tool?', toolReferenceName),\n\t\t\t\tdisclaimer: new MarkdownString(localize('defaultToolConfirmation.disclaimer', 'Auto approval for \\'{0}\\' is restricted via {1}.', getToolReferenceFullName(tool.data), createMarkdownCommandLink({ title: '`' + ChatConfiguration.EligibleForAutoApproval + '`', id: 'workbench.action.openSettings', arguments: [ChatConfiguration.EligibleForAutoApproval] }, false)), { isTrusted: true }),\n\t\t\t\tallowAutoConfirm: false,\n\t\t\t};\n\t\t}\n\n\t\tif (!isEligibleForAutoApproval && prepared?.confirmationMessages?.title) {\n\t\t\t// Always overwrite the disclaimer if not eligible for auto-approval\n\t\t\tprepared.confirmationMessages.disclaimer = new MarkdownString(localize('defaultToolConfirmation.disclaimer', 'Auto approval for \\'{0}\\' is restricted via {1}.', getToolReferenceFullName(tool.data), createMarkdownCommandLink({ title: '`' + ChatConfiguration.EligibleForAutoApproval + '`', id: 'workbench.action.openSettings', arguments: [ChatConfiguration.EligibleForAutoApproval] }, false)), { isTrusted: true });\n\t\t}\n\n\t\tif (prepared?.confirmationMessages?.title) {\n\t\t\tif (prepared.toolSpecificData?.kind !== 'terminal' && prepared.confirmationMessages.allowAutoConfirm !== false) {\n\t\t\t\tprepared.confirmationMessages.allowAutoConfirm = isEligibleForAutoApproval;\n\t\t\t}\n\n\t\t\tif (!prepared.toolSpecificData && tool.data.alwaysDisplayInputOutput) {\n\t\t\t\tprepared.toolSpecificData = {\n\t\t\t\t\tkind: 'input',\n\t\t\t\t\trawInput: dto.parameters,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn prepared;\n\t}\n\n\tprivate playAccessibilitySignal(toolInvocations: ChatToolInvocation[]): void {\n\t\tconst autoApproved = this._configurationService.getValue(ChatConfiguration.GlobalAutoApprove);\n\t\tif (autoApproved) {\n\t\t\treturn;\n\t\t}\n\t\tconst setting: { sound?: 'auto' | 'on' | 'off'; announcement?: 'auto' | 'off' } | undefined = this._configurationService.getValue(AccessibilitySignal.chatUserActionRequired.settingsKey);\n\t\tif (!setting) {\n\t\t\treturn;\n\t\t}\n\t\tconst soundEnabled = setting.sound === 'on' || (setting.sound === 'auto' && (this._accessibilityService.isScreenReaderOptimized()));\n\t\tconst announcementEnabled = this._accessibilityService.isScreenReaderOptimized() && setting.announcement === 'auto';\n\t\tif (soundEnabled || announcementEnabled) {\n\t\t\tthis._accessibilitySignalService.playSignal(AccessibilitySignal.chatUserActionRequired, { customAlertMessage: this._instantiationService.invokeFunction(getToolConfirmationAlert, toolInvocations), userGesture: true, modality: !soundEnabled ? 'announcement' : undefined });\n\t\t}\n\t}\n\n\tprivate ensureToolDetails(dto: IToolInvocation, toolResult: IToolResult, toolData: IToolData): void {\n\t\tif (!toolResult.toolResultDetails && toolData.alwaysDisplayInputOutput) {\n\t\t\ttoolResult.toolResultDetails = {\n\t\t\t\tinput: this.formatToolInput(dto),\n\t\t\t\toutput: this.toolResultToIO(toolResult),\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate formatToolInput(dto: IToolInvocation): string {\n\t\treturn JSON.stringify(dto.parameters, undefined, 2);\n\t}\n\n\tprivate toolResultToIO(toolResult: IToolResult): IToolResultInputOutputDetails['output'] {\n\t\treturn toolResult.content.map(part => {\n\t\t\tif (part.kind === 'text') {\n\t\t\t\treturn { type: 'embed', isText: true, value: part.value };\n\t\t\t} else if (part.kind === 'promptTsx') {\n\t\t\t\treturn { type: 'embed', isText: true, value: stringifyPromptTsxPart(part) };\n\t\t\t} else if (part.kind === 'data') {\n\t\t\t\treturn { type: 'embed', value: encodeBase64(part.value.data), mimeType: part.value.mimeType };\n\t\t\t} else {\n\t\t\t\tassertNever(part);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate getEligibleForAutoApprovalSpecialCase(toolData: IToolData): string | undefined {\n\t\tif (toolData.id === 'vscode_fetchWebPage_internal') {\n\t\t\treturn 'fetch';\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprivate isToolEligibleForAutoApproval(toolData: IToolData): boolean {\n\t\tconst toolReferenceName = this.getEligibleForAutoApprovalSpecialCase(toolData) ?? getToolReferenceFullName(toolData);\n\t\tif (toolData.id === 'copilot_fetchWebPage') {\n\t\t\t// Special case, this fetch will call an internal tool 'vscode_fetchWebPage_internal'\n\t\t\treturn true;\n\t\t}\n\t\tconst eligibilityConfig = this._configurationService.getValue<Record<string, boolean>>(ChatConfiguration.EligibleForAutoApproval);\n\t\tif (eligibilityConfig && typeof eligibilityConfig === 'object' && toolReferenceName) {\n\t\t\t// Direct match\n\t\t\tif (Object.prototype.hasOwnProperty.call(eligibilityConfig, toolReferenceName)) {\n\t\t\t\treturn eligibilityConfig[toolReferenceName];\n\t\t\t}\n\t\t\t// Back compat with legacy names\n\t\t\tif (toolData.legacyToolReferenceFullNames) {\n\t\t\t\tfor (const legacyName of toolData.legacyToolReferenceFullNames) {\n\t\t\t\t\tif (Object.prototype.hasOwnProperty.call(eligibilityConfig, legacyName)) {\n\t\t\t\t\t\treturn eligibilityConfig[legacyName];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// Default true\n\t\treturn true;\n\t}\n\n\tprivate async shouldAutoConfirm(toolId: string, runsInWorkspace: boolean | undefined, source: ToolDataSource, parameters: unknown): Promise<ConfirmedReason | undefined> {\n\t\tconst tool = this._tools.get(toolId);\n\t\tif (!tool) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!this.isToolEligibleForAutoApproval(tool.data)) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst reason = this._confirmationService.getPreConfirmAction({ toolId, source, parameters });\n\t\tif (reason) {\n\t\t\treturn reason;\n\t\t}\n\n\t\tconst config = this._configurationService.inspect<boolean | Record<string, boolean>>(ChatConfiguration.GlobalAutoApprove);\n\n\t\t// If we know the tool runs at a global level, only consider the global config.\n\t\t// If we know the tool runs at a workspace level, use those specific settings when appropriate.\n\t\tlet value = config.value ?? config.defaultValue;\n\t\tif (typeof runsInWorkspace === 'boolean') {\n\t\t\tvalue = config.userLocalValue ?? config.applicationValue;\n\t\t\tif (runsInWorkspace) {\n\t\t\t\tvalue = config.workspaceValue ?? config.workspaceFolderValue ?? config.userRemoteValue ?? value;\n\t\t\t}\n\t\t}\n\n\t\tconst autoConfirm = value === true || (typeof value === 'object' && value.hasOwnProperty(toolId) && value[toolId] === true);\n\t\tif (autoConfirm) {\n\t\t\tif (await this._checkGlobalAutoApprove()) {\n\t\t\t\treturn { type: ToolConfirmKind.Setting, id: ChatConfiguration.GlobalAutoApprove };\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate async shouldAutoConfirmPostExecution(toolId: string, runsInWorkspace: boolean | undefined, source: ToolDataSource, parameters: unknown): Promise<ConfirmedReason | undefined> {\n\t\tif (this._configurationService.getValue<boolean>(ChatConfiguration.GlobalAutoApprove) && await this._checkGlobalAutoApprove()) {\n\t\t\treturn { type: ToolConfirmKind.Setting, id: ChatConfiguration.GlobalAutoApprove };\n\t\t}\n\n\t\treturn this._confirmationService.getPostConfirmAction({ toolId, source, parameters });\n\t}\n\n\tprivate async _checkGlobalAutoApprove(): Promise<boolean> {\n\t\tconst optedIn = this._storageService.getBoolean(AutoApproveStorageKeys.GlobalAutoApproveOptIn, StorageScope.APPLICATION, false);\n\t\tif (optedIn) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (this._contextKeyService.getContextKeyValue(SkipAutoApproveConfirmationKey) === true) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst promptResult = await this._dialogService.prompt({\n\t\t\ttype: Severity.Warning,\n\t\t\tmessage: localize('autoApprove2.title', 'Enable global auto approve?'),\n\t\t\tbuttons: [\n\t\t\t\t{\n\t\t\t\t\tlabel: localize('autoApprove2.button.enable', 'Enable'),\n\t\t\t\t\trun: () => true\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlabel: localize('autoApprove2.button.disable', 'Disable'),\n\t\t\t\t\trun: () => false\n\t\t\t\t},\n\t\t\t],\n\t\t\tcustom: {\n\t\t\t\ticon: Codicon.warning,\n\t\t\t\tdisableCloseAction: true,\n\t\t\t\tmarkdownDetails: [{\n\t\t\t\t\tmarkdown: new MarkdownString(globalAutoApproveDescription.value),\n\t\t\t\t}],\n\t\t\t}\n\t\t});\n\n\t\tif (promptResult.result !== true) {\n\t\t\tawait this._configurationService.updateValue(ChatConfiguration.GlobalAutoApprove, false);\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._storageService.store(AutoApproveStorageKeys.GlobalAutoApproveOptIn, true, StorageScope.APPLICATION, StorageTarget.USER);\n\t\treturn true;\n\t}\n\n\tprivate cleanupCallDisposables(requestId: string | undefined, store: DisposableStore): void {\n\t\tif (requestId) {\n\t\t\tconst disposables = this._callsByRequestId.get(requestId);\n\t\t\tif (disposables) {\n\t\t\t\tconst index = disposables.findIndex(d => d.store === store);\n\t\t\t\tif (index > -1) {\n\t\t\t\t\tdisposables.splice(index, 1);\n\t\t\t\t}\n\t\t\t\tif (disposables.length === 0) {\n\t\t\t\t\tthis._callsByRequestId.delete(requestId);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tstore.dispose();\n\t}\n\n\tcancelToolCallsForRequest(requestId: string): void {\n\t\tconst calls = this._callsByRequestId.get(requestId);\n\t\tif (calls) {\n\t\t\tcalls.forEach(call => call.store.dispose());\n\t\t\tthis._callsByRequestId.delete(requestId);\n\t\t}\n\t}\n\n\tprivate _githubToVSCodeToolMap: Record<string, string> = {\n\t\t[GithubCopilotToolReference.shell]: VSCodeToolReference.shell,\n\t\t[GithubCopilotToolReference.customAgent]: VSCodeToolReference.runSubagent,\n\t\t'github/*': 'github/github-mcp-server/*',\n\t\t'playwright/*': 'microsoft/playwright-mcp/*',\n\t};\n\tprivate _githubPrefixToVSCodePrefix = [['github', 'github/github-mcp-server'], ['playwright', 'microsoft/playwright-mcp']] as const;\n\n\tmapGithubToolName(name: string): string {\n\t\tconst mapped = this._githubToVSCodeToolMap[name];\n\t\tif (mapped) {\n\t\t\treturn mapped;\n\t\t}\n\t\tfor (const [fromPrefix, toPrefix] of this._githubPrefixToVSCodePrefix) {\n\t\t\tconst regexp = new RegExp(`^${fromPrefix}(/[^/]+)$`);\n\t\t\tconst m = name.match(regexp);\n\t\t\tif (m) {\n\t\t\t\treturn toPrefix + m[1];\n\t\t\t}\n\t\t}\n\t\treturn name;\n\t}\n\n\t/**\n\t * Create a map that contains all tools and toolsets with their enablement state.\n\t * @param toolOrToolSetNames A list of tool or toolset names that are enabled.\n\t * @returns A map of tool or toolset instances to their enablement state.\n\t */\n\ttoToolAndToolSetEnablementMap(enabledQualifiedToolOrToolSetNames: readonly string[], target: string | undefined): IToolAndToolSetEnablementMap {\n\t\tif (target === undefined || target === Target.GitHubCopilot) {\n\t\t\tenabledQualifiedToolOrToolSetNames = enabledQualifiedToolOrToolSetNames.map(name => this.mapGithubToolName(name));\n\t\t}\n\t\tconst toolOrToolSetNames = new Set(enabledQualifiedToolOrToolSetNames);\n\t\tconst result = new Map<ToolSet | IToolData, boolean>();\n\t\tfor (const [tool, toolReferenceName] of this.getPromptReferencableTools()) {\n\t\t\tif (tool instanceof ToolSet) {\n\t\t\t\tconst enabled = Boolean(\n\t\t\t\t\ttoolOrToolSetNames.has(toolReferenceName) ||\n\t\t\t\t\ttoolOrToolSetNames.has(tool.referenceName) ||\n\t\t\t\t\ttool.legacyFullNames?.some(name => toolOrToolSetNames.has(name))\n\t\t\t\t);\n\t\t\t\tresult.set(tool, enabled);\n\t\t\t\tif (enabled) {\n\t\t\t\t\tfor (const memberTool of tool.getTools()) {\n\t\t\t\t\t\tresult.set(memberTool, true);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (!result.has(tool)) { // already set via an enabled toolset\n\t\t\t\t\tconst enabled = Boolean(\n\t\t\t\t\t\ttoolOrToolSetNames.has(toolReferenceName) ||\n\t\t\t\t\t\ttoolOrToolSetNames.has(tool.toolReferenceName ?? tool.displayName) ||\n\t\t\t\t\t\ttool.legacyToolReferenceFullNames?.some(toolFullName => {\n\t\t\t\t\t\t\t// enable tool if either the legacy fully qualified name or just the legacy tool set name is present\n\t\t\t\t\t\t\tconst toolSetFullName = toolFullName.substring(0, toolFullName.lastIndexOf('/'));\n\t\t\t\t\t\t\treturn toolOrToolSetNames.has(toolFullName) ||\n\t\t\t\t\t\t\t\t(toolSetFullName && toolOrToolSetNames.has(toolSetFullName));\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t\tresult.set(tool, enabled);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t// also add all user tool sets (not part of the prompt referencable tools)\n\t\tfor (const toolSet of this._toolSets) {\n\t\t\tif (toolSet.source.type === 'user') {\n\t\t\t\tconst enabled = Iterable.every(toolSet.getTools(), t => result.get(t) === true);\n\t\t\t\tresult.set(toolSet, enabled);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\ttoQualifiedToolNames(map: IToolAndToolSetEnablementMap): string[] {\n\t\tconst result: string[] = [];\n\t\tconst toolsCoveredByEnabledToolSet = new Set<IToolData>();\n\t\tfor (const [tool, toolReferenceName] of this.getPromptReferencableTools()) {\n\t\t\tif (tool instanceof ToolSet) {\n\t\t\t\tif (map.get(tool)) {\n\t\t\t\t\tresult.push(toolReferenceName);\n\t\t\t\t\tfor (const memberTool of tool.getTools()) {\n\t\t\t\t\t\ttoolsCoveredByEnabledToolSet.add(memberTool);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (map.get(tool) && !toolsCoveredByEnabledToolSet.has(tool)) {\n\t\t\t\t\tresult.push(toolReferenceName);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\ttoToolReferences(variableReferences: readonly IVariableReference[]): ChatRequestToolReferenceEntry[] {\n\t\tconst toolsOrToolSetByName = new Map<string, ToolSet | IToolData>();\n\t\tfor (const [tool, toolReferenceName] of this.getPromptReferencableTools()) {\n\t\t\ttoolsOrToolSetByName.set(toolReferenceName, tool);\n\t\t}\n\n\t\tconst result: ChatRequestToolReferenceEntry[] = [];\n\t\tfor (const ref of variableReferences) {\n\t\t\tconst toolOrToolSet = toolsOrToolSetByName.get(ref.name);\n\t\t\tif (toolOrToolSet) {\n\t\t\t\tif (toolOrToolSet instanceof ToolSet) {\n\t\t\t\t\tresult.push(toToolSetVariableEntry(toolOrToolSet, ref.range));\n\t\t\t\t} else {\n\t\t\t\t\tresult.push(toToolVariableEntry(toolOrToolSet, ref.range));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\n\tprivate readonly _toolSets = new ObservableSet<ToolSet>();\n\n\treadonly toolSets: IObservable<Iterable<ToolSet>> = this._toolSets.observable;\n\n\tgetToolSet(id: string): ToolSet | undefined {\n\t\tfor (const toolSet of this._toolSets) {\n\t\t\tif (toolSet.id === id) {\n\t\t\t\treturn toolSet;\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tgetToolSetByName(name: string): ToolSet | undefined {\n\t\tfor (const toolSet of this._toolSets) {\n\t\t\tif (toolSet.referenceName === name) {\n\t\t\t\treturn toolSet;\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tcreateToolSet(source: ToolDataSource, id: string, referenceName: string, options?: { icon?: ThemeIcon; description?: string; legacyFullNames?: string[] }): ToolSet & IDisposable {\n\n\t\tconst that = this;\n\n\t\tconst result = new class extends ToolSet implements IDisposable {\n\t\t\tdispose(): void {\n\t\t\t\tif (that._toolSets.has(result)) {\n\t\t\t\t\tthis._tools.clear();\n\t\t\t\t\tthat._toolSets.delete(result);\n\t\t\t\t}\n\n\t\t\t}\n\t\t}(id, referenceName, options?.icon ?? Codicon.tools, source, options?.description, options?.legacyFullNames);\n\n\t\tthis._toolSets.add(result);\n\t\treturn result;\n\t}\n\n\tprivate * getPromptReferencableTools(): Iterable<[IToolData | ToolSet, string]> {\n\t\tconst coveredByToolSets = new Set<IToolData>();\n\t\tfor (const toolSet of this.toolSets.get()) {\n\t\t\tif (toolSet.source.type !== 'user') {\n\t\t\t\tyield [toolSet, getToolSetReferenceName(toolSet)];\n\t\t\t\tfor (const tool of toolSet.getTools()) {\n\t\t\t\t\tyield [tool, getToolReferenceFullName(tool, toolSet)];\n\t\t\t\t\tcoveredByToolSets.add(tool);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfor (const tool of this.getTools()) {\n\t\t\tif (tool.canBeReferencedInPrompt && !coveredByToolSets.has(tool)) {\n\t\t\t\tyield [tool, getToolReferenceFullName(tool)];\n\t\t\t}\n\t\t}\n\t}\n\n\t* getQualifiedToolNames(): Iterable<string> {\n\t\tfor (const [, toolReferenceName] of this.getPromptReferencableTools()) {\n\t\t\tyield toolReferenceName;\n\t\t}\n\t}\n\n\tgetDeprecatedQualifiedToolNames(): Map<string, Set<string>> {\n\t\tconst result = new Map<string, Set<string>>();\n\t\tconst knownToolSetNames = new Set<string>();\n\t\tconst add = (name: string, toolReferenceName: string) => {\n\t\t\tif (name !== toolReferenceName) {\n\t\t\t\tif (!result.has(name)) {\n\t\t\t\t\tresult.set(name, new Set<string>());\n\t\t\t\t}\n\t\t\t\tresult.get(name)!.add(toolReferenceName);\n\t\t\t}\n\t\t};\n\n\t\tfor (const [tool, _] of this.getPromptReferencableTools()) {\n\t\t\tif (tool instanceof ToolSet) {\n\t\t\t\tknownToolSetNames.add(tool.referenceName);\n\t\t\t\tif (tool.legacyFullNames) {\n\t\t\t\t\tfor (const legacyName of tool.legacyFullNames) {\n\t\t\t\t\t\tknownToolSetNames.add(legacyName);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfor (const [tool, toolReferenceName] of this.getPromptReferencableTools()) {\n\t\t\tif (tool instanceof ToolSet) {\n\t\t\t\tadd(tool.referenceName, toolReferenceName);\n\t\t\t\tif (tool.legacyFullNames) {\n\t\t\t\t\tfor (const legacyName of tool.legacyFullNames) {\n\t\t\t\t\t\tadd(legacyName, toolReferenceName);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tadd(tool.toolReferenceName ?? tool.displayName, toolReferenceName);\n\t\t\t\tif (tool.legacyToolReferenceFullNames) {\n\t\t\t\t\tfor (const legacyName of tool.legacyToolReferenceFullNames) {\n\t\t\t\t\t\tadd(legacyName, toolReferenceName);\n\t\t\t\t\t\t// for any 'orphaned' toolsets (toolsets that no longer exist and\n\t\t\t\t\t\t// do not have an explicit legacy mapping), we should\n\t\t\t\t\t\t// just point them to the list of tools directly\n\t\t\t\t\t\tif (legacyName.includes('/')) {\n\t\t\t\t\t\t\tconst toolSetFullName = legacyName.substring(0, legacyName.lastIndexOf('/'));\n\t\t\t\t\t\t\tif (!knownToolSetNames.has(toolSetFullName)) {\n\t\t\t\t\t\t\t\tadd(toolSetFullName, toolReferenceName);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tgetToolByQualifiedName(qualifiedName: string): IToolData | ToolSet | undefined {\n\t\tfor (const [tool, toolReferenceName] of this.getPromptReferencableTools()) {\n\t\t\tif (qualifiedName === toolReferenceName) {\n\t\t\t\treturn tool;\n\t\t\t}\n\t\t\t// legacy: check for the old name\n\t\t\tif (qualifiedName === (tool instanceof ToolSet ? tool.referenceName : tool.toolReferenceName ?? tool.displayName)) {\n\t\t\t\treturn tool;\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tgetQualifiedToolName(tool: IToolData | ToolSet, toolSet?: ToolSet): string {\n\t\tif (tool instanceof ToolSet) {\n\t\t\treturn getToolSetReferenceName(tool);\n\t\t}\n\t\treturn getToolReferenceFullName(tool, toolSet);\n\t}\n}\n\nfunction getToolReferenceFullName(tool: IToolData, toolSet?: ToolSet) {\n\tconst toolName = tool.toolReferenceName ?? tool.displayName;\n\tif (toolSet) {\n\t\treturn `${toolSet.referenceName}/${toolName}`;\n\t} else if (tool.source.type === 'extension') {\n\t\treturn `${tool.source.extensionId.value.toLowerCase()}/${toolName}`;\n\t}\n\treturn toolName;\n}\n\nfunction getToolSetReferenceName(toolSet: ToolSet) {\n\tif (toolSet.source.type === 'mcp') {\n\t\treturn `${toolSet.referenceName}/*`;\n\t}\n\treturn toolSet.referenceName;\n}\n\n\ntype LanguageModelToolInvokedEvent = {\n\tresult: 'success' | 'error' | 'userCancelled';\n\tchatSessionId: string | undefined;\n\ttoolId: string;\n\ttoolExtensionId: string | undefined;\n\ttoolSourceKind: string;\n\tprepareTimeMs?: number;\n\tinvocationTimeMs?: number;\n};\n\ntype LanguageModelToolInvokedClassification = {\n\tresult: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Whether invoking the LanguageModelTool resulted in an error.' };\n\tchatSessionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the chat session that the tool was used within, if applicable.' };\n\ttoolId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The ID of the tool used.' };\n\ttoolExtensionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The extension that contributed the tool.' };\n\ttoolSourceKind: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The source (mcp/extension/internal) of the tool.' };\n\tprepareTimeMs?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Time spent in prepareToolInvocation method in milliseconds.' };\n\tinvocationTimeMs?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Time spent in tool invoke method in milliseconds.' };\n\towner: 'roblourens';\n\tcomment: 'Provides insight into the usage of language model tools.';\n};\n"]}