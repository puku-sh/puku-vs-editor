{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/chat/browser/chatContextService.ts","vs/workbench/contrib/chat/browser/chatContextService.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;AAEhG,OAAO,EAAE,SAAS,EAAE,MAAM,sCAAsC,CAAC;AACjE,OAAO,EAAoB,KAAK,EAAE,MAAM,+CAA+C,CAAC;AACxF,OAAO,EAAE,eAAe,EAAE,MAAM,4DAA4D,CAAC;AAC7F,OAAO,EAA8C,uBAAuB,EAAE,MAAM,6BAA6B,CAAC;AAElH,OAAO,EAAE,iBAAiB,EAAE,MAAM,yCAAyC,CAAC;AAE5E,OAAO,EAAE,iBAAiB,EAAE,MAAM,mDAAmD,CAAC;AACtF,OAAO,EAAqB,iBAAiB,EAAE,MAAM,yDAAyD,CAAC;AAC/G,OAAO,EAAE,UAAU,EAAE,aAAa,EAAe,MAAM,sCAAsC,CAAC;AAG9F,MAAM,CAAC,MAAM,mBAAmB,GAAG,eAAe,CAAsB,oBAAoB,CAAC,CAAC;AAYvF,IAAM,kBAAkB,GAAxB,MAAM,kBAAmB,SAAQ,UAAU;IAQjD,YAC0B,mBAA6D,EACnE,iBAAqD;QAExE,KAAK,EAAE,CAAC;QAHkC,wBAAmB,GAAnB,mBAAmB,CAAyB;QAClD,sBAAiB,GAAjB,iBAAiB,CAAmB;QAPxD,eAAU,GAAG,IAAI,GAAG,EAAqC,CAAC;QAC1D,sBAAiB,GAAG,IAAI,GAAG,EAA8B,CAAC;QAC1D,uBAAkB,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,aAAa,EAAuB,CAAC,CAAC;QACvF,yBAAoB,GAAoG,IAAI,GAAG,EAAE,CAAC;IAO1I,CAAC;IAED,sBAAsB,CAAC,EAAU,EAAE,MAA0C;QAC5E,MAAM,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC;QACvE,aAAa,CAAC,MAAM,GAAG,MAAM,CAAC;QAC9B,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,EAAE,aAAa,CAAC,CAAC;QACvC,IAAI,CAAC,wBAAwB,CAAC,EAAE,CAAC,CAAC;IACnC,CAAC;IAEO,wBAAwB,CAAC,EAAU;QAC1C,MAAM,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;QAC9C,IAAI,CAAC,aAAa,IAAI,CAAC,aAAa,CAAC,MAAM,IAAI,CAAC,aAAa,CAAC,mBAAmB,EAAE,CAAC;YACnF,OAAO;QACR,CAAC;QACD,MAAM,KAAK,GAAG,GAAG,aAAa,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,MAAM,EAAE,EAAE,CAAC,KAAK,CAAC;QACrE,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,EAAE,EAAE,IAAI,CAAC,mBAAmB,CAAC,uBAAuB,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,aAAa,CAAC,MAAM,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC,CAAC,CAAC;IACzI,CAAC;IAED,2BAA2B,CAAC,EAAU,EAAE,QAAsC,EAAE,QAA8B;QAC7G,MAAM,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,EAAE,MAAM,EAAE,SAAS,EAAE,CAAC;QACvE,aAAa,CAAC,mBAAmB,GAAG,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC;QAC3D,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,EAAE,aAAa,CAAC,CAAC;QACvC,IAAI,CAAC,wBAAwB,CAAC,EAAE,CAAC,CAAC;IACnC,CAAC;IAED,6BAA6B,CAAC,EAAU;QACvC,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;QAC3B,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,CAAC,EAAE,CAAC,CAAC;IAC9C,CAAC;IAED,2BAA2B,CAAC,EAAU,EAAE,KAAyB;QAChE,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,EAAE,EAAE,KAAK,CAAC,CAAC;IACvC,CAAC;IAED,wBAAwB;QACvB,MAAM,KAAK,GAAyC,EAAE,CAAC;QACvD,KAAK,MAAM,iBAAiB,IAAI,IAAI,CAAC,iBAAiB,CAAC,MAAM,EAAE,EAAE,CAAC;YACjE,KAAK,MAAM,IAAI,IAAI,iBAAiB,EAAE,CAAC;gBACtC,IAAI,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC;oBACjB,SAAS;gBACV,CAAC;gBACD,KAAK,CAAC,IAAI,CAAC;oBACV,KAAK,EAAE,IAAI,CAAC,KAAK;oBACjB,IAAI,EAAE,IAAI,CAAC,KAAK;oBAChB,gBAAgB,EAAE,IAAI,CAAC,gBAAgB;oBACvC,EAAE,EAAE,IAAI,CAAC,KAAK;oBACd,IAAI,EAAE,WAAW;iBACjB,CAAC,CAAC;YACJ,CAAC;QACF,CAAC;QACD,OAAO,KAAK,CAAC;IACd,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,GAAQ;QAChC,OAAO,IAAI,CAAC,mBAAmB,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;IAC7C,CAAC;IAEO,KAAK,CAAC,mBAAmB,CAAC,GAAQ,EAAE,SAAkB;QAC7D,MAAM,eAAe,GAA6D,EAAE,CAAC;QACrF,KAAK,MAAM,aAAa,IAAI,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE,EAAE,CAAC;YACtD,IAAI,CAAC,aAAa,CAAC,mBAAmB,EAAE,QAAQ,CAAC,6BAA6B,IAAI,CAAC,aAAa,CAAC,mBAAmB,CAAC,QAAQ,KAAK,SAAS,CAAC,EAAE,CAAC;gBAC9I,SAAS;YACV,CAAC;YACD,MAAM,UAAU,GAAG,KAAK,CAAC,aAAa,CAAC,mBAAmB,CAAC,QAAQ,EAAE,GAAG,EAAE,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE,SAAS,CAAC,CAAC;YAC1G,eAAe,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,UAAU,EAAE,QAAQ,EAAE,aAAa,CAAC,mBAAmB,CAAC,QAAQ,EAAE,CAAC,CAAC;QACnG,CAAC;QACD,eAAe,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC;QAClD,IAAI,eAAe,CAAC,MAAM,KAAK,CAAC,IAAI,eAAe,CAAC,CAAC,CAAC,CAAC,KAAK,IAAI,CAAC,EAAE,CAAC;YACnE,OAAO;QACR,CAAC;QACD,MAAM,OAAO,GAAG,CAAC,MAAM,eAAe,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,6BAA8B,CAAC,GAAG,EAAE,SAAS,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC,CAAC;QAC3H,IAAI,CAAC,OAAO,EAAE,CAAC;YACd,OAAO;QACR,CAAC;QACD,MAAM,YAAY,GAA2B;YAC5C,KAAK,EAAE,SAAS;YAChB,IAAI,EAAE,OAAO,CAAC,KAAK;YACnB,IAAI,EAAE,OAAO,CAAC,IAAI;YAClB,GAAG,EAAE,GAAG;YACR,gBAAgB,EAAE,OAAO,CAAC,gBAAgB;SAC1C,CAAC;QACF,IAAI,CAAC,oBAAoB,CAAC,KAAK,EAAE,CAAC;QAClC,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,YAAY,EAAE,EAAE,YAAY,EAAE,OAAO,EAAE,QAAQ,EAAE,eAAe,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAC,CAAC;QAC9G,OAAO,YAAY,CAAC;IACrB,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,OAA+B;QACvD,IAAI,OAAO,CAAC,KAAK,KAAK,SAAS,EAAE,CAAC;YACjC,OAAO,OAAO,CAAC;QAChB,CAAC;QAED,MAAM,IAAI,GAAG,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QACpD,IAAI,CAAC,IAAI,EAAE,CAAC;YACX,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;YACnE,OAAO,CAAC,KAAK,GAAG,QAAQ,EAAE,KAAK,CAAC;YAChC,OAAO,CAAC,gBAAgB,GAAG,QAAQ,EAAE,gBAAgB,CAAC;YACtD,OAAO,OAAO,CAAC;QAChB,CAAC;aAAM,IAAI,IAAI,CAAC,QAAQ,CAAC,kBAAkB,EAAE,CAAC;YAC7C,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,QAAQ,CAAC,kBAAkB,CAAC,IAAI,CAAC,YAAY,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;YACnG,IAAI,QAAQ,EAAE,CAAC;gBACd,OAAO,CAAC,KAAK,GAAG,QAAQ,CAAC,KAAK,CAAC;gBAC/B,OAAO,CAAC,gBAAgB,GAAG,QAAQ,CAAC,gBAAgB,CAAC;gBACrD,OAAO,OAAO,CAAC;YAChB,CAAC;QACF,CAAC;QACD,OAAO,OAAO,CAAC;IAChB,CAAC;IAEO,SAAS,CAAC,KAAa,EAAE,IAAe,EAAE,EAAU;QAC3D,MAAM,QAAQ,GAAG,GAAuB,EAAE;YACzC,IAAI,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;YAC5C,IAAI,CAAC,aAAa,EAAE,CAAC;gBACpB,MAAM,IAAI,KAAK,CAAC,qCAAqC,CAAC,CAAC;YACxD,CAAC;YAED,MAAM,KAAK,GAAG,KAAK,IAAiC,EAAE;gBACrD,IAAI,aAAa,IAAI,CAAC,aAAa,CAAC,mBAAmB,EAAE,CAAC;oBACzD,6DAA6D;oBAC7D,MAAM,IAAI,CAAC,iBAAiB,CAAC,eAAe,CAAC,yBAAyB,EAAE,EAAE,CAAC,CAAC;oBAC5E,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;oBACxC,IAAI,CAAC,aAAa,EAAE,mBAAmB,EAAE,CAAC;wBACzC,OAAO,EAAE,CAAC;oBACX,CAAC;gBACF,CAAC;gBACD,MAAM,OAAO,GAAG,MAAM,aAAa,EAAE,mBAAoB,CAAC,QAAQ,CAAC,kBAAkB,CAAC,EAAE,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;gBAClH,OAAO,OAAO,IAAI,EAAE,CAAC;YACtB,CAAC,CAAC;YAEF,OAAO;gBACN,KAAK,EAAE,KAAK,EAAE,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;oBAC3B,OAAO,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;wBACzB,KAAK,EAAE,IAAI,CAAC,KAAK;wBACjB,SAAS,EAAE,SAAS,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC;wBAC3C,YAAY,EAAE,KAAK,IAA+C,EAAE;4BACnE,IAAI,YAAY,GAAG,IAAI,CAAC;4BACxB,IAAI,CAAC,YAAY,CAAC,KAAK,KAAK,SAAS,CAAC,IAAI,aAAa,EAAE,mBAAmB,EAAE,QAAS,CAAC,kBAAkB,EAAE,CAAC;gCAC5G,YAAY,GAAG,MAAM,aAAa,CAAC,mBAAmB,CAAC,QAAQ,CAAC,kBAAkB,CAAC,IAAI,EAAE,iBAAiB,CAAC,IAAI,CAAC,CAAC;4BAClH,CAAC;4BACD,OAAO;gCACN,IAAI,EAAE,SAAS;gCACf,EAAE,EAAE,YAAY,CAAC,KAAK;gCACtB,IAAI,EAAE,YAAY,CAAC,KAAK;gCACxB,IAAI,EAAE,YAAY,CAAC,IAAI;gCACvB,KAAK,EAAE,YAAY,CAAC,KAAK;6BACzB,CAAC;wBACH,CAAC;qBACD,CAAC,CAAC,CAAC;gBACL,CAAC,CAAC;gBACF,WAAW,EAAE,KAAK;aAClB,CAAC;QACH,CAAC,CAAC;QAEF,MAAM,MAAM,GAA2B;YACtC,QAAQ;YACR,IAAI,EAAE,YAAY;YAClB,KAAK,EAAE,KAAK;YACZ,IAAI;SACJ,CAAC;QAEF,OAAO,MAAM,CAAC;IACf,CAAC;CACD,CAAA;AA9KY,kBAAkB;IAS5B,WAAA,uBAAuB,CAAA;IACvB,WAAA,iBAAiB,CAAA;GAVP,kBAAkB,CA8K9B;;AAED,iBAAiB,CAAC,mBAAmB,EAAE,kBAAkB,oCAA4B,CAAC","file":"chatContextService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ThemeIcon } from '../../../../base/common/themables.js';\nimport { LanguageSelector, score } from '../../../../editor/common/languageSelector.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IChatContextPicker, IChatContextPickerItem, IChatContextPickService } from './chatContextPickService.js';\nimport { IChatContextItem, IChatContextProvider } from '../common/chatContext.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { IChatRequestWorkspaceVariableEntry, IGenericChatRequestVariableEntry, StringChatContextValue } from '../common/chatVariableEntries.js';\nimport { IExtensionService } from '../../../services/extensions/common/extensions.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { Disposable, DisposableMap, IDisposable } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\n\nexport const IChatContextService = createDecorator<IChatContextService>('chatContextService');\n\nexport interface IChatContextService extends ChatContextService { }\n\ninterface IChatContextProviderEntry {\n\tpicker?: { title: string; icon: ThemeIcon };\n\tchatContextProvider?: {\n\t\tselector: LanguageSelector | undefined;\n\t\tprovider: IChatContextProvider;\n\t};\n}\n\nexport class ChatContextService extends Disposable {\n\t_serviceBrand: undefined;\n\n\tprivate readonly _providers = new Map<string, IChatContextProviderEntry>();\n\tprivate readonly _workspaceContext = new Map<string, IChatContextItem[]>();\n\tprivate readonly _registeredPickers = this._register(new DisposableMap<string, IDisposable>());\n\tprivate _lastResourceContext: Map<StringChatContextValue, { originalItem: IChatContextItem; provider: IChatContextProvider }> = new Map();\n\n\tconstructor(\n\t\t@IChatContextPickService private readonly _contextPickService: IChatContextPickService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService\n\t) {\n\t\tsuper();\n\t}\n\n\tsetChatContextProvider(id: string, picker: { title: string; icon: ThemeIcon }): void {\n\t\tconst providerEntry = this._providers.get(id) ?? { picker: undefined };\n\t\tproviderEntry.picker = picker;\n\t\tthis._providers.set(id, providerEntry);\n\t\tthis._registerWithPickService(id);\n\t}\n\n\tprivate _registerWithPickService(id: string): void {\n\t\tconst providerEntry = this._providers.get(id);\n\t\tif (!providerEntry || !providerEntry.picker || !providerEntry.chatContextProvider) {\n\t\t\treturn;\n\t\t}\n\t\tconst title = `${providerEntry.picker.title.replace(/\\.+$/, '')}...`;\n\t\tthis._registeredPickers.set(id, this._contextPickService.registerChatContextItem(this._asPicker(title, providerEntry.picker.icon, id)));\n\t}\n\n\tregisterChatContextProvider(id: string, selector: LanguageSelector | undefined, provider: IChatContextProvider): void {\n\t\tconst providerEntry = this._providers.get(id) ?? { picker: undefined };\n\t\tproviderEntry.chatContextProvider = { selector, provider };\n\t\tthis._providers.set(id, providerEntry);\n\t\tthis._registerWithPickService(id);\n\t}\n\n\tunregisterChatContextProvider(id: string): void {\n\t\tthis._providers.delete(id);\n\t\tthis._registeredPickers.deleteAndDispose(id);\n\t}\n\n\tupdateWorkspaceContextItems(id: string, items: IChatContextItem[]): void {\n\t\tthis._workspaceContext.set(id, items);\n\t}\n\n\tgetWorkspaceContextItems(): IChatRequestWorkspaceVariableEntry[] {\n\t\tconst items: IChatRequestWorkspaceVariableEntry[] = [];\n\t\tfor (const workspaceContexts of this._workspaceContext.values()) {\n\t\t\tfor (const item of workspaceContexts) {\n\t\t\t\tif (!item.value) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\titems.push({\n\t\t\t\t\tvalue: item.value,\n\t\t\t\t\tname: item.label,\n\t\t\t\t\tmodelDescription: item.modelDescription,\n\t\t\t\t\tid: item.label,\n\t\t\t\t\tkind: 'workspace'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\treturn items;\n\t}\n\n\tasync contextForResource(uri: URI): Promise<StringChatContextValue | undefined> {\n\t\treturn this._contextForResource(uri, false);\n\t}\n\n\tprivate async _contextForResource(uri: URI, withValue: boolean): Promise<StringChatContextValue | undefined> {\n\t\tconst scoredProviders: Array<{ score: number; provider: IChatContextProvider }> = [];\n\t\tfor (const providerEntry of this._providers.values()) {\n\t\t\tif (!providerEntry.chatContextProvider?.provider.provideChatContextForResource || (providerEntry.chatContextProvider.selector === undefined)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst matchScore = score(providerEntry.chatContextProvider.selector, uri, '', true, undefined, undefined);\n\t\t\tscoredProviders.push({ score: matchScore, provider: providerEntry.chatContextProvider.provider });\n\t\t}\n\t\tscoredProviders.sort((a, b) => b.score - a.score);\n\t\tif (scoredProviders.length === 0 || scoredProviders[0].score <= 0) {\n\t\t\treturn;\n\t\t}\n\t\tconst context = (await scoredProviders[0].provider.provideChatContextForResource!(uri, withValue, CancellationToken.None));\n\t\tif (!context) {\n\t\t\treturn;\n\t\t}\n\t\tconst contextValue: StringChatContextValue = {\n\t\t\tvalue: undefined,\n\t\t\tname: context.label,\n\t\t\ticon: context.icon,\n\t\t\turi: uri,\n\t\t\tmodelDescription: context.modelDescription\n\t\t};\n\t\tthis._lastResourceContext.clear();\n\t\tthis._lastResourceContext.set(contextValue, { originalItem: context, provider: scoredProviders[0].provider });\n\t\treturn contextValue;\n\t}\n\n\tasync resolveChatContext(context: StringChatContextValue): Promise<StringChatContextValue> {\n\t\tif (context.value !== undefined) {\n\t\t\treturn context;\n\t\t}\n\n\t\tconst item = this._lastResourceContext.get(context);\n\t\tif (!item) {\n\t\t\tconst resolved = await this._contextForResource(context.uri, true);\n\t\t\tcontext.value = resolved?.value;\n\t\t\tcontext.modelDescription = resolved?.modelDescription;\n\t\t\treturn context;\n\t\t} else if (item.provider.resolveChatContext) {\n\t\t\tconst resolved = await item.provider.resolveChatContext(item.originalItem, CancellationToken.None);\n\t\t\tif (resolved) {\n\t\t\t\tcontext.value = resolved.value;\n\t\t\t\tcontext.modelDescription = resolved.modelDescription;\n\t\t\t\treturn context;\n\t\t\t}\n\t\t}\n\t\treturn context;\n\t}\n\n\tprivate _asPicker(title: string, icon: ThemeIcon, id: string): IChatContextPickerItem {\n\t\tconst asPicker = (): IChatContextPicker => {\n\t\t\tlet providerEntry = this._providers.get(id);\n\t\t\tif (!providerEntry) {\n\t\t\t\tthrow new Error('No chat context provider registered');\n\t\t\t}\n\n\t\t\tconst picks = async (): Promise<IChatContextItem[]> => {\n\t\t\t\tif (providerEntry && !providerEntry.chatContextProvider) {\n\t\t\t\t\t// Activate the extension providing the chat context provider\n\t\t\t\t\tawait this._extensionService.activateByEvent(`onChatContextProvider:${id}`);\n\t\t\t\t\tproviderEntry = this._providers.get(id);\n\t\t\t\t\tif (!providerEntry?.chatContextProvider) {\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tconst results = await providerEntry?.chatContextProvider!.provider.provideChatContext({}, CancellationToken.None);\n\t\t\t\treturn results || [];\n\t\t\t};\n\n\t\t\treturn {\n\t\t\t\tpicks: picks().then(items => {\n\t\t\t\t\treturn items.map(item => ({\n\t\t\t\t\t\tlabel: item.label,\n\t\t\t\t\t\ticonClass: ThemeIcon.asClassName(item.icon),\n\t\t\t\t\t\tasAttachment: async (): Promise<IGenericChatRequestVariableEntry> => {\n\t\t\t\t\t\t\tlet contextValue = item;\n\t\t\t\t\t\t\tif ((contextValue.value === undefined) && providerEntry?.chatContextProvider?.provider!.resolveChatContext) {\n\t\t\t\t\t\t\t\tcontextValue = await providerEntry.chatContextProvider.provider.resolveChatContext(item, CancellationToken.None);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tkind: 'generic',\n\t\t\t\t\t\t\t\tid: contextValue.label,\n\t\t\t\t\t\t\t\tname: contextValue.label,\n\t\t\t\t\t\t\t\ticon: contextValue.icon,\n\t\t\t\t\t\t\t\tvalue: contextValue.value\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t}),\n\t\t\t\tplaceholder: title\n\t\t\t};\n\t\t};\n\n\t\tconst picker: IChatContextPickerItem = {\n\t\t\tasPicker,\n\t\t\ttype: 'pickerPick',\n\t\t\tlabel: title,\n\t\t\ticon\n\t\t};\n\n\t\treturn picker;\n\t}\n}\n\nregisterSingleton(IChatContextService, ChatContextService, InstantiationType.Delayed);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ThemeIcon } from '../../../../base/common/themables.js';\nimport { LanguageSelector, score } from '../../../../editor/common/languageSelector.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IChatContextPicker, IChatContextPickerItem, IChatContextPickService } from './chatContextPickService.js';\nimport { IChatContextItem, IChatContextProvider } from '../common/chatContext.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { IChatRequestWorkspaceVariableEntry, IGenericChatRequestVariableEntry, StringChatContextValue } from '../common/chatVariableEntries.js';\nimport { IExtensionService } from '../../../services/extensions/common/extensions.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { Disposable, DisposableMap, IDisposable } from '../../../../base/common/lifecycle.js';\nimport { URI } from '../../../../base/common/uri.js';\n\nexport const IChatContextService = createDecorator<IChatContextService>('chatContextService');\n\nexport interface IChatContextService extends ChatContextService { }\n\ninterface IChatContextProviderEntry {\n\tpicker?: { title: string; icon: ThemeIcon };\n\tchatContextProvider?: {\n\t\tselector: LanguageSelector | undefined;\n\t\tprovider: IChatContextProvider;\n\t};\n}\n\nexport class ChatContextService extends Disposable {\n\t_serviceBrand: undefined;\n\n\tprivate readonly _providers = new Map<string, IChatContextProviderEntry>();\n\tprivate readonly _workspaceContext = new Map<string, IChatContextItem[]>();\n\tprivate readonly _registeredPickers = this._register(new DisposableMap<string, IDisposable>());\n\tprivate _lastResourceContext: Map<StringChatContextValue, { originalItem: IChatContextItem; provider: IChatContextProvider }> = new Map();\n\n\tconstructor(\n\t\t@IChatContextPickService private readonly _contextPickService: IChatContextPickService,\n\t\t@IExtensionService private readonly _extensionService: IExtensionService\n\t) {\n\t\tsuper();\n\t}\n\n\tsetChatContextProvider(id: string, picker: { title: string; icon: ThemeIcon }): void {\n\t\tconst providerEntry = this._providers.get(id) ?? { picker: undefined };\n\t\tproviderEntry.picker = picker;\n\t\tthis._providers.set(id, providerEntry);\n\t\tthis._registerWithPickService(id);\n\t}\n\n\tprivate _registerWithPickService(id: string): void {\n\t\tconst providerEntry = this._providers.get(id);\n\t\tif (!providerEntry || !providerEntry.picker || !providerEntry.chatContextProvider) {\n\t\t\treturn;\n\t\t}\n\t\tconst title = `${providerEntry.picker.title.replace(/\\.+$/, '')}...`;\n\t\tthis._registeredPickers.set(id, this._contextPickService.registerChatContextItem(this._asPicker(title, providerEntry.picker.icon, id)));\n\t}\n\n\tregisterChatContextProvider(id: string, selector: LanguageSelector | undefined, provider: IChatContextProvider): void {\n\t\tconst providerEntry = this._providers.get(id) ?? { picker: undefined };\n\t\tproviderEntry.chatContextProvider = { selector, provider };\n\t\tthis._providers.set(id, providerEntry);\n\t\tthis._registerWithPickService(id);\n\t}\n\n\tunregisterChatContextProvider(id: string): void {\n\t\tthis._providers.delete(id);\n\t\tthis._registeredPickers.deleteAndDispose(id);\n\t}\n\n\tupdateWorkspaceContextItems(id: string, items: IChatContextItem[]): void {\n\t\tthis._workspaceContext.set(id, items);\n\t}\n\n\tgetWorkspaceContextItems(): IChatRequestWorkspaceVariableEntry[] {\n\t\tconst items: IChatRequestWorkspaceVariableEntry[] = [];\n\t\tfor (const workspaceContexts of this._workspaceContext.values()) {\n\t\t\tfor (const item of workspaceContexts) {\n\t\t\t\tif (!item.value) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\titems.push({\n\t\t\t\t\tvalue: item.value,\n\t\t\t\t\tname: item.label,\n\t\t\t\t\tmodelDescription: item.modelDescription,\n\t\t\t\t\tid: item.label,\n\t\t\t\t\tkind: 'workspace'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\treturn items;\n\t}\n\n\tasync contextForResource(uri: URI): Promise<StringChatContextValue | undefined> {\n\t\treturn this._contextForResource(uri, false);\n\t}\n\n\tprivate async _contextForResource(uri: URI, withValue: boolean): Promise<StringChatContextValue | undefined> {\n\t\tconst scoredProviders: Array<{ score: number; provider: IChatContextProvider }> = [];\n\t\tfor (const providerEntry of this._providers.values()) {\n\t\t\tif (!providerEntry.chatContextProvider?.provider.provideChatContextForResource || (providerEntry.chatContextProvider.selector === undefined)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst matchScore = score(providerEntry.chatContextProvider.selector, uri, '', true, undefined, undefined);\n\t\t\tscoredProviders.push({ score: matchScore, provider: providerEntry.chatContextProvider.provider });\n\t\t}\n\t\tscoredProviders.sort((a, b) => b.score - a.score);\n\t\tif (scoredProviders.length === 0 || scoredProviders[0].score <= 0) {\n\t\t\treturn;\n\t\t}\n\t\tconst context = (await scoredProviders[0].provider.provideChatContextForResource!(uri, withValue, CancellationToken.None));\n\t\tif (!context) {\n\t\t\treturn;\n\t\t}\n\t\tconst contextValue: StringChatContextValue = {\n\t\t\tvalue: undefined,\n\t\t\tname: context.label,\n\t\t\ticon: context.icon,\n\t\t\turi: uri,\n\t\t\tmodelDescription: context.modelDescription\n\t\t};\n\t\tthis._lastResourceContext.clear();\n\t\tthis._lastResourceContext.set(contextValue, { originalItem: context, provider: scoredProviders[0].provider });\n\t\treturn contextValue;\n\t}\n\n\tasync resolveChatContext(context: StringChatContextValue): Promise<StringChatContextValue> {\n\t\tif (context.value !== undefined) {\n\t\t\treturn context;\n\t\t}\n\n\t\tconst item = this._lastResourceContext.get(context);\n\t\tif (!item) {\n\t\t\tconst resolved = await this._contextForResource(context.uri, true);\n\t\t\tcontext.value = resolved?.value;\n\t\t\tcontext.modelDescription = resolved?.modelDescription;\n\t\t\treturn context;\n\t\t} else if (item.provider.resolveChatContext) {\n\t\t\tconst resolved = await item.provider.resolveChatContext(item.originalItem, CancellationToken.None);\n\t\t\tif (resolved) {\n\t\t\t\tcontext.value = resolved.value;\n\t\t\t\tcontext.modelDescription = resolved.modelDescription;\n\t\t\t\treturn context;\n\t\t\t}\n\t\t}\n\t\treturn context;\n\t}\n\n\tprivate _asPicker(title: string, icon: ThemeIcon, id: string): IChatContextPickerItem {\n\t\tconst asPicker = (): IChatContextPicker => {\n\t\t\tlet providerEntry = this._providers.get(id);\n\t\t\tif (!providerEntry) {\n\t\t\t\tthrow new Error('No chat context provider registered');\n\t\t\t}\n\n\t\t\tconst picks = async (): Promise<IChatContextItem[]> => {\n\t\t\t\tif (providerEntry && !providerEntry.chatContextProvider) {\n\t\t\t\t\t// Activate the extension providing the chat context provider\n\t\t\t\t\tawait this._extensionService.activateByEvent(`onChatContextProvider:${id}`);\n\t\t\t\t\tproviderEntry = this._providers.get(id);\n\t\t\t\t\tif (!providerEntry?.chatContextProvider) {\n\t\t\t\t\t\treturn [];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tconst results = await providerEntry?.chatContextProvider!.provider.provideChatContext({}, CancellationToken.None);\n\t\t\t\treturn results || [];\n\t\t\t};\n\n\t\t\treturn {\n\t\t\t\tpicks: picks().then(items => {\n\t\t\t\t\treturn items.map(item => ({\n\t\t\t\t\t\tlabel: item.label,\n\t\t\t\t\t\ticonClass: ThemeIcon.asClassName(item.icon),\n\t\t\t\t\t\tasAttachment: async (): Promise<IGenericChatRequestVariableEntry> => {\n\t\t\t\t\t\t\tlet contextValue = item;\n\t\t\t\t\t\t\tif ((contextValue.value === undefined) && providerEntry?.chatContextProvider?.provider!.resolveChatContext) {\n\t\t\t\t\t\t\t\tcontextValue = await providerEntry.chatContextProvider.provider.resolveChatContext(item, CancellationToken.None);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tkind: 'generic',\n\t\t\t\t\t\t\t\tid: contextValue.label,\n\t\t\t\t\t\t\t\tname: contextValue.label,\n\t\t\t\t\t\t\t\ticon: contextValue.icon,\n\t\t\t\t\t\t\t\tvalue: contextValue.value\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t}),\n\t\t\t\tplaceholder: title\n\t\t\t};\n\t\t};\n\n\t\tconst picker: IChatContextPickerItem = {\n\t\t\tasPicker,\n\t\t\ttype: 'pickerPick',\n\t\t\tlabel: title,\n\t\t\ticon\n\t\t};\n\n\t\treturn picker;\n\t}\n}\n\nregisterSingleton(IChatContextService, ChatContextService, InstantiationType.Delayed);\n"]}