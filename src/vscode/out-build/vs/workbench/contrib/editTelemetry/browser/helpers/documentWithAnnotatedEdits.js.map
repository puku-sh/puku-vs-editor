{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/editTelemetry/browser/helpers/documentWithAnnotatedEdits.ts","vs/workbench/contrib/editTelemetry/browser/helpers/documentWithAnnotatedEdits.ts"],"names":[],"mappings":"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","file":"documentWithAnnotatedEdits.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { AsyncReader, AsyncReaderEndOfStream } from '../../../../../base/common/async.js';\nimport { CachedFunction } from '../../../../../base/common/cache.js';\nimport { Disposable, DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { IObservableWithChange, ISettableObservable, observableValue, runOnChange } from '../../../../../base/common/observable.js';\nimport { AnnotatedStringEdit, IEditData, StringEdit } from '../../../../../editor/common/core/edits/stringEdit.js';\nimport { StringText } from '../../../../../editor/common/core/text/abstractText.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { TextModelEditSource } from '../../../../../editor/common/textModelEditSource.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IObservableDocument } from './observableWorkspace.js';\nimport { iterateObservableChanges, mapObservableDelta } from './utils.js';\n\nexport interface IDocumentWithAnnotatedEdits<TEditData extends IEditData<TEditData> = EditKeySourceData> {\n\treadonly value: IObservableWithChange<StringText, { edit: AnnotatedStringEdit<TEditData> }>;\n\twaitForQueue(): Promise<void>;\n}\n\n/**\n * Creates a document that is a delayed copy of the original document,\n * but with edits annotated with the source of the edit.\n*/\nexport class DocumentWithSourceAnnotatedEdits extends Disposable implements IDocumentWithAnnotatedEdits<EditSourceData> {\n\tpublic readonly value: IObservableWithChange<StringText, { edit: AnnotatedStringEdit<EditSourceData> }>;\n\n\tconstructor(private readonly _originalDoc: IObservableDocument) {\n\t\tsuper();\n\n\t\tconst v = this.value = observableValue(this, _originalDoc.value.get());\n\n\t\tthis._register(runOnChange(this._originalDoc.value, (val, _prevVal, edits) => {\n\t\t\tconst eComposed = AnnotatedStringEdit.compose(edits.map(e => {\n\t\t\t\tconst editSourceData = new EditSourceData(e.reason);\n\t\t\t\treturn e.mapData(() => editSourceData);\n\t\t\t}));\n\n\t\t\tv.set(val, undefined, { edit: eComposed });\n\t\t}));\n\t}\n\n\tpublic waitForQueue(): Promise<void> {\n\t\treturn Promise.resolve();\n\t}\n}\n\n/**\n * Only joins touching edits if the source and the metadata is the same (e.g. requestUuids must be equal).\n*/\nexport class EditSourceData implements IEditData<EditSourceData> {\n\tpublic readonly source;\n\tpublic readonly key;\n\n\tconstructor(\n\t\tpublic readonly editSource: TextModelEditSource\n\t) {\n\t\tthis.key = this.editSource.toKey(1);\n\t\tthis.source = EditSourceBase.create(this.editSource);\n\t}\n\n\tjoin(data: EditSourceData): EditSourceData | undefined {\n\t\tif (this.editSource !== data.editSource) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this;\n\t}\n\n\ttoEditSourceData(): EditKeySourceData {\n\t\treturn new EditKeySourceData(this.key, this.source, this.editSource);\n\t}\n}\n\nexport class EditKeySourceData implements IEditData<EditKeySourceData> {\n\tconstructor(\n\t\tpublic readonly key: string,\n\t\tpublic readonly source: EditSource,\n\t\tpublic readonly representative: TextModelEditSource,\n\t) { }\n\n\tjoin(data: EditKeySourceData): EditKeySourceData | undefined {\n\t\tif (this.key !== data.key) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (this.source !== data.source) {\n\t\t\treturn undefined;\n\t\t}\n\t\t// The representatives could be different! (But equal modulo key)\n\t\treturn this;\n\t}\n}\n\nexport abstract class EditSourceBase {\n\tprivate static _cache = new CachedFunction({ getCacheKey: v => v.toString() }, (arg: EditSource) => arg);\n\n\tpublic static create(reason: TextModelEditSource): EditSource {\n\t\tconst data = reason.metadata;\n\t\tswitch (data.source) {\n\t\t\tcase 'reloadFromDisk':\n\t\t\t\treturn this._cache.get(new ExternalEditSource());\n\t\t\tcase 'inlineCompletionPartialAccept':\n\t\t\tcase 'inlineCompletionAccept': {\n\t\t\t\tconst type = 'type' in data ? data.type : undefined;\n\t\t\t\tif ('$nes' in data && data.$nes) {\n\t\t\t\t\treturn this._cache.get(new InlineSuggestEditSource('nes', data.$extensionId ?? '', data.$providerId ?? '', type));\n\t\t\t\t}\n\t\t\t\treturn this._cache.get(new InlineSuggestEditSource('completion', data.$extensionId ?? '', data.$providerId ?? '', type));\n\t\t\t}\n\t\t\tcase 'snippet':\n\t\t\t\treturn this._cache.get(new IdeEditSource('suggest'));\n\t\t\tcase 'unknown':\n\t\t\t\tif (!data.name) {\n\t\t\t\t\treturn this._cache.get(new UnknownEditSource());\n\t\t\t\t}\n\t\t\t\tswitch (data.name) {\n\t\t\t\t\tcase 'formatEditsCommand':\n\t\t\t\t\t\treturn this._cache.get(new IdeEditSource('format'));\n\t\t\t\t}\n\t\t\t\treturn this._cache.get(new UnknownEditSource());\n\n\t\t\tcase 'Chat.applyEdits':\n\t\t\t\treturn this._cache.get(new ChatEditSource('sidebar'));\n\t\t\tcase 'inlineChat.applyEdits':\n\t\t\t\treturn this._cache.get(new ChatEditSource('inline'));\n\t\t\tcase 'cursor':\n\t\t\t\treturn this._cache.get(new UserEditSource());\n\t\t\tdefault:\n\t\t\t\treturn this._cache.get(new UnknownEditSource());\n\t\t}\n\t}\n\n\tpublic abstract getColor(): string;\n}\n\nexport type EditSource = InlineSuggestEditSource | ChatEditSource | IdeEditSource | UserEditSource | UnknownEditSource | ExternalEditSource;\n\nexport class InlineSuggestEditSource extends EditSourceBase {\n\tpublic readonly category = 'ai';\n\tpublic readonly feature = 'inlineSuggest';\n\tconstructor(\n\t\tpublic readonly kind: 'completion' | 'nes',\n\t\tpublic readonly extensionId: string,\n\t\tpublic readonly providerId: string,\n\t\tpublic readonly type: 'word' | 'line' | undefined,\n\t) { super(); }\n\n\toverride toString() { return `${this.category}/${this.feature}/${this.kind}/${this.extensionId}/${this.type}`; }\n\n\tpublic getColor(): string { return '#00ff0033'; }\n}\n\nclass ChatEditSource extends EditSourceBase {\n\tpublic readonly category = 'ai';\n\tpublic readonly feature = 'chat';\n\tconstructor(\n\t\tpublic readonly kind: 'sidebar' | 'inline',\n\t) { super(); }\n\n\toverride toString() { return `${this.category}/${this.feature}/${this.kind}`; }\n\n\tpublic getColor(): string { return '#00ff0066'; }\n}\n\nclass IdeEditSource extends EditSourceBase {\n\tpublic readonly category = 'ide';\n\tconstructor(\n\t\tpublic readonly feature: 'suggest' | 'format' | string,\n\t) { super(); }\n\n\toverride toString() { return `${this.category}/${this.feature}`; }\n\n\tpublic getColor(): string { return this.feature === 'format' ? '#0000ff33' : '#80808033'; }\n}\n\nclass UserEditSource extends EditSourceBase {\n\tpublic readonly category = 'user';\n\tconstructor() { super(); }\n\n\toverride toString() { return this.category; }\n\n\tpublic getColor(): string { return '#d3d3d333'; }\n}\n\n/** Caused by external tools that trigger a reload from disk */\nclass ExternalEditSource extends EditSourceBase {\n\tpublic readonly category = 'external';\n\tconstructor() { super(); }\n\n\toverride toString() { return this.category; }\n\n\tpublic getColor(): string { return '#009ab254'; }\n}\n\nclass UnknownEditSource extends EditSourceBase {\n\tpublic readonly category = 'unknown';\n\tconstructor() { super(); }\n\n\toverride toString() { return this.category; }\n\n\tpublic getColor(): string { return '#ff000033'; }\n}\n\nexport class CombineStreamedChanges<TEditData extends (EditKeySourceData | EditSourceData) & IEditData<TEditData>> extends Disposable implements IDocumentWithAnnotatedEdits<TEditData> {\n\tprivate readonly _value: ISettableObservable<StringText, { edit: AnnotatedStringEdit<TEditData> }>;\n\treadonly value: IObservableWithChange<StringText, { edit: AnnotatedStringEdit<TEditData> }>;\n\tprivate readonly _runStore = this._register(new DisposableStore());\n\tprivate _runQueue: Promise<void> = Promise.resolve();\n\n\tprivate readonly _diffService: DiffService;\n\n\tconstructor(\n\t\tprivate readonly _originalDoc: IDocumentWithAnnotatedEdits<TEditData>,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tthis._diffService = this._instantiationService.createInstance(DiffService);\n\t\tthis.value = this._value = observableValue(this, _originalDoc.value.get());\n\t\tthis._restart();\n\n\t}\n\n\tasync _restart(): Promise<void> {\n\t\tthis._runStore.clear();\n\t\tconst iterator = iterateObservableChanges(this._originalDoc.value, this._runStore)[Symbol.asyncIterator]();\n\t\tconst p = this._runQueue;\n\t\tthis._runQueue = this._runQueue.then(() => this._run(iterator));\n\t\tawait p;\n\t}\n\n\tprivate async _run(iterator: AsyncIterator<{ value: StringText; prevValue: StringText; change: { edit: AnnotatedStringEdit<TEditData> }[] }, any, any>) {\n\t\tconst reader = new AsyncReader(iterator);\n\t\twhile (true) {\n\t\t\tlet peeked = await reader.peek();\n\t\t\tif (peeked === AsyncReaderEndOfStream) {\n\t\t\t\treturn;\n\t\t\t} else if (isChatEdit(peeked)) {\n\t\t\t\tconst first = peeked;\n\n\t\t\t\tlet last = first;\n\t\t\t\tlet chatEdit = AnnotatedStringEdit.empty as AnnotatedStringEdit<TEditData>;\n\n\t\t\t\tdo {\n\t\t\t\t\treader.readBufferedOrThrow();\n\t\t\t\t\tlast = peeked;\n\t\t\t\t\tchatEdit = chatEdit.compose(AnnotatedStringEdit.compose(peeked.change.map(c => c.edit)));\n\t\t\t\t\tconst peekedOrUndefined = await reader.peekTimeout(1000);\n\t\t\t\t\tif (!peekedOrUndefined) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tpeeked = peekedOrUndefined;\n\t\t\t\t} while (peeked !== AsyncReaderEndOfStream && isChatEdit(peeked));\n\n\t\t\t\tif (!chatEdit.isEmpty()) {\n\t\t\t\t\tconst data = chatEdit.replacements[0].data;\n\t\t\t\t\tconst diffEdit = await this._diffService.computeDiff(first.prevValue.value, last.value.value);\n\t\t\t\t\tconst edit = diffEdit.mapData(_e => data);\n\t\t\t\t\tthis._value.set(last.value, undefined, { edit });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treader.readBufferedOrThrow();\n\t\t\t\tconst e = AnnotatedStringEdit.compose(peeked.change.map(c => c.edit));\n\t\t\t\tthis._value.set(peeked.value, undefined, { edit: e });\n\t\t\t}\n\t\t}\n\t}\n\n\tasync waitForQueue(): Promise<void> {\n\t\tawait this._originalDoc.waitForQueue();\n\t\tawait this._restart();\n\t}\n}\n\nexport class DiffService {\n\tconstructor(\n\t\t@IEditorWorkerService private readonly _editorWorkerService: IEditorWorkerService,\n\t) {\n\t}\n\n\tpublic async computeDiff(original: string, modified: string): Promise<StringEdit> {\n\t\tconst diffEdit = await this._editorWorkerService.computeStringEditFromDiff(original, modified, { maxComputationTimeMs: 500 }, 'advanced');\n\t\treturn diffEdit;\n\t}\n}\n\nfunction isChatEdit(next: { value: StringText; change: { edit: AnnotatedStringEdit<EditKeySourceData | EditSourceData> }[] }) {\n\treturn next.change.every(c => c.edit.replacements.every(e => {\n\t\tif (e.data.source.category === 'ai' && e.data.source.feature === 'chat') {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}));\n}\n\nexport class MinimizeEditsProcessor<TEditData extends IEditData<TEditData>> extends Disposable implements IDocumentWithAnnotatedEdits<TEditData> {\n\treadonly value: IObservableWithChange<StringText, { edit: AnnotatedStringEdit<TEditData> }>;\n\n\tconstructor(\n\t\tprivate readonly _originalDoc: IDocumentWithAnnotatedEdits<TEditData>,\n\t) {\n\t\tsuper();\n\n\t\tconst v = this.value = observableValue(this, _originalDoc.value.get());\n\n\t\tlet prevValue: string = this._originalDoc.value.get().value;\n\t\tthis._register(runOnChange(this._originalDoc.value, (val, _prevVal, edits) => {\n\t\t\tconst eComposed = AnnotatedStringEdit.compose(edits.map(e => e.edit));\n\n\t\t\tconst e = eComposed.removeCommonSuffixAndPrefix(prevValue);\n\t\t\tprevValue = val.value;\n\n\t\t\tv.set(val, undefined, { edit: e });\n\t\t}));\n\t}\n\n\tasync waitForQueue(): Promise<void> {\n\t\tawait this._originalDoc.waitForQueue();\n\t}\n}\n\n/**\n * Removing the metadata allows touching edits from the same source to merged, even if they were caused by different actions (e.g. two user edits).\n */\nexport function createDocWithJustReason(docWithAnnotatedEdits: IDocumentWithAnnotatedEdits<EditSourceData>, store: DisposableStore): IDocumentWithAnnotatedEdits<EditKeySourceData> {\n\tconst docWithJustReason: IDocumentWithAnnotatedEdits<EditKeySourceData> = {\n\t\tvalue: mapObservableDelta(docWithAnnotatedEdits.value, edit => ({ edit: edit.edit.mapData(d => d.data.toEditSourceData()) }), store),\n\t\twaitForQueue: () => docWithAnnotatedEdits.waitForQueue(),\n\t};\n\treturn docWithJustReason;\n}\n\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { AsyncReader, AsyncReaderEndOfStream } from '../../../../../base/common/async.js';\nimport { CachedFunction } from '../../../../../base/common/cache.js';\nimport { Disposable, DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { IObservableWithChange, ISettableObservable, observableValue, runOnChange } from '../../../../../base/common/observable.js';\nimport { AnnotatedStringEdit, IEditData, StringEdit } from '../../../../../editor/common/core/edits/stringEdit.js';\nimport { StringText } from '../../../../../editor/common/core/text/abstractText.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { TextModelEditSource } from '../../../../../editor/common/textModelEditSource.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IObservableDocument } from './observableWorkspace.js';\nimport { iterateObservableChanges, mapObservableDelta } from './utils.js';\n\nexport interface IDocumentWithAnnotatedEdits<TEditData extends IEditData<TEditData> = EditKeySourceData> {\n\treadonly value: IObservableWithChange<StringText, { edit: AnnotatedStringEdit<TEditData> }>;\n\twaitForQueue(): Promise<void>;\n}\n\n/**\n * Creates a document that is a delayed copy of the original document,\n * but with edits annotated with the source of the edit.\n*/\nexport class DocumentWithSourceAnnotatedEdits extends Disposable implements IDocumentWithAnnotatedEdits<EditSourceData> {\n\tpublic readonly value: IObservableWithChange<StringText, { edit: AnnotatedStringEdit<EditSourceData> }>;\n\n\tconstructor(private readonly _originalDoc: IObservableDocument) {\n\t\tsuper();\n\n\t\tconst v = this.value = observableValue(this, _originalDoc.value.get());\n\n\t\tthis._register(runOnChange(this._originalDoc.value, (val, _prevVal, edits) => {\n\t\t\tconst eComposed = AnnotatedStringEdit.compose(edits.map(e => {\n\t\t\t\tconst editSourceData = new EditSourceData(e.reason);\n\t\t\t\treturn e.mapData(() => editSourceData);\n\t\t\t}));\n\n\t\t\tv.set(val, undefined, { edit: eComposed });\n\t\t}));\n\t}\n\n\tpublic waitForQueue(): Promise<void> {\n\t\treturn Promise.resolve();\n\t}\n}\n\n/**\n * Only joins touching edits if the source and the metadata is the same (e.g. requestUuids must be equal).\n*/\nexport class EditSourceData implements IEditData<EditSourceData> {\n\tpublic readonly source;\n\tpublic readonly key;\n\n\tconstructor(\n\t\tpublic readonly editSource: TextModelEditSource\n\t) {\n\t\tthis.key = this.editSource.toKey(1);\n\t\tthis.source = EditSourceBase.create(this.editSource);\n\t}\n\n\tjoin(data: EditSourceData): EditSourceData | undefined {\n\t\tif (this.editSource !== data.editSource) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this;\n\t}\n\n\ttoEditSourceData(): EditKeySourceData {\n\t\treturn new EditKeySourceData(this.key, this.source, this.editSource);\n\t}\n}\n\nexport class EditKeySourceData implements IEditData<EditKeySourceData> {\n\tconstructor(\n\t\tpublic readonly key: string,\n\t\tpublic readonly source: EditSource,\n\t\tpublic readonly representative: TextModelEditSource,\n\t) { }\n\n\tjoin(data: EditKeySourceData): EditKeySourceData | undefined {\n\t\tif (this.key !== data.key) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (this.source !== data.source) {\n\t\t\treturn undefined;\n\t\t}\n\t\t// The representatives could be different! (But equal modulo key)\n\t\treturn this;\n\t}\n}\n\nexport abstract class EditSourceBase {\n\tprivate static _cache = new CachedFunction({ getCacheKey: v => v.toString() }, (arg: EditSource) => arg);\n\n\tpublic static create(reason: TextModelEditSource): EditSource {\n\t\tconst data = reason.metadata;\n\t\tswitch (data.source) {\n\t\t\tcase 'reloadFromDisk':\n\t\t\t\treturn this._cache.get(new ExternalEditSource());\n\t\t\tcase 'inlineCompletionPartialAccept':\n\t\t\tcase 'inlineCompletionAccept': {\n\t\t\t\tconst type = 'type' in data ? data.type : undefined;\n\t\t\t\tif ('$nes' in data && data.$nes) {\n\t\t\t\t\treturn this._cache.get(new InlineSuggestEditSource('nes', data.$extensionId ?? '', data.$providerId ?? '', type));\n\t\t\t\t}\n\t\t\t\treturn this._cache.get(new InlineSuggestEditSource('completion', data.$extensionId ?? '', data.$providerId ?? '', type));\n\t\t\t}\n\t\t\tcase 'snippet':\n\t\t\t\treturn this._cache.get(new IdeEditSource('suggest'));\n\t\t\tcase 'unknown':\n\t\t\t\tif (!data.name) {\n\t\t\t\t\treturn this._cache.get(new UnknownEditSource());\n\t\t\t\t}\n\t\t\t\tswitch (data.name) {\n\t\t\t\t\tcase 'formatEditsCommand':\n\t\t\t\t\t\treturn this._cache.get(new IdeEditSource('format'));\n\t\t\t\t}\n\t\t\t\treturn this._cache.get(new UnknownEditSource());\n\n\t\t\tcase 'Chat.applyEdits':\n\t\t\t\treturn this._cache.get(new ChatEditSource('sidebar'));\n\t\t\tcase 'inlineChat.applyEdits':\n\t\t\t\treturn this._cache.get(new ChatEditSource('inline'));\n\t\t\tcase 'cursor':\n\t\t\t\treturn this._cache.get(new UserEditSource());\n\t\t\tdefault:\n\t\t\t\treturn this._cache.get(new UnknownEditSource());\n\t\t}\n\t}\n\n\tpublic abstract getColor(): string;\n}\n\nexport type EditSource = InlineSuggestEditSource | ChatEditSource | IdeEditSource | UserEditSource | UnknownEditSource | ExternalEditSource;\n\nexport class InlineSuggestEditSource extends EditSourceBase {\n\tpublic readonly category = 'ai';\n\tpublic readonly feature = 'inlineSuggest';\n\tconstructor(\n\t\tpublic readonly kind: 'completion' | 'nes',\n\t\tpublic readonly extensionId: string,\n\t\tpublic readonly providerId: string,\n\t\tpublic readonly type: 'word' | 'line' | undefined,\n\t) { super(); }\n\n\toverride toString() { return `${this.category}/${this.feature}/${this.kind}/${this.extensionId}/${this.type}`; }\n\n\tpublic getColor(): string { return '#00ff0033'; }\n}\n\nclass ChatEditSource extends EditSourceBase {\n\tpublic readonly category = 'ai';\n\tpublic readonly feature = 'chat';\n\tconstructor(\n\t\tpublic readonly kind: 'sidebar' | 'inline',\n\t) { super(); }\n\n\toverride toString() { return `${this.category}/${this.feature}/${this.kind}`; }\n\n\tpublic getColor(): string { return '#00ff0066'; }\n}\n\nclass IdeEditSource extends EditSourceBase {\n\tpublic readonly category = 'ide';\n\tconstructor(\n\t\tpublic readonly feature: 'suggest' | 'format' | string,\n\t) { super(); }\n\n\toverride toString() { return `${this.category}/${this.feature}`; }\n\n\tpublic getColor(): string { return this.feature === 'format' ? '#0000ff33' : '#80808033'; }\n}\n\nclass UserEditSource extends EditSourceBase {\n\tpublic readonly category = 'user';\n\tconstructor() { super(); }\n\n\toverride toString() { return this.category; }\n\n\tpublic getColor(): string { return '#d3d3d333'; }\n}\n\n/** Caused by external tools that trigger a reload from disk */\nclass ExternalEditSource extends EditSourceBase {\n\tpublic readonly category = 'external';\n\tconstructor() { super(); }\n\n\toverride toString() { return this.category; }\n\n\tpublic getColor(): string { return '#009ab254'; }\n}\n\nclass UnknownEditSource extends EditSourceBase {\n\tpublic readonly category = 'unknown';\n\tconstructor() { super(); }\n\n\toverride toString() { return this.category; }\n\n\tpublic getColor(): string { return '#ff000033'; }\n}\n\nexport class CombineStreamedChanges<TEditData extends (EditKeySourceData | EditSourceData) & IEditData<TEditData>> extends Disposable implements IDocumentWithAnnotatedEdits<TEditData> {\n\tprivate readonly _value: ISettableObservable<StringText, { edit: AnnotatedStringEdit<TEditData> }>;\n\treadonly value: IObservableWithChange<StringText, { edit: AnnotatedStringEdit<TEditData> }>;\n\tprivate readonly _runStore = this._register(new DisposableStore());\n\tprivate _runQueue: Promise<void> = Promise.resolve();\n\n\tprivate readonly _diffService: DiffService;\n\n\tconstructor(\n\t\tprivate readonly _originalDoc: IDocumentWithAnnotatedEdits<TEditData>,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tthis._diffService = this._instantiationService.createInstance(DiffService);\n\t\tthis.value = this._value = observableValue(this, _originalDoc.value.get());\n\t\tthis._restart();\n\n\t}\n\n\tasync _restart(): Promise<void> {\n\t\tthis._runStore.clear();\n\t\tconst iterator = iterateObservableChanges(this._originalDoc.value, this._runStore)[Symbol.asyncIterator]();\n\t\tconst p = this._runQueue;\n\t\tthis._runQueue = this._runQueue.then(() => this._run(iterator));\n\t\tawait p;\n\t}\n\n\tprivate async _run(iterator: AsyncIterator<{ value: StringText; prevValue: StringText; change: { edit: AnnotatedStringEdit<TEditData> }[] }, any, any>) {\n\t\tconst reader = new AsyncReader(iterator);\n\t\twhile (true) {\n\t\t\tlet peeked = await reader.peek();\n\t\t\tif (peeked === AsyncReaderEndOfStream) {\n\t\t\t\treturn;\n\t\t\t} else if (isChatEdit(peeked)) {\n\t\t\t\tconst first = peeked;\n\n\t\t\t\tlet last = first;\n\t\t\t\tlet chatEdit = AnnotatedStringEdit.empty as AnnotatedStringEdit<TEditData>;\n\n\t\t\t\tdo {\n\t\t\t\t\treader.readBufferedOrThrow();\n\t\t\t\t\tlast = peeked;\n\t\t\t\t\tchatEdit = chatEdit.compose(AnnotatedStringEdit.compose(peeked.change.map(c => c.edit)));\n\t\t\t\t\tconst peekedOrUndefined = await reader.peekTimeout(1000);\n\t\t\t\t\tif (!peekedOrUndefined) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tpeeked = peekedOrUndefined;\n\t\t\t\t} while (peeked !== AsyncReaderEndOfStream && isChatEdit(peeked));\n\n\t\t\t\tif (!chatEdit.isEmpty()) {\n\t\t\t\t\tconst data = chatEdit.replacements[0].data;\n\t\t\t\t\tconst diffEdit = await this._diffService.computeDiff(first.prevValue.value, last.value.value);\n\t\t\t\t\tconst edit = diffEdit.mapData(_e => data);\n\t\t\t\t\tthis._value.set(last.value, undefined, { edit });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treader.readBufferedOrThrow();\n\t\t\t\tconst e = AnnotatedStringEdit.compose(peeked.change.map(c => c.edit));\n\t\t\t\tthis._value.set(peeked.value, undefined, { edit: e });\n\t\t\t}\n\t\t}\n\t}\n\n\tasync waitForQueue(): Promise<void> {\n\t\tawait this._originalDoc.waitForQueue();\n\t\tawait this._restart();\n\t}\n}\n\nexport class DiffService {\n\tconstructor(\n\t\t@IEditorWorkerService private readonly _editorWorkerService: IEditorWorkerService,\n\t) {\n\t}\n\n\tpublic async computeDiff(original: string, modified: string): Promise<StringEdit> {\n\t\tconst diffEdit = await this._editorWorkerService.computeStringEditFromDiff(original, modified, { maxComputationTimeMs: 500 }, 'advanced');\n\t\treturn diffEdit;\n\t}\n}\n\nfunction isChatEdit(next: { value: StringText; change: { edit: AnnotatedStringEdit<EditKeySourceData | EditSourceData> }[] }) {\n\treturn next.change.every(c => c.edit.replacements.every(e => {\n\t\tif (e.data.source.category === 'ai' && e.data.source.feature === 'chat') {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}));\n}\n\nexport class MinimizeEditsProcessor<TEditData extends IEditData<TEditData>> extends Disposable implements IDocumentWithAnnotatedEdits<TEditData> {\n\treadonly value: IObservableWithChange<StringText, { edit: AnnotatedStringEdit<TEditData> }>;\n\n\tconstructor(\n\t\tprivate readonly _originalDoc: IDocumentWithAnnotatedEdits<TEditData>,\n\t) {\n\t\tsuper();\n\n\t\tconst v = this.value = observableValue(this, _originalDoc.value.get());\n\n\t\tlet prevValue: string = this._originalDoc.value.get().value;\n\t\tthis._register(runOnChange(this._originalDoc.value, (val, _prevVal, edits) => {\n\t\t\tconst eComposed = AnnotatedStringEdit.compose(edits.map(e => e.edit));\n\n\t\t\tconst e = eComposed.removeCommonSuffixAndPrefix(prevValue);\n\t\t\tprevValue = val.value;\n\n\t\t\tv.set(val, undefined, { edit: e });\n\t\t}));\n\t}\n\n\tasync waitForQueue(): Promise<void> {\n\t\tawait this._originalDoc.waitForQueue();\n\t}\n}\n\n/**\n * Removing the metadata allows touching edits from the same source to merged, even if they were caused by different actions (e.g. two user edits).\n */\nexport function createDocWithJustReason(docWithAnnotatedEdits: IDocumentWithAnnotatedEdits<EditSourceData>, store: DisposableStore): IDocumentWithAnnotatedEdits<EditKeySourceData> {\n\tconst docWithJustReason: IDocumentWithAnnotatedEdits<EditKeySourceData> = {\n\t\tvalue: mapObservableDelta(docWithAnnotatedEdits.value, edit => ({ edit: edit.edit.mapData(d => d.data.toEditSourceData()) }), store),\n\t\twaitForQueue: () => docWithAnnotatedEdits.waitForQueue(),\n\t};\n\treturn docWithJustReason;\n}\n\n"]}