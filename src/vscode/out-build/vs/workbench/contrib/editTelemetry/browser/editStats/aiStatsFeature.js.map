{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/editTelemetry/browser/editStats/aiStatsFeature.ts","vs/workbench/contrib/editTelemetry/browser/editStats/aiStatsFeature.ts"],"names":[],"mappings":"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","file":"aiStatsFeature.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { sumBy } from '../../../../../base/common/arrays.js';\nimport { TaskQueue, timeout } from '../../../../../base/common/async.js';\nimport { Lazy } from '../../../../../base/common/lazy.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { autorun, derived, mapObservableArrayCached, observableValue, runOnChange } from '../../../../../base/common/observable.js';\nimport { AnnotatedStringEdit } from '../../../../../editor/common/core/edits/stringEdit.js';\nimport { isAiEdit, isUserEdit } from '../../../../../editor/common/textModelEditSource.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../platform/storage/common/storage.js';\nimport { AnnotatedDocuments } from '../helpers/annotatedDocuments.js';\nimport { AiStatsStatusBar } from './aiStatsStatusBar.js';\n\nexport class AiStatsFeature extends Disposable {\n\tprivate readonly _data: IValue<IData>;\n\tprivate readonly _dataVersion = observableValue(this, 0);\n\n\tconstructor(\n\t\tannotatedDocuments: AnnotatedDocuments,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tconst storedValue = getStoredValue<IData>(this._storageService, 'aiStats', StorageScope.WORKSPACE, StorageTarget.USER);\n\t\tthis._data = rateLimitWrite<IData>(storedValue, 1 / 60, this._store);\n\n\t\tthis.aiRate.recomputeInitiallyAndOnChange(this._store);\n\n\t\tthis._register(autorun(reader => {\n\t\t\treader.store.add(this._instantiationService.createInstance(AiStatsStatusBar.hot.read(reader), this));\n\t\t}));\n\n\n\t\tconst lastRequestIds: string[] = [];\n\n\t\tconst obs = mapObservableArrayCached(this, annotatedDocuments.documents, (doc, store) => {\n\t\t\tstore.add(runOnChange(doc.documentWithAnnotations.value, (_val, _prev, edit) => {\n\t\t\t\tconst e = AnnotatedStringEdit.compose(edit.map(e => e.edit));\n\n\t\t\t\tconst curSession = new Lazy(() => this._getDataAndSession());\n\n\t\t\t\tfor (const r of e.replacements) {\n\t\t\t\t\tif (isAiEdit(r.data.editSource)) {\n\t\t\t\t\t\tcurSession.value.currentSession.aiCharacters += r.newText.length;\n\t\t\t\t\t} else if (isUserEdit(r.data.editSource)) {\n\t\t\t\t\t\tcurSession.value.currentSession.typedCharacters += r.newText.length;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (e.replacements.length > 0) {\n\t\t\t\t\tconst sessionToUpdate = curSession.value.currentSession;\n\t\t\t\t\tconst s = e.replacements[0].data.editSource;\n\t\t\t\t\tif (s.metadata.source === 'inlineCompletionAccept') {\n\t\t\t\t\t\tif (sessionToUpdate.acceptedInlineSuggestions === undefined) {\n\t\t\t\t\t\t\tsessionToUpdate.acceptedInlineSuggestions = 0;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsessionToUpdate.acceptedInlineSuggestions += 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (s.metadata.source === 'Chat.applyEdits' && s.metadata.$$requestId !== undefined) {\n\t\t\t\t\t\tconst didSeeRequestId = lastRequestIds.includes(s.metadata.$$requestId);\n\t\t\t\t\t\tif (!didSeeRequestId) {\n\t\t\t\t\t\t\tlastRequestIds.push(s.metadata.$$requestId);\n\t\t\t\t\t\t\tif (lastRequestIds.length > 10) {\n\t\t\t\t\t\t\t\tlastRequestIds.shift();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (sessionToUpdate.chatEditCount === undefined) {\n\t\t\t\t\t\t\t\tsessionToUpdate.chatEditCount = 0;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tsessionToUpdate.chatEditCount += 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (curSession.hasValue) {\n\t\t\t\t\tthis._data.writeValue(curSession.value.data);\n\t\t\t\t\tthis._dataVersion.set(this._dataVersion.get() + 1, undefined);\n\t\t\t\t}\n\t\t\t}));\n\t\t});\n\n\t\tobs.recomputeInitiallyAndOnChange(this._store);\n\t}\n\n\tpublic readonly aiRate = this._dataVersion.map(() => {\n\t\tconst val = this._data.getValue();\n\t\tif (!val) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst r = average(val.sessions, session => {\n\t\t\tconst sum = session.typedCharacters + session.aiCharacters;\n\t\t\tif (sum === 0) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\treturn session.aiCharacters / sum;\n\t\t});\n\n\t\treturn r;\n\t});\n\n\tpublic readonly sessionCount = derived(this, r => {\n\t\tthis._dataVersion.read(r);\n\t\tconst val = this._data.getValue();\n\t\tif (!val) {\n\t\t\treturn 0;\n\t\t}\n\t\treturn val.sessions.length;\n\t});\n\n\tpublic readonly acceptedInlineSuggestionsToday = derived(this, r => {\n\t\tthis._dataVersion.read(r);\n\t\tconst val = this._data.getValue();\n\t\tif (!val) {\n\t\t\treturn 0;\n\t\t}\n\t\tconst startOfToday = new Date();\n\t\tstartOfToday.setHours(0, 0, 0, 0);\n\n\t\tconst sessionsToday = val.sessions.filter(s => s.startTime > startOfToday.getTime());\n\t\treturn sumBy(sessionsToday, s => s.acceptedInlineSuggestions ?? 0);\n\t});\n\n\tprivate _getDataAndSession(): { data: IData; currentSession: ISession } {\n\t\tconst state = this._data.getValue() ?? { sessions: [] };\n\n\t\tconst sessionLengthMs = 5 * 60 * 1000; // 5 minutes\n\n\t\tlet lastSession = state.sessions.at(-1);\n\t\tconst nowTime = Date.now();\n\t\tif (!lastSession || nowTime - lastSession.startTime > sessionLengthMs) {\n\t\t\tstate.sessions.push({\n\t\t\t\tstartTime: nowTime,\n\t\t\t\ttypedCharacters: 0,\n\t\t\t\taiCharacters: 0,\n\t\t\t\tacceptedInlineSuggestions: 0,\n\t\t\t\tchatEditCount: 0,\n\t\t\t});\n\t\t\tlastSession = state.sessions.at(-1)!;\n\n\t\t\tconst dayMs = 24 * 60 * 60 * 1000; // 24h\n\t\t\t// Clean up old sessions, keep only the last 24h worth of sessions\n\t\t\twhile (state.sessions.length > dayMs / sessionLengthMs) {\n\t\t\t\tstate.sessions.shift();\n\t\t\t}\n\t\t}\n\t\treturn { data: state, currentSession: lastSession };\n\t}\n}\n\ninterface IData {\n\tsessions: ISession[];\n}\n\n// 5 min window\ninterface ISession {\n\tstartTime: number;\n\ttypedCharacters: number;\n\taiCharacters: number;\n\tacceptedInlineSuggestions: number | undefined;\n\tchatEditCount: number | undefined;\n}\n\n\nfunction average<T>(arr: T[], selector: (item: T) => number): number {\n\tif (arr.length === 0) {\n\t\treturn 0;\n\t}\n\tconst s = sumBy(arr, selector);\n\treturn s / arr.length;\n}\n\n\ninterface IValue<T> {\n\twriteValue(value: T | undefined): void;\n\tgetValue(): T | undefined;\n}\n\nfunction rateLimitWrite<T>(targetValue: IValue<T>, maxWritesPerSecond: number, store: DisposableStore): IValue<T> {\n\tconst queue = new TaskQueue();\n\tlet _value: T | undefined = undefined;\n\tlet valueVersion = 0;\n\tlet savedVersion = 0;\n\tstore.add(toDisposable(() => {\n\t\tif (valueVersion !== savedVersion) {\n\t\t\ttargetValue.writeValue(_value);\n\t\t\tsavedVersion = valueVersion;\n\t\t}\n\t}));\n\n\treturn {\n\t\twriteValue(value: T | undefined): void {\n\t\t\tvalueVersion++;\n\t\t\tconst v = valueVersion;\n\t\t\t_value = value;\n\n\t\t\tqueue.clearPending();\n\t\t\tqueue.schedule(async () => {\n\t\t\t\ttargetValue.writeValue(value);\n\t\t\t\tsavedVersion = v;\n\t\t\t\tawait timeout(5000);\n\t\t\t});\n\t\t},\n\t\tgetValue(): T | undefined {\n\t\t\tif (valueVersion > 0) {\n\t\t\t\treturn _value;\n\t\t\t}\n\t\t\treturn targetValue.getValue();\n\t\t}\n\t};\n}\n\nfunction getStoredValue<T>(service: IStorageService, key: string, scope: StorageScope, target: StorageTarget): IValue<T> {\n\tlet lastValue: T | undefined = undefined;\n\tlet hasLastValue = false;\n\treturn {\n\t\twriteValue(value: T | undefined): void {\n\t\t\tif (value === undefined) {\n\t\t\t\tservice.remove(key, scope);\n\t\t\t} else {\n\t\t\t\tservice.store(key, JSON.stringify(value), scope, target);\n\t\t\t}\n\t\t\tlastValue = value;\n\t\t},\n\t\tgetValue(): T | undefined {\n\t\t\tif (hasLastValue) {\n\t\t\t\treturn lastValue;\n\t\t\t}\n\t\t\tconst strVal = service.get(key, scope);\n\t\t\tlastValue = strVal === undefined ? undefined : JSON.parse(strVal) as T | undefined;\n\t\t\thasLastValue = true;\n\t\t\treturn lastValue;\n\t\t}\n\t};\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { sumBy } from '../../../../../base/common/arrays.js';\nimport { TaskQueue, timeout } from '../../../../../base/common/async.js';\nimport { Lazy } from '../../../../../base/common/lazy.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../../../base/common/lifecycle.js';\nimport { autorun, derived, mapObservableArrayCached, observableValue, runOnChange } from '../../../../../base/common/observable.js';\nimport { AnnotatedStringEdit } from '../../../../../editor/common/core/edits/stringEdit.js';\nimport { isAiEdit, isUserEdit } from '../../../../../editor/common/textModelEditSource.js';\nimport { IInstantiationService } from '../../../../../platform/instantiation/common/instantiation.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../../platform/storage/common/storage.js';\nimport { AnnotatedDocuments } from '../helpers/annotatedDocuments.js';\nimport { AiStatsStatusBar } from './aiStatsStatusBar.js';\n\nexport class AiStatsFeature extends Disposable {\n\tprivate readonly _data: IValue<IData>;\n\tprivate readonly _dataVersion = observableValue(this, 0);\n\n\tconstructor(\n\t\tannotatedDocuments: AnnotatedDocuments,\n\t\t@IStorageService private readonly _storageService: IStorageService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\n\t\tconst storedValue = getStoredValue<IData>(this._storageService, 'aiStats', StorageScope.WORKSPACE, StorageTarget.USER);\n\t\tthis._data = rateLimitWrite<IData>(storedValue, 1 / 60, this._store);\n\n\t\tthis.aiRate.recomputeInitiallyAndOnChange(this._store);\n\n\t\tthis._register(autorun(reader => {\n\t\t\treader.store.add(this._instantiationService.createInstance(AiStatsStatusBar.hot.read(reader), this));\n\t\t}));\n\n\n\t\tconst lastRequestIds: string[] = [];\n\n\t\tconst obs = mapObservableArrayCached(this, annotatedDocuments.documents, (doc, store) => {\n\t\t\tstore.add(runOnChange(doc.documentWithAnnotations.value, (_val, _prev, edit) => {\n\t\t\t\tconst e = AnnotatedStringEdit.compose(edit.map(e => e.edit));\n\n\t\t\t\tconst curSession = new Lazy(() => this._getDataAndSession());\n\n\t\t\t\tfor (const r of e.replacements) {\n\t\t\t\t\tif (isAiEdit(r.data.editSource)) {\n\t\t\t\t\t\tcurSession.value.currentSession.aiCharacters += r.newText.length;\n\t\t\t\t\t} else if (isUserEdit(r.data.editSource)) {\n\t\t\t\t\t\tcurSession.value.currentSession.typedCharacters += r.newText.length;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (e.replacements.length > 0) {\n\t\t\t\t\tconst sessionToUpdate = curSession.value.currentSession;\n\t\t\t\t\tconst s = e.replacements[0].data.editSource;\n\t\t\t\t\tif (s.metadata.source === 'inlineCompletionAccept') {\n\t\t\t\t\t\tif (sessionToUpdate.acceptedInlineSuggestions === undefined) {\n\t\t\t\t\t\t\tsessionToUpdate.acceptedInlineSuggestions = 0;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tsessionToUpdate.acceptedInlineSuggestions += 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (s.metadata.source === 'Chat.applyEdits' && s.metadata.$$requestId !== undefined) {\n\t\t\t\t\t\tconst didSeeRequestId = lastRequestIds.includes(s.metadata.$$requestId);\n\t\t\t\t\t\tif (!didSeeRequestId) {\n\t\t\t\t\t\t\tlastRequestIds.push(s.metadata.$$requestId);\n\t\t\t\t\t\t\tif (lastRequestIds.length > 10) {\n\t\t\t\t\t\t\t\tlastRequestIds.shift();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (sessionToUpdate.chatEditCount === undefined) {\n\t\t\t\t\t\t\t\tsessionToUpdate.chatEditCount = 0;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tsessionToUpdate.chatEditCount += 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (curSession.hasValue) {\n\t\t\t\t\tthis._data.writeValue(curSession.value.data);\n\t\t\t\t\tthis._dataVersion.set(this._dataVersion.get() + 1, undefined);\n\t\t\t\t}\n\t\t\t}));\n\t\t});\n\n\t\tobs.recomputeInitiallyAndOnChange(this._store);\n\t}\n\n\tpublic readonly aiRate = this._dataVersion.map(() => {\n\t\tconst val = this._data.getValue();\n\t\tif (!val) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst r = average(val.sessions, session => {\n\t\t\tconst sum = session.typedCharacters + session.aiCharacters;\n\t\t\tif (sum === 0) {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\treturn session.aiCharacters / sum;\n\t\t});\n\n\t\treturn r;\n\t});\n\n\tpublic readonly sessionCount = derived(this, r => {\n\t\tthis._dataVersion.read(r);\n\t\tconst val = this._data.getValue();\n\t\tif (!val) {\n\t\t\treturn 0;\n\t\t}\n\t\treturn val.sessions.length;\n\t});\n\n\tpublic readonly acceptedInlineSuggestionsToday = derived(this, r => {\n\t\tthis._dataVersion.read(r);\n\t\tconst val = this._data.getValue();\n\t\tif (!val) {\n\t\t\treturn 0;\n\t\t}\n\t\tconst startOfToday = new Date();\n\t\tstartOfToday.setHours(0, 0, 0, 0);\n\n\t\tconst sessionsToday = val.sessions.filter(s => s.startTime > startOfToday.getTime());\n\t\treturn sumBy(sessionsToday, s => s.acceptedInlineSuggestions ?? 0);\n\t});\n\n\tprivate _getDataAndSession(): { data: IData; currentSession: ISession } {\n\t\tconst state = this._data.getValue() ?? { sessions: [] };\n\n\t\tconst sessionLengthMs = 5 * 60 * 1000; // 5 minutes\n\n\t\tlet lastSession = state.sessions.at(-1);\n\t\tconst nowTime = Date.now();\n\t\tif (!lastSession || nowTime - lastSession.startTime > sessionLengthMs) {\n\t\t\tstate.sessions.push({\n\t\t\t\tstartTime: nowTime,\n\t\t\t\ttypedCharacters: 0,\n\t\t\t\taiCharacters: 0,\n\t\t\t\tacceptedInlineSuggestions: 0,\n\t\t\t\tchatEditCount: 0,\n\t\t\t});\n\t\t\tlastSession = state.sessions.at(-1)!;\n\n\t\t\tconst dayMs = 24 * 60 * 60 * 1000; // 24h\n\t\t\t// Clean up old sessions, keep only the last 24h worth of sessions\n\t\t\twhile (state.sessions.length > dayMs / sessionLengthMs) {\n\t\t\t\tstate.sessions.shift();\n\t\t\t}\n\t\t}\n\t\treturn { data: state, currentSession: lastSession };\n\t}\n}\n\ninterface IData {\n\tsessions: ISession[];\n}\n\n// 5 min window\ninterface ISession {\n\tstartTime: number;\n\ttypedCharacters: number;\n\taiCharacters: number;\n\tacceptedInlineSuggestions: number | undefined;\n\tchatEditCount: number | undefined;\n}\n\n\nfunction average<T>(arr: T[], selector: (item: T) => number): number {\n\tif (arr.length === 0) {\n\t\treturn 0;\n\t}\n\tconst s = sumBy(arr, selector);\n\treturn s / arr.length;\n}\n\n\ninterface IValue<T> {\n\twriteValue(value: T | undefined): void;\n\tgetValue(): T | undefined;\n}\n\nfunction rateLimitWrite<T>(targetValue: IValue<T>, maxWritesPerSecond: number, store: DisposableStore): IValue<T> {\n\tconst queue = new TaskQueue();\n\tlet _value: T | undefined = undefined;\n\tlet valueVersion = 0;\n\tlet savedVersion = 0;\n\tstore.add(toDisposable(() => {\n\t\tif (valueVersion !== savedVersion) {\n\t\t\ttargetValue.writeValue(_value);\n\t\t\tsavedVersion = valueVersion;\n\t\t}\n\t}));\n\n\treturn {\n\t\twriteValue(value: T | undefined): void {\n\t\t\tvalueVersion++;\n\t\t\tconst v = valueVersion;\n\t\t\t_value = value;\n\n\t\t\tqueue.clearPending();\n\t\t\tqueue.schedule(async () => {\n\t\t\t\ttargetValue.writeValue(value);\n\t\t\t\tsavedVersion = v;\n\t\t\t\tawait timeout(5000);\n\t\t\t});\n\t\t},\n\t\tgetValue(): T | undefined {\n\t\t\tif (valueVersion > 0) {\n\t\t\t\treturn _value;\n\t\t\t}\n\t\t\treturn targetValue.getValue();\n\t\t}\n\t};\n}\n\nfunction getStoredValue<T>(service: IStorageService, key: string, scope: StorageScope, target: StorageTarget): IValue<T> {\n\tlet lastValue: T | undefined = undefined;\n\tlet hasLastValue = false;\n\treturn {\n\t\twriteValue(value: T | undefined): void {\n\t\t\tif (value === undefined) {\n\t\t\t\tservice.remove(key, scope);\n\t\t\t} else {\n\t\t\t\tservice.store(key, JSON.stringify(value), scope, target);\n\t\t\t}\n\t\t\tlastValue = value;\n\t\t},\n\t\tgetValue(): T | undefined {\n\t\t\tif (hasLastValue) {\n\t\t\t\treturn lastValue;\n\t\t\t}\n\t\t\tconst strVal = service.get(key, scope);\n\t\t\tlastValue = strVal === undefined ? undefined : JSON.parse(strVal) as T | undefined;\n\t\t\thasLastValue = true;\n\t\t\treturn lastValue;\n\t\t}\n\t};\n}\n"]}