{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/terminal/test/browser/xterm/shellIntegrationAddon.integrationTest.ts","vs/workbench/contrib/terminal/test/browser/xterm/shellIntegrationAddon.integrationTest.ts"],"names":[],"mappings":"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","file":"shellIntegrationAddon.integrationTest.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { Terminal } from '@xterm/xterm';\nimport { deepStrictEqual, fail, strictEqual } from 'assert';\nimport { importAMDNodeModule } from '../../../../../../amdX.js';\nimport { getActiveDocument } from '../../../../../../base/browser/dom.js';\nimport { timeout } from '../../../../../../base/common/async.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { NullLogService } from '../../../../../../platform/log/common/log.js';\nimport { TerminalCapability, type ICommandDetectionCapability } from '../../../../../../platform/terminal/common/capabilities/capabilities.js';\nimport type { TerminalCapabilityStore } from '../../../../../../platform/terminal/common/capabilities/terminalCapabilityStore.js';\nimport { ShellIntegrationAddon } from '../../../../../../platform/terminal/common/xterm/shellIntegrationAddon.js';\nimport { workbenchInstantiationService, type TestTerminalConfigurationService } from '../../../../../test/browser/workbenchTestServices.js';\nimport { ITerminalConfigurationService } from '../../../../terminal/browser/terminal.js';\n\nimport { NullTelemetryService } from '../../../../../../platform/telemetry/common/telemetryUtils.js';\nimport { events as rich_windows11_pwsh7_echo_3_times } from './recordings/rich/windows11_pwsh7_echo_3_times.js';\nimport { events as rich_windows11_pwsh7_ls_one_time } from './recordings/rich/windows11_pwsh7_ls_one_time.js';\nimport { events as rich_windows11_pwsh7_type_foo } from './recordings/rich/windows11_pwsh7_type_foo.js';\nimport { events as rich_windows11_pwsh7_type_foo_left_twice } from './recordings/rich/windows11_pwsh7_type_foo_left_twice.js';\nimport { events as rich_macos_zsh_omz_echo_3_times } from './recordings/rich/macos_zsh_omz_echo_3_times.js';\nimport { events as rich_macos_zsh_omz_ls_one_time } from './recordings/rich/macos_zsh_omz_ls_one_time.js';\nimport { events as basic_macos_zsh_p10k_ls_one_time } from './recordings/basic/macos_zsh_p10k_ls_one_time.js';\nimport type { ITerminalConfiguration } from '../../../common/terminal.js';\n\n// These are test cases recorded with the `Developer: Record Terminal Session` command. Once that is\n// run, a terminal is created and the test case is manually executed. After nothing happens for a\n// few seconds the test case will be put into the clipboard.\n//\n// They aim to guarantee the complex interactions within command detection result in a particular\n// outcome.\n//\n// Some things to be aware of when recording tests:\n// - Pwsh on non-Windows can add a bunch of spammy cursor reports (`CSI x;y R`)\n// - It's best to record pwsh on Windows\n// - It's best to record other shells on non-Windows\n// - Turn off builtinCompletions to simplify the recording\n// - Capitalization matters in the recorded events\ntype RecordedTestCase = {\n\t/**\n\t * The test case name.\n\t */\n\tname: string;\n\t/**\n\t * A set of events that will play or be awaited for in order.\n\t */\n\tevents: RecordedSessionEvent[];\n\t/**\n\t * Any assertions to perform after the events have been played and validated.\n\t */\n\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => void;\n};\nconst recordedTestCases: RecordedTestCase[] = [\n\t{\n\t\tname: 'rich_windows11_pwsh7_echo_3_times',\n\t\tevents: rich_windows11_pwsh7_echo_3_times as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, ['echo a', 'echo b', 'echo c'], '|');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_windows11_pwsh7_ls_one_time',\n\t\tevents: rich_windows11_pwsh7_ls_one_time as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, ['ls'], '|');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_windows11_pwsh7_type_foo',\n\t\tevents: rich_windows11_pwsh7_type_foo as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, [], 'foo|');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_windows11_pwsh7_type_foo_left_twice',\n\t\tevents: rich_windows11_pwsh7_type_foo_left_twice as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, [], 'f|oo');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_macos_zsh_omz_echo_3_times',\n\t\tevents: rich_macos_zsh_omz_echo_3_times as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, ['echo a', 'echo b', 'echo c'], '|');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_macos_zsh_omz_ls_one_time',\n\t\tevents: rich_macos_zsh_omz_ls_one_time as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, ['ls'], '|');\n\t\t}\n\t},\n\t{\n\t\tname: 'basic_macos_zsh_p10k_ls_one_time',\n\t\tevents: basic_macos_zsh_p10k_ls_one_time as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\t// Prompt input model doesn't work for p10k yet\n\t\t\t// Assert a single command has completed\n\t\t\tdeepStrictEqual(commandDetection!.commands.map(e => e.command), ['']);\n\t\t}\n\t},\n];\nfunction assertCommandDetectionState(commandDetection: ICommandDetectionCapability | undefined, commands: string[], promptInput: string) {\n\tif (!commandDetection) {\n\t\tfail('Command detection must be set');\n\t}\n\tdeepStrictEqual(commandDetection!.commands.map(e => e.command), commands);\n\tstrictEqual(commandDetection!.promptInputModel.getCombinedString(), promptInput);\n}\n\ntype RecordedSessionEvent = (\n\tIRecordedSessionTerminalEvent |\n\tIRecordedSessionCommandEvent |\n\tIRecordedSessionResizeEvent\n);\n\ninterface IRecordedSessionTerminalEvent {\n\ttype: 'output' | 'input' | 'sendText' | 'promptInputChange';\n\tdata: string;\n}\n\ninterface IRecordedSessionCommandEvent {\n\ttype: 'command';\n\tid: string;\n}\n\ninterface IRecordedSessionResizeEvent {\n\ttype: 'resize';\n\tcols: number;\n\trows: number;\n}\n\nsuite('Terminal Contrib Shell Integration Recordings', () => {\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet xterm: Terminal;\n\tlet capabilities: TerminalCapabilityStore;\n\n\tsetup(async () => {\n\t\tconst terminalConfig = {\n\t\t\tintegrated: {\n\t\t\t}\n\t\t};\n\t\tconst instantiationService = workbenchInstantiationService({\n\t\t\tconfigurationService: () => new TestConfigurationService({\n\t\t\t\tfiles: { autoSave: false },\n\t\t\t\tterminal: terminalConfig,\n\t\t\t\teditor: { fontSize: 14, fontFamily: 'Arial', lineHeight: 12, fontWeight: 'bold' }\n\t\t\t})\n\t\t}, store);\n\t\tconst terminalConfigurationService = instantiationService.get(ITerminalConfigurationService) as TestTerminalConfigurationService;\n\t\tterminalConfigurationService.setConfig(terminalConfig as unknown as Partial<ITerminalConfiguration>);\n\t\tconst shellIntegrationAddon = store.add(new ShellIntegrationAddon('', true, undefined, NullTelemetryService, new NullLogService));\n\t\tconst TerminalCtor = (await importAMDNodeModule<typeof import('@xterm/xterm')>('@xterm/xterm', 'lib/xterm.js')).Terminal;\n\t\txterm = store.add(new TerminalCtor({ allowProposedApi: true }));\n\t\tcapabilities = shellIntegrationAddon.capabilities;\n\t\tconst testContainer = document.createElement('div');\n\t\tgetActiveDocument().body.append(testContainer);\n\n\t\txterm.open(testContainer);\n\t\txterm.loadAddon(shellIntegrationAddon);\n\t\txterm.focus();\n\t});\n\n\tfor (const testCase of recordedTestCases) {\n\t\ttest(testCase.name, async () => {\n\t\t\tfor (const [i, event] of testCase.events.entries()) {\n\t\t\t\t// DEBUG: Uncomment to see the events as they are played\n\t\t\t\t// console.log(\n\t\t\t\t// \tevent.type,\n\t\t\t\t// \tevent.type === 'command'\n\t\t\t\t// \t\t? event.id\n\t\t\t\t// \t\t: event.type === 'resize'\n\t\t\t\t// \t\t\t? `${event.cols}x${event.rows}`\n\t\t\t\t// \t\t\t: (event.data.length > 50 ? event.data.slice(0, 50) + '...' : event.data).replaceAll('\\x1b', '\\\\x1b').replace(/(\\n|\\r).+$/, '...')\n\t\t\t\t// );\n\t\t\t\t// console.log('promptInputModel', capabilities.get(TerminalCapability.CommandDetection)?.promptInputModel.getCombinedString());\n\t\t\t\tswitch (event.type) {\n\t\t\t\t\tcase 'resize': {\n\t\t\t\t\t\txterm.resize(event.cols, event.rows);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'output': {\n\t\t\t\t\t\tconst promises: Promise<unknown>[] = [];\n\t\t\t\t\t\tif (event.data.includes('\\x1b]633;B')) {\n\t\t\t\t\t\t\t// If the output contains the command start sequence, allow time for the prompt to get\n\t\t\t\t\t\t\t// adjusted.\n\t\t\t\t\t\t\tpromises.push(new Promise<void>(r => {\n\t\t\t\t\t\t\t\tconst commandDetection = capabilities.get(TerminalCapability.CommandDetection)!;\n\t\t\t\t\t\t\t\tif (commandDetection) {\n\t\t\t\t\t\t\t\t\tconst d = commandDetection.onCommandStarted(() => {\n\t\t\t\t\t\t\t\t\t\td.dispose();\n\t\t\t\t\t\t\t\t\t\tr();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpromises.push(new Promise<void>(r => xterm.write(event.data, () => r())));\n\t\t\t\t\t\tawait Promise.all(promises);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'input': {\n\t\t\t\t\t\txterm.input(event.data, true);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'promptInputChange': {\n\t\t\t\t\t\t// Ignore this event if it's followed by another promptInputChange as that\n\t\t\t\t\t\t// means this one isn't important and could cause a race condition in the\n\t\t\t\t\t\t// test\n\t\t\t\t\t\tif (testCase.events.length > i + 1 && testCase.events[i + 1].type === 'promptInputChange') {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst promptInputModel = capabilities.get(TerminalCapability.CommandDetection)?.promptInputModel;\n\t\t\t\t\t\tif (promptInputModel && promptInputModel.getCombinedString() !== event.data) {\n\t\t\t\t\t\t\tawait Promise.race([\n\t\t\t\t\t\t\t\tawait timeout(1000).then(() => { throw new Error(`Prompt input change timed out current=\"${promptInputModel.getCombinedString()}\", expected=\"${event.data}\"`); }),\n\t\t\t\t\t\t\t\tawait new Promise<void>(r => {\n\t\t\t\t\t\t\t\t\tconst d = promptInputModel.onDidChangeInput(() => {\n\t\t\t\t\t\t\t\t\t\tif (promptInputModel.getCombinedString() === event.data) {\n\t\t\t\t\t\t\t\t\t\t\td.dispose();\n\t\t\t\t\t\t\t\t\t\t\tr();\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t]);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\ttestCase.finalAssertions(capabilities.get(TerminalCapability.CommandDetection));\n\t\t});\n\t}\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { Terminal } from '@xterm/xterm';\nimport { deepStrictEqual, fail, strictEqual } from 'assert';\nimport { importAMDNodeModule } from '../../../../../../amdX.js';\nimport { getActiveDocument } from '../../../../../../base/browser/dom.js';\nimport { timeout } from '../../../../../../base/common/async.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../../base/test/common/utils.js';\nimport { TestConfigurationService } from '../../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { NullLogService } from '../../../../../../platform/log/common/log.js';\nimport { TerminalCapability, type ICommandDetectionCapability } from '../../../../../../platform/terminal/common/capabilities/capabilities.js';\nimport type { TerminalCapabilityStore } from '../../../../../../platform/terminal/common/capabilities/terminalCapabilityStore.js';\nimport { ShellIntegrationAddon } from '../../../../../../platform/terminal/common/xterm/shellIntegrationAddon.js';\nimport { workbenchInstantiationService, type TestTerminalConfigurationService } from '../../../../../test/browser/workbenchTestServices.js';\nimport { ITerminalConfigurationService } from '../../../../terminal/browser/terminal.js';\n\nimport { NullTelemetryService } from '../../../../../../platform/telemetry/common/telemetryUtils.js';\nimport { events as rich_windows11_pwsh7_echo_3_times } from './recordings/rich/windows11_pwsh7_echo_3_times.js';\nimport { events as rich_windows11_pwsh7_ls_one_time } from './recordings/rich/windows11_pwsh7_ls_one_time.js';\nimport { events as rich_windows11_pwsh7_type_foo } from './recordings/rich/windows11_pwsh7_type_foo.js';\nimport { events as rich_windows11_pwsh7_type_foo_left_twice } from './recordings/rich/windows11_pwsh7_type_foo_left_twice.js';\nimport { events as rich_macos_zsh_omz_echo_3_times } from './recordings/rich/macos_zsh_omz_echo_3_times.js';\nimport { events as rich_macos_zsh_omz_ls_one_time } from './recordings/rich/macos_zsh_omz_ls_one_time.js';\nimport { events as basic_macos_zsh_p10k_ls_one_time } from './recordings/basic/macos_zsh_p10k_ls_one_time.js';\nimport type { ITerminalConfiguration } from '../../../common/terminal.js';\n\n// These are test cases recorded with the `Developer: Record Terminal Session` command. Once that is\n// run, a terminal is created and the test case is manually executed. After nothing happens for a\n// few seconds the test case will be put into the clipboard.\n//\n// They aim to guarantee the complex interactions within command detection result in a particular\n// outcome.\n//\n// Some things to be aware of when recording tests:\n// - Pwsh on non-Windows can add a bunch of spammy cursor reports (`CSI x;y R`)\n// - It's best to record pwsh on Windows\n// - It's best to record other shells on non-Windows\n// - Turn off builtinCompletions to simplify the recording\n// - Capitalization matters in the recorded events\ntype RecordedTestCase = {\n\t/**\n\t * The test case name.\n\t */\n\tname: string;\n\t/**\n\t * A set of events that will play or be awaited for in order.\n\t */\n\tevents: RecordedSessionEvent[];\n\t/**\n\t * Any assertions to perform after the events have been played and validated.\n\t */\n\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => void;\n};\nconst recordedTestCases: RecordedTestCase[] = [\n\t{\n\t\tname: 'rich_windows11_pwsh7_echo_3_times',\n\t\tevents: rich_windows11_pwsh7_echo_3_times as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, ['echo a', 'echo b', 'echo c'], '|');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_windows11_pwsh7_ls_one_time',\n\t\tevents: rich_windows11_pwsh7_ls_one_time as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, ['ls'], '|');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_windows11_pwsh7_type_foo',\n\t\tevents: rich_windows11_pwsh7_type_foo as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, [], 'foo|');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_windows11_pwsh7_type_foo_left_twice',\n\t\tevents: rich_windows11_pwsh7_type_foo_left_twice as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, [], 'f|oo');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_macos_zsh_omz_echo_3_times',\n\t\tevents: rich_macos_zsh_omz_echo_3_times as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, ['echo a', 'echo b', 'echo c'], '|');\n\t\t}\n\t},\n\t{\n\t\tname: 'rich_macos_zsh_omz_ls_one_time',\n\t\tevents: rich_macos_zsh_omz_ls_one_time as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\tassertCommandDetectionState(commandDetection, ['ls'], '|');\n\t\t}\n\t},\n\t{\n\t\tname: 'basic_macos_zsh_p10k_ls_one_time',\n\t\tevents: basic_macos_zsh_p10k_ls_one_time as unknown as RecordedSessionEvent[],\n\t\tfinalAssertions: (commandDetection: ICommandDetectionCapability | undefined) => {\n\t\t\t// Prompt input model doesn't work for p10k yet\n\t\t\t// Assert a single command has completed\n\t\t\tdeepStrictEqual(commandDetection!.commands.map(e => e.command), ['']);\n\t\t}\n\t},\n];\nfunction assertCommandDetectionState(commandDetection: ICommandDetectionCapability | undefined, commands: string[], promptInput: string) {\n\tif (!commandDetection) {\n\t\tfail('Command detection must be set');\n\t}\n\tdeepStrictEqual(commandDetection!.commands.map(e => e.command), commands);\n\tstrictEqual(commandDetection!.promptInputModel.getCombinedString(), promptInput);\n}\n\ntype RecordedSessionEvent = (\n\tIRecordedSessionTerminalEvent |\n\tIRecordedSessionCommandEvent |\n\tIRecordedSessionResizeEvent\n);\n\ninterface IRecordedSessionTerminalEvent {\n\ttype: 'output' | 'input' | 'sendText' | 'promptInputChange';\n\tdata: string;\n}\n\ninterface IRecordedSessionCommandEvent {\n\ttype: 'command';\n\tid: string;\n}\n\ninterface IRecordedSessionResizeEvent {\n\ttype: 'resize';\n\tcols: number;\n\trows: number;\n}\n\nsuite('Terminal Contrib Shell Integration Recordings', () => {\n\tconst store = ensureNoDisposablesAreLeakedInTestSuite();\n\n\tlet xterm: Terminal;\n\tlet capabilities: TerminalCapabilityStore;\n\n\tsetup(async () => {\n\t\tconst terminalConfig = {\n\t\t\tintegrated: {\n\t\t\t}\n\t\t};\n\t\tconst instantiationService = workbenchInstantiationService({\n\t\t\tconfigurationService: () => new TestConfigurationService({\n\t\t\t\tfiles: { autoSave: false },\n\t\t\t\tterminal: terminalConfig,\n\t\t\t\teditor: { fontSize: 14, fontFamily: 'Arial', lineHeight: 12, fontWeight: 'bold' }\n\t\t\t})\n\t\t}, store);\n\t\tconst terminalConfigurationService = instantiationService.get(ITerminalConfigurationService) as TestTerminalConfigurationService;\n\t\tterminalConfigurationService.setConfig(terminalConfig as unknown as Partial<ITerminalConfiguration>);\n\t\tconst shellIntegrationAddon = store.add(new ShellIntegrationAddon('', true, undefined, NullTelemetryService, new NullLogService));\n\t\tconst TerminalCtor = (await importAMDNodeModule<typeof import('@xterm/xterm')>('@xterm/xterm', 'lib/xterm.js')).Terminal;\n\t\txterm = store.add(new TerminalCtor({ allowProposedApi: true }));\n\t\tcapabilities = shellIntegrationAddon.capabilities;\n\t\tconst testContainer = document.createElement('div');\n\t\tgetActiveDocument().body.append(testContainer);\n\n\t\txterm.open(testContainer);\n\t\txterm.loadAddon(shellIntegrationAddon);\n\t\txterm.focus();\n\t});\n\n\tfor (const testCase of recordedTestCases) {\n\t\ttest(testCase.name, async () => {\n\t\t\tfor (const [i, event] of testCase.events.entries()) {\n\t\t\t\t// DEBUG: Uncomment to see the events as they are played\n\t\t\t\t// console.log(\n\t\t\t\t// \tevent.type,\n\t\t\t\t// \tevent.type === 'command'\n\t\t\t\t// \t\t? event.id\n\t\t\t\t// \t\t: event.type === 'resize'\n\t\t\t\t// \t\t\t? `${event.cols}x${event.rows}`\n\t\t\t\t// \t\t\t: (event.data.length > 50 ? event.data.slice(0, 50) + '...' : event.data).replaceAll('\\x1b', '\\\\x1b').replace(/(\\n|\\r).+$/, '...')\n\t\t\t\t// );\n\t\t\t\t// console.log('promptInputModel', capabilities.get(TerminalCapability.CommandDetection)?.promptInputModel.getCombinedString());\n\t\t\t\tswitch (event.type) {\n\t\t\t\t\tcase 'resize': {\n\t\t\t\t\t\txterm.resize(event.cols, event.rows);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'output': {\n\t\t\t\t\t\tconst promises: Promise<unknown>[] = [];\n\t\t\t\t\t\tif (event.data.includes('\\x1b]633;B')) {\n\t\t\t\t\t\t\t// If the output contains the command start sequence, allow time for the prompt to get\n\t\t\t\t\t\t\t// adjusted.\n\t\t\t\t\t\t\tpromises.push(new Promise<void>(r => {\n\t\t\t\t\t\t\t\tconst commandDetection = capabilities.get(TerminalCapability.CommandDetection)!;\n\t\t\t\t\t\t\t\tif (commandDetection) {\n\t\t\t\t\t\t\t\t\tconst d = commandDetection.onCommandStarted(() => {\n\t\t\t\t\t\t\t\t\t\td.dispose();\n\t\t\t\t\t\t\t\t\t\tr();\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}));\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpromises.push(new Promise<void>(r => xterm.write(event.data, () => r())));\n\t\t\t\t\t\tawait Promise.all(promises);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'input': {\n\t\t\t\t\t\txterm.input(event.data, true);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'promptInputChange': {\n\t\t\t\t\t\t// Ignore this event if it's followed by another promptInputChange as that\n\t\t\t\t\t\t// means this one isn't important and could cause a race condition in the\n\t\t\t\t\t\t// test\n\t\t\t\t\t\tif (testCase.events.length > i + 1 && testCase.events[i + 1].type === 'promptInputChange') {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst promptInputModel = capabilities.get(TerminalCapability.CommandDetection)?.promptInputModel;\n\t\t\t\t\t\tif (promptInputModel && promptInputModel.getCombinedString() !== event.data) {\n\t\t\t\t\t\t\tawait Promise.race([\n\t\t\t\t\t\t\t\tawait timeout(1000).then(() => { throw new Error(`Prompt input change timed out current=\"${promptInputModel.getCombinedString()}\", expected=\"${event.data}\"`); }),\n\t\t\t\t\t\t\t\tawait new Promise<void>(r => {\n\t\t\t\t\t\t\t\t\tconst d = promptInputModel.onDidChangeInput(() => {\n\t\t\t\t\t\t\t\t\t\tif (promptInputModel.getCombinedString() === event.data) {\n\t\t\t\t\t\t\t\t\t\t\td.dispose();\n\t\t\t\t\t\t\t\t\t\t\tr();\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t]);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\ttestCase.finalAssertions(capabilities.get(TerminalCapability.CommandDetection));\n\t\t});\n\t}\n});\n"]}