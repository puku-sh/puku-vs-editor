{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/scm/common/scmService.ts","vs/workbench/contrib/scm/common/scmService.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;AAEhG,OAAO,EAAE,UAAU,EAAE,eAAe,EAAE,YAAY,EAAE,MAAM,sCAAsC,CAAC;AACjG,OAAO,EAAS,OAAO,EAAE,MAAM,kCAAkC,CAAC;AAClE,OAAO,EAA+F,oBAAoB,EAAyC,MAAM,UAAU,CAAC;AACpL,OAAO,EAAE,WAAW,EAAE,MAAM,wCAAwC,CAAC;AACrE,OAAO,EAAe,kBAAkB,EAAE,MAAM,sDAAsD,CAAC;AACvG,OAAO,EAAE,eAAe,EAA+B,MAAM,gDAAgD,CAAC;AAC9G,OAAO,EAAE,iBAAiB,EAAE,MAAM,oCAAoC,CAAC;AAEvE,OAAO,EAAE,WAAW,EAAE,MAAM,gCAAgC,CAAC;AAC7D,OAAO,EAAE,GAAG,EAAE,MAAM,gCAAgC,CAAC;AACrD,OAAO,EAAE,QAAQ,EAAE,MAAM,qCAAqC,CAAC;AAC/D,OAAO,EAAE,wBAAwB,EAAE,MAAM,oDAAoD,CAAC;AAC9F,OAAO,EAAE,OAAO,EAAE,MAAM,oCAAoC,CAAC;AAC7D,OAAO,EAAE,mBAAmB,EAAE,MAAM,wDAAwD,CAAC;AAC7F,OAAO,EAAE,WAAW,EAAE,MAAM,uCAAuC,CAAC;AAEpE,MAAM,QAAS,SAAQ,UAAU;IAIhC,IAAI,KAAK;QACR,OAAO,IAAI,CAAC,MAAM,CAAC;IACpB,CAAC;IAOD,IAAI,WAAW;QACd,OAAO,IAAI,CAAC,YAAY,CAAC;IAC1B,CAAC;IAED,IAAI,WAAW,CAAC,WAAmB;QAClC,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC;QAChC,IAAI,CAAC,uBAAuB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAChD,CAAC;IAOD,IAAI,OAAO;QACV,OAAO,IAAI,CAAC,QAAQ,CAAC;IACtB,CAAC;IAED,IAAI,OAAO,CAAC,OAAgB;QAC3B,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;IAC3C,CAAC;IAOD,IAAI,OAAO;QACV,OAAO,IAAI,CAAC,QAAQ,CAAC;IACtB,CAAC;IAED,IAAI,OAAO,CAAC,OAAgB;QAC3B,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;IAC3C,CAAC;IAKD,QAAQ;QACP,IAAI,CAAC,iBAAiB,CAAC,IAAI,EAAE,CAAC;IAC/B,CAAC;IAKD,qBAAqB,CAAC,OAAiC,EAAE,IAAyB;QACjF,IAAI,CAAC,6BAA6B,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC,CAAC;IAC3E,CAAC;IAOD,IAAI,aAAa;QAChB,OAAO,IAAI,CAAC,cAAc,CAAC;IAC5B,CAAC;IAED,IAAI,aAAa,CAAC,aAA8B;QAC/C,IAAI,CAAC,cAAc,GAAG,aAAa,CAAC;QACpC,IAAI,CAAC,yBAAyB,CAAC,IAAI,EAAE,CAAC;IACvC,CAAC;IAQD,YACU,UAA0B,EAClB,OAAwB;QAEzC,KAAK,EAAE,CAAC;QAHC,eAAU,GAAV,UAAU,CAAgB;QAClB,YAAO,GAAP,OAAO,CAAiB;QApFlC,WAAM,GAAG,EAAE,CAAC;QAMH,iBAAY,GAAG,IAAI,OAAO,EAAwB,CAAC;QAC3D,gBAAW,GAAgC,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC;QAEpE,iBAAY,GAAG,EAAE,CAAC;QAWT,4BAAuB,GAAG,IAAI,OAAO,EAAU,CAAC;QACxD,2BAAsB,GAAkB,IAAI,CAAC,uBAAuB,CAAC,KAAK,CAAC;QAE5E,aAAQ,GAAG,IAAI,CAAC;QAWP,2BAAsB,GAAG,IAAI,OAAO,EAAW,CAAC;QACxD,0BAAqB,GAAmB,IAAI,CAAC,sBAAsB,CAAC,KAAK,CAAC;QAE3E,aAAQ,GAAG,IAAI,CAAC;QAWP,2BAAsB,GAAG,IAAI,OAAO,EAAW,CAAC;QACxD,0BAAqB,GAAmB,IAAI,CAAC,sBAAsB,CAAC,KAAK,CAAC;QAMlE,sBAAiB,GAAG,IAAI,OAAO,EAAQ,CAAC;QAChD,qBAAgB,GAAgB,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC;QAMrD,kCAA6B,GAAG,IAAI,OAAO,EAAoB,CAAC;QACxE,iCAA4B,GAA4B,IAAI,CAAC,6BAA6B,CAAC,KAAK,CAAC;QAElG,mBAAc,GAAoB,GAAG,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;QAW1D,8BAAyB,GAAG,IAAI,OAAO,EAAQ,CAAC;QACxD,6BAAwB,GAAgB,IAAI,CAAC,yBAAyB,CAAC,KAAK,CAAC;QAG9E,qBAAgB,GAAY,KAAK,CAAC;QAQzC,IAAI,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC;YACtC,IAAI,CAAC,gBAAgB,GAAG,OAAO,CAAC,UAAU,CAAC,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,KAAK,EAAE,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;YAC7G,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,OAAO,CAAC,iBAAiB,CAAC,KAAK,CAAC,EAAE;gBACrD,IAAI,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,EAAE,CAAC;oBACrC,IAAI,CAAC,SAAS,EAAE,CAAC;gBAClB,CAAC;gBAED,IAAI,IAAI,CAAC,gBAAgB,EAAE,CAAC;oBAC3B,KAAK,CAAC,sBAAsB,EAAE,CAAC;gBAChC,CAAC;gBAED,IAAI,CAAC,gBAAgB,GAAG,KAAK,CAAC;YAC/B,CAAC,CAAC,CAAC,CAAC;QACL,CAAC;aAAM,CAAC,CAAC,iBAAiB;YACzB,IAAI,CAAC,gBAAgB,GAAG,IAAI,iBAAiB,CAAC,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,CAAC;QAC1D,CAAC;QAED,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,CAAC;IAC/C,CAAC;IAED,QAAQ,CAAC,KAAa,EAAE,SAAkB,EAAE,MAA6B;QACxE,IAAI,KAAK,KAAK,IAAI,CAAC,MAAM,EAAE,CAAC;YAC3B,OAAO;QACR,CAAC;QAED,IAAI,CAAC,SAAS,EAAE,CAAC;YAChB,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;YAC/C,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YACjC,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC;QAC9B,CAAC;QAED,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACpB,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;IAC3C,CAAC;IAED,oBAAoB;QACnB,IAAI,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,EAAE,CAAC;YACrC,OAAO;QACR,CAAC;aAAM,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;YACnD,IAAI,CAAC,SAAS,EAAE,CAAC;YACjB,IAAI,CAAC,gBAAgB,CAAC,WAAW,EAAE,CAAC;QACrC,CAAC;QAED,MAAM,KAAK,GAAG,IAAI,CAAC,gBAAgB,CAAC,IAAI,EAAE,CAAC;QAC3C,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,IAAI,EAAE,oBAAoB,CAAC,WAAW,CAAC,CAAC;IAC9D,CAAC;IAED,wBAAwB;QACvB,IAAI,IAAI,CAAC,gBAAgB,CAAC,OAAO,EAAE,EAAE,CAAC;YACrC,IAAI,CAAC,SAAS,EAAE,CAAC;QAClB,CAAC;aAAM,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC;YACpD,IAAI,CAAC,SAAS,EAAE,CAAC;YACjB,IAAI,CAAC,gBAAgB,CAAC,WAAW,EAAE,CAAC;QACrC,CAAC;QAED,MAAM,KAAK,GAAG,IAAI,CAAC,gBAAgB,CAAC,QAAQ,EAAE,CAAC;QAC/C,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,IAAI,EAAE,oBAAoB,CAAC,eAAe,CAAC,CAAC;IAClE,CAAC;IAEO,SAAS;QAChB,MAAM,QAAQ,GAAG,IAAI,CAAC,gBAAgB,CAAC,WAAW,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAChE,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC,gBAAgB,IAAI,CAAC,QAAQ,KAAK,IAAI,CAAC,MAAM,CAAC,CAAC;IAC7E,CAAC;CACD;AAED,MAAM,aAAa;IAGlB,IAAI,QAAQ;QACX,OAAO,IAAI,CAAC,SAAS,CAAC;IACvB,CAAC;IAOD,YACiB,EAAU,EACV,QAAsB,EACrB,WAA4B,EAC7C,YAA6B;QAHb,OAAE,GAAF,EAAE,CAAQ;QACV,aAAQ,GAAR,QAAQ,CAAc;QACrB,gBAAW,GAAX,WAAW,CAAiB;QAbtC,cAAS,GAAG,KAAK,CAAC;QAKT,0BAAqB,GAAG,IAAI,OAAO,EAAW,CAAC;QACvD,yBAAoB,GAAmB,IAAI,CAAC,qBAAqB,CAAC,KAAK,CAAC;QAUhF,IAAI,CAAC,KAAK,GAAG,IAAI,QAAQ,CAAC,IAAI,EAAE,YAAY,CAAC,CAAC;IAC/C,CAAC;IAED,WAAW,CAAC,QAAiB;QAC5B,IAAI,IAAI,CAAC,SAAS,KAAK,QAAQ,EAAE,CAAC;YACjC,OAAO;QACR,CAAC;QAED,IAAI,CAAC,SAAS,GAAG,QAAQ,CAAC;QAC1B,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;IAC3C,CAAC;IAED,OAAO;QACN,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC;QAC3B,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC;IACzB,CAAC;CACD;AAED,MAAM,oBAAoB;IAA1B;QACS,sBAAiB,GAAG,KAAK,CAAC;IAGnC,CAAC;IAFA,IAAI,gBAAgB,KAAK,OAAO,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC;IACzD,sBAAsB,KAAK,IAAI,CAAC,iBAAiB,GAAG,IAAI,CAAC,CAAC,CAAC;CAC3D;AAED,IAAM,eAAe,GAArB,MAAM,eAAe;IAQpB,YACkB,cAAuC,EAC9B,uBAAyD;QAD1D,mBAAc,GAAd,cAAc,CAAiB;QACtB,4BAAuB,GAAvB,uBAAuB,CAA0B;QARnE,gBAAW,GAAG,IAAI,eAAe,EAAE,CAAC;QACpC,cAAS,GAAG,IAAI,GAAG,EAAkD,CAAC;QAEtE,uBAAkB,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,OAAO,EAAwB,CAAC,CAAC;QACvF,sBAAiB,GAAG,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC;QAM1D,IAAI,CAAC,SAAS,GAAG,IAAI,GAAG,EAAE,CAAC;QAE3B,MAAM,OAAO,GAAG,IAAI,CAAC,cAAc,CAAC,SAAS,CAA4B,aAAa,kCAA0B,EAAE,CAAC,CAAC;QAEpH,KAAK,MAAM,CAAC,aAAa,EAAE,OAAO,EAAE,OAAO,CAAC,IAAI,OAAO,EAAE,CAAC;YACzD,IAAI,iBAAiB,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;YAE1D,IAAI,CAAC,iBAAiB,EAAE,CAAC;gBACxB,iBAAiB,GAAG,IAAI,WAAW,EAAE,CAAC;gBACtC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,aAAa,EAAE,iBAAiB,CAAC,CAAC;YACtD,CAAC;YAED,iBAAiB,CAAC,GAAG,CAAC,OAAO,EAAE,IAAI,iBAAiB,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC,CAAC;QACrE,CAAC;QAED,IAAI,IAAI,CAAC,cAAc,EAAE,EAAE,CAAC;YAC3B,IAAI,CAAC,aAAa,EAAE,CAAC;QACtB,CAAC;QAED,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,gBAAgB,iCAAyB,aAAa,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,EAAE;YACtH,IAAI,CAAC,CAAC,QAAQ,IAAI,CAAC,CAAC,GAAG,KAAK,aAAa,EAAE,CAAC;gBAC3C,MAAM,GAAG,GAAG,IAAI,CAAC,cAAc,CAAC,SAAS,CAA4B,aAAa,kCAA0B,EAAE,CAAC,CAAC;gBAEhH,KAAK,MAAM,CAAC,aAAa,EAAE,GAAG,EAAE,UAAU,CAAC,IAAI,GAAG,EAAE,CAAC;oBACpD,MAAM,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,aAAa,EAAE,GAAG,CAAC,CAAC;oBAEpD,KAAK,MAAM,KAAK,IAAI,QAAQ,CAAC,OAAO,CAAC,UAAU,CAAC,EAAE,CAAC;wBAClD,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;oBACxB,CAAC;gBACF,CAAC;YACF,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;QAEJ,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,eAAe,CAAC,CAAC,CAAC,EAAE;YAC5D,MAAM,KAAK,GAAG,IAAI,oBAAoB,EAAE,CAAC;YACzC,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAEpC,IAAI,KAAK,CAAC,gBAAgB,EAAE,CAAC;gBAC5B,IAAI,CAAC,aAAa,EAAE,CAAC;YACtB,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,aAAa;QACpB,MAAM,GAAG,GAA8B,EAAE,CAAC;QAE1C,KAAK,MAAM,CAAC,aAAa,EAAE,iBAAiB,CAAC,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACjE,KAAK,MAAM,CAAC,OAAO,EAAE,OAAO,CAAC,IAAI,iBAAiB,EAAE,CAAC;gBACpD,IAAI,CAAC,CAAC,OAAO,CAAC,IAAI,KAAK,CAAC,IAAI,OAAO,CAAC,OAAO,EAAE,KAAK,EAAE,CAAC,EAAE,CAAC;oBACvD,GAAG,CAAC,IAAI,CAAC,CAAC,aAAa,EAAE,OAAO,EAAE,CAAC,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;gBAClD,CAAC;YACF,CAAC;QACF,CAAC;QAED,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,aAAa,EAAE,GAAG,6DAA6C,CAAC;IAC3F,CAAC;IAED,UAAU,CAAC,aAAqB,EAAE,OAAY;QAC7C,IAAI,iBAAiB,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,aAAa,CAAC,CAAC;QAE1D,IAAI,CAAC,iBAAiB,EAAE,CAAC;YACxB,iBAAiB,GAAG,IAAI,WAAW,EAAE,CAAC;YACtC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,aAAa,EAAE,iBAAiB,CAAC,CAAC;QACtD,CAAC;QAED,IAAI,OAAO,GAAG,iBAAiB,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QAE7C,IAAI,CAAC,OAAO,EAAE,CAAC;YACd,OAAO,GAAG,IAAI,iBAAiB,CAAC,CAAC,EAAE,CAAC,EAAE,GAAG,CAAC,CAAC;YAC3C,iBAAiB,CAAC,GAAG,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QACzC,CAAC;QAED,OAAO,OAAO,CAAC;IAChB,CAAC;IAED,8DAA8D;IAC9D,uHAAuH;IAC/G,cAAc;QACrB,IAAI,kBAAkB,GAAG,KAAK,CAAC;QAC/B,MAAM,WAAW,GAAG,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,cAAc,CAAC,IAAI,kEAAiD,EAAE,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,UAAU,CAAC,YAAY,CAAC,CAAC,CAAC;QAEpJ,KAAK,MAAM,GAAG,IAAI,WAAW,EAAE,CAAC;YAC/B,IAAI,CAAC;gBACJ,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,GAAG,qCAA4B,EAAE,CAAC,CAAC,CAAC;gBAC7F,MAAM,KAAK,GAAG,2BAA2B,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;gBAEpD,IAAI,CAAC,KAAK,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,aAAa,EAAE,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,aAAa,EAAE,SAAS,CAAC,EAAE,CAAC;oBACrG,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,GAAG,oCAA2B,CAAC;oBAC1D,SAAS;gBACV,CAAC;gBAED,MAAM,CAAC,EAAE,aAAa,EAAE,QAAQ,CAAC,GAAG,KAAK,CAAC;gBAC1C,MAAM,OAAO,GAAG,GAAG,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;gBAEnC,IAAI,IAAI,CAAC,uBAAuB,CAAC,kBAAkB,CAAC,OAAO,CAAC,EAAE,CAAC;oBAC9D,MAAM,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,aAAa,EAAE,OAAO,CAAC,CAAC;oBAExD,KAAK,MAAM,KAAK,IAAI,QAAQ,CAAC,OAAO,CAAC,aAAa,CAAC,OAAmB,CAAC,EAAE,CAAC;wBACzE,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;oBACxB,CAAC;oBAED,kBAAkB,GAAG,IAAI,CAAC;oBAC1B,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,GAAG,oCAA2B,CAAC;gBAC3D,CAAC;YACF,CAAC;YAAC,MAAM,CAAC;gBACR,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,GAAG,oCAA2B,CAAC;YAC3D,CAAC;QACF,CAAC;QAED,OAAO,kBAAkB,CAAC;IAC3B,CAAC;IAED,OAAO;QACN,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC;IAC5B,CAAC;CACD,CAAA;AA/HK,eAAe;IASlB,WAAA,eAAe,CAAA;IACf,WAAA,wBAAwB,CAAA;GAVrB,eAAe,CA+HpB;AAGM,IAAM,UAAU,GAAhB,MAAM,UAAU;IAKtB,IAAI,YAAY,KAA+B,OAAO,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;IACpF,IAAI,eAAe,KAAa,OAAO,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC;IAYjE,YACc,UAAwC,EAC3B,uBAAiD,EACvD,iBAAqC,EACxC,cAA+B,EAC3B,kBAAwD;QAJ/C,eAAU,GAAV,UAAU,CAAa;QAIf,uBAAkB,GAAlB,kBAAkB,CAAqB;QAnB9E,kBAAa,GAAG,IAAI,GAAG,EAA0B,CAAC,CAAE,gBAAgB;QAQnD,sBAAiB,GAAG,IAAI,OAAO,EAAkB,CAAC;QAC1D,uBAAkB,GAA0B,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC;QAEjE,yBAAoB,GAAG,IAAI,OAAO,EAAkB,CAAC;QAC7D,0BAAqB,GAA0B,IAAI,CAAC,oBAAoB,CAAC,KAAK,CAAC;QASvF,IAAI,CAAC,YAAY,GAAG,IAAI,eAAe,CAAC,cAAc,EAAE,uBAAuB,CAAC,CAAC;QAEjF,IAAI,CAAC,aAAa,GAAG,iBAAiB,CAAC,SAAS,CAAC,mBAAmB,EAAE,CAAC,CAAC,CAAC;QACzE,IAAI,CAAC,oBAAoB,GAAG,iBAAiB,CAAC,SAAS,CAAC,0BAA0B,EAAE,CAAC,CAAC,CAAC;IACxF,CAAC;IAED,mBAAmB,CAAC,QAAsB;QACzC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,gCAAgC,CAAC,CAAC;QAExD,IAAI,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,CAAC,EAAE,CAAC;YACzC,MAAM,IAAI,KAAK,CAAC,gBAAgB,QAAQ,CAAC,EAAE,kBAAkB,CAAC,CAAC;QAChE,CAAC;QAED,MAAM,WAAW,GAAG,IAAI,eAAe,EAAE,CAAC;QAE1C,MAAM,oBAAoB,GAAG,GAAG,EAAE;YACjC,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,CAAC;iBAC5C,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,eAAe,CAAC,GAAG,EAAE,CAAC,CAAC,MAAM,CAAC;QAC1D,CAAC,CAAC;QAEF,WAAW,CAAC,GAAG,CAAC,YAAY,CAAC,GAAG,EAAE;YACjC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;YACvC,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YAE3C,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;YAChD,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,oBAAoB,EAAE,CAAC,CAAC;QACvD,CAAC,CAAC,CAAC,CAAC;QAEJ,MAAM,UAAU,GAAG,IAAI,aAAa,CAAC,QAAQ,CAAC,EAAE,EAAE,QAAQ,EAAE,WAAW,EAAE,IAAI,CAAC,YAAY,CAAC,CAAC;QAC5F,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,QAAQ,CAAC,EAAE,EAAE,UAAU,CAAC,CAAC;QAEhD,WAAW,CAAC,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;YAC1D,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,oBAAoB,EAAE,CAAC,CAAC;QACvD,CAAC,CAAC,CAAC,CAAC;QAEJ,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;QAChD,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,oBAAoB,EAAE,CAAC,CAAC;QAEtD,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAExC,OAAO,UAAU,CAAC;IACnB,CAAC;IAID,aAAa,CAAC,YAA0B;QACvC,IAAI,OAAO,YAAY,KAAK,QAAQ,EAAE,CAAC;YACtC,OAAO,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;QAC7C,CAAC;QAED,IAAI,YAAY,CAAC,MAAM,KAAK,OAAO,CAAC,IAAI;YACvC,YAAY,CAAC,MAAM,KAAK,OAAO,CAAC,YAAY,EAAE,CAAC;YAC/C,OAAO,SAAS,CAAC;QAClB,CAAC;QAED,IAAI,cAAc,GAA+B,SAAS,CAAC;QAC3D,IAAI,eAAe,GAAG,MAAM,CAAC,iBAAiB,CAAC;QAE/C,KAAK,MAAM,UAAU,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;YAC5C,MAAM,IAAI,GAAG,UAAU,CAAC,QAAQ,CAAC,OAAO,CAAC;YAEzC,IAAI,CAAC,IAAI,EAAE,CAAC;gBACX,SAAS;YACV,CAAC;YAED,MAAM,IAAI,GAAG,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,EAAE,YAAY,CAAC,CAAC;YAE7E,IAAI,IAAI,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,MAAM,GAAG,eAAe,EAAE,CAAC;gBAClE,cAAc,GAAG,UAAU,CAAC;gBAC5B,eAAe,GAAG,IAAI,CAAC,MAAM,CAAC;YAC/B,CAAC;QACF,CAAC;QAED,OAAO,cAAc,CAAC;IACvB,CAAC;CACD,CAAA;AApGY,UAAU;IAmBpB,WAAA,WAAW,CAAA;IACX,WAAA,wBAAwB,CAAA;IACxB,WAAA,kBAAkB,CAAA;IAClB,WAAA,eAAe,CAAA;IACf,WAAA,mBAAmB,CAAA;GAvBT,UAAU,CAoGtB","file":"scmService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable, DisposableStore, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { Event, Emitter } from '../../../../base/common/event.js';\nimport { ISCMService, ISCMProvider, ISCMInput, ISCMRepository, IInputValidator, ISCMInputChangeEvent, SCMInputChangeReason, InputValidationType, IInputValidation } from './scm.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { HistoryNavigator2 } from '../../../../base/common/history.js';\nimport { IMarkdownString } from '../../../../base/common/htmlContent.js';\nimport { ResourceMap } from '../../../../base/common/map.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { IWorkspaceContextService } from '../../../../platform/workspace/common/workspace.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { IUriIdentityService } from '../../../../platform/uriIdentity/common/uriIdentity.js';\nimport { runOnChange } from '../../../../base/common/observable.js';\n\nclass SCMInput extends Disposable implements ISCMInput {\n\n\tprivate _value = '';\n\n\tget value(): string {\n\t\treturn this._value;\n\t}\n\n\tprivate readonly _onDidChange = new Emitter<ISCMInputChangeEvent>();\n\treadonly onDidChange: Event<ISCMInputChangeEvent> = this._onDidChange.event;\n\n\tprivate _placeholder = '';\n\n\tget placeholder(): string {\n\t\treturn this._placeholder;\n\t}\n\n\tset placeholder(placeholder: string) {\n\t\tthis._placeholder = placeholder;\n\t\tthis._onDidChangePlaceholder.fire(placeholder);\n\t}\n\n\tprivate readonly _onDidChangePlaceholder = new Emitter<string>();\n\treadonly onDidChangePlaceholder: Event<string> = this._onDidChangePlaceholder.event;\n\n\tprivate _enabled = true;\n\n\tget enabled(): boolean {\n\t\treturn this._enabled;\n\t}\n\n\tset enabled(enabled: boolean) {\n\t\tthis._enabled = enabled;\n\t\tthis._onDidChangeEnablement.fire(enabled);\n\t}\n\n\tprivate readonly _onDidChangeEnablement = new Emitter<boolean>();\n\treadonly onDidChangeEnablement: Event<boolean> = this._onDidChangeEnablement.event;\n\n\tprivate _visible = true;\n\n\tget visible(): boolean {\n\t\treturn this._visible;\n\t}\n\n\tset visible(visible: boolean) {\n\t\tthis._visible = visible;\n\t\tthis._onDidChangeVisibility.fire(visible);\n\t}\n\n\tprivate readonly _onDidChangeVisibility = new Emitter<boolean>();\n\treadonly onDidChangeVisibility: Event<boolean> = this._onDidChangeVisibility.event;\n\n\tsetFocus(): void {\n\t\tthis._onDidChangeFocus.fire();\n\t}\n\n\tprivate readonly _onDidChangeFocus = new Emitter<void>();\n\treadonly onDidChangeFocus: Event<void> = this._onDidChangeFocus.event;\n\n\tshowValidationMessage(message: string | IMarkdownString, type: InputValidationType): void {\n\t\tthis._onDidChangeValidationMessage.fire({ message: message, type: type });\n\t}\n\n\tprivate readonly _onDidChangeValidationMessage = new Emitter<IInputValidation>();\n\treadonly onDidChangeValidationMessage: Event<IInputValidation> = this._onDidChangeValidationMessage.event;\n\n\tprivate _validateInput: IInputValidator = () => Promise.resolve(undefined);\n\n\tget validateInput(): IInputValidator {\n\t\treturn this._validateInput;\n\t}\n\n\tset validateInput(validateInput: IInputValidator) {\n\t\tthis._validateInput = validateInput;\n\t\tthis._onDidChangeValidateInput.fire();\n\t}\n\n\tprivate readonly _onDidChangeValidateInput = new Emitter<void>();\n\treadonly onDidChangeValidateInput: Event<void> = this._onDidChangeValidateInput.event;\n\n\tprivate readonly historyNavigator: HistoryNavigator2<string>;\n\tprivate didChangeHistory: boolean = false;\n\n\tconstructor(\n\t\treadonly repository: ISCMRepository,\n\t\tprivate readonly history: SCMInputHistory\n\t) {\n\t\tsuper();\n\n\t\tif (this.repository.provider.rootUri) {\n\t\t\tthis.historyNavigator = history.getHistory(this.repository.provider.label, this.repository.provider.rootUri);\n\t\t\tthis._register(this.history.onWillSaveHistory(event => {\n\t\t\t\tif (this.historyNavigator.isAtEnd()) {\n\t\t\t\t\tthis.saveValue();\n\t\t\t\t}\n\n\t\t\t\tif (this.didChangeHistory) {\n\t\t\t\t\tevent.historyDidIndeedChange();\n\t\t\t\t}\n\n\t\t\t\tthis.didChangeHistory = false;\n\t\t\t}));\n\t\t} else { // in memory only\n\t\t\tthis.historyNavigator = new HistoryNavigator2([''], 100);\n\t\t}\n\n\t\tthis._value = this.historyNavigator.current();\n\t}\n\n\tsetValue(value: string, transient: boolean, reason?: SCMInputChangeReason) {\n\t\tif (value === this._value) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!transient) {\n\t\t\tthis.historyNavigator.replaceLast(this._value);\n\t\t\tthis.historyNavigator.add(value);\n\t\t\tthis.didChangeHistory = true;\n\t\t}\n\n\t\tthis._value = value;\n\t\tthis._onDidChange.fire({ value, reason });\n\t}\n\n\tshowNextHistoryValue(): void {\n\t\tif (this.historyNavigator.isAtEnd()) {\n\t\t\treturn;\n\t\t} else if (!this.historyNavigator.has(this.value)) {\n\t\t\tthis.saveValue();\n\t\t\tthis.historyNavigator.resetCursor();\n\t\t}\n\n\t\tconst value = this.historyNavigator.next();\n\t\tthis.setValue(value, true, SCMInputChangeReason.HistoryNext);\n\t}\n\n\tshowPreviousHistoryValue(): void {\n\t\tif (this.historyNavigator.isAtEnd()) {\n\t\t\tthis.saveValue();\n\t\t} else if (!this.historyNavigator.has(this._value)) {\n\t\t\tthis.saveValue();\n\t\t\tthis.historyNavigator.resetCursor();\n\t\t}\n\n\t\tconst value = this.historyNavigator.previous();\n\t\tthis.setValue(value, true, SCMInputChangeReason.HistoryPrevious);\n\t}\n\n\tprivate saveValue(): void {\n\t\tconst oldValue = this.historyNavigator.replaceLast(this._value);\n\t\tthis.didChangeHistory = this.didChangeHistory || (oldValue !== this._value);\n\t}\n}\n\nclass SCMRepository implements ISCMRepository {\n\n\tprivate _selected = false;\n\tget selected(): boolean {\n\t\treturn this._selected;\n\t}\n\n\tprivate readonly _onDidChangeSelection = new Emitter<boolean>();\n\treadonly onDidChangeSelection: Event<boolean> = this._onDidChangeSelection.event;\n\n\treadonly input: ISCMInput;\n\n\tconstructor(\n\t\tpublic readonly id: string,\n\t\tpublic readonly provider: ISCMProvider,\n\t\tprivate readonly disposables: DisposableStore,\n\t\tinputHistory: SCMInputHistory\n\t) {\n\t\tthis.input = new SCMInput(this, inputHistory);\n\t}\n\n\tsetSelected(selected: boolean): void {\n\t\tif (this._selected === selected) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._selected = selected;\n\t\tthis._onDidChangeSelection.fire(selected);\n\t}\n\n\tdispose(): void {\n\t\tthis.disposables.dispose();\n\t\tthis.provider.dispose();\n\t}\n}\n\nclass WillSaveHistoryEvent {\n\tprivate _didChangeHistory = false;\n\tget didChangeHistory() { return this._didChangeHistory; }\n\thistoryDidIndeedChange() { this._didChangeHistory = true; }\n}\n\nclass SCMInputHistory {\n\n\tprivate readonly disposables = new DisposableStore();\n\tprivate readonly histories = new Map<string, ResourceMap<HistoryNavigator2<string>>>();\n\n\tprivate readonly _onWillSaveHistory = this.disposables.add(new Emitter<WillSaveHistoryEvent>());\n\treadonly onWillSaveHistory = this._onWillSaveHistory.event;\n\n\tconstructor(\n\t\t@IStorageService private storageService: IStorageService,\n\t\t@IWorkspaceContextService private workspaceContextService: IWorkspaceContextService,\n\t) {\n\t\tthis.histories = new Map();\n\n\t\tconst entries = this.storageService.getObject<[string, URI, string[]][]>('scm.history', StorageScope.WORKSPACE, []);\n\n\t\tfor (const [providerLabel, rootUri, history] of entries) {\n\t\t\tlet providerHistories = this.histories.get(providerLabel);\n\n\t\t\tif (!providerHistories) {\n\t\t\t\tproviderHistories = new ResourceMap();\n\t\t\t\tthis.histories.set(providerLabel, providerHistories);\n\t\t\t}\n\n\t\t\tproviderHistories.set(rootUri, new HistoryNavigator2(history, 100));\n\t\t}\n\n\t\tif (this.migrateStorage()) {\n\t\t\tthis.saveToStorage();\n\t\t}\n\n\t\tthis.disposables.add(this.storageService.onDidChangeValue(StorageScope.WORKSPACE, 'scm.history', this.disposables)(e => {\n\t\t\tif (e.external && e.key === 'scm.history') {\n\t\t\t\tconst raw = this.storageService.getObject<[string, URI, string[]][]>('scm.history', StorageScope.WORKSPACE, []);\n\n\t\t\t\tfor (const [providerLabel, uri, rawHistory] of raw) {\n\t\t\t\t\tconst history = this.getHistory(providerLabel, uri);\n\n\t\t\t\t\tfor (const value of Iterable.reverse(rawHistory)) {\n\t\t\t\t\t\thistory.prepend(value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis.disposables.add(this.storageService.onWillSaveState(_ => {\n\t\t\tconst event = new WillSaveHistoryEvent();\n\t\t\tthis._onWillSaveHistory.fire(event);\n\n\t\t\tif (event.didChangeHistory) {\n\t\t\t\tthis.saveToStorage();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate saveToStorage(): void {\n\t\tconst raw: [string, URI, string[]][] = [];\n\n\t\tfor (const [providerLabel, providerHistories] of this.histories) {\n\t\t\tfor (const [rootUri, history] of providerHistories) {\n\t\t\t\tif (!(history.size === 1 && history.current() === '')) {\n\t\t\t\t\traw.push([providerLabel, rootUri, [...history]]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.storageService.store('scm.history', raw, StorageScope.WORKSPACE, StorageTarget.USER);\n\t}\n\n\tgetHistory(providerLabel: string, rootUri: URI): HistoryNavigator2<string> {\n\t\tlet providerHistories = this.histories.get(providerLabel);\n\n\t\tif (!providerHistories) {\n\t\t\tproviderHistories = new ResourceMap();\n\t\t\tthis.histories.set(providerLabel, providerHistories);\n\t\t}\n\n\t\tlet history = providerHistories.get(rootUri);\n\n\t\tif (!history) {\n\t\t\thistory = new HistoryNavigator2([''], 100);\n\t\t\tproviderHistories.set(rootUri, history);\n\t\t}\n\n\t\treturn history;\n\t}\n\n\t// Migrates from Application scope storage to Workspace scope.\n\t// TODO@joaomoreno: Change from January 2024 onwards such that the only code is to remove all `scm/input:` storage keys\n\tprivate migrateStorage(): boolean {\n\t\tlet didSomethingChange = false;\n\t\tconst machineKeys = Iterable.filter(this.storageService.keys(StorageScope.APPLICATION, StorageTarget.MACHINE), key => key.startsWith('scm/input:'));\n\n\t\tfor (const key of machineKeys) {\n\t\t\ttry {\n\t\t\t\tconst legacyHistory = JSON.parse(this.storageService.get(key, StorageScope.APPLICATION, ''));\n\t\t\t\tconst match = /^scm\\/input:([^:]+):(.+)$/.exec(key);\n\n\t\t\t\tif (!match || !Array.isArray(legacyHistory?.history) || !Number.isInteger(legacyHistory?.timestamp)) {\n\t\t\t\t\tthis.storageService.remove(key, StorageScope.APPLICATION);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst [, providerLabel, rootPath] = match;\n\t\t\t\tconst rootUri = URI.file(rootPath);\n\n\t\t\t\tif (this.workspaceContextService.getWorkspaceFolder(rootUri)) {\n\t\t\t\t\tconst history = this.getHistory(providerLabel, rootUri);\n\n\t\t\t\t\tfor (const entry of Iterable.reverse(legacyHistory.history as string[])) {\n\t\t\t\t\t\thistory.prepend(entry);\n\t\t\t\t\t}\n\n\t\t\t\t\tdidSomethingChange = true;\n\t\t\t\t\tthis.storageService.remove(key, StorageScope.APPLICATION);\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\tthis.storageService.remove(key, StorageScope.APPLICATION);\n\t\t\t}\n\t\t}\n\n\t\treturn didSomethingChange;\n\t}\n\n\tdispose() {\n\t\tthis.disposables.dispose();\n\t}\n}\n\n\nexport class SCMService implements ISCMService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\t_repositories = new Map<string, ISCMRepository>();  // used in tests\n\tget repositories(): Iterable<ISCMRepository> { return this._repositories.values(); }\n\tget repositoryCount(): number { return this._repositories.size; }\n\n\tprivate inputHistory: SCMInputHistory;\n\tprivate providerCount: IContextKey<number>;\n\tprivate historyProviderCount: IContextKey<number>;\n\n\tprivate readonly _onDidAddProvider = new Emitter<ISCMRepository>();\n\treadonly onDidAddRepository: Event<ISCMRepository> = this._onDidAddProvider.event;\n\n\tprivate readonly _onDidRemoveProvider = new Emitter<ISCMRepository>();\n\treadonly onDidRemoveRepository: Event<ISCMRepository> = this._onDidRemoveProvider.event;\n\n\tconstructor(\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IWorkspaceContextService workspaceContextService: IWorkspaceContextService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IUriIdentityService private readonly uriIdentityService: IUriIdentityService\n\t) {\n\t\tthis.inputHistory = new SCMInputHistory(storageService, workspaceContextService);\n\n\t\tthis.providerCount = contextKeyService.createKey('scm.providerCount', 0);\n\t\tthis.historyProviderCount = contextKeyService.createKey('scm.historyProviderCount', 0);\n\t}\n\n\tregisterSCMProvider(provider: ISCMProvider): ISCMRepository {\n\t\tthis.logService.trace('SCMService#registerSCMProvider');\n\n\t\tif (this._repositories.has(provider.id)) {\n\t\t\tthrow new Error(`SCM Provider ${provider.id} already exists.`);\n\t\t}\n\n\t\tconst disposables = new DisposableStore();\n\n\t\tconst historyProviderCount = () => {\n\t\t\treturn Array.from(this._repositories.values())\n\t\t\t\t.filter(r => !!r.provider.historyProvider.get()).length;\n\t\t};\n\n\t\tdisposables.add(toDisposable(() => {\n\t\t\tthis._repositories.delete(provider.id);\n\t\t\tthis._onDidRemoveProvider.fire(repository);\n\n\t\t\tthis.providerCount.set(this._repositories.size);\n\t\t\tthis.historyProviderCount.set(historyProviderCount());\n\t\t}));\n\n\t\tconst repository = new SCMRepository(provider.id, provider, disposables, this.inputHistory);\n\t\tthis._repositories.set(provider.id, repository);\n\n\t\tdisposables.add(runOnChange(provider.historyProvider, () => {\n\t\t\tthis.historyProviderCount.set(historyProviderCount());\n\t\t}));\n\n\t\tthis.providerCount.set(this._repositories.size);\n\t\tthis.historyProviderCount.set(historyProviderCount());\n\n\t\tthis._onDidAddProvider.fire(repository);\n\n\t\treturn repository;\n\t}\n\n\tgetRepository(id: string): ISCMRepository | undefined;\n\tgetRepository(resource: URI): ISCMRepository | undefined;\n\tgetRepository(idOrResource: string | URI): ISCMRepository | undefined {\n\t\tif (typeof idOrResource === 'string') {\n\t\t\treturn this._repositories.get(idOrResource);\n\t\t}\n\n\t\tif (idOrResource.scheme !== Schemas.file &&\n\t\t\tidOrResource.scheme !== Schemas.vscodeRemote) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tlet bestRepository: ISCMRepository | undefined = undefined;\n\t\tlet bestMatchLength = Number.POSITIVE_INFINITY;\n\n\t\tfor (const repository of this.repositories) {\n\t\t\tconst root = repository.provider.rootUri;\n\n\t\t\tif (!root) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst path = this.uriIdentityService.extUri.relativePath(root, idOrResource);\n\n\t\t\tif (path && !/^\\.\\./.test(path) && path.length < bestMatchLength) {\n\t\t\t\tbestRepository = repository;\n\t\t\t\tbestMatchLength = path.length;\n\t\t\t}\n\t\t}\n\n\t\treturn bestRepository;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable, DisposableStore, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { Event, Emitter } from '../../../../base/common/event.js';\nimport { ISCMService, ISCMProvider, ISCMInput, ISCMRepository, IInputValidator, ISCMInputChangeEvent, SCMInputChangeReason, InputValidationType, IInputValidation } from './scm.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { HistoryNavigator2 } from '../../../../base/common/history.js';\nimport { IMarkdownString } from '../../../../base/common/htmlContent.js';\nimport { ResourceMap } from '../../../../base/common/map.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { IWorkspaceContextService } from '../../../../platform/workspace/common/workspace.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { IUriIdentityService } from '../../../../platform/uriIdentity/common/uriIdentity.js';\nimport { runOnChange } from '../../../../base/common/observable.js';\n\nclass SCMInput extends Disposable implements ISCMInput {\n\n\tprivate _value = '';\n\n\tget value(): string {\n\t\treturn this._value;\n\t}\n\n\tprivate readonly _onDidChange = new Emitter<ISCMInputChangeEvent>();\n\treadonly onDidChange: Event<ISCMInputChangeEvent> = this._onDidChange.event;\n\n\tprivate _placeholder = '';\n\n\tget placeholder(): string {\n\t\treturn this._placeholder;\n\t}\n\n\tset placeholder(placeholder: string) {\n\t\tthis._placeholder = placeholder;\n\t\tthis._onDidChangePlaceholder.fire(placeholder);\n\t}\n\n\tprivate readonly _onDidChangePlaceholder = new Emitter<string>();\n\treadonly onDidChangePlaceholder: Event<string> = this._onDidChangePlaceholder.event;\n\n\tprivate _enabled = true;\n\n\tget enabled(): boolean {\n\t\treturn this._enabled;\n\t}\n\n\tset enabled(enabled: boolean) {\n\t\tthis._enabled = enabled;\n\t\tthis._onDidChangeEnablement.fire(enabled);\n\t}\n\n\tprivate readonly _onDidChangeEnablement = new Emitter<boolean>();\n\treadonly onDidChangeEnablement: Event<boolean> = this._onDidChangeEnablement.event;\n\n\tprivate _visible = true;\n\n\tget visible(): boolean {\n\t\treturn this._visible;\n\t}\n\n\tset visible(visible: boolean) {\n\t\tthis._visible = visible;\n\t\tthis._onDidChangeVisibility.fire(visible);\n\t}\n\n\tprivate readonly _onDidChangeVisibility = new Emitter<boolean>();\n\treadonly onDidChangeVisibility: Event<boolean> = this._onDidChangeVisibility.event;\n\n\tsetFocus(): void {\n\t\tthis._onDidChangeFocus.fire();\n\t}\n\n\tprivate readonly _onDidChangeFocus = new Emitter<void>();\n\treadonly onDidChangeFocus: Event<void> = this._onDidChangeFocus.event;\n\n\tshowValidationMessage(message: string | IMarkdownString, type: InputValidationType): void {\n\t\tthis._onDidChangeValidationMessage.fire({ message: message, type: type });\n\t}\n\n\tprivate readonly _onDidChangeValidationMessage = new Emitter<IInputValidation>();\n\treadonly onDidChangeValidationMessage: Event<IInputValidation> = this._onDidChangeValidationMessage.event;\n\n\tprivate _validateInput: IInputValidator = () => Promise.resolve(undefined);\n\n\tget validateInput(): IInputValidator {\n\t\treturn this._validateInput;\n\t}\n\n\tset validateInput(validateInput: IInputValidator) {\n\t\tthis._validateInput = validateInput;\n\t\tthis._onDidChangeValidateInput.fire();\n\t}\n\n\tprivate readonly _onDidChangeValidateInput = new Emitter<void>();\n\treadonly onDidChangeValidateInput: Event<void> = this._onDidChangeValidateInput.event;\n\n\tprivate readonly historyNavigator: HistoryNavigator2<string>;\n\tprivate didChangeHistory: boolean = false;\n\n\tconstructor(\n\t\treadonly repository: ISCMRepository,\n\t\tprivate readonly history: SCMInputHistory\n\t) {\n\t\tsuper();\n\n\t\tif (this.repository.provider.rootUri) {\n\t\t\tthis.historyNavigator = history.getHistory(this.repository.provider.label, this.repository.provider.rootUri);\n\t\t\tthis._register(this.history.onWillSaveHistory(event => {\n\t\t\t\tif (this.historyNavigator.isAtEnd()) {\n\t\t\t\t\tthis.saveValue();\n\t\t\t\t}\n\n\t\t\t\tif (this.didChangeHistory) {\n\t\t\t\t\tevent.historyDidIndeedChange();\n\t\t\t\t}\n\n\t\t\t\tthis.didChangeHistory = false;\n\t\t\t}));\n\t\t} else { // in memory only\n\t\t\tthis.historyNavigator = new HistoryNavigator2([''], 100);\n\t\t}\n\n\t\tthis._value = this.historyNavigator.current();\n\t}\n\n\tsetValue(value: string, transient: boolean, reason?: SCMInputChangeReason) {\n\t\tif (value === this._value) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!transient) {\n\t\t\tthis.historyNavigator.replaceLast(this._value);\n\t\t\tthis.historyNavigator.add(value);\n\t\t\tthis.didChangeHistory = true;\n\t\t}\n\n\t\tthis._value = value;\n\t\tthis._onDidChange.fire({ value, reason });\n\t}\n\n\tshowNextHistoryValue(): void {\n\t\tif (this.historyNavigator.isAtEnd()) {\n\t\t\treturn;\n\t\t} else if (!this.historyNavigator.has(this.value)) {\n\t\t\tthis.saveValue();\n\t\t\tthis.historyNavigator.resetCursor();\n\t\t}\n\n\t\tconst value = this.historyNavigator.next();\n\t\tthis.setValue(value, true, SCMInputChangeReason.HistoryNext);\n\t}\n\n\tshowPreviousHistoryValue(): void {\n\t\tif (this.historyNavigator.isAtEnd()) {\n\t\t\tthis.saveValue();\n\t\t} else if (!this.historyNavigator.has(this._value)) {\n\t\t\tthis.saveValue();\n\t\t\tthis.historyNavigator.resetCursor();\n\t\t}\n\n\t\tconst value = this.historyNavigator.previous();\n\t\tthis.setValue(value, true, SCMInputChangeReason.HistoryPrevious);\n\t}\n\n\tprivate saveValue(): void {\n\t\tconst oldValue = this.historyNavigator.replaceLast(this._value);\n\t\tthis.didChangeHistory = this.didChangeHistory || (oldValue !== this._value);\n\t}\n}\n\nclass SCMRepository implements ISCMRepository {\n\n\tprivate _selected = false;\n\tget selected(): boolean {\n\t\treturn this._selected;\n\t}\n\n\tprivate readonly _onDidChangeSelection = new Emitter<boolean>();\n\treadonly onDidChangeSelection: Event<boolean> = this._onDidChangeSelection.event;\n\n\treadonly input: ISCMInput;\n\n\tconstructor(\n\t\tpublic readonly id: string,\n\t\tpublic readonly provider: ISCMProvider,\n\t\tprivate readonly disposables: DisposableStore,\n\t\tinputHistory: SCMInputHistory\n\t) {\n\t\tthis.input = new SCMInput(this, inputHistory);\n\t}\n\n\tsetSelected(selected: boolean): void {\n\t\tif (this._selected === selected) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._selected = selected;\n\t\tthis._onDidChangeSelection.fire(selected);\n\t}\n\n\tdispose(): void {\n\t\tthis.disposables.dispose();\n\t\tthis.provider.dispose();\n\t}\n}\n\nclass WillSaveHistoryEvent {\n\tprivate _didChangeHistory = false;\n\tget didChangeHistory() { return this._didChangeHistory; }\n\thistoryDidIndeedChange() { this._didChangeHistory = true; }\n}\n\nclass SCMInputHistory {\n\n\tprivate readonly disposables = new DisposableStore();\n\tprivate readonly histories = new Map<string, ResourceMap<HistoryNavigator2<string>>>();\n\n\tprivate readonly _onWillSaveHistory = this.disposables.add(new Emitter<WillSaveHistoryEvent>());\n\treadonly onWillSaveHistory = this._onWillSaveHistory.event;\n\n\tconstructor(\n\t\t@IStorageService private storageService: IStorageService,\n\t\t@IWorkspaceContextService private workspaceContextService: IWorkspaceContextService,\n\t) {\n\t\tthis.histories = new Map();\n\n\t\tconst entries = this.storageService.getObject<[string, URI, string[]][]>('scm.history', StorageScope.WORKSPACE, []);\n\n\t\tfor (const [providerLabel, rootUri, history] of entries) {\n\t\t\tlet providerHistories = this.histories.get(providerLabel);\n\n\t\t\tif (!providerHistories) {\n\t\t\t\tproviderHistories = new ResourceMap();\n\t\t\t\tthis.histories.set(providerLabel, providerHistories);\n\t\t\t}\n\n\t\t\tproviderHistories.set(rootUri, new HistoryNavigator2(history, 100));\n\t\t}\n\n\t\tif (this.migrateStorage()) {\n\t\t\tthis.saveToStorage();\n\t\t}\n\n\t\tthis.disposables.add(this.storageService.onDidChangeValue(StorageScope.WORKSPACE, 'scm.history', this.disposables)(e => {\n\t\t\tif (e.external && e.key === 'scm.history') {\n\t\t\t\tconst raw = this.storageService.getObject<[string, URI, string[]][]>('scm.history', StorageScope.WORKSPACE, []);\n\n\t\t\t\tfor (const [providerLabel, uri, rawHistory] of raw) {\n\t\t\t\t\tconst history = this.getHistory(providerLabel, uri);\n\n\t\t\t\t\tfor (const value of Iterable.reverse(rawHistory)) {\n\t\t\t\t\t\thistory.prepend(value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis.disposables.add(this.storageService.onWillSaveState(_ => {\n\t\t\tconst event = new WillSaveHistoryEvent();\n\t\t\tthis._onWillSaveHistory.fire(event);\n\n\t\t\tif (event.didChangeHistory) {\n\t\t\t\tthis.saveToStorage();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate saveToStorage(): void {\n\t\tconst raw: [string, URI, string[]][] = [];\n\n\t\tfor (const [providerLabel, providerHistories] of this.histories) {\n\t\t\tfor (const [rootUri, history] of providerHistories) {\n\t\t\t\tif (!(history.size === 1 && history.current() === '')) {\n\t\t\t\t\traw.push([providerLabel, rootUri, [...history]]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.storageService.store('scm.history', raw, StorageScope.WORKSPACE, StorageTarget.USER);\n\t}\n\n\tgetHistory(providerLabel: string, rootUri: URI): HistoryNavigator2<string> {\n\t\tlet providerHistories = this.histories.get(providerLabel);\n\n\t\tif (!providerHistories) {\n\t\t\tproviderHistories = new ResourceMap();\n\t\t\tthis.histories.set(providerLabel, providerHistories);\n\t\t}\n\n\t\tlet history = providerHistories.get(rootUri);\n\n\t\tif (!history) {\n\t\t\thistory = new HistoryNavigator2([''], 100);\n\t\t\tproviderHistories.set(rootUri, history);\n\t\t}\n\n\t\treturn history;\n\t}\n\n\t// Migrates from Application scope storage to Workspace scope.\n\t// TODO@joaomoreno: Change from January 2024 onwards such that the only code is to remove all `scm/input:` storage keys\n\tprivate migrateStorage(): boolean {\n\t\tlet didSomethingChange = false;\n\t\tconst machineKeys = Iterable.filter(this.storageService.keys(StorageScope.APPLICATION, StorageTarget.MACHINE), key => key.startsWith('scm/input:'));\n\n\t\tfor (const key of machineKeys) {\n\t\t\ttry {\n\t\t\t\tconst legacyHistory = JSON.parse(this.storageService.get(key, StorageScope.APPLICATION, ''));\n\t\t\t\tconst match = /^scm\\/input:([^:]+):(.+)$/.exec(key);\n\n\t\t\t\tif (!match || !Array.isArray(legacyHistory?.history) || !Number.isInteger(legacyHistory?.timestamp)) {\n\t\t\t\t\tthis.storageService.remove(key, StorageScope.APPLICATION);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst [, providerLabel, rootPath] = match;\n\t\t\t\tconst rootUri = URI.file(rootPath);\n\n\t\t\t\tif (this.workspaceContextService.getWorkspaceFolder(rootUri)) {\n\t\t\t\t\tconst history = this.getHistory(providerLabel, rootUri);\n\n\t\t\t\t\tfor (const entry of Iterable.reverse(legacyHistory.history as string[])) {\n\t\t\t\t\t\thistory.prepend(entry);\n\t\t\t\t\t}\n\n\t\t\t\t\tdidSomethingChange = true;\n\t\t\t\t\tthis.storageService.remove(key, StorageScope.APPLICATION);\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\tthis.storageService.remove(key, StorageScope.APPLICATION);\n\t\t\t}\n\t\t}\n\n\t\treturn didSomethingChange;\n\t}\n\n\tdispose() {\n\t\tthis.disposables.dispose();\n\t}\n}\n\n\nexport class SCMService implements ISCMService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\t_repositories = new Map<string, ISCMRepository>();  // used in tests\n\tget repositories(): Iterable<ISCMRepository> { return this._repositories.values(); }\n\tget repositoryCount(): number { return this._repositories.size; }\n\n\tprivate inputHistory: SCMInputHistory;\n\tprivate providerCount: IContextKey<number>;\n\tprivate historyProviderCount: IContextKey<number>;\n\n\tprivate readonly _onDidAddProvider = new Emitter<ISCMRepository>();\n\treadonly onDidAddRepository: Event<ISCMRepository> = this._onDidAddProvider.event;\n\n\tprivate readonly _onDidRemoveProvider = new Emitter<ISCMRepository>();\n\treadonly onDidRemoveRepository: Event<ISCMRepository> = this._onDidRemoveProvider.event;\n\n\tconstructor(\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IWorkspaceContextService workspaceContextService: IWorkspaceContextService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IUriIdentityService private readonly uriIdentityService: IUriIdentityService\n\t) {\n\t\tthis.inputHistory = new SCMInputHistory(storageService, workspaceContextService);\n\n\t\tthis.providerCount = contextKeyService.createKey('scm.providerCount', 0);\n\t\tthis.historyProviderCount = contextKeyService.createKey('scm.historyProviderCount', 0);\n\t}\n\n\tregisterSCMProvider(provider: ISCMProvider): ISCMRepository {\n\t\tthis.logService.trace('SCMService#registerSCMProvider');\n\n\t\tif (this._repositories.has(provider.id)) {\n\t\t\tthrow new Error(`SCM Provider ${provider.id} already exists.`);\n\t\t}\n\n\t\tconst disposables = new DisposableStore();\n\n\t\tconst historyProviderCount = () => {\n\t\t\treturn Array.from(this._repositories.values())\n\t\t\t\t.filter(r => !!r.provider.historyProvider.get()).length;\n\t\t};\n\n\t\tdisposables.add(toDisposable(() => {\n\t\t\tthis._repositories.delete(provider.id);\n\t\t\tthis._onDidRemoveProvider.fire(repository);\n\n\t\t\tthis.providerCount.set(this._repositories.size);\n\t\t\tthis.historyProviderCount.set(historyProviderCount());\n\t\t}));\n\n\t\tconst repository = new SCMRepository(provider.id, provider, disposables, this.inputHistory);\n\t\tthis._repositories.set(provider.id, repository);\n\n\t\tdisposables.add(runOnChange(provider.historyProvider, () => {\n\t\t\tthis.historyProviderCount.set(historyProviderCount());\n\t\t}));\n\n\t\tthis.providerCount.set(this._repositories.size);\n\t\tthis.historyProviderCount.set(historyProviderCount());\n\n\t\tthis._onDidAddProvider.fire(repository);\n\n\t\treturn repository;\n\t}\n\n\tgetRepository(id: string): ISCMRepository | undefined;\n\tgetRepository(resource: URI): ISCMRepository | undefined;\n\tgetRepository(idOrResource: string | URI): ISCMRepository | undefined {\n\t\tif (typeof idOrResource === 'string') {\n\t\t\treturn this._repositories.get(idOrResource);\n\t\t}\n\n\t\tif (idOrResource.scheme !== Schemas.file &&\n\t\t\tidOrResource.scheme !== Schemas.vscodeRemote) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tlet bestRepository: ISCMRepository | undefined = undefined;\n\t\tlet bestMatchLength = Number.POSITIVE_INFINITY;\n\n\t\tfor (const repository of this.repositories) {\n\t\t\tconst root = repository.provider.rootUri;\n\n\t\t\tif (!root) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst path = this.uriIdentityService.extUri.relativePath(root, idOrResource);\n\n\t\t\tif (path && !/^\\.\\./.test(path) && path.length < bestMatchLength) {\n\t\t\t\tbestRepository = repository;\n\t\t\t\tbestMatchLength = path.length;\n\t\t\t}\n\t\t}\n\n\t\treturn bestRepository;\n\t}\n}\n"]}