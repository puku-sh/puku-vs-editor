{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/inlineChat/browser/inlineChatStrategies.ts","vs/workbench/contrib/inlineChat/browser/inlineChatStrategies.ts"],"names":[],"mappings":"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","file":"inlineChatStrategies.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { WindowIntervalTimer } from '../../../../base/browser/dom.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { themeColorFromId, ThemeIcon } from '../../../../base/common/themables.js';\nimport { ICodeEditor, IViewZone, IViewZoneChangeAccessor } from '../../../../editor/browser/editorBrowser.js';\nimport { StableEditorScrollState } from '../../../../editor/browser/stableEditorScroll.js';\nimport { LineSource, RenderOptions, renderLines } from '../../../../editor/browser/widget/diffEditor/components/diffEditorViewZones/renderLines.js';\nimport { ISingleEditOperation } from '../../../../editor/common/core/editOperation.js';\nimport { LineRange } from '../../../../editor/common/core/ranges/lineRange.js';\nimport { Position } from '../../../../editor/common/core/position.js';\nimport { Range } from '../../../../editor/common/core/range.js';\nimport { IEditorDecorationsCollection } from '../../../../editor/common/editorCommon.js';\nimport { IModelDecorationsChangeAccessor, IModelDeltaDecoration, IValidEditOperation, MinimapPosition, OverviewRulerLane, TrackedRangeStickiness } from '../../../../editor/common/model.js';\nimport { ModelDecorationOptions } from '../../../../editor/common/model/textModel.js';\nimport { IEditorWorkerService } from '../../../../editor/common/services/editorWorker.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { Progress } from '../../../../platform/progress/common/progress.js';\nimport { SaveReason } from '../../../common/editor.js';\nimport { countWords } from '../../chat/common/chatWordCounter.js';\nimport { HunkInformation, Session, HunkState } from './inlineChatSession.js';\nimport { InlineChatZoneWidget } from './inlineChatZoneWidget.js';\nimport { ACTION_TOGGLE_DIFF, CTX_INLINE_CHAT_CHANGE_HAS_DIFF, CTX_INLINE_CHAT_CHANGE_SHOWS_DIFF, InlineChatConfigKeys, MENU_INLINE_CHAT_ZONE, minimapInlineChatDiffInserted, overviewRulerInlineChatDiffInserted } from '../common/inlineChat.js';\nimport { assertType } from '../../../../base/common/types.js';\nimport { performAsyncTextEdit, asProgressiveEdit } from './utils.js';\nimport { IAccessibilityService } from '../../../../platform/accessibility/common/accessibility.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { ITextFileService } from '../../../services/textfile/common/textfiles.js';\nimport { IUntitledTextEditorModel } from '../../../services/untitled/common/untitledTextEditorModel.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { DefaultChatTextEditor } from '../../chat/browser/codeBlockPart.js';\nimport { isEqual } from '../../../../base/common/resources.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { ConflictActionsFactory, IContentWidgetAction } from '../../mergeEditor/browser/view/conflictActions.js';\nimport { observableValue } from '../../../../base/common/observable.js';\nimport { IMenuService, MenuItemAction } from '../../../../platform/actions/common/actions.js';\nimport { InlineDecoration, InlineDecorationType } from '../../../../editor/common/viewModel/inlineDecorations.js';\nimport { EditSources } from '../../../../editor/common/textModelEditSource.js';\nimport { VersionedExtensionId } from '../../../../editor/common/languages.js';\n\nexport interface IEditObserver {\n\tstart(): void;\n\tstop(): void;\n}\n\nexport const enum HunkAction {\n\tAccept,\n\tDiscard,\n\tMoveNext,\n\tMovePrev,\n\tToggleDiff\n}\n\nexport class LiveStrategy {\n\n\tprivate readonly _decoInsertedText = ModelDecorationOptions.register({\n\t\tdescription: 'inline-modified-line',\n\t\tclassName: 'inline-chat-inserted-range-linehighlight',\n\t\tisWholeLine: true,\n\t\toverviewRuler: {\n\t\t\tposition: OverviewRulerLane.Full,\n\t\t\tcolor: themeColorFromId(overviewRulerInlineChatDiffInserted),\n\t\t},\n\t\tminimap: {\n\t\t\tposition: MinimapPosition.Inline,\n\t\t\tcolor: themeColorFromId(minimapInlineChatDiffInserted),\n\t\t}\n\t});\n\n\tprivate readonly _decoInsertedTextRange = ModelDecorationOptions.register({\n\t\tdescription: 'inline-chat-inserted-range-linehighlight',\n\t\tclassName: 'inline-chat-inserted-range',\n\t\tstickiness: TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,\n\t});\n\n\tprotected readonly _store = new DisposableStore();\n\tprotected readonly _onDidAccept = this._store.add(new Emitter<void>());\n\tprotected readonly _onDidDiscard = this._store.add(new Emitter<void>());\n\tprivate readonly _ctxCurrentChangeHasDiff: IContextKey<boolean>;\n\tprivate readonly _ctxCurrentChangeShowsDiff: IContextKey<boolean>;\n\tprivate readonly _progressiveEditingDecorations: IEditorDecorationsCollection;\n\tprivate readonly _lensActionsFactory: ConflictActionsFactory;\n\tprivate _editCount: number = 0;\n\tprivate readonly _hunkData = new Map<HunkInformation, HunkDisplayData>();\n\n\treadonly onDidAccept: Event<void> = this._onDidAccept.event;\n\treadonly onDidDiscard: Event<void> = this._onDidDiscard.event;\n\n\tconstructor(\n\t\tprotected readonly _session: Session,\n\t\tprotected readonly _editor: ICodeEditor,\n\t\tprotected readonly _zone: InlineChatZoneWidget,\n\t\tprivate readonly _showOverlayToolbar: boolean,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IEditorWorkerService protected readonly _editorWorkerService: IEditorWorkerService,\n\t\t@IAccessibilityService private readonly _accessibilityService: IAccessibilityService,\n\t\t@IConfigurationService private readonly _configService: IConfigurationService,\n\t\t@IMenuService private readonly _menuService: IMenuService,\n\t\t@IContextKeyService private readonly _contextService: IContextKeyService,\n\t\t@ITextFileService private readonly _textFileService: ITextFileService,\n\t\t@IInstantiationService protected readonly _instaService: IInstantiationService\n\t) {\n\t\tthis._ctxCurrentChangeHasDiff = CTX_INLINE_CHAT_CHANGE_HAS_DIFF.bindTo(contextKeyService);\n\t\tthis._ctxCurrentChangeShowsDiff = CTX_INLINE_CHAT_CHANGE_SHOWS_DIFF.bindTo(contextKeyService);\n\n\t\tthis._progressiveEditingDecorations = this._editor.createDecorationsCollection();\n\t\tthis._lensActionsFactory = this._store.add(new ConflictActionsFactory(this._editor));\n\t}\n\n\tdispose(): void {\n\t\tthis._resetDiff();\n\t\tthis._store.dispose();\n\t}\n\n\tprivate _resetDiff(): void {\n\t\tthis._ctxCurrentChangeHasDiff.reset();\n\t\tthis._ctxCurrentChangeShowsDiff.reset();\n\t\tthis._zone.widget.updateStatus('');\n\t\tthis._progressiveEditingDecorations.clear();\n\n\n\t\tfor (const data of this._hunkData.values()) {\n\t\t\tdata.remove();\n\t\t}\n\t}\n\n\tasync apply() {\n\t\tthis._resetDiff();\n\t\tif (this._editCount > 0) {\n\t\t\tthis._editor.pushUndoStop();\n\t\t}\n\t\tawait this._doApplyChanges(true);\n\t}\n\n\tcancel() {\n\t\tthis._resetDiff();\n\t\treturn this._session.hunkData.discardAll();\n\t}\n\n\tasync makeChanges(edits: ISingleEditOperation[], obs: IEditObserver, undoStopBefore: boolean, metadata: IInlineChatMetadata): Promise<void> {\n\t\treturn this._makeChanges(edits, obs, undefined, undefined, undoStopBefore, metadata);\n\t}\n\n\tasync makeProgressiveChanges(edits: ISingleEditOperation[], obs: IEditObserver, opts: ProgressingEditsOptions, undoStopBefore: boolean, metadata: IInlineChatMetadata): Promise<void> {\n\n\t\t// add decorations once per line that got edited\n\t\tconst progress = new Progress<IValidEditOperation[]>(edits => {\n\n\t\t\tconst newLines = new Set<number>();\n\t\t\tfor (const edit of edits) {\n\t\t\t\tLineRange.fromRange(edit.range).forEach(line => newLines.add(line));\n\t\t\t}\n\t\t\tconst existingRanges = this._progressiveEditingDecorations.getRanges().map(LineRange.fromRange);\n\t\t\tfor (const existingRange of existingRanges) {\n\t\t\t\texistingRange.forEach(line => newLines.delete(line));\n\t\t\t}\n\t\t\tconst newDecorations: IModelDeltaDecoration[] = [];\n\t\t\tfor (const line of newLines) {\n\t\t\t\tnewDecorations.push({ range: new Range(line, 1, line, Number.MAX_VALUE), options: this._decoInsertedText });\n\t\t\t}\n\n\t\t\tthis._progressiveEditingDecorations.append(newDecorations);\n\t\t});\n\t\treturn this._makeChanges(edits, obs, opts, progress, undoStopBefore, metadata);\n\t}\n\n\tprivate async _makeChanges(edits: ISingleEditOperation[], obs: IEditObserver, opts: ProgressingEditsOptions | undefined, progress: Progress<IValidEditOperation[]> | undefined, undoStopBefore: boolean, metadata: IInlineChatMetadata): Promise<void> {\n\n\t\t// push undo stop before first edit\n\t\tif (undoStopBefore) {\n\t\t\tthis._editor.pushUndoStop();\n\t\t}\n\n\t\tthis._editCount++;\n\t\tconst editSource = EditSources.inlineChatApplyEdit({\n\t\t\tmodelId: metadata.modelId,\n\t\t\textensionId: metadata.extensionId,\n\t\t\trequestId: metadata.requestId,\n\t\t\tsessionId: undefined,\n\t\t\tlanguageId: this._session.textModelN.getLanguageId(),\n\t\t});\n\n\t\tif (opts) {\n\t\t\t// ASYNC\n\t\t\tconst durationInSec = opts.duration / 1000;\n\t\t\tfor (const edit of edits) {\n\t\t\t\tconst wordCount = countWords(edit.text ?? '');\n\t\t\t\tconst speed = wordCount / durationInSec;\n\t\t\t\t// console.log({ durationInSec, wordCount, speed: wordCount / durationInSec });\n\t\t\t\tconst asyncEdit = asProgressiveEdit(new WindowIntervalTimer(this._zone.domNode), edit, speed, opts.token);\n\t\t\t\tawait performAsyncTextEdit(this._session.textModelN, asyncEdit, progress, obs, editSource);\n\t\t\t}\n\n\t\t} else {\n\t\t\t// SYNC\n\t\t\tobs.start();\n\t\t\tthis._session.textModelN.pushEditOperations(null, edits, (undoEdits) => {\n\t\t\t\tprogress?.report(undoEdits);\n\t\t\t\treturn null;\n\t\t\t}, undefined, editSource);\n\t\t\tobs.stop();\n\t\t}\n\t}\n\n\tperformHunkAction(hunk: HunkInformation | undefined, action: HunkAction) {\n\t\tconst displayData = this._findDisplayData(hunk);\n\n\t\tif (!displayData) {\n\t\t\t// no hunks (left or not yet) found, make sure to\n\t\t\t// finish the sessions\n\t\t\tif (action === HunkAction.Accept) {\n\t\t\t\tthis._onDidAccept.fire();\n\t\t\t} else if (action === HunkAction.Discard) {\n\t\t\t\tthis._onDidDiscard.fire();\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (action === HunkAction.Accept) {\n\t\t\tdisplayData.acceptHunk();\n\t\t} else if (action === HunkAction.Discard) {\n\t\t\tdisplayData.discardHunk();\n\t\t} else if (action === HunkAction.MoveNext) {\n\t\t\tdisplayData.move(true);\n\t\t} else if (action === HunkAction.MovePrev) {\n\t\t\tdisplayData.move(false);\n\t\t} else if (action === HunkAction.ToggleDiff) {\n\t\t\tdisplayData.toggleDiff?.();\n\t\t}\n\t}\n\n\tprivate _findDisplayData(hunkInfo?: HunkInformation) {\n\t\tlet result: HunkDisplayData | undefined;\n\t\tif (hunkInfo) {\n\t\t\t// use context hunk (from tool/buttonbar)\n\t\t\tresult = this._hunkData.get(hunkInfo);\n\t\t}\n\n\t\tif (!result && this._zone.position) {\n\t\t\t// find nearest from zone position\n\t\t\tconst zoneLine = this._zone.position.lineNumber;\n\t\t\tlet distance: number = Number.MAX_SAFE_INTEGER;\n\t\t\tfor (const candidate of this._hunkData.values()) {\n\t\t\t\tif (candidate.hunk.getState() !== HunkState.Pending) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst hunkRanges = candidate.hunk.getRangesN();\n\t\t\t\tif (hunkRanges.length === 0) {\n\t\t\t\t\t// bogous hunk\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst myDistance = zoneLine <= hunkRanges[0].startLineNumber\n\t\t\t\t\t? hunkRanges[0].startLineNumber - zoneLine\n\t\t\t\t\t: zoneLine - hunkRanges[0].endLineNumber;\n\n\t\t\t\tif (myDistance < distance) {\n\t\t\t\t\tdistance = myDistance;\n\t\t\t\t\tresult = candidate;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!result) {\n\t\t\t// fallback: first hunk that is pending\n\t\t\tresult = Iterable.first(Iterable.filter(this._hunkData.values(), candidate => candidate.hunk.getState() === HunkState.Pending));\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync renderChanges() {\n\n\t\tthis._progressiveEditingDecorations.clear();\n\n\t\tconst renderHunks = () => {\n\n\t\t\tlet widgetData: HunkDisplayData | undefined;\n\n\t\t\tchangeDecorationsAndViewZones(this._editor, (decorationsAccessor, viewZoneAccessor) => {\n\n\t\t\t\tconst keysNow = new Set(this._hunkData.keys());\n\t\t\t\twidgetData = undefined;\n\n\t\t\t\tfor (const hunkData of this._session.hunkData.getInfo()) {\n\n\t\t\t\t\tkeysNow.delete(hunkData);\n\n\t\t\t\t\tconst hunkRanges = hunkData.getRangesN();\n\t\t\t\t\tlet data = this._hunkData.get(hunkData);\n\t\t\t\t\tif (!data) {\n\t\t\t\t\t\t// first time -> create decoration\n\t\t\t\t\t\tconst decorationIds: string[] = [];\n\t\t\t\t\t\tfor (let i = 0; i < hunkRanges.length; i++) {\n\t\t\t\t\t\t\tdecorationIds.push(decorationsAccessor.addDecoration(hunkRanges[i], i === 0\n\t\t\t\t\t\t\t\t? this._decoInsertedText\n\t\t\t\t\t\t\t\t: this._decoInsertedTextRange)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst acceptHunk = () => {\n\t\t\t\t\t\t\thunkData.acceptChanges();\n\t\t\t\t\t\t\trenderHunks();\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst discardHunk = () => {\n\t\t\t\t\t\t\thunkData.discardChanges();\n\t\t\t\t\t\t\trenderHunks();\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t// original view zone\n\t\t\t\t\t\tconst mightContainNonBasicASCII = this._session.textModel0.mightContainNonBasicASCII();\n\t\t\t\t\t\tconst mightContainRTL = this._session.textModel0.mightContainRTL();\n\t\t\t\t\t\tconst renderOptions = RenderOptions.fromEditor(this._editor);\n\t\t\t\t\t\tconst originalRange = hunkData.getRanges0()[0];\n\t\t\t\t\t\tconst source = new LineSource(\n\t\t\t\t\t\t\tLineRange.fromRangeInclusive(originalRange).mapToLineArray(l => this._session.textModel0.tokenization.getLineTokens(l)),\n\t\t\t\t\t\t\t[],\n\t\t\t\t\t\t\tmightContainNonBasicASCII,\n\t\t\t\t\t\t\tmightContainRTL,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst domNode = document.createElement('div');\n\t\t\t\t\t\tdomNode.className = 'inline-chat-original-zone2';\n\t\t\t\t\t\tconst result = renderLines(source, renderOptions, [new InlineDecoration(new Range(originalRange.startLineNumber, 1, originalRange.startLineNumber, 1), '', InlineDecorationType.Regular)], domNode);\n\t\t\t\t\t\tconst viewZoneData: IViewZone = {\n\t\t\t\t\t\t\tafterLineNumber: -1,\n\t\t\t\t\t\t\theightInLines: result.heightInLines,\n\t\t\t\t\t\t\tdomNode,\n\t\t\t\t\t\t\tordinal: 50000 + 2 // more than https://github.com/microsoft/vscode/blob/bf52a5cfb2c75a7327c9adeaefbddc06d529dcad/src/vs/workbench/contrib/inlineChat/browser/inlineChatZoneWidget.ts#L42\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst toggleDiff = () => {\n\t\t\t\t\t\t\tconst scrollState = StableEditorScrollState.capture(this._editor);\n\t\t\t\t\t\t\tchangeDecorationsAndViewZones(this._editor, (_decorationsAccessor, viewZoneAccessor) => {\n\t\t\t\t\t\t\t\tassertType(data);\n\t\t\t\t\t\t\t\tif (!data.diffViewZoneId) {\n\t\t\t\t\t\t\t\t\tconst [hunkRange] = hunkData.getRangesN();\n\t\t\t\t\t\t\t\t\tviewZoneData.afterLineNumber = hunkRange.startLineNumber - 1;\n\t\t\t\t\t\t\t\t\tdata.diffViewZoneId = viewZoneAccessor.addZone(viewZoneData);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tviewZoneAccessor.removeZone(data.diffViewZoneId!);\n\t\t\t\t\t\t\t\t\tdata.diffViewZoneId = undefined;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tthis._ctxCurrentChangeShowsDiff.set(typeof data?.diffViewZoneId === 'string');\n\t\t\t\t\t\t\tscrollState.restore(this._editor);\n\t\t\t\t\t\t};\n\n\n\t\t\t\t\t\tlet lensActions: DisposableStore | undefined;\n\t\t\t\t\t\tconst lensActionsViewZoneIds: string[] = [];\n\n\t\t\t\t\t\tif (this._showOverlayToolbar && hunkData.getState() === HunkState.Pending) {\n\n\t\t\t\t\t\t\tlensActions = new DisposableStore();\n\n\t\t\t\t\t\t\tconst menu = this._menuService.createMenu(MENU_INLINE_CHAT_ZONE, this._contextService);\n\t\t\t\t\t\t\tconst makeActions = () => {\n\t\t\t\t\t\t\t\tconst actions: IContentWidgetAction[] = [];\n\t\t\t\t\t\t\t\tconst tuples = menu.getActions({ arg: hunkData });\n\t\t\t\t\t\t\t\tfor (const [, group] of tuples) {\n\t\t\t\t\t\t\t\t\tfor (const item of group) {\n\t\t\t\t\t\t\t\t\t\tif (item instanceof MenuItemAction) {\n\n\t\t\t\t\t\t\t\t\t\t\tlet text = item.label;\n\n\t\t\t\t\t\t\t\t\t\t\tif (item.id === ACTION_TOGGLE_DIFF) {\n\t\t\t\t\t\t\t\t\t\t\t\ttext = item.checked ? 'Hide Changes' : 'Show Changes';\n\t\t\t\t\t\t\t\t\t\t\t} else if (ThemeIcon.isThemeIcon(item.item.icon)) {\n\t\t\t\t\t\t\t\t\t\t\t\ttext = `$(${item.item.icon.id}) ${text}`;\n\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\tactions.push({\n\t\t\t\t\t\t\t\t\t\t\t\ttext,\n\t\t\t\t\t\t\t\t\t\t\t\ttooltip: item.tooltip,\n\t\t\t\t\t\t\t\t\t\t\t\taction: async () => item.run(),\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\treturn actions;\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tconst obs = observableValue(this, makeActions());\n\t\t\t\t\t\t\tlensActions.add(menu.onDidChange(() => obs.set(makeActions(), undefined)));\n\t\t\t\t\t\t\tlensActions.add(menu);\n\n\t\t\t\t\t\t\tlensActions.add(this._lensActionsFactory.createWidget(viewZoneAccessor,\n\t\t\t\t\t\t\t\thunkRanges[0].startLineNumber - 1,\n\t\t\t\t\t\t\t\tobs,\n\t\t\t\t\t\t\t\tlensActionsViewZoneIds\n\t\t\t\t\t\t\t));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst remove = () => {\n\t\t\t\t\t\t\tchangeDecorationsAndViewZones(this._editor, (decorationsAccessor, viewZoneAccessor) => {\n\t\t\t\t\t\t\t\tassertType(data);\n\t\t\t\t\t\t\t\tfor (const decorationId of data.decorationIds) {\n\t\t\t\t\t\t\t\t\tdecorationsAccessor.removeDecoration(decorationId);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (data.diffViewZoneId) {\n\t\t\t\t\t\t\t\t\tviewZoneAccessor.removeZone(data.diffViewZoneId!);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tdata.decorationIds = [];\n\t\t\t\t\t\t\t\tdata.diffViewZoneId = undefined;\n\n\t\t\t\t\t\t\t\tdata.lensActionsViewZoneIds?.forEach(viewZoneAccessor.removeZone);\n\t\t\t\t\t\t\t\tdata.lensActionsViewZoneIds = undefined;\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tlensActions?.dispose();\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst move = (next: boolean) => {\n\t\t\t\t\t\t\tconst keys = Array.from(this._hunkData.keys());\n\t\t\t\t\t\t\tconst idx = keys.indexOf(hunkData);\n\t\t\t\t\t\t\tconst nextIdx = (idx + (next ? 1 : -1) + keys.length) % keys.length;\n\t\t\t\t\t\t\tif (nextIdx !== idx) {\n\t\t\t\t\t\t\t\tconst nextData = this._hunkData.get(keys[nextIdx])!;\n\t\t\t\t\t\t\t\tthis._zone.updatePositionAndHeight(nextData?.position);\n\t\t\t\t\t\t\t\trenderHunks();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst zoneLineNumber = this._zone.position?.lineNumber ?? this._editor.getPosition()!.lineNumber;\n\t\t\t\t\t\tconst myDistance = zoneLineNumber <= hunkRanges[0].startLineNumber\n\t\t\t\t\t\t\t? hunkRanges[0].startLineNumber - zoneLineNumber\n\t\t\t\t\t\t\t: zoneLineNumber - hunkRanges[0].endLineNumber;\n\n\t\t\t\t\t\tdata = {\n\t\t\t\t\t\t\thunk: hunkData,\n\t\t\t\t\t\t\tdecorationIds,\n\t\t\t\t\t\t\tdiffViewZoneId: '',\n\t\t\t\t\t\t\tdiffViewZone: viewZoneData,\n\t\t\t\t\t\t\tlensActionsViewZoneIds,\n\t\t\t\t\t\t\tdistance: myDistance,\n\t\t\t\t\t\t\tposition: hunkRanges[0].getStartPosition().delta(-1),\n\t\t\t\t\t\t\tacceptHunk,\n\t\t\t\t\t\t\tdiscardHunk,\n\t\t\t\t\t\t\ttoggleDiff: !hunkData.isInsertion() ? toggleDiff : undefined,\n\t\t\t\t\t\t\tremove,\n\t\t\t\t\t\t\tmove,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tthis._hunkData.set(hunkData, data);\n\n\t\t\t\t\t} else if (hunkData.getState() !== HunkState.Pending) {\n\t\t\t\t\t\tdata.remove();\n\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// update distance and position based on modifiedRange-decoration\n\t\t\t\t\t\tconst zoneLineNumber = this._zone.position?.lineNumber ?? this._editor.getPosition()!.lineNumber;\n\t\t\t\t\t\tconst modifiedRangeNow = hunkRanges[0];\n\t\t\t\t\t\tdata.position = modifiedRangeNow.getStartPosition().delta(-1);\n\t\t\t\t\t\tdata.distance = zoneLineNumber <= modifiedRangeNow.startLineNumber\n\t\t\t\t\t\t\t? modifiedRangeNow.startLineNumber - zoneLineNumber\n\t\t\t\t\t\t\t: zoneLineNumber - modifiedRangeNow.endLineNumber;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (hunkData.getState() === HunkState.Pending && (!widgetData || data.distance < widgetData.distance)) {\n\t\t\t\t\t\twidgetData = data;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfor (const key of keysNow) {\n\t\t\t\t\tconst data = this._hunkData.get(key);\n\t\t\t\t\tif (data) {\n\t\t\t\t\t\tthis._hunkData.delete(key);\n\t\t\t\t\t\tdata.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (widgetData) {\n\t\t\t\tthis._zone.reveal(widgetData.position);\n\n\t\t\t\tconst mode = this._configService.getValue<'on' | 'off' | 'auto'>(InlineChatConfigKeys.AccessibleDiffView);\n\t\t\t\tif (mode === 'on' || mode === 'auto' && this._accessibilityService.isScreenReaderOptimized()) {\n\t\t\t\t\tthis._zone.widget.showAccessibleHunk(this._session, widgetData.hunk);\n\t\t\t\t}\n\n\t\t\t\tthis._ctxCurrentChangeHasDiff.set(Boolean(widgetData.toggleDiff));\n\n\t\t\t} else if (this._hunkData.size > 0) {\n\t\t\t\t// everything accepted or rejected\n\t\t\t\tlet oneAccepted = false;\n\t\t\t\tfor (const hunkData of this._session.hunkData.getInfo()) {\n\t\t\t\t\tif (hunkData.getState() === HunkState.Accepted) {\n\t\t\t\t\t\toneAccepted = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (oneAccepted) {\n\t\t\t\t\tthis._onDidAccept.fire();\n\t\t\t\t} else {\n\t\t\t\t\tthis._onDidDiscard.fire();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn widgetData;\n\t\t};\n\n\t\treturn renderHunks()?.position;\n\t}\n\n\tgetWholeRangeDecoration(): IModelDeltaDecoration[] {\n\t\t// don't render the blue in live mode\n\t\treturn [];\n\t}\n\n\tprivate async _doApplyChanges(ignoreLocal: boolean): Promise<void> {\n\n\t\tconst untitledModels: IUntitledTextEditorModel[] = [];\n\n\t\tconst editor = this._instaService.createInstance(DefaultChatTextEditor);\n\n\n\t\tfor (const request of this._session.chatModel.getRequests()) {\n\n\t\t\tif (!request.response?.response) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tfor (const item of request.response.response.value) {\n\t\t\t\tif (item.kind !== 'textEditGroup') {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (ignoreLocal && isEqual(item.uri, this._session.textModelN.uri)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tawait editor.apply(request.response, item, undefined);\n\n\t\t\t\tif (item.uri.scheme === Schemas.untitled) {\n\t\t\t\t\tconst untitled = this._textFileService.untitled.get(item.uri);\n\t\t\t\t\tif (untitled) {\n\t\t\t\t\t\tuntitledModels.push(untitled);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfor (const untitledModel of untitledModels) {\n\t\t\tif (!untitledModel.isDisposed()) {\n\t\t\t\tawait untitledModel.resolve();\n\t\t\t\tawait untitledModel.save({ reason: SaveReason.EXPLICIT });\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport interface ProgressingEditsOptions {\n\tduration: number;\n\ttoken: CancellationToken;\n}\n\ntype HunkDisplayData = {\n\n\tdecorationIds: string[];\n\n\tdiffViewZoneId: string | undefined;\n\tdiffViewZone: IViewZone;\n\n\tlensActionsViewZoneIds?: string[];\n\n\tdistance: number;\n\tposition: Position;\n\tacceptHunk: () => void;\n\tdiscardHunk: () => void;\n\ttoggleDiff?: () => any;\n\tremove(): void;\n\tmove: (next: boolean) => void;\n\n\thunk: HunkInformation;\n};\n\nfunction changeDecorationsAndViewZones(editor: ICodeEditor, callback: (accessor: IModelDecorationsChangeAccessor, viewZoneAccessor: IViewZoneChangeAccessor) => void): void {\n\teditor.changeDecorations(decorationsAccessor => {\n\t\teditor.changeViewZones(viewZoneAccessor => {\n\t\t\tcallback(decorationsAccessor, viewZoneAccessor);\n\t\t});\n\t});\n}\n\nexport interface IInlineChatMetadata {\n\tmodelId: string | undefined;\n\textensionId: VersionedExtensionId | undefined;\n\trequestId: string | undefined;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { WindowIntervalTimer } from '../../../../base/browser/dom.js';\nimport { CancellationToken } from '../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { themeColorFromId, ThemeIcon } from '../../../../base/common/themables.js';\nimport { ICodeEditor, IViewZone, IViewZoneChangeAccessor } from '../../../../editor/browser/editorBrowser.js';\nimport { StableEditorScrollState } from '../../../../editor/browser/stableEditorScroll.js';\nimport { LineSource, RenderOptions, renderLines } from '../../../../editor/browser/widget/diffEditor/components/diffEditorViewZones/renderLines.js';\nimport { ISingleEditOperation } from '../../../../editor/common/core/editOperation.js';\nimport { LineRange } from '../../../../editor/common/core/ranges/lineRange.js';\nimport { Position } from '../../../../editor/common/core/position.js';\nimport { Range } from '../../../../editor/common/core/range.js';\nimport { IEditorDecorationsCollection } from '../../../../editor/common/editorCommon.js';\nimport { IModelDecorationsChangeAccessor, IModelDeltaDecoration, IValidEditOperation, MinimapPosition, OverviewRulerLane, TrackedRangeStickiness } from '../../../../editor/common/model.js';\nimport { ModelDecorationOptions } from '../../../../editor/common/model/textModel.js';\nimport { IEditorWorkerService } from '../../../../editor/common/services/editorWorker.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { Progress } from '../../../../platform/progress/common/progress.js';\nimport { SaveReason } from '../../../common/editor.js';\nimport { countWords } from '../../chat/common/chatWordCounter.js';\nimport { HunkInformation, Session, HunkState } from './inlineChatSession.js';\nimport { InlineChatZoneWidget } from './inlineChatZoneWidget.js';\nimport { ACTION_TOGGLE_DIFF, CTX_INLINE_CHAT_CHANGE_HAS_DIFF, CTX_INLINE_CHAT_CHANGE_SHOWS_DIFF, InlineChatConfigKeys, MENU_INLINE_CHAT_ZONE, minimapInlineChatDiffInserted, overviewRulerInlineChatDiffInserted } from '../common/inlineChat.js';\nimport { assertType } from '../../../../base/common/types.js';\nimport { performAsyncTextEdit, asProgressiveEdit } from './utils.js';\nimport { IAccessibilityService } from '../../../../platform/accessibility/common/accessibility.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { ITextFileService } from '../../../services/textfile/common/textfiles.js';\nimport { IUntitledTextEditorModel } from '../../../services/untitled/common/untitledTextEditorModel.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { DefaultChatTextEditor } from '../../chat/browser/codeBlockPart.js';\nimport { isEqual } from '../../../../base/common/resources.js';\nimport { Iterable } from '../../../../base/common/iterator.js';\nimport { ConflictActionsFactory, IContentWidgetAction } from '../../mergeEditor/browser/view/conflictActions.js';\nimport { observableValue } from '../../../../base/common/observable.js';\nimport { IMenuService, MenuItemAction } from '../../../../platform/actions/common/actions.js';\nimport { InlineDecoration, InlineDecorationType } from '../../../../editor/common/viewModel/inlineDecorations.js';\nimport { EditSources } from '../../../../editor/common/textModelEditSource.js';\nimport { VersionedExtensionId } from '../../../../editor/common/languages.js';\n\nexport interface IEditObserver {\n\tstart(): void;\n\tstop(): void;\n}\n\nexport const enum HunkAction {\n\tAccept,\n\tDiscard,\n\tMoveNext,\n\tMovePrev,\n\tToggleDiff\n}\n\nexport class LiveStrategy {\n\n\tprivate readonly _decoInsertedText = ModelDecorationOptions.register({\n\t\tdescription: 'inline-modified-line',\n\t\tclassName: 'inline-chat-inserted-range-linehighlight',\n\t\tisWholeLine: true,\n\t\toverviewRuler: {\n\t\t\tposition: OverviewRulerLane.Full,\n\t\t\tcolor: themeColorFromId(overviewRulerInlineChatDiffInserted),\n\t\t},\n\t\tminimap: {\n\t\t\tposition: MinimapPosition.Inline,\n\t\t\tcolor: themeColorFromId(minimapInlineChatDiffInserted),\n\t\t}\n\t});\n\n\tprivate readonly _decoInsertedTextRange = ModelDecorationOptions.register({\n\t\tdescription: 'inline-chat-inserted-range-linehighlight',\n\t\tclassName: 'inline-chat-inserted-range',\n\t\tstickiness: TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,\n\t});\n\n\tprotected readonly _store = new DisposableStore();\n\tprotected readonly _onDidAccept = this._store.add(new Emitter<void>());\n\tprotected readonly _onDidDiscard = this._store.add(new Emitter<void>());\n\tprivate readonly _ctxCurrentChangeHasDiff: IContextKey<boolean>;\n\tprivate readonly _ctxCurrentChangeShowsDiff: IContextKey<boolean>;\n\tprivate readonly _progressiveEditingDecorations: IEditorDecorationsCollection;\n\tprivate readonly _lensActionsFactory: ConflictActionsFactory;\n\tprivate _editCount: number = 0;\n\tprivate readonly _hunkData = new Map<HunkInformation, HunkDisplayData>();\n\n\treadonly onDidAccept: Event<void> = this._onDidAccept.event;\n\treadonly onDidDiscard: Event<void> = this._onDidDiscard.event;\n\n\tconstructor(\n\t\tprotected readonly _session: Session,\n\t\tprotected readonly _editor: ICodeEditor,\n\t\tprotected readonly _zone: InlineChatZoneWidget,\n\t\tprivate readonly _showOverlayToolbar: boolean,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IEditorWorkerService protected readonly _editorWorkerService: IEditorWorkerService,\n\t\t@IAccessibilityService private readonly _accessibilityService: IAccessibilityService,\n\t\t@IConfigurationService private readonly _configService: IConfigurationService,\n\t\t@IMenuService private readonly _menuService: IMenuService,\n\t\t@IContextKeyService private readonly _contextService: IContextKeyService,\n\t\t@ITextFileService private readonly _textFileService: ITextFileService,\n\t\t@IInstantiationService protected readonly _instaService: IInstantiationService\n\t) {\n\t\tthis._ctxCurrentChangeHasDiff = CTX_INLINE_CHAT_CHANGE_HAS_DIFF.bindTo(contextKeyService);\n\t\tthis._ctxCurrentChangeShowsDiff = CTX_INLINE_CHAT_CHANGE_SHOWS_DIFF.bindTo(contextKeyService);\n\n\t\tthis._progressiveEditingDecorations = this._editor.createDecorationsCollection();\n\t\tthis._lensActionsFactory = this._store.add(new ConflictActionsFactory(this._editor));\n\t}\n\n\tdispose(): void {\n\t\tthis._resetDiff();\n\t\tthis._store.dispose();\n\t}\n\n\tprivate _resetDiff(): void {\n\t\tthis._ctxCurrentChangeHasDiff.reset();\n\t\tthis._ctxCurrentChangeShowsDiff.reset();\n\t\tthis._zone.widget.updateStatus('');\n\t\tthis._progressiveEditingDecorations.clear();\n\n\n\t\tfor (const data of this._hunkData.values()) {\n\t\t\tdata.remove();\n\t\t}\n\t}\n\n\tasync apply() {\n\t\tthis._resetDiff();\n\t\tif (this._editCount > 0) {\n\t\t\tthis._editor.pushUndoStop();\n\t\t}\n\t\tawait this._doApplyChanges(true);\n\t}\n\n\tcancel() {\n\t\tthis._resetDiff();\n\t\treturn this._session.hunkData.discardAll();\n\t}\n\n\tasync makeChanges(edits: ISingleEditOperation[], obs: IEditObserver, undoStopBefore: boolean, metadata: IInlineChatMetadata): Promise<void> {\n\t\treturn this._makeChanges(edits, obs, undefined, undefined, undoStopBefore, metadata);\n\t}\n\n\tasync makeProgressiveChanges(edits: ISingleEditOperation[], obs: IEditObserver, opts: ProgressingEditsOptions, undoStopBefore: boolean, metadata: IInlineChatMetadata): Promise<void> {\n\n\t\t// add decorations once per line that got edited\n\t\tconst progress = new Progress<IValidEditOperation[]>(edits => {\n\n\t\t\tconst newLines = new Set<number>();\n\t\t\tfor (const edit of edits) {\n\t\t\t\tLineRange.fromRange(edit.range).forEach(line => newLines.add(line));\n\t\t\t}\n\t\t\tconst existingRanges = this._progressiveEditingDecorations.getRanges().map(LineRange.fromRange);\n\t\t\tfor (const existingRange of existingRanges) {\n\t\t\t\texistingRange.forEach(line => newLines.delete(line));\n\t\t\t}\n\t\t\tconst newDecorations: IModelDeltaDecoration[] = [];\n\t\t\tfor (const line of newLines) {\n\t\t\t\tnewDecorations.push({ range: new Range(line, 1, line, Number.MAX_VALUE), options: this._decoInsertedText });\n\t\t\t}\n\n\t\t\tthis._progressiveEditingDecorations.append(newDecorations);\n\t\t});\n\t\treturn this._makeChanges(edits, obs, opts, progress, undoStopBefore, metadata);\n\t}\n\n\tprivate async _makeChanges(edits: ISingleEditOperation[], obs: IEditObserver, opts: ProgressingEditsOptions | undefined, progress: Progress<IValidEditOperation[]> | undefined, undoStopBefore: boolean, metadata: IInlineChatMetadata): Promise<void> {\n\n\t\t// push undo stop before first edit\n\t\tif (undoStopBefore) {\n\t\t\tthis._editor.pushUndoStop();\n\t\t}\n\n\t\tthis._editCount++;\n\t\tconst editSource = EditSources.inlineChatApplyEdit({\n\t\t\tmodelId: metadata.modelId,\n\t\t\textensionId: metadata.extensionId,\n\t\t\trequestId: metadata.requestId,\n\t\t\tsessionId: undefined,\n\t\t\tlanguageId: this._session.textModelN.getLanguageId(),\n\t\t});\n\n\t\tif (opts) {\n\t\t\t// ASYNC\n\t\t\tconst durationInSec = opts.duration / 1000;\n\t\t\tfor (const edit of edits) {\n\t\t\t\tconst wordCount = countWords(edit.text ?? '');\n\t\t\t\tconst speed = wordCount / durationInSec;\n\t\t\t\t// console.log({ durationInSec, wordCount, speed: wordCount / durationInSec });\n\t\t\t\tconst asyncEdit = asProgressiveEdit(new WindowIntervalTimer(this._zone.domNode), edit, speed, opts.token);\n\t\t\t\tawait performAsyncTextEdit(this._session.textModelN, asyncEdit, progress, obs, editSource);\n\t\t\t}\n\n\t\t} else {\n\t\t\t// SYNC\n\t\t\tobs.start();\n\t\t\tthis._session.textModelN.pushEditOperations(null, edits, (undoEdits) => {\n\t\t\t\tprogress?.report(undoEdits);\n\t\t\t\treturn null;\n\t\t\t}, undefined, editSource);\n\t\t\tobs.stop();\n\t\t}\n\t}\n\n\tperformHunkAction(hunk: HunkInformation | undefined, action: HunkAction) {\n\t\tconst displayData = this._findDisplayData(hunk);\n\n\t\tif (!displayData) {\n\t\t\t// no hunks (left or not yet) found, make sure to\n\t\t\t// finish the sessions\n\t\t\tif (action === HunkAction.Accept) {\n\t\t\t\tthis._onDidAccept.fire();\n\t\t\t} else if (action === HunkAction.Discard) {\n\t\t\t\tthis._onDidDiscard.fire();\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\n\t\tif (action === HunkAction.Accept) {\n\t\t\tdisplayData.acceptHunk();\n\t\t} else if (action === HunkAction.Discard) {\n\t\t\tdisplayData.discardHunk();\n\t\t} else if (action === HunkAction.MoveNext) {\n\t\t\tdisplayData.move(true);\n\t\t} else if (action === HunkAction.MovePrev) {\n\t\t\tdisplayData.move(false);\n\t\t} else if (action === HunkAction.ToggleDiff) {\n\t\t\tdisplayData.toggleDiff?.();\n\t\t}\n\t}\n\n\tprivate _findDisplayData(hunkInfo?: HunkInformation) {\n\t\tlet result: HunkDisplayData | undefined;\n\t\tif (hunkInfo) {\n\t\t\t// use context hunk (from tool/buttonbar)\n\t\t\tresult = this._hunkData.get(hunkInfo);\n\t\t}\n\n\t\tif (!result && this._zone.position) {\n\t\t\t// find nearest from zone position\n\t\t\tconst zoneLine = this._zone.position.lineNumber;\n\t\t\tlet distance: number = Number.MAX_SAFE_INTEGER;\n\t\t\tfor (const candidate of this._hunkData.values()) {\n\t\t\t\tif (candidate.hunk.getState() !== HunkState.Pending) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst hunkRanges = candidate.hunk.getRangesN();\n\t\t\t\tif (hunkRanges.length === 0) {\n\t\t\t\t\t// bogous hunk\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst myDistance = zoneLine <= hunkRanges[0].startLineNumber\n\t\t\t\t\t? hunkRanges[0].startLineNumber - zoneLine\n\t\t\t\t\t: zoneLine - hunkRanges[0].endLineNumber;\n\n\t\t\t\tif (myDistance < distance) {\n\t\t\t\t\tdistance = myDistance;\n\t\t\t\t\tresult = candidate;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!result) {\n\t\t\t// fallback: first hunk that is pending\n\t\t\tresult = Iterable.first(Iterable.filter(this._hunkData.values(), candidate => candidate.hunk.getState() === HunkState.Pending));\n\t\t}\n\t\treturn result;\n\t}\n\n\tasync renderChanges() {\n\n\t\tthis._progressiveEditingDecorations.clear();\n\n\t\tconst renderHunks = () => {\n\n\t\t\tlet widgetData: HunkDisplayData | undefined;\n\n\t\t\tchangeDecorationsAndViewZones(this._editor, (decorationsAccessor, viewZoneAccessor) => {\n\n\t\t\t\tconst keysNow = new Set(this._hunkData.keys());\n\t\t\t\twidgetData = undefined;\n\n\t\t\t\tfor (const hunkData of this._session.hunkData.getInfo()) {\n\n\t\t\t\t\tkeysNow.delete(hunkData);\n\n\t\t\t\t\tconst hunkRanges = hunkData.getRangesN();\n\t\t\t\t\tlet data = this._hunkData.get(hunkData);\n\t\t\t\t\tif (!data) {\n\t\t\t\t\t\t// first time -> create decoration\n\t\t\t\t\t\tconst decorationIds: string[] = [];\n\t\t\t\t\t\tfor (let i = 0; i < hunkRanges.length; i++) {\n\t\t\t\t\t\t\tdecorationIds.push(decorationsAccessor.addDecoration(hunkRanges[i], i === 0\n\t\t\t\t\t\t\t\t? this._decoInsertedText\n\t\t\t\t\t\t\t\t: this._decoInsertedTextRange)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst acceptHunk = () => {\n\t\t\t\t\t\t\thunkData.acceptChanges();\n\t\t\t\t\t\t\trenderHunks();\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst discardHunk = () => {\n\t\t\t\t\t\t\thunkData.discardChanges();\n\t\t\t\t\t\t\trenderHunks();\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t// original view zone\n\t\t\t\t\t\tconst mightContainNonBasicASCII = this._session.textModel0.mightContainNonBasicASCII();\n\t\t\t\t\t\tconst mightContainRTL = this._session.textModel0.mightContainRTL();\n\t\t\t\t\t\tconst renderOptions = RenderOptions.fromEditor(this._editor);\n\t\t\t\t\t\tconst originalRange = hunkData.getRanges0()[0];\n\t\t\t\t\t\tconst source = new LineSource(\n\t\t\t\t\t\t\tLineRange.fromRangeInclusive(originalRange).mapToLineArray(l => this._session.textModel0.tokenization.getLineTokens(l)),\n\t\t\t\t\t\t\t[],\n\t\t\t\t\t\t\tmightContainNonBasicASCII,\n\t\t\t\t\t\t\tmightContainRTL,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconst domNode = document.createElement('div');\n\t\t\t\t\t\tdomNode.className = 'inline-chat-original-zone2';\n\t\t\t\t\t\tconst result = renderLines(source, renderOptions, [new InlineDecoration(new Range(originalRange.startLineNumber, 1, originalRange.startLineNumber, 1), '', InlineDecorationType.Regular)], domNode);\n\t\t\t\t\t\tconst viewZoneData: IViewZone = {\n\t\t\t\t\t\t\tafterLineNumber: -1,\n\t\t\t\t\t\t\theightInLines: result.heightInLines,\n\t\t\t\t\t\t\tdomNode,\n\t\t\t\t\t\t\tordinal: 50000 + 2 // more than https://github.com/microsoft/vscode/blob/bf52a5cfb2c75a7327c9adeaefbddc06d529dcad/src/vs/workbench/contrib/inlineChat/browser/inlineChatZoneWidget.ts#L42\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst toggleDiff = () => {\n\t\t\t\t\t\t\tconst scrollState = StableEditorScrollState.capture(this._editor);\n\t\t\t\t\t\t\tchangeDecorationsAndViewZones(this._editor, (_decorationsAccessor, viewZoneAccessor) => {\n\t\t\t\t\t\t\t\tassertType(data);\n\t\t\t\t\t\t\t\tif (!data.diffViewZoneId) {\n\t\t\t\t\t\t\t\t\tconst [hunkRange] = hunkData.getRangesN();\n\t\t\t\t\t\t\t\t\tviewZoneData.afterLineNumber = hunkRange.startLineNumber - 1;\n\t\t\t\t\t\t\t\t\tdata.diffViewZoneId = viewZoneAccessor.addZone(viewZoneData);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tviewZoneAccessor.removeZone(data.diffViewZoneId!);\n\t\t\t\t\t\t\t\t\tdata.diffViewZoneId = undefined;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tthis._ctxCurrentChangeShowsDiff.set(typeof data?.diffViewZoneId === 'string');\n\t\t\t\t\t\t\tscrollState.restore(this._editor);\n\t\t\t\t\t\t};\n\n\n\t\t\t\t\t\tlet lensActions: DisposableStore | undefined;\n\t\t\t\t\t\tconst lensActionsViewZoneIds: string[] = [];\n\n\t\t\t\t\t\tif (this._showOverlayToolbar && hunkData.getState() === HunkState.Pending) {\n\n\t\t\t\t\t\t\tlensActions = new DisposableStore();\n\n\t\t\t\t\t\t\tconst menu = this._menuService.createMenu(MENU_INLINE_CHAT_ZONE, this._contextService);\n\t\t\t\t\t\t\tconst makeActions = () => {\n\t\t\t\t\t\t\t\tconst actions: IContentWidgetAction[] = [];\n\t\t\t\t\t\t\t\tconst tuples = menu.getActions({ arg: hunkData });\n\t\t\t\t\t\t\t\tfor (const [, group] of tuples) {\n\t\t\t\t\t\t\t\t\tfor (const item of group) {\n\t\t\t\t\t\t\t\t\t\tif (item instanceof MenuItemAction) {\n\n\t\t\t\t\t\t\t\t\t\t\tlet text = item.label;\n\n\t\t\t\t\t\t\t\t\t\t\tif (item.id === ACTION_TOGGLE_DIFF) {\n\t\t\t\t\t\t\t\t\t\t\t\ttext = item.checked ? 'Hide Changes' : 'Show Changes';\n\t\t\t\t\t\t\t\t\t\t\t} else if (ThemeIcon.isThemeIcon(item.item.icon)) {\n\t\t\t\t\t\t\t\t\t\t\t\ttext = `$(${item.item.icon.id}) ${text}`;\n\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\tactions.push({\n\t\t\t\t\t\t\t\t\t\t\t\ttext,\n\t\t\t\t\t\t\t\t\t\t\t\ttooltip: item.tooltip,\n\t\t\t\t\t\t\t\t\t\t\t\taction: async () => item.run(),\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\treturn actions;\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tconst obs = observableValue(this, makeActions());\n\t\t\t\t\t\t\tlensActions.add(menu.onDidChange(() => obs.set(makeActions(), undefined)));\n\t\t\t\t\t\t\tlensActions.add(menu);\n\n\t\t\t\t\t\t\tlensActions.add(this._lensActionsFactory.createWidget(viewZoneAccessor,\n\t\t\t\t\t\t\t\thunkRanges[0].startLineNumber - 1,\n\t\t\t\t\t\t\t\tobs,\n\t\t\t\t\t\t\t\tlensActionsViewZoneIds\n\t\t\t\t\t\t\t));\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst remove = () => {\n\t\t\t\t\t\t\tchangeDecorationsAndViewZones(this._editor, (decorationsAccessor, viewZoneAccessor) => {\n\t\t\t\t\t\t\t\tassertType(data);\n\t\t\t\t\t\t\t\tfor (const decorationId of data.decorationIds) {\n\t\t\t\t\t\t\t\t\tdecorationsAccessor.removeDecoration(decorationId);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (data.diffViewZoneId) {\n\t\t\t\t\t\t\t\t\tviewZoneAccessor.removeZone(data.diffViewZoneId!);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tdata.decorationIds = [];\n\t\t\t\t\t\t\t\tdata.diffViewZoneId = undefined;\n\n\t\t\t\t\t\t\t\tdata.lensActionsViewZoneIds?.forEach(viewZoneAccessor.removeZone);\n\t\t\t\t\t\t\t\tdata.lensActionsViewZoneIds = undefined;\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tlensActions?.dispose();\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst move = (next: boolean) => {\n\t\t\t\t\t\t\tconst keys = Array.from(this._hunkData.keys());\n\t\t\t\t\t\t\tconst idx = keys.indexOf(hunkData);\n\t\t\t\t\t\t\tconst nextIdx = (idx + (next ? 1 : -1) + keys.length) % keys.length;\n\t\t\t\t\t\t\tif (nextIdx !== idx) {\n\t\t\t\t\t\t\t\tconst nextData = this._hunkData.get(keys[nextIdx])!;\n\t\t\t\t\t\t\t\tthis._zone.updatePositionAndHeight(nextData?.position);\n\t\t\t\t\t\t\t\trenderHunks();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tconst zoneLineNumber = this._zone.position?.lineNumber ?? this._editor.getPosition()!.lineNumber;\n\t\t\t\t\t\tconst myDistance = zoneLineNumber <= hunkRanges[0].startLineNumber\n\t\t\t\t\t\t\t? hunkRanges[0].startLineNumber - zoneLineNumber\n\t\t\t\t\t\t\t: zoneLineNumber - hunkRanges[0].endLineNumber;\n\n\t\t\t\t\t\tdata = {\n\t\t\t\t\t\t\thunk: hunkData,\n\t\t\t\t\t\t\tdecorationIds,\n\t\t\t\t\t\t\tdiffViewZoneId: '',\n\t\t\t\t\t\t\tdiffViewZone: viewZoneData,\n\t\t\t\t\t\t\tlensActionsViewZoneIds,\n\t\t\t\t\t\t\tdistance: myDistance,\n\t\t\t\t\t\t\tposition: hunkRanges[0].getStartPosition().delta(-1),\n\t\t\t\t\t\t\tacceptHunk,\n\t\t\t\t\t\t\tdiscardHunk,\n\t\t\t\t\t\t\ttoggleDiff: !hunkData.isInsertion() ? toggleDiff : undefined,\n\t\t\t\t\t\t\tremove,\n\t\t\t\t\t\t\tmove,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\tthis._hunkData.set(hunkData, data);\n\n\t\t\t\t\t} else if (hunkData.getState() !== HunkState.Pending) {\n\t\t\t\t\t\tdata.remove();\n\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// update distance and position based on modifiedRange-decoration\n\t\t\t\t\t\tconst zoneLineNumber = this._zone.position?.lineNumber ?? this._editor.getPosition()!.lineNumber;\n\t\t\t\t\t\tconst modifiedRangeNow = hunkRanges[0];\n\t\t\t\t\t\tdata.position = modifiedRangeNow.getStartPosition().delta(-1);\n\t\t\t\t\t\tdata.distance = zoneLineNumber <= modifiedRangeNow.startLineNumber\n\t\t\t\t\t\t\t? modifiedRangeNow.startLineNumber - zoneLineNumber\n\t\t\t\t\t\t\t: zoneLineNumber - modifiedRangeNow.endLineNumber;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (hunkData.getState() === HunkState.Pending && (!widgetData || data.distance < widgetData.distance)) {\n\t\t\t\t\t\twidgetData = data;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfor (const key of keysNow) {\n\t\t\t\t\tconst data = this._hunkData.get(key);\n\t\t\t\t\tif (data) {\n\t\t\t\t\t\tthis._hunkData.delete(key);\n\t\t\t\t\t\tdata.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (widgetData) {\n\t\t\t\tthis._zone.reveal(widgetData.position);\n\n\t\t\t\tconst mode = this._configService.getValue<'on' | 'off' | 'auto'>(InlineChatConfigKeys.AccessibleDiffView);\n\t\t\t\tif (mode === 'on' || mode === 'auto' && this._accessibilityService.isScreenReaderOptimized()) {\n\t\t\t\t\tthis._zone.widget.showAccessibleHunk(this._session, widgetData.hunk);\n\t\t\t\t}\n\n\t\t\t\tthis._ctxCurrentChangeHasDiff.set(Boolean(widgetData.toggleDiff));\n\n\t\t\t} else if (this._hunkData.size > 0) {\n\t\t\t\t// everything accepted or rejected\n\t\t\t\tlet oneAccepted = false;\n\t\t\t\tfor (const hunkData of this._session.hunkData.getInfo()) {\n\t\t\t\t\tif (hunkData.getState() === HunkState.Accepted) {\n\t\t\t\t\t\toneAccepted = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (oneAccepted) {\n\t\t\t\t\tthis._onDidAccept.fire();\n\t\t\t\t} else {\n\t\t\t\t\tthis._onDidDiscard.fire();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn widgetData;\n\t\t};\n\n\t\treturn renderHunks()?.position;\n\t}\n\n\tgetWholeRangeDecoration(): IModelDeltaDecoration[] {\n\t\t// don't render the blue in live mode\n\t\treturn [];\n\t}\n\n\tprivate async _doApplyChanges(ignoreLocal: boolean): Promise<void> {\n\n\t\tconst untitledModels: IUntitledTextEditorModel[] = [];\n\n\t\tconst editor = this._instaService.createInstance(DefaultChatTextEditor);\n\n\n\t\tfor (const request of this._session.chatModel.getRequests()) {\n\n\t\t\tif (!request.response?.response) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tfor (const item of request.response.response.value) {\n\t\t\t\tif (item.kind !== 'textEditGroup') {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (ignoreLocal && isEqual(item.uri, this._session.textModelN.uri)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tawait editor.apply(request.response, item, undefined);\n\n\t\t\t\tif (item.uri.scheme === Schemas.untitled) {\n\t\t\t\t\tconst untitled = this._textFileService.untitled.get(item.uri);\n\t\t\t\t\tif (untitled) {\n\t\t\t\t\t\tuntitledModels.push(untitled);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfor (const untitledModel of untitledModels) {\n\t\t\tif (!untitledModel.isDisposed()) {\n\t\t\t\tawait untitledModel.resolve();\n\t\t\t\tawait untitledModel.save({ reason: SaveReason.EXPLICIT });\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport interface ProgressingEditsOptions {\n\tduration: number;\n\ttoken: CancellationToken;\n}\n\ntype HunkDisplayData = {\n\n\tdecorationIds: string[];\n\n\tdiffViewZoneId: string | undefined;\n\tdiffViewZone: IViewZone;\n\n\tlensActionsViewZoneIds?: string[];\n\n\tdistance: number;\n\tposition: Position;\n\tacceptHunk: () => void;\n\tdiscardHunk: () => void;\n\ttoggleDiff?: () => any;\n\tremove(): void;\n\tmove: (next: boolean) => void;\n\n\thunk: HunkInformation;\n};\n\nfunction changeDecorationsAndViewZones(editor: ICodeEditor, callback: (accessor: IModelDecorationsChangeAccessor, viewZoneAccessor: IViewZoneChangeAccessor) => void): void {\n\teditor.changeDecorations(decorationsAccessor => {\n\t\teditor.changeViewZones(viewZoneAccessor => {\n\t\t\tcallback(decorationsAccessor, viewZoneAccessor);\n\t\t});\n\t});\n}\n\nexport interface IInlineChatMetadata {\n\tmodelId: string | undefined;\n\textensionId: VersionedExtensionId | undefined;\n\trequestId: string | undefined;\n}\n"]}