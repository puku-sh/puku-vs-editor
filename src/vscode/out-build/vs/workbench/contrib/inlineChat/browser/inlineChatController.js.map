{"version":3,"sources":["vs/workbench/contrib/inlineChat/browser/inlineChatController.ts"],"names":[],"mappings":"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","file":"inlineChatController.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as aria from '../../../../base/browser/ui/aria/aria.js';\nimport { alert } from '../../../../base/browser/ui/aria/aria.js';\nimport { Barrier, DeferredPromise, Queue, raceCancellation } from '../../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../../base/common/cancellation.js';\nimport { toErrorMessage } from '../../../../base/common/errorMessage.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Lazy } from '../../../../base/common/lazy.js';\nimport { DisposableStore, MutableDisposable, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { MovingAverage } from '../../../../base/common/numbers.js';\nimport { autorun, derived, IObservable, observableSignalFromEvent, observableValue, waitForState } from '../../../../base/common/observable.js';\nimport { isEqual } from '../../../../base/common/resources.js';\nimport { StopWatch } from '../../../../base/common/stopwatch.js';\nimport { assertType } from '../../../../base/common/types.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { ICodeEditor, isCodeEditor } from '../../../../editor/browser/editorBrowser.js';\nimport { observableCodeEditor } from '../../../../editor/browser/observableCodeEditor.js';\nimport { ICodeEditorService } from '../../../../editor/browser/services/codeEditorService.js';\nimport { EditorOption } from '../../../../editor/common/config/editorOptions.js';\nimport { IPosition, Position } from '../../../../editor/common/core/position.js';\nimport { IRange, Range } from '../../../../editor/common/core/range.js';\nimport { ISelection, Selection, SelectionDirection } from '../../../../editor/common/core/selection.js';\nimport { IEditorContribution } from '../../../../editor/common/editorCommon.js';\nimport { TextEdit, VersionedExtensionId } from '../../../../editor/common/languages.js';\nimport { IValidEditOperation } from '../../../../editor/common/model.js';\nimport { IEditorWorkerService } from '../../../../editor/common/services/editorWorker.js';\nimport { IMarkerDecorationsService } from '../../../../editor/common/services/markerDecorations.js';\nimport { DefaultModelSHA1Computer } from '../../../../editor/common/services/modelService.js';\nimport { EditSuggestionId } from '../../../../editor/common/textModelEditSource.js';\nimport { InlineCompletionsController } from '../../../../editor/contrib/inlineCompletions/browser/controller/inlineCompletionsController.js';\nimport { MessageController } from '../../../../editor/contrib/message/browser/messageController.js';\nimport { localize } from '../../../../nls.js';\nimport { MenuId } from '../../../../platform/actions/common/actions.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { IInstantiationService, ServicesAccessor } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { observableConfigValue } from '../../../../platform/observable/common/platformObservableUtils.js';\nimport { ISharedWebContentExtractorService } from '../../../../platform/webContentExtractor/common/webContentExtractor.js';\nimport { IEditorService, SIDE_GROUP } from '../../../services/editor/common/editorService.js';\nimport { IChatAttachmentResolveService } from '../../chat/browser/chatAttachmentResolveService.js';\nimport { IChatWidgetLocationOptions } from '../../chat/browser/chatWidget.js';\nimport { ChatContextKeys } from '../../chat/common/chatContextKeys.js';\nimport { IChatEditingSession, ModifiedFileEntryState } from '../../chat/common/chatEditingService.js';\nimport { ChatRequestRemovalReason, IChatRequestModel, IChatTextEditGroup, IChatTextEditGroupState, IResponse } from '../../chat/common/chatModel.js';\nimport { ChatMode } from '../../chat/common/chatModes.js';\nimport { IChatService } from '../../chat/common/chatService.js';\nimport { IChatRequestVariableEntry, IDiagnosticVariableEntryFilterData } from '../../chat/common/chatVariableEntries.js';\nimport { ChatAgentLocation } from '../../chat/common/constants.js';\nimport { isNotebookContainingCellEditor as isNotebookWithCellEditor } from '../../notebook/browser/notebookEditor.js';\nimport { INotebookEditorService } from '../../notebook/browser/services/notebookEditorService.js';\nimport { ICellEditOperation } from '../../notebook/common/notebookCommon.js';\nimport { INotebookService } from '../../notebook/common/notebookService.js';\nimport { CTX_INLINE_CHAT_EDITING, CTX_INLINE_CHAT_REQUEST_IN_PROGRESS, CTX_INLINE_CHAT_RESPONSE_TYPE, CTX_INLINE_CHAT_VISIBLE, INLINE_CHAT_ID, InlineChatConfigKeys, InlineChatResponseType } from '../common/inlineChat.js';\nimport { HunkInformation, Session, StashedSession } from './inlineChatSession.js';\nimport { IInlineChatSession2, IInlineChatSessionService, moveToPanelChat } from './inlineChatSessionService.js';\nimport { InlineChatError } from './inlineChatSessionServiceImpl.js';\nimport { HunkAction, IEditObserver, IInlineChatMetadata, LiveStrategy, ProgressingEditsOptions } from './inlineChatStrategies.js';\nimport { EditorBasedInlineChatWidget } from './inlineChatWidget.js';\nimport { InlineChatZoneWidget } from './inlineChatZoneWidget.js';\n\nexport const enum State {\n\tCREATE_SESSION = 'CREATE_SESSION',\n\tINIT_UI = 'INIT_UI',\n\tWAIT_FOR_INPUT = 'WAIT_FOR_INPUT',\n\tSHOW_REQUEST = 'SHOW_REQUEST',\n\tPAUSE = 'PAUSE',\n\tCANCEL = 'CANCEL',\n\tACCEPT = 'DONE',\n}\n\nconst enum Message {\n\tNONE = 0,\n\tACCEPT_SESSION = 1 << 0,\n\tCANCEL_SESSION = 1 << 1,\n\tPAUSE_SESSION = 1 << 2,\n\tCANCEL_REQUEST = 1 << 3,\n\tCANCEL_INPUT = 1 << 4,\n\tACCEPT_INPUT = 1 << 5,\n}\n\nexport abstract class InlineChatRunOptions {\n\tinitialSelection?: ISelection;\n\tinitialRange?: IRange;\n\tmessage?: string;\n\tattachments?: URI[];\n\tautoSend?: boolean;\n\texistingSession?: Session;\n\tposition?: IPosition;\n\n\tstatic isInlineChatRunOptions(options: any): options is InlineChatRunOptions {\n\t\tconst { initialSelection, initialRange, message, autoSend, position, existingSession, attachments: attachments } = <InlineChatRunOptions>options;\n\t\tif (\n\t\t\ttypeof message !== 'undefined' && typeof message !== 'string'\n\t\t\t|| typeof autoSend !== 'undefined' && typeof autoSend !== 'boolean'\n\t\t\t|| typeof initialRange !== 'undefined' && !Range.isIRange(initialRange)\n\t\t\t|| typeof initialSelection !== 'undefined' && !Selection.isISelection(initialSelection)\n\t\t\t|| typeof position !== 'undefined' && !Position.isIPosition(position)\n\t\t\t|| typeof existingSession !== 'undefined' && !(existingSession instanceof Session)\n\t\t\t|| typeof attachments !== 'undefined' && (!Array.isArray(attachments) || !attachments.every(item => item instanceof URI))\n\t\t) {\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n}\n\nexport class InlineChatController implements IEditorContribution {\n\n\tstatic ID = 'editor.contrib.inlineChatController';\n\n\tstatic get(editor: ICodeEditor) {\n\t\treturn editor.getContribution<InlineChatController>(InlineChatController.ID);\n\t}\n\n\tprivate readonly _delegate: IObservable<InlineChatController1 | InlineChatController2>;\n\n\tconstructor(\n\t\teditor: ICodeEditor,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@INotebookEditorService private readonly _notebookEditorService: INotebookEditorService\n\t) {\n\t\tconst notebookAgent = observableConfigValue(InlineChatConfigKeys.notebookAgent, false, configurationService);\n\n\t\tthis._delegate = derived(r => {\n\t\t\tconst isNotebookCell = !!this._notebookEditorService.getNotebookForPossibleCell(editor);\n\t\t\tif (!isNotebookCell || notebookAgent.read(r)) {\n\t\t\t\treturn InlineChatController2.get(editor)!;\n\t\t\t} else {\n\t\t\t\treturn InlineChatController1.get(editor)!;\n\t\t\t}\n\t\t});\n\t}\n\n\tdispose(): void {\n\n\t}\n\n\tget isActive(): boolean {\n\t\treturn this._delegate.get().isActive;\n\t}\n\n\tasync run(arg?: InlineChatRunOptions): Promise<boolean> {\n\t\treturn this._delegate.get().run(arg);\n\t}\n\n\tfocus() {\n\t\treturn this._delegate.get().focus();\n\t}\n\n\tget widget(): EditorBasedInlineChatWidget {\n\t\treturn this._delegate.get().widget;\n\t}\n\n\tgetWidgetPosition() {\n\t\treturn this._delegate.get().getWidgetPosition();\n\t}\n\n\tacceptSession() {\n\t\treturn this._delegate.get().acceptSession();\n\t}\n}\n\n/**\n * @deprecated\n */\nexport class InlineChatController1 implements IEditorContribution {\n\n\tstatic get(editor: ICodeEditor) {\n\t\treturn editor.getContribution<InlineChatController1>(INLINE_CHAT_ID);\n\t}\n\n\tprivate _isDisposed: boolean = false;\n\tprivate readonly _store = new DisposableStore();\n\n\tprivate readonly _ui: Lazy<InlineChatZoneWidget>;\n\n\tprivate readonly _ctxVisible: IContextKey<boolean>;\n\tprivate readonly _ctxEditing: IContextKey<boolean>;\n\tprivate readonly _ctxResponseType: IContextKey<undefined | InlineChatResponseType>;\n\tprivate readonly _ctxRequestInProgress: IContextKey<boolean>;\n\n\tprivate readonly _ctxResponse: IContextKey<boolean>;\n\n\tprivate readonly _messages = this._store.add(new Emitter<Message>());\n\tprotected readonly _onDidEnterState = this._store.add(new Emitter<State>());\n\n\tget chatWidget() {\n\t\treturn this._ui.value.widget.chatWidget;\n\t}\n\n\tprivate readonly _sessionStore = this._store.add(new DisposableStore());\n\tprivate readonly _stashedSession = this._store.add(new MutableDisposable<StashedSession>());\n\tprivate _delegateSession?: IChatEditingSession;\n\n\tprivate _session?: Session;\n\tprivate _strategy?: LiveStrategy;\n\n\tconstructor(\n\t\tprivate readonly _editor: ICodeEditor,\n\t\t@IInstantiationService private readonly _instaService: IInstantiationService,\n\t\t@IInlineChatSessionService private readonly _inlineChatSessionService: IInlineChatSessionService,\n\t\t@IEditorWorkerService private readonly _editorWorkerService: IEditorWorkerService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@IChatService private readonly _chatService: IChatService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@INotebookEditorService notebookEditorService: INotebookEditorService,\n\t\t@ISharedWebContentExtractorService private readonly _webContentExtractorService: ISharedWebContentExtractorService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@IChatAttachmentResolveService private readonly _chatAttachmentResolveService: IChatAttachmentResolveService\n\t) {\n\t\tthis._ctxVisible = CTX_INLINE_CHAT_VISIBLE.bindTo(contextKeyService);\n\t\tthis._ctxEditing = CTX_INLINE_CHAT_EDITING.bindTo(contextKeyService);\n\t\tthis._ctxResponseType = CTX_INLINE_CHAT_RESPONSE_TYPE.bindTo(contextKeyService);\n\t\tthis._ctxRequestInProgress = CTX_INLINE_CHAT_REQUEST_IN_PROGRESS.bindTo(contextKeyService);\n\n\t\tthis._ctxResponse = ChatContextKeys.isResponse.bindTo(contextKeyService);\n\t\tChatContextKeys.responseHasError.bindTo(contextKeyService);\n\n\t\tthis._ui = new Lazy(() => {\n\n\t\t\tconst location: IChatWidgetLocationOptions = {\n\t\t\t\tlocation: ChatAgentLocation.EditorInline,\n\t\t\t\tresolveData: () => {\n\t\t\t\t\tassertType(this._editor.hasModel());\n\t\t\t\t\tassertType(this._session);\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttype: ChatAgentLocation.EditorInline,\n\t\t\t\t\t\tselection: this._editor.getSelection(),\n\t\t\t\t\t\tdocument: this._session.textModelN.uri,\n\t\t\t\t\t\twholeRange: this._session?.wholeRange.trackedInitialRange,\n\t\t\t\t\t\tclose: () => this.cancelSession(),\n\t\t\t\t\t\tdelegateSessionResource: this._delegateSession?.chatSessionResource,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// inline chat in notebooks\n\t\t\t// check if this editor is part of a notebook editor\n\t\t\t// and iff so, use the notebook location but keep the resolveData\n\t\t\t// talk about editor data\n\t\t\tconst notebookEditor = notebookEditorService.getNotebookForPossibleCell(this._editor);\n\t\t\tif (!!notebookEditor) {\n\t\t\t\tlocation.location = ChatAgentLocation.Notebook;\n\t\t\t}\n\n\t\t\tconst clear = async () => {\n\t\t\t\tconst r = this.joinCurrentRun();\n\t\t\t\tthis.cancelSession();\n\t\t\t\tawait r;\n\t\t\t\tthis.run();\n\t\t\t};\n\t\t\tconst zone = _instaService.createInstance(InlineChatZoneWidget, location, undefined, { editor: this._editor, notebookEditor }, clear);\n\t\t\tthis._store.add(zone);\n\n\t\t\treturn zone;\n\t\t});\n\n\t\tthis._store.add(this._editor.onDidChangeModel(async e => {\n\t\t\tif (this._session || !e.newModelUrl) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst existingSession = this._inlineChatSessionService.getSession(this._editor, e.newModelUrl);\n\t\t\tif (!existingSession) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._log('session RESUMING after model change', e);\n\t\t\tawait this.run({ existingSession });\n\t\t}));\n\n\t\tthis._store.add(this._inlineChatSessionService.onDidEndSession(e => {\n\t\t\tif (e.session === this._session && e.endedByExternalCause) {\n\t\t\t\tthis._log('session ENDED by external cause');\n\t\t\t\tthis.acceptSession();\n\t\t\t}\n\t\t}));\n\n\t\tthis._store.add(this._inlineChatSessionService.onDidMoveSession(async e => {\n\t\t\tif (e.editor === this._editor) {\n\t\t\t\tthis._log('session RESUMING after move', e);\n\t\t\t\tawait this.run({ existingSession: e.session });\n\t\t\t}\n\t\t}));\n\n\t\tthis._log(`NEW controller`);\n\t}\n\n\tdispose(): void {\n\t\tif (this._currentRun) {\n\t\t\tthis._messages.fire(this._session?.chatModel.hasRequests\n\t\t\t\t? Message.PAUSE_SESSION\n\t\t\t\t: Message.CANCEL_SESSION);\n\t\t}\n\t\tthis._store.dispose();\n\t\tthis._isDisposed = true;\n\t\tthis._log('DISPOSED controller');\n\t}\n\n\tprivate _log(message: string | Error, ...more: unknown[]): void {\n\t\tif (message instanceof Error) {\n\t\t\tthis._logService.error(message, ...more);\n\t\t} else {\n\t\t\tthis._logService.trace(`[IE] (editor:${this._editor.getId()}) ${message}`, ...more);\n\t\t}\n\t}\n\n\tget widget(): EditorBasedInlineChatWidget {\n\t\treturn this._ui.value.widget;\n\t}\n\n\tgetId(): string {\n\t\treturn INLINE_CHAT_ID;\n\t}\n\n\tgetWidgetPosition(): Position | undefined {\n\t\treturn this._ui.value.position;\n\t}\n\n\tprivate _currentRun?: Promise<void>;\n\n\tasync run(options: InlineChatRunOptions | undefined = {}): Promise<boolean> {\n\n\t\tlet lastState: State | undefined;\n\t\tconst d = this._onDidEnterState.event(e => lastState = e);\n\n\t\ttry {\n\t\t\tthis.acceptSession();\n\t\t\tif (this._currentRun) {\n\t\t\t\tawait this._currentRun;\n\t\t\t}\n\t\t\tif (options.initialSelection) {\n\t\t\t\tthis._editor.setSelection(options.initialSelection);\n\t\t\t}\n\t\t\tthis._stashedSession.clear();\n\t\t\tthis._currentRun = this._nextState(State.CREATE_SESSION, options);\n\t\t\tawait this._currentRun;\n\n\t\t} catch (error) {\n\t\t\t// this should not happen but when it does make sure to tear down the UI and everything\n\t\t\tthis._log('error during run', error);\n\t\t\tonUnexpectedError(error);\n\t\t\tif (this._session) {\n\t\t\t\tthis._inlineChatSessionService.releaseSession(this._session);\n\t\t\t}\n\t\t\tthis[State.PAUSE]();\n\n\t\t} finally {\n\t\t\tthis._currentRun = undefined;\n\t\t\td.dispose();\n\t\t}\n\n\t\treturn lastState !== State.CANCEL;\n\t}\n\n\t// ---- state machine\n\n\tprotected async _nextState(state: State, options: InlineChatRunOptions): Promise<void> {\n\t\tlet nextState: State | void = state;\n\t\twhile (nextState && !this._isDisposed) {\n\t\t\tthis._log('setState to ', nextState);\n\t\t\tconst p: State | Promise<State> | Promise<void> = this[nextState](options);\n\t\t\tthis._onDidEnterState.fire(nextState);\n\t\t\tnextState = await p;\n\t\t}\n\t}\n\n\tprivate async [State.CREATE_SESSION](options: InlineChatRunOptions): Promise<State.CANCEL | State.INIT_UI> {\n\t\tassertType(this._session === undefined);\n\t\tassertType(this._editor.hasModel());\n\n\t\tlet session: Session | undefined = options.existingSession;\n\n\t\tlet initPosition: Position | undefined;\n\t\tif (options.position) {\n\t\t\tinitPosition = Position.lift(options.position).delta(-1);\n\t\t\tdelete options.position;\n\t\t}\n\n\t\tconst widgetPosition = this._showWidget(session?.headless, true, initPosition);\n\n\t\t// this._updatePlaceholder();\n\t\tlet errorMessage = localize('create.fail', \"Failed to start editor chat\");\n\n\t\tif (!session) {\n\t\t\tconst createSessionCts = new CancellationTokenSource();\n\t\t\tconst msgListener = Event.once(this._messages.event)(m => {\n\t\t\t\tthis._log('state=_createSession) message received', m);\n\t\t\t\tif (m === Message.ACCEPT_INPUT) {\n\t\t\t\t\t// user accepted the input before having a session\n\t\t\t\t\toptions.autoSend = true;\n\t\t\t\t\tthis._ui.value.widget.updateInfo(localize('welcome.2', \"Getting ready...\"));\n\t\t\t\t} else {\n\t\t\t\t\tcreateSessionCts.cancel();\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ttry {\n\t\t\t\tsession = await this._inlineChatSessionService.createSession(\n\t\t\t\t\tthis._editor,\n\t\t\t\t\t{ wholeRange: options.initialRange },\n\t\t\t\t\tcreateSessionCts.token\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\t// Inline chat errors are from the provider and have their error messages shown to the user\n\t\t\t\tif (error instanceof InlineChatError || error?.name === InlineChatError.code) {\n\t\t\t\t\terrorMessage = error.message;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tcreateSessionCts.dispose();\n\t\t\tmsgListener.dispose();\n\n\t\t\tif (createSessionCts.token.isCancellationRequested) {\n\t\t\t\tif (session) {\n\t\t\t\t\tthis._inlineChatSessionService.releaseSession(session);\n\t\t\t\t}\n\t\t\t\treturn State.CANCEL;\n\t\t\t}\n\t\t}\n\n\t\tdelete options.initialRange;\n\t\tdelete options.existingSession;\n\n\t\tif (!session) {\n\t\t\tMessageController.get(this._editor)?.showMessage(errorMessage, widgetPosition);\n\t\t\tthis._log('Failed to start editor chat');\n\t\t\treturn State.CANCEL;\n\t\t}\n\n\t\t// create a new strategy\n\t\tthis._strategy = this._instaService.createInstance(LiveStrategy, session, this._editor, this._ui.value, session.headless);\n\n\t\tthis._session = session;\n\t\treturn State.INIT_UI;\n\t}\n\n\tprivate async [State.INIT_UI](options: InlineChatRunOptions): Promise<State.WAIT_FOR_INPUT | State.SHOW_REQUEST> {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\n\t\t// hide/cancel inline completions when invoking IE\n\t\tInlineCompletionsController.get(this._editor)?.reject();\n\n\t\tthis._sessionStore.clear();\n\n\t\tconst wholeRangeDecoration = this._editor.createDecorationsCollection();\n\t\tconst handleWholeRangeChange = () => {\n\t\t\tconst newDecorations = this._strategy?.getWholeRangeDecoration() ?? [];\n\t\t\twholeRangeDecoration.set(newDecorations);\n\n\t\t\tthis._ctxEditing.set(!this._session?.wholeRange.trackedInitialRange.isEmpty());\n\t\t};\n\t\tthis._sessionStore.add(toDisposable(() => {\n\t\t\twholeRangeDecoration.clear();\n\t\t\tthis._ctxEditing.reset();\n\t\t}));\n\t\tthis._sessionStore.add(this._session.wholeRange.onDidChange(handleWholeRangeChange));\n\t\thandleWholeRangeChange();\n\n\t\tthis._ui.value.widget.setChatModel(this._session.chatModel);\n\t\tthis._updatePlaceholder();\n\n\t\tconst isModelEmpty = !this._session.chatModel.hasRequests;\n\t\tthis._ui.value.widget.updateToolbar(true);\n\t\tthis._ui.value.widget.toggleStatus(!isModelEmpty);\n\t\tthis._showWidget(this._session.headless, isModelEmpty);\n\n\t\tthis._sessionStore.add(this._editor.onDidChangeModel((e) => {\n\t\t\tconst msg = this._session?.chatModel.hasRequests\n\t\t\t\t? Message.PAUSE_SESSION // pause when switching models/tabs and when having a previous exchange\n\t\t\t\t: Message.CANCEL_SESSION;\n\t\t\tthis._log('model changed, pause or cancel session', msg, e);\n\t\t\tthis._messages.fire(msg);\n\t\t}));\n\n\t\tconst filePartOfEditSessions = this._chatService.editingSessions.filter(session =>\n\t\t\tsession.entries.get().some(e => e.state.get() === ModifiedFileEntryState.Modified && e.modifiedURI.toString() === this._session!.textModelN.uri.toString())\n\t\t);\n\n\t\tconst withinEditSession = filePartOfEditSessions.find(session =>\n\t\t\tsession.entries.get().some(e => e.state.get() === ModifiedFileEntryState.Modified && e.hasModificationAt({\n\t\t\t\trange: this._session!.wholeRange.trackedInitialRange,\n\t\t\t\turi: this._session!.textModelN.uri\n\t\t\t}))\n\t\t);\n\n\t\tconst chatWidget = this._ui.value.widget.chatWidget;\n\t\tthis._delegateSession = withinEditSession || filePartOfEditSessions[0];\n\t\tchatWidget.input.setIsWithinEditSession(!!withinEditSession, filePartOfEditSessions.length > 0);\n\n\t\tthis._sessionStore.add(this._editor.onDidChangeModelContent(e => {\n\n\n\t\t\tif (this._session?.hunkData.ignoreTextModelNChanges || this._ui.value.widget.hasFocus()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst wholeRange = this._session!.wholeRange;\n\t\t\tlet shouldFinishSession = false;\n\t\t\tif (this._configurationService.getValue<boolean>(InlineChatConfigKeys.FinishOnType)) {\n\t\t\t\tfor (const { range } of e.changes) {\n\t\t\t\t\tshouldFinishSession = !Range.areIntersectingOrTouching(range, wholeRange.value);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis._session!.recordExternalEditOccurred(shouldFinishSession);\n\n\t\t\tif (shouldFinishSession) {\n\t\t\t\tthis._log('text changed outside of whole range, FINISH session');\n\t\t\t\tthis.acceptSession();\n\t\t\t}\n\t\t}));\n\n\t\tthis._sessionStore.add(this._session.chatModel.onDidChange(async e => {\n\t\t\tif (e.kind === 'removeRequest') {\n\t\t\t\t// TODO@jrieken there is still some work left for when a request \"in the middle\"\n\t\t\t\t// is removed. We will undo all changes till that point but not remove those\n\t\t\t\t// later request\n\t\t\t\tawait this._session!.undoChangesUntil(e.requestId);\n\t\t\t}\n\t\t}));\n\n\t\t// apply edits from completed requests that haven't been applied yet\n\t\tconst editState = this._createChatTextEditGroupState();\n\t\tlet didEdit = false;\n\t\tfor (const request of this._session.chatModel.getRequests()) {\n\t\t\tif (!request.response || request.response.result?.errorDetails) {\n\t\t\t\t// done when seeing the first request that is still pending (no response).\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tfor (const part of request.response.response.value) {\n\t\t\t\tif (part.kind !== 'textEditGroup' || !isEqual(part.uri, this._session.textModelN.uri)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (part.state?.applied) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tfor (const edit of part.edits) {\n\t\t\t\t\tthis._makeChanges(edit, undefined, !didEdit);\n\t\t\t\t\tdidEdit = true;\n\t\t\t\t}\n\t\t\t\tpart.state ??= editState;\n\t\t\t}\n\t\t}\n\t\tif (didEdit) {\n\t\t\tconst diff = await this._editorWorkerService.computeDiff(this._session.textModel0.uri, this._session.textModelN.uri, { computeMoves: false, maxComputationTimeMs: Number.MAX_SAFE_INTEGER, ignoreTrimWhitespace: false }, 'advanced');\n\t\t\tthis._session.wholeRange.fixup(diff?.changes ?? []);\n\t\t\tawait this._session.hunkData.recompute(editState, diff);\n\n\t\t\tthis._updateCtxResponseType();\n\t\t}\n\t\toptions.position = await this._strategy.renderChanges();\n\n\t\tif (this._session.chatModel.requestInProgress.get()) {\n\t\t\treturn State.SHOW_REQUEST;\n\t\t} else {\n\t\t\treturn State.WAIT_FOR_INPUT;\n\t\t}\n\t}\n\n\tprivate async [State.WAIT_FOR_INPUT](options: InlineChatRunOptions): Promise<State.ACCEPT | State.CANCEL | State.PAUSE | State.WAIT_FOR_INPUT | State.SHOW_REQUEST> {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\n\t\tthis._updatePlaceholder();\n\n\t\tif (options.message) {\n\t\t\tthis._updateInput(options.message);\n\t\t\taria.alert(options.message);\n\t\t\tdelete options.message;\n\t\t\tthis._showWidget(this._session.headless, false);\n\t\t}\n\n\t\tlet message = Message.NONE;\n\t\tlet request: IChatRequestModel | undefined;\n\n\t\tconst barrier = new Barrier();\n\t\tconst store = new DisposableStore();\n\t\tstore.add(this._session.chatModel.onDidChange(e => {\n\t\t\tif (e.kind === 'addRequest') {\n\t\t\t\trequest = e.request;\n\t\t\t\tmessage = Message.ACCEPT_INPUT;\n\t\t\t\tbarrier.open();\n\t\t\t}\n\t\t}));\n\t\tstore.add(this._strategy.onDidAccept(() => this.acceptSession()));\n\t\tstore.add(this._strategy.onDidDiscard(() => this.cancelSession()));\n\t\tstore.add(this.chatWidget.onDidHide(() => this.cancelSession()));\n\t\tstore.add(Event.once(this._messages.event)(m => {\n\t\t\tthis._log('state=_waitForInput) message received', m);\n\t\t\tmessage = m;\n\t\t\tbarrier.open();\n\t\t}));\n\n\t\tif (options.attachments) {\n\t\t\tawait Promise.all(options.attachments.map(async attachment => {\n\t\t\t\tawait this._ui.value.widget.chatWidget.attachmentModel.addFile(attachment);\n\t\t\t}));\n\t\t\tdelete options.attachments;\n\t\t}\n\t\tif (options.autoSend) {\n\t\t\tdelete options.autoSend;\n\t\t\tthis._showWidget(this._session.headless, false);\n\t\t\tthis._ui.value.widget.chatWidget.acceptInput();\n\t\t}\n\n\t\tawait barrier.wait();\n\t\tstore.dispose();\n\n\n\t\tif (message & (Message.CANCEL_INPUT | Message.CANCEL_SESSION)) {\n\t\t\treturn State.CANCEL;\n\t\t}\n\n\t\tif (message & Message.PAUSE_SESSION) {\n\t\t\treturn State.PAUSE;\n\t\t}\n\n\t\tif (message & Message.ACCEPT_SESSION) {\n\t\t\tthis._ui.value.widget.selectAll();\n\t\t\treturn State.ACCEPT;\n\t\t}\n\n\t\tif (!request?.message.text) {\n\t\t\treturn State.WAIT_FOR_INPUT;\n\t\t}\n\n\n\t\treturn State.SHOW_REQUEST;\n\t}\n\n\n\tprivate async [State.SHOW_REQUEST](options: InlineChatRunOptions): Promise<State.WAIT_FOR_INPUT | State.CANCEL | State.PAUSE | State.ACCEPT> {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\t\tassertType(this._session.chatModel.requestInProgress.get());\n\n\t\tthis._ctxRequestInProgress.set(true);\n\n\t\tconst { chatModel } = this._session;\n\t\tconst request = chatModel.lastRequest;\n\n\t\tassertType(request);\n\t\tassertType(request.response);\n\n\t\tthis._showWidget(this._session.headless, false);\n\t\tthis._ui.value.widget.selectAll();\n\t\tthis._ui.value.widget.updateInfo('');\n\t\tthis._ui.value.widget.toggleStatus(true);\n\n\t\tconst { response } = request;\n\t\tconst responsePromise = new DeferredPromise<void>();\n\n\t\tconst store = new DisposableStore();\n\n\t\tconst progressiveEditsCts = store.add(new CancellationTokenSource());\n\t\tconst progressiveEditsAvgDuration = new MovingAverage();\n\t\tconst progressiveEditsClock = StopWatch.create();\n\t\tconst progressiveEditsQueue = new Queue();\n\n\t\t// disable typing and squiggles while streaming a reply\n\t\tconst origDeco = this._editor.getOption(EditorOption.renderValidationDecorations);\n\t\tthis._editor.updateOptions({\n\t\t\trenderValidationDecorations: 'off'\n\t\t});\n\t\tstore.add(toDisposable(() => {\n\t\t\tthis._editor.updateOptions({\n\t\t\t\trenderValidationDecorations: origDeco\n\t\t\t});\n\t\t}));\n\n\n\t\tlet next: State.WAIT_FOR_INPUT | State.SHOW_REQUEST | State.CANCEL | State.PAUSE | State.ACCEPT = State.WAIT_FOR_INPUT;\n\t\tstore.add(Event.once(this._messages.event)(message => {\n\t\t\tthis._log('state=_makeRequest) message received', message);\n\t\t\tthis._chatService.cancelCurrentRequestForSession(chatModel.sessionResource);\n\t\t\tif (message & Message.CANCEL_SESSION) {\n\t\t\t\tnext = State.CANCEL;\n\t\t\t} else if (message & Message.PAUSE_SESSION) {\n\t\t\t\tnext = State.PAUSE;\n\t\t\t} else if (message & Message.ACCEPT_SESSION) {\n\t\t\t\tnext = State.ACCEPT;\n\t\t\t}\n\t\t}));\n\n\t\tstore.add(chatModel.onDidChange(async e => {\n\t\t\tif (e.kind === 'removeRequest' && e.requestId === request.id) {\n\t\t\t\tprogressiveEditsCts.cancel();\n\t\t\t\tresponsePromise.complete();\n\t\t\t\tif (e.reason === ChatRequestRemovalReason.Resend) {\n\t\t\t\t\tnext = State.SHOW_REQUEST;\n\t\t\t\t} else {\n\t\t\t\t\tnext = State.CANCEL;\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (e.kind === 'move') {\n\t\t\t\tassertType(this._session);\n\t\t\t\tconst log: typeof this._log = (msg: string, ...args: unknown[]) => this._log('state=_showRequest) moving inline chat', msg, ...args);\n\n\t\t\t\tlog('move was requested', e.target, e.range);\n\n\t\t\t\t// if there's already a tab open for targetUri, show it and move inline chat to that tab\n\t\t\t\t// otherwise, open the tab to the side\n\t\t\t\tconst initialSelection = Selection.fromRange(Range.lift(e.range), SelectionDirection.LTR);\n\t\t\t\tconst editorPane = await this._editorService.openEditor({ resource: e.target, options: { selection: initialSelection } }, SIDE_GROUP);\n\n\t\t\t\tif (!editorPane) {\n\t\t\t\t\tlog('opening editor failed');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst newEditor = editorPane.getControl();\n\t\t\t\tif (!isCodeEditor(newEditor) || !newEditor.hasModel()) {\n\t\t\t\t\tlog('new editor is either missing or not a code editor or does not have a model');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (this._inlineChatSessionService.getSession(newEditor, e.target)) {\n\t\t\t\t\tlog('new editor ALREADY has a session');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst newSession = await this._inlineChatSessionService.createSession(\n\t\t\t\t\tnewEditor,\n\t\t\t\t\t{\n\t\t\t\t\t\tsession: this._session,\n\t\t\t\t\t},\n\t\t\t\t\tCancellationToken.None); // TODO@ulugbekna: add proper cancellation?\n\n\n\t\t\t\tInlineChatController1.get(newEditor)?.run({ existingSession: newSession });\n\n\t\t\t\tnext = State.CANCEL;\n\t\t\t\tresponsePromise.complete();\n\n\t\t\t\treturn;\n\t\t\t}\n\t\t}));\n\n\t\t// cancel the request when the user types\n\t\tstore.add(this._ui.value.widget.chatWidget.inputEditor.onDidChangeModelContent(() => {\n\t\t\tthis._chatService.cancelCurrentRequestForSession(chatModel.sessionResource);\n\t\t}));\n\n\t\tlet lastLength = 0;\n\t\tlet isFirstChange = true;\n\n\t\tconst editState = this._createChatTextEditGroupState();\n\t\tlet localEditGroup: IChatTextEditGroup | undefined;\n\n\t\t// apply edits\n\t\tconst handleResponse = () => {\n\n\t\t\tthis._updateCtxResponseType();\n\n\t\t\tif (!localEditGroup) {\n\t\t\t\tlocalEditGroup = <IChatTextEditGroup | undefined>response.response.value.find(part => part.kind === 'textEditGroup' && isEqual(part.uri, this._session?.textModelN.uri));\n\t\t\t}\n\n\t\t\tif (localEditGroup) {\n\n\t\t\t\tlocalEditGroup.state ??= editState;\n\n\t\t\t\tconst edits = localEditGroup.edits;\n\t\t\t\tconst newEdits = edits.slice(lastLength);\n\t\t\t\tif (newEdits.length > 0) {\n\n\t\t\t\t\tthis._log(`${this._session?.textModelN.uri.toString()} received ${newEdits.length} edits`);\n\n\t\t\t\t\t// NEW changes\n\t\t\t\t\tlastLength = edits.length;\n\t\t\t\t\tprogressiveEditsAvgDuration.update(progressiveEditsClock.elapsed());\n\t\t\t\t\tprogressiveEditsClock.reset();\n\n\t\t\t\t\tprogressiveEditsQueue.queue(async () => {\n\n\t\t\t\t\t\tconst startThen = this._session!.wholeRange.value.getStartPosition();\n\n\t\t\t\t\t\t// making changes goes into a queue because otherwise the async-progress time will\n\t\t\t\t\t\t// influence the time it takes to receive the changes and progressive typing will\n\t\t\t\t\t\t// become infinitely fast\n\t\t\t\t\t\tfor (const edits of newEdits) {\n\t\t\t\t\t\t\tawait this._makeChanges(edits, {\n\t\t\t\t\t\t\t\tduration: progressiveEditsAvgDuration.value,\n\t\t\t\t\t\t\t\ttoken: progressiveEditsCts.token\n\t\t\t\t\t\t\t}, isFirstChange);\n\n\t\t\t\t\t\t\tisFirstChange = false;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// reshow the widget if the start position changed or shows at the wrong position\n\t\t\t\t\t\tconst startNow = this._session!.wholeRange.value.getStartPosition();\n\t\t\t\t\t\tif (!startNow.equals(startThen) || !this._ui.value.position?.equals(startNow)) {\n\t\t\t\t\t\t\tthis._showWidget(this._session!.headless, false, startNow.delta(-1));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (response.isCanceled) {\n\t\t\t\tprogressiveEditsCts.cancel();\n\t\t\t\tresponsePromise.complete();\n\n\t\t\t} else if (response.isComplete) {\n\t\t\t\tresponsePromise.complete();\n\t\t\t}\n\t\t};\n\t\tstore.add(response.onDidChange(handleResponse));\n\t\thandleResponse();\n\n\t\t// (1) we must wait for the request to finish\n\t\t// (2) we must wait for all edits that came in via progress to complete\n\t\tawait responsePromise.p;\n\t\tawait progressiveEditsQueue.whenIdle();\n\n\t\tif (response.result?.errorDetails && !response.result.errorDetails.responseIsFiltered) {\n\t\t\tawait this._session.undoChangesUntil(response.requestId);\n\t\t}\n\n\t\tstore.dispose();\n\n\t\tconst diff = await this._editorWorkerService.computeDiff(this._session.textModel0.uri, this._session.textModelN.uri, { computeMoves: false, maxComputationTimeMs: Number.MAX_SAFE_INTEGER, ignoreTrimWhitespace: false }, 'advanced');\n\t\tthis._session.wholeRange.fixup(diff?.changes ?? []);\n\t\tawait this._session.hunkData.recompute(editState, diff);\n\n\t\tthis._ctxRequestInProgress.set(false);\n\n\n\t\tlet newPosition: Position | undefined;\n\n\t\tif (response.result?.errorDetails) {\n\t\t\t// error -> no message, errors are shown with the request\n\t\t\talert(response.result.errorDetails.message);\n\t\t} else if (response.response.value.length === 0) {\n\t\t\t// empty -> show message\n\t\t\tconst status = localize('empty', \"No results, please refine your input and try again\");\n\t\t\tthis._ui.value.widget.updateStatus(status, { classes: ['warn'] });\n\t\t\talert(status);\n\t\t} else {\n\t\t\t// real response -> no message\n\t\t\tthis._ui.value.widget.updateStatus('');\n\t\t\talert(localize('responseWasEmpty', \"Response was empty\"));\n\t\t}\n\n\t\tconst position = await this._strategy.renderChanges();\n\t\tif (position) {\n\t\t\t// if the selection doesn't start far off we keep the widget at its current position\n\t\t\t// because it makes reading this nicer\n\t\t\tconst selection = this._editor.getSelection();\n\t\t\tif (selection?.containsPosition(position)) {\n\t\t\t\tif (position.lineNumber - selection.startLineNumber > 8) {\n\t\t\t\t\tnewPosition = position;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tnewPosition = position;\n\t\t\t}\n\t\t}\n\t\tthis._showWidget(this._session.headless, false, newPosition);\n\n\t\treturn next;\n\t}\n\n\tprivate async[State.PAUSE]() {\n\n\t\tthis._resetWidget();\n\n\t\tthis._strategy?.dispose?.();\n\t\tthis._session = undefined;\n\t}\n\n\tprivate async[State.ACCEPT]() {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\t\tthis._sessionStore.clear();\n\n\t\ttry {\n\t\t\tawait this._strategy.apply();\n\t\t} catch (err) {\n\t\t\tthis._dialogService.error(localize('err.apply', \"Failed to apply changes.\", toErrorMessage(err)));\n\t\t\tthis._log('FAILED to apply changes');\n\t\t\tthis._log(err);\n\t\t}\n\n\t\tthis._resetWidget();\n\t\tthis._inlineChatSessionService.releaseSession(this._session);\n\n\n\t\tthis._strategy?.dispose();\n\t\tthis._strategy = undefined;\n\t\tthis._session = undefined;\n\t}\n\n\tprivate async[State.CANCEL]() {\n\n\t\tthis._resetWidget();\n\n\t\tif (this._session) {\n\t\t\t// assertType(this._session);\n\t\t\tassertType(this._strategy);\n\t\t\tthis._sessionStore.clear();\n\n\t\t\t// only stash sessions that were not unstashed, not \"empty\", and not interacted with\n\t\t\tconst shouldStash = !this._session.isUnstashed && this._session.chatModel.hasRequests && this._session.hunkData.size === this._session.hunkData.pending;\n\t\t\tlet undoCancelEdits: IValidEditOperation[] = [];\n\t\t\ttry {\n\t\t\t\tundoCancelEdits = this._strategy.cancel();\n\t\t\t} catch (err) {\n\t\t\t\tthis._dialogService.error(localize('err.discard', \"Failed to discard changes.\", toErrorMessage(err)));\n\t\t\t\tthis._log('FAILED to discard changes');\n\t\t\t\tthis._log(err);\n\t\t\t}\n\n\t\t\tthis._stashedSession.clear();\n\t\t\tif (shouldStash) {\n\t\t\t\tthis._stashedSession.value = this._inlineChatSessionService.stashSession(this._session, this._editor, undoCancelEdits);\n\t\t\t} else {\n\t\t\t\tthis._inlineChatSessionService.releaseSession(this._session);\n\t\t\t}\n\t\t}\n\n\n\t\tthis._strategy?.dispose();\n\t\tthis._strategy = undefined;\n\t\tthis._session = undefined;\n\t}\n\n\t// ----\n\n\tprivate _showWidget(headless: boolean = false, initialRender: boolean = false, position?: Position) {\n\t\tassertType(this._editor.hasModel());\n\t\tthis._ctxVisible.set(true);\n\n\t\tlet widgetPosition: Position;\n\t\tif (position) {\n\t\t\t// explicit position wins\n\t\t\twidgetPosition = position;\n\t\t} else if (this._ui.rawValue?.position) {\n\t\t\t// already showing - special case of line 1\n\t\t\tif (this._ui.rawValue?.position.lineNumber === 1) {\n\t\t\t\twidgetPosition = this._ui.rawValue?.position.delta(-1);\n\t\t\t} else {\n\t\t\t\twidgetPosition = this._ui.rawValue?.position;\n\t\t\t}\n\t\t} else {\n\t\t\t// default to ABOVE the selection\n\t\t\twidgetPosition = this._editor.getSelection().getStartPosition().delta(-1);\n\t\t}\n\n\t\tif (this._session && !position && (this._session.hasChangedText || this._session.chatModel.hasRequests)) {\n\t\t\twidgetPosition = this._session.wholeRange.trackedInitialRange.getStartPosition().delta(-1);\n\t\t}\n\n\t\tif (initialRender && (this._editor.getOption(EditorOption.stickyScroll)).enabled) {\n\t\t\tthis._editor.revealLine(widgetPosition.lineNumber); // do NOT substract `this._editor.getOption(EditorOption.stickyScroll).maxLineCount` because the editor already does that\n\t\t}\n\n\t\tif (!headless) {\n\t\t\tif (this._ui.rawValue?.position) {\n\t\t\t\tthis._ui.value.updatePositionAndHeight(widgetPosition);\n\t\t\t} else {\n\t\t\t\tthis._ui.value.show(widgetPosition);\n\t\t\t}\n\t\t}\n\n\t\treturn widgetPosition;\n\t}\n\n\tprivate _resetWidget() {\n\n\t\tthis._sessionStore.clear();\n\t\tthis._ctxVisible.reset();\n\n\t\tthis._ui.rawValue?.hide();\n\n\t\t// Return focus to the editor only if the current focus is within the editor widget\n\t\tif (this._editor.hasWidgetFocus()) {\n\t\t\tthis._editor.focus();\n\t\t}\n\t}\n\n\tprivate _updateCtxResponseType(): void {\n\n\t\tif (!this._session) {\n\t\t\tthis._ctxResponseType.set(InlineChatResponseType.None);\n\t\t\treturn;\n\t\t}\n\n\t\tconst hasLocalEdit = (response: IResponse): boolean => {\n\t\t\treturn response.value.some(part => part.kind === 'textEditGroup' && isEqual(part.uri, this._session?.textModelN.uri));\n\t\t};\n\n\t\tlet responseType = InlineChatResponseType.None;\n\t\tfor (const request of this._session.chatModel.getRequests()) {\n\t\t\tif (!request.response) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tresponseType = InlineChatResponseType.Messages;\n\t\t\tif (hasLocalEdit(request.response.response)) {\n\t\t\t\tresponseType = InlineChatResponseType.MessagesAndEdits;\n\t\t\t\tbreak; // no need to check further\n\t\t\t}\n\t\t}\n\t\tthis._ctxResponseType.set(responseType);\n\t\tthis._ctxResponse.set(responseType !== InlineChatResponseType.None);\n\t}\n\n\tprivate _createChatTextEditGroupState(): IChatTextEditGroupState {\n\t\tassertType(this._session);\n\n\t\tconst sha1 = new DefaultModelSHA1Computer();\n\t\tconst textModel0Sha1 = sha1.canComputeSHA1(this._session.textModel0)\n\t\t\t? sha1.computeSHA1(this._session.textModel0)\n\t\t\t: generateUuid();\n\n\t\treturn {\n\t\t\tsha1: textModel0Sha1,\n\t\t\tapplied: 0\n\t\t};\n\t}\n\n\tprivate async _makeChanges(edits: TextEdit[], opts: ProgressingEditsOptions | undefined, undoStopBefore: boolean) {\n\t\tassertType(this._session);\n\t\tassertType(this._strategy);\n\n\t\tconst moreMinimalEdits = await raceCancellation(this._editorWorkerService.computeMoreMinimalEdits(this._session.textModelN.uri, edits), opts?.token || CancellationToken.None);\n\t\tthis._log('edits from PROVIDER and after making them MORE MINIMAL', this._session.agent.extensionId, edits, moreMinimalEdits);\n\n\t\tif (moreMinimalEdits?.length === 0) {\n\t\t\t// nothing left to do\n\t\t\treturn;\n\t\t}\n\n\t\tconst actualEdits = !opts && moreMinimalEdits ? moreMinimalEdits : edits;\n\t\tconst editOperations = actualEdits.map(TextEdit.asEditOperation);\n\n\t\tconst editsObserver: IEditObserver = {\n\t\t\tstart: () => this._session!.hunkData.ignoreTextModelNChanges = true,\n\t\t\tstop: () => this._session!.hunkData.ignoreTextModelNChanges = false,\n\t\t};\n\n\t\tconst metadata = this._getMetadata();\n\t\tif (opts) {\n\t\t\tawait this._strategy.makeProgressiveChanges(editOperations, editsObserver, opts, undoStopBefore, metadata);\n\t\t} else {\n\t\t\tawait this._strategy.makeChanges(editOperations, editsObserver, undoStopBefore, metadata);\n\t\t}\n\t}\n\n\tprivate _getMetadata(): IInlineChatMetadata {\n\t\tconst lastRequest = this._session?.chatModel.lastRequest;\n\t\treturn {\n\t\t\textensionId: VersionedExtensionId.tryCreate(this._session?.agent.extensionId.value, this._session?.agent.extensionVersion),\n\t\t\tmodelId: lastRequest?.modelId,\n\t\t\trequestId: lastRequest?.id,\n\t\t};\n\t}\n\n\tprivate _updatePlaceholder(): void {\n\t\tthis._ui.value.widget.placeholder = this._session?.agent.description ?? localize('askOrEditInContext', 'Ask or edit in context');\n\t}\n\n\tprivate _updateInput(text: string, selectAll = true): void {\n\n\t\tthis._ui.value.widget.chatWidget.setInput(text);\n\t\tif (selectAll) {\n\t\t\tconst newSelection = new Selection(1, 1, Number.MAX_SAFE_INTEGER, 1);\n\t\t\tthis._ui.value.widget.chatWidget.inputEditor.setSelection(newSelection);\n\t\t}\n\t}\n\n\t// ---- controller API\n\n\tarrowOut(up: boolean): void {\n\t\tif (this._ui.value.position && this._editor.hasModel()) {\n\t\t\tconst { column } = this._editor.getPosition();\n\t\t\tconst { lineNumber } = this._ui.value.position;\n\t\t\tconst newLine = up ? lineNumber : lineNumber + 1;\n\t\t\tthis._editor.setPosition({ lineNumber: newLine, column });\n\t\t\tthis._editor.focus();\n\t\t}\n\t}\n\n\tfocus(): void {\n\t\tthis._ui.value.widget.focus();\n\t}\n\n\tasync viewInChat() {\n\t\tif (!this._strategy || !this._session) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet someApplied = false;\n\t\tlet lastEdit: IChatTextEditGroup | undefined;\n\n\t\tconst uri = this._editor.getModel()?.uri;\n\t\tconst requests = this._session.chatModel.getRequests();\n\t\tfor (const request of requests) {\n\t\t\tif (!request.response) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tfor (const part of request.response.response.value) {\n\t\t\t\tif (part.kind === 'textEditGroup' && isEqual(part.uri, uri)) {\n\t\t\t\t\t// fully or partially applied edits\n\t\t\t\t\tsomeApplied = someApplied || Boolean(part.state?.applied);\n\t\t\t\t\tlastEdit = part;\n\t\t\t\t\tpart.edits = [];\n\t\t\t\t\tpart.state = undefined;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst doEdits = this._strategy.cancel();\n\n\t\tif (someApplied) {\n\t\t\tassertType(lastEdit);\n\t\t\tlastEdit.edits = [doEdits];\n\t\t}\n\n\t\tawait this._instaService.invokeFunction(moveToPanelChat, this._session?.chatModel, false);\n\n\t\tthis.cancelSession();\n\t}\n\n\tacceptSession(): void {\n\t\tconst response = this._session?.chatModel.getRequests().at(-1)?.response;\n\t\tif (response) {\n\t\t\tthis._chatService.notifyUserAction({\n\t\t\t\tsessionResource: response.session.sessionResource,\n\t\t\t\trequestId: response.requestId,\n\t\t\t\tagentId: response.agent?.id,\n\t\t\t\tcommand: response.slashCommand?.name,\n\t\t\t\tresult: response.result,\n\t\t\t\taction: {\n\t\t\t\t\tkind: 'inlineChat',\n\t\t\t\t\taction: 'accepted'\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tthis._messages.fire(Message.ACCEPT_SESSION);\n\t}\n\n\tacceptHunk(hunkInfo?: HunkInformation) {\n\t\treturn this._strategy?.performHunkAction(hunkInfo, HunkAction.Accept);\n\t}\n\n\tdiscardHunk(hunkInfo?: HunkInformation) {\n\t\treturn this._strategy?.performHunkAction(hunkInfo, HunkAction.Discard);\n\t}\n\n\ttoggleDiff(hunkInfo?: HunkInformation) {\n\t\treturn this._strategy?.performHunkAction(hunkInfo, HunkAction.ToggleDiff);\n\t}\n\n\tmoveHunk(next: boolean) {\n\t\tthis.focus();\n\t\tthis._strategy?.performHunkAction(undefined, next ? HunkAction.MoveNext : HunkAction.MovePrev);\n\t}\n\n\tasync cancelSession() {\n\t\tconst response = this._session?.chatModel.lastRequest?.response;\n\t\tif (response) {\n\t\t\tthis._chatService.notifyUserAction({\n\t\t\t\tsessionResource: response.session.sessionResource,\n\t\t\t\trequestId: response.requestId,\n\t\t\t\tagentId: response.agent?.id,\n\t\t\t\tcommand: response.slashCommand?.name,\n\t\t\t\tresult: response.result,\n\t\t\t\taction: {\n\t\t\t\t\tkind: 'inlineChat',\n\t\t\t\t\taction: 'discarded'\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tthis._resetWidget();\n\t\tthis._messages.fire(Message.CANCEL_SESSION);\n\t}\n\n\treportIssue() {\n\t\tconst response = this._session?.chatModel.lastRequest?.response;\n\t\tif (response) {\n\t\t\tthis._chatService.notifyUserAction({\n\t\t\t\tsessionResource: response.session.sessionResource,\n\t\t\t\trequestId: response.requestId,\n\t\t\t\tagentId: response.agent?.id,\n\t\t\t\tcommand: response.slashCommand?.name,\n\t\t\t\tresult: response.result,\n\t\t\t\taction: { kind: 'bug' }\n\t\t\t});\n\t\t}\n\t}\n\n\tunstashLastSession(): Session | undefined {\n\t\tconst result = this._stashedSession.value?.unstash();\n\t\treturn result;\n\t}\n\n\tjoinCurrentRun(): Promise<void> | undefined {\n\t\treturn this._currentRun;\n\t}\n\n\tget isActive() {\n\t\treturn Boolean(this._currentRun);\n\t}\n\n\tasync createImageAttachment(attachment: URI): Promise<IChatRequestVariableEntry | undefined> {\n\t\tif (attachment.scheme === Schemas.file) {\n\t\t\tif (await this._fileService.canHandleResource(attachment)) {\n\t\t\t\treturn await this._chatAttachmentResolveService.resolveImageEditorAttachContext(attachment);\n\t\t\t}\n\t\t} else if (attachment.scheme === Schemas.http || attachment.scheme === Schemas.https) {\n\t\t\tconst extractedImages = await this._webContentExtractorService.readImage(attachment, CancellationToken.None);\n\t\t\tif (extractedImages) {\n\t\t\t\treturn await this._chatAttachmentResolveService.resolveImageEditorAttachContext(attachment, extractedImages);\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n}\n\nexport class InlineChatController2 implements IEditorContribution {\n\n\tstatic readonly ID = 'editor.contrib.inlineChatController2';\n\n\tstatic get(editor: ICodeEditor): InlineChatController2 | undefined {\n\t\treturn editor.getContribution<InlineChatController2>(InlineChatController2.ID) ?? undefined;\n\t}\n\n\tprivate readonly _store = new DisposableStore();\n\tprivate readonly _isActiveController = observableValue(this, false);\n\tprivate readonly _zone: Lazy<InlineChatZoneWidget>;\n\n\tprivate readonly _currentSession: IObservable<IInlineChatSession2 | undefined>;\n\n\tget widget(): EditorBasedInlineChatWidget {\n\t\treturn this._zone.value.widget;\n\t}\n\n\tget isActive() {\n\t\treturn Boolean(this._currentSession.get());\n\t}\n\n\tconstructor(\n\t\tprivate readonly _editor: ICodeEditor,\n\t\t@IInstantiationService private readonly _instaService: IInstantiationService,\n\t\t@INotebookEditorService private readonly _notebookEditorService: INotebookEditorService,\n\t\t@IInlineChatSessionService private readonly _inlineChatSessions: IInlineChatSessionService,\n\t\t@ICodeEditorService codeEditorService: ICodeEditorService,\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@ISharedWebContentExtractorService private readonly _webContentExtractorService: ISharedWebContentExtractorService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@IChatAttachmentResolveService private readonly _chatAttachmentResolveService: IChatAttachmentResolveService,\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@IMarkerDecorationsService private readonly _markerDecorationsService: IMarkerDecorationsService,\n\t\t@IChatService chatService: IChatService,\n\t) {\n\n\t\tconst ctxInlineChatVisible = CTX_INLINE_CHAT_VISIBLE.bindTo(contextKeyService);\n\n\t\tthis._zone = new Lazy<InlineChatZoneWidget>(() => {\n\n\n\t\t\tconst location: IChatWidgetLocationOptions = {\n\t\t\t\tlocation: ChatAgentLocation.EditorInline,\n\t\t\t\tresolveData: () => {\n\t\t\t\t\tassertType(this._editor.hasModel());\n\t\t\t\t\tconst wholeRange = this._editor.getSelection();\n\t\t\t\t\tconst document = this._editor.getModel().uri;\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttype: ChatAgentLocation.EditorInline,\n\t\t\t\t\t\tselection: this._editor.getSelection(),\n\t\t\t\t\t\tdocument,\n\t\t\t\t\t\twholeRange,\n\t\t\t\t\t\tclose: () => { /* TODO@jrieken */ },\n\t\t\t\t\t\tdelegateSessionResource: chatService.editingSessions.find(session =>\n\t\t\t\t\t\t\tsession.entries.get().some(e => e.hasModificationAt({\n\t\t\t\t\t\t\t\trange: wholeRange,\n\t\t\t\t\t\t\t\turi: document\n\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t)?.chatSessionResource,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// inline chat in notebooks\n\t\t\t// check if this editor is part of a notebook editor\n\t\t\t// if so, update the location and use the notebook specific widget\n\t\t\tconst notebookEditor = this._notebookEditorService.getNotebookForPossibleCell(this._editor);\n\t\t\tif (!!notebookEditor) {\n\t\t\t\tlocation.location = ChatAgentLocation.Notebook;\n\t\t\t\tlocation.resolveData = () => {\n\t\t\t\t\tassertType(this._editor.hasModel());\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttype: ChatAgentLocation.Notebook,\n\t\t\t\t\t\tsessionInputUri: this._editor.getModel().uri,\n\t\t\t\t\t};\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst result = this._instaService.createInstance(InlineChatZoneWidget,\n\t\t\t\tlocation,\n\t\t\t\t{\n\t\t\t\t\tenableWorkingSet: 'implicit',\n\t\t\t\t\tenableImplicitContext: false,\n\t\t\t\t\trenderInputOnTop: false,\n\t\t\t\t\trenderInputToolbarBelowInput: true,\n\t\t\t\t\tfilter: _item => false, // filter ALL items\n\t\t\t\t\tmenus: {\n\t\t\t\t\t\ttelemetrySource: 'inlineChatWidget',\n\t\t\t\t\t\texecuteToolbar: MenuId.ChatEditorInlineExecute,\n\t\t\t\t\t\tinputSideToolbar: MenuId.ChatEditorInlineInputSide\n\t\t\t\t\t},\n\t\t\t\t\tdefaultMode: ChatMode.Ask\n\t\t\t\t},\n\t\t\t\t{ editor: this._editor, notebookEditor },\n\t\t\t\t() => Promise.resolve(),\n\t\t\t);\n\n\t\t\tresult.domNode.classList.add('inline-chat-2');\n\n\t\t\treturn result;\n\t\t});\n\n\n\t\tconst editorObs = observableCodeEditor(_editor);\n\n\t\tconst sessionsSignal = observableSignalFromEvent(this, _inlineChatSessions.onDidChangeSessions);\n\n\t\tthis._currentSession = derived(r => {\n\t\t\tsessionsSignal.read(r);\n\t\t\tconst model = editorObs.model.read(r);\n\t\t\tconst value = model && _inlineChatSessions.getSession2(model.uri);\n\t\t\treturn value ?? undefined;\n\t\t});\n\n\n\t\tthis._store.add(autorun(r => {\n\t\t\tconst session = this._currentSession.read(r);\n\t\t\tif (!session) {\n\t\t\t\tthis._isActiveController.set(false, undefined);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet foundOne = false;\n\t\t\tfor (const editor of codeEditorService.listCodeEditors()) {\n\t\t\t\tif (Boolean(InlineChatController2.get(editor)?._isActiveController.read(undefined))) {\n\t\t\t\t\tfoundOne = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!foundOne && editorObs.isFocused.read(r)) {\n\t\t\t\tthis._isActiveController.set(true, undefined);\n\t\t\t}\n\t\t}));\n\n\t\tconst visibleSessionObs = observableValue<IInlineChatSession2 | undefined>(this, undefined);\n\n\t\tthis._store.add(autorun(r => {\n\n\t\t\tconst model = editorObs.model.read(r);\n\t\t\tconst session = this._currentSession.read(r);\n\t\t\tconst isActive = this._isActiveController.read(r);\n\n\t\t\tif (!session || !isActive || !model) {\n\t\t\t\tvisibleSessionObs.set(undefined, undefined);\n\t\t\t} else {\n\t\t\t\tvisibleSessionObs.set(session, undefined);\n\t\t\t}\n\t\t}));\n\n\t\tthis._store.add(autorun(r => {\n\n\t\t\t// HIDE/SHOW\n\t\t\tconst session = visibleSessionObs.read(r);\n\t\t\tif (!session) {\n\t\t\t\tthis._zone.rawValue?.hide();\n\t\t\t\t_editor.focus();\n\t\t\t\tctxInlineChatVisible.reset();\n\t\t\t} else {\n\t\t\t\tctxInlineChatVisible.set(true);\n\t\t\t\tthis._zone.value.widget.setChatModel(session.chatModel);\n\t\t\t\tif (!this._zone.value.position) {\n\t\t\t\t\tthis._zone.value.widget.chatWidget.input.renderAttachedContext(); // TODO - fights layout bug\n\t\t\t\t\tthis._zone.value.show(session.initialPosition);\n\t\t\t\t}\n\t\t\t\tthis._zone.value.reveal(this._zone.value.position!);\n\t\t\t\tthis._zone.value.widget.focus();\n\t\t\t}\n\t\t}));\n\n\t\tthis._store.add(autorun(r => {\n\t\t\tconst session = visibleSessionObs.read(r);\n\t\t\tif (session) {\n\t\t\t\tconst entries = session.editingSession.entries.read(r);\n\t\t\t\tconst otherEntries = entries.filter(entry => !isEqual(entry.modifiedURI, session.uri));\n\t\t\t\tfor (const entry of otherEntries) {\n\t\t\t\t\t// OPEN other modified files in side group. This is a workaround, temp-solution until we have no more backend\n\t\t\t\t\t// that modifies other files\n\t\t\t\t\tthis._editorService.openEditor({ resource: entry.modifiedURI }, SIDE_GROUP).catch(onUnexpectedError);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._store.add(autorun(r => {\n\t\t\tconst session = visibleSessionObs.read(r);\n\t\t\tif (!session) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst entry = session.editingSession.readEntry(session.uri, r);\n\t\t\tif (entry?.state.read(r) === ModifiedFileEntryState.Modified) {\n\t\t\t\tentry?.enableReviewModeUntilSettled();\n\t\t\t}\n\n\t\t\tconst inProgress = session.chatModel.requestInProgress.read(r);\n\t\t\tthis._zone.value.widget.domNode.classList.toggle('request-in-progress', inProgress);\n\t\t\tif (!inProgress) {\n\t\t\t\tthis._zone.value.widget.chatWidget.setInputPlaceholder(localize('placeholder', \"Edit, refactor, and generate code\"));\n\t\t\t} else {\n\t\t\t\tconst prompt = session.chatModel.getRequests().at(-1)?.message.text;\n\t\t\t\tthis._zone.value.widget.chatWidget.setInputPlaceholder(prompt || localize('loading', \"Working...\"));\n\t\t\t}\n\t\t}));\n\n\t\tthis._store.add(autorun(r => {\n\n\t\t\tconst session = visibleSessionObs.read(r);\n\t\t\tconst entry = session?.editingSession.readEntry(session.uri, r);\n\n\t\t\t// make sure there is an editor integration\n\t\t\tconst pane = this._editorService.visibleEditorPanes.find(candidate => candidate.getControl() === this._editor || isNotebookWithCellEditor(candidate, this._editor));\n\t\t\tif (pane && entry) {\n\t\t\t\tentry?.getEditorIntegration(pane);\n\t\t\t}\n\n\t\t\t// make sure the ZONE isn't inbetween a diff and move above if so\n\t\t\tif (entry?.diffInfo && this._zone.value.position) {\n\t\t\t\tconst { position } = this._zone.value;\n\t\t\t\tconst diff = entry.diffInfo.read(r);\n\n\t\t\t\tfor (const change of diff.changes) {\n\t\t\t\t\tif (change.modified.contains(position.lineNumber)) {\n\t\t\t\t\t\tthis._zone.value.updatePositionAndHeight(new Position(change.modified.startLineNumber - 1, 1));\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tdispose(): void {\n\t\tthis._store.dispose();\n\t}\n\n\tgetWidgetPosition(): Position | undefined {\n\t\treturn this._zone.rawValue?.position;\n\t}\n\n\tfocus() {\n\t\tthis._zone.rawValue?.widget.focus();\n\t}\n\n\tmarkActiveController() {\n\t\tthis._isActiveController.set(true, undefined);\n\t}\n\n\tasync run(arg?: InlineChatRunOptions): Promise<boolean> {\n\t\tassertType(this._editor.hasModel());\n\n\n\t\tconst uri = this._editor.getModel().uri;\n\n\t\tconst existingSession = this._inlineChatSessions.getSession2(uri);\n\t\tif (existingSession) {\n\t\t\tawait existingSession.editingSession.accept();\n\t\t\texistingSession.dispose();\n\t\t}\n\n\t\tthis.markActiveController();\n\n\t\tconst session = await this._inlineChatSessions.createSession2(this._editor, uri, CancellationToken.None);\n\n\t\t// ADD diagnostics\n\t\tconst entries: IChatRequestVariableEntry[] = [];\n\t\tfor (const [range, marker] of this._markerDecorationsService.getLiveMarkers(uri)) {\n\t\t\tif (range.intersectRanges(this._editor.getSelection())) {\n\t\t\t\tconst filter = IDiagnosticVariableEntryFilterData.fromMarker(marker);\n\t\t\t\tentries.push(IDiagnosticVariableEntryFilterData.toEntry(filter));\n\t\t\t}\n\t\t}\n\t\tif (entries.length > 0) {\n\t\t\tthis._zone.value.widget.chatWidget.attachmentModel.addContext(...entries);\n\t\t\tthis._zone.value.widget.chatWidget.input.setValue(entries.length > 1\n\t\t\t\t? localize('fixN', \"Fix the attached problems\")\n\t\t\t\t: localize('fix1', \"Fix the attached problem\"),\n\t\t\t\ttrue\n\t\t\t);\n\t\t\tthis._zone.value.widget.chatWidget.inputEditor.setSelection(new Selection(1, 1, Number.MAX_SAFE_INTEGER, 1));\n\t\t}\n\n\t\t// Check args\n\t\tif (arg && InlineChatRunOptions.isInlineChatRunOptions(arg)) {\n\t\t\tif (arg.initialRange) {\n\t\t\t\tthis._editor.revealRange(arg.initialRange);\n\t\t\t}\n\t\t\tif (arg.initialSelection) {\n\t\t\t\tthis._editor.setSelection(arg.initialSelection);\n\t\t\t}\n\t\t\tif (arg.attachments) {\n\t\t\t\tawait Promise.all(arg.attachments.map(async attachment => {\n\t\t\t\t\tawait this._zone.value.widget.chatWidget.attachmentModel.addFile(attachment);\n\t\t\t\t}));\n\t\t\t\tdelete arg.attachments;\n\t\t\t}\n\t\t\tif (arg.message) {\n\t\t\t\tthis._zone.value.widget.chatWidget.setInput(arg.message);\n\t\t\t\tif (arg.autoSend) {\n\t\t\t\t\tawait this._zone.value.widget.chatWidget.acceptInput();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tawait Event.toPromise(session.editingSession.onDidDispose);\n\n\t\tconst rejected = session.editingSession.getEntry(uri)?.state.get() === ModifiedFileEntryState.Rejected;\n\t\treturn !rejected;\n\t}\n\n\tasync acceptSession() {\n\t\tconst session = this._currentSession.get();\n\t\tif (!session) {\n\t\t\treturn;\n\t\t}\n\t\tawait session.editingSession.accept();\n\t\tsession.dispose();\n\t}\n\n\tasync rejectSession() {\n\t\tconst session = this._currentSession.get();\n\t\tif (!session) {\n\t\t\treturn;\n\t\t}\n\t\tawait session.editingSession.reject();\n\t\tsession.dispose();\n\t}\n\n\tasync createImageAttachment(attachment: URI): Promise<IChatRequestVariableEntry | undefined> {\n\t\tconst value = this._currentSession.get();\n\t\tif (!value) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (attachment.scheme === Schemas.file) {\n\t\t\tif (await this._fileService.canHandleResource(attachment)) {\n\t\t\t\treturn await this._chatAttachmentResolveService.resolveImageEditorAttachContext(attachment);\n\t\t\t}\n\t\t} else if (attachment.scheme === Schemas.http || attachment.scheme === Schemas.https) {\n\t\t\tconst extractedImages = await this._webContentExtractorService.readImage(attachment, CancellationToken.None);\n\t\t\tif (extractedImages) {\n\t\t\t\treturn await this._chatAttachmentResolveService.resolveImageEditorAttachContext(attachment, extractedImages);\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n}\n\nexport async function reviewEdits(accessor: ServicesAccessor, editor: ICodeEditor, stream: AsyncIterable<TextEdit[]>, token: CancellationToken, applyCodeBlockSuggestionId: EditSuggestionId | undefined): Promise<boolean> {\n\tif (!editor.hasModel()) {\n\t\treturn false;\n\t}\n\n\tconst chatService = accessor.get(IChatService);\n\tconst uri = editor.getModel().uri;\n\tconst chatModel = chatService.startSession(ChatAgentLocation.EditorInline, token);\n\n\tchatModel.startEditingSession(true);\n\n\tconst store = new DisposableStore();\n\tstore.add(chatModel);\n\n\t// STREAM\n\tconst chatRequest = chatModel?.addRequest({ text: '', parts: [] }, { variables: [] }, 0, {\n\t\tkind: undefined,\n\t\tmodeId: 'applyCodeBlock',\n\t\tmodeInstructions: undefined,\n\t\tisBuiltin: true,\n\t\tapplyCodeBlockSuggestionId,\n\t});\n\tassertType(chatRequest.response);\n\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [], done: false });\n\tfor await (const chunk of stream) {\n\n\t\tif (token.isCancellationRequested) {\n\t\t\tchatRequest.response.cancel();\n\t\t\tbreak;\n\t\t}\n\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: chunk, done: false });\n\t}\n\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [], done: true });\n\n\tif (!token.isCancellationRequested) {\n\t\tchatRequest.response.complete();\n\t}\n\n\tconst isSettled = derived(r => {\n\t\tconst entry = chatModel.editingSession?.readEntry(uri, r);\n\t\tif (!entry) {\n\t\t\treturn false;\n\t\t}\n\t\tconst state = entry.state.read(r);\n\t\treturn state === ModifiedFileEntryState.Accepted || state === ModifiedFileEntryState.Rejected;\n\t});\n\tconst whenDecided = waitForState(isSettled, Boolean);\n\tawait raceCancellation(whenDecided, token);\n\tstore.dispose();\n\treturn true;\n}\n\nexport async function reviewNotebookEdits(accessor: ServicesAccessor, uri: URI, stream: AsyncIterable<[URI, TextEdit[]] | ICellEditOperation[]>, token: CancellationToken): Promise<boolean> {\n\n\tconst chatService = accessor.get(IChatService);\n\tconst notebookService = accessor.get(INotebookService);\n\tconst isNotebook = notebookService.hasSupportedNotebooks(uri);\n\tconst chatModel = chatService.startSession(ChatAgentLocation.EditorInline, token);\n\n\tchatModel.startEditingSession(true);\n\n\tconst store = new DisposableStore();\n\tstore.add(chatModel);\n\n\t// STREAM\n\tconst chatRequest = chatModel?.addRequest({ text: '', parts: [] }, { variables: [] }, 0);\n\tassertType(chatRequest.response);\n\tif (isNotebook) {\n\t\tchatRequest.response.updateContent({ kind: 'notebookEdit', uri, edits: [], done: false });\n\t} else {\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [], done: false });\n\t}\n\tfor await (const chunk of stream) {\n\n\t\tif (token.isCancellationRequested) {\n\t\t\tchatRequest.response.cancel();\n\t\t\tbreak;\n\t\t}\n\t\tif (chunk.every(isCellEditOperation)) {\n\t\t\tchatRequest.response.updateContent({ kind: 'notebookEdit', uri, edits: chunk, done: false });\n\t\t} else {\n\t\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri: chunk[0], edits: chunk[1], done: false });\n\t\t}\n\t}\n\tif (isNotebook) {\n\t\tchatRequest.response.updateContent({ kind: 'notebookEdit', uri, edits: [], done: true });\n\t} else {\n\t\tchatRequest.response.updateContent({ kind: 'textEdit', uri, edits: [], done: true });\n\t}\n\n\tif (!token.isCancellationRequested) {\n\t\tchatRequest.response.complete();\n\t}\n\n\tconst isSettled = derived(r => {\n\t\tconst entry = chatModel.editingSession?.readEntry(uri, r);\n\t\tif (!entry) {\n\t\t\treturn false;\n\t\t}\n\t\tconst state = entry.state.read(r);\n\t\treturn state === ModifiedFileEntryState.Accepted || state === ModifiedFileEntryState.Rejected;\n\t});\n\n\tconst whenDecided = waitForState(isSettled, Boolean);\n\n\tawait raceCancellation(whenDecided, token);\n\n\tstore.dispose();\n\n\treturn true;\n}\n\nfunction isCellEditOperation(edit: URI | TextEdit[] | ICellEditOperation): edit is ICellEditOperation {\n\tif (URI.isUri(edit)) {\n\t\treturn false;\n\t}\n\tif (Array.isArray(edit)) {\n\t\treturn false;\n\t}\n\treturn true;\n}\n"]}