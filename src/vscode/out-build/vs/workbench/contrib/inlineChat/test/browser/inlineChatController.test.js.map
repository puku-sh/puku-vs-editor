{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/inlineChat/test/browser/inlineChatController.test.ts","vs/workbench/contrib/inlineChat/test/browser/inlineChatController.test.ts"],"names":[],"mappings":"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","file":"inlineChatController.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { equals } from '../../../../../base/common/arrays.js';\nimport { DeferredPromise, raceCancellation, timeout } from '../../../../../base/common/async.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { constObservable, IObservable } from '../../../../../base/common/observable.js';\nimport { assertType } from '../../../../../base/common/types.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { runWithFakedTimers } from '../../../../../base/test/common/timeTravelScheduler.js';\nimport { IActiveCodeEditor, ICodeEditor } from '../../../../../editor/browser/editorBrowser.js';\nimport { IDiffProviderFactoryService } from '../../../../../editor/browser/widget/diffEditor/diffProviderFactoryService.js';\nimport { EditOperation } from '../../../../../editor/common/core/editOperation.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { EndOfLineSequence, ITextModel } from '../../../../../editor/common/model.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { IModelService } from '../../../../../editor/common/services/model.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { TestDiffProviderFactoryService } from '../../../../../editor/test/browser/diff/testDiffProviderFactoryService.js';\nimport { TestCommandService } from '../../../../../editor/test/browser/editorTestServices.js';\nimport { instantiateTestCodeEditor } from '../../../../../editor/test/browser/testCodeEditor.js';\nimport { IAccessibleViewService } from '../../../../../platform/accessibility/browser/accessibleView.js';\nimport { ICommandService } from '../../../../../platform/commands/common/commands.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IHoverService } from '../../../../../platform/hover/browser/hover.js';\nimport { NullHoverService } from '../../../../../platform/hover/test/browser/nullHoverService.js';\nimport { SyncDescriptor } from '../../../../../platform/instantiation/common/descriptors.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { MockContextKeyService } from '../../../../../platform/keybinding/test/common/mockKeybindingService.js';\nimport { ILogService, NullLogService } from '../../../../../platform/log/common/log.js';\nimport { IEditorProgressService, IProgressRunner } from '../../../../../platform/progress/common/progress.js';\nimport { ITelemetryService } from '../../../../../platform/telemetry/common/telemetry.js';\nimport { NullTelemetryService } from '../../../../../platform/telemetry/common/telemetryUtils.js';\nimport { IWorkspaceContextService } from '../../../../../platform/workspace/common/workspace.js';\nimport { IView, IViewDescriptorService } from '../../../../common/views.js';\nimport { IWorkbenchAssignmentService } from '../../../../services/assignment/common/assignmentService.js';\nimport { NullWorkbenchAssignmentService } from '../../../../services/assignment/test/common/nullAssignmentService.js';\nimport { IExtensionService, nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { TextModelResolverService } from '../../../../services/textmodelResolver/common/textModelResolverService.js';\nimport { IViewsService } from '../../../../services/views/common/viewsService.js';\nimport { TestViewsService, workbenchInstantiationService } from '../../../../test/browser/workbenchTestServices.js';\nimport { TestChatEntitlementService, TestContextService, TestExtensionService } from '../../../../test/common/workbenchTestServices.js';\nimport { AccessibilityVerbositySettingId } from '../../../accessibility/browser/accessibilityConfiguration.js';\nimport { IChatAccessibilityService, IChatWidget, IChatWidgetService, IQuickChatService } from '../../../chat/browser/chat.js';\nimport { ChatInputBoxContentProvider } from '../../../chat/browser/chatEdinputInputContentProvider.js';\nimport { ChatLayoutService } from '../../../chat/browser/chatLayoutService.js';\nimport { ChatVariablesService } from '../../../chat/browser/chatVariables.js';\nimport { ChatWidget } from '../../../chat/browser/chatWidget.js';\nimport { ChatAgentService, IChatAgentData, IChatAgentNameService, IChatAgentService } from '../../../chat/common/chatAgents.js';\nimport { IChatEditingService, IChatEditingSession } from '../../../chat/common/chatEditingService.js';\nimport { IChatEntitlementService } from '../../../../services/chat/common/chatEntitlementService.js';\nimport { IChatLayoutService } from '../../../chat/common/chatLayoutService.js';\nimport { IChatModeService } from '../../../chat/common/chatModes.js';\nimport { IChatTodo, IChatTodoListService } from '../../../chat/common/chatTodoListService.js';\nimport { IChatProgress, IChatService } from '../../../chat/common/chatService.js';\nimport { ChatService } from '../../../chat/common/chatServiceImpl.js';\nimport { ChatSlashCommandService, IChatSlashCommandService } from '../../../chat/common/chatSlashCommands.js';\nimport { ChatTransferService, IChatTransferService } from '../../../chat/common/chatTransferService.js';\nimport { IChatVariablesService } from '../../../chat/common/chatVariables.js';\nimport { IChatResponseViewModel } from '../../../chat/common/chatViewModel.js';\nimport { ChatWidgetHistoryService, IChatWidgetHistoryService } from '../../../chat/common/chatWidgetHistoryService.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../../chat/common/constants.js';\nimport { ILanguageModelsService, LanguageModelsService } from '../../../chat/common/languageModels.js';\nimport { ILanguageModelToolsService } from '../../../chat/common/languageModelToolsService.js';\nimport { PromptsType } from '../../../chat/common/promptSyntax/promptTypes.js';\nimport { IPromptPath, IPromptsService } from '../../../chat/common/promptSyntax/service/promptsService.js';\nimport { MockChatModeService } from '../../../chat/test/common/mockChatModeService.js';\nimport { MockLanguageModelToolsService } from '../../../chat/test/common/mockLanguageModelToolsService.js';\nimport { IMcpService } from '../../../mcp/common/mcpTypes.js';\nimport { TestMcpService } from '../../../mcp/test/common/testMcpService.js';\nimport { INotebookEditorService } from '../../../notebook/browser/services/notebookEditorService.js';\nimport { RerunAction } from '../../browser/inlineChatActions.js';\nimport { InlineChatController1, State } from '../../browser/inlineChatController.js';\nimport { IInlineChatSessionService } from '../../browser/inlineChatSessionService.js';\nimport { InlineChatSessionServiceImpl } from '../../browser/inlineChatSessionServiceImpl.js';\nimport { CTX_INLINE_CHAT_RESPONSE_TYPE, InlineChatConfigKeys, InlineChatResponseType } from '../../common/inlineChat.js';\nimport { TestWorkerService } from './testWorkerService.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { ChatWidgetService } from '../../../chat/browser/chatWidgetService.js';\nimport { ChatContextService, IChatContextService } from '../../../chat/browser/chatContextService.js';\n\nsuite('InlineChatController', function () {\n\n\tconst agentData = {\n\t\textensionId: nullExtensionDescription.identifier,\n\t\textensionVersion: undefined,\n\t\tpublisherDisplayName: '',\n\t\textensionDisplayName: '',\n\t\textensionPublisherId: '',\n\t\t// id: 'testEditorAgent',\n\t\tname: 'testEditorAgent',\n\t\tisDefault: true,\n\t\tlocations: [ChatAgentLocation.EditorInline],\n\t\tmodes: [ChatModeKind.Ask],\n\t\tmetadata: {},\n\t\tslashCommands: [],\n\t\tdisambiguation: [],\n\t};\n\n\tclass TestController extends InlineChatController1 {\n\n\t\tstatic INIT_SEQUENCE: readonly State[] = [State.CREATE_SESSION, State.INIT_UI, State.WAIT_FOR_INPUT];\n\t\tstatic INIT_SEQUENCE_AUTO_SEND: readonly State[] = [...this.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT];\n\n\n\t\treadonly onDidChangeState: Event<State> = this._onDidEnterState.event;\n\n\t\treadonly states: readonly State[] = [];\n\n\t\tawaitStates(states: readonly State[]): Promise<string | undefined> {\n\t\t\tconst actual: State[] = [];\n\n\t\t\treturn new Promise<string | undefined>((resolve, reject) => {\n\t\t\t\tconst d = this.onDidChangeState(state => {\n\t\t\t\t\tactual.push(state);\n\t\t\t\t\tif (equals(states, actual)) {\n\t\t\t\t\t\td.dispose();\n\t\t\t\t\t\tresolve(undefined);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\td.dispose();\n\t\t\t\t\tresolve(`[${states.join(',')}] <> [${actual.join(',')}]`);\n\t\t\t\t}, 1000);\n\t\t\t});\n\t\t}\n\t}\n\n\tconst store = new DisposableStore();\n\tlet configurationService: TestConfigurationService;\n\tlet editor: IActiveCodeEditor;\n\tlet model: ITextModel;\n\tlet ctrl: TestController;\n\tlet contextKeyService: MockContextKeyService;\n\tlet chatService: IChatService;\n\tlet chatAgentService: IChatAgentService;\n\tlet inlineChatSessionService: IInlineChatSessionService;\n\tlet instaService: TestInstantiationService;\n\n\tlet chatWidget: IChatWidget;\n\n\tsetup(function () {\n\n\t\tconst serviceCollection = new ServiceCollection(\n\t\t\t[IConfigurationService, new TestConfigurationService()],\n\t\t\t[IChatVariablesService, new SyncDescriptor(ChatVariablesService)],\n\t\t\t[ILogService, new NullLogService()],\n\t\t\t[ITelemetryService, NullTelemetryService],\n\t\t\t[IHoverService, NullHoverService],\n\t\t\t[IExtensionService, new TestExtensionService()],\n\t\t\t[IContextKeyService, new MockContextKeyService()],\n\t\t\t[IViewsService, new class extends TestViewsService {\n\t\t\t\toverride async openView<T extends IView>(id: string, focus?: boolean | undefined): Promise<T | null> {\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\treturn { widget: chatWidget ?? null } as any;\n\t\t\t\t}\n\t\t\t}()],\n\t\t\t[IWorkspaceContextService, new TestContextService()],\n\t\t\t[IChatWidgetHistoryService, new SyncDescriptor(ChatWidgetHistoryService)],\n\t\t\t[IChatWidgetService, new SyncDescriptor(ChatWidgetService)],\n\t\t\t[IChatSlashCommandService, new SyncDescriptor(ChatSlashCommandService)],\n\t\t\t[IChatTransferService, new SyncDescriptor(ChatTransferService)],\n\t\t\t[IChatService, new SyncDescriptor(ChatService)],\n\t\t\t[IMcpService, new TestMcpService()],\n\t\t\t[IChatAgentNameService, new class extends mock<IChatAgentNameService>() {\n\t\t\t\toverride getAgentNameRestriction(chatAgentData: IChatAgentData): boolean {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IEditorWorkerService, new SyncDescriptor(TestWorkerService)],\n\t\t\t[IContextKeyService, contextKeyService],\n\t\t\t[IChatAgentService, new SyncDescriptor(ChatAgentService)],\n\t\t\t[IDiffProviderFactoryService, new SyncDescriptor(TestDiffProviderFactoryService)],\n\t\t\t[IInlineChatSessionService, new SyncDescriptor(InlineChatSessionServiceImpl)],\n\t\t\t[ICommandService, new SyncDescriptor(TestCommandService)],\n\t\t\t[IChatEditingService, new class extends mock<IChatEditingService>() {\n\t\t\t\toverride editingSessionsObs: IObservable<readonly IChatEditingSession[]> = constObservable([]);\n\t\t\t}],\n\t\t\t[IEditorProgressService, new class extends mock<IEditorProgressService>() {\n\t\t\t\toverride show(total: unknown, delay?: unknown): IProgressRunner {\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttotal() { },\n\t\t\t\t\t\tworked(value) { },\n\t\t\t\t\t\tdone() { },\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IChatAccessibilityService, new class extends mock<IChatAccessibilityService>() {\n\t\t\t\toverride acceptResponse(widget: ChatWidget, container: HTMLElement, response: IChatResponseViewModel | undefined, requestId: number): void { }\n\t\t\t\toverride acceptRequest(): number { return -1; }\n\t\t\t\toverride acceptElicitation(): void { }\n\t\t\t}],\n\t\t\t[IAccessibleViewService, new class extends mock<IAccessibleViewService>() {\n\t\t\t\toverride getOpenAriaHint(verbositySettingKey: AccessibilityVerbositySettingId): string | null {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IConfigurationService, configurationService],\n\t\t\t[IViewDescriptorService, new class extends mock<IViewDescriptorService>() {\n\t\t\t\toverride onDidChangeLocation = Event.None;\n\t\t\t}],\n\t\t\t[INotebookEditorService, new class extends mock<INotebookEditorService>() {\n\t\t\t\toverride listNotebookEditors() { return []; }\n\t\t\t\toverride getNotebookForPossibleCell(editor: ICodeEditor) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IWorkbenchAssignmentService, new NullWorkbenchAssignmentService()],\n\t\t\t[ILanguageModelsService, new SyncDescriptor(LanguageModelsService)],\n\t\t\t[ITextModelService, new SyncDescriptor(TextModelResolverService)],\n\t\t\t[ILanguageModelToolsService, new SyncDescriptor(MockLanguageModelToolsService)],\n\t\t\t[IPromptsService, new class extends mock<IPromptsService>() {\n\t\t\t\toverride async listPromptFiles(type: PromptsType, token: CancellationToken): Promise<readonly IPromptPath[]> {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IChatEntitlementService, new class extends mock<IChatEntitlementService>() { }],\n\t\t\t[IChatModeService, new SyncDescriptor(MockChatModeService)],\n\t\t\t[IChatLayoutService, new SyncDescriptor(ChatLayoutService)],\n\t\t\t[IQuickChatService, new class extends mock<IQuickChatService>() { }],\n\t\t\t[IChatTodoListService, new class extends mock<IChatTodoListService>() {\n\t\t\t\toverride onDidUpdateTodos = Event.None;\n\t\t\t\toverride getTodos(sessionResource: URI): IChatTodo[] { return []; }\n\t\t\t\toverride setTodos(sessionResource: URI, todos: IChatTodo[]): void { }\n\t\t\t}],\n\t\t\t[IChatEntitlementService, new SyncDescriptor(TestChatEntitlementService)],\n\t\t);\n\n\t\tinstaService = store.add((store.add(workbenchInstantiationService(undefined, store))).createChild(serviceCollection));\n\n\t\tconfigurationService = instaService.get(IConfigurationService) as TestConfigurationService;\n\t\tconfigurationService.setUserConfiguration('chat', { editor: { fontSize: 14, fontFamily: 'default' } });\n\n\t\tconfigurationService.setUserConfiguration('editor', {});\n\n\t\tcontextKeyService = instaService.get(IContextKeyService) as MockContextKeyService;\n\t\tchatService = instaService.get(IChatService);\n\t\tchatAgentService = instaService.get(IChatAgentService);\n\n\t\tinlineChatSessionService = store.add(instaService.get(IInlineChatSessionService));\n\n\t\tstore.add(instaService.get(ILanguageModelsService) as LanguageModelsService);\n\t\tstore.add(instaService.get(IEditorWorkerService) as TestWorkerService);\n\n\t\tstore.add(instaService.createInstance(ChatInputBoxContentProvider));\n\n\t\tmodel = store.add(instaService.get(IModelService).createModel('Hello\\nWorld\\nHello Again\\nHello World\\n', null));\n\t\tmodel.setEOL(EndOfLineSequence.LF);\n\t\teditor = store.add(instantiateTestCodeEditor(instaService, model));\n\n\t\tinstaService.set(IChatContextService, store.add(instaService.createInstance(ChatContextService)));\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({ id: 'testEditorAgent', ...agentData, }, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{\n\t\t\t\t\tkind: 'textEdit',\n\t\t\t\t\turi: model.uri,\n\t\t\t\t\tedits: [{\n\t\t\t\t\t\trange: new Range(1, 1, 1, 1),\n\t\t\t\t\t\ttext: request.message\n\t\t\t\t\t}]\n\t\t\t\t}]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t});\n\n\tteardown(function () {\n\t\tstore.clear();\n\t\tctrl?.dispose();\n\t});\n\n\t// TODO@jrieken re-enable, looks like List/ChatWidget is leaking\n\t// ensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('creation, not showing anything', function () {\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tassert.ok(ctrl);\n\t\tassert.strictEqual(ctrl.getWidgetPosition(), undefined);\n\t});\n\n\ttest('run (show/hide)', async function () {\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst actualStates = ctrl.awaitStates(TestController.INIT_SEQUENCE_AUTO_SEND);\n\t\tconst run = ctrl.run({ message: 'Hello', autoSend: true });\n\t\tassert.strictEqual(await actualStates, undefined);\n\t\tassert.ok(ctrl.getWidgetPosition() !== undefined);\n\t\tawait ctrl.cancelSession();\n\n\t\tawait run;\n\n\t\tassert.ok(ctrl.getWidgetPosition() === undefined);\n\t});\n\n\ttest('wholeRange does not expand to whole lines, editor selection default', async function () {\n\n\t\teditor.setSelection(new Range(1, 1, 1, 3));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\tctrl.run({});\n\t\tawait Event.toPromise(Event.filter(ctrl.onDidChangeState, e => e === State.WAIT_FOR_INPUT));\n\n\t\tconst session = inlineChatSessionService.getSession(editor, editor.getModel()!.uri);\n\t\tassert.ok(session);\n\t\tassert.deepStrictEqual(session.wholeRange.value, new Range(1, 1, 1, 3));\n\n\t\tawait ctrl.cancelSession();\n\t});\n\n\ttest('typing outside of wholeRange finishes session', async function () {\n\n\t\tconfigurationService.setUserConfiguration(InlineChatConfigKeys.FinishOnType, true);\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst actualStates = ctrl.awaitStates(TestController.INIT_SEQUENCE_AUTO_SEND);\n\t\tconst r = ctrl.run({ message: 'Hello', autoSend: true });\n\n\t\tassert.strictEqual(await actualStates, undefined);\n\n\t\tconst session = inlineChatSessionService.getSession(editor, editor.getModel()!.uri);\n\t\tassert.ok(session);\n\t\tassert.deepStrictEqual(session.wholeRange.value, new Range(1, 1, 1, 11 /* line length */));\n\n\t\teditor.setSelection(new Range(2, 1, 2, 1));\n\t\teditor.trigger('test', 'type', { text: 'a' });\n\n\t\tassert.strictEqual(await ctrl.awaitStates([State.ACCEPT]), undefined);\n\t\tawait r;\n\t});\n\n\ttest('\\'whole range\\' isn\\'t updated for edits outside whole range #4346', async function () {\n\n\t\teditor.setSelection(new Range(3, 1, 3, 3));\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{\n\t\t\t\t\tkind: 'textEdit',\n\t\t\t\t\turi: editor.getModel().uri,\n\t\t\t\t\tedits: [{\n\t\t\t\t\t\trange: new Range(1, 1, 1, 1), // EDIT happens outside of whole range\n\t\t\t\t\t\ttext: `${request.message}\\n${request.message}`\n\t\t\t\t\t}]\n\t\t\t\t}]);\n\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates(TestController.INIT_SEQUENCE);\n\t\tconst r = ctrl.run({ message: 'GENGEN', autoSend: false });\n\n\t\tassert.strictEqual(await p, undefined);\n\n\n\t\tconst session = inlineChatSessionService.getSession(editor, editor.getModel()!.uri);\n\t\tassert.ok(session);\n\t\tassert.deepStrictEqual(session.wholeRange.value, new Range(3, 1, 3, 3)); // initial\n\n\t\tctrl.chatWidget.setInput('GENGEN');\n\t\tctrl.chatWidget.acceptInput();\n\t\tassert.strictEqual(await ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]), undefined);\n\n\t\tassert.deepStrictEqual(session.wholeRange.value, new Range(1, 1, 4, 3));\n\n\t\tawait ctrl.cancelSession();\n\t\tawait r;\n\t});\n\n\ttest('Stuck inline chat widget #211', async function () {\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\treturn new Promise<never>(() => { });\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tconst r = ctrl.run({ message: 'Hello', autoSend: true });\n\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tctrl.acceptSession();\n\n\t\tawait r;\n\t\tassert.strictEqual(ctrl.getWidgetPosition(), undefined);\n\t});\n\n\ttest('[Bug] Inline Chat\\'s streaming pushed broken iterations to the undo stack #2403', async function () {\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'hEllo1\\n' }] }]);\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(2, 1, 2, 1), text: 'hEllo2\\n' }] }]);\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1000, 1), text: 'Hello1\\nHello2\\n' }] }]);\n\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tconst valueThen = editor.getModel().getValue();\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: 'Hello', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\t\tctrl.acceptSession();\n\t\tawait r;\n\n\t\tassert.strictEqual(editor.getModel().getValue(), 'Hello1\\nHello2\\n');\n\n\t\teditor.getModel().undo();\n\t\tassert.strictEqual(editor.getModel().getValue(), valueThen);\n\t});\n\n\n\n\ttest.skip('UI is streaming edits minutes after the response is finished #3345', async function () {\n\n\n\t\treturn runWithFakedTimers({ maxTaskCount: Number.MAX_SAFE_INTEGER }, async () => {\n\n\t\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\t\tid: 'testEditorAgent2',\n\t\t\t\t...agentData\n\t\t\t}, {\n\t\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\t\tconst text = '${CSI}#a\\n${CSI}#b\\n${CSI}#c\\n';\n\n\t\t\t\t\tawait timeout(10);\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text }] }]);\n\n\t\t\t\t\tawait timeout(10);\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text.repeat(1000) + 'DONE' }] }]);\n\n\t\t\t\t\tthrow new Error('Too long');\n\t\t\t\t},\n\t\t\t}));\n\n\n\t\t\t// let modelChangeCounter = 0;\n\t\t\t// store.add(editor.getModel().onDidChangeContent(() => { modelChangeCounter++; }));\n\n\t\t\tctrl = instaService.createInstance(TestController, editor);\n\t\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\t\tconst r = ctrl.run({ message: 'Hello', autoSend: true });\n\t\t\tassert.strictEqual(await p, undefined);\n\n\t\t\t// assert.ok(modelChangeCounter > 0, modelChangeCounter.toString()); // some changes have been made\n\t\t\t// const modelChangeCounterNow = modelChangeCounter;\n\n\t\t\tassert.ok(!editor.getModel().getValue().includes('DONE'));\n\t\t\tawait timeout(10);\n\n\t\t\t// assert.strictEqual(modelChangeCounterNow, modelChangeCounter);\n\t\t\tassert.ok(!editor.getModel().getValue().includes('DONE'));\n\n\t\t\tawait ctrl.cancelSession();\n\t\t\tawait r;\n\t\t});\n\t});\n\n\ttest('escape doesn\\'t remove code added from inline editor chat #3523 1/2', async function () {\n\n\n\t\t// NO manual edits -> cancel\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: 'GENERATED', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.ok(model.getValue().includes('GENERATED'));\n\t\tctrl.cancelSession();\n\t\tawait r;\n\t\tassert.ok(!model.getValue().includes('GENERATED'));\n\n\t});\n\n\ttest('escape doesn\\'t remove code added from inline editor chat #3523, 2/2', async function () {\n\n\t\t// manual edits -> finish\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: 'GENERATED', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.ok(model.getValue().includes('GENERATED'));\n\n\t\teditor.executeEdits('test', [EditOperation.insert(model.getFullModelRange().getEndPosition(), 'MANUAL')]);\n\n\t\tctrl.acceptSession();\n\t\tawait r;\n\t\tassert.ok(model.getValue().includes('GENERATED'));\n\t\tassert.ok(model.getValue().includes('MANUAL'));\n\n\t});\n\n\ttest('cancel while applying streamed edits should close the widget', async function () {\n\n\t\tconst workerService = instaService.get(IEditorWorkerService) as TestWorkerService;\n\t\tconst originalCompute = workerService.computeMoreMinimalEdits.bind(workerService);\n\t\tconst editsBarrier = new DeferredPromise<void>();\n\t\tlet computeInvoked = false;\n\t\tworkerService.computeMoreMinimalEdits = async (resource, edits, pretty) => {\n\t\t\tcomputeInvoked = true;\n\t\t\tawait editsBarrier.p;\n\t\t\treturn originalCompute(resource, edits, pretty);\n\t\t};\n\t\tstore.add({ dispose: () => { workerService.computeMoreMinimalEdits = originalCompute; } });\n\n\t\tconst progressBarrier = new DeferredPromise<void>();\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'pendingEditsAgent',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: request.message }] }]);\n\t\t\t\tawait progressBarrier.p;\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst states = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tconst run = ctrl.run({ message: 'BLOCK', autoSend: true });\n\t\tassert.strictEqual(await states, undefined);\n\t\tassert.ok(computeInvoked);\n\n\t\tctrl.cancelSession();\n\t\tassert.strictEqual(await states, undefined);\n\n\t\tawait run;\n\t});\n\n\ttest('re-run should discard pending edits', async function () {\n\n\t\tlet count = 1;\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: request.message + (count++) }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst rerun = new RerunAction();\n\n\t\tmodel.setValue('');\n\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: 'PROMPT_', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\n\t\tassert.strictEqual(model.getValue(), 'PROMPT_1');\n\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tawait instaService.invokeFunction(rerun.runInlineChatCommand, ctrl, editor);\n\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'PROMPT_2');\n\t\tctrl.acceptSession();\n\t\tawait r;\n\t});\n\n\ttest('Retry undoes all changes, not just those from the request#5736', async function () {\n\n\t\tconst text = [\n\t\t\t'eins-',\n\t\t\t'zwei-',\n\t\t\t'drei-'\n\t\t];\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text.shift() ?? '' }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst rerun = new RerunAction();\n\n\t\tmodel.setValue('');\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: '1', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'eins-');\n\n\t\t// REQUEST 2\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.chatWidget.setInput('1');\n\t\tawait ctrl.chatWidget.acceptInput();\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'zwei-eins-');\n\n\t\t// REQUEST 2 - RERUN\n\t\tconst p3 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tawait instaService.invokeFunction(rerun.runInlineChatCommand, ctrl, editor);\n\t\tassert.strictEqual(await p3, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'drei-eins-');\n\n\t\tctrl.acceptSession();\n\t\tawait r;\n\n\t});\n\n\ttest('moving inline chat to another model undoes changes', async function () {\n\t\tconst text = [\n\t\t\t'eins\\n',\n\t\t\t'zwei\\n'\n\t\t];\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text.shift() ?? '' }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.run({ message: '1', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'eins\\nHello\\nWorld\\nHello Again\\nHello World\\n');\n\n\t\tconst targetModel = chatService.startSession(ChatAgentLocation.EditorInline, CancellationToken.None)!;\n\t\tstore.add(targetModel);\n\t\tchatWidget = new class extends mock<IChatWidget>() {\n\t\t\toverride get viewModel() {\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\treturn { model: targetModel } as any;\n\t\t\t}\n\t\t\toverride focusResponseItem() { }\n\t\t};\n\n\t\tconst r = ctrl.joinCurrentRun();\n\t\tawait ctrl.viewInChat();\n\n\t\tassert.strictEqual(model.getValue(), 'Hello\\nWorld\\nHello Again\\nHello World\\n');\n\t\tawait r;\n\t});\n\n\ttest('moving inline chat to another model undoes changes (2 requests)', async function () {\n\t\tconst text = [\n\t\t\t'eins\\n',\n\t\t\t'zwei\\n'\n\t\t];\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text.shift() ?? '' }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.run({ message: '1', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'eins\\nHello\\nWorld\\nHello Again\\nHello World\\n');\n\n\t\t// REQUEST 2\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.chatWidget.setInput('1');\n\t\tawait ctrl.chatWidget.acceptInput();\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'zwei\\neins\\nHello\\nWorld\\nHello Again\\nHello World\\n');\n\n\t\tconst targetModel = chatService.startSession(ChatAgentLocation.EditorInline, CancellationToken.None)!;\n\t\tstore.add(targetModel);\n\t\tchatWidget = new class extends mock<IChatWidget>() {\n\t\t\toverride get viewModel() {\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\treturn { model: targetModel } as any;\n\t\t\t}\n\t\t\toverride focusResponseItem() { }\n\t\t};\n\n\t\tconst r = ctrl.joinCurrentRun();\n\n\t\tawait ctrl.viewInChat();\n\n\t\tassert.strictEqual(model.getValue(), 'Hello\\nWorld\\nHello Again\\nHello World\\n');\n\n\t\tawait r;\n\t});\n\n\t// TODO@jrieken https://github.com/microsoft/vscode/issues/251429\n\ttest.skip('Clicking \"re-run without /doc\" while a request is in progress closes the widget #5997', async function () {\n\n\t\tmodel.setValue('');\n\n\t\tlet count = 0;\n\t\tconst commandDetection: (boolean | undefined)[] = [];\n\n\t\tconst onDidInvoke = new Emitter<void>();\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tqueueMicrotask(() => onDidInvoke.fire());\n\t\t\t\tcommandDetection.push(request.enableCommandDetection);\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: request.message + (count++) }] }]);\n\n\t\t\t\tif (count === 1) {\n\t\t\t\t\t// FIRST call waits for cancellation\n\t\t\t\t\tawait raceCancellation(new Promise<never>(() => { }), token);\n\t\t\t\t} else {\n\t\t\t\t\tawait timeout(10);\n\t\t\t\t}\n\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\t// const p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tconst p = Event.toPromise(onDidInvoke.event);\n\t\tctrl.run({ message: 'Hello-', autoSend: true });\n\n\t\tawait p;\n\n\t\t// assert.strictEqual(await p, undefined);\n\n\t\t// resend pending request without command detection\n\t\tconst request = ctrl.chatWidget.viewModel?.model.getRequests().at(-1);\n\t\tassertType(request);\n\t\tconst p2 = Event.toPromise(onDidInvoke.event);\n\t\tconst p3 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tchatService.resendRequest(request, { noCommandDetection: true, attempt: request.attempt + 1, location: ChatAgentLocation.EditorInline });\n\n\t\tawait p2;\n\t\tassert.strictEqual(await p3, undefined);\n\n\t\tassert.deepStrictEqual(commandDetection, [true, false]);\n\t\tassert.strictEqual(model.getValue(), 'Hello-1');\n\t});\n\n\ttest('Re-run without after request is done', async function () {\n\n\t\tmodel.setValue('');\n\n\t\tlet count = 0;\n\t\tconst commandDetection: (boolean | undefined)[] = [];\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tcommandDetection.push(request.enableCommandDetection);\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: request.message + (count++) }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.run({ message: 'Hello-', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\t// resend pending request without command detection\n\t\tconst request = ctrl.chatWidget.viewModel?.model.getRequests().at(-1);\n\t\tassertType(request);\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tchatService.resendRequest(request, { noCommandDetection: true, attempt: request.attempt + 1, location: ChatAgentLocation.EditorInline });\n\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.deepStrictEqual(commandDetection, [true, false]);\n\t\tassert.strictEqual(model.getValue(), 'Hello-1');\n\t});\n\n\n\ttest('Inline: Pressing Rerun request while the response streams breaks the response #5442', async function () {\n\n\t\tmodel.setValue('two\\none\\n');\n\n\t\tconst attempts: (number | undefined)[] = [];\n\n\t\tconst deferred = new DeferredPromise<void>();\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\tattempts.push(request.attempt);\n\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: `TRY:${request.attempt}\\n` }] }]);\n\t\t\t\tawait raceCancellation(deferred.p, token);\n\t\t\t\tdeferred.complete();\n\t\t\t\tawait timeout(10);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tctrl.run({ message: 'Hello-', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\t\tawait timeout(10);\n\t\tassert.deepStrictEqual(attempts, [0]);\n\n\t\t// RERUN (cancel, undo, redo)\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst rerun = new RerunAction();\n\t\tawait instaService.invokeFunction(rerun.runInlineChatCommand, ctrl, editor);\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.deepStrictEqual(attempts, [0, 1]);\n\n\t\tassert.strictEqual(model.getValue(), 'TRY:1\\ntwo\\none\\n');\n\n\t});\n\n\ttest('Stopping/cancelling a request should NOT undo its changes', async function () {\n\n\t\tmodel.setValue('World');\n\n\t\tconst deferred = new DeferredPromise<void>();\n\t\tlet progress: ((parts: IChatProgress[]) => void) | undefined;\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, _progress, history, token) {\n\n\t\t\t\tprogress = _progress;\n\t\t\t\tawait deferred.p;\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tctrl.run({ message: 'Hello', autoSend: true });\n\t\tawait timeout(10);\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassertType(progress);\n\n\t\tconst modelChange = new Promise<void>(resolve => model.onDidChangeContent(() => resolve()));\n\n\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello-Hello' }] }]);\n\n\t\tawait modelChange;\n\t\tassert.strictEqual(model.getValue(), 'HelloWorld'); // first word has been streamed\n\n\t\tconst p2 = ctrl.awaitStates([State.WAIT_FOR_INPUT]);\n\t\tchatService.cancelCurrentRequestForSession(ctrl.chatWidget.viewModel!.model.sessionResource);\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'HelloWorld'); // CANCEL just stops the request and progressive typing but doesn't undo\n\n\t});\n\n\ttest('Apply Edits from existing session w/ edits', async function () {\n\n\t\tmodel.setValue('');\n\n\t\tconst newSession = await inlineChatSessionService.createSession(editor, {}, CancellationToken.None);\n\t\tassertType(newSession);\n\n\t\tawait (await chatService.sendRequest(newSession.chatModel.sessionResource, 'Existing', { location: ChatAgentLocation.EditorInline }))?.responseCreatedPromise;\n\n\t\tassert.strictEqual(newSession.chatModel.requestInProgress.get(), true);\n\n\t\tconst response = newSession.chatModel.lastRequest?.response;\n\t\tassertType(response);\n\n\t\tawait new Promise(resolve => {\n\t\t\tif (response.isComplete) {\n\t\t\t\tresolve(undefined);\n\t\t\t}\n\t\t\tconst d = response.onDidChange(() => {\n\t\t\t\tif (response.isComplete) {\n\t\t\t\t\td.dispose();\n\t\t\t\t\tresolve(undefined);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE]);\n\t\tctrl.run({ existingSession: newSession });\n\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'Existing');\n\n\t});\n\n\ttest('Undo on error (2 rounds)', async function () {\n\n\t\treturn runWithFakedTimers({}, async () => {\n\n\n\t\t\tstore.add(chatAgentService.registerDynamicAgent({ id: 'testEditorAgent', ...agentData, }, {\n\t\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\t\tprogress([{\n\t\t\t\t\t\tkind: 'textEdit',\n\t\t\t\t\t\turi: model.uri,\n\t\t\t\t\t\tedits: [{\n\t\t\t\t\t\t\trange: new Range(1, 1, 1, 1),\n\t\t\t\t\t\t\ttext: request.message\n\t\t\t\t\t\t}]\n\t\t\t\t\t}]);\n\n\t\t\t\t\tif (request.message === 'two') {\n\t\t\t\t\t\tawait timeout(100); // give edit a chance\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\terrorDetails: { message: 'FAILED' }\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\treturn {};\n\t\t\t\t},\n\t\t\t}));\n\n\t\t\tmodel.setValue('');\n\n\t\t\t// ROUND 1\n\n\t\t\tctrl = instaService.createInstance(TestController, editor);\n\t\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\t\tctrl.run({ autoSend: true, message: 'one' });\n\t\t\tassert.strictEqual(await p, undefined);\n\t\t\tassert.strictEqual(model.getValue(), 'one');\n\n\n\t\t\t// ROUND 2\n\n\t\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\t\tconst values = new Set<string>();\n\t\t\tstore.add(model.onDidChangeContent(() => values.add(model.getValue())));\n\t\t\tctrl.chatWidget.acceptInput('two'); // WILL Trigger a failure\n\t\t\tassert.strictEqual(await p2, undefined);\n\t\t\tassert.strictEqual(model.getValue(), 'one'); // undone\n\t\t\tassert.ok(values.has('twoone')); // we had but the change got undone\n\t\t});\n\t});\n\n\ttest('Inline chat \"discard\" button does not always appear if response is stopped #228030', async function () {\n\n\t\tmodel.setValue('World');\n\n\t\tconst deferred = new DeferredPromise<void>();\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello-Hello' }] }]);\n\t\t\t\tawait deferred.p;\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tctrl.run({ message: 'Hello', autoSend: true });\n\n\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tconst p2 = ctrl.awaitStates([State.WAIT_FOR_INPUT]);\n\t\tchatService.cancelCurrentRequestForSession(ctrl.chatWidget.viewModel!.model.sessionResource);\n\t\tassert.strictEqual(await p2, undefined);\n\n\n\t\tconst value = contextKeyService.getContextKeyValue(CTX_INLINE_CHAT_RESPONSE_TYPE.key);\n\t\tassert.notStrictEqual(value, InlineChatResponseType.None);\n\t});\n\n\ttest('Restore doesn\\'t edit on errored result', async function () {\n\t\treturn runWithFakedTimers({ useFakeTimers: true }, async () => {\n\n\t\t\tconst model2 = store.add(instaService.get(IModelService).createModel('ABC', null));\n\n\t\t\tmodel.setValue('World');\n\n\t\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\t\tid: 'testEditorAgent2',\n\t\t\t\t...agentData\n\t\t\t}, {\n\t\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello1' }] }]);\n\t\t\t\t\tawait timeout(100);\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello2' }] }]);\n\t\t\t\t\tawait timeout(100);\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello3' }] }]);\n\t\t\t\t\tawait timeout(100);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\terrorDetails: { message: 'FAILED' }\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t}));\n\n\t\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t\t// REQUEST 1\n\t\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\t\tctrl.run({ message: 'Hello', autoSend: true });\n\n\t\t\tassert.strictEqual(await p, undefined);\n\n\t\t\tconst p2 = ctrl.awaitStates([State.PAUSE]);\n\t\t\teditor.setModel(model2);\n\t\t\tassert.strictEqual(await p2, undefined);\n\n\t\t\tconst p3 = ctrl.awaitStates([...TestController.INIT_SEQUENCE]);\n\t\t\teditor.setModel(model);\n\t\t\tassert.strictEqual(await p3, undefined);\n\n\t\t\tassert.strictEqual(model.getValue(), 'World');\n\t\t});\n\t});\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { equals } from '../../../../../base/common/arrays.js';\nimport { DeferredPromise, raceCancellation, timeout } from '../../../../../base/common/async.js';\nimport { CancellationToken } from '../../../../../base/common/cancellation.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { constObservable, IObservable } from '../../../../../base/common/observable.js';\nimport { assertType } from '../../../../../base/common/types.js';\nimport { mock } from '../../../../../base/test/common/mock.js';\nimport { runWithFakedTimers } from '../../../../../base/test/common/timeTravelScheduler.js';\nimport { IActiveCodeEditor, ICodeEditor } from '../../../../../editor/browser/editorBrowser.js';\nimport { IDiffProviderFactoryService } from '../../../../../editor/browser/widget/diffEditor/diffProviderFactoryService.js';\nimport { EditOperation } from '../../../../../editor/common/core/editOperation.js';\nimport { Range } from '../../../../../editor/common/core/range.js';\nimport { EndOfLineSequence, ITextModel } from '../../../../../editor/common/model.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { IModelService } from '../../../../../editor/common/services/model.js';\nimport { ITextModelService } from '../../../../../editor/common/services/resolverService.js';\nimport { TestDiffProviderFactoryService } from '../../../../../editor/test/browser/diff/testDiffProviderFactoryService.js';\nimport { TestCommandService } from '../../../../../editor/test/browser/editorTestServices.js';\nimport { instantiateTestCodeEditor } from '../../../../../editor/test/browser/testCodeEditor.js';\nimport { IAccessibleViewService } from '../../../../../platform/accessibility/browser/accessibleView.js';\nimport { ICommandService } from '../../../../../platform/commands/common/commands.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { TestConfigurationService } from '../../../../../platform/configuration/test/common/testConfigurationService.js';\nimport { IContextKeyService } from '../../../../../platform/contextkey/common/contextkey.js';\nimport { IHoverService } from '../../../../../platform/hover/browser/hover.js';\nimport { NullHoverService } from '../../../../../platform/hover/test/browser/nullHoverService.js';\nimport { SyncDescriptor } from '../../../../../platform/instantiation/common/descriptors.js';\nimport { ServiceCollection } from '../../../../../platform/instantiation/common/serviceCollection.js';\nimport { TestInstantiationService } from '../../../../../platform/instantiation/test/common/instantiationServiceMock.js';\nimport { MockContextKeyService } from '../../../../../platform/keybinding/test/common/mockKeybindingService.js';\nimport { ILogService, NullLogService } from '../../../../../platform/log/common/log.js';\nimport { IEditorProgressService, IProgressRunner } from '../../../../../platform/progress/common/progress.js';\nimport { ITelemetryService } from '../../../../../platform/telemetry/common/telemetry.js';\nimport { NullTelemetryService } from '../../../../../platform/telemetry/common/telemetryUtils.js';\nimport { IWorkspaceContextService } from '../../../../../platform/workspace/common/workspace.js';\nimport { IView, IViewDescriptorService } from '../../../../common/views.js';\nimport { IWorkbenchAssignmentService } from '../../../../services/assignment/common/assignmentService.js';\nimport { NullWorkbenchAssignmentService } from '../../../../services/assignment/test/common/nullAssignmentService.js';\nimport { IExtensionService, nullExtensionDescription } from '../../../../services/extensions/common/extensions.js';\nimport { TextModelResolverService } from '../../../../services/textmodelResolver/common/textModelResolverService.js';\nimport { IViewsService } from '../../../../services/views/common/viewsService.js';\nimport { TestViewsService, workbenchInstantiationService } from '../../../../test/browser/workbenchTestServices.js';\nimport { TestChatEntitlementService, TestContextService, TestExtensionService } from '../../../../test/common/workbenchTestServices.js';\nimport { AccessibilityVerbositySettingId } from '../../../accessibility/browser/accessibilityConfiguration.js';\nimport { IChatAccessibilityService, IChatWidget, IChatWidgetService, IQuickChatService } from '../../../chat/browser/chat.js';\nimport { ChatInputBoxContentProvider } from '../../../chat/browser/chatEdinputInputContentProvider.js';\nimport { ChatLayoutService } from '../../../chat/browser/chatLayoutService.js';\nimport { ChatVariablesService } from '../../../chat/browser/chatVariables.js';\nimport { ChatWidget } from '../../../chat/browser/chatWidget.js';\nimport { ChatAgentService, IChatAgentData, IChatAgentNameService, IChatAgentService } from '../../../chat/common/chatAgents.js';\nimport { IChatEditingService, IChatEditingSession } from '../../../chat/common/chatEditingService.js';\nimport { IChatEntitlementService } from '../../../../services/chat/common/chatEntitlementService.js';\nimport { IChatLayoutService } from '../../../chat/common/chatLayoutService.js';\nimport { IChatModeService } from '../../../chat/common/chatModes.js';\nimport { IChatTodo, IChatTodoListService } from '../../../chat/common/chatTodoListService.js';\nimport { IChatProgress, IChatService } from '../../../chat/common/chatService.js';\nimport { ChatService } from '../../../chat/common/chatServiceImpl.js';\nimport { ChatSlashCommandService, IChatSlashCommandService } from '../../../chat/common/chatSlashCommands.js';\nimport { ChatTransferService, IChatTransferService } from '../../../chat/common/chatTransferService.js';\nimport { IChatVariablesService } from '../../../chat/common/chatVariables.js';\nimport { IChatResponseViewModel } from '../../../chat/common/chatViewModel.js';\nimport { ChatWidgetHistoryService, IChatWidgetHistoryService } from '../../../chat/common/chatWidgetHistoryService.js';\nimport { ChatAgentLocation, ChatModeKind } from '../../../chat/common/constants.js';\nimport { ILanguageModelsService, LanguageModelsService } from '../../../chat/common/languageModels.js';\nimport { ILanguageModelToolsService } from '../../../chat/common/languageModelToolsService.js';\nimport { PromptsType } from '../../../chat/common/promptSyntax/promptTypes.js';\nimport { IPromptPath, IPromptsService } from '../../../chat/common/promptSyntax/service/promptsService.js';\nimport { MockChatModeService } from '../../../chat/test/common/mockChatModeService.js';\nimport { MockLanguageModelToolsService } from '../../../chat/test/common/mockLanguageModelToolsService.js';\nimport { IMcpService } from '../../../mcp/common/mcpTypes.js';\nimport { TestMcpService } from '../../../mcp/test/common/testMcpService.js';\nimport { INotebookEditorService } from '../../../notebook/browser/services/notebookEditorService.js';\nimport { RerunAction } from '../../browser/inlineChatActions.js';\nimport { InlineChatController1, State } from '../../browser/inlineChatController.js';\nimport { IInlineChatSessionService } from '../../browser/inlineChatSessionService.js';\nimport { InlineChatSessionServiceImpl } from '../../browser/inlineChatSessionServiceImpl.js';\nimport { CTX_INLINE_CHAT_RESPONSE_TYPE, InlineChatConfigKeys, InlineChatResponseType } from '../../common/inlineChat.js';\nimport { TestWorkerService } from './testWorkerService.js';\nimport { URI } from '../../../../../base/common/uri.js';\nimport { ChatWidgetService } from '../../../chat/browser/chatWidgetService.js';\nimport { ChatContextService, IChatContextService } from '../../../chat/browser/chatContextService.js';\n\nsuite('InlineChatController', function () {\n\n\tconst agentData = {\n\t\textensionId: nullExtensionDescription.identifier,\n\t\textensionVersion: undefined,\n\t\tpublisherDisplayName: '',\n\t\textensionDisplayName: '',\n\t\textensionPublisherId: '',\n\t\t// id: 'testEditorAgent',\n\t\tname: 'testEditorAgent',\n\t\tisDefault: true,\n\t\tlocations: [ChatAgentLocation.EditorInline],\n\t\tmodes: [ChatModeKind.Ask],\n\t\tmetadata: {},\n\t\tslashCommands: [],\n\t\tdisambiguation: [],\n\t};\n\n\tclass TestController extends InlineChatController1 {\n\n\t\tstatic INIT_SEQUENCE: readonly State[] = [State.CREATE_SESSION, State.INIT_UI, State.WAIT_FOR_INPUT];\n\t\tstatic INIT_SEQUENCE_AUTO_SEND: readonly State[] = [...this.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT];\n\n\n\t\treadonly onDidChangeState: Event<State> = this._onDidEnterState.event;\n\n\t\treadonly states: readonly State[] = [];\n\n\t\tawaitStates(states: readonly State[]): Promise<string | undefined> {\n\t\t\tconst actual: State[] = [];\n\n\t\t\treturn new Promise<string | undefined>((resolve, reject) => {\n\t\t\t\tconst d = this.onDidChangeState(state => {\n\t\t\t\t\tactual.push(state);\n\t\t\t\t\tif (equals(states, actual)) {\n\t\t\t\t\t\td.dispose();\n\t\t\t\t\t\tresolve(undefined);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\td.dispose();\n\t\t\t\t\tresolve(`[${states.join(',')}] <> [${actual.join(',')}]`);\n\t\t\t\t}, 1000);\n\t\t\t});\n\t\t}\n\t}\n\n\tconst store = new DisposableStore();\n\tlet configurationService: TestConfigurationService;\n\tlet editor: IActiveCodeEditor;\n\tlet model: ITextModel;\n\tlet ctrl: TestController;\n\tlet contextKeyService: MockContextKeyService;\n\tlet chatService: IChatService;\n\tlet chatAgentService: IChatAgentService;\n\tlet inlineChatSessionService: IInlineChatSessionService;\n\tlet instaService: TestInstantiationService;\n\n\tlet chatWidget: IChatWidget;\n\n\tsetup(function () {\n\n\t\tconst serviceCollection = new ServiceCollection(\n\t\t\t[IConfigurationService, new TestConfigurationService()],\n\t\t\t[IChatVariablesService, new SyncDescriptor(ChatVariablesService)],\n\t\t\t[ILogService, new NullLogService()],\n\t\t\t[ITelemetryService, NullTelemetryService],\n\t\t\t[IHoverService, NullHoverService],\n\t\t\t[IExtensionService, new TestExtensionService()],\n\t\t\t[IContextKeyService, new MockContextKeyService()],\n\t\t\t[IViewsService, new class extends TestViewsService {\n\t\t\t\toverride async openView<T extends IView>(id: string, focus?: boolean | undefined): Promise<T | null> {\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\treturn { widget: chatWidget ?? null } as any;\n\t\t\t\t}\n\t\t\t}()],\n\t\t\t[IWorkspaceContextService, new TestContextService()],\n\t\t\t[IChatWidgetHistoryService, new SyncDescriptor(ChatWidgetHistoryService)],\n\t\t\t[IChatWidgetService, new SyncDescriptor(ChatWidgetService)],\n\t\t\t[IChatSlashCommandService, new SyncDescriptor(ChatSlashCommandService)],\n\t\t\t[IChatTransferService, new SyncDescriptor(ChatTransferService)],\n\t\t\t[IChatService, new SyncDescriptor(ChatService)],\n\t\t\t[IMcpService, new TestMcpService()],\n\t\t\t[IChatAgentNameService, new class extends mock<IChatAgentNameService>() {\n\t\t\t\toverride getAgentNameRestriction(chatAgentData: IChatAgentData): boolean {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IEditorWorkerService, new SyncDescriptor(TestWorkerService)],\n\t\t\t[IContextKeyService, contextKeyService],\n\t\t\t[IChatAgentService, new SyncDescriptor(ChatAgentService)],\n\t\t\t[IDiffProviderFactoryService, new SyncDescriptor(TestDiffProviderFactoryService)],\n\t\t\t[IInlineChatSessionService, new SyncDescriptor(InlineChatSessionServiceImpl)],\n\t\t\t[ICommandService, new SyncDescriptor(TestCommandService)],\n\t\t\t[IChatEditingService, new class extends mock<IChatEditingService>() {\n\t\t\t\toverride editingSessionsObs: IObservable<readonly IChatEditingSession[]> = constObservable([]);\n\t\t\t}],\n\t\t\t[IEditorProgressService, new class extends mock<IEditorProgressService>() {\n\t\t\t\toverride show(total: unknown, delay?: unknown): IProgressRunner {\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttotal() { },\n\t\t\t\t\t\tworked(value) { },\n\t\t\t\t\t\tdone() { },\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IChatAccessibilityService, new class extends mock<IChatAccessibilityService>() {\n\t\t\t\toverride acceptResponse(widget: ChatWidget, container: HTMLElement, response: IChatResponseViewModel | undefined, requestId: number): void { }\n\t\t\t\toverride acceptRequest(): number { return -1; }\n\t\t\t\toverride acceptElicitation(): void { }\n\t\t\t}],\n\t\t\t[IAccessibleViewService, new class extends mock<IAccessibleViewService>() {\n\t\t\t\toverride getOpenAriaHint(verbositySettingKey: AccessibilityVerbositySettingId): string | null {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IConfigurationService, configurationService],\n\t\t\t[IViewDescriptorService, new class extends mock<IViewDescriptorService>() {\n\t\t\t\toverride onDidChangeLocation = Event.None;\n\t\t\t}],\n\t\t\t[INotebookEditorService, new class extends mock<INotebookEditorService>() {\n\t\t\t\toverride listNotebookEditors() { return []; }\n\t\t\t\toverride getNotebookForPossibleCell(editor: ICodeEditor) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IWorkbenchAssignmentService, new NullWorkbenchAssignmentService()],\n\t\t\t[ILanguageModelsService, new SyncDescriptor(LanguageModelsService)],\n\t\t\t[ITextModelService, new SyncDescriptor(TextModelResolverService)],\n\t\t\t[ILanguageModelToolsService, new SyncDescriptor(MockLanguageModelToolsService)],\n\t\t\t[IPromptsService, new class extends mock<IPromptsService>() {\n\t\t\t\toverride async listPromptFiles(type: PromptsType, token: CancellationToken): Promise<readonly IPromptPath[]> {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\t\t\t}],\n\t\t\t[IChatEntitlementService, new class extends mock<IChatEntitlementService>() { }],\n\t\t\t[IChatModeService, new SyncDescriptor(MockChatModeService)],\n\t\t\t[IChatLayoutService, new SyncDescriptor(ChatLayoutService)],\n\t\t\t[IQuickChatService, new class extends mock<IQuickChatService>() { }],\n\t\t\t[IChatTodoListService, new class extends mock<IChatTodoListService>() {\n\t\t\t\toverride onDidUpdateTodos = Event.None;\n\t\t\t\toverride getTodos(sessionResource: URI): IChatTodo[] { return []; }\n\t\t\t\toverride setTodos(sessionResource: URI, todos: IChatTodo[]): void { }\n\t\t\t}],\n\t\t\t[IChatEntitlementService, new SyncDescriptor(TestChatEntitlementService)],\n\t\t);\n\n\t\tinstaService = store.add((store.add(workbenchInstantiationService(undefined, store))).createChild(serviceCollection));\n\n\t\tconfigurationService = instaService.get(IConfigurationService) as TestConfigurationService;\n\t\tconfigurationService.setUserConfiguration('chat', { editor: { fontSize: 14, fontFamily: 'default' } });\n\n\t\tconfigurationService.setUserConfiguration('editor', {});\n\n\t\tcontextKeyService = instaService.get(IContextKeyService) as MockContextKeyService;\n\t\tchatService = instaService.get(IChatService);\n\t\tchatAgentService = instaService.get(IChatAgentService);\n\n\t\tinlineChatSessionService = store.add(instaService.get(IInlineChatSessionService));\n\n\t\tstore.add(instaService.get(ILanguageModelsService) as LanguageModelsService);\n\t\tstore.add(instaService.get(IEditorWorkerService) as TestWorkerService);\n\n\t\tstore.add(instaService.createInstance(ChatInputBoxContentProvider));\n\n\t\tmodel = store.add(instaService.get(IModelService).createModel('Hello\\nWorld\\nHello Again\\nHello World\\n', null));\n\t\tmodel.setEOL(EndOfLineSequence.LF);\n\t\teditor = store.add(instantiateTestCodeEditor(instaService, model));\n\n\t\tinstaService.set(IChatContextService, store.add(instaService.createInstance(ChatContextService)));\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({ id: 'testEditorAgent', ...agentData, }, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{\n\t\t\t\t\tkind: 'textEdit',\n\t\t\t\t\turi: model.uri,\n\t\t\t\t\tedits: [{\n\t\t\t\t\t\trange: new Range(1, 1, 1, 1),\n\t\t\t\t\t\ttext: request.message\n\t\t\t\t\t}]\n\t\t\t\t}]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t});\n\n\tteardown(function () {\n\t\tstore.clear();\n\t\tctrl?.dispose();\n\t});\n\n\t// TODO@jrieken re-enable, looks like List/ChatWidget is leaking\n\t// ensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('creation, not showing anything', function () {\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tassert.ok(ctrl);\n\t\tassert.strictEqual(ctrl.getWidgetPosition(), undefined);\n\t});\n\n\ttest('run (show/hide)', async function () {\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst actualStates = ctrl.awaitStates(TestController.INIT_SEQUENCE_AUTO_SEND);\n\t\tconst run = ctrl.run({ message: 'Hello', autoSend: true });\n\t\tassert.strictEqual(await actualStates, undefined);\n\t\tassert.ok(ctrl.getWidgetPosition() !== undefined);\n\t\tawait ctrl.cancelSession();\n\n\t\tawait run;\n\n\t\tassert.ok(ctrl.getWidgetPosition() === undefined);\n\t});\n\n\ttest('wholeRange does not expand to whole lines, editor selection default', async function () {\n\n\t\teditor.setSelection(new Range(1, 1, 1, 3));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\tctrl.run({});\n\t\tawait Event.toPromise(Event.filter(ctrl.onDidChangeState, e => e === State.WAIT_FOR_INPUT));\n\n\t\tconst session = inlineChatSessionService.getSession(editor, editor.getModel()!.uri);\n\t\tassert.ok(session);\n\t\tassert.deepStrictEqual(session.wholeRange.value, new Range(1, 1, 1, 3));\n\n\t\tawait ctrl.cancelSession();\n\t});\n\n\ttest('typing outside of wholeRange finishes session', async function () {\n\n\t\tconfigurationService.setUserConfiguration(InlineChatConfigKeys.FinishOnType, true);\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst actualStates = ctrl.awaitStates(TestController.INIT_SEQUENCE_AUTO_SEND);\n\t\tconst r = ctrl.run({ message: 'Hello', autoSend: true });\n\n\t\tassert.strictEqual(await actualStates, undefined);\n\n\t\tconst session = inlineChatSessionService.getSession(editor, editor.getModel()!.uri);\n\t\tassert.ok(session);\n\t\tassert.deepStrictEqual(session.wholeRange.value, new Range(1, 1, 1, 11 /* line length */));\n\n\t\teditor.setSelection(new Range(2, 1, 2, 1));\n\t\teditor.trigger('test', 'type', { text: 'a' });\n\n\t\tassert.strictEqual(await ctrl.awaitStates([State.ACCEPT]), undefined);\n\t\tawait r;\n\t});\n\n\ttest('\\'whole range\\' isn\\'t updated for edits outside whole range #4346', async function () {\n\n\t\teditor.setSelection(new Range(3, 1, 3, 3));\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{\n\t\t\t\t\tkind: 'textEdit',\n\t\t\t\t\turi: editor.getModel().uri,\n\t\t\t\t\tedits: [{\n\t\t\t\t\t\trange: new Range(1, 1, 1, 1), // EDIT happens outside of whole range\n\t\t\t\t\t\ttext: `${request.message}\\n${request.message}`\n\t\t\t\t\t}]\n\t\t\t\t}]);\n\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates(TestController.INIT_SEQUENCE);\n\t\tconst r = ctrl.run({ message: 'GENGEN', autoSend: false });\n\n\t\tassert.strictEqual(await p, undefined);\n\n\n\t\tconst session = inlineChatSessionService.getSession(editor, editor.getModel()!.uri);\n\t\tassert.ok(session);\n\t\tassert.deepStrictEqual(session.wholeRange.value, new Range(3, 1, 3, 3)); // initial\n\n\t\tctrl.chatWidget.setInput('GENGEN');\n\t\tctrl.chatWidget.acceptInput();\n\t\tassert.strictEqual(await ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]), undefined);\n\n\t\tassert.deepStrictEqual(session.wholeRange.value, new Range(1, 1, 4, 3));\n\n\t\tawait ctrl.cancelSession();\n\t\tawait r;\n\t});\n\n\ttest('Stuck inline chat widget #211', async function () {\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\treturn new Promise<never>(() => { });\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tconst r = ctrl.run({ message: 'Hello', autoSend: true });\n\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tctrl.acceptSession();\n\n\t\tawait r;\n\t\tassert.strictEqual(ctrl.getWidgetPosition(), undefined);\n\t});\n\n\ttest('[Bug] Inline Chat\\'s streaming pushed broken iterations to the undo stack #2403', async function () {\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'hEllo1\\n' }] }]);\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(2, 1, 2, 1), text: 'hEllo2\\n' }] }]);\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1000, 1), text: 'Hello1\\nHello2\\n' }] }]);\n\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tconst valueThen = editor.getModel().getValue();\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: 'Hello', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\t\tctrl.acceptSession();\n\t\tawait r;\n\n\t\tassert.strictEqual(editor.getModel().getValue(), 'Hello1\\nHello2\\n');\n\n\t\teditor.getModel().undo();\n\t\tassert.strictEqual(editor.getModel().getValue(), valueThen);\n\t});\n\n\n\n\ttest.skip('UI is streaming edits minutes after the response is finished #3345', async function () {\n\n\n\t\treturn runWithFakedTimers({ maxTaskCount: Number.MAX_SAFE_INTEGER }, async () => {\n\n\t\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\t\tid: 'testEditorAgent2',\n\t\t\t\t...agentData\n\t\t\t}, {\n\t\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\t\tconst text = '${CSI}#a\\n${CSI}#b\\n${CSI}#c\\n';\n\n\t\t\t\t\tawait timeout(10);\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text }] }]);\n\n\t\t\t\t\tawait timeout(10);\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text.repeat(1000) + 'DONE' }] }]);\n\n\t\t\t\t\tthrow new Error('Too long');\n\t\t\t\t},\n\t\t\t}));\n\n\n\t\t\t// let modelChangeCounter = 0;\n\t\t\t// store.add(editor.getModel().onDidChangeContent(() => { modelChangeCounter++; }));\n\n\t\t\tctrl = instaService.createInstance(TestController, editor);\n\t\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\t\tconst r = ctrl.run({ message: 'Hello', autoSend: true });\n\t\t\tassert.strictEqual(await p, undefined);\n\n\t\t\t// assert.ok(modelChangeCounter > 0, modelChangeCounter.toString()); // some changes have been made\n\t\t\t// const modelChangeCounterNow = modelChangeCounter;\n\n\t\t\tassert.ok(!editor.getModel().getValue().includes('DONE'));\n\t\t\tawait timeout(10);\n\n\t\t\t// assert.strictEqual(modelChangeCounterNow, modelChangeCounter);\n\t\t\tassert.ok(!editor.getModel().getValue().includes('DONE'));\n\n\t\t\tawait ctrl.cancelSession();\n\t\t\tawait r;\n\t\t});\n\t});\n\n\ttest('escape doesn\\'t remove code added from inline editor chat #3523 1/2', async function () {\n\n\n\t\t// NO manual edits -> cancel\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: 'GENERATED', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.ok(model.getValue().includes('GENERATED'));\n\t\tctrl.cancelSession();\n\t\tawait r;\n\t\tassert.ok(!model.getValue().includes('GENERATED'));\n\n\t});\n\n\ttest('escape doesn\\'t remove code added from inline editor chat #3523, 2/2', async function () {\n\n\t\t// manual edits -> finish\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: 'GENERATED', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.ok(model.getValue().includes('GENERATED'));\n\n\t\teditor.executeEdits('test', [EditOperation.insert(model.getFullModelRange().getEndPosition(), 'MANUAL')]);\n\n\t\tctrl.acceptSession();\n\t\tawait r;\n\t\tassert.ok(model.getValue().includes('GENERATED'));\n\t\tassert.ok(model.getValue().includes('MANUAL'));\n\n\t});\n\n\ttest('cancel while applying streamed edits should close the widget', async function () {\n\n\t\tconst workerService = instaService.get(IEditorWorkerService) as TestWorkerService;\n\t\tconst originalCompute = workerService.computeMoreMinimalEdits.bind(workerService);\n\t\tconst editsBarrier = new DeferredPromise<void>();\n\t\tlet computeInvoked = false;\n\t\tworkerService.computeMoreMinimalEdits = async (resource, edits, pretty) => {\n\t\t\tcomputeInvoked = true;\n\t\t\tawait editsBarrier.p;\n\t\t\treturn originalCompute(resource, edits, pretty);\n\t\t};\n\t\tstore.add({ dispose: () => { workerService.computeMoreMinimalEdits = originalCompute; } });\n\n\t\tconst progressBarrier = new DeferredPromise<void>();\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'pendingEditsAgent',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: request.message }] }]);\n\t\t\t\tawait progressBarrier.p;\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst states = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tconst run = ctrl.run({ message: 'BLOCK', autoSend: true });\n\t\tassert.strictEqual(await states, undefined);\n\t\tassert.ok(computeInvoked);\n\n\t\tctrl.cancelSession();\n\t\tassert.strictEqual(await states, undefined);\n\n\t\tawait run;\n\t});\n\n\ttest('re-run should discard pending edits', async function () {\n\n\t\tlet count = 1;\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: request.message + (count++) }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst rerun = new RerunAction();\n\n\t\tmodel.setValue('');\n\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: 'PROMPT_', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\n\t\tassert.strictEqual(model.getValue(), 'PROMPT_1');\n\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tawait instaService.invokeFunction(rerun.runInlineChatCommand, ctrl, editor);\n\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'PROMPT_2');\n\t\tctrl.acceptSession();\n\t\tawait r;\n\t});\n\n\ttest('Retry undoes all changes, not just those from the request#5736', async function () {\n\n\t\tconst text = [\n\t\t\t'eins-',\n\t\t\t'zwei-',\n\t\t\t'drei-'\n\t\t];\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text.shift() ?? '' }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst rerun = new RerunAction();\n\n\t\tmodel.setValue('');\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst r = ctrl.run({ message: '1', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'eins-');\n\n\t\t// REQUEST 2\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.chatWidget.setInput('1');\n\t\tawait ctrl.chatWidget.acceptInput();\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'zwei-eins-');\n\n\t\t// REQUEST 2 - RERUN\n\t\tconst p3 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tawait instaService.invokeFunction(rerun.runInlineChatCommand, ctrl, editor);\n\t\tassert.strictEqual(await p3, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'drei-eins-');\n\n\t\tctrl.acceptSession();\n\t\tawait r;\n\n\t});\n\n\ttest('moving inline chat to another model undoes changes', async function () {\n\t\tconst text = [\n\t\t\t'eins\\n',\n\t\t\t'zwei\\n'\n\t\t];\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text.shift() ?? '' }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.run({ message: '1', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'eins\\nHello\\nWorld\\nHello Again\\nHello World\\n');\n\n\t\tconst targetModel = chatService.startSession(ChatAgentLocation.EditorInline, CancellationToken.None)!;\n\t\tstore.add(targetModel);\n\t\tchatWidget = new class extends mock<IChatWidget>() {\n\t\t\toverride get viewModel() {\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\treturn { model: targetModel } as any;\n\t\t\t}\n\t\t\toverride focusResponseItem() { }\n\t\t};\n\n\t\tconst r = ctrl.joinCurrentRun();\n\t\tawait ctrl.viewInChat();\n\n\t\tassert.strictEqual(model.getValue(), 'Hello\\nWorld\\nHello Again\\nHello World\\n');\n\t\tawait r;\n\t});\n\n\ttest('moving inline chat to another model undoes changes (2 requests)', async function () {\n\t\tconst text = [\n\t\t\t'eins\\n',\n\t\t\t'zwei\\n'\n\t\t];\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: text.shift() ?? '' }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.run({ message: '1', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'eins\\nHello\\nWorld\\nHello Again\\nHello World\\n');\n\n\t\t// REQUEST 2\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.chatWidget.setInput('1');\n\t\tawait ctrl.chatWidget.acceptInput();\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'zwei\\neins\\nHello\\nWorld\\nHello Again\\nHello World\\n');\n\n\t\tconst targetModel = chatService.startSession(ChatAgentLocation.EditorInline, CancellationToken.None)!;\n\t\tstore.add(targetModel);\n\t\tchatWidget = new class extends mock<IChatWidget>() {\n\t\t\toverride get viewModel() {\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\treturn { model: targetModel } as any;\n\t\t\t}\n\t\t\toverride focusResponseItem() { }\n\t\t};\n\n\t\tconst r = ctrl.joinCurrentRun();\n\n\t\tawait ctrl.viewInChat();\n\n\t\tassert.strictEqual(model.getValue(), 'Hello\\nWorld\\nHello Again\\nHello World\\n');\n\n\t\tawait r;\n\t});\n\n\t// TODO@jrieken https://github.com/microsoft/vscode/issues/251429\n\ttest.skip('Clicking \"re-run without /doc\" while a request is in progress closes the widget #5997', async function () {\n\n\t\tmodel.setValue('');\n\n\t\tlet count = 0;\n\t\tconst commandDetection: (boolean | undefined)[] = [];\n\n\t\tconst onDidInvoke = new Emitter<void>();\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tqueueMicrotask(() => onDidInvoke.fire());\n\t\t\t\tcommandDetection.push(request.enableCommandDetection);\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: request.message + (count++) }] }]);\n\n\t\t\t\tif (count === 1) {\n\t\t\t\t\t// FIRST call waits for cancellation\n\t\t\t\t\tawait raceCancellation(new Promise<never>(() => { }), token);\n\t\t\t\t} else {\n\t\t\t\t\tawait timeout(10);\n\t\t\t\t}\n\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\t// const p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tconst p = Event.toPromise(onDidInvoke.event);\n\t\tctrl.run({ message: 'Hello-', autoSend: true });\n\n\t\tawait p;\n\n\t\t// assert.strictEqual(await p, undefined);\n\n\t\t// resend pending request without command detection\n\t\tconst request = ctrl.chatWidget.viewModel?.model.getRequests().at(-1);\n\t\tassertType(request);\n\t\tconst p2 = Event.toPromise(onDidInvoke.event);\n\t\tconst p3 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tchatService.resendRequest(request, { noCommandDetection: true, attempt: request.attempt + 1, location: ChatAgentLocation.EditorInline });\n\n\t\tawait p2;\n\t\tassert.strictEqual(await p3, undefined);\n\n\t\tassert.deepStrictEqual(commandDetection, [true, false]);\n\t\tassert.strictEqual(model.getValue(), 'Hello-1');\n\t});\n\n\ttest('Re-run without after request is done', async function () {\n\n\t\tmodel.setValue('');\n\n\t\tlet count = 0;\n\t\tconst commandDetection: (boolean | undefined)[] = [];\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\t\t\t\tcommandDetection.push(request.enableCommandDetection);\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: request.message + (count++) }] }]);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tctrl.run({ message: 'Hello-', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\n\t\t// resend pending request without command detection\n\t\tconst request = ctrl.chatWidget.viewModel?.model.getRequests().at(-1);\n\t\tassertType(request);\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tchatService.resendRequest(request, { noCommandDetection: true, attempt: request.attempt + 1, location: ChatAgentLocation.EditorInline });\n\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.deepStrictEqual(commandDetection, [true, false]);\n\t\tassert.strictEqual(model.getValue(), 'Hello-1');\n\t});\n\n\n\ttest('Inline: Pressing Rerun request while the response streams breaks the response #5442', async function () {\n\n\t\tmodel.setValue('two\\none\\n');\n\n\t\tconst attempts: (number | undefined)[] = [];\n\n\t\tconst deferred = new DeferredPromise<void>();\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\tattempts.push(request.attempt);\n\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: `TRY:${request.attempt}\\n` }] }]);\n\t\t\t\tawait raceCancellation(deferred.p, token);\n\t\t\t\tdeferred.complete();\n\t\t\t\tawait timeout(10);\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tctrl.run({ message: 'Hello-', autoSend: true });\n\t\tassert.strictEqual(await p, undefined);\n\t\tawait timeout(10);\n\t\tassert.deepStrictEqual(attempts, [0]);\n\n\t\t// RERUN (cancel, undo, redo)\n\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\tconst rerun = new RerunAction();\n\t\tawait instaService.invokeFunction(rerun.runInlineChatCommand, ctrl, editor);\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.deepStrictEqual(attempts, [0, 1]);\n\n\t\tassert.strictEqual(model.getValue(), 'TRY:1\\ntwo\\none\\n');\n\n\t});\n\n\ttest('Stopping/cancelling a request should NOT undo its changes', async function () {\n\n\t\tmodel.setValue('World');\n\n\t\tconst deferred = new DeferredPromise<void>();\n\t\tlet progress: ((parts: IChatProgress[]) => void) | undefined;\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, _progress, history, token) {\n\n\t\t\t\tprogress = _progress;\n\t\t\t\tawait deferred.p;\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tctrl.run({ message: 'Hello', autoSend: true });\n\t\tawait timeout(10);\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassertType(progress);\n\n\t\tconst modelChange = new Promise<void>(resolve => model.onDidChangeContent(() => resolve()));\n\n\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello-Hello' }] }]);\n\n\t\tawait modelChange;\n\t\tassert.strictEqual(model.getValue(), 'HelloWorld'); // first word has been streamed\n\n\t\tconst p2 = ctrl.awaitStates([State.WAIT_FOR_INPUT]);\n\t\tchatService.cancelCurrentRequestForSession(ctrl.chatWidget.viewModel!.model.sessionResource);\n\t\tassert.strictEqual(await p2, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'HelloWorld'); // CANCEL just stops the request and progressive typing but doesn't undo\n\n\t});\n\n\ttest('Apply Edits from existing session w/ edits', async function () {\n\n\t\tmodel.setValue('');\n\n\t\tconst newSession = await inlineChatSessionService.createSession(editor, {}, CancellationToken.None);\n\t\tassertType(newSession);\n\n\t\tawait (await chatService.sendRequest(newSession.chatModel.sessionResource, 'Existing', { location: ChatAgentLocation.EditorInline }))?.responseCreatedPromise;\n\n\t\tassert.strictEqual(newSession.chatModel.requestInProgress.get(), true);\n\n\t\tconst response = newSession.chatModel.lastRequest?.response;\n\t\tassertType(response);\n\n\t\tawait new Promise(resolve => {\n\t\t\tif (response.isComplete) {\n\t\t\t\tresolve(undefined);\n\t\t\t}\n\t\t\tconst d = response.onDidChange(() => {\n\t\t\t\tif (response.isComplete) {\n\t\t\t\t\td.dispose();\n\t\t\t\t\tresolve(undefined);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE]);\n\t\tctrl.run({ existingSession: newSession });\n\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tassert.strictEqual(model.getValue(), 'Existing');\n\n\t});\n\n\ttest('Undo on error (2 rounds)', async function () {\n\n\t\treturn runWithFakedTimers({}, async () => {\n\n\n\t\t\tstore.add(chatAgentService.registerDynamicAgent({ id: 'testEditorAgent', ...agentData, }, {\n\t\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\t\tprogress([{\n\t\t\t\t\t\tkind: 'textEdit',\n\t\t\t\t\t\turi: model.uri,\n\t\t\t\t\t\tedits: [{\n\t\t\t\t\t\t\trange: new Range(1, 1, 1, 1),\n\t\t\t\t\t\t\ttext: request.message\n\t\t\t\t\t\t}]\n\t\t\t\t\t}]);\n\n\t\t\t\t\tif (request.message === 'two') {\n\t\t\t\t\t\tawait timeout(100); // give edit a chance\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\terrorDetails: { message: 'FAILED' }\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\treturn {};\n\t\t\t\t},\n\t\t\t}));\n\n\t\t\tmodel.setValue('');\n\n\t\t\t// ROUND 1\n\n\t\t\tctrl = instaService.createInstance(TestController, editor);\n\t\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\t\tctrl.run({ autoSend: true, message: 'one' });\n\t\t\tassert.strictEqual(await p, undefined);\n\t\t\tassert.strictEqual(model.getValue(), 'one');\n\n\n\t\t\t// ROUND 2\n\n\t\t\tconst p2 = ctrl.awaitStates([State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\t\tconst values = new Set<string>();\n\t\t\tstore.add(model.onDidChangeContent(() => values.add(model.getValue())));\n\t\t\tctrl.chatWidget.acceptInput('two'); // WILL Trigger a failure\n\t\t\tassert.strictEqual(await p2, undefined);\n\t\t\tassert.strictEqual(model.getValue(), 'one'); // undone\n\t\t\tassert.ok(values.has('twoone')); // we had but the change got undone\n\t\t});\n\t});\n\n\ttest('Inline chat \"discard\" button does not always appear if response is stopped #228030', async function () {\n\n\t\tmodel.setValue('World');\n\n\t\tconst deferred = new DeferredPromise<void>();\n\n\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\tid: 'testEditorAgent2',\n\t\t\t...agentData\n\t\t}, {\n\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello-Hello' }] }]);\n\t\t\t\tawait deferred.p;\n\t\t\t\treturn {};\n\t\t\t},\n\t\t}));\n\n\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t// REQUEST 1\n\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST]);\n\t\tctrl.run({ message: 'Hello', autoSend: true });\n\n\n\t\tassert.strictEqual(await p, undefined);\n\n\t\tconst p2 = ctrl.awaitStates([State.WAIT_FOR_INPUT]);\n\t\tchatService.cancelCurrentRequestForSession(ctrl.chatWidget.viewModel!.model.sessionResource);\n\t\tassert.strictEqual(await p2, undefined);\n\n\n\t\tconst value = contextKeyService.getContextKeyValue(CTX_INLINE_CHAT_RESPONSE_TYPE.key);\n\t\tassert.notStrictEqual(value, InlineChatResponseType.None);\n\t});\n\n\ttest('Restore doesn\\'t edit on errored result', async function () {\n\t\treturn runWithFakedTimers({ useFakeTimers: true }, async () => {\n\n\t\t\tconst model2 = store.add(instaService.get(IModelService).createModel('ABC', null));\n\n\t\t\tmodel.setValue('World');\n\n\t\t\tstore.add(chatAgentService.registerDynamicAgent({\n\t\t\t\tid: 'testEditorAgent2',\n\t\t\t\t...agentData\n\t\t\t}, {\n\t\t\t\tasync invoke(request, progress, history, token) {\n\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello1' }] }]);\n\t\t\t\t\tawait timeout(100);\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello2' }] }]);\n\t\t\t\t\tawait timeout(100);\n\t\t\t\t\tprogress([{ kind: 'textEdit', uri: model.uri, edits: [{ range: new Range(1, 1, 1, 1), text: 'Hello3' }] }]);\n\t\t\t\t\tawait timeout(100);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\terrorDetails: { message: 'FAILED' }\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t}));\n\n\t\t\tctrl = instaService.createInstance(TestController, editor);\n\n\t\t\t// REQUEST 1\n\t\t\tconst p = ctrl.awaitStates([...TestController.INIT_SEQUENCE, State.SHOW_REQUEST, State.WAIT_FOR_INPUT]);\n\t\t\tctrl.run({ message: 'Hello', autoSend: true });\n\n\t\t\tassert.strictEqual(await p, undefined);\n\n\t\t\tconst p2 = ctrl.awaitStates([State.PAUSE]);\n\t\t\teditor.setModel(model2);\n\t\t\tassert.strictEqual(await p2, undefined);\n\n\t\t\tconst p3 = ctrl.awaitStates([...TestController.INIT_SEQUENCE]);\n\t\t\teditor.setModel(model);\n\t\t\tassert.strictEqual(await p3, undefined);\n\n\t\t\tassert.strictEqual(model.getValue(), 'World');\n\t\t});\n\t});\n});\n"]}