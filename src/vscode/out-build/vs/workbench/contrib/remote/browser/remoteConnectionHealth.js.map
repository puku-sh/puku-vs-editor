{"version":3,"sources":["vs/workbench/contrib/remote/browser/remoteConnectionHealth.ts"],"names":[],"mappings":"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","file":"remoteConnectionHealth.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { IRemoteAgentService, remoteConnectionLatencyMeasurer } from '../../../services/remote/common/remoteAgentService.js';\nimport { IWorkbenchEnvironmentService } from '../../../services/environment/common/environmentService.js';\nimport { localize } from '../../../../nls.js';\nimport { isWeb } from '../../../../base/common/platform.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { getRemoteName } from '../../../../platform/remote/common/remoteHosts.js';\nimport { IBannerService } from '../../../services/banner/browser/bannerService.js';\nimport { IOpenerService } from '../../../../platform/opener/common/opener.js';\nimport { IHostService } from '../../../services/host/browser/host.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { IDialogService } from '../../../../platform/dialogs/common/dialogs.js';\nimport { Codicon } from '../../../../base/common/codicons.js';\nimport Severity from '../../../../base/common/severity.js';\n\n\nconst REMOTE_UNSUPPORTED_CONNECTION_CHOICE_KEY = 'remote.unsupportedConnectionChoice';\nconst BANNER_REMOTE_UNSUPPORTED_CONNECTION_DISMISSED_KEY = 'workbench.banner.remote.unsupportedConnection.dismissed';\n\nexport class InitialRemoteConnectionHealthContribution implements IWorkbenchContribution {\n\n\tconstructor(\n\t\t@IRemoteAgentService private readonly _remoteAgentService: IRemoteAgentService,\n\t\t@IWorkbenchEnvironmentService private readonly _environmentService: IWorkbenchEnvironmentService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@IBannerService private readonly bannerService: IBannerService,\n\t\t@IDialogService private readonly dialogService: IDialogService,\n\t\t@IOpenerService private readonly openerService: IOpenerService,\n\t\t@IHostService private readonly hostService: IHostService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@IProductService private readonly productService: IProductService,\n\t) {\n\t\tif (this._environmentService.remoteAuthority) {\n\t\t\tthis._checkInitialRemoteConnectionHealth();\n\t\t}\n\t}\n\n\tprivate async _confirmConnection(): Promise<boolean> {\n\t\tconst enum ConnectionChoice {\n\t\t\tAllow = 1,\n\t\t\tLearnMore = 2,\n\t\t\tCancel = 0\n\t\t}\n\n\t\tconst { result, checkboxChecked } = await this.dialogService.prompt<ConnectionChoice>({\n\t\t\ttype: Severity.Warning,\n\t\t\tmessage: localize('unsupportedGlibcWarning', \"You are about to connect to an OS version that is unsupported by {0}.\", this.productService.nameLong),\n\t\t\tbuttons: [\n\t\t\t\t{\n\t\t\t\t\tlabel: localize({ key: 'allow', comment: ['&& denotes a mnemonic'] }, \"&&Allow\"),\n\t\t\t\t\trun: () => ConnectionChoice.Allow\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tlabel: localize({ key: 'learnMore', comment: ['&& denotes a mnemonic'] }, \"&&Learn More\"),\n\t\t\t\t\trun: async () => { await this.openerService.open('https://aka.ms/vscode-remote/faq/old-linux'); return ConnectionChoice.LearnMore; }\n\t\t\t\t}\n\t\t\t],\n\t\t\tcancelButton: {\n\t\t\t\trun: () => ConnectionChoice.Cancel\n\t\t\t},\n\t\t\tcheckbox: {\n\t\t\t\tlabel: localize('remember', \"Do not show again\"),\n\t\t\t}\n\t\t});\n\n\t\tif (result === ConnectionChoice.LearnMore) {\n\t\t\treturn await this._confirmConnection();\n\t\t}\n\n\t\tconst allowed = result === ConnectionChoice.Allow;\n\t\tif (allowed && checkboxChecked) {\n\t\t\tthis.storageService.store(`${REMOTE_UNSUPPORTED_CONNECTION_CHOICE_KEY}.${this._environmentService.remoteAuthority}`, allowed, StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\t}\n\n\t\treturn allowed;\n\t}\n\n\tprivate async _checkInitialRemoteConnectionHealth(): Promise<void> {\n\t\ttry {\n\t\t\tconst environment = await this._remoteAgentService.getRawEnvironment();\n\n\t\t\tif (environment && environment.isUnsupportedGlibc) {\n\t\t\t\tlet allowed = this.storageService.getBoolean(`${REMOTE_UNSUPPORTED_CONNECTION_CHOICE_KEY}.${this._environmentService.remoteAuthority}`, StorageScope.PROFILE);\n\t\t\t\tif (allowed === undefined) {\n\t\t\t\t\tallowed = await this._confirmConnection();\n\t\t\t\t}\n\t\t\t\tif (allowed) {\n\t\t\t\t\tconst bannerDismissedVersion = this.storageService.get(`${BANNER_REMOTE_UNSUPPORTED_CONNECTION_DISMISSED_KEY}`, StorageScope.PROFILE) ?? '';\n\t\t\t\t\t// Ignore patch versions and dismiss the banner if the major and minor versions match.\n\t\t\t\t\tconst shouldShowBanner = bannerDismissedVersion.slice(0, bannerDismissedVersion.lastIndexOf('.')) !== this.productService.version.slice(0, this.productService.version.lastIndexOf('.'));\n\t\t\t\t\tif (shouldShowBanner) {\n\t\t\t\t\t\tconst actions = [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlabel: localize('unsupportedGlibcBannerLearnMore', \"Learn More\"),\n\t\t\t\t\t\t\t\thref: 'https://aka.ms/vscode-remote/faq/old-linux'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t];\n\t\t\t\t\t\tthis.bannerService.show({\n\t\t\t\t\t\t\tid: 'unsupportedGlibcWarning.banner',\n\t\t\t\t\t\t\tmessage: localize('unsupportedGlibcWarning.banner', \"You are connected to an OS version that is unsupported by {0}.\", this.productService.nameLong),\n\t\t\t\t\t\t\tactions,\n\t\t\t\t\t\t\ticon: Codicon.warning,\n\t\t\t\t\t\t\tcloseLabel: `Do not show again in v${this.productService.version}`,\n\t\t\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\t\t\tthis.storageService.store(`${BANNER_REMOTE_UNSUPPORTED_CONNECTION_DISMISSED_KEY}`, this.productService.version, StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.hostService.openWindow({ forceReuseWindow: true, remoteAuthority: null });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttype RemoteConnectionSuccessClassification = {\n\t\t\t\towner: 'alexdima';\n\t\t\t\tcomment: 'The initial connection succeeded';\n\t\t\t\tweb: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Is web ui.' };\n\t\t\t\tconnectionTimeMs: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Time, in ms, until connected' };\n\t\t\t\tremoteName: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The name of the resolver.' };\n\t\t\t};\n\t\t\ttype RemoteConnectionSuccessEvent = {\n\t\t\t\tweb: boolean;\n\t\t\t\tconnectionTimeMs: number | undefined;\n\t\t\t\tremoteName: string | undefined;\n\t\t\t};\n\t\t\tthis._telemetryService.publicLog2<RemoteConnectionSuccessEvent, RemoteConnectionSuccessClassification>('remoteConnectionSuccess', {\n\t\t\t\tweb: isWeb,\n\t\t\t\tconnectionTimeMs: await this._remoteAgentService.getConnection()?.getInitialConnectionTimeMs(),\n\t\t\t\tremoteName: getRemoteName(this._environmentService.remoteAuthority)\n\t\t\t});\n\n\t\t\tawait this._measureExtHostLatency();\n\n\t\t} catch (err) {\n\n\t\t\ttype RemoteConnectionFailureClassification = {\n\t\t\t\towner: 'alexdima';\n\t\t\t\tcomment: 'The initial connection failed';\n\t\t\t\tweb: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Is web ui.' };\n\t\t\t\tremoteName: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The name of the resolver.' };\n\t\t\t\tconnectionTimeMs: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Time, in ms, until connection failure' };\n\t\t\t\tmessage: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Error message' };\n\t\t\t};\n\t\t\ttype RemoteConnectionFailureEvent = {\n\t\t\t\tweb: boolean;\n\t\t\t\tremoteName: string | undefined;\n\t\t\t\tconnectionTimeMs: number | undefined;\n\t\t\t\tmessage: string;\n\t\t\t};\n\t\t\tthis._telemetryService.publicLog2<RemoteConnectionFailureEvent, RemoteConnectionFailureClassification>('remoteConnectionFailure', {\n\t\t\t\tweb: isWeb,\n\t\t\t\tconnectionTimeMs: await this._remoteAgentService.getConnection()?.getInitialConnectionTimeMs(),\n\t\t\t\tremoteName: getRemoteName(this._environmentService.remoteAuthority),\n\t\t\t\tmessage: err ? err.message : ''\n\t\t\t});\n\n\t\t}\n\t}\n\n\tprivate async _measureExtHostLatency() {\n\t\tconst measurement = await remoteConnectionLatencyMeasurer.measure(this._remoteAgentService);\n\t\tif (measurement === undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\ttype RemoteConnectionLatencyClassification = {\n\t\t\towner: 'connor4312';\n\t\t\tcomment: 'The latency to the remote extension host';\n\t\t\tweb: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Whether this is running on web' };\n\t\t\tremoteName: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Anonymized remote name' };\n\t\t\tlatencyMs: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Latency to the remote, in milliseconds' };\n\t\t};\n\t\ttype RemoteConnectionLatencyEvent = {\n\t\t\tweb: boolean;\n\t\t\tremoteName: string | undefined;\n\t\t\tlatencyMs: number;\n\t\t};\n\n\t\tthis._telemetryService.publicLog2<RemoteConnectionLatencyEvent, RemoteConnectionLatencyClassification>('remoteConnectionLatency', {\n\t\t\tweb: isWeb,\n\t\t\tremoteName: getRemoteName(this._environmentService.remoteAuthority),\n\t\t\tlatencyMs: measurement.current\n\t\t});\n\t}\n}\n"]}