{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/performance/electron-browser/startupTimings.ts","vs/workbench/contrib/performance/electron-browser/startupTimings.ts"],"names":[],"mappings":"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","file":"startupTimings.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { timeout } from '../../../../base/common/async.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { INativeWorkbenchEnvironmentService } from '../../../services/environment/electron-browser/environmentService.js';\nimport { ILifecycleService } from '../../../services/lifecycle/common/lifecycle.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IUpdateService } from '../../../../platform/update/common/update.js';\nimport { INativeHostService } from '../../../../platform/native/common/native.js';\nimport { IEditorService } from '../../../services/editor/common/editorService.js';\nimport { ITimerService } from '../../../services/timer/browser/timerService.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { IWorkspaceTrustManagementService } from '../../../../platform/workspace/common/workspaceTrust.js';\nimport { IPaneCompositePartService } from '../../../services/panecomposite/browser/panecomposite.js';\nimport { StartupTimings } from '../browser/startupTimings.js';\nimport { coalesce } from '../../../../base/common/arrays.js';\n\ninterface ITracingData {\n\treadonly args?: {\n\t\treadonly usedHeapSizeAfter?: number;\n\t\treadonly usedHeapSizeBefore?: number;\n\t};\n\treadonly dur: number; \t// in microseconds\n\treadonly name: string;\t// e.g. MinorGC or MajorGC\n\treadonly pid: number;\n}\n\ninterface IHeapStatistics {\n\treadonly used: number;\n\treadonly garbage: number;\n\treadonly majorGCs: number;\n\treadonly minorGCs: number;\n\treadonly duration: number;\n}\n\nexport class NativeStartupTimings extends StartupTimings implements IWorkbenchContribution {\n\n\tconstructor(\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@ITimerService private readonly _timerService: ITimerService,\n\t\t@INativeHostService private readonly _nativeHostService: INativeHostService,\n\t\t@IEditorService editorService: IEditorService,\n\t\t@IPaneCompositePartService paneCompositeService: IPaneCompositePartService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@ILifecycleService lifecycleService: ILifecycleService,\n\t\t@IUpdateService updateService: IUpdateService,\n\t\t@INativeWorkbenchEnvironmentService private readonly _environmentService: INativeWorkbenchEnvironmentService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@IWorkspaceTrustManagementService workspaceTrustService: IWorkspaceTrustManagementService\n\t) {\n\t\tsuper(editorService, paneCompositeService, lifecycleService, updateService, workspaceTrustService);\n\n\t\tthis._report().catch(onUnexpectedError);\n\t}\n\n\tprivate async _report() {\n\t\tconst standardStartupError = await this._isStandardStartup();\n\t\tthis._appendStartupTimes(standardStartupError).catch(onUnexpectedError);\n\t}\n\n\tprivate async _appendStartupTimes(standardStartupError: string | undefined) {\n\t\tconst appendTo = this._environmentService.args['prof-append-timers'];\n\t\tconst durationMarkers = this._environmentService.args['prof-duration-markers'];\n\t\tconst durationMarkersFile = this._environmentService.args['prof-duration-markers-file'];\n\t\tif (!appendTo && !durationMarkers) {\n\t\t\t// nothing to do\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tawait Promise.all([\n\t\t\t\tthis._timerService.whenReady(),\n\t\t\t\ttimeout(15000), // wait: cached data creation, telemetry sending\n\t\t\t]);\n\n\t\t\tconst perfBaseline = await this._timerService.perfBaseline;\n\t\t\tconst heapStatistics = await this._resolveStartupHeapStatistics();\n\t\t\tif (heapStatistics) {\n\t\t\t\tthis._telemetryLogHeapStatistics(heapStatistics);\n\t\t\t}\n\n\t\t\tif (appendTo) {\n\t\t\t\tconst content = coalesce([\n\t\t\t\t\tthis._timerService.startupMetrics.ellapsed,\n\t\t\t\t\tthis._productService.nameShort,\n\t\t\t\t\t(this._productService.commit || '').slice(0, 10) || '0000000000',\n\t\t\t\t\tthis._telemetryService.sessionId,\n\t\t\t\t\tstandardStartupError === undefined ? 'standard_start' : `NO_standard_start : ${standardStartupError}`,\n\t\t\t\t\t`${String(perfBaseline).padStart(4, '0')}ms`,\n\t\t\t\t\theapStatistics ? this._printStartupHeapStatistics(heapStatistics) : undefined\n\t\t\t\t]).join('\\t') + '\\n';\n\t\t\t\tawait this._appendContent(URI.file(appendTo), content);\n\t\t\t}\n\n\t\t\tif (durationMarkers?.length) {\n\t\t\t\tconst durations: string[] = [];\n\t\t\t\tfor (const durationMarker of durationMarkers) {\n\t\t\t\t\tlet duration: number = 0;\n\t\t\t\t\tif (durationMarker === 'ellapsed') {\n\t\t\t\t\t\tduration = this._timerService.startupMetrics.ellapsed;\n\t\t\t\t\t} else if (durationMarker.indexOf('-') !== -1) {\n\t\t\t\t\t\tconst markers = durationMarker.split('-');\n\t\t\t\t\t\tif (markers.length === 2) {\n\t\t\t\t\t\t\tduration = this._timerService.getDuration(markers[0], markers[1]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (duration) {\n\t\t\t\t\t\tdurations.push(durationMarker);\n\t\t\t\t\t\tdurations.push(`${duration}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst durationsContent = `${durations.join('\\t')}\\n`;\n\t\t\t\tif (durationMarkersFile) {\n\t\t\t\t\tawait this._appendContent(URI.file(durationMarkersFile), durationsContent);\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(durationsContent);\n\t\t\t\t}\n\t\t\t}\n\n\t\t} catch (err) {\n\t\t\tconsole.error(err);\n\t\t} finally {\n\t\t\tthis._nativeHostService.exit(0);\n\t\t}\n\t}\n\n\tprotected override async _isStandardStartup(): Promise<string | undefined> {\n\t\tconst windowCount = await this._nativeHostService.getWindowCount();\n\t\tif (windowCount !== 1) {\n\t\t\treturn `Expected window count : 1, Actual : ${windowCount}`;\n\t\t}\n\t\treturn super._isStandardStartup();\n\t}\n\n\tprivate async _appendContent(file: URI, content: string): Promise<void> {\n\t\tconst chunks: VSBuffer[] = [];\n\t\tif (await this._fileService.exists(file)) {\n\t\t\tchunks.push((await this._fileService.readFile(file)).value);\n\t\t}\n\t\tchunks.push(VSBuffer.fromString(content));\n\t\tawait this._fileService.writeFile(file, VSBuffer.concat(chunks));\n\t}\n\n\tprivate async _resolveStartupHeapStatistics(): Promise<IHeapStatistics | undefined> {\n\t\tif (\n\t\t\t!this._environmentService.args['enable-tracing'] ||\n\t\t\t!this._environmentService.args['trace-startup-file'] ||\n\t\t\tthis._environmentService.args['trace-startup-format'] !== 'json' ||\n\t\t\t!this._environmentService.args['trace-startup-duration']\n\t\t) {\n\t\t\treturn undefined; // unexpected arguments for startup heap statistics\n\t\t}\n\n\t\tconst windowProcessId = await this._nativeHostService.getProcessId();\n\t\tconst used = (performance as unknown as { memory?: { usedJSHeapSize?: number } }).memory?.usedJSHeapSize ?? 0; // https://developer.mozilla.org/en-US/docs/Web/API/Performance/memory\n\n\t\tlet minorGCs = 0;\n\t\tlet majorGCs = 0;\n\t\tlet garbage = 0;\n\t\tlet duration = 0;\n\n\t\ttry {\n\t\t\tconst traceContents: { traceEvents: ITracingData[] } = JSON.parse((await this._fileService.readFile(URI.file(this._environmentService.args['trace-startup-file']))).value.toString());\n\t\t\tfor (const event of traceContents.traceEvents) {\n\t\t\t\tif (event.pid !== windowProcessId) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tswitch (event.name) {\n\n\t\t\t\t\t// Major/Minor GC Events\n\t\t\t\t\tcase 'MinorGC':\n\t\t\t\t\t\tminorGCs++;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'MajorGC':\n\t\t\t\t\t\tmajorGCs++;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t// GC Events that block the main thread\n\t\t\t\t\t// Refs: https://v8.dev/blog/trash-talk\n\t\t\t\t\tcase 'V8.GCFinalizeMC':\n\t\t\t\t\tcase 'V8.GCScavenger':\n\t\t\t\t\t\tduration += event.dur;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif (event.name === 'MajorGC' || event.name === 'MinorGC') {\n\t\t\t\t\tif (typeof event.args?.usedHeapSizeAfter === 'number' && typeof event.args.usedHeapSizeBefore === 'number') {\n\t\t\t\t\t\tgarbage += (event.args.usedHeapSizeBefore - event.args.usedHeapSizeAfter);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { minorGCs, majorGCs, used, garbage, duration: Math.round(duration / 1000) };\n\t\t} catch (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate _telemetryLogHeapStatistics({ used, garbage, majorGCs, minorGCs, duration }: IHeapStatistics): void {\n\t\ttype StartupHeapStatisticsClassification = {\n\t\t\towner: 'bpasero';\n\t\t\tcomment: 'An event that reports startup heap statistics for performance analysis.';\n\t\t\theapUsed: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Used heap' };\n\t\t\theapGarbage: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Garbage heap' };\n\t\t\tmajorGCs: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Major GCs count' };\n\t\t\tminorGCs: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Minor GCs count' };\n\t\t\tgcsDuration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'GCs duration' };\n\t\t};\n\t\ttype StartupHeapStatisticsEvent = {\n\t\t\theapUsed: number;\n\t\t\theapGarbage: number;\n\t\t\tmajorGCs: number;\n\t\t\tminorGCs: number;\n\t\t\tgcsDuration: number;\n\t\t};\n\t\tthis._telemetryService.publicLog2<StartupHeapStatisticsEvent, StartupHeapStatisticsClassification>('startupHeapStatistics', {\n\t\t\theapUsed: used,\n\t\t\theapGarbage: garbage,\n\t\t\tmajorGCs,\n\t\t\tminorGCs,\n\t\t\tgcsDuration: duration\n\t\t});\n\t}\n\n\tprivate _printStartupHeapStatistics({ used, garbage, majorGCs, minorGCs, duration }: IHeapStatistics) {\n\t\tconst MB = 1024 * 1024;\n\t\treturn `Heap: ${Math.round(used / MB)}MB (used) ${Math.round(garbage / MB)}MB (garbage) ${majorGCs} (MajorGC) ${minorGCs} (MinorGC) ${duration}ms (GC duration)`;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { timeout } from '../../../../base/common/async.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { INativeWorkbenchEnvironmentService } from '../../../services/environment/electron-browser/environmentService.js';\nimport { ILifecycleService } from '../../../services/lifecycle/common/lifecycle.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { IUpdateService } from '../../../../platform/update/common/update.js';\nimport { INativeHostService } from '../../../../platform/native/common/native.js';\nimport { IEditorService } from '../../../services/editor/common/editorService.js';\nimport { ITimerService } from '../../../services/timer/browser/timerService.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { IWorkspaceTrustManagementService } from '../../../../platform/workspace/common/workspaceTrust.js';\nimport { IPaneCompositePartService } from '../../../services/panecomposite/browser/panecomposite.js';\nimport { StartupTimings } from '../browser/startupTimings.js';\nimport { coalesce } from '../../../../base/common/arrays.js';\n\ninterface ITracingData {\n\treadonly args?: {\n\t\treadonly usedHeapSizeAfter?: number;\n\t\treadonly usedHeapSizeBefore?: number;\n\t};\n\treadonly dur: number; \t// in microseconds\n\treadonly name: string;\t// e.g. MinorGC or MajorGC\n\treadonly pid: number;\n}\n\ninterface IHeapStatistics {\n\treadonly used: number;\n\treadonly garbage: number;\n\treadonly majorGCs: number;\n\treadonly minorGCs: number;\n\treadonly duration: number;\n}\n\nexport class NativeStartupTimings extends StartupTimings implements IWorkbenchContribution {\n\n\tconstructor(\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@ITimerService private readonly _timerService: ITimerService,\n\t\t@INativeHostService private readonly _nativeHostService: INativeHostService,\n\t\t@IEditorService editorService: IEditorService,\n\t\t@IPaneCompositePartService paneCompositeService: IPaneCompositePartService,\n\t\t@ITelemetryService private readonly _telemetryService: ITelemetryService,\n\t\t@ILifecycleService lifecycleService: ILifecycleService,\n\t\t@IUpdateService updateService: IUpdateService,\n\t\t@INativeWorkbenchEnvironmentService private readonly _environmentService: INativeWorkbenchEnvironmentService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@IWorkspaceTrustManagementService workspaceTrustService: IWorkspaceTrustManagementService\n\t) {\n\t\tsuper(editorService, paneCompositeService, lifecycleService, updateService, workspaceTrustService);\n\n\t\tthis._report().catch(onUnexpectedError);\n\t}\n\n\tprivate async _report() {\n\t\tconst standardStartupError = await this._isStandardStartup();\n\t\tthis._appendStartupTimes(standardStartupError).catch(onUnexpectedError);\n\t}\n\n\tprivate async _appendStartupTimes(standardStartupError: string | undefined) {\n\t\tconst appendTo = this._environmentService.args['prof-append-timers'];\n\t\tconst durationMarkers = this._environmentService.args['prof-duration-markers'];\n\t\tconst durationMarkersFile = this._environmentService.args['prof-duration-markers-file'];\n\t\tif (!appendTo && !durationMarkers) {\n\t\t\t// nothing to do\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tawait Promise.all([\n\t\t\t\tthis._timerService.whenReady(),\n\t\t\t\ttimeout(15000), // wait: cached data creation, telemetry sending\n\t\t\t]);\n\n\t\t\tconst perfBaseline = await this._timerService.perfBaseline;\n\t\t\tconst heapStatistics = await this._resolveStartupHeapStatistics();\n\t\t\tif (heapStatistics) {\n\t\t\t\tthis._telemetryLogHeapStatistics(heapStatistics);\n\t\t\t}\n\n\t\t\tif (appendTo) {\n\t\t\t\tconst content = coalesce([\n\t\t\t\t\tthis._timerService.startupMetrics.ellapsed,\n\t\t\t\t\tthis._productService.nameShort,\n\t\t\t\t\t(this._productService.commit || '').slice(0, 10) || '0000000000',\n\t\t\t\t\tthis._telemetryService.sessionId,\n\t\t\t\t\tstandardStartupError === undefined ? 'standard_start' : `NO_standard_start : ${standardStartupError}`,\n\t\t\t\t\t`${String(perfBaseline).padStart(4, '0')}ms`,\n\t\t\t\t\theapStatistics ? this._printStartupHeapStatistics(heapStatistics) : undefined\n\t\t\t\t]).join('\\t') + '\\n';\n\t\t\t\tawait this._appendContent(URI.file(appendTo), content);\n\t\t\t}\n\n\t\t\tif (durationMarkers?.length) {\n\t\t\t\tconst durations: string[] = [];\n\t\t\t\tfor (const durationMarker of durationMarkers) {\n\t\t\t\t\tlet duration: number = 0;\n\t\t\t\t\tif (durationMarker === 'ellapsed') {\n\t\t\t\t\t\tduration = this._timerService.startupMetrics.ellapsed;\n\t\t\t\t\t} else if (durationMarker.indexOf('-') !== -1) {\n\t\t\t\t\t\tconst markers = durationMarker.split('-');\n\t\t\t\t\t\tif (markers.length === 2) {\n\t\t\t\t\t\t\tduration = this._timerService.getDuration(markers[0], markers[1]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (duration) {\n\t\t\t\t\t\tdurations.push(durationMarker);\n\t\t\t\t\t\tdurations.push(`${duration}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst durationsContent = `${durations.join('\\t')}\\n`;\n\t\t\t\tif (durationMarkersFile) {\n\t\t\t\t\tawait this._appendContent(URI.file(durationMarkersFile), durationsContent);\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(durationsContent);\n\t\t\t\t}\n\t\t\t}\n\n\t\t} catch (err) {\n\t\t\tconsole.error(err);\n\t\t} finally {\n\t\t\tthis._nativeHostService.exit(0);\n\t\t}\n\t}\n\n\tprotected override async _isStandardStartup(): Promise<string | undefined> {\n\t\tconst windowCount = await this._nativeHostService.getWindowCount();\n\t\tif (windowCount !== 1) {\n\t\t\treturn `Expected window count : 1, Actual : ${windowCount}`;\n\t\t}\n\t\treturn super._isStandardStartup();\n\t}\n\n\tprivate async _appendContent(file: URI, content: string): Promise<void> {\n\t\tconst chunks: VSBuffer[] = [];\n\t\tif (await this._fileService.exists(file)) {\n\t\t\tchunks.push((await this._fileService.readFile(file)).value);\n\t\t}\n\t\tchunks.push(VSBuffer.fromString(content));\n\t\tawait this._fileService.writeFile(file, VSBuffer.concat(chunks));\n\t}\n\n\tprivate async _resolveStartupHeapStatistics(): Promise<IHeapStatistics | undefined> {\n\t\tif (\n\t\t\t!this._environmentService.args['enable-tracing'] ||\n\t\t\t!this._environmentService.args['trace-startup-file'] ||\n\t\t\tthis._environmentService.args['trace-startup-format'] !== 'json' ||\n\t\t\t!this._environmentService.args['trace-startup-duration']\n\t\t) {\n\t\t\treturn undefined; // unexpected arguments for startup heap statistics\n\t\t}\n\n\t\tconst windowProcessId = await this._nativeHostService.getProcessId();\n\t\tconst used = (performance as unknown as { memory?: { usedJSHeapSize?: number } }).memory?.usedJSHeapSize ?? 0; // https://developer.mozilla.org/en-US/docs/Web/API/Performance/memory\n\n\t\tlet minorGCs = 0;\n\t\tlet majorGCs = 0;\n\t\tlet garbage = 0;\n\t\tlet duration = 0;\n\n\t\ttry {\n\t\t\tconst traceContents: { traceEvents: ITracingData[] } = JSON.parse((await this._fileService.readFile(URI.file(this._environmentService.args['trace-startup-file']))).value.toString());\n\t\t\tfor (const event of traceContents.traceEvents) {\n\t\t\t\tif (event.pid !== windowProcessId) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tswitch (event.name) {\n\n\t\t\t\t\t// Major/Minor GC Events\n\t\t\t\t\tcase 'MinorGC':\n\t\t\t\t\t\tminorGCs++;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'MajorGC':\n\t\t\t\t\t\tmajorGCs++;\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t// GC Events that block the main thread\n\t\t\t\t\t// Refs: https://v8.dev/blog/trash-talk\n\t\t\t\t\tcase 'V8.GCFinalizeMC':\n\t\t\t\t\tcase 'V8.GCScavenger':\n\t\t\t\t\t\tduration += event.dur;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif (event.name === 'MajorGC' || event.name === 'MinorGC') {\n\t\t\t\t\tif (typeof event.args?.usedHeapSizeAfter === 'number' && typeof event.args.usedHeapSizeBefore === 'number') {\n\t\t\t\t\t\tgarbage += (event.args.usedHeapSizeBefore - event.args.usedHeapSizeAfter);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { minorGCs, majorGCs, used, garbage, duration: Math.round(duration / 1000) };\n\t\t} catch (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tprivate _telemetryLogHeapStatistics({ used, garbage, majorGCs, minorGCs, duration }: IHeapStatistics): void {\n\t\ttype StartupHeapStatisticsClassification = {\n\t\t\towner: 'bpasero';\n\t\t\tcomment: 'An event that reports startup heap statistics for performance analysis.';\n\t\t\theapUsed: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Used heap' };\n\t\t\theapGarbage: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Garbage heap' };\n\t\t\tmajorGCs: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Major GCs count' };\n\t\t\tminorGCs: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'Minor GCs count' };\n\t\t\tgcsDuration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'GCs duration' };\n\t\t};\n\t\ttype StartupHeapStatisticsEvent = {\n\t\t\theapUsed: number;\n\t\t\theapGarbage: number;\n\t\t\tmajorGCs: number;\n\t\t\tminorGCs: number;\n\t\t\tgcsDuration: number;\n\t\t};\n\t\tthis._telemetryService.publicLog2<StartupHeapStatisticsEvent, StartupHeapStatisticsClassification>('startupHeapStatistics', {\n\t\t\theapUsed: used,\n\t\t\theapGarbage: garbage,\n\t\t\tmajorGCs,\n\t\t\tminorGCs,\n\t\t\tgcsDuration: duration\n\t\t});\n\t}\n\n\tprivate _printStartupHeapStatistics({ used, garbage, majorGCs, minorGCs, duration }: IHeapStatistics) {\n\t\tconst MB = 1024 * 1024;\n\t\treturn `Heap: ${Math.round(used / MB)}MB (used) ${Math.round(garbage / MB)}MB (garbage) ${majorGCs} (MajorGC) ${minorGCs} (MinorGC) ${duration}ms (GC duration)`;\n\t}\n}\n"]}