{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/performance/electron-browser/rendererAutoProfiler.ts","vs/workbench/contrib/performance/electron-browser/rendererAutoProfiler.ts"],"names":[],"mappings":"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","file":"rendererAutoProfiler.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { timeout } from '../../../../base/common/async.js';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { joinPath } from '../../../../base/common/resources.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { INativeHostService } from '../../../../platform/native/common/native.js';\nimport { IV8Profile } from '../../../../platform/profiling/common/profiling.js';\nimport { IProfileAnalysisWorkerService, ProfilingOutput } from '../../../../platform/profiling/electron-browser/profileAnalysisWorkerService.js';\nimport { INativeWorkbenchEnvironmentService } from '../../../services/environment/electron-browser/environmentService.js';\nimport { parseExtensionDevOptions } from '../../../services/extensions/common/extensionDevOptions.js';\nimport { ITimerService } from '../../../services/timer/browser/timerService.js';\n\nexport class RendererProfiling {\n\n\tprivate _observer?: PerformanceObserver;\n\n\tconstructor(\n\t\t@INativeWorkbenchEnvironmentService private readonly _environmentService: INativeWorkbenchEnvironmentService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@INativeHostService nativeHostService: INativeHostService,\n\t\t@ITimerService timerService: ITimerService,\n\t\t@IConfigurationService configService: IConfigurationService,\n\t\t@IProfileAnalysisWorkerService profileAnalysisService: IProfileAnalysisWorkerService\n\t) {\n\n\t\tconst devOpts = parseExtensionDevOptions(_environmentService);\n\t\tif (devOpts.isExtensionDevTestFromCli) {\n\t\t\t// disabled when running extension tests\n\t\t\treturn;\n\t\t}\n\n\t\ttimerService.perfBaseline.then(perfBaseline => {\n\t\t\t(_environmentService.isBuilt ? _logService.info : _logService.trace).apply(_logService, [`[perf] Render performance baseline is ${perfBaseline}ms`]);\n\n\t\t\tif (perfBaseline < 0) {\n\t\t\t\t// too slow\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// SLOW threshold\n\t\t\tconst slowThreshold = perfBaseline * 10; // ~10 frames at 64fps on MY machine\n\n\t\t\tconst obs = new PerformanceObserver(async list => {\n\n\t\t\t\tobs.takeRecords();\n\t\t\t\tconst maxDuration = list.getEntries()\n\t\t\t\t\t.map(e => e.duration)\n\t\t\t\t\t.reduce((p, c) => Math.max(p, c), 0);\n\n\t\t\t\tif (maxDuration < slowThreshold) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!configService.getValue('application.experimental.rendererProfiling')) {\n\t\t\t\t\t_logService.debug(`[perf] SLOW task detected (${maxDuration}ms) but renderer profiling is disabled via 'application.experimental.rendererProfiling'`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst sessionId = generateUuid();\n\n\t\t\t\t_logService.warn(`[perf] Renderer reported VERY LONG TASK (${maxDuration}ms), starting profiling session '${sessionId}'`);\n\n\t\t\t\t// pause observation, we'll take a detailed look\n\t\t\t\tobs.disconnect();\n\n\t\t\t\t// profile renderer for 5secs, analyse, and take action depending on the result\n\t\t\t\tfor (let i = 0; i < 3; i++) {\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst profile = await nativeHostService.profileRenderer(sessionId, 5000);\n\t\t\t\t\t\tconst output = await profileAnalysisService.analyseBottomUp(profile, _url => '<<renderer>>', perfBaseline, true);\n\t\t\t\t\t\tif (output === ProfilingOutput.Interesting) {\n\t\t\t\t\t\t\tthis._store(profile, sessionId);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\ttimeout(15000); // wait 15s\n\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t_logService.error(err);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// reconnect the observer\n\t\t\t\tobs.observe({ entryTypes: ['longtask'] });\n\t\t\t});\n\n\t\t\tobs.observe({ entryTypes: ['longtask'] });\n\t\t\tthis._observer = obs;\n\n\t\t});\n\t}\n\n\tdispose(): void {\n\t\tthis._observer?.disconnect();\n\t}\n\n\n\tprivate async _store(profile: IV8Profile, sessionId: string): Promise<void> {\n\t\tconst path = joinPath(this._environmentService.tmpDir, `renderer-${Math.random().toString(16).slice(2, 8)}.cpuprofile.json`);\n\t\tawait this._fileService.writeFile(path, VSBuffer.fromString(JSON.stringify(profile)));\n\t\tthis._logService.info(`[perf] stored profile to DISK '${path}'`, sessionId);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { timeout } from '../../../../base/common/async.js';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { joinPath } from '../../../../base/common/resources.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { IConfigurationService } from '../../../../platform/configuration/common/configuration.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { INativeHostService } from '../../../../platform/native/common/native.js';\nimport { IV8Profile } from '../../../../platform/profiling/common/profiling.js';\nimport { IProfileAnalysisWorkerService, ProfilingOutput } from '../../../../platform/profiling/electron-browser/profileAnalysisWorkerService.js';\nimport { INativeWorkbenchEnvironmentService } from '../../../services/environment/electron-browser/environmentService.js';\nimport { parseExtensionDevOptions } from '../../../services/extensions/common/extensionDevOptions.js';\nimport { ITimerService } from '../../../services/timer/browser/timerService.js';\n\nexport class RendererProfiling {\n\n\tprivate _observer?: PerformanceObserver;\n\n\tconstructor(\n\t\t@INativeWorkbenchEnvironmentService private readonly _environmentService: INativeWorkbenchEnvironmentService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@INativeHostService nativeHostService: INativeHostService,\n\t\t@ITimerService timerService: ITimerService,\n\t\t@IConfigurationService configService: IConfigurationService,\n\t\t@IProfileAnalysisWorkerService profileAnalysisService: IProfileAnalysisWorkerService\n\t) {\n\n\t\tconst devOpts = parseExtensionDevOptions(_environmentService);\n\t\tif (devOpts.isExtensionDevTestFromCli) {\n\t\t\t// disabled when running extension tests\n\t\t\treturn;\n\t\t}\n\n\t\ttimerService.perfBaseline.then(perfBaseline => {\n\t\t\t(_environmentService.isBuilt ? _logService.info : _logService.trace).apply(_logService, [`[perf] Render performance baseline is ${perfBaseline}ms`]);\n\n\t\t\tif (perfBaseline < 0) {\n\t\t\t\t// too slow\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// SLOW threshold\n\t\t\tconst slowThreshold = perfBaseline * 10; // ~10 frames at 64fps on MY machine\n\n\t\t\tconst obs = new PerformanceObserver(async list => {\n\n\t\t\t\tobs.takeRecords();\n\t\t\t\tconst maxDuration = list.getEntries()\n\t\t\t\t\t.map(e => e.duration)\n\t\t\t\t\t.reduce((p, c) => Math.max(p, c), 0);\n\n\t\t\t\tif (maxDuration < slowThreshold) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!configService.getValue('application.experimental.rendererProfiling')) {\n\t\t\t\t\t_logService.debug(`[perf] SLOW task detected (${maxDuration}ms) but renderer profiling is disabled via 'application.experimental.rendererProfiling'`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst sessionId = generateUuid();\n\n\t\t\t\t_logService.warn(`[perf] Renderer reported VERY LONG TASK (${maxDuration}ms), starting profiling session '${sessionId}'`);\n\n\t\t\t\t// pause observation, we'll take a detailed look\n\t\t\t\tobs.disconnect();\n\n\t\t\t\t// profile renderer for 5secs, analyse, and take action depending on the result\n\t\t\t\tfor (let i = 0; i < 3; i++) {\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst profile = await nativeHostService.profileRenderer(sessionId, 5000);\n\t\t\t\t\t\tconst output = await profileAnalysisService.analyseBottomUp(profile, _url => '<<renderer>>', perfBaseline, true);\n\t\t\t\t\t\tif (output === ProfilingOutput.Interesting) {\n\t\t\t\t\t\t\tthis._store(profile, sessionId);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\ttimeout(15000); // wait 15s\n\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t_logService.error(err);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// reconnect the observer\n\t\t\t\tobs.observe({ entryTypes: ['longtask'] });\n\t\t\t});\n\n\t\t\tobs.observe({ entryTypes: ['longtask'] });\n\t\t\tthis._observer = obs;\n\n\t\t});\n\t}\n\n\tdispose(): void {\n\t\tthis._observer?.disconnect();\n\t}\n\n\n\tprivate async _store(profile: IV8Profile, sessionId: string): Promise<void> {\n\t\tconst path = joinPath(this._environmentService.tmpDir, `renderer-${Math.random().toString(16).slice(2, 8)}.cpuprofile.json`);\n\t\tawait this._fileService.writeFile(path, VSBuffer.fromString(JSON.stringify(profile)));\n\t\tthis._logService.info(`[perf] stored profile to DISK '${path}'`, sessionId);\n\t}\n}\n"]}