{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/testing/common/testResultService.ts","vs/workbench/contrib/testing/common/testResultService.ts"],"names":[],"mappings":"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","file":"testResultService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { findFirstIdxMonotonousOrArrLen } from '../../../../base/common/arraysFind.js';\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { createSingleCallFunction } from '../../../../base/common/functional.js';\nimport { Disposable, DisposableStore, dispose, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { TestingContextKeys } from './testingContextKeys.js';\nimport { ITestProfileService } from './testProfileService.js';\nimport { ITestResult, LiveTestResult, TestResultItemChange, TestResultItemChangeReason } from './testResult.js';\nimport { ITestResultStorage, RETAIN_MAX_RESULTS } from './testResultStorage.js';\nimport { ExtensionRunTestsRequest, ITestRunProfile, ResolvedTestRunRequest, TestResultItem, TestResultState, TestRunProfileBitset } from './testTypes.js';\n\nexport type ResultChangeEvent =\n\t| { completed: LiveTestResult }\n\t| { started: LiveTestResult }\n\t| { inserted: ITestResult }\n\t| { removed: ITestResult[] };\n\nexport interface ITestResultService {\n\treadonly _serviceBrand: undefined;\n\t/**\n\t * Fired after any results are added, removed, or completed.\n\t */\n\treadonly onResultsChanged: Event<ResultChangeEvent>;\n\n\t/**\n\t * Fired when a test changed it state, or its computed state is updated.\n\t */\n\treadonly onTestChanged: Event<TestResultItemChange>;\n\n\t/**\n\t * List of known test results.\n\t */\n\treadonly results: ReadonlyArray<ITestResult>;\n\n\t/**\n\t * Discards all completed test results.\n\t */\n\tclear(): void;\n\n\t/**\n\t * Creates a new, live test result.\n\t */\n\tcreateLiveResult(req: ResolvedTestRunRequest | ExtensionRunTestsRequest): LiveTestResult;\n\n\t/**\n\t * Adds a new test result to the collection.\n\t */\n\tpush<T extends ITestResult>(result: T): T;\n\n\t/**\n\t * Looks up a set of test results by ID.\n\t */\n\tgetResult(resultId: string): ITestResult | undefined;\n\n\t/**\n\t * Looks up a test's most recent state, by its extension-assigned ID.\n\t */\n\tgetStateById(extId: string): [results: ITestResult, item: TestResultItem] | undefined;\n}\n\nconst isRunningTests = (service: ITestResultService) =>\n\tservice.results.length > 0 && service.results[0].completedAt === undefined;\n\nexport const ITestResultService = createDecorator<ITestResultService>('testResultService');\n\nexport class TestResultService extends Disposable implements ITestResultService {\n\tdeclare _serviceBrand: undefined;\n\tprivate changeResultEmitter = this._register(new Emitter<ResultChangeEvent>());\n\tprivate _results: ITestResult[] = [];\n\tprivate readonly _resultsDisposables: DisposableStore[] = [];\n\tprivate testChangeEmitter = this._register(new Emitter<TestResultItemChange>());\n\tprivate insertOrderCounter = 0;\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic get results() {\n\t\tthis.loadResults();\n\t\treturn this._results;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic readonly onResultsChanged = this.changeResultEmitter.event;\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic readonly onTestChanged = this.testChangeEmitter.event;\n\n\tprivate readonly isRunning: IContextKey<boolean>;\n\tprivate readonly hasAnyResults: IContextKey<boolean>;\n\tprivate readonly loadResults = createSingleCallFunction(() => this.storage.read().then(loaded => {\n\t\tfor (let i = loaded.length - 1; i >= 0; i--) {\n\t\t\tthis.push(loaded[i]);\n\t\t}\n\t}));\n\n\tprotected readonly persistScheduler = new RunOnceScheduler(() => this.persistImmediately(), 500);\n\n\tconstructor(\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@ITestResultStorage private readonly storage: ITestResultStorage,\n\t\t@ITestProfileService private readonly testProfiles: ITestProfileService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t) {\n\t\tsuper();\n\t\tthis._register(toDisposable(() => dispose(this._resultsDisposables)));\n\t\tthis.isRunning = TestingContextKeys.isRunning.bindTo(contextKeyService);\n\t\tthis.hasAnyResults = TestingContextKeys.hasAnyResults.bindTo(contextKeyService);\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic getStateById(extId: string): [results: ITestResult, item: TestResultItem] | undefined {\n\t\tfor (const result of this.results) {\n\t\t\tconst lookup = result.getStateById(extId);\n\t\t\tif (lookup && lookup.computedState !== TestResultState.Unset) {\n\t\t\t\treturn [result, lookup];\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic createLiveResult(req: ResolvedTestRunRequest | ExtensionRunTestsRequest) {\n\t\tif ('targets' in req) {\n\t\t\tconst id = generateUuid();\n\t\t\treturn this.push(new LiveTestResult(id, true, req, this.insertOrderCounter++, this.telemetryService));\n\t\t}\n\n\t\tlet profile: ITestRunProfile | undefined;\n\t\tif (req.profile) {\n\t\t\tconst profiles = this.testProfiles.getControllerProfiles(req.controllerId);\n\t\t\tprofile = profiles.find(c => c.profileId === req.profile!.id);\n\t\t}\n\n\t\tconst resolved: ResolvedTestRunRequest = {\n\t\t\tpreserveFocus: req.preserveFocus,\n\t\t\ttargets: [],\n\t\t\texclude: req.exclude,\n\t\t\tcontinuous: req.continuous,\n\t\t\tgroup: profile?.group ?? TestRunProfileBitset.Run,\n\t\t};\n\n\t\tif (profile) {\n\t\t\tresolved.targets.push({\n\t\t\t\tprofileId: profile.profileId,\n\t\t\t\tcontrollerId: req.controllerId,\n\t\t\t\ttestIds: req.include,\n\t\t\t});\n\t\t}\n\n\t\treturn this.push(new LiveTestResult(req.id, req.persist, resolved, this.insertOrderCounter++, this.telemetryService));\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic push<T extends ITestResult>(result: T): T {\n\t\tif (result.completedAt === undefined) {\n\t\t\tthis.results.unshift(result);\n\t\t} else {\n\t\t\tconst index = findFirstIdxMonotonousOrArrLen(this.results, r => r.completedAt !== undefined && r.completedAt <= result.completedAt!);\n\t\t\tthis.results.splice(index, 0, result);\n\t\t\tthis.persistScheduler.schedule();\n\t\t}\n\n\t\tthis.hasAnyResults.set(true);\n\t\tif (this.results.length > RETAIN_MAX_RESULTS) {\n\t\t\tthis.results.pop();\n\t\t\tthis._resultsDisposables.pop()?.dispose();\n\t\t}\n\n\t\tconst ds = new DisposableStore();\n\t\tthis._resultsDisposables.push(ds);\n\n\t\tif (result instanceof LiveTestResult) {\n\t\t\tds.add(result);\n\t\t\tds.add(result.onComplete(() => this.onComplete(result)));\n\t\t\tds.add(result.onChange(this.testChangeEmitter.fire, this.testChangeEmitter));\n\t\t\tthis.isRunning.set(true);\n\t\t\tthis.changeResultEmitter.fire({ started: result });\n\t\t} else {\n\t\t\tthis.changeResultEmitter.fire({ inserted: result });\n\t\t\t// If this is not a new result, go through each of its tests. For each\n\t\t\t// test for which the new result is the most recently inserted, fir\n\t\t\t// a change event so that UI updates.\n\t\t\tfor (const item of result.tests) {\n\t\t\t\tfor (const otherResult of this.results) {\n\t\t\t\t\tif (otherResult === result) {\n\t\t\t\t\t\tthis.testChangeEmitter.fire({ item, result, reason: TestResultItemChangeReason.ComputedStateChange });\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else if (otherResult.getStateById(item.item.extId) !== undefined) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic getResult(id: string) {\n\t\treturn this.results.find(r => r.id === id);\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic clear() {\n\t\tconst keep: ITestResult[] = [];\n\t\tconst removed: ITestResult[] = [];\n\t\tfor (const result of this.results) {\n\t\t\tif (result.completedAt !== undefined) {\n\t\t\t\tremoved.push(result);\n\t\t\t} else {\n\t\t\t\tkeep.push(result);\n\t\t\t}\n\t\t}\n\n\t\tthis._results = keep;\n\t\tthis.persistScheduler.schedule();\n\t\tif (keep.length === 0) {\n\t\t\tthis.hasAnyResults.set(false);\n\t\t}\n\t\tthis.changeResultEmitter.fire({ removed });\n\t}\n\n\tprivate onComplete(result: LiveTestResult) {\n\t\tthis.resort();\n\t\tthis.updateIsRunning();\n\t\tthis.persistScheduler.schedule();\n\t\tthis.changeResultEmitter.fire({ completed: result });\n\t}\n\n\tprivate resort() {\n\t\tthis.results.sort((a, b) => {\n\t\t\t// Running tests should always be sorted higher:\n\t\t\tif (!!a.completedAt !== !!b.completedAt) {\n\t\t\t\treturn a.completedAt === undefined ? -1 : 1;\n\t\t\t}\n\n\t\t\t// Otherwise sort by insertion order, hydrated tests are always last:\n\t\t\tconst aComp = a instanceof LiveTestResult ? a.insertOrder : -1;\n\t\t\tconst bComp = b instanceof LiveTestResult ? b.insertOrder : -1;\n\t\t\treturn bComp - aComp;\n\t\t});\n\t}\n\n\tprivate updateIsRunning() {\n\t\tthis.isRunning.set(isRunningTests(this));\n\t}\n\n\tprotected async persistImmediately() {\n\t\t// ensure results are loaded before persisting to avoid deleting once\n\t\t// that we don't have yet.\n\t\tawait this.loadResults();\n\t\tthis.storage.persist(this.results);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { findFirstIdxMonotonousOrArrLen } from '../../../../base/common/arraysFind.js';\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { createSingleCallFunction } from '../../../../base/common/functional.js';\nimport { Disposable, DisposableStore, dispose, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { IContextKey, IContextKeyService } from '../../../../platform/contextkey/common/contextkey.js';\nimport { createDecorator } from '../../../../platform/instantiation/common/instantiation.js';\nimport { ITelemetryService } from '../../../../platform/telemetry/common/telemetry.js';\nimport { TestingContextKeys } from './testingContextKeys.js';\nimport { ITestProfileService } from './testProfileService.js';\nimport { ITestResult, LiveTestResult, TestResultItemChange, TestResultItemChangeReason } from './testResult.js';\nimport { ITestResultStorage, RETAIN_MAX_RESULTS } from './testResultStorage.js';\nimport { ExtensionRunTestsRequest, ITestRunProfile, ResolvedTestRunRequest, TestResultItem, TestResultState, TestRunProfileBitset } from './testTypes.js';\n\nexport type ResultChangeEvent =\n\t| { completed: LiveTestResult }\n\t| { started: LiveTestResult }\n\t| { inserted: ITestResult }\n\t| { removed: ITestResult[] };\n\nexport interface ITestResultService {\n\treadonly _serviceBrand: undefined;\n\t/**\n\t * Fired after any results are added, removed, or completed.\n\t */\n\treadonly onResultsChanged: Event<ResultChangeEvent>;\n\n\t/**\n\t * Fired when a test changed it state, or its computed state is updated.\n\t */\n\treadonly onTestChanged: Event<TestResultItemChange>;\n\n\t/**\n\t * List of known test results.\n\t */\n\treadonly results: ReadonlyArray<ITestResult>;\n\n\t/**\n\t * Discards all completed test results.\n\t */\n\tclear(): void;\n\n\t/**\n\t * Creates a new, live test result.\n\t */\n\tcreateLiveResult(req: ResolvedTestRunRequest | ExtensionRunTestsRequest): LiveTestResult;\n\n\t/**\n\t * Adds a new test result to the collection.\n\t */\n\tpush<T extends ITestResult>(result: T): T;\n\n\t/**\n\t * Looks up a set of test results by ID.\n\t */\n\tgetResult(resultId: string): ITestResult | undefined;\n\n\t/**\n\t * Looks up a test's most recent state, by its extension-assigned ID.\n\t */\n\tgetStateById(extId: string): [results: ITestResult, item: TestResultItem] | undefined;\n}\n\nconst isRunningTests = (service: ITestResultService) =>\n\tservice.results.length > 0 && service.results[0].completedAt === undefined;\n\nexport const ITestResultService = createDecorator<ITestResultService>('testResultService');\n\nexport class TestResultService extends Disposable implements ITestResultService {\n\tdeclare _serviceBrand: undefined;\n\tprivate changeResultEmitter = this._register(new Emitter<ResultChangeEvent>());\n\tprivate _results: ITestResult[] = [];\n\tprivate readonly _resultsDisposables: DisposableStore[] = [];\n\tprivate testChangeEmitter = this._register(new Emitter<TestResultItemChange>());\n\tprivate insertOrderCounter = 0;\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic get results() {\n\t\tthis.loadResults();\n\t\treturn this._results;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic readonly onResultsChanged = this.changeResultEmitter.event;\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic readonly onTestChanged = this.testChangeEmitter.event;\n\n\tprivate readonly isRunning: IContextKey<boolean>;\n\tprivate readonly hasAnyResults: IContextKey<boolean>;\n\tprivate readonly loadResults = createSingleCallFunction(() => this.storage.read().then(loaded => {\n\t\tfor (let i = loaded.length - 1; i >= 0; i--) {\n\t\t\tthis.push(loaded[i]);\n\t\t}\n\t}));\n\n\tprotected readonly persistScheduler = new RunOnceScheduler(() => this.persistImmediately(), 500);\n\n\tconstructor(\n\t\t@IContextKeyService contextKeyService: IContextKeyService,\n\t\t@ITestResultStorage private readonly storage: ITestResultStorage,\n\t\t@ITestProfileService private readonly testProfiles: ITestProfileService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t) {\n\t\tsuper();\n\t\tthis._register(toDisposable(() => dispose(this._resultsDisposables)));\n\t\tthis.isRunning = TestingContextKeys.isRunning.bindTo(contextKeyService);\n\t\tthis.hasAnyResults = TestingContextKeys.hasAnyResults.bindTo(contextKeyService);\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic getStateById(extId: string): [results: ITestResult, item: TestResultItem] | undefined {\n\t\tfor (const result of this.results) {\n\t\t\tconst lookup = result.getStateById(extId);\n\t\t\tif (lookup && lookup.computedState !== TestResultState.Unset) {\n\t\t\t\treturn [result, lookup];\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic createLiveResult(req: ResolvedTestRunRequest | ExtensionRunTestsRequest) {\n\t\tif ('targets' in req) {\n\t\t\tconst id = generateUuid();\n\t\t\treturn this.push(new LiveTestResult(id, true, req, this.insertOrderCounter++, this.telemetryService));\n\t\t}\n\n\t\tlet profile: ITestRunProfile | undefined;\n\t\tif (req.profile) {\n\t\t\tconst profiles = this.testProfiles.getControllerProfiles(req.controllerId);\n\t\t\tprofile = profiles.find(c => c.profileId === req.profile!.id);\n\t\t}\n\n\t\tconst resolved: ResolvedTestRunRequest = {\n\t\t\tpreserveFocus: req.preserveFocus,\n\t\t\ttargets: [],\n\t\t\texclude: req.exclude,\n\t\t\tcontinuous: req.continuous,\n\t\t\tgroup: profile?.group ?? TestRunProfileBitset.Run,\n\t\t};\n\n\t\tif (profile) {\n\t\t\tresolved.targets.push({\n\t\t\t\tprofileId: profile.profileId,\n\t\t\t\tcontrollerId: req.controllerId,\n\t\t\t\ttestIds: req.include,\n\t\t\t});\n\t\t}\n\n\t\treturn this.push(new LiveTestResult(req.id, req.persist, resolved, this.insertOrderCounter++, this.telemetryService));\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic push<T extends ITestResult>(result: T): T {\n\t\tif (result.completedAt === undefined) {\n\t\t\tthis.results.unshift(result);\n\t\t} else {\n\t\t\tconst index = findFirstIdxMonotonousOrArrLen(this.results, r => r.completedAt !== undefined && r.completedAt <= result.completedAt!);\n\t\t\tthis.results.splice(index, 0, result);\n\t\t\tthis.persistScheduler.schedule();\n\t\t}\n\n\t\tthis.hasAnyResults.set(true);\n\t\tif (this.results.length > RETAIN_MAX_RESULTS) {\n\t\t\tthis.results.pop();\n\t\t\tthis._resultsDisposables.pop()?.dispose();\n\t\t}\n\n\t\tconst ds = new DisposableStore();\n\t\tthis._resultsDisposables.push(ds);\n\n\t\tif (result instanceof LiveTestResult) {\n\t\t\tds.add(result);\n\t\t\tds.add(result.onComplete(() => this.onComplete(result)));\n\t\t\tds.add(result.onChange(this.testChangeEmitter.fire, this.testChangeEmitter));\n\t\t\tthis.isRunning.set(true);\n\t\t\tthis.changeResultEmitter.fire({ started: result });\n\t\t} else {\n\t\t\tthis.changeResultEmitter.fire({ inserted: result });\n\t\t\t// If this is not a new result, go through each of its tests. For each\n\t\t\t// test for which the new result is the most recently inserted, fir\n\t\t\t// a change event so that UI updates.\n\t\t\tfor (const item of result.tests) {\n\t\t\t\tfor (const otherResult of this.results) {\n\t\t\t\t\tif (otherResult === result) {\n\t\t\t\t\t\tthis.testChangeEmitter.fire({ item, result, reason: TestResultItemChangeReason.ComputedStateChange });\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else if (otherResult.getStateById(item.item.extId) !== undefined) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic getResult(id: string) {\n\t\treturn this.results.find(r => r.id === id);\n\t}\n\n\t/**\n\t * @inheritdoc\n\t */\n\tpublic clear() {\n\t\tconst keep: ITestResult[] = [];\n\t\tconst removed: ITestResult[] = [];\n\t\tfor (const result of this.results) {\n\t\t\tif (result.completedAt !== undefined) {\n\t\t\t\tremoved.push(result);\n\t\t\t} else {\n\t\t\t\tkeep.push(result);\n\t\t\t}\n\t\t}\n\n\t\tthis._results = keep;\n\t\tthis.persistScheduler.schedule();\n\t\tif (keep.length === 0) {\n\t\t\tthis.hasAnyResults.set(false);\n\t\t}\n\t\tthis.changeResultEmitter.fire({ removed });\n\t}\n\n\tprivate onComplete(result: LiveTestResult) {\n\t\tthis.resort();\n\t\tthis.updateIsRunning();\n\t\tthis.persistScheduler.schedule();\n\t\tthis.changeResultEmitter.fire({ completed: result });\n\t}\n\n\tprivate resort() {\n\t\tthis.results.sort((a, b) => {\n\t\t\t// Running tests should always be sorted higher:\n\t\t\tif (!!a.completedAt !== !!b.completedAt) {\n\t\t\t\treturn a.completedAt === undefined ? -1 : 1;\n\t\t\t}\n\n\t\t\t// Otherwise sort by insertion order, hydrated tests are always last:\n\t\t\tconst aComp = a instanceof LiveTestResult ? a.insertOrder : -1;\n\t\t\tconst bComp = b instanceof LiveTestResult ? b.insertOrder : -1;\n\t\t\treturn bComp - aComp;\n\t\t});\n\t}\n\n\tprivate updateIsRunning() {\n\t\tthis.isRunning.set(isRunningTests(this));\n\t}\n\n\tprotected async persistImmediately() {\n\t\t// ensure results are loaded before persisting to avoid deleting once\n\t\t// that we don't have yet.\n\t\tawait this.loadResults();\n\t\tthis.storage.persist(this.results);\n\t}\n}\n"]}