{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/debug/browser/debugMemory.ts","vs/workbench/contrib/debug/browser/debugMemory.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,EAAE,QAAQ,EAAE,MAAM,mCAAmC,CAAC;AAC7D,OAAO,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,kCAAkC,CAAC;AAClE,OAAO,EAAE,UAAU,EAAE,eAAe,EAAE,YAAY,EAAE,MAAM,sCAAsC,CAAC;AACjG,OAAO,EAAE,KAAK,EAAE,MAAM,oCAAoC,CAAC;AAC3D,OAAO,EAAE,WAAW,EAAE,MAAM,mCAAmC,CAAC;AAEhE,OAAO,EAAoC,cAAc,EAAkC,2BAA2B,EAAE,QAAQ,EAA0D,6BAA6B,EAAE,MAAM,4CAA4C,CAAC;AAC5Q,OAAO,EAAE,mBAAmB,EAA8G,MAAM,oBAAoB,CAAC;AAErK,MAAM,OAAO,GAAG,yBAAyB,CAAC;AAE1C,MAAM,OAAO,6BAA8B,SAAQ,UAAU;IAgB5D,YAA6B,YAA2B;QACvD,KAAK,EAAE,CAAC;QADoB,iBAAY,GAAZ,YAAY,CAAe;QAfhD,oBAAe,GAAG,CAAC,CAAC;QACX,aAAQ,GAAG,IAAI,GAAG,EAA6D,CAAC;QAChF,kBAAa,GAAG,IAAI,OAAO,EAA0B,CAAC;QAEvE,kBAAkB;QACF,4BAAuB,GAAG,KAAK,CAAC,IAAI,CAAC;QAErD,kBAAkB;QACF,oBAAe,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC;QAE3D,kBAAkB;QACF,iBAAY,GAAG,CAAC;yEACmB;2EACK,CAAC;QAKxD,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,eAAe,CAAC,CAAC,EAAE,OAAO,EAAE,EAAE,EAAE;YAC3D,KAAK,MAAM,CAAC,EAAE,EAAE,MAAM,CAAC,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;gBAC1C,IAAI,MAAM,CAAC,OAAO,KAAK,OAAO,EAAE,CAAC;oBAChC,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;gBAChB,CAAC;YACF,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;IACL,CAAC;IAEM,KAAK,CAAC,QAAa,EAAE,IAAmB;QAC9C,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACpB,OAAO,YAAY,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC;QAChC,CAAC;QAED,MAAM,EAAE,OAAO,EAAE,eAAe,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QACrE,MAAM,UAAU,GAAG,IAAI,eAAe,EAAE,CAAC;QAEzC,UAAU,CAAC,GAAG,CAAC,OAAO,CAAC,gBAAgB,CAAC,GAAG,EAAE;YAC5C,IAAI,OAAO,CAAC,KAAK,0BAAkB,IAAI,OAAO,CAAC,KAAK,2BAAmB,EAAE,CAAC;gBACzE,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,gCAAwB,EAAE,QAAQ,EAAE,CAAC,CAAC,CAAC;YACvE,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;QAEJ,UAAU,CAAC,GAAG,CAAC,OAAO,CAAC,qBAAqB,CAAC,CAAC,CAAC,EAAE;YAChD,IAAI,CAAC,CAAC,IAAI,CAAC,eAAe,KAAK,eAAe,EAAE,CAAC;gBAChD,OAAO;YACR,CAAC;YAED,IAAI,MAAM,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC,MAAM,IAAI,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,IAAI,CAAC,KAAK,GAAG,MAAM,CAAC,UAAU,CAAC,EAAE,CAAC;gBACtG,OAAO;YACR,CAAC;YAED,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,EAAE,QAAQ,EAAE,IAAI,gCAAwB,EAAE,CAAC,CAAC,CAAC;QACvE,CAAC,CAAC,CAAC,CAAC;QAEJ,OAAO,UAAU,CAAC;IACnB,CAAC;IAED,kBAAkB;IACX,IAAI,CAAC,IAAS;QACpB,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACzC,OAAO,OAAO,CAAC,OAAO,CAAC;YACtB,IAAI,EAAE,QAAQ,CAAC,IAAI;YACnB,KAAK,EAAE,CAAC;YACR,KAAK,EAAE,CAAC;YACR,IAAI,EAAE,CAAC;YACP,WAAW,EAAE,QAAQ,CAAC,CAAC,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC,CAAC,SAAS;SAC3D,CAAC,CAAC;IACJ,CAAC;IAED,kBAAkB;IACX,KAAK;QACX,MAAM,6BAA6B,CAAC,aAAa,EAAE,2BAA2B,CAAC,aAAa,CAAC,CAAC;IAC/F,CAAC;IAED,kBAAkB;IACX,OAAO;QACb,MAAM,6BAA6B,CAAC,aAAa,EAAE,2BAA2B,CAAC,aAAa,CAAC,CAAC;IAC/F,CAAC;IAED,kBAAkB;IACX,MAAM;QACZ,MAAM,6BAA6B,CAAC,aAAa,EAAE,2BAA2B,CAAC,aAAa,CAAC,CAAC;IAC/F,CAAC;IAED,kBAAkB;IACX,MAAM;QACZ,MAAM,6BAA6B,CAAC,aAAa,EAAE,2BAA2B,CAAC,aAAa,CAAC,CAAC;IAC/F,CAAC;IAED,kBAAkB;IACX,IAAI,CAAC,QAAa,EAAE,KAAuB;QACjD,MAAM,EAAE,OAAO,EAAE,eAAe,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QACrE,MAAM,EAAE,GAAG,IAAI,CAAC,eAAe,EAAE,CAAC;QAClC,IAAI,MAAM,GAAG,OAAO,CAAC,SAAS,CAAC,eAAe,CAAC,CAAC;QAChD,IAAI,MAAM,EAAE,CAAC;YACZ,MAAM,GAAG,IAAI,gBAAgB,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;QAC/C,CAAC;QAED,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC,CAAC;QAC3C,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;IAC5B,CAAC;IAED,kBAAkB;IACX,KAAK,CAAC,EAAU;QACtB,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC;QACxC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;QACzB,OAAO,OAAO,CAAC,OAAO,EAAE,CAAC;IAC1B,CAAC;IAED,kBAAkB;IACX,KAAK,CAAC,SAAS,CAAC,QAAa,EAAE,OAAmB;QACxD,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QAC3C,IAAI,CAAC,MAAM,EAAE,CAAC;YACb,MAAM,6BAA6B,CAAC,sCAAsC,EAAE,2BAA2B,CAAC,YAAY,CAAC,CAAC;QACvH,CAAC;QAED,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;QAExD,IAAI,CAAC;YACJ,MAAM,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE,MAAM,CAAC,UAAU,EAAE,OAAO,EAAE,CAAC,EAAE,OAAO,CAAC,MAAM,CAAC,CAAC;QACrE,CAAC;gBAAS,CAAC;YACV,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;QAChB,CAAC;IACF,CAAC;IAED,kBAAkB;IACX,KAAK,CAAC,QAAQ,CAAC,QAAa;QAClC,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QAC3C,IAAI,CAAC,MAAM,EAAE,CAAC;YACb,MAAM,6BAA6B,CAAC,sCAAsC,EAAE,2BAA2B,CAAC,YAAY,CAAC,CAAC;QACvH,CAAC;QAED,MAAM,IAAI,GAAG,IAAI,UAAU,CAAC,MAAM,CAAC,QAAQ,GAAG,MAAM,CAAC,UAAU,CAAC,CAAC;QACjE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC,CAAC;QAExD,IAAI,CAAC;YACJ,MAAM,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE,MAAM,CAAC,UAAU,EAAE,IAAI,EAAE,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;YAC7D,OAAO,IAAI,CAAC;QACb,CAAC;gBAAS,CAAC;YACV,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;QAChB,CAAC;IACF,CAAC;IAED,kBAAkB;IACX,KAAK,CAAC,IAAI,CAAC,EAAU,EAAE,GAAW,EAAE,IAAgB,EAAE,MAAc,EAAE,MAAc;QAC1F,MAAM,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;QACrC,IAAI,CAAC,MAAM,EAAE,CAAC;YACb,MAAM,6BAA6B,CAAC,mCAAmC,EAAE,2BAA2B,CAAC,WAAW,CAAC,CAAC;QACnH,CAAC;QAED,MAAM,MAAM,GAAG,MAAM,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;QACrD,IAAI,SAAS,GAAG,CAAC,CAAC;QAClB,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;YAC5B,QAAQ,KAAK,CAAC,IAAI,EAAE,CAAC;gBACpB;oBACC,OAAO,SAAS,CAAC;gBAClB;oBACC,IAAI,SAAS,GAAG,CAAC,EAAE,CAAC;wBACnB,OAAO,SAAS,CAAC;oBAClB,CAAC;yBAAM,CAAC;wBACP,MAAM,6BAA6B,CAAC,KAAK,CAAC,KAAK,EAAE,2BAA2B,CAAC,OAAO,CAAC,CAAC;oBACvF,CAAC;gBACF,kCAA0B,CAAC,CAAC,CAAC;oBAC5B,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,GAAG,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC;oBAC9C,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,UAAU,EAAE,KAAK,GAAG,CAAC,MAAM,GAAG,SAAS,CAAC,CAAC,CAAC,CAAC;oBACvG,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,MAAM,EAAE,MAAM,GAAG,SAAS,CAAC,CAAC;oBAC7C,SAAS,IAAI,OAAO,CAAC,UAAU,CAAC;oBAChC,MAAM;gBACP,CAAC;gBACD;oBACC,WAAW,CAAC,KAAK,CAAC,CAAC;YACrB,CAAC;QACF,CAAC;QAED,OAAO,SAAS,CAAC;IAClB,CAAC;IAED,kBAAkB;IACX,KAAK,CAAC,EAAU,EAAE,GAAW,EAAE,IAAgB,EAAE,MAAc,EAAE,MAAc;QACrF,MAAM,MAAM,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;QACrC,IAAI,CAAC,MAAM,EAAE,CAAC;YACb,MAAM,6BAA6B,CAAC,mCAAmC,EAAE,2BAA2B,CAAC,WAAW,CAAC,CAAC;QACnH,CAAC;QAED,OAAO,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,EAAE,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,MAAM,EAAE,MAAM,GAAG,MAAM,CAAC,CAAC,CAAC;IACrF,CAAC;IAES,QAAQ,CAAC,GAAQ;QAC1B,IAAI,GAAG,CAAC,MAAM,KAAK,mBAAmB,EAAE,CAAC;YACxC,MAAM,6BAA6B,CAAC,gCAAgC,GAAG,CAAC,MAAM,EAAE,EAAE,2BAA2B,CAAC,YAAY,CAAC,CAAC;QAC7H,CAAC;QAED,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,CAAC,UAAU,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;QACvE,IAAI,CAAC,OAAO,EAAE,CAAC;YACd,MAAM,6BAA6B,CAAC,yBAAyB,EAAE,2BAA2B,CAAC,YAAY,CAAC,CAAC;QAC1G,CAAC;QAED,IAAI,MAA4D,CAAC;QACjE,MAAM,UAAU,GAAG,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QAC3C,IAAI,UAAU,EAAE,CAAC;YAChB,MAAM,GAAG,EAAE,UAAU,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,EAAE,QAAQ,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;QACjF,CAAC;QAED,MAAM,CAAC,EAAE,eAAe,CAAC,GAAG,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;QAEhD,OAAO;YACN,OAAO;YACP,MAAM;YACN,QAAQ,EAAE,CAAC,OAAO,CAAC,YAAY,CAAC,0BAA0B;YAC1D,SAAS,EAAE,GAAG,CAAC,SAAS;YACxB,eAAe,EAAE,kBAAkB,CAAC,eAAe,CAAC;SACpD,CAAC;IACH,CAAC;CACD;AAED,uFAAuF;AACvF,MAAM,gBAAiB,SAAQ,UAAU;IAOxC,YAA6B,MAAqB,EAAkB,KAA+C;QAClH,KAAK,EAAE,CAAC;QADoB,WAAM,GAAN,MAAM,CAAe;QAAkB,UAAK,GAAL,KAAK,CAA0C;QANlG,sBAAiB,GAAG,IAAI,OAAO,EAA4B,CAAC;QAE7D,oBAAe,GAAG,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC;QAM9D,IAAI,CAAC,QAAQ,GAAG,MAAM,CAAC,QAAQ,CAAC;QAChC,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,QAAQ,GAAG,KAAK,CAAC,UAAU,CAAC;QAE/C,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC;QACvB,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC,CAAC,EAAE;YACzC,MAAM,UAAU,GAAG,KAAK,CAAC,CAAC,CAAC,UAAU,GAAG,KAAK,CAAC,UAAU,EAAE,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;YACzE,MAAM,QAAQ,GAAG,KAAK,CAAC,CAAC,CAAC,QAAQ,GAAG,KAAK,CAAC,UAAU,EAAE,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;YACrE,IAAI,QAAQ,GAAG,UAAU,EAAE,CAAC;gBAC3B,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,EAAE,UAAU,EAAE,QAAQ,EAAE,CAAC,CAAC;YACvD,CAAC;QACF,CAAC,CAAC,CAAC,CAAC;IACL,CAAC;IAEM,IAAI,CAAC,UAAkB,EAAE,QAAgB;QAC/C,IAAI,UAAU,GAAG,CAAC,EAAE,CAAC;YACpB,MAAM,IAAI,UAAU,CAAC,uBAAuB,UAAU,EAAE,CAAC,CAAC;QAC3D,CAAC;QAED,OAAO,IAAI,CAAC,MAAM,CAAC,IAAI,CACtB,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,UAAU,EAClC,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,EAAE,IAAI,CAAC,KAAK,CAAC,CACtD,CAAC;IACH,CAAC;IAEM,KAAK,CAAC,MAAc,EAAE,IAAc;QAC1C,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,MAAM,EAAE,IAAI,CAAC,CAAC;IAChE,CAAC;CACD","file":"debugMemory.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { clamp } from '../../../../base/common/numbers.js';\nimport { assertNever } from '../../../../base/common/assert.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { FileChangeType, IFileOpenOptions, FilePermission, FileSystemProviderCapabilities, FileSystemProviderErrorCode, FileType, IFileChange, IFileSystemProvider, IStat, IWatchOptions, createFileSystemProviderError } from '../../../../platform/files/common/files.js';\nimport { DEBUG_MEMORY_SCHEME, IDebugService, IDebugSession, IMemoryInvalidationEvent, IMemoryRegion, MemoryRange, MemoryRangeType, State } from '../common/debug.js';\n\nconst rangeRe = /range=([0-9]+):([0-9]+)/;\n\nexport class DebugMemoryFileSystemProvider extends Disposable implements IFileSystemProvider {\n\tprivate memoryFdCounter = 0;\n\tprivate readonly fdMemory = new Map<number, { session: IDebugSession; region: IMemoryRegion }>();\n\tprivate readonly changeEmitter = new Emitter<readonly IFileChange[]>();\n\n\t/** @inheritdoc */\n\tpublic readonly onDidChangeCapabilities = Event.None;\n\n\t/** @inheritdoc */\n\tpublic readonly onDidChangeFile = this.changeEmitter.event;\n\n\t/** @inheritdoc */\n\tpublic readonly capabilities = 0\n\t\t| FileSystemProviderCapabilities.PathCaseSensitive\n\t\t| FileSystemProviderCapabilities.FileOpenReadWriteClose;\n\n\tconstructor(private readonly debugService: IDebugService) {\n\t\tsuper();\n\n\t\tthis._register(debugService.onDidEndSession(({ session }) => {\n\t\t\tfor (const [fd, memory] of this.fdMemory) {\n\t\t\t\tif (memory.session === session) {\n\t\t\t\t\tthis.close(fd);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tpublic watch(resource: URI, opts: IWatchOptions) {\n\t\tif (opts.recursive) {\n\t\t\treturn toDisposable(() => { });\n\t\t}\n\n\t\tconst { session, memoryReference, offset } = this.parseUri(resource);\n\t\tconst disposable = new DisposableStore();\n\n\t\tdisposable.add(session.onDidChangeState(() => {\n\t\t\tif (session.state === State.Running || session.state === State.Inactive) {\n\t\t\t\tthis.changeEmitter.fire([{ type: FileChangeType.DELETED, resource }]);\n\t\t\t}\n\t\t}));\n\n\t\tdisposable.add(session.onDidInvalidateMemory(e => {\n\t\t\tif (e.body.memoryReference !== memoryReference) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (offset && (e.body.offset >= offset.toOffset || e.body.offset + e.body.count < offset.fromOffset)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.changeEmitter.fire([{ resource, type: FileChangeType.UPDATED }]);\n\t\t}));\n\n\t\treturn disposable;\n\t}\n\n\t/** @inheritdoc */\n\tpublic stat(file: URI): Promise<IStat> {\n\t\tconst { readOnly } = this.parseUri(file);\n\t\treturn Promise.resolve({\n\t\t\ttype: FileType.File,\n\t\t\tmtime: 0,\n\t\t\tctime: 0,\n\t\t\tsize: 0,\n\t\t\tpermissions: readOnly ? FilePermission.Readonly : undefined,\n\t\t});\n\t}\n\n\t/** @inheritdoc */\n\tpublic mkdir(): never {\n\t\tthrow createFileSystemProviderError(`Not allowed`, FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\t/** @inheritdoc */\n\tpublic readdir(): never {\n\t\tthrow createFileSystemProviderError(`Not allowed`, FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\t/** @inheritdoc */\n\tpublic delete(): never {\n\t\tthrow createFileSystemProviderError(`Not allowed`, FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\t/** @inheritdoc */\n\tpublic rename(): never {\n\t\tthrow createFileSystemProviderError(`Not allowed`, FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\t/** @inheritdoc */\n\tpublic open(resource: URI, _opts: IFileOpenOptions): Promise<number> {\n\t\tconst { session, memoryReference, offset } = this.parseUri(resource);\n\t\tconst fd = this.memoryFdCounter++;\n\t\tlet region = session.getMemory(memoryReference);\n\t\tif (offset) {\n\t\t\tregion = new MemoryRegionView(region, offset);\n\t\t}\n\n\t\tthis.fdMemory.set(fd, { session, region });\n\t\treturn Promise.resolve(fd);\n\t}\n\n\t/** @inheritdoc */\n\tpublic close(fd: number) {\n\t\tthis.fdMemory.get(fd)?.region.dispose();\n\t\tthis.fdMemory.delete(fd);\n\t\treturn Promise.resolve();\n\t}\n\n\t/** @inheritdoc */\n\tpublic async writeFile(resource: URI, content: Uint8Array) {\n\t\tconst { offset } = this.parseUri(resource);\n\t\tif (!offset) {\n\t\t\tthrow createFileSystemProviderError(`Range must be present to read a file`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst fd = await this.open(resource, { create: false });\n\n\t\ttry {\n\t\t\tawait this.write(fd, offset.fromOffset, content, 0, content.length);\n\t\t} finally {\n\t\t\tthis.close(fd);\n\t\t}\n\t}\n\n\t/** @inheritdoc */\n\tpublic async readFile(resource: URI) {\n\t\tconst { offset } = this.parseUri(resource);\n\t\tif (!offset) {\n\t\t\tthrow createFileSystemProviderError(`Range must be present to read a file`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst data = new Uint8Array(offset.toOffset - offset.fromOffset);\n\t\tconst fd = await this.open(resource, { create: false });\n\n\t\ttry {\n\t\t\tawait this.read(fd, offset.fromOffset, data, 0, data.length);\n\t\t\treturn data;\n\t\t} finally {\n\t\t\tthis.close(fd);\n\t\t}\n\t}\n\n\t/** @inheritdoc */\n\tpublic async read(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number> {\n\t\tconst memory = this.fdMemory.get(fd);\n\t\tif (!memory) {\n\t\t\tthrow createFileSystemProviderError(`No file with that descriptor open`, FileSystemProviderErrorCode.Unavailable);\n\t\t}\n\n\t\tconst ranges = await memory.region.read(pos, length);\n\t\tlet readSoFar = 0;\n\t\tfor (const range of ranges) {\n\t\t\tswitch (range.type) {\n\t\t\t\tcase MemoryRangeType.Unreadable:\n\t\t\t\t\treturn readSoFar;\n\t\t\t\tcase MemoryRangeType.Error:\n\t\t\t\t\tif (readSoFar > 0) {\n\t\t\t\t\t\treturn readSoFar;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow createFileSystemProviderError(range.error, FileSystemProviderErrorCode.Unknown);\n\t\t\t\t\t}\n\t\t\t\tcase MemoryRangeType.Valid: {\n\t\t\t\t\tconst start = Math.max(0, pos - range.offset);\n\t\t\t\t\tconst toWrite = range.data.slice(start, Math.min(range.data.byteLength, start + (length - readSoFar)));\n\t\t\t\t\tdata.set(toWrite.buffer, offset + readSoFar);\n\t\t\t\t\treadSoFar += toWrite.byteLength;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\tassertNever(range);\n\t\t\t}\n\t\t}\n\n\t\treturn readSoFar;\n\t}\n\n\t/** @inheritdoc */\n\tpublic write(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number> {\n\t\tconst memory = this.fdMemory.get(fd);\n\t\tif (!memory) {\n\t\t\tthrow createFileSystemProviderError(`No file with that descriptor open`, FileSystemProviderErrorCode.Unavailable);\n\t\t}\n\n\t\treturn memory.region.write(pos, VSBuffer.wrap(data).slice(offset, offset + length));\n\t}\n\n\tprotected parseUri(uri: URI) {\n\t\tif (uri.scheme !== DEBUG_MEMORY_SCHEME) {\n\t\t\tthrow createFileSystemProviderError(`Cannot open file with scheme ${uri.scheme}`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst session = this.debugService.getModel().getSession(uri.authority);\n\t\tif (!session) {\n\t\t\tthrow createFileSystemProviderError(`Debug session not found`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tlet offset: { fromOffset: number; toOffset: number } | undefined;\n\t\tconst rangeMatch = rangeRe.exec(uri.query);\n\t\tif (rangeMatch) {\n\t\t\toffset = { fromOffset: Number(rangeMatch[1]), toOffset: Number(rangeMatch[2]) };\n\t\t}\n\n\t\tconst [, memoryReference] = uri.path.split('/');\n\n\t\treturn {\n\t\t\tsession,\n\t\t\toffset,\n\t\t\treadOnly: !session.capabilities.supportsWriteMemoryRequest,\n\t\t\tsessionId: uri.authority,\n\t\t\tmemoryReference: decodeURIComponent(memoryReference),\n\t\t};\n\t}\n}\n\n/** A wrapper for a MemoryRegion that references a subset of data in another region. */\nclass MemoryRegionView extends Disposable implements IMemoryRegion {\n\tprivate readonly invalidateEmitter = new Emitter<IMemoryInvalidationEvent>();\n\n\tpublic readonly onDidInvalidate = this.invalidateEmitter.event;\n\tpublic readonly writable: boolean;\n\tprivate readonly width: number;\n\n\tconstructor(private readonly parent: IMemoryRegion, public readonly range: { fromOffset: number; toOffset: number }) {\n\t\tsuper();\n\t\tthis.writable = parent.writable;\n\t\tthis.width = range.toOffset - range.fromOffset;\n\n\t\tthis._register(parent);\n\t\tthis._register(parent.onDidInvalidate(e => {\n\t\t\tconst fromOffset = clamp(e.fromOffset - range.fromOffset, 0, this.width);\n\t\t\tconst toOffset = clamp(e.toOffset - range.fromOffset, 0, this.width);\n\t\t\tif (toOffset > fromOffset) {\n\t\t\t\tthis.invalidateEmitter.fire({ fromOffset, toOffset });\n\t\t\t}\n\t\t}));\n\t}\n\n\tpublic read(fromOffset: number, toOffset: number): Promise<MemoryRange[]> {\n\t\tif (fromOffset < 0) {\n\t\t\tthrow new RangeError(`Invalid fromOffset: ${fromOffset}`);\n\t\t}\n\n\t\treturn this.parent.read(\n\t\t\tthis.range.fromOffset + fromOffset,\n\t\t\tthis.range.fromOffset + Math.min(toOffset, this.width),\n\t\t);\n\t}\n\n\tpublic write(offset: number, data: VSBuffer): Promise<number> {\n\t\treturn this.parent.write(this.range.fromOffset + offset, data);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { clamp } from '../../../../base/common/numbers.js';\nimport { assertNever } from '../../../../base/common/assert.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { FileChangeType, IFileOpenOptions, FilePermission, FileSystemProviderCapabilities, FileSystemProviderErrorCode, FileType, IFileChange, IFileSystemProvider, IStat, IWatchOptions, createFileSystemProviderError } from '../../../../platform/files/common/files.js';\nimport { DEBUG_MEMORY_SCHEME, IDebugService, IDebugSession, IMemoryInvalidationEvent, IMemoryRegion, MemoryRange, MemoryRangeType, State } from '../common/debug.js';\n\nconst rangeRe = /range=([0-9]+):([0-9]+)/;\n\nexport class DebugMemoryFileSystemProvider extends Disposable implements IFileSystemProvider {\n\tprivate memoryFdCounter = 0;\n\tprivate readonly fdMemory = new Map<number, { session: IDebugSession; region: IMemoryRegion }>();\n\tprivate readonly changeEmitter = new Emitter<readonly IFileChange[]>();\n\n\t/** @inheritdoc */\n\tpublic readonly onDidChangeCapabilities = Event.None;\n\n\t/** @inheritdoc */\n\tpublic readonly onDidChangeFile = this.changeEmitter.event;\n\n\t/** @inheritdoc */\n\tpublic readonly capabilities = 0\n\t\t| FileSystemProviderCapabilities.PathCaseSensitive\n\t\t| FileSystemProviderCapabilities.FileOpenReadWriteClose;\n\n\tconstructor(private readonly debugService: IDebugService) {\n\t\tsuper();\n\n\t\tthis._register(debugService.onDidEndSession(({ session }) => {\n\t\t\tfor (const [fd, memory] of this.fdMemory) {\n\t\t\t\tif (memory.session === session) {\n\t\t\t\t\tthis.close(fd);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tpublic watch(resource: URI, opts: IWatchOptions) {\n\t\tif (opts.recursive) {\n\t\t\treturn toDisposable(() => { });\n\t\t}\n\n\t\tconst { session, memoryReference, offset } = this.parseUri(resource);\n\t\tconst disposable = new DisposableStore();\n\n\t\tdisposable.add(session.onDidChangeState(() => {\n\t\t\tif (session.state === State.Running || session.state === State.Inactive) {\n\t\t\t\tthis.changeEmitter.fire([{ type: FileChangeType.DELETED, resource }]);\n\t\t\t}\n\t\t}));\n\n\t\tdisposable.add(session.onDidInvalidateMemory(e => {\n\t\t\tif (e.body.memoryReference !== memoryReference) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (offset && (e.body.offset >= offset.toOffset || e.body.offset + e.body.count < offset.fromOffset)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.changeEmitter.fire([{ resource, type: FileChangeType.UPDATED }]);\n\t\t}));\n\n\t\treturn disposable;\n\t}\n\n\t/** @inheritdoc */\n\tpublic stat(file: URI): Promise<IStat> {\n\t\tconst { readOnly } = this.parseUri(file);\n\t\treturn Promise.resolve({\n\t\t\ttype: FileType.File,\n\t\t\tmtime: 0,\n\t\t\tctime: 0,\n\t\t\tsize: 0,\n\t\t\tpermissions: readOnly ? FilePermission.Readonly : undefined,\n\t\t});\n\t}\n\n\t/** @inheritdoc */\n\tpublic mkdir(): never {\n\t\tthrow createFileSystemProviderError(`Not allowed`, FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\t/** @inheritdoc */\n\tpublic readdir(): never {\n\t\tthrow createFileSystemProviderError(`Not allowed`, FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\t/** @inheritdoc */\n\tpublic delete(): never {\n\t\tthrow createFileSystemProviderError(`Not allowed`, FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\t/** @inheritdoc */\n\tpublic rename(): never {\n\t\tthrow createFileSystemProviderError(`Not allowed`, FileSystemProviderErrorCode.NoPermissions);\n\t}\n\n\t/** @inheritdoc */\n\tpublic open(resource: URI, _opts: IFileOpenOptions): Promise<number> {\n\t\tconst { session, memoryReference, offset } = this.parseUri(resource);\n\t\tconst fd = this.memoryFdCounter++;\n\t\tlet region = session.getMemory(memoryReference);\n\t\tif (offset) {\n\t\t\tregion = new MemoryRegionView(region, offset);\n\t\t}\n\n\t\tthis.fdMemory.set(fd, { session, region });\n\t\treturn Promise.resolve(fd);\n\t}\n\n\t/** @inheritdoc */\n\tpublic close(fd: number) {\n\t\tthis.fdMemory.get(fd)?.region.dispose();\n\t\tthis.fdMemory.delete(fd);\n\t\treturn Promise.resolve();\n\t}\n\n\t/** @inheritdoc */\n\tpublic async writeFile(resource: URI, content: Uint8Array) {\n\t\tconst { offset } = this.parseUri(resource);\n\t\tif (!offset) {\n\t\t\tthrow createFileSystemProviderError(`Range must be present to read a file`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst fd = await this.open(resource, { create: false });\n\n\t\ttry {\n\t\t\tawait this.write(fd, offset.fromOffset, content, 0, content.length);\n\t\t} finally {\n\t\t\tthis.close(fd);\n\t\t}\n\t}\n\n\t/** @inheritdoc */\n\tpublic async readFile(resource: URI) {\n\t\tconst { offset } = this.parseUri(resource);\n\t\tif (!offset) {\n\t\t\tthrow createFileSystemProviderError(`Range must be present to read a file`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst data = new Uint8Array(offset.toOffset - offset.fromOffset);\n\t\tconst fd = await this.open(resource, { create: false });\n\n\t\ttry {\n\t\t\tawait this.read(fd, offset.fromOffset, data, 0, data.length);\n\t\t\treturn data;\n\t\t} finally {\n\t\t\tthis.close(fd);\n\t\t}\n\t}\n\n\t/** @inheritdoc */\n\tpublic async read(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number> {\n\t\tconst memory = this.fdMemory.get(fd);\n\t\tif (!memory) {\n\t\t\tthrow createFileSystemProviderError(`No file with that descriptor open`, FileSystemProviderErrorCode.Unavailable);\n\t\t}\n\n\t\tconst ranges = await memory.region.read(pos, length);\n\t\tlet readSoFar = 0;\n\t\tfor (const range of ranges) {\n\t\t\tswitch (range.type) {\n\t\t\t\tcase MemoryRangeType.Unreadable:\n\t\t\t\t\treturn readSoFar;\n\t\t\t\tcase MemoryRangeType.Error:\n\t\t\t\t\tif (readSoFar > 0) {\n\t\t\t\t\t\treturn readSoFar;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow createFileSystemProviderError(range.error, FileSystemProviderErrorCode.Unknown);\n\t\t\t\t\t}\n\t\t\t\tcase MemoryRangeType.Valid: {\n\t\t\t\t\tconst start = Math.max(0, pos - range.offset);\n\t\t\t\t\tconst toWrite = range.data.slice(start, Math.min(range.data.byteLength, start + (length - readSoFar)));\n\t\t\t\t\tdata.set(toWrite.buffer, offset + readSoFar);\n\t\t\t\t\treadSoFar += toWrite.byteLength;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault:\n\t\t\t\t\tassertNever(range);\n\t\t\t}\n\t\t}\n\n\t\treturn readSoFar;\n\t}\n\n\t/** @inheritdoc */\n\tpublic write(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number> {\n\t\tconst memory = this.fdMemory.get(fd);\n\t\tif (!memory) {\n\t\t\tthrow createFileSystemProviderError(`No file with that descriptor open`, FileSystemProviderErrorCode.Unavailable);\n\t\t}\n\n\t\treturn memory.region.write(pos, VSBuffer.wrap(data).slice(offset, offset + length));\n\t}\n\n\tprotected parseUri(uri: URI) {\n\t\tif (uri.scheme !== DEBUG_MEMORY_SCHEME) {\n\t\t\tthrow createFileSystemProviderError(`Cannot open file with scheme ${uri.scheme}`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tconst session = this.debugService.getModel().getSession(uri.authority);\n\t\tif (!session) {\n\t\t\tthrow createFileSystemProviderError(`Debug session not found`, FileSystemProviderErrorCode.FileNotFound);\n\t\t}\n\n\t\tlet offset: { fromOffset: number; toOffset: number } | undefined;\n\t\tconst rangeMatch = rangeRe.exec(uri.query);\n\t\tif (rangeMatch) {\n\t\t\toffset = { fromOffset: Number(rangeMatch[1]), toOffset: Number(rangeMatch[2]) };\n\t\t}\n\n\t\tconst [, memoryReference] = uri.path.split('/');\n\n\t\treturn {\n\t\t\tsession,\n\t\t\toffset,\n\t\t\treadOnly: !session.capabilities.supportsWriteMemoryRequest,\n\t\t\tsessionId: uri.authority,\n\t\t\tmemoryReference: decodeURIComponent(memoryReference),\n\t\t};\n\t}\n}\n\n/** A wrapper for a MemoryRegion that references a subset of data in another region. */\nclass MemoryRegionView extends Disposable implements IMemoryRegion {\n\tprivate readonly invalidateEmitter = new Emitter<IMemoryInvalidationEvent>();\n\n\tpublic readonly onDidInvalidate = this.invalidateEmitter.event;\n\tpublic readonly writable: boolean;\n\tprivate readonly width: number;\n\n\tconstructor(private readonly parent: IMemoryRegion, public readonly range: { fromOffset: number; toOffset: number }) {\n\t\tsuper();\n\t\tthis.writable = parent.writable;\n\t\tthis.width = range.toOffset - range.fromOffset;\n\n\t\tthis._register(parent);\n\t\tthis._register(parent.onDidInvalidate(e => {\n\t\t\tconst fromOffset = clamp(e.fromOffset - range.fromOffset, 0, this.width);\n\t\t\tconst toOffset = clamp(e.toOffset - range.fromOffset, 0, this.width);\n\t\t\tif (toOffset > fromOffset) {\n\t\t\t\tthis.invalidateEmitter.fire({ fromOffset, toOffset });\n\t\t\t}\n\t\t}));\n\t}\n\n\tpublic read(fromOffset: number, toOffset: number): Promise<MemoryRange[]> {\n\t\tif (fromOffset < 0) {\n\t\t\tthrow new RangeError(`Invalid fromOffset: ${fromOffset}`);\n\t\t}\n\n\t\treturn this.parent.read(\n\t\t\tthis.range.fromOffset + fromOffset,\n\t\t\tthis.range.fromOffset + Math.min(toOffset, this.width),\n\t\t);\n\t}\n\n\tpublic write(offset: number, data: VSBuffer): Promise<number> {\n\t\treturn this.parent.write(this.range.fromOffset + offset, data);\n\t}\n}\n"]}