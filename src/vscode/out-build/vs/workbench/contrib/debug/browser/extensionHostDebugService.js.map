{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/debug/browser/extensionHostDebugService.ts","vs/workbench/contrib/debug/browser/extensionHostDebugService.ts"],"names":[],"mappings":"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","file":"extensionHostDebugService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from '../../../../base/common/event.js';\nimport { URI, UriComponents } from '../../../../base/common/uri.js';\nimport { IChannel } from '../../../../base/parts/ipc/common/ipc.js';\nimport { IExtensionHostDebugService, IOpenExtensionWindowResult } from '../../../../platform/debug/common/extensionHostDebug.js';\nimport { ExtensionHostDebugBroadcastChannel, ExtensionHostDebugChannelClient } from '../../../../platform/debug/common/extensionHostDebugIpc.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { isFolderToOpen, isWorkspaceToOpen } from '../../../../platform/window/common/window.js';\nimport { IWorkspaceContextService, isSingleFolderWorkspaceIdentifier, isWorkspaceIdentifier, toWorkspaceIdentifier, hasWorkspaceFileExtension } from '../../../../platform/workspace/common/workspace.js';\nimport { IWorkspace, IWorkspaceProvider } from '../../../browser/web.api.js';\nimport { IBrowserWorkbenchEnvironmentService } from '../../../services/environment/browser/environmentService.js';\nimport { IHostService } from '../../../services/host/browser/host.js';\nimport { IRemoteAgentService } from '../../../services/remote/common/remoteAgentService.js';\n\nclass BrowserExtensionHostDebugService extends ExtensionHostDebugChannelClient implements IExtensionHostDebugService {\n\n\tprivate static readonly LAST_EXTENSION_DEVELOPMENT_WORKSPACE_KEY = 'debug.lastExtensionDevelopmentWorkspace';\n\n\tprivate workspaceProvider: IWorkspaceProvider;\n\n\tprivate readonly storageService: IStorageService;\n\tprivate readonly fileService: IFileService;\n\n\tconstructor(\n\t\t@IRemoteAgentService remoteAgentService: IRemoteAgentService,\n\t\t@IBrowserWorkbenchEnvironmentService environmentService: IBrowserWorkbenchEnvironmentService,\n\t\t@ILogService logService: ILogService,\n\t\t@IHostService hostService: IHostService,\n\t\t@IWorkspaceContextService contextService: IWorkspaceContextService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IFileService fileService: IFileService\n\t) {\n\t\tconst connection = remoteAgentService.getConnection();\n\t\tlet channel: IChannel;\n\t\tif (connection) {\n\t\t\tchannel = connection.getChannel(ExtensionHostDebugBroadcastChannel.ChannelName);\n\t\t} else {\n\t\t\t// Extension host debugging not supported in serverless.\n\t\t\tchannel = { call: async () => Promise.resolve(undefined!), listen: () => Event.None };\n\t\t}\n\n\t\tsuper(channel);\n\n\t\tthis.storageService = storageService;\n\t\tthis.fileService = fileService;\n\n\t\tif (environmentService.options && environmentService.options.workspaceProvider) {\n\t\t\tthis.workspaceProvider = environmentService.options.workspaceProvider;\n\t\t} else {\n\t\t\tthis.workspaceProvider = { open: async () => true, workspace: undefined, trusted: undefined };\n\t\t\tlogService.warn('Extension Host Debugging not available due to missing workspace provider.');\n\t\t}\n\n\t\t// Reload window on reload request\n\t\tthis._register(this.onReload(event => {\n\t\t\tif (environmentService.isExtensionDevelopment && environmentService.debugExtensionHost.debugId === event.sessionId) {\n\t\t\t\thostService.reload();\n\t\t\t}\n\t\t}));\n\n\t\t// Close window on close request\n\t\tthis._register(this.onClose(event => {\n\t\t\tif (environmentService.isExtensionDevelopment && environmentService.debugExtensionHost.debugId === event.sessionId) {\n\t\t\t\thostService.close();\n\t\t\t}\n\t\t}));\n\n\t\t// Remember workspace as last used for extension development\n\t\t// (unless this is API tests) to restore for a future session\n\t\tif (environmentService.isExtensionDevelopment && !environmentService.extensionTestsLocationURI) {\n\t\t\tconst workspaceId = toWorkspaceIdentifier(contextService.getWorkspace());\n\t\t\tif (isSingleFolderWorkspaceIdentifier(workspaceId) || isWorkspaceIdentifier(workspaceId)) {\n\t\t\t\tconst serializedWorkspace = isSingleFolderWorkspaceIdentifier(workspaceId) ? { folderUri: workspaceId.uri.toJSON() } : { workspaceUri: workspaceId.configPath.toJSON() };\n\t\t\t\tstorageService.store(BrowserExtensionHostDebugService.LAST_EXTENSION_DEVELOPMENT_WORKSPACE_KEY, JSON.stringify(serializedWorkspace), StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\t\t} else {\n\t\t\t\tstorageService.remove(BrowserExtensionHostDebugService.LAST_EXTENSION_DEVELOPMENT_WORKSPACE_KEY, StorageScope.PROFILE);\n\t\t\t}\n\t\t}\n\t}\n\n\toverride async openExtensionDevelopmentHostWindow(args: string[], _debugRenderer: boolean): Promise<IOpenExtensionWindowResult> {\n\n\t\t// Add environment parameters required for debug to work\n\t\tconst environment = new Map<string, string>();\n\n\t\tconst fileUriArg = this.findArgument('file-uri', args);\n\t\tif (fileUriArg && !hasWorkspaceFileExtension(fileUriArg)) {\n\t\t\tenvironment.set('openFile', fileUriArg);\n\t\t}\n\n\t\tconst copyArgs = [\n\t\t\t'extensionDevelopmentPath',\n\t\t\t'extensionTestsPath',\n\t\t\t'extensionEnvironment',\n\t\t\t'debugId',\n\t\t\t'inspect-brk-extensions',\n\t\t\t'inspect-extensions',\n\t\t];\n\n\t\tfor (const argName of copyArgs) {\n\t\t\tconst value = this.findArgument(argName, args);\n\t\t\tif (value) {\n\t\t\t\tenvironment.set(argName, value);\n\t\t\t}\n\t\t}\n\n\t\t// Find out which workspace to open debug window on\n\t\tlet debugWorkspace: IWorkspace = undefined;\n\t\tconst folderUriArg = this.findArgument('folder-uri', args);\n\t\tif (folderUriArg) {\n\t\t\tdebugWorkspace = { folderUri: URI.parse(folderUriArg) };\n\t\t} else {\n\t\t\tconst fileUriArg = this.findArgument('file-uri', args);\n\t\t\tif (fileUriArg && hasWorkspaceFileExtension(fileUriArg)) {\n\t\t\t\tdebugWorkspace = { workspaceUri: URI.parse(fileUriArg) };\n\t\t\t}\n\t\t}\n\n\t\tconst extensionTestsPath = this.findArgument('extensionTestsPath', args);\n\t\tif (!debugWorkspace && !extensionTestsPath) {\n\t\t\tconst lastExtensionDevelopmentWorkspace = this.storageService.get(BrowserExtensionHostDebugService.LAST_EXTENSION_DEVELOPMENT_WORKSPACE_KEY, StorageScope.PROFILE);\n\t\t\tif (lastExtensionDevelopmentWorkspace) {\n\t\t\t\ttry {\n\t\t\t\t\tconst serializedWorkspace: { workspaceUri?: UriComponents; folderUri?: UriComponents } = JSON.parse(lastExtensionDevelopmentWorkspace);\n\t\t\t\t\tif (serializedWorkspace.workspaceUri) {\n\t\t\t\t\t\tdebugWorkspace = { workspaceUri: URI.revive(serializedWorkspace.workspaceUri) };\n\t\t\t\t\t} else if (serializedWorkspace.folderUri) {\n\t\t\t\t\t\tdebugWorkspace = { folderUri: URI.revive(serializedWorkspace.folderUri) };\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\t// ignore\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Validate workspace exists\n\t\tif (debugWorkspace) {\n\t\t\tconst debugWorkspaceResource = isFolderToOpen(debugWorkspace) ? debugWorkspace.folderUri : isWorkspaceToOpen(debugWorkspace) ? debugWorkspace.workspaceUri : undefined;\n\t\t\tif (debugWorkspaceResource) {\n\t\t\t\tconst workspaceExists = await this.fileService.exists(debugWorkspaceResource);\n\t\t\t\tif (!workspaceExists) {\n\t\t\t\t\tdebugWorkspace = undefined;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Open debug window as new window. Pass arguments over.\n\t\tconst success = await this.workspaceProvider.open(debugWorkspace, {\n\t\t\treuse: false, \t\t\t\t\t\t\t\t// debugging always requires a new window\n\t\t\tpayload: Array.from(environment.entries())\t// mandatory properties to enable debugging\n\t\t});\n\n\t\treturn { success };\n\t}\n\n\tprivate findArgument(key: string, args: string[]): string | undefined {\n\t\tfor (const a of args) {\n\t\t\tconst k = `--${key}=`;\n\t\t\tif (a.indexOf(k) === 0) {\n\t\t\t\treturn a.substring(k.length);\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n}\n\nregisterSingleton(IExtensionHostDebugService, BrowserExtensionHostDebugService, InstantiationType.Delayed);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from '../../../../base/common/event.js';\nimport { URI, UriComponents } from '../../../../base/common/uri.js';\nimport { IChannel } from '../../../../base/parts/ipc/common/ipc.js';\nimport { IExtensionHostDebugService, IOpenExtensionWindowResult } from '../../../../platform/debug/common/extensionHostDebug.js';\nimport { ExtensionHostDebugBroadcastChannel, ExtensionHostDebugChannelClient } from '../../../../platform/debug/common/extensionHostDebugIpc.js';\nimport { IFileService } from '../../../../platform/files/common/files.js';\nimport { InstantiationType, registerSingleton } from '../../../../platform/instantiation/common/extensions.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../../../platform/storage/common/storage.js';\nimport { isFolderToOpen, isWorkspaceToOpen } from '../../../../platform/window/common/window.js';\nimport { IWorkspaceContextService, isSingleFolderWorkspaceIdentifier, isWorkspaceIdentifier, toWorkspaceIdentifier, hasWorkspaceFileExtension } from '../../../../platform/workspace/common/workspace.js';\nimport { IWorkspace, IWorkspaceProvider } from '../../../browser/web.api.js';\nimport { IBrowserWorkbenchEnvironmentService } from '../../../services/environment/browser/environmentService.js';\nimport { IHostService } from '../../../services/host/browser/host.js';\nimport { IRemoteAgentService } from '../../../services/remote/common/remoteAgentService.js';\n\nclass BrowserExtensionHostDebugService extends ExtensionHostDebugChannelClient implements IExtensionHostDebugService {\n\n\tprivate static readonly LAST_EXTENSION_DEVELOPMENT_WORKSPACE_KEY = 'debug.lastExtensionDevelopmentWorkspace';\n\n\tprivate workspaceProvider: IWorkspaceProvider;\n\n\tprivate readonly storageService: IStorageService;\n\tprivate readonly fileService: IFileService;\n\n\tconstructor(\n\t\t@IRemoteAgentService remoteAgentService: IRemoteAgentService,\n\t\t@IBrowserWorkbenchEnvironmentService environmentService: IBrowserWorkbenchEnvironmentService,\n\t\t@ILogService logService: ILogService,\n\t\t@IHostService hostService: IHostService,\n\t\t@IWorkspaceContextService contextService: IWorkspaceContextService,\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IFileService fileService: IFileService\n\t) {\n\t\tconst connection = remoteAgentService.getConnection();\n\t\tlet channel: IChannel;\n\t\tif (connection) {\n\t\t\tchannel = connection.getChannel(ExtensionHostDebugBroadcastChannel.ChannelName);\n\t\t} else {\n\t\t\t// Extension host debugging not supported in serverless.\n\t\t\tchannel = { call: async () => Promise.resolve(undefined!), listen: () => Event.None };\n\t\t}\n\n\t\tsuper(channel);\n\n\t\tthis.storageService = storageService;\n\t\tthis.fileService = fileService;\n\n\t\tif (environmentService.options && environmentService.options.workspaceProvider) {\n\t\t\tthis.workspaceProvider = environmentService.options.workspaceProvider;\n\t\t} else {\n\t\t\tthis.workspaceProvider = { open: async () => true, workspace: undefined, trusted: undefined };\n\t\t\tlogService.warn('Extension Host Debugging not available due to missing workspace provider.');\n\t\t}\n\n\t\t// Reload window on reload request\n\t\tthis._register(this.onReload(event => {\n\t\t\tif (environmentService.isExtensionDevelopment && environmentService.debugExtensionHost.debugId === event.sessionId) {\n\t\t\t\thostService.reload();\n\t\t\t}\n\t\t}));\n\n\t\t// Close window on close request\n\t\tthis._register(this.onClose(event => {\n\t\t\tif (environmentService.isExtensionDevelopment && environmentService.debugExtensionHost.debugId === event.sessionId) {\n\t\t\t\thostService.close();\n\t\t\t}\n\t\t}));\n\n\t\t// Remember workspace as last used for extension development\n\t\t// (unless this is API tests) to restore for a future session\n\t\tif (environmentService.isExtensionDevelopment && !environmentService.extensionTestsLocationURI) {\n\t\t\tconst workspaceId = toWorkspaceIdentifier(contextService.getWorkspace());\n\t\t\tif (isSingleFolderWorkspaceIdentifier(workspaceId) || isWorkspaceIdentifier(workspaceId)) {\n\t\t\t\tconst serializedWorkspace = isSingleFolderWorkspaceIdentifier(workspaceId) ? { folderUri: workspaceId.uri.toJSON() } : { workspaceUri: workspaceId.configPath.toJSON() };\n\t\t\t\tstorageService.store(BrowserExtensionHostDebugService.LAST_EXTENSION_DEVELOPMENT_WORKSPACE_KEY, JSON.stringify(serializedWorkspace), StorageScope.PROFILE, StorageTarget.MACHINE);\n\t\t\t} else {\n\t\t\t\tstorageService.remove(BrowserExtensionHostDebugService.LAST_EXTENSION_DEVELOPMENT_WORKSPACE_KEY, StorageScope.PROFILE);\n\t\t\t}\n\t\t}\n\t}\n\n\toverride async openExtensionDevelopmentHostWindow(args: string[], _debugRenderer: boolean): Promise<IOpenExtensionWindowResult> {\n\n\t\t// Add environment parameters required for debug to work\n\t\tconst environment = new Map<string, string>();\n\n\t\tconst fileUriArg = this.findArgument('file-uri', args);\n\t\tif (fileUriArg && !hasWorkspaceFileExtension(fileUriArg)) {\n\t\t\tenvironment.set('openFile', fileUriArg);\n\t\t}\n\n\t\tconst copyArgs = [\n\t\t\t'extensionDevelopmentPath',\n\t\t\t'extensionTestsPath',\n\t\t\t'extensionEnvironment',\n\t\t\t'debugId',\n\t\t\t'inspect-brk-extensions',\n\t\t\t'inspect-extensions',\n\t\t];\n\n\t\tfor (const argName of copyArgs) {\n\t\t\tconst value = this.findArgument(argName, args);\n\t\t\tif (value) {\n\t\t\t\tenvironment.set(argName, value);\n\t\t\t}\n\t\t}\n\n\t\t// Find out which workspace to open debug window on\n\t\tlet debugWorkspace: IWorkspace = undefined;\n\t\tconst folderUriArg = this.findArgument('folder-uri', args);\n\t\tif (folderUriArg) {\n\t\t\tdebugWorkspace = { folderUri: URI.parse(folderUriArg) };\n\t\t} else {\n\t\t\tconst fileUriArg = this.findArgument('file-uri', args);\n\t\t\tif (fileUriArg && hasWorkspaceFileExtension(fileUriArg)) {\n\t\t\t\tdebugWorkspace = { workspaceUri: URI.parse(fileUriArg) };\n\t\t\t}\n\t\t}\n\n\t\tconst extensionTestsPath = this.findArgument('extensionTestsPath', args);\n\t\tif (!debugWorkspace && !extensionTestsPath) {\n\t\t\tconst lastExtensionDevelopmentWorkspace = this.storageService.get(BrowserExtensionHostDebugService.LAST_EXTENSION_DEVELOPMENT_WORKSPACE_KEY, StorageScope.PROFILE);\n\t\t\tif (lastExtensionDevelopmentWorkspace) {\n\t\t\t\ttry {\n\t\t\t\t\tconst serializedWorkspace: { workspaceUri?: UriComponents; folderUri?: UriComponents } = JSON.parse(lastExtensionDevelopmentWorkspace);\n\t\t\t\t\tif (serializedWorkspace.workspaceUri) {\n\t\t\t\t\t\tdebugWorkspace = { workspaceUri: URI.revive(serializedWorkspace.workspaceUri) };\n\t\t\t\t\t} else if (serializedWorkspace.folderUri) {\n\t\t\t\t\t\tdebugWorkspace = { folderUri: URI.revive(serializedWorkspace.folderUri) };\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\t// ignore\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Validate workspace exists\n\t\tif (debugWorkspace) {\n\t\t\tconst debugWorkspaceResource = isFolderToOpen(debugWorkspace) ? debugWorkspace.folderUri : isWorkspaceToOpen(debugWorkspace) ? debugWorkspace.workspaceUri : undefined;\n\t\t\tif (debugWorkspaceResource) {\n\t\t\t\tconst workspaceExists = await this.fileService.exists(debugWorkspaceResource);\n\t\t\t\tif (!workspaceExists) {\n\t\t\t\t\tdebugWorkspace = undefined;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Open debug window as new window. Pass arguments over.\n\t\tconst success = await this.workspaceProvider.open(debugWorkspace, {\n\t\t\treuse: false, \t\t\t\t\t\t\t\t// debugging always requires a new window\n\t\t\tpayload: Array.from(environment.entries())\t// mandatory properties to enable debugging\n\t\t});\n\n\t\treturn { success };\n\t}\n\n\tprivate findArgument(key: string, args: string[]): string | undefined {\n\t\tfor (const a of args) {\n\t\t\tconst k = `--${key}=`;\n\t\t\tif (a.indexOf(k) === 0) {\n\t\t\t\treturn a.substring(k.length);\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n}\n\nregisterSingleton(IExtensionHostDebugService, BrowserExtensionHostDebugService, InstantiationType.Delayed);\n"]}