{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/customEditor/browser/customEditorInputFactory.ts","vs/workbench/contrib/customEditor/browser/customEditorInputFactory.ts"],"names":[],"mappings":"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","file":"customEditorInputFactory.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { isEqual } from '../../../../base/common/resources.js';\nimport { URI, UriComponents } from '../../../../base/common/uri.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { EditorInput } from '../../../common/editor/editorInput.js';\nimport { CustomEditorInput } from './customEditorInput.js';\nimport { ICustomEditorService } from '../common/customEditor.js';\nimport { NotebookEditorInput } from '../../notebook/common/notebookEditorInput.js';\nimport { IWebviewService, WebviewContentOptions, WebviewContentPurpose, WebviewExtensionDescription, WebviewOptions } from '../../webview/browser/webview.js';\nimport { DeserializedWebview, restoreWebviewContentOptions, restoreWebviewOptions, reviveWebviewExtensionDescription, SerializedWebview, SerializedWebviewOptions, WebviewEditorInputSerializer } from '../../webviewPanel/browser/webviewEditorInputSerializer.js';\nimport { IWebviewWorkbenchService } from '../../webviewPanel/browser/webviewWorkbenchService.js';\nimport { IWorkingCopyBackupMeta, IWorkingCopyIdentifier } from '../../../services/workingCopy/common/workingCopy.js';\nimport { IWorkingCopyBackupService } from '../../../services/workingCopy/common/workingCopyBackup.js';\nimport { IWorkingCopyEditorHandler, IWorkingCopyEditorService } from '../../../services/workingCopy/common/workingCopyEditorService.js';\n\nexport interface CustomDocumentBackupData extends IWorkingCopyBackupMeta {\n\treadonly viewType: string;\n\treadonly editorResource: UriComponents;\n\n\treadonly customTitle: string | undefined;\n\treadonly iconPath: { dark: UriComponents; light: UriComponents } | undefined;\n\n\tbackupId: string;\n\n\treadonly extension: undefined | {\n\t\treadonly location: UriComponents;\n\t\treadonly id: string;\n\t};\n\n\treadonly webview: {\n\t\treadonly origin: string | undefined;\n\t\treadonly options: SerializedWebviewOptions;\n\t\treadonly state: any;\n\t};\n}\n\ninterface SerializedCustomEditor extends SerializedWebview {\n\treadonly editorResource: UriComponents;\n\treadonly dirty: boolean;\n\treadonly backupId?: string;\n}\n\ninterface DeserializedCustomEditor extends DeserializedWebview {\n\treadonly editorResource: URI;\n\treadonly dirty: boolean;\n\treadonly backupId?: string;\n}\n\nexport class CustomEditorInputSerializer extends WebviewEditorInputSerializer {\n\n\tpublic static override readonly ID = CustomEditorInput.typeId;\n\n\tpublic constructor(\n\t\t@IWebviewWorkbenchService webviewWorkbenchService: IWebviewWorkbenchService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IWebviewService private readonly _webviewService: IWebviewService,\n\t) {\n\t\tsuper(webviewWorkbenchService);\n\t}\n\n\tpublic override serialize(input: CustomEditorInput): string | undefined {\n\t\tconst dirty = input.isDirty();\n\t\tconst data: SerializedCustomEditor = {\n\t\t\t...this.toJson(input),\n\t\t\teditorResource: input.resource.toJSON(),\n\t\t\tdirty,\n\t\t\tbackupId: dirty ? input.backupId : undefined,\n\t\t};\n\n\t\ttry {\n\t\t\treturn JSON.stringify(data);\n\t\t} catch {\n\t\t\treturn undefined;\n\t\t}\n\t}\n\n\tprotected override fromJson(data: SerializedCustomEditor): DeserializedCustomEditor {\n\t\treturn {\n\t\t\t...super.fromJson(data),\n\t\t\teditorResource: URI.from(data.editorResource),\n\t\t\tdirty: data.dirty,\n\t\t};\n\t}\n\n\tpublic override deserialize(\n\t\t_instantiationService: IInstantiationService,\n\t\tserializedEditorInput: string\n\t): CustomEditorInput {\n\t\tconst data = this.fromJson(JSON.parse(serializedEditorInput));\n\n\t\tconst webview = reviveWebview(this._webviewService, data);\n\t\tconst customInput = this._instantiationService.createInstance(CustomEditorInput, {\n\t\t\tresource: data.editorResource,\n\t\t\tviewType: data.viewType,\n\t\t\twebviewTitle: data.title,\n\t\t\ticonPath: data.iconPath,\n\t\t}, webview, { startsDirty: data.dirty, backupId: data.backupId });\n\t\tif (typeof data.group === 'number') {\n\t\t\tcustomInput.updateGroup(data.group);\n\t\t}\n\t\treturn customInput;\n\t}\n}\n\nfunction reviveWebview(webviewService: IWebviewService, data: { origin: string | undefined; viewType: string; state: any; webviewOptions: WebviewOptions; contentOptions: WebviewContentOptions; extension?: WebviewExtensionDescription; title: string | undefined }) {\n\tconst webview = webviewService.createWebviewOverlay({\n\t\tprovidedViewType: data.viewType,\n\t\torigin: data.origin,\n\t\ttitle: data.title,\n\t\toptions: {\n\t\t\tpurpose: WebviewContentPurpose.CustomEditor,\n\t\t\tenableFindWidget: data.webviewOptions.enableFindWidget,\n\t\t\tretainContextWhenHidden: data.webviewOptions.retainContextWhenHidden,\n\t\t},\n\t\tcontentOptions: data.contentOptions,\n\t\textension: data.extension,\n\t});\n\twebview.state = data.state;\n\treturn webview;\n}\n\nexport class ComplexCustomWorkingCopyEditorHandler extends Disposable implements IWorkbenchContribution, IWorkingCopyEditorHandler {\n\n\tstatic readonly ID = 'workbench.contrib.complexCustomWorkingCopyEditorHandler';\n\n\tconstructor(\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IWorkingCopyEditorService _workingCopyEditorService: IWorkingCopyEditorService,\n\t\t@IWorkingCopyBackupService private readonly _workingCopyBackupService: IWorkingCopyBackupService,\n\t\t@IWebviewService private readonly _webviewService: IWebviewService,\n\t\t@ICustomEditorService _customEditorService: ICustomEditorService // DO NOT REMOVE (needed on startup to register overrides properly)\n\t) {\n\t\tsuper();\n\n\t\tthis._register(_workingCopyEditorService.registerHandler(this));\n\t}\n\n\thandles(workingCopy: IWorkingCopyIdentifier): boolean {\n\t\treturn workingCopy.resource.scheme === Schemas.vscodeCustomEditor;\n\t}\n\n\tisOpen(workingCopy: IWorkingCopyIdentifier, editor: EditorInput): boolean {\n\t\tif (!this.handles(workingCopy)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (workingCopy.resource.authority === 'jupyter-notebook-ipynb' && editor instanceof NotebookEditorInput) {\n\t\t\ttry {\n\t\t\t\tconst data = JSON.parse(workingCopy.resource.query);\n\t\t\t\tconst workingCopyResource = URI.from(data);\n\t\t\t\treturn isEqual(workingCopyResource, editor.resource);\n\t\t\t} catch {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tif (!(editor instanceof CustomEditorInput)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (workingCopy.resource.authority !== editor.viewType.replace(/[^a-z0-9\\-_]/gi, '-').toLowerCase()) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// The working copy stores the uri of the original resource as its query param\n\t\ttry {\n\t\t\tconst data = JSON.parse(workingCopy.resource.query);\n\t\t\tconst workingCopyResource = URI.from(data);\n\t\t\treturn isEqual(workingCopyResource, editor.resource);\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tasync createEditor(workingCopy: IWorkingCopyIdentifier): Promise<EditorInput> {\n\t\tconst backup = await this._workingCopyBackupService.resolve<CustomDocumentBackupData>(workingCopy);\n\t\tif (!backup?.meta) {\n\t\t\tthrow new Error(`No backup found for custom editor: ${workingCopy.resource}`);\n\t\t}\n\n\t\tconst backupData = backup.meta;\n\t\tconst extension = reviveWebviewExtensionDescription(backupData.extension?.id, backupData.extension?.location);\n\t\tconst webview = reviveWebview(this._webviewService, {\n\t\t\tviewType: backupData.viewType,\n\t\t\torigin: backupData.webview.origin,\n\t\t\twebviewOptions: restoreWebviewOptions(backupData.webview.options),\n\t\t\tcontentOptions: restoreWebviewContentOptions(backupData.webview.options),\n\t\t\tstate: backupData.webview.state,\n\t\t\textension,\n\t\t\ttitle: backupData.customTitle,\n\t\t});\n\n\t\tconst editor = this._instantiationService.createInstance(CustomEditorInput, {\n\t\t\tresource: URI.revive(backupData.editorResource),\n\t\t\tviewType: backupData.viewType,\n\t\t\twebviewTitle: backupData.customTitle,\n\t\t\ticonPath: backupData.iconPath\n\t\t\t\t? { dark: URI.revive(backupData.iconPath.dark), light: URI.revive(backupData.iconPath.light) }\n\t\t\t\t: undefined\n\t\t}, webview, { backupId: backupData.backupId });\n\t\teditor.updateGroup(0);\n\t\treturn editor;\n\t}\n}\n\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { isEqual } from '../../../../base/common/resources.js';\nimport { URI, UriComponents } from '../../../../base/common/uri.js';\nimport { IInstantiationService } from '../../../../platform/instantiation/common/instantiation.js';\nimport { IWorkbenchContribution } from '../../../common/contributions.js';\nimport { EditorInput } from '../../../common/editor/editorInput.js';\nimport { CustomEditorInput } from './customEditorInput.js';\nimport { ICustomEditorService } from '../common/customEditor.js';\nimport { NotebookEditorInput } from '../../notebook/common/notebookEditorInput.js';\nimport { IWebviewService, WebviewContentOptions, WebviewContentPurpose, WebviewExtensionDescription, WebviewOptions } from '../../webview/browser/webview.js';\nimport { DeserializedWebview, restoreWebviewContentOptions, restoreWebviewOptions, reviveWebviewExtensionDescription, SerializedWebview, SerializedWebviewOptions, WebviewEditorInputSerializer } from '../../webviewPanel/browser/webviewEditorInputSerializer.js';\nimport { IWebviewWorkbenchService } from '../../webviewPanel/browser/webviewWorkbenchService.js';\nimport { IWorkingCopyBackupMeta, IWorkingCopyIdentifier } from '../../../services/workingCopy/common/workingCopy.js';\nimport { IWorkingCopyBackupService } from '../../../services/workingCopy/common/workingCopyBackup.js';\nimport { IWorkingCopyEditorHandler, IWorkingCopyEditorService } from '../../../services/workingCopy/common/workingCopyEditorService.js';\n\nexport interface CustomDocumentBackupData extends IWorkingCopyBackupMeta {\n\treadonly viewType: string;\n\treadonly editorResource: UriComponents;\n\n\treadonly customTitle: string | undefined;\n\treadonly iconPath: { dark: UriComponents; light: UriComponents } | undefined;\n\n\tbackupId: string;\n\n\treadonly extension: undefined | {\n\t\treadonly location: UriComponents;\n\t\treadonly id: string;\n\t};\n\n\treadonly webview: {\n\t\treadonly origin: string | undefined;\n\t\treadonly options: SerializedWebviewOptions;\n\t\treadonly state: any;\n\t};\n}\n\ninterface SerializedCustomEditor extends SerializedWebview {\n\treadonly editorResource: UriComponents;\n\treadonly dirty: boolean;\n\treadonly backupId?: string;\n}\n\ninterface DeserializedCustomEditor extends DeserializedWebview {\n\treadonly editorResource: URI;\n\treadonly dirty: boolean;\n\treadonly backupId?: string;\n}\n\nexport class CustomEditorInputSerializer extends WebviewEditorInputSerializer {\n\n\tpublic static override readonly ID = CustomEditorInput.typeId;\n\n\tpublic constructor(\n\t\t@IWebviewWorkbenchService webviewWorkbenchService: IWebviewWorkbenchService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IWebviewService private readonly _webviewService: IWebviewService,\n\t) {\n\t\tsuper(webviewWorkbenchService);\n\t}\n\n\tpublic override serialize(input: CustomEditorInput): string | undefined {\n\t\tconst dirty = input.isDirty();\n\t\tconst data: SerializedCustomEditor = {\n\t\t\t...this.toJson(input),\n\t\t\teditorResource: input.resource.toJSON(),\n\t\t\tdirty,\n\t\t\tbackupId: dirty ? input.backupId : undefined,\n\t\t};\n\n\t\ttry {\n\t\t\treturn JSON.stringify(data);\n\t\t} catch {\n\t\t\treturn undefined;\n\t\t}\n\t}\n\n\tprotected override fromJson(data: SerializedCustomEditor): DeserializedCustomEditor {\n\t\treturn {\n\t\t\t...super.fromJson(data),\n\t\t\teditorResource: URI.from(data.editorResource),\n\t\t\tdirty: data.dirty,\n\t\t};\n\t}\n\n\tpublic override deserialize(\n\t\t_instantiationService: IInstantiationService,\n\t\tserializedEditorInput: string\n\t): CustomEditorInput {\n\t\tconst data = this.fromJson(JSON.parse(serializedEditorInput));\n\n\t\tconst webview = reviveWebview(this._webviewService, data);\n\t\tconst customInput = this._instantiationService.createInstance(CustomEditorInput, {\n\t\t\tresource: data.editorResource,\n\t\t\tviewType: data.viewType,\n\t\t\twebviewTitle: data.title,\n\t\t\ticonPath: data.iconPath,\n\t\t}, webview, { startsDirty: data.dirty, backupId: data.backupId });\n\t\tif (typeof data.group === 'number') {\n\t\t\tcustomInput.updateGroup(data.group);\n\t\t}\n\t\treturn customInput;\n\t}\n}\n\nfunction reviveWebview(webviewService: IWebviewService, data: { origin: string | undefined; viewType: string; state: any; webviewOptions: WebviewOptions; contentOptions: WebviewContentOptions; extension?: WebviewExtensionDescription; title: string | undefined }) {\n\tconst webview = webviewService.createWebviewOverlay({\n\t\tprovidedViewType: data.viewType,\n\t\torigin: data.origin,\n\t\ttitle: data.title,\n\t\toptions: {\n\t\t\tpurpose: WebviewContentPurpose.CustomEditor,\n\t\t\tenableFindWidget: data.webviewOptions.enableFindWidget,\n\t\t\tretainContextWhenHidden: data.webviewOptions.retainContextWhenHidden,\n\t\t},\n\t\tcontentOptions: data.contentOptions,\n\t\textension: data.extension,\n\t});\n\twebview.state = data.state;\n\treturn webview;\n}\n\nexport class ComplexCustomWorkingCopyEditorHandler extends Disposable implements IWorkbenchContribution, IWorkingCopyEditorHandler {\n\n\tstatic readonly ID = 'workbench.contrib.complexCustomWorkingCopyEditorHandler';\n\n\tconstructor(\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t\t@IWorkingCopyEditorService _workingCopyEditorService: IWorkingCopyEditorService,\n\t\t@IWorkingCopyBackupService private readonly _workingCopyBackupService: IWorkingCopyBackupService,\n\t\t@IWebviewService private readonly _webviewService: IWebviewService,\n\t\t@ICustomEditorService _customEditorService: ICustomEditorService // DO NOT REMOVE (needed on startup to register overrides properly)\n\t) {\n\t\tsuper();\n\n\t\tthis._register(_workingCopyEditorService.registerHandler(this));\n\t}\n\n\thandles(workingCopy: IWorkingCopyIdentifier): boolean {\n\t\treturn workingCopy.resource.scheme === Schemas.vscodeCustomEditor;\n\t}\n\n\tisOpen(workingCopy: IWorkingCopyIdentifier, editor: EditorInput): boolean {\n\t\tif (!this.handles(workingCopy)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (workingCopy.resource.authority === 'jupyter-notebook-ipynb' && editor instanceof NotebookEditorInput) {\n\t\t\ttry {\n\t\t\t\tconst data = JSON.parse(workingCopy.resource.query);\n\t\t\t\tconst workingCopyResource = URI.from(data);\n\t\t\t\treturn isEqual(workingCopyResource, editor.resource);\n\t\t\t} catch {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tif (!(editor instanceof CustomEditorInput)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (workingCopy.resource.authority !== editor.viewType.replace(/[^a-z0-9\\-_]/gi, '-').toLowerCase()) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// The working copy stores the uri of the original resource as its query param\n\t\ttry {\n\t\t\tconst data = JSON.parse(workingCopy.resource.query);\n\t\t\tconst workingCopyResource = URI.from(data);\n\t\t\treturn isEqual(workingCopyResource, editor.resource);\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tasync createEditor(workingCopy: IWorkingCopyIdentifier): Promise<EditorInput> {\n\t\tconst backup = await this._workingCopyBackupService.resolve<CustomDocumentBackupData>(workingCopy);\n\t\tif (!backup?.meta) {\n\t\t\tthrow new Error(`No backup found for custom editor: ${workingCopy.resource}`);\n\t\t}\n\n\t\tconst backupData = backup.meta;\n\t\tconst extension = reviveWebviewExtensionDescription(backupData.extension?.id, backupData.extension?.location);\n\t\tconst webview = reviveWebview(this._webviewService, {\n\t\t\tviewType: backupData.viewType,\n\t\t\torigin: backupData.webview.origin,\n\t\t\twebviewOptions: restoreWebviewOptions(backupData.webview.options),\n\t\t\tcontentOptions: restoreWebviewContentOptions(backupData.webview.options),\n\t\t\tstate: backupData.webview.state,\n\t\t\textension,\n\t\t\ttitle: backupData.customTitle,\n\t\t});\n\n\t\tconst editor = this._instantiationService.createInstance(CustomEditorInput, {\n\t\t\tresource: URI.revive(backupData.editorResource),\n\t\t\tviewType: backupData.viewType,\n\t\t\twebviewTitle: backupData.customTitle,\n\t\t\ticonPath: backupData.iconPath\n\t\t\t\t? { dark: URI.revive(backupData.iconPath.dark), light: URI.revive(backupData.iconPath.light) }\n\t\t\t\t: undefined\n\t\t}, webview, { backupId: backupData.backupId });\n\t\teditor.updateGroup(0);\n\t\treturn editor;\n\t}\n}\n\n"]}