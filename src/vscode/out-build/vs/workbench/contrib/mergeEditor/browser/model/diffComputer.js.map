{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/workbench/contrib/mergeEditor/browser/model/diffComputer.ts","vs/workbench/contrib/mergeEditor/browser/model/diffComputer.ts"],"names":[],"mappings":"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","file":"diffComputer.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { assertFn, checkAdjacentItems } from '../../../../../base/common/assert.js';\nimport { IReader } from '../../../../../base/common/observable.js';\nimport { RangeMapping as DiffRangeMapping } from '../../../../../editor/common/diff/rangeMapping.js';\nimport { ITextModel } from '../../../../../editor/common/model.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { MergeEditorLineRange } from './lineRange.js';\nimport { DetailedLineRangeMapping, RangeMapping } from './mapping.js';\nimport { observableConfigValue } from '../../../../../platform/observable/common/platformObservableUtils.js';\nimport { LineRange } from '../../../../../editor/common/core/ranges/lineRange.js';\n\nexport interface IMergeDiffComputer {\n\tcomputeDiff(textModel1: ITextModel, textModel2: ITextModel, reader: IReader): Promise<IMergeDiffComputerResult>;\n}\n\nexport interface IMergeDiffComputerResult {\n\tdiffs: DetailedLineRangeMapping[] | null;\n}\n\nexport class MergeDiffComputer implements IMergeDiffComputer {\n\tprivate readonly mergeAlgorithm;\n\n\tconstructor(\n\t\t@IEditorWorkerService private readonly editorWorkerService: IEditorWorkerService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t) {\n\t\tthis.mergeAlgorithm = observableConfigValue<'smart' | 'experimental' | 'legacy' | 'advanced'>(\n\t\t\t'mergeEditor.diffAlgorithm', 'advanced', this.configurationService)\n\t\t\t.map(v => v === 'smart' ? 'legacy' : v === 'experimental' ? 'advanced' : v);\n\t}\n\n\tasync computeDiff(textModel1: ITextModel, textModel2: ITextModel, reader: IReader): Promise<IMergeDiffComputerResult> {\n\t\tconst diffAlgorithm = this.mergeAlgorithm.read(reader);\n\t\tconst inputVersion = textModel1.getVersionId();\n\t\tconst outputVersion = textModel2.getVersionId();\n\n\t\tconst result = await this.editorWorkerService.computeDiff(\n\t\t\ttextModel1.uri,\n\t\t\ttextModel2.uri,\n\t\t\t{\n\t\t\t\tignoreTrimWhitespace: false,\n\t\t\t\tmaxComputationTimeMs: 0,\n\t\t\t\tcomputeMoves: false,\n\t\t\t},\n\t\t\tdiffAlgorithm,\n\t\t);\n\n\t\tif (!result) {\n\t\t\tthrow new Error('Diff computation failed');\n\t\t}\n\n\t\tif (textModel1.isDisposed() || textModel2.isDisposed()) {\n\t\t\treturn { diffs: null };\n\t\t}\n\n\t\tconst changes = result.changes.map(c =>\n\t\t\tnew DetailedLineRangeMapping(\n\t\t\t\ttoLineRange(c.original),\n\t\t\t\ttextModel1,\n\t\t\t\ttoLineRange(c.modified),\n\t\t\t\ttextModel2,\n\t\t\t\tc.innerChanges?.map(ic => toRangeMapping(ic))\n\t\t\t)\n\t\t);\n\n\t\tconst newInputVersion = textModel1.getVersionId();\n\t\tconst newOutputVersion = textModel2.getVersionId();\n\n\t\tif (inputVersion !== newInputVersion || outputVersion !== newOutputVersion) {\n\t\t\treturn { diffs: null };\n\t\t}\n\n\t\tassertFn(() => {\n\t\t\t/*\n\t\t\t// This does not hold (see https://github.com/microsoft/vscode-copilot/issues/10610)\n\t\t\t// TODO@hediet the diff algorithm should just use compute a string edit that transforms the input to the output, nothing else\n\n\t\t\tfor (const c of changes) {\n\t\t\t\tconst inputRange = c.inputRange;\n\t\t\t\tconst outputRange = c.outputRange;\n\t\t\t\tconst inputTextModel = c.inputTextModel;\n\t\t\t\tconst outputTextModel = c.outputTextModel;\n\n\t\t\t\tfor (const map of c.rangeMappings) {\n\t\t\t\t\tlet inputRangesValid = inputRange.startLineNumber - 1 <= map.inputRange.startLineNumber\n\t\t\t\t\t\t&& map.inputRange.endLineNumber <= inputRange.endLineNumberExclusive;\n\t\t\t\t\tif (inputRangesValid && map.inputRange.startLineNumber === inputRange.startLineNumber - 1) {\n\t\t\t\t\t\tinputRangesValid = map.inputRange.endColumn >= inputTextModel.getLineMaxColumn(map.inputRange.startLineNumber);\n\t\t\t\t\t}\n\t\t\t\t\tif (inputRangesValid && map.inputRange.endLineNumber === inputRange.endLineNumberExclusive) {\n\t\t\t\t\t\tinputRangesValid = map.inputRange.endColumn === 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet outputRangesValid = outputRange.startLineNumber - 1 <= map.outputRange.startLineNumber\n\t\t\t\t\t\t&& map.outputRange.endLineNumber <= outputRange.endLineNumberExclusive;\n\t\t\t\t\tif (outputRangesValid && map.outputRange.startLineNumber === outputRange.startLineNumber - 1) {\n\t\t\t\t\t\toutputRangesValid = map.outputRange.endColumn >= outputTextModel.getLineMaxColumn(map.outputRange.endLineNumber);\n\t\t\t\t\t}\n\t\t\t\t\tif (outputRangesValid && map.outputRange.endLineNumber === outputRange.endLineNumberExclusive) {\n\t\t\t\t\t\toutputRangesValid = map.outputRange.endColumn === 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!inputRangesValid || !outputRangesValid) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}*/\n\n\t\t\treturn changes.length === 0 || (changes[0].inputRange.startLineNumber === changes[0].outputRange.startLineNumber &&\n\t\t\t\tcheckAdjacentItems(changes,\n\t\t\t\t\t(m1, m2) => m2.inputRange.startLineNumber - m1.inputRange.endLineNumberExclusive === m2.outputRange.startLineNumber - m1.outputRange.endLineNumberExclusive &&\n\t\t\t\t\t\t// There has to be an unchanged line in between (otherwise both diffs should have been joined)\n\t\t\t\t\t\tm1.inputRange.endLineNumberExclusive < m2.inputRange.startLineNumber &&\n\t\t\t\t\t\tm1.outputRange.endLineNumberExclusive < m2.outputRange.startLineNumber,\n\t\t\t\t));\n\t\t});\n\n\t\treturn {\n\t\t\tdiffs: changes\n\t\t};\n\t}\n}\n\nexport function toLineRange(range: LineRange): MergeEditorLineRange {\n\treturn MergeEditorLineRange.fromLength(range.startLineNumber, range.length);\n}\n\nexport function toRangeMapping(mapping: DiffRangeMapping): RangeMapping {\n\treturn new RangeMapping(mapping.originalRange, mapping.modifiedRange);\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { assertFn, checkAdjacentItems } from '../../../../../base/common/assert.js';\nimport { IReader } from '../../../../../base/common/observable.js';\nimport { RangeMapping as DiffRangeMapping } from '../../../../../editor/common/diff/rangeMapping.js';\nimport { ITextModel } from '../../../../../editor/common/model.js';\nimport { IEditorWorkerService } from '../../../../../editor/common/services/editorWorker.js';\nimport { IConfigurationService } from '../../../../../platform/configuration/common/configuration.js';\nimport { MergeEditorLineRange } from './lineRange.js';\nimport { DetailedLineRangeMapping, RangeMapping } from './mapping.js';\nimport { observableConfigValue } from '../../../../../platform/observable/common/platformObservableUtils.js';\nimport { LineRange } from '../../../../../editor/common/core/ranges/lineRange.js';\n\nexport interface IMergeDiffComputer {\n\tcomputeDiff(textModel1: ITextModel, textModel2: ITextModel, reader: IReader): Promise<IMergeDiffComputerResult>;\n}\n\nexport interface IMergeDiffComputerResult {\n\tdiffs: DetailedLineRangeMapping[] | null;\n}\n\nexport class MergeDiffComputer implements IMergeDiffComputer {\n\tprivate readonly mergeAlgorithm;\n\n\tconstructor(\n\t\t@IEditorWorkerService private readonly editorWorkerService: IEditorWorkerService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t) {\n\t\tthis.mergeAlgorithm = observableConfigValue<'smart' | 'experimental' | 'legacy' | 'advanced'>(\n\t\t\t'mergeEditor.diffAlgorithm', 'advanced', this.configurationService)\n\t\t\t.map(v => v === 'smart' ? 'legacy' : v === 'experimental' ? 'advanced' : v);\n\t}\n\n\tasync computeDiff(textModel1: ITextModel, textModel2: ITextModel, reader: IReader): Promise<IMergeDiffComputerResult> {\n\t\tconst diffAlgorithm = this.mergeAlgorithm.read(reader);\n\t\tconst inputVersion = textModel1.getVersionId();\n\t\tconst outputVersion = textModel2.getVersionId();\n\n\t\tconst result = await this.editorWorkerService.computeDiff(\n\t\t\ttextModel1.uri,\n\t\t\ttextModel2.uri,\n\t\t\t{\n\t\t\t\tignoreTrimWhitespace: false,\n\t\t\t\tmaxComputationTimeMs: 0,\n\t\t\t\tcomputeMoves: false,\n\t\t\t},\n\t\t\tdiffAlgorithm,\n\t\t);\n\n\t\tif (!result) {\n\t\t\tthrow new Error('Diff computation failed');\n\t\t}\n\n\t\tif (textModel1.isDisposed() || textModel2.isDisposed()) {\n\t\t\treturn { diffs: null };\n\t\t}\n\n\t\tconst changes = result.changes.map(c =>\n\t\t\tnew DetailedLineRangeMapping(\n\t\t\t\ttoLineRange(c.original),\n\t\t\t\ttextModel1,\n\t\t\t\ttoLineRange(c.modified),\n\t\t\t\ttextModel2,\n\t\t\t\tc.innerChanges?.map(ic => toRangeMapping(ic))\n\t\t\t)\n\t\t);\n\n\t\tconst newInputVersion = textModel1.getVersionId();\n\t\tconst newOutputVersion = textModel2.getVersionId();\n\n\t\tif (inputVersion !== newInputVersion || outputVersion !== newOutputVersion) {\n\t\t\treturn { diffs: null };\n\t\t}\n\n\t\tassertFn(() => {\n\t\t\t/*\n\t\t\t// This does not hold (see https://github.com/microsoft/vscode-copilot/issues/10610)\n\t\t\t// TODO@hediet the diff algorithm should just use compute a string edit that transforms the input to the output, nothing else\n\n\t\t\tfor (const c of changes) {\n\t\t\t\tconst inputRange = c.inputRange;\n\t\t\t\tconst outputRange = c.outputRange;\n\t\t\t\tconst inputTextModel = c.inputTextModel;\n\t\t\t\tconst outputTextModel = c.outputTextModel;\n\n\t\t\t\tfor (const map of c.rangeMappings) {\n\t\t\t\t\tlet inputRangesValid = inputRange.startLineNumber - 1 <= map.inputRange.startLineNumber\n\t\t\t\t\t\t&& map.inputRange.endLineNumber <= inputRange.endLineNumberExclusive;\n\t\t\t\t\tif (inputRangesValid && map.inputRange.startLineNumber === inputRange.startLineNumber - 1) {\n\t\t\t\t\t\tinputRangesValid = map.inputRange.endColumn >= inputTextModel.getLineMaxColumn(map.inputRange.startLineNumber);\n\t\t\t\t\t}\n\t\t\t\t\tif (inputRangesValid && map.inputRange.endLineNumber === inputRange.endLineNumberExclusive) {\n\t\t\t\t\t\tinputRangesValid = map.inputRange.endColumn === 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet outputRangesValid = outputRange.startLineNumber - 1 <= map.outputRange.startLineNumber\n\t\t\t\t\t\t&& map.outputRange.endLineNumber <= outputRange.endLineNumberExclusive;\n\t\t\t\t\tif (outputRangesValid && map.outputRange.startLineNumber === outputRange.startLineNumber - 1) {\n\t\t\t\t\t\toutputRangesValid = map.outputRange.endColumn >= outputTextModel.getLineMaxColumn(map.outputRange.endLineNumber);\n\t\t\t\t\t}\n\t\t\t\t\tif (outputRangesValid && map.outputRange.endLineNumber === outputRange.endLineNumberExclusive) {\n\t\t\t\t\t\toutputRangesValid = map.outputRange.endColumn === 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!inputRangesValid || !outputRangesValid) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}*/\n\n\t\t\treturn changes.length === 0 || (changes[0].inputRange.startLineNumber === changes[0].outputRange.startLineNumber &&\n\t\t\t\tcheckAdjacentItems(changes,\n\t\t\t\t\t(m1, m2) => m2.inputRange.startLineNumber - m1.inputRange.endLineNumberExclusive === m2.outputRange.startLineNumber - m1.outputRange.endLineNumberExclusive &&\n\t\t\t\t\t\t// There has to be an unchanged line in between (otherwise both diffs should have been joined)\n\t\t\t\t\t\tm1.inputRange.endLineNumberExclusive < m2.inputRange.startLineNumber &&\n\t\t\t\t\t\tm1.outputRange.endLineNumberExclusive < m2.outputRange.startLineNumber,\n\t\t\t\t));\n\t\t});\n\n\t\treturn {\n\t\t\tdiffs: changes\n\t\t};\n\t}\n}\n\nexport function toLineRange(range: LineRange): MergeEditorLineRange {\n\treturn MergeEditorLineRange.fromLength(range.startLineNumber, range.length);\n}\n\nexport function toRangeMapping(mapping: DiffRangeMapping): RangeMapping {\n\treturn new RangeMapping(mapping.originalRange, mapping.modifiedRange);\n}\n"]}