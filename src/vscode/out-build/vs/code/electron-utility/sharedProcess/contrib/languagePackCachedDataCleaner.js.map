{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/code/electron-utility/sharedProcess/contrib/languagePackCachedDataCleaner.ts","vs/code/electron-utility/sharedProcess/contrib/languagePackCachedDataCleaner.ts"],"names":[],"mappings":"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","file":"languagePackCachedDataCleaner.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { promises } from 'fs';\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { IStringDictionary } from '../../../../base/common/collections.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { join } from '../../../../base/common/path.js';\nimport { Promises } from '../../../../base/node/pfs.js';\nimport { INativeEnvironmentService } from '../../../../platform/environment/common/environment.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\n\ninterface IExtensionEntry {\n\tversion: string;\n\textensionIdentifier: {\n\t\tid: string;\n\t\tuuid: string;\n\t};\n}\n\ninterface ILanguagePackEntry {\n\thash: string;\n\textensions: IExtensionEntry[];\n}\n\ninterface ILanguagePackFile {\n\t[locale: string]: ILanguagePackEntry;\n}\n\nexport class LanguagePackCachedDataCleaner extends Disposable {\n\n\tprivate readonly dataMaxAge: number;\n\n\tconstructor(\n\t\t@INativeEnvironmentService private readonly environmentService: INativeEnvironmentService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IProductService productService: IProductService\n\t) {\n\t\tsuper();\n\n\t\tthis.dataMaxAge = productService.quality !== 'stable'\n\t\t\t? 1000 * 60 * 60 * 24 * 7 \t\t// roughly 1 week (insiders)\n\t\t\t: 1000 * 60 * 60 * 24 * 30 * 3; // roughly 3 months (stable)\n\n\t\t// We have no Language pack support for dev version (run from source)\n\t\t// So only cleanup when we have a build version.\n\t\tif (this.environmentService.isBuilt) {\n\t\t\tconst scheduler = this._register(new RunOnceScheduler(() => {\n\t\t\t\tthis.cleanUpLanguagePackCache();\n\t\t\t}, 40 * 1000 /* after 40s */));\n\t\t\tscheduler.schedule();\n\t\t}\n\t}\n\n\tprivate async cleanUpLanguagePackCache(): Promise<void> {\n\t\tthis.logService.trace('[language pack cache cleanup]: Starting to clean up unused language packs.');\n\n\t\ttry {\n\t\t\tconst installed: IStringDictionary<boolean> = Object.create(null);\n\t\t\tconst metaData: ILanguagePackFile = JSON.parse(await promises.readFile(join(this.environmentService.userDataPath, 'languagepacks.json'), 'utf8'));\n\t\t\tfor (const locale of Object.keys(metaData)) {\n\t\t\t\tconst entry = metaData[locale];\n\t\t\t\tinstalled[`${entry.hash}.${locale}`] = true;\n\t\t\t}\n\n\t\t\t// Cleanup entries for language packs that aren't installed anymore\n\t\t\tconst cacheDir = join(this.environmentService.userDataPath, 'clp');\n\t\t\tconst cacheDirExists = await Promises.exists(cacheDir);\n\t\t\tif (!cacheDirExists) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst entries = await Promises.readdir(cacheDir);\n\t\t\tfor (const entry of entries) {\n\t\t\t\tif (installed[entry]) {\n\t\t\t\t\tthis.logService.trace(`[language pack cache cleanup]: Skipping folder ${entry}. Language pack still in use.`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.logService.trace(`[language pack cache cleanup]: Removing unused language pack: ${entry}`);\n\n\t\t\t\tawait Promises.rm(join(cacheDir, entry));\n\t\t\t}\n\n\t\t\tconst now = Date.now();\n\t\t\tfor (const packEntry of Object.keys(installed)) {\n\t\t\t\tconst folder = join(cacheDir, packEntry);\n\t\t\t\tconst entries = await Promises.readdir(folder);\n\t\t\t\tfor (const entry of entries) {\n\t\t\t\t\tif (entry === 'tcf.json') {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst candidate = join(folder, entry);\n\t\t\t\t\tconst stat = await promises.stat(candidate);\n\t\t\t\t\tif (stat.isDirectory() && (now - stat.mtime.getTime()) > this.dataMaxAge) {\n\t\t\t\t\t\tthis.logService.trace(`[language pack cache cleanup]: Removing language pack cache folder: ${join(packEntry, entry)}`);\n\n\t\t\t\t\t\tawait Promises.rm(candidate);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tonUnexpectedError(error);\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { promises } from 'fs';\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { IStringDictionary } from '../../../../base/common/collections.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { join } from '../../../../base/common/path.js';\nimport { Promises } from '../../../../base/node/pfs.js';\nimport { INativeEnvironmentService } from '../../../../platform/environment/common/environment.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\n\ninterface IExtensionEntry {\n\tversion: string;\n\textensionIdentifier: {\n\t\tid: string;\n\t\tuuid: string;\n\t};\n}\n\ninterface ILanguagePackEntry {\n\thash: string;\n\textensions: IExtensionEntry[];\n}\n\ninterface ILanguagePackFile {\n\t[locale: string]: ILanguagePackEntry;\n}\n\nexport class LanguagePackCachedDataCleaner extends Disposable {\n\n\tprivate readonly dataMaxAge: number;\n\n\tconstructor(\n\t\t@INativeEnvironmentService private readonly environmentService: INativeEnvironmentService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IProductService productService: IProductService\n\t) {\n\t\tsuper();\n\n\t\tthis.dataMaxAge = productService.quality !== 'stable'\n\t\t\t? 1000 * 60 * 60 * 24 * 7 \t\t// roughly 1 week (insiders)\n\t\t\t: 1000 * 60 * 60 * 24 * 30 * 3; // roughly 3 months (stable)\n\n\t\t// We have no Language pack support for dev version (run from source)\n\t\t// So only cleanup when we have a build version.\n\t\tif (this.environmentService.isBuilt) {\n\t\t\tconst scheduler = this._register(new RunOnceScheduler(() => {\n\t\t\t\tthis.cleanUpLanguagePackCache();\n\t\t\t}, 40 * 1000 /* after 40s */));\n\t\t\tscheduler.schedule();\n\t\t}\n\t}\n\n\tprivate async cleanUpLanguagePackCache(): Promise<void> {\n\t\tthis.logService.trace('[language pack cache cleanup]: Starting to clean up unused language packs.');\n\n\t\ttry {\n\t\t\tconst installed: IStringDictionary<boolean> = Object.create(null);\n\t\t\tconst metaData: ILanguagePackFile = JSON.parse(await promises.readFile(join(this.environmentService.userDataPath, 'languagepacks.json'), 'utf8'));\n\t\t\tfor (const locale of Object.keys(metaData)) {\n\t\t\t\tconst entry = metaData[locale];\n\t\t\t\tinstalled[`${entry.hash}.${locale}`] = true;\n\t\t\t}\n\n\t\t\t// Cleanup entries for language packs that aren't installed anymore\n\t\t\tconst cacheDir = join(this.environmentService.userDataPath, 'clp');\n\t\t\tconst cacheDirExists = await Promises.exists(cacheDir);\n\t\t\tif (!cacheDirExists) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst entries = await Promises.readdir(cacheDir);\n\t\t\tfor (const entry of entries) {\n\t\t\t\tif (installed[entry]) {\n\t\t\t\t\tthis.logService.trace(`[language pack cache cleanup]: Skipping folder ${entry}. Language pack still in use.`);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.logService.trace(`[language pack cache cleanup]: Removing unused language pack: ${entry}`);\n\n\t\t\t\tawait Promises.rm(join(cacheDir, entry));\n\t\t\t}\n\n\t\t\tconst now = Date.now();\n\t\t\tfor (const packEntry of Object.keys(installed)) {\n\t\t\t\tconst folder = join(cacheDir, packEntry);\n\t\t\t\tconst entries = await Promises.readdir(folder);\n\t\t\t\tfor (const entry of entries) {\n\t\t\t\t\tif (entry === 'tcf.json') {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst candidate = join(folder, entry);\n\t\t\t\t\tconst stat = await promises.stat(candidate);\n\t\t\t\t\tif (stat.isDirectory() && (now - stat.mtime.getTime()) > this.dataMaxAge) {\n\t\t\t\t\t\tthis.logService.trace(`[language pack cache cleanup]: Removing language pack cache folder: ${join(packEntry, entry)}`);\n\n\t\t\t\t\t\tawait Promises.rm(candidate);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tonUnexpectedError(error);\n\t\t}\n\t}\n}\n"]}