{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/code/electron-utility/sharedProcess/contrib/codeCacheCleaner.ts","vs/code/electron-utility/sharedProcess/contrib/codeCacheCleaner.ts"],"names":[],"mappings":"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","file":"codeCacheCleaner.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { promises } from 'fs';\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { basename, dirname, join } from '../../../../base/common/path.js';\nimport { Promises } from '../../../../base/node/pfs.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\n\nexport class CodeCacheCleaner extends Disposable {\n\n\tprivate readonly dataMaxAge: number;\n\n\tconstructor(\n\t\tcurrentCodeCachePath: string | undefined,\n\t\t@IProductService productService: IProductService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\tthis.dataMaxAge = productService.quality !== 'stable'\n\t\t\t? 1000 * 60 * 60 * 24 * 7 \t\t// roughly 1 week (insiders)\n\t\t\t: 1000 * 60 * 60 * 24 * 30 * 3; // roughly 3 months (stable)\n\n\t\t// Cached data is stored as user data and we run a cleanup task every time\n\t\t// the editor starts. The strategy is to delete all files that are older than\n\t\t// 3 months (1 week respectively)\n\t\tif (currentCodeCachePath) {\n\t\t\tconst scheduler = this._register(new RunOnceScheduler(() => {\n\t\t\t\tthis.cleanUpCodeCaches(currentCodeCachePath);\n\t\t\t}, 30 * 1000 /* after 30s */));\n\t\t\tscheduler.schedule();\n\t\t}\n\t}\n\n\tprivate async cleanUpCodeCaches(currentCodeCachePath: string): Promise<void> {\n\t\tthis.logService.trace('[code cache cleanup]: Starting to clean up old code cache folders.');\n\n\t\ttry {\n\t\t\tconst now = Date.now();\n\n\t\t\t// The folder which contains folders of cached data.\n\t\t\t// Each of these folders is partioned per commit\n\t\t\tconst codeCacheRootPath = dirname(currentCodeCachePath);\n\t\t\tconst currentCodeCache = basename(currentCodeCachePath);\n\n\t\t\tconst codeCaches = await Promises.readdir(codeCacheRootPath);\n\t\t\tawait Promise.all(codeCaches.map(async codeCache => {\n\t\t\t\tif (codeCache === currentCodeCache) {\n\t\t\t\t\treturn; // not the current cache folder\n\t\t\t\t}\n\n\t\t\t\t// Delete cache folder if old enough\n\t\t\t\tconst codeCacheEntryPath = join(codeCacheRootPath, codeCache);\n\t\t\t\tconst codeCacheEntryStat = await promises.stat(codeCacheEntryPath);\n\t\t\t\tif (codeCacheEntryStat.isDirectory() && (now - codeCacheEntryStat.mtime.getTime()) > this.dataMaxAge) {\n\t\t\t\t\tthis.logService.trace(`[code cache cleanup]: Removing code cache folder ${codeCache}.`);\n\n\t\t\t\t\treturn Promises.rm(codeCacheEntryPath);\n\t\t\t\t}\n\t\t\t}));\n\t\t} catch (error) {\n\t\t\tonUnexpectedError(error);\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { promises } from 'fs';\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { basename, dirname, join } from '../../../../base/common/path.js';\nimport { Promises } from '../../../../base/node/pfs.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { IProductService } from '../../../../platform/product/common/productService.js';\n\nexport class CodeCacheCleaner extends Disposable {\n\n\tprivate readonly dataMaxAge: number;\n\n\tconstructor(\n\t\tcurrentCodeCachePath: string | undefined,\n\t\t@IProductService productService: IProductService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\tthis.dataMaxAge = productService.quality !== 'stable'\n\t\t\t? 1000 * 60 * 60 * 24 * 7 \t\t// roughly 1 week (insiders)\n\t\t\t: 1000 * 60 * 60 * 24 * 30 * 3; // roughly 3 months (stable)\n\n\t\t// Cached data is stored as user data and we run a cleanup task every time\n\t\t// the editor starts. The strategy is to delete all files that are older than\n\t\t// 3 months (1 week respectively)\n\t\tif (currentCodeCachePath) {\n\t\t\tconst scheduler = this._register(new RunOnceScheduler(() => {\n\t\t\t\tthis.cleanUpCodeCaches(currentCodeCachePath);\n\t\t\t}, 30 * 1000 /* after 30s */));\n\t\t\tscheduler.schedule();\n\t\t}\n\t}\n\n\tprivate async cleanUpCodeCaches(currentCodeCachePath: string): Promise<void> {\n\t\tthis.logService.trace('[code cache cleanup]: Starting to clean up old code cache folders.');\n\n\t\ttry {\n\t\t\tconst now = Date.now();\n\n\t\t\t// The folder which contains folders of cached data.\n\t\t\t// Each of these folders is partioned per commit\n\t\t\tconst codeCacheRootPath = dirname(currentCodeCachePath);\n\t\t\tconst currentCodeCache = basename(currentCodeCachePath);\n\n\t\t\tconst codeCaches = await Promises.readdir(codeCacheRootPath);\n\t\t\tawait Promise.all(codeCaches.map(async codeCache => {\n\t\t\t\tif (codeCache === currentCodeCache) {\n\t\t\t\t\treturn; // not the current cache folder\n\t\t\t\t}\n\n\t\t\t\t// Delete cache folder if old enough\n\t\t\t\tconst codeCacheEntryPath = join(codeCacheRootPath, codeCache);\n\t\t\t\tconst codeCacheEntryStat = await promises.stat(codeCacheEntryPath);\n\t\t\t\tif (codeCacheEntryStat.isDirectory() && (now - codeCacheEntryStat.mtime.getTime()) > this.dataMaxAge) {\n\t\t\t\t\tthis.logService.trace(`[code cache cleanup]: Removing code cache folder ${codeCache}.`);\n\n\t\t\t\t\treturn Promises.rm(codeCacheEntryPath);\n\t\t\t\t}\n\t\t\t}));\n\t\t} catch (error) {\n\t\t\tonUnexpectedError(error);\n\t\t}\n\t}\n}\n"]}