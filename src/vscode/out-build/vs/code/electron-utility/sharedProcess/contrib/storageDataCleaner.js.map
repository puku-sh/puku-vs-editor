{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/code/electron-utility/sharedProcess/contrib/storageDataCleaner.ts","vs/code/electron-utility/sharedProcess/contrib/storageDataCleaner.ts"],"names":[],"mappings":"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","file":"storageDataCleaner.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { join } from '../../../../base/common/path.js';\nimport { Promises } from '../../../../base/node/pfs.js';\nimport { INativeEnvironmentService } from '../../../../platform/environment/common/environment.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { StorageClient } from '../../../../platform/storage/common/storageIpc.js';\nimport { EXTENSION_DEVELOPMENT_EMPTY_WINDOW_WORKSPACE } from '../../../../platform/workspace/common/workspace.js';\nimport { NON_EMPTY_WORKSPACE_ID_LENGTH } from '../../../../platform/workspaces/node/workspaces.js';\nimport { INativeHostService } from '../../../../platform/native/common/native.js';\nimport { IMainProcessService } from '../../../../platform/ipc/common/mainProcessService.js';\nimport { Schemas } from '../../../../base/common/network.js';\n\nexport class UnusedWorkspaceStorageDataCleaner extends Disposable {\n\n\tconstructor(\n\t\t@INativeEnvironmentService private readonly environmentService: INativeEnvironmentService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@INativeHostService private readonly nativeHostService: INativeHostService,\n\t\t@IMainProcessService private readonly mainProcessService: IMainProcessService\n\t) {\n\t\tsuper();\n\n\t\tconst scheduler = this._register(new RunOnceScheduler(() => {\n\t\t\tthis.cleanUpStorage();\n\t\t}, 30 * 1000 /* after 30s */));\n\t\tscheduler.schedule();\n\t}\n\n\tprivate async cleanUpStorage(): Promise<void> {\n\t\tthis.logService.trace('[storage cleanup]: Starting to clean up workspace storage folders for unused empty workspaces.');\n\n\t\ttry {\n\t\t\tconst workspaceStorageHome = this.environmentService.workspaceStorageHome.with({ scheme: Schemas.file }).fsPath;\n\t\t\tconst workspaceStorageFolders = await Promises.readdir(workspaceStorageHome);\n\t\t\tconst storageClient = new StorageClient(this.mainProcessService.getChannel('storage'));\n\n\t\t\tawait Promise.all(workspaceStorageFolders.map(async workspaceStorageFolder => {\n\t\t\t\tconst workspaceStoragePath = join(workspaceStorageHome, workspaceStorageFolder);\n\n\t\t\t\tif (workspaceStorageFolder.length === NON_EMPTY_WORKSPACE_ID_LENGTH) {\n\t\t\t\t\treturn; // keep workspace storage for folders/workspaces that can be accessed still\n\t\t\t\t}\n\n\t\t\t\tif (workspaceStorageFolder === EXTENSION_DEVELOPMENT_EMPTY_WINDOW_WORKSPACE.id) {\n\t\t\t\t\treturn; // keep workspace storage for empty extension development workspaces\n\t\t\t\t}\n\n\t\t\t\tconst windows = await this.nativeHostService.getWindows({ includeAuxiliaryWindows: false });\n\t\t\t\tif (windows.some(window => window.workspace?.id === workspaceStorageFolder)) {\n\t\t\t\t\treturn; // keep workspace storage for empty workspaces opened as window\n\t\t\t\t}\n\n\t\t\t\tconst isStorageUsed = await storageClient.isUsed(workspaceStoragePath);\n\t\t\t\tif (isStorageUsed) {\n\t\t\t\t\treturn; // keep workspace storage for empty workspaces that are in use\n\t\t\t\t}\n\n\t\t\t\tthis.logService.trace(`[storage cleanup]: Deleting workspace storage folder ${workspaceStorageFolder} as it seems to be an unused empty workspace.`);\n\n\t\t\t\tawait Promises.rm(workspaceStoragePath);\n\t\t\t}));\n\t\t} catch (error) {\n\t\t\tonUnexpectedError(error);\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { onUnexpectedError } from '../../../../base/common/errors.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { join } from '../../../../base/common/path.js';\nimport { Promises } from '../../../../base/node/pfs.js';\nimport { INativeEnvironmentService } from '../../../../platform/environment/common/environment.js';\nimport { ILogService } from '../../../../platform/log/common/log.js';\nimport { StorageClient } from '../../../../platform/storage/common/storageIpc.js';\nimport { EXTENSION_DEVELOPMENT_EMPTY_WINDOW_WORKSPACE } from '../../../../platform/workspace/common/workspace.js';\nimport { NON_EMPTY_WORKSPACE_ID_LENGTH } from '../../../../platform/workspaces/node/workspaces.js';\nimport { INativeHostService } from '../../../../platform/native/common/native.js';\nimport { IMainProcessService } from '../../../../platform/ipc/common/mainProcessService.js';\nimport { Schemas } from '../../../../base/common/network.js';\n\nexport class UnusedWorkspaceStorageDataCleaner extends Disposable {\n\n\tconstructor(\n\t\t@INativeEnvironmentService private readonly environmentService: INativeEnvironmentService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@INativeHostService private readonly nativeHostService: INativeHostService,\n\t\t@IMainProcessService private readonly mainProcessService: IMainProcessService\n\t) {\n\t\tsuper();\n\n\t\tconst scheduler = this._register(new RunOnceScheduler(() => {\n\t\t\tthis.cleanUpStorage();\n\t\t}, 30 * 1000 /* after 30s */));\n\t\tscheduler.schedule();\n\t}\n\n\tprivate async cleanUpStorage(): Promise<void> {\n\t\tthis.logService.trace('[storage cleanup]: Starting to clean up workspace storage folders for unused empty workspaces.');\n\n\t\ttry {\n\t\t\tconst workspaceStorageHome = this.environmentService.workspaceStorageHome.with({ scheme: Schemas.file }).fsPath;\n\t\t\tconst workspaceStorageFolders = await Promises.readdir(workspaceStorageHome);\n\t\t\tconst storageClient = new StorageClient(this.mainProcessService.getChannel('storage'));\n\n\t\t\tawait Promise.all(workspaceStorageFolders.map(async workspaceStorageFolder => {\n\t\t\t\tconst workspaceStoragePath = join(workspaceStorageHome, workspaceStorageFolder);\n\n\t\t\t\tif (workspaceStorageFolder.length === NON_EMPTY_WORKSPACE_ID_LENGTH) {\n\t\t\t\t\treturn; // keep workspace storage for folders/workspaces that can be accessed still\n\t\t\t\t}\n\n\t\t\t\tif (workspaceStorageFolder === EXTENSION_DEVELOPMENT_EMPTY_WINDOW_WORKSPACE.id) {\n\t\t\t\t\treturn; // keep workspace storage for empty extension development workspaces\n\t\t\t\t}\n\n\t\t\t\tconst windows = await this.nativeHostService.getWindows({ includeAuxiliaryWindows: false });\n\t\t\t\tif (windows.some(window => window.workspace?.id === workspaceStorageFolder)) {\n\t\t\t\t\treturn; // keep workspace storage for empty workspaces opened as window\n\t\t\t\t}\n\n\t\t\t\tconst isStorageUsed = await storageClient.isUsed(workspaceStoragePath);\n\t\t\t\tif (isStorageUsed) {\n\t\t\t\t\treturn; // keep workspace storage for empty workspaces that are in use\n\t\t\t\t}\n\n\t\t\t\tthis.logService.trace(`[storage cleanup]: Deleting workspace storage folder ${workspaceStorageFolder} as it seems to be an unused empty workspace.`);\n\n\t\t\t\tawait Promises.rm(workspaceStoragePath);\n\t\t\t}));\n\t\t} catch (error) {\n\t\t\tonUnexpectedError(error);\n\t\t}\n\t}\n}\n"]}