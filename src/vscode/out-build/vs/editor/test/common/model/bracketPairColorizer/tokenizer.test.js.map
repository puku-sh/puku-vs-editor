{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/editor/test/common/model/bracketPairColorizer/tokenizer.test.ts","vs/editor/test/common/model/bracketPairColorizer/tokenizer.test.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,MAAM,MAAM,QAAQ,CAAC;AAC5B,OAAO,EAAE,eAAe,EAAE,MAAM,yCAAyC,CAAC;AAC1E,OAAO,EAAE,uCAAuC,EAAE,MAAM,0CAA0C,CAAC;AAEnG,OAAO,EAAE,yBAAyB,EAAgC,oBAAoB,EAAE,MAAM,iCAAiC,CAAC;AAChI,OAAO,EAAE,gBAAgB,EAAE,MAAM,0CAA0C,CAAC;AAC5E,OAAO,EAAE,6BAA6B,EAAE,MAAM,+DAA+D,CAAC;AAC9G,OAAO,EAAE,6BAA6B,EAAE,MAAM,iFAAiF,CAAC;AAChI,OAAO,EAAU,SAAS,EAAE,cAAc,EAAE,UAAU,EAAE,MAAM,+EAA+E,CAAC;AAC9I,OAAO,EAAE,gBAAgB,EAAE,MAAM,0FAA0F,CAAC;AAC5H,OAAO,EAAE,mBAAmB,EAA+B,MAAM,kFAAkF,CAAC;AAEpJ,OAAO,EAAE,mBAAmB,EAAE,oBAAoB,EAAE,MAAM,wBAAwB,CAAC;AAEnF,KAAK,CAAC,oCAAoC,EAAE,GAAG,EAAE;IAEhD,uCAAuC,EAAE,CAAC;IAE1C,IAAI,CAAC,OAAO,EAAE,GAAG,EAAE;QAClB,MAAM,KAAK,GAAG,WAAW,CAAC;QAC1B,MAAM,eAAe,GAAG,IAAI,eAAe,EAAE,CAAC;QAC9C,MAAM,oBAAoB,GAAG,mBAAmB,CAAC,eAAe,CAAC,CAAC;QAClE,MAAM,4BAA4B,GAAG,oBAAoB,CAAC,GAAG,CAAC,6BAA6B,CAAC,CAAC;QAC7F,MAAM,eAAe,GAAG,oBAAoB,CAAC,GAAG,CAAC,gBAAgB,CAAC,CAAC;QACnE,eAAe,CAAC,GAAG,CAAC,eAAe,CAAC,gBAAgB,CAAC,EAAE,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC;QACrE,MAAM,YAAY,GAAG,eAAe,CAAC,eAAe,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;QAE7E,MAAM,gBAAgB,GAAG,IAAI,gBAAgB,EAAU,CAAC;QAExD,MAAM,SAAS,GAAG,CAAC,IAAY,EAAE,EAAE,CAAC,IAAI,SAAS,CAAC,IAAI,EAAE,YAAY,mCAA2B,IAAI,CAAC,CAAC;QACrG,MAAM,QAAQ,GAAG,CAAC,IAAY,EAAE,EAAE,CAAC,IAAI,SAAS,CAAC,IAAI,EAAE,YAAY,qCAA6B,IAAI,CAAC,CAAC;QACtG,MAAM,QAAQ,GAAG,IAAI,iBAAiB,CAAC;YACtC,SAAS,CAAC,OAAO,CAAC,EAAE,SAAS,CAAC,IAAI,CAAC,EAAE,SAAS,CAAC,SAAS,CAAC,EAAE,SAAS,CAAC,IAAI,CAAC;YAC1E,SAAS,CAAC,OAAO,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,EAAE,SAAS,CAAC,GAAG,CAAC;SACjD,CAAC,CAAC;QAEH,eAAe,CAAC,GAAG,CAAC,oBAAoB,CAAC,QAAQ,CAAC,KAAK,EAAE,QAAQ,CAAC,sBAAsB,EAAE,CAAC,CAAC,CAAC;QAC7F,eAAe,CAAC,GAAG,CAAC,4BAA4B,CAAC,QAAQ,CAAC,KAAK,EAAE;YAChE,QAAQ,EAAE,CAAC,CAAC,GAAG,EAAE,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;SAChE,CAAC,CAAC,CAAC;QAEJ,MAAM,KAAK,GAAG,eAAe,CAAC,GAAG,CAAC,oBAAoB,CAAC,oBAAoB,EAAE,QAAQ,CAAC,OAAO,EAAE,EAAE,KAAK,CAAC,CAAC,CAAC;QACzG,KAAK,CAAC,YAAY,CAAC,iBAAiB,CAAC,KAAK,CAAC,YAAY,EAAE,CAAC,CAAC;QAE3D,MAAM,QAAQ,GAAG,IAAI,6BAA6B,CAAC,gBAAgB,EAAE,CAAC,CAAC,EAAE,CAAC,4BAA4B,CAAC,wBAAwB,CAAC,CAAC,CAAC,CAAC,CAAC;QAEpI,MAAM,MAAM,GAAG,aAAa,CAAC,IAAI,mBAAmB,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC,CAAC;QAEvE,MAAM,CAAC,eAAe,CAAC,KAAK,CAAC,MAAM,EAAE,KAAK,EAAE,gBAAgB,CAAC,EAAE;YAC9D,EAAE,IAAI,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE;YAC5D;gBACC,IAAI,EAAE,GAAG;gBACT,SAAS,EAAE,eAAe;gBAC1B,UAAU,EAAE,CAAC,eAAe,CAAC;gBAC7B,IAAI,EAAE,gBAAgB;aACtB;YACD,EAAE,IAAI,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE;YAC5D;gBACC,IAAI,EAAE,GAAG;gBACT,SAAS,EAAE,eAAe;gBAC1B,UAAU,EAAE,CAAC,eAAe,CAAC;gBAC7B,IAAI,EAAE,gBAAgB;aACtB;YACD,EAAE,IAAI,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE;YAC5D;gBACC,IAAI,EAAE,OAAO;gBACb,SAAS,EAAE,mBAAmB;gBAC9B,UAAU,EAAE,CAAC,mBAAmB,CAAC;gBACjC,IAAI,EAAE,gBAAgB;aACtB;YACD,EAAE,IAAI,EAAE,GAAG,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE;YAC5D;gBACC,IAAI,EAAE,KAAK;gBACX,SAAS,EAAE,mBAAmB;gBAC9B,UAAU,EAAE,CAAC,mBAAmB,CAAC;gBACjC,IAAI,EAAE,gBAAgB;aACtB;YACD,EAAE,IAAI,EAAE,UAAU,EAAE,SAAS,EAAE,IAAI,EAAE,UAAU,EAAE,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE;YACnE;gBACC,IAAI,EAAE,GAAG;gBACT,SAAS,EAAE,eAAe;gBAC1B,UAAU,EAAE,CAAC,eAAe,CAAC;gBAC7B,IAAI,EAAE,gBAAgB;aACtB;SACD,CAAC,CAAC;QAEH,eAAe,CAAC,OAAO,EAAE,CAAC;IAC3B,CAAC,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAEH,SAAS,aAAa,CAAC,SAAoB;IAC1C,MAAM,MAAM,GAAG,IAAI,KAAK,EAAS,CAAC;IAClC,OAAO,IAAI,EAAE,CAAC;QACb,MAAM,KAAK,GAAG,SAAS,CAAC,IAAI,EAAE,CAAC;QAC/B,IAAI,CAAC,KAAK,EAAE,CAAC;YACZ,MAAM;QACP,CAAC;QACD,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;IACpB,CAAC;IACD,OAAO,MAAM,CAAC;AACf,CAAC;AAED,SAAS,KAAK,CAAC,MAAe,EAAE,KAAgB,EAAE,WAAqC;IACtF,MAAM,MAAM,GAAG,IAAI,KAAK,EAAO,CAAC;IAChC,IAAI,MAAM,GAAG,UAAU,CAAC;IACxB,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;QAC5B,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,EAAE,MAAM,EAAE,KAAK,EAAE,WAAW,CAAC,CAAC,CAAC;QAC3D,MAAM,GAAG,SAAS,CAAC,MAAM,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC;IAC1C,CAAC;IACD,OAAO,MAAM,CAAC;AACf,CAAC;AAED,SAAS,UAAU,CAAC,KAAY,EAAE,MAAc,EAAE,KAAgB,EAAE,WAAkC;IACrG,OAAO;QACN,IAAI,EAAE,KAAK,CAAC,eAAe,CAAC,cAAc,CAAC,MAAM,EAAE,SAAS,CAAC,MAAM,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;QACpF,SAAS,EAAE,WAAW,CAAC,aAAa,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,IAAI;QAC7D,UAAU,EAAE,WAAW,CAAC,gBAAgB,CAAC,KAAK,CAAC,UAAU,CAAC;QAC1D,IAAI,EAAE;YACL,kCAA0B,EAAE,gBAAgB;YAC5C,kCAA0B,EAAE,gBAAgB;YAC5C,wBAAgB,EAAE,MAAM;SACxB,CAAC,KAAK,CAAC,IAAI,CAAC;KACb,CAAC;AACH,CAAC;AAED,MAAM,OAAO,iBAAiB;IAE7B,YAAY,MAAmB;QAC9B,MAAM,YAAY,GAAG,IAAI,KAAK,EAAe,CAAC;QAC9C,IAAI,OAAO,GAAG,IAAI,KAAK,EAAa,CAAC;QAErC,KAAK,MAAM,KAAK,IAAI,MAAM,EAAE,CAAC;YAC5B,MAAM,KAAK,GAAG,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;YACrC,IAAI,KAAK,GAAG,IAAI,CAAC;YACjB,OAAO,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBACzB,IAAI,CAAC,KAAK,EAAE,CAAC;oBACZ,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;oBAC3B,OAAO,GAAG,IAAI,KAAK,EAAa,CAAC;gBAClC,CAAC;qBAAM,CAAC;oBACP,KAAK,GAAG,KAAK,CAAC;gBACf,CAAC;gBAED,IAAI,KAAK,CAAC,CAAC,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACzB,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;gBACxC,CAAC;gBACD,KAAK,CAAC,GAAG,EAAE,CAAC;YACb,CAAC;QACF,CAAC;QAED,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAE3B,IAAI,CAAC,YAAY,GAAG,YAAY,CAAC;IAClC,CAAC;IAED,OAAO;QACN,OAAO,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAC3E,CAAC;IAED,sBAAsB;QACrB,MAAM,KAAK;YACV,YAA4B,UAAkB;gBAAlB,eAAU,GAAV,UAAU,CAAQ;YAAI,CAAC;YAEnD,KAAK;gBACJ,OAAO,IAAI,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YACnC,CAAC;YAED,MAAM,CAAC,KAAa;gBACnB,OAAO,IAAI,CAAC,UAAU,KAAM,KAAe,CAAC,UAAU,CAAC;YACxD,CAAC;SACD;QAED,OAAO;YACN,eAAe,EAAE,GAAG,EAAE,CAAC,IAAI,KAAK,CAAC,CAAC,CAAC;YACnC,QAAQ,EAAE,GAAG,EAAE,GAAG,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC,CAAC,CAAC;YAC/D,eAAe,EAAE,CAAC,IAAY,EAAE,MAAe,EAAE,KAAa,EAA6B,EAAE;gBAC5F,MAAM,MAAM,GAAG,KAAc,CAAC;gBAC9B,MAAM,MAAM,GAAG,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;gBACpD,MAAM,GAAG,GAAG,IAAI,KAAK,EAAU,CAAC;gBAChC,IAAI,MAAM,GAAG,CAAC,CAAC;gBACf,KAAK,MAAM,CAAC,IAAI,MAAM,EAAE,CAAC;oBACxB,GAAG,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC,WAAW,EAAE,CAAC,CAAC;oBAClC,MAAM,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC;gBACzB,CAAC;gBAED,OAAO,IAAI,yBAAyB,CAAC,IAAI,WAAW,CAAC,GAAG,CAAC,EAAE,IAAI,KAAK,CAAC,MAAM,CAAC,UAAU,GAAG,CAAC,CAAC,CAAC,CAAC;YAC9F,CAAC;SACD,CAAC;IACH,CAAC;CACD;AAED,MAAM,OAAO,SAAS;IACrB,YACiB,IAAY,EACZ,UAAsB,EACtB,SAA4B,EAC5B,mBAA4B;QAH5B,SAAI,GAAJ,IAAI,CAAQ;QACZ,eAAU,GAAV,UAAU,CAAY;QACtB,cAAS,GAAT,SAAS,CAAmB;QAC5B,wBAAmB,GAAnB,mBAAmB,CAAS;IACzC,CAAC;IAEL,WAAW;QACV,OAAO,CACN,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,4CAAoC,CAAC;YACtD,CAAC,IAAI,CAAC,SAAS,4CAAoC,CAAC,CAAC;YACrD,CAAC,CAAC;YACH,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC,kDAAuC,CAAC,CAAC,CAAC,CAAC,CACtE,CAAC;IACH,CAAC;IAED,QAAQ,CAAC,IAAY;QACpB,OAAO,IAAI,SAAS,CAAC,IAAI,EAAE,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,mBAAmB,CAAC,CAAC;IACvF,CAAC;CACD","file":"tokenizer.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { LanguageId, MetadataConsts, StandardTokenType } from '../../../../common/encodedTokenAttributes.js';\nimport { EncodedTokenizationResult, IState, ITokenizationSupport, TokenizationRegistry } from '../../../../common/languages.js';\nimport { ILanguageService } from '../../../../common/languages/language.js';\nimport { ILanguageConfigurationService } from '../../../../common/languages/languageConfigurationRegistry.js';\nimport { LanguageAgnosticBracketTokens } from '../../../../common/model/bracketPairsTextModelPart/bracketPairsTree/brackets.js';\nimport { Length, lengthAdd, lengthsToRange, lengthZero } from '../../../../common/model/bracketPairsTextModelPart/bracketPairsTree/length.js';\nimport { DenseKeyProvider } from '../../../../common/model/bracketPairsTextModelPart/bracketPairsTree/smallImmutableSet.js';\nimport { TextBufferTokenizer, Token, Tokenizer, TokenKind } from '../../../../common/model/bracketPairsTextModelPart/bracketPairsTree/tokenizer.js';\nimport { TextModel } from '../../../../common/model/textModel.js';\nimport { createModelServices, instantiateTextModel } from '../../testTextModel.js';\n\nsuite('Bracket Pair Colorizer - Tokenizer', () => {\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('Basic', () => {\n\t\tconst mode1 = 'testMode1';\n\t\tconst disposableStore = new DisposableStore();\n\t\tconst instantiationService = createModelServices(disposableStore);\n\t\tconst languageConfigurationService = instantiationService.get(ILanguageConfigurationService);\n\t\tconst languageService = instantiationService.get(ILanguageService);\n\t\tdisposableStore.add(languageService.registerLanguage({ id: mode1 }));\n\t\tconst encodedMode1 = languageService.languageIdCodec.encodeLanguageId(mode1);\n\n\t\tconst denseKeyProvider = new DenseKeyProvider<string>();\n\n\t\tconst tStandard = (text: string) => new TokenInfo(text, encodedMode1, StandardTokenType.Other, true);\n\t\tconst tComment = (text: string) => new TokenInfo(text, encodedMode1, StandardTokenType.Comment, true);\n\t\tconst document = new TokenizedDocument([\n\t\t\ttStandard(' { } '), tStandard('be'), tStandard('gin end'), tStandard('\\n'),\n\t\t\ttStandard('hello'), tComment('{'), tStandard('}'),\n\t\t]);\n\n\t\tdisposableStore.add(TokenizationRegistry.register(mode1, document.getTokenizationSupport()));\n\t\tdisposableStore.add(languageConfigurationService.register(mode1, {\n\t\t\tbrackets: [['{', '}'], ['[', ']'], ['(', ')'], ['begin', 'end']],\n\t\t}));\n\n\t\tconst model = disposableStore.add(instantiateTextModel(instantiationService, document.getText(), mode1));\n\t\tmodel.tokenization.forceTokenization(model.getLineCount());\n\n\t\tconst brackets = new LanguageAgnosticBracketTokens(denseKeyProvider, l => languageConfigurationService.getLanguageConfiguration(l));\n\n\t\tconst tokens = readAllTokens(new TextBufferTokenizer(model, brackets));\n\n\t\tassert.deepStrictEqual(toArr(tokens, model, denseKeyProvider), [\n\t\t\t{ text: ' ', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: '{',\n\t\t\t\tbracketId: 'testMode1:::{',\n\t\t\t\tbracketIds: ['testMode1:::{'],\n\t\t\t\tkind: 'OpeningBracket',\n\t\t\t},\n\t\t\t{ text: ' ', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: '}',\n\t\t\t\tbracketId: 'testMode1:::{',\n\t\t\t\tbracketIds: ['testMode1:::{'],\n\t\t\t\tkind: 'ClosingBracket',\n\t\t\t},\n\t\t\t{ text: ' ', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: 'begin',\n\t\t\t\tbracketId: 'testMode1:::begin',\n\t\t\t\tbracketIds: ['testMode1:::begin'],\n\t\t\t\tkind: 'OpeningBracket',\n\t\t\t},\n\t\t\t{ text: ' ', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: 'end',\n\t\t\t\tbracketId: 'testMode1:::begin',\n\t\t\t\tbracketIds: ['testMode1:::begin'],\n\t\t\t\tkind: 'ClosingBracket',\n\t\t\t},\n\t\t\t{ text: '\\nhello{', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: '}',\n\t\t\t\tbracketId: 'testMode1:::{',\n\t\t\t\tbracketIds: ['testMode1:::{'],\n\t\t\t\tkind: 'ClosingBracket',\n\t\t\t},\n\t\t]);\n\n\t\tdisposableStore.dispose();\n\t});\n});\n\nfunction readAllTokens(tokenizer: Tokenizer): Token[] {\n\tconst tokens = new Array<Token>();\n\twhile (true) {\n\t\tconst token = tokenizer.read();\n\t\tif (!token) {\n\t\t\tbreak;\n\t\t}\n\t\ttokens.push(token);\n\t}\n\treturn tokens;\n}\n\nfunction toArr(tokens: Token[], model: TextModel, keyProvider: DenseKeyProvider<string>): any[] {\n\tconst result = new Array<any>();\n\tlet offset = lengthZero;\n\tfor (const token of tokens) {\n\t\tresult.push(tokenToObj(token, offset, model, keyProvider));\n\t\toffset = lengthAdd(offset, token.length);\n\t}\n\treturn result;\n}\n\nfunction tokenToObj(token: Token, offset: Length, model: TextModel, keyProvider: DenseKeyProvider<any>): any {\n\treturn {\n\t\ttext: model.getValueInRange(lengthsToRange(offset, lengthAdd(offset, token.length))),\n\t\tbracketId: keyProvider.reverseLookup(token.bracketId) || null,\n\t\tbracketIds: keyProvider.reverseLookupSet(token.bracketIds),\n\t\tkind: {\n\t\t\t[TokenKind.ClosingBracket]: 'ClosingBracket',\n\t\t\t[TokenKind.OpeningBracket]: 'OpeningBracket',\n\t\t\t[TokenKind.Text]: 'Text',\n\t\t}[token.kind]\n\t};\n}\n\nexport class TokenizedDocument {\n\tprivate readonly tokensByLine: readonly TokenInfo[][];\n\tconstructor(tokens: TokenInfo[]) {\n\t\tconst tokensByLine = new Array<TokenInfo[]>();\n\t\tlet curLine = new Array<TokenInfo>();\n\n\t\tfor (const token of tokens) {\n\t\t\tconst lines = token.text.split('\\n');\n\t\t\tlet first = true;\n\t\t\twhile (lines.length > 0) {\n\t\t\t\tif (!first) {\n\t\t\t\t\ttokensByLine.push(curLine);\n\t\t\t\t\tcurLine = new Array<TokenInfo>();\n\t\t\t\t} else {\n\t\t\t\t\tfirst = false;\n\t\t\t\t}\n\n\t\t\t\tif (lines[0].length > 0) {\n\t\t\t\t\tcurLine.push(token.withText(lines[0]));\n\t\t\t\t}\n\t\t\t\tlines.pop();\n\t\t\t}\n\t\t}\n\n\t\ttokensByLine.push(curLine);\n\n\t\tthis.tokensByLine = tokensByLine;\n\t}\n\n\tgetText() {\n\t\treturn this.tokensByLine.map(t => t.map(t => t.text).join('')).join('\\n');\n\t}\n\n\tgetTokenizationSupport(): ITokenizationSupport {\n\t\tclass State implements IState {\n\t\t\tconstructor(public readonly lineNumber: number) { }\n\n\t\t\tclone(): IState {\n\t\t\t\treturn new State(this.lineNumber);\n\t\t\t}\n\n\t\t\tequals(other: IState): boolean {\n\t\t\t\treturn this.lineNumber === (other as State).lineNumber;\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tgetInitialState: () => new State(0),\n\t\t\ttokenize: () => { throw new Error('Method not implemented.'); },\n\t\t\ttokenizeEncoded: (line: string, hasEOL: boolean, state: IState): EncodedTokenizationResult => {\n\t\t\t\tconst state2 = state as State;\n\t\t\t\tconst tokens = this.tokensByLine[state2.lineNumber];\n\t\t\t\tconst arr = new Array<number>();\n\t\t\t\tlet offset = 0;\n\t\t\t\tfor (const t of tokens) {\n\t\t\t\t\tarr.push(offset, t.getMetadata());\n\t\t\t\t\toffset += t.text.length;\n\t\t\t\t}\n\n\t\t\t\treturn new EncodedTokenizationResult(new Uint32Array(arr), new State(state2.lineNumber + 1));\n\t\t\t}\n\t\t};\n\t}\n}\n\nexport class TokenInfo {\n\tconstructor(\n\t\tpublic readonly text: string,\n\t\tpublic readonly languageId: LanguageId,\n\t\tpublic readonly tokenType: StandardTokenType,\n\t\tpublic readonly hasBalancedBrackets: boolean,\n\t) { }\n\n\tgetMetadata(): number {\n\t\treturn (\n\t\t\t(((this.languageId << MetadataConsts.LANGUAGEID_OFFSET) |\n\t\t\t\t(this.tokenType << MetadataConsts.TOKEN_TYPE_OFFSET)) >>>\n\t\t\t\t0) |\n\t\t\t(this.hasBalancedBrackets ? MetadataConsts.BALANCED_BRACKETS_MASK : 0)\n\t\t);\n\t}\n\n\twithText(text: string): TokenInfo {\n\t\treturn new TokenInfo(text, this.languageId, this.tokenType, this.hasBalancedBrackets);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { DisposableStore } from '../../../../../base/common/lifecycle.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../../base/test/common/utils.js';\nimport { LanguageId, MetadataConsts, StandardTokenType } from '../../../../common/encodedTokenAttributes.js';\nimport { EncodedTokenizationResult, IState, ITokenizationSupport, TokenizationRegistry } from '../../../../common/languages.js';\nimport { ILanguageService } from '../../../../common/languages/language.js';\nimport { ILanguageConfigurationService } from '../../../../common/languages/languageConfigurationRegistry.js';\nimport { LanguageAgnosticBracketTokens } from '../../../../common/model/bracketPairsTextModelPart/bracketPairsTree/brackets.js';\nimport { Length, lengthAdd, lengthsToRange, lengthZero } from '../../../../common/model/bracketPairsTextModelPart/bracketPairsTree/length.js';\nimport { DenseKeyProvider } from '../../../../common/model/bracketPairsTextModelPart/bracketPairsTree/smallImmutableSet.js';\nimport { TextBufferTokenizer, Token, Tokenizer, TokenKind } from '../../../../common/model/bracketPairsTextModelPart/bracketPairsTree/tokenizer.js';\nimport { TextModel } from '../../../../common/model/textModel.js';\nimport { createModelServices, instantiateTextModel } from '../../testTextModel.js';\n\nsuite('Bracket Pair Colorizer - Tokenizer', () => {\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\ttest('Basic', () => {\n\t\tconst mode1 = 'testMode1';\n\t\tconst disposableStore = new DisposableStore();\n\t\tconst instantiationService = createModelServices(disposableStore);\n\t\tconst languageConfigurationService = instantiationService.get(ILanguageConfigurationService);\n\t\tconst languageService = instantiationService.get(ILanguageService);\n\t\tdisposableStore.add(languageService.registerLanguage({ id: mode1 }));\n\t\tconst encodedMode1 = languageService.languageIdCodec.encodeLanguageId(mode1);\n\n\t\tconst denseKeyProvider = new DenseKeyProvider<string>();\n\n\t\tconst tStandard = (text: string) => new TokenInfo(text, encodedMode1, StandardTokenType.Other, true);\n\t\tconst tComment = (text: string) => new TokenInfo(text, encodedMode1, StandardTokenType.Comment, true);\n\t\tconst document = new TokenizedDocument([\n\t\t\ttStandard(' { } '), tStandard('be'), tStandard('gin end'), tStandard('\\n'),\n\t\t\ttStandard('hello'), tComment('{'), tStandard('}'),\n\t\t]);\n\n\t\tdisposableStore.add(TokenizationRegistry.register(mode1, document.getTokenizationSupport()));\n\t\tdisposableStore.add(languageConfigurationService.register(mode1, {\n\t\t\tbrackets: [['{', '}'], ['[', ']'], ['(', ')'], ['begin', 'end']],\n\t\t}));\n\n\t\tconst model = disposableStore.add(instantiateTextModel(instantiationService, document.getText(), mode1));\n\t\tmodel.tokenization.forceTokenization(model.getLineCount());\n\n\t\tconst brackets = new LanguageAgnosticBracketTokens(denseKeyProvider, l => languageConfigurationService.getLanguageConfiguration(l));\n\n\t\tconst tokens = readAllTokens(new TextBufferTokenizer(model, brackets));\n\n\t\tassert.deepStrictEqual(toArr(tokens, model, denseKeyProvider), [\n\t\t\t{ text: ' ', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: '{',\n\t\t\t\tbracketId: 'testMode1:::{',\n\t\t\t\tbracketIds: ['testMode1:::{'],\n\t\t\t\tkind: 'OpeningBracket',\n\t\t\t},\n\t\t\t{ text: ' ', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: '}',\n\t\t\t\tbracketId: 'testMode1:::{',\n\t\t\t\tbracketIds: ['testMode1:::{'],\n\t\t\t\tkind: 'ClosingBracket',\n\t\t\t},\n\t\t\t{ text: ' ', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: 'begin',\n\t\t\t\tbracketId: 'testMode1:::begin',\n\t\t\t\tbracketIds: ['testMode1:::begin'],\n\t\t\t\tkind: 'OpeningBracket',\n\t\t\t},\n\t\t\t{ text: ' ', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: 'end',\n\t\t\t\tbracketId: 'testMode1:::begin',\n\t\t\t\tbracketIds: ['testMode1:::begin'],\n\t\t\t\tkind: 'ClosingBracket',\n\t\t\t},\n\t\t\t{ text: '\\nhello{', bracketId: null, bracketIds: [], kind: 'Text' },\n\t\t\t{\n\t\t\t\ttext: '}',\n\t\t\t\tbracketId: 'testMode1:::{',\n\t\t\t\tbracketIds: ['testMode1:::{'],\n\t\t\t\tkind: 'ClosingBracket',\n\t\t\t},\n\t\t]);\n\n\t\tdisposableStore.dispose();\n\t});\n});\n\nfunction readAllTokens(tokenizer: Tokenizer): Token[] {\n\tconst tokens = new Array<Token>();\n\twhile (true) {\n\t\tconst token = tokenizer.read();\n\t\tif (!token) {\n\t\t\tbreak;\n\t\t}\n\t\ttokens.push(token);\n\t}\n\treturn tokens;\n}\n\nfunction toArr(tokens: Token[], model: TextModel, keyProvider: DenseKeyProvider<string>): any[] {\n\tconst result = new Array<any>();\n\tlet offset = lengthZero;\n\tfor (const token of tokens) {\n\t\tresult.push(tokenToObj(token, offset, model, keyProvider));\n\t\toffset = lengthAdd(offset, token.length);\n\t}\n\treturn result;\n}\n\nfunction tokenToObj(token: Token, offset: Length, model: TextModel, keyProvider: DenseKeyProvider<any>): any {\n\treturn {\n\t\ttext: model.getValueInRange(lengthsToRange(offset, lengthAdd(offset, token.length))),\n\t\tbracketId: keyProvider.reverseLookup(token.bracketId) || null,\n\t\tbracketIds: keyProvider.reverseLookupSet(token.bracketIds),\n\t\tkind: {\n\t\t\t[TokenKind.ClosingBracket]: 'ClosingBracket',\n\t\t\t[TokenKind.OpeningBracket]: 'OpeningBracket',\n\t\t\t[TokenKind.Text]: 'Text',\n\t\t}[token.kind]\n\t};\n}\n\nexport class TokenizedDocument {\n\tprivate readonly tokensByLine: readonly TokenInfo[][];\n\tconstructor(tokens: TokenInfo[]) {\n\t\tconst tokensByLine = new Array<TokenInfo[]>();\n\t\tlet curLine = new Array<TokenInfo>();\n\n\t\tfor (const token of tokens) {\n\t\t\tconst lines = token.text.split('\\n');\n\t\t\tlet first = true;\n\t\t\twhile (lines.length > 0) {\n\t\t\t\tif (!first) {\n\t\t\t\t\ttokensByLine.push(curLine);\n\t\t\t\t\tcurLine = new Array<TokenInfo>();\n\t\t\t\t} else {\n\t\t\t\t\tfirst = false;\n\t\t\t\t}\n\n\t\t\t\tif (lines[0].length > 0) {\n\t\t\t\t\tcurLine.push(token.withText(lines[0]));\n\t\t\t\t}\n\t\t\t\tlines.pop();\n\t\t\t}\n\t\t}\n\n\t\ttokensByLine.push(curLine);\n\n\t\tthis.tokensByLine = tokensByLine;\n\t}\n\n\tgetText() {\n\t\treturn this.tokensByLine.map(t => t.map(t => t.text).join('')).join('\\n');\n\t}\n\n\tgetTokenizationSupport(): ITokenizationSupport {\n\t\tclass State implements IState {\n\t\t\tconstructor(public readonly lineNumber: number) { }\n\n\t\t\tclone(): IState {\n\t\t\t\treturn new State(this.lineNumber);\n\t\t\t}\n\n\t\t\tequals(other: IState): boolean {\n\t\t\t\treturn this.lineNumber === (other as State).lineNumber;\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tgetInitialState: () => new State(0),\n\t\t\ttokenize: () => { throw new Error('Method not implemented.'); },\n\t\t\ttokenizeEncoded: (line: string, hasEOL: boolean, state: IState): EncodedTokenizationResult => {\n\t\t\t\tconst state2 = state as State;\n\t\t\t\tconst tokens = this.tokensByLine[state2.lineNumber];\n\t\t\t\tconst arr = new Array<number>();\n\t\t\t\tlet offset = 0;\n\t\t\t\tfor (const t of tokens) {\n\t\t\t\t\tarr.push(offset, t.getMetadata());\n\t\t\t\t\toffset += t.text.length;\n\t\t\t\t}\n\n\t\t\t\treturn new EncodedTokenizationResult(new Uint32Array(arr), new State(state2.lineNumber + 1));\n\t\t\t}\n\t\t};\n\t}\n}\n\nexport class TokenInfo {\n\tconstructor(\n\t\tpublic readonly text: string,\n\t\tpublic readonly languageId: LanguageId,\n\t\tpublic readonly tokenType: StandardTokenType,\n\t\tpublic readonly hasBalancedBrackets: boolean,\n\t) { }\n\n\tgetMetadata(): number {\n\t\treturn (\n\t\t\t(((this.languageId << MetadataConsts.LANGUAGEID_OFFSET) |\n\t\t\t\t(this.tokenType << MetadataConsts.TOKEN_TYPE_OFFSET)) >>>\n\t\t\t\t0) |\n\t\t\t(this.hasBalancedBrackets ? MetadataConsts.BALANCED_BRACKETS_MASK : 0)\n\t\t);\n\t}\n\n\twithText(text: string): TokenInfo {\n\t\treturn new TokenInfo(text, this.languageId, this.tokenType, this.hasBalancedBrackets);\n\t}\n}\n"]}