{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/editor/test/node/diffing/fixtures.test.ts","vs/editor/test/node/diffing/fixtures.test.ts"],"names":[],"mappings":"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","file":"fixtures.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { existsSync, readFileSync, readdirSync, rmSync, writeFileSync } from 'fs';\nimport { join, resolve } from '../../../../base/common/path.js';\nimport { setUnexpectedErrorHandler } from '../../../../base/common/errors.js';\nimport { FileAccess } from '../../../../base/common/network.js';\nimport { DetailedLineRangeMapping, RangeMapping } from '../../../common/diff/rangeMapping.js';\nimport { LegacyLinesDiffComputer } from '../../../common/diff/legacyLinesDiffComputer.js';\nimport { DefaultLinesDiffComputer } from '../../../common/diff/defaultLinesDiffComputer/defaultLinesDiffComputer.js';\nimport { Range } from '../../../common/core/range.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { TextReplacement, TextEdit } from '../../../common/core/edits/textEdit.js';\nimport { AbstractText, ArrayText } from '../../../common/core/text/abstractText.js';\nimport { LinesDiff } from '../../../common/diff/linesDiffComputer.js';\n\nsuite('diffing fixtures', () => {\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tsetup(() => {\n\t\tsetUnexpectedErrorHandler(e => {\n\t\t\tthrow e;\n\t\t});\n\t});\n\n\n\tconst fixturesOutDir = FileAccess.asFileUri('vs/editor/test/node/diffing/fixtures').fsPath;\n\t// We want the dir in src, so we can directly update the source files if they disagree and create invalid files to capture the previous state.\n\t// This makes it very easy to update the fixtures.\n\tconst fixturesSrcDir = resolve(fixturesOutDir).replaceAll('\\\\', '/').replace('/out/vs/editor/', '/src/vs/editor/');\n\tconst folders = readdirSync(fixturesSrcDir);\n\n\tfunction runTest(folder: string, diffingAlgoName: 'legacy' | 'advanced') {\n\t\tconst folderPath = join(fixturesSrcDir, folder);\n\t\tconst files = readdirSync(folderPath);\n\n\t\tconst firstFileName = files.find(f => f.startsWith('1.'))!;\n\t\tconst secondFileName = files.find(f => f.startsWith('2.'))!;\n\n\t\tconst firstContent = readFileSync(join(folderPath, firstFileName), 'utf8').replaceAll('\\r\\n', '\\n').replaceAll('\\r', '\\n');\n\t\tconst firstContentLines = firstContent.split(/\\n/);\n\t\tconst secondContent = readFileSync(join(folderPath, secondFileName), 'utf8').replaceAll('\\r\\n', '\\n').replaceAll('\\r', '\\n');\n\t\tconst secondContentLines = secondContent.split(/\\n/);\n\n\t\tconst diffingAlgo = diffingAlgoName === 'legacy' ? new LegacyLinesDiffComputer() : new DefaultLinesDiffComputer();\n\n\t\tconst ignoreTrimWhitespace = folder.indexOf('trimws') >= 0;\n\t\tconst diff = diffingAlgo.computeDiff(firstContentLines, secondContentLines, { ignoreTrimWhitespace, maxComputationTimeMs: Number.MAX_SAFE_INTEGER, computeMoves: true });\n\n\t\tif (diffingAlgoName === 'advanced' && !ignoreTrimWhitespace) {\n\t\t\tassertDiffCorrectness(diff, firstContentLines, secondContentLines);\n\t\t}\n\n\t\tfunction getDiffs(changes: readonly DetailedLineRangeMapping[]): IDetailedDiff[] {\n\t\t\tfor (const c of changes) {\n\t\t\t\tRangeMapping.assertSorted(c.innerChanges ?? []);\n\t\t\t}\n\n\t\t\treturn changes.map<IDetailedDiff>(c => ({\n\t\t\t\toriginalRange: c.original.toString(),\n\t\t\t\tmodifiedRange: c.modified.toString(),\n\t\t\t\tinnerChanges: c.innerChanges?.map<IDiff>(c => ({\n\t\t\t\t\toriginalRange: formatRange(c.originalRange, firstContentLines),\n\t\t\t\t\tmodifiedRange: formatRange(c.modifiedRange, secondContentLines),\n\t\t\t\t})) || null\n\t\t\t}));\n\t\t}\n\n\t\tfunction formatRange(range: Range, lines: string[]): string {\n\t\t\tconst toLastChar = range.endColumn === lines[range.endLineNumber - 1].length + 1;\n\n\t\t\treturn '[' + range.startLineNumber + ',' + range.startColumn + ' -> ' + range.endLineNumber + ',' + range.endColumn + (toLastChar ? ' EOL' : '') + ']';\n\t\t}\n\n\t\tconst actualDiffingResult: DiffingResult = {\n\t\t\toriginal: { content: firstContent, fileName: `./${firstFileName}` },\n\t\t\tmodified: { content: secondContent, fileName: `./${secondFileName}` },\n\t\t\tdiffs: getDiffs(diff.changes),\n\t\t\tmoves: diff.moves.map(v => ({\n\t\t\t\toriginalRange: v.lineRangeMapping.original.toString(),\n\t\t\t\tmodifiedRange: v.lineRangeMapping.modified.toString(),\n\t\t\t\tchanges: getDiffs(v.changes),\n\t\t\t}))\n\t\t};\n\t\tif (actualDiffingResult.moves?.length === 0) {\n\t\t\tdelete actualDiffingResult.moves;\n\t\t}\n\n\t\tconst expectedFilePath = join(folderPath, `${diffingAlgoName}.expected.diff.json`);\n\t\tconst invalidFilePath = join(folderPath, `${diffingAlgoName}.invalid.diff.json`);\n\n\t\tconst actualJsonStr = JSON.stringify(actualDiffingResult, null, '\\t');\n\n\t\tif (!existsSync(expectedFilePath)) {\n\t\t\t// New test, create expected file\n\t\t\twriteFileSync(expectedFilePath, actualJsonStr);\n\t\t\t// Create invalid file so that this test fails on a re-run\n\t\t\twriteFileSync(invalidFilePath, '');\n\t\t\tthrow new Error('No expected file! Expected and invalid files were written. Delete the invalid file to make the test pass.');\n\t\t} if (existsSync(invalidFilePath)) {\n\t\t\tconst invalidJsonStr = readFileSync(invalidFilePath, 'utf8');\n\t\t\tif (invalidJsonStr === '') {\n\t\t\t\t// Update expected file\n\t\t\t\twriteFileSync(expectedFilePath, actualJsonStr);\n\t\t\t\tthrow new Error(`Delete the invalid ${invalidFilePath} file to make the test pass.`);\n\t\t\t} else {\n\t\t\t\tconst expectedFileDiffResult: DiffingResult = JSON.parse(invalidJsonStr);\n\t\t\t\ttry {\n\t\t\t\t\tassert.deepStrictEqual(actualDiffingResult, expectedFileDiffResult);\n\t\t\t\t} catch (e) {\n\t\t\t\t\twriteFileSync(expectedFilePath, actualJsonStr);\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t\t// Test succeeded with the invalid file, restore expected file from invalid\n\t\t\t\twriteFileSync(expectedFilePath, invalidJsonStr);\n\t\t\t\trmSync(invalidFilePath);\n\t\t\t}\n\t\t} else {\n\t\t\tconst expectedJsonStr = readFileSync(expectedFilePath, 'utf8');\n\t\t\tconst expectedFileDiffResult: DiffingResult = JSON.parse(expectedJsonStr);\n\t\t\ttry {\n\t\t\t\tassert.deepStrictEqual(actualDiffingResult, expectedFileDiffResult);\n\t\t\t} catch (e) {\n\t\t\t\t// Backup expected file\n\t\t\t\twriteFileSync(invalidFilePath, expectedJsonStr);\n\t\t\t\t// Update expected file\n\t\t\t\twriteFileSync(expectedFilePath, actualJsonStr);\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n\n\ttest(`test`, () => {\n\t\trunTest('invalid-diff-trimws', 'advanced');\n\t});\n\n\tfor (const folder of folders) {\n\t\tfor (const diffingAlgoName of ['legacy', 'advanced'] as const) {\n\t\t\ttest(`${folder}-${diffingAlgoName}`, () => {\n\t\t\t\trunTest(folder, diffingAlgoName);\n\t\t\t});\n\t\t}\n\t}\n});\n\ninterface DiffingResult {\n\toriginal: { content: string; fileName: string };\n\tmodified: { content: string; fileName: string };\n\n\tdiffs: IDetailedDiff[];\n\tmoves?: IMoveInfo[];\n}\n\ninterface IDetailedDiff {\n\toriginalRange: string; // [startLineNumber, endLineNumberExclusive)\n\tmodifiedRange: string; // [startLineNumber, endLineNumberExclusive)\n\tinnerChanges: IDiff[] | null;\n}\n\ninterface IDiff {\n\toriginalRange: string; // [1,18 -> 1,19]\n\tmodifiedRange: string; // [1,18 -> 1,19]\n}\n\ninterface IMoveInfo {\n\toriginalRange: string; // [startLineNumber, endLineNumberExclusive)\n\tmodifiedRange: string; // [startLineNumber, endLineNumberExclusive)\n\n\tchanges: IDetailedDiff[];\n}\n\nfunction assertDiffCorrectness(diff: LinesDiff, original: string[], modified: string[]) {\n\tconst allInnerChanges = diff.changes.flatMap(c => c.innerChanges!);\n\tconst edit = rangeMappingsToTextEdit(allInnerChanges, new ArrayText(modified));\n\tconst result = edit.normalize().apply(new ArrayText(original));\n\n\tassert.deepStrictEqual(result, modified.join('\\n'));\n}\n\nfunction rangeMappingsToTextEdit(rangeMappings: readonly RangeMapping[], modified: AbstractText): TextEdit {\n\treturn new TextEdit(rangeMappings.map(m => {\n\t\treturn new TextReplacement(\n\t\t\tm.originalRange,\n\t\t\tmodified.getValueOfRange(m.modifiedRange)\n\t\t);\n\t}));\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { existsSync, readFileSync, readdirSync, rmSync, writeFileSync } from 'fs';\nimport { join, resolve } from '../../../../base/common/path.js';\nimport { setUnexpectedErrorHandler } from '../../../../base/common/errors.js';\nimport { FileAccess } from '../../../../base/common/network.js';\nimport { DetailedLineRangeMapping, RangeMapping } from '../../../common/diff/rangeMapping.js';\nimport { LegacyLinesDiffComputer } from '../../../common/diff/legacyLinesDiffComputer.js';\nimport { DefaultLinesDiffComputer } from '../../../common/diff/defaultLinesDiffComputer/defaultLinesDiffComputer.js';\nimport { Range } from '../../../common/core/range.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { TextReplacement, TextEdit } from '../../../common/core/edits/textEdit.js';\nimport { AbstractText, ArrayText } from '../../../common/core/text/abstractText.js';\nimport { LinesDiff } from '../../../common/diff/linesDiffComputer.js';\n\nsuite('diffing fixtures', () => {\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tsetup(() => {\n\t\tsetUnexpectedErrorHandler(e => {\n\t\t\tthrow e;\n\t\t});\n\t});\n\n\n\tconst fixturesOutDir = FileAccess.asFileUri('vs/editor/test/node/diffing/fixtures').fsPath;\n\t// We want the dir in src, so we can directly update the source files if they disagree and create invalid files to capture the previous state.\n\t// This makes it very easy to update the fixtures.\n\tconst fixturesSrcDir = resolve(fixturesOutDir).replaceAll('\\\\', '/').replace('/out/vs/editor/', '/src/vs/editor/');\n\tconst folders = readdirSync(fixturesSrcDir);\n\n\tfunction runTest(folder: string, diffingAlgoName: 'legacy' | 'advanced') {\n\t\tconst folderPath = join(fixturesSrcDir, folder);\n\t\tconst files = readdirSync(folderPath);\n\n\t\tconst firstFileName = files.find(f => f.startsWith('1.'))!;\n\t\tconst secondFileName = files.find(f => f.startsWith('2.'))!;\n\n\t\tconst firstContent = readFileSync(join(folderPath, firstFileName), 'utf8').replaceAll('\\r\\n', '\\n').replaceAll('\\r', '\\n');\n\t\tconst firstContentLines = firstContent.split(/\\n/);\n\t\tconst secondContent = readFileSync(join(folderPath, secondFileName), 'utf8').replaceAll('\\r\\n', '\\n').replaceAll('\\r', '\\n');\n\t\tconst secondContentLines = secondContent.split(/\\n/);\n\n\t\tconst diffingAlgo = diffingAlgoName === 'legacy' ? new LegacyLinesDiffComputer() : new DefaultLinesDiffComputer();\n\n\t\tconst ignoreTrimWhitespace = folder.indexOf('trimws') >= 0;\n\t\tconst diff = diffingAlgo.computeDiff(firstContentLines, secondContentLines, { ignoreTrimWhitespace, maxComputationTimeMs: Number.MAX_SAFE_INTEGER, computeMoves: true });\n\n\t\tif (diffingAlgoName === 'advanced' && !ignoreTrimWhitespace) {\n\t\t\tassertDiffCorrectness(diff, firstContentLines, secondContentLines);\n\t\t}\n\n\t\tfunction getDiffs(changes: readonly DetailedLineRangeMapping[]): IDetailedDiff[] {\n\t\t\tfor (const c of changes) {\n\t\t\t\tRangeMapping.assertSorted(c.innerChanges ?? []);\n\t\t\t}\n\n\t\t\treturn changes.map<IDetailedDiff>(c => ({\n\t\t\t\toriginalRange: c.original.toString(),\n\t\t\t\tmodifiedRange: c.modified.toString(),\n\t\t\t\tinnerChanges: c.innerChanges?.map<IDiff>(c => ({\n\t\t\t\t\toriginalRange: formatRange(c.originalRange, firstContentLines),\n\t\t\t\t\tmodifiedRange: formatRange(c.modifiedRange, secondContentLines),\n\t\t\t\t})) || null\n\t\t\t}));\n\t\t}\n\n\t\tfunction formatRange(range: Range, lines: string[]): string {\n\t\t\tconst toLastChar = range.endColumn === lines[range.endLineNumber - 1].length + 1;\n\n\t\t\treturn '[' + range.startLineNumber + ',' + range.startColumn + ' -> ' + range.endLineNumber + ',' + range.endColumn + (toLastChar ? ' EOL' : '') + ']';\n\t\t}\n\n\t\tconst actualDiffingResult: DiffingResult = {\n\t\t\toriginal: { content: firstContent, fileName: `./${firstFileName}` },\n\t\t\tmodified: { content: secondContent, fileName: `./${secondFileName}` },\n\t\t\tdiffs: getDiffs(diff.changes),\n\t\t\tmoves: diff.moves.map(v => ({\n\t\t\t\toriginalRange: v.lineRangeMapping.original.toString(),\n\t\t\t\tmodifiedRange: v.lineRangeMapping.modified.toString(),\n\t\t\t\tchanges: getDiffs(v.changes),\n\t\t\t}))\n\t\t};\n\t\tif (actualDiffingResult.moves?.length === 0) {\n\t\t\tdelete actualDiffingResult.moves;\n\t\t}\n\n\t\tconst expectedFilePath = join(folderPath, `${diffingAlgoName}.expected.diff.json`);\n\t\tconst invalidFilePath = join(folderPath, `${diffingAlgoName}.invalid.diff.json`);\n\n\t\tconst actualJsonStr = JSON.stringify(actualDiffingResult, null, '\\t');\n\n\t\tif (!existsSync(expectedFilePath)) {\n\t\t\t// New test, create expected file\n\t\t\twriteFileSync(expectedFilePath, actualJsonStr);\n\t\t\t// Create invalid file so that this test fails on a re-run\n\t\t\twriteFileSync(invalidFilePath, '');\n\t\t\tthrow new Error('No expected file! Expected and invalid files were written. Delete the invalid file to make the test pass.');\n\t\t} if (existsSync(invalidFilePath)) {\n\t\t\tconst invalidJsonStr = readFileSync(invalidFilePath, 'utf8');\n\t\t\tif (invalidJsonStr === '') {\n\t\t\t\t// Update expected file\n\t\t\t\twriteFileSync(expectedFilePath, actualJsonStr);\n\t\t\t\tthrow new Error(`Delete the invalid ${invalidFilePath} file to make the test pass.`);\n\t\t\t} else {\n\t\t\t\tconst expectedFileDiffResult: DiffingResult = JSON.parse(invalidJsonStr);\n\t\t\t\ttry {\n\t\t\t\t\tassert.deepStrictEqual(actualDiffingResult, expectedFileDiffResult);\n\t\t\t\t} catch (e) {\n\t\t\t\t\twriteFileSync(expectedFilePath, actualJsonStr);\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t\t// Test succeeded with the invalid file, restore expected file from invalid\n\t\t\t\twriteFileSync(expectedFilePath, invalidJsonStr);\n\t\t\t\trmSync(invalidFilePath);\n\t\t\t}\n\t\t} else {\n\t\t\tconst expectedJsonStr = readFileSync(expectedFilePath, 'utf8');\n\t\t\tconst expectedFileDiffResult: DiffingResult = JSON.parse(expectedJsonStr);\n\t\t\ttry {\n\t\t\t\tassert.deepStrictEqual(actualDiffingResult, expectedFileDiffResult);\n\t\t\t} catch (e) {\n\t\t\t\t// Backup expected file\n\t\t\t\twriteFileSync(invalidFilePath, expectedJsonStr);\n\t\t\t\t// Update expected file\n\t\t\t\twriteFileSync(expectedFilePath, actualJsonStr);\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n\n\ttest(`test`, () => {\n\t\trunTest('invalid-diff-trimws', 'advanced');\n\t});\n\n\tfor (const folder of folders) {\n\t\tfor (const diffingAlgoName of ['legacy', 'advanced'] as const) {\n\t\t\ttest(`${folder}-${diffingAlgoName}`, () => {\n\t\t\t\trunTest(folder, diffingAlgoName);\n\t\t\t});\n\t\t}\n\t}\n});\n\ninterface DiffingResult {\n\toriginal: { content: string; fileName: string };\n\tmodified: { content: string; fileName: string };\n\n\tdiffs: IDetailedDiff[];\n\tmoves?: IMoveInfo[];\n}\n\ninterface IDetailedDiff {\n\toriginalRange: string; // [startLineNumber, endLineNumberExclusive)\n\tmodifiedRange: string; // [startLineNumber, endLineNumberExclusive)\n\tinnerChanges: IDiff[] | null;\n}\n\ninterface IDiff {\n\toriginalRange: string; // [1,18 -> 1,19]\n\tmodifiedRange: string; // [1,18 -> 1,19]\n}\n\ninterface IMoveInfo {\n\toriginalRange: string; // [startLineNumber, endLineNumberExclusive)\n\tmodifiedRange: string; // [startLineNumber, endLineNumberExclusive)\n\n\tchanges: IDetailedDiff[];\n}\n\nfunction assertDiffCorrectness(diff: LinesDiff, original: string[], modified: string[]) {\n\tconst allInnerChanges = diff.changes.flatMap(c => c.innerChanges!);\n\tconst edit = rangeMappingsToTextEdit(allInnerChanges, new ArrayText(modified));\n\tconst result = edit.normalize().apply(new ArrayText(original));\n\n\tassert.deepStrictEqual(result, modified.join('\\n'));\n}\n\nfunction rangeMappingsToTextEdit(rangeMappings: readonly RangeMapping[], modified: AbstractText): TextEdit {\n\treturn new TextEdit(rangeMappings.map(m => {\n\t\treturn new TextReplacement(\n\t\t\tm.originalRange,\n\t\t\tmodified.getValueOfRange(m.modifiedRange)\n\t\t);\n\t}));\n}\n"]}