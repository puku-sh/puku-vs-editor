{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/editor/test/browser/widget/observableCodeEditor.test.ts","vs/editor/test/browser/widget/observableCodeEditor.test.ts"],"names":[],"mappings":"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","file":"observableCodeEditor.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as assert from 'assert';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { IObservable, derivedHandleChanges } from '../../../../base/common/observable.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { ICodeEditor } from '../../../browser/editorBrowser.js';\nimport { ObservableCodeEditor, observableCodeEditor } from '../../../browser/observableCodeEditor.js';\nimport { Position } from '../../../common/core/position.js';\nimport { Range } from '../../../common/core/range.js';\nimport { ViewModel } from '../../../common/viewModel/viewModelImpl.js';\nimport { withTestCodeEditor } from '../testCodeEditor.js';\n\nsuite('CodeEditorWidget', () => {\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tfunction withTestFixture(\n\t\tcb: (args: { editor: ICodeEditor; viewModel: ViewModel; log: Log; derived: IObservable<string> }) => void\n\t) {\n\t\twithEditorSetupTestFixture(undefined, cb);\n\t}\n\n\tfunction withEditorSetupTestFixture(\n\t\tpreSetupCallback:\n\t\t\t| ((editor: ICodeEditor, disposables: DisposableStore) => void)\n\t\t\t| undefined,\n\t\tcb: (args: { editor: ICodeEditor; viewModel: ViewModel; log: Log; derived: IObservable<string> }) => void\n\t) {\n\t\twithTestCodeEditor('hello world', {}, (editor, viewModel) => {\n\t\t\tconst disposables = new DisposableStore();\n\t\t\tpreSetupCallback?.(editor, disposables);\n\t\t\tconst obsEditor = observableCodeEditor(editor);\n\t\t\tconst log = new Log();\n\n\t\t\tconst derived = derivedHandleChanges(\n\t\t\t\t{\n\t\t\t\t\tchangeTracker: {\n\t\t\t\t\t\tcreateChangeSummary: () => undefined,\n\t\t\t\t\t\thandleChange: (context) => {\n\t\t\t\t\t\t\tconst obsName = observableName(context.changedObservable, obsEditor);\n\n\t\t\t\t\t\t\tlog.log(`handle change: ${obsName} ${formatChange(context.change)}`);\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t(reader) => {\n\t\t\t\t\tconst versionId = obsEditor.versionId.read(reader);\n\t\t\t\t\tconst selection = obsEditor.selections.read(reader)?.map((s) => s.toString()).join(', ');\n\t\t\t\t\tobsEditor.onDidType.read(reader);\n\n\t\t\t\t\tconst str = `running derived: selection: ${selection}, value: ${versionId}`;\n\t\t\t\t\tlog.log(str);\n\t\t\t\t\treturn str;\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tderived.recomputeInitiallyAndOnChange(disposables);\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), [\n\t\t\t\t'running derived: selection: [1,1 -> 1,1], value: 1',\n\t\t\t]);\n\n\t\t\tcb({ editor, viewModel, log, derived });\n\n\t\t\tdisposables.dispose();\n\t\t});\n\t}\n\n\ttest('setPosition', () =>\n\t\twithTestFixture(({ editor, log }) => {\n\t\t\teditor.setPosition(new Position(1, 2));\n\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,2 -> 1,2]\",\"modelVersionId\":1,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"api\",\"reason\":0}',\n\t\t\t\t'running derived: selection: [1,2 -> 1,2], value: 1'\n\t\t\t]));\n\t\t}));\n\n\ttest('keyboard.type', () =>\n\t\twithTestFixture(({ editor, log }) => {\n\t\t\teditor.trigger('keyboard', 'type', { text: 'abc' });\n\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t'handle change: editor.onDidType \"abc\"',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,1 -> 1,1]\",\"rangeLength\":0,\"text\":\"a\",\"rangeOffset\":0}],\"eol\":\"\\\\n\",\"versionId\":2,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,2 -> 1,2]\",\"rangeLength\":0,\"text\":\"b\",\"rangeOffset\":1}],\"eol\":\"\\\\n\",\"versionId\":3,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,3 -> 1,3]\",\"rangeLength\":0,\"text\":\"c\",\"rangeOffset\":2}],\"eol\":\"\\\\n\",\"versionId\":4,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,4 -> 1,4]\",\"modelVersionId\":4,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"keyboard\",\"reason\":0}',\n\t\t\t\t'running derived: selection: [1,4 -> 1,4], value: 4'\n\t\t\t]));\n\t\t}));\n\n\ttest('keyboard.type and set position', () =>\n\t\twithTestFixture(({ editor, log }) => {\n\t\t\teditor.trigger('keyboard', 'type', { text: 'abc' });\n\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t'handle change: editor.onDidType \"abc\"',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,1 -> 1,1]\",\"rangeLength\":0,\"text\":\"a\",\"rangeOffset\":0}],\"eol\":\"\\\\n\",\"versionId\":2,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,2 -> 1,2]\",\"rangeLength\":0,\"text\":\"b\",\"rangeOffset\":1}],\"eol\":\"\\\\n\",\"versionId\":3,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,3 -> 1,3]\",\"rangeLength\":0,\"text\":\"c\",\"rangeOffset\":2}],\"eol\":\"\\\\n\",\"versionId\":4,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,4 -> 1,4]\",\"modelVersionId\":4,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"keyboard\",\"reason\":0}',\n\t\t\t\t'running derived: selection: [1,4 -> 1,4], value: 4'\n\t\t\t]));\n\n\t\t\teditor.setPosition(new Position(1, 5), 'test');\n\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,5 -> 1,5]\",\"modelVersionId\":4,\"oldSelections\":[\"[1,4 -> 1,4]\"],\"oldModelVersionId\":4,\"source\":\"test\",\"reason\":0}',\n\t\t\t\t'running derived: selection: [1,5 -> 1,5], value: 4'\n\t\t\t]));\n\t\t}));\n\n\ttest('listener interaction (unforced)', () => {\n\t\tlet derived: IObservable<string>;\n\t\tlet log: Log;\n\t\twithEditorSetupTestFixture(\n\t\t\t(editor, disposables) => {\n\t\t\t\tdisposables.add(\n\t\t\t\t\teditor.onDidChangeModelContent(() => {\n\t\t\t\t\t\tlog.log('>>> before get');\n\t\t\t\t\t\tderived.get();\n\t\t\t\t\t\tlog.log('<<< after get');\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t},\n\t\t\t(args) => {\n\t\t\t\tconst editor = args.editor;\n\t\t\t\tderived = args.derived;\n\t\t\t\tlog = args.log;\n\n\t\t\t\teditor.trigger('keyboard', 'type', { text: 'a' });\n\t\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t\t'>>> before get',\n\t\t\t\t\t'<<< after get',\n\t\t\t\t\t'handle change: editor.onDidType \"a\"',\n\t\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,1 -> 1,1]\",\"rangeLength\":0,\"text\":\"a\",\"rangeOffset\":0}],\"eol\":\"\\\\n\",\"versionId\":2,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,2 -> 1,2]\",\"modelVersionId\":2,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"keyboard\",\"reason\":0}',\n\t\t\t\t\t'running derived: selection: [1,2 -> 1,2], value: 2'\n\t\t\t\t]));\n\t\t\t}\n\t\t);\n\t});\n\n\ttest('listener interaction ()', () => {\n\t\tlet derived: IObservable<string>;\n\t\tlet log: Log;\n\t\twithEditorSetupTestFixture(\n\t\t\t(editor, disposables) => {\n\t\t\t\tdisposables.add(\n\t\t\t\t\teditor.onDidChangeModelContent(() => {\n\t\t\t\t\t\tlog.log('>>> before forceUpdate');\n\t\t\t\t\t\tobservableCodeEditor(editor).forceUpdate();\n\n\t\t\t\t\t\tlog.log('>>> before get');\n\t\t\t\t\t\tderived.get();\n\t\t\t\t\t\tlog.log('<<< after get');\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t},\n\t\t\t(args) => {\n\t\t\t\tconst editor = args.editor;\n\t\t\t\tderived = args.derived;\n\t\t\t\tlog = args.log;\n\n\t\t\t\teditor.trigger('keyboard', 'type', { text: 'a' });\n\n\t\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t\t'>>> before forceUpdate',\n\t\t\t\t\t'>>> before get',\n\t\t\t\t\t'handle change: editor.versionId undefined',\n\t\t\t\t\t'running derived: selection: [1,2 -> 1,2], value: 2',\n\t\t\t\t\t'<<< after get',\n\t\t\t\t\t'handle change: editor.onDidType \"a\"',\n\t\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,1 -> 1,1]\",\"rangeLength\":0,\"text\":\"a\",\"rangeOffset\":0}],\"eol\":\"\\\\n\",\"versionId\":2,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,2 -> 1,2]\",\"modelVersionId\":2,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"keyboard\",\"reason\":0}',\n\t\t\t\t\t'running derived: selection: [1,2 -> 1,2], value: 2'\n\t\t\t\t]));\n\t\t\t}\n\t\t);\n\t});\n});\n\nclass Log {\n\tprivate readonly entries: string[] = [];\n\tpublic log(message: string): void {\n\t\tthis.entries.push(message);\n\t}\n\n\tpublic getAndClearEntries(): string[] {\n\t\tconst entries = [...this.entries];\n\t\tthis.entries.length = 0;\n\t\treturn entries;\n\t}\n}\n\nfunction formatChange(change: unknown) {\n\treturn JSON.stringify(\n\t\tchange,\n\t\t(key, value) => {\n\t\t\tif (value instanceof Range) {\n\t\t\t\treturn value.toString();\n\t\t\t}\n\t\t\tif (\n\t\t\t\tvalue === false ||\n\t\t\t\t(Array.isArray(value) && value.length === 0)\n\t\t\t) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\treturn value;\n\t\t}\n\t);\n}\n\nfunction observableName(obs: IObservable<any>, obsEditor: ObservableCodeEditor): string {\n\tswitch (obs) {\n\t\tcase obsEditor.selections:\n\t\t\treturn 'editor.selections';\n\t\tcase obsEditor.versionId:\n\t\t\treturn 'editor.versionId';\n\t\tcase obsEditor.onDidType:\n\t\t\treturn 'editor.onDidType';\n\t\tdefault:\n\t\t\treturn 'unknown';\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as assert from 'assert';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { IObservable, derivedHandleChanges } from '../../../../base/common/observable.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { ICodeEditor } from '../../../browser/editorBrowser.js';\nimport { ObservableCodeEditor, observableCodeEditor } from '../../../browser/observableCodeEditor.js';\nimport { Position } from '../../../common/core/position.js';\nimport { Range } from '../../../common/core/range.js';\nimport { ViewModel } from '../../../common/viewModel/viewModelImpl.js';\nimport { withTestCodeEditor } from '../testCodeEditor.js';\n\nsuite('CodeEditorWidget', () => {\n\tensureNoDisposablesAreLeakedInTestSuite();\n\n\tfunction withTestFixture(\n\t\tcb: (args: { editor: ICodeEditor; viewModel: ViewModel; log: Log; derived: IObservable<string> }) => void\n\t) {\n\t\twithEditorSetupTestFixture(undefined, cb);\n\t}\n\n\tfunction withEditorSetupTestFixture(\n\t\tpreSetupCallback:\n\t\t\t| ((editor: ICodeEditor, disposables: DisposableStore) => void)\n\t\t\t| undefined,\n\t\tcb: (args: { editor: ICodeEditor; viewModel: ViewModel; log: Log; derived: IObservable<string> }) => void\n\t) {\n\t\twithTestCodeEditor('hello world', {}, (editor, viewModel) => {\n\t\t\tconst disposables = new DisposableStore();\n\t\t\tpreSetupCallback?.(editor, disposables);\n\t\t\tconst obsEditor = observableCodeEditor(editor);\n\t\t\tconst log = new Log();\n\n\t\t\tconst derived = derivedHandleChanges(\n\t\t\t\t{\n\t\t\t\t\tchangeTracker: {\n\t\t\t\t\t\tcreateChangeSummary: () => undefined,\n\t\t\t\t\t\thandleChange: (context) => {\n\t\t\t\t\t\t\tconst obsName = observableName(context.changedObservable, obsEditor);\n\n\t\t\t\t\t\t\tlog.log(`handle change: ${obsName} ${formatChange(context.change)}`);\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t(reader) => {\n\t\t\t\t\tconst versionId = obsEditor.versionId.read(reader);\n\t\t\t\t\tconst selection = obsEditor.selections.read(reader)?.map((s) => s.toString()).join(', ');\n\t\t\t\t\tobsEditor.onDidType.read(reader);\n\n\t\t\t\t\tconst str = `running derived: selection: ${selection}, value: ${versionId}`;\n\t\t\t\t\tlog.log(str);\n\t\t\t\t\treturn str;\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tderived.recomputeInitiallyAndOnChange(disposables);\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), [\n\t\t\t\t'running derived: selection: [1,1 -> 1,1], value: 1',\n\t\t\t]);\n\n\t\t\tcb({ editor, viewModel, log, derived });\n\n\t\t\tdisposables.dispose();\n\t\t});\n\t}\n\n\ttest('setPosition', () =>\n\t\twithTestFixture(({ editor, log }) => {\n\t\t\teditor.setPosition(new Position(1, 2));\n\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,2 -> 1,2]\",\"modelVersionId\":1,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"api\",\"reason\":0}',\n\t\t\t\t'running derived: selection: [1,2 -> 1,2], value: 1'\n\t\t\t]));\n\t\t}));\n\n\ttest('keyboard.type', () =>\n\t\twithTestFixture(({ editor, log }) => {\n\t\t\teditor.trigger('keyboard', 'type', { text: 'abc' });\n\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t'handle change: editor.onDidType \"abc\"',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,1 -> 1,1]\",\"rangeLength\":0,\"text\":\"a\",\"rangeOffset\":0}],\"eol\":\"\\\\n\",\"versionId\":2,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,2 -> 1,2]\",\"rangeLength\":0,\"text\":\"b\",\"rangeOffset\":1}],\"eol\":\"\\\\n\",\"versionId\":3,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,3 -> 1,3]\",\"rangeLength\":0,\"text\":\"c\",\"rangeOffset\":2}],\"eol\":\"\\\\n\",\"versionId\":4,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,4 -> 1,4]\",\"modelVersionId\":4,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"keyboard\",\"reason\":0}',\n\t\t\t\t'running derived: selection: [1,4 -> 1,4], value: 4'\n\t\t\t]));\n\t\t}));\n\n\ttest('keyboard.type and set position', () =>\n\t\twithTestFixture(({ editor, log }) => {\n\t\t\teditor.trigger('keyboard', 'type', { text: 'abc' });\n\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t'handle change: editor.onDidType \"abc\"',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,1 -> 1,1]\",\"rangeLength\":0,\"text\":\"a\",\"rangeOffset\":0}],\"eol\":\"\\\\n\",\"versionId\":2,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,2 -> 1,2]\",\"rangeLength\":0,\"text\":\"b\",\"rangeOffset\":1}],\"eol\":\"\\\\n\",\"versionId\":3,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,3 -> 1,3]\",\"rangeLength\":0,\"text\":\"c\",\"rangeOffset\":2}],\"eol\":\"\\\\n\",\"versionId\":4,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,4 -> 1,4]\",\"modelVersionId\":4,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"keyboard\",\"reason\":0}',\n\t\t\t\t'running derived: selection: [1,4 -> 1,4], value: 4'\n\t\t\t]));\n\n\t\t\teditor.setPosition(new Position(1, 5), 'test');\n\n\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,5 -> 1,5]\",\"modelVersionId\":4,\"oldSelections\":[\"[1,4 -> 1,4]\"],\"oldModelVersionId\":4,\"source\":\"test\",\"reason\":0}',\n\t\t\t\t'running derived: selection: [1,5 -> 1,5], value: 4'\n\t\t\t]));\n\t\t}));\n\n\ttest('listener interaction (unforced)', () => {\n\t\tlet derived: IObservable<string>;\n\t\tlet log: Log;\n\t\twithEditorSetupTestFixture(\n\t\t\t(editor, disposables) => {\n\t\t\t\tdisposables.add(\n\t\t\t\t\teditor.onDidChangeModelContent(() => {\n\t\t\t\t\t\tlog.log('>>> before get');\n\t\t\t\t\t\tderived.get();\n\t\t\t\t\t\tlog.log('<<< after get');\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t},\n\t\t\t(args) => {\n\t\t\t\tconst editor = args.editor;\n\t\t\t\tderived = args.derived;\n\t\t\t\tlog = args.log;\n\n\t\t\t\teditor.trigger('keyboard', 'type', { text: 'a' });\n\t\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t\t'>>> before get',\n\t\t\t\t\t'<<< after get',\n\t\t\t\t\t'handle change: editor.onDidType \"a\"',\n\t\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,1 -> 1,1]\",\"rangeLength\":0,\"text\":\"a\",\"rangeOffset\":0}],\"eol\":\"\\\\n\",\"versionId\":2,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,2 -> 1,2]\",\"modelVersionId\":2,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"keyboard\",\"reason\":0}',\n\t\t\t\t\t'running derived: selection: [1,2 -> 1,2], value: 2'\n\t\t\t\t]));\n\t\t\t}\n\t\t);\n\t});\n\n\ttest('listener interaction ()', () => {\n\t\tlet derived: IObservable<string>;\n\t\tlet log: Log;\n\t\twithEditorSetupTestFixture(\n\t\t\t(editor, disposables) => {\n\t\t\t\tdisposables.add(\n\t\t\t\t\teditor.onDidChangeModelContent(() => {\n\t\t\t\t\t\tlog.log('>>> before forceUpdate');\n\t\t\t\t\t\tobservableCodeEditor(editor).forceUpdate();\n\n\t\t\t\t\t\tlog.log('>>> before get');\n\t\t\t\t\t\tderived.get();\n\t\t\t\t\t\tlog.log('<<< after get');\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t},\n\t\t\t(args) => {\n\t\t\t\tconst editor = args.editor;\n\t\t\t\tderived = args.derived;\n\t\t\t\tlog = args.log;\n\n\t\t\t\teditor.trigger('keyboard', 'type', { text: 'a' });\n\n\t\t\t\tassert.deepStrictEqual(log.getAndClearEntries(), ([\n\t\t\t\t\t'>>> before forceUpdate',\n\t\t\t\t\t'>>> before get',\n\t\t\t\t\t'handle change: editor.versionId undefined',\n\t\t\t\t\t'running derived: selection: [1,2 -> 1,2], value: 2',\n\t\t\t\t\t'<<< after get',\n\t\t\t\t\t'handle change: editor.onDidType \"a\"',\n\t\t\t\t\t'handle change: editor.versionId {\"changes\":[{\"range\":\"[1,1 -> 1,1]\",\"rangeLength\":0,\"text\":\"a\",\"rangeOffset\":0}],\"eol\":\"\\\\n\",\"versionId\":2,\"detailedReasons\":[{\"metadata\":{\"source\":\"cursor\",\"kind\":\"type\",\"detailedSource\":\"keyboard\"}}],\"detailedReasonsChangeLengths\":[1]}',\n\t\t\t\t\t'handle change: editor.selections {\"selection\":\"[1,2 -> 1,2]\",\"modelVersionId\":2,\"oldSelections\":[\"[1,1 -> 1,1]\"],\"oldModelVersionId\":1,\"source\":\"keyboard\",\"reason\":0}',\n\t\t\t\t\t'running derived: selection: [1,2 -> 1,2], value: 2'\n\t\t\t\t]));\n\t\t\t}\n\t\t);\n\t});\n});\n\nclass Log {\n\tprivate readonly entries: string[] = [];\n\tpublic log(message: string): void {\n\t\tthis.entries.push(message);\n\t}\n\n\tpublic getAndClearEntries(): string[] {\n\t\tconst entries = [...this.entries];\n\t\tthis.entries.length = 0;\n\t\treturn entries;\n\t}\n}\n\nfunction formatChange(change: unknown) {\n\treturn JSON.stringify(\n\t\tchange,\n\t\t(key, value) => {\n\t\t\tif (value instanceof Range) {\n\t\t\t\treturn value.toString();\n\t\t\t}\n\t\t\tif (\n\t\t\t\tvalue === false ||\n\t\t\t\t(Array.isArray(value) && value.length === 0)\n\t\t\t) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\treturn value;\n\t\t}\n\t);\n}\n\nfunction observableName(obs: IObservable<any>, obsEditor: ObservableCodeEditor): string {\n\tswitch (obs) {\n\t\tcase obsEditor.selections:\n\t\t\treturn 'editor.selections';\n\t\tcase obsEditor.versionId:\n\t\t\treturn 'editor.versionId';\n\t\tcase obsEditor.onDidType:\n\t\t\treturn 'editor.onDidType';\n\t\tdefault:\n\t\t\treturn 'unknown';\n\t}\n}\n"]}