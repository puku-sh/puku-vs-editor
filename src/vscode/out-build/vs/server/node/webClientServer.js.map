{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/server/node/webClientServer.ts","vs/server/node/webClientServer.ts"],"names":[],"mappings":"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","file":"webClientServer.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { createReadStream, promises } from 'fs';\nimport * as http from 'http';\nimport * as url from 'url';\nimport * as cookie from 'cookie';\nimport * as crypto from 'crypto';\nimport { isEqualOrParent } from '../../base/common/extpath.js';\nimport { getMediaMime } from '../../base/common/mime.js';\nimport { isLinux } from '../../base/common/platform.js';\nimport { ILogService, LogLevel } from '../../platform/log/common/log.js';\nimport { IServerEnvironmentService } from './serverEnvironmentService.js';\nimport { extname, dirname, join, normalize, posix, resolve } from '../../base/common/path.js';\nimport { FileAccess, connectionTokenCookieName, connectionTokenQueryName, Schemas, builtinExtensionsPath } from '../../base/common/network.js';\nimport { generateUuid } from '../../base/common/uuid.js';\nimport { IProductService } from '../../platform/product/common/productService.js';\nimport { ServerConnectionToken, ServerConnectionTokenType } from './serverConnectionToken.js';\nimport { asTextOrError, IRequestService } from '../../platform/request/common/request.js';\nimport { IHeaders } from '../../base/parts/request/common/request.js';\nimport { CancellationToken } from '../../base/common/cancellation.js';\nimport { URI } from '../../base/common/uri.js';\nimport { streamToBuffer } from '../../base/common/buffer.js';\nimport { IProductConfiguration } from '../../base/common/product.js';\nimport { isString, Mutable } from '../../base/common/types.js';\nimport { CharCode } from '../../base/common/charCode.js';\nimport { IExtensionManifest } from '../../platform/extensions/common/extensions.js';\nimport { ICSSDevelopmentService } from '../../platform/cssDev/node/cssDevService.js';\n\nconst textMimeType: { [ext: string]: string | undefined } = {\n\t'.html': 'text/html',\n\t'.js': 'text/javascript',\n\t'.json': 'application/json',\n\t'.css': 'text/css',\n\t'.svg': 'image/svg+xml',\n};\n\n/**\n * Return an error to the client.\n */\nexport async function serveError(req: http.IncomingMessage, res: http.ServerResponse, errorCode: number, errorMessage: string): Promise<void> {\n\tres.writeHead(errorCode, { 'Content-Type': 'text/plain' });\n\tres.end(errorMessage);\n}\n\nexport const enum CacheControl {\n\tNO_CACHING, ETAG, NO_EXPIRY\n}\n\n/**\n * Serve a file at a given path or 404 if the file is missing.\n */\nexport async function serveFile(filePath: string, cacheControl: CacheControl, logService: ILogService, req: http.IncomingMessage, res: http.ServerResponse, responseHeaders: Record<string, string>): Promise<void> {\n\ttry {\n\t\tconst stat = await promises.stat(filePath); // throws an error if file doesn't exist\n\t\tif (cacheControl === CacheControl.ETAG) {\n\n\t\t\t// Check if file modified since\n\t\t\tconst etag = `W/\"${[stat.ino, stat.size, stat.mtime.getTime()].join('-')}\"`; // weak validator (https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag)\n\t\t\tif (req.headers['if-none-match'] === etag) {\n\t\t\t\tres.writeHead(304);\n\t\t\t\treturn void res.end();\n\t\t\t}\n\n\t\t\tresponseHeaders['Etag'] = etag;\n\t\t} else if (cacheControl === CacheControl.NO_EXPIRY) {\n\t\t\tresponseHeaders['Cache-Control'] = 'public, max-age=31536000';\n\t\t} else if (cacheControl === CacheControl.NO_CACHING) {\n\t\t\tresponseHeaders['Cache-Control'] = 'no-store';\n\t\t}\n\n\t\tresponseHeaders['Content-Type'] = textMimeType[extname(filePath)] || getMediaMime(filePath) || 'text/plain';\n\n\t\tres.writeHead(200, responseHeaders);\n\n\t\t// Data\n\t\tcreateReadStream(filePath).pipe(res);\n\t} catch (error) {\n\t\tif (error.code !== 'ENOENT') {\n\t\t\tlogService.error(error);\n\t\t\tconsole.error(error.toString());\n\t\t} else {\n\t\t\tconsole.error(`File not found: ${filePath}`);\n\t\t}\n\n\t\tres.writeHead(404, { 'Content-Type': 'text/plain' });\n\t\treturn void res.end('Not found');\n\t}\n}\n\nconst APP_ROOT = dirname(FileAccess.asFileUri('').fsPath);\n\nconst STATIC_PATH = `/static`;\nconst CALLBACK_PATH = `/callback`;\nconst WEB_EXTENSION_PATH = `/web-extension-resource`;\n\nexport class WebClientServer {\n\n\tprivate readonly _webExtensionResourceUrlTemplate: URI | undefined;\n\n\tconstructor(\n\t\tprivate readonly _connectionToken: ServerConnectionToken,\n\t\tprivate readonly _basePath: string,\n\t\tprivate readonly _productPath: string,\n\t\t@IServerEnvironmentService private readonly _environmentService: IServerEnvironmentService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IRequestService private readonly _requestService: IRequestService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@ICSSDevelopmentService private readonly _cssDevService: ICSSDevelopmentService\n\t) {\n\t\tthis._webExtensionResourceUrlTemplate = this._productService.extensionsGallery?.resourceUrlTemplate ? URI.parse(this._productService.extensionsGallery.resourceUrlTemplate) : undefined;\n\t}\n\n\t/**\n\t * Handle web resources (i.e. only needed by the web client).\n\t * **NOTE**: This method is only invoked when the server has web bits.\n\t * **NOTE**: This method is only invoked after the connection token has been validated.\n\t * @param parsedUrl The URL to handle, including base and product path\n\t * @param pathname The pathname of the URL, without base and product path\n\t */\n\tasync handle(req: http.IncomingMessage, res: http.ServerResponse, parsedUrl: url.UrlWithParsedQuery, pathname: string): Promise<void> {\n\t\ttry {\n\t\t\tif (pathname.startsWith(STATIC_PATH) && pathname.charCodeAt(STATIC_PATH.length) === CharCode.Slash) {\n\t\t\t\treturn this._handleStatic(req, res, pathname.substring(STATIC_PATH.length));\n\t\t\t}\n\t\t\tif (pathname === '/') {\n\t\t\t\treturn this._handleRoot(req, res, parsedUrl);\n\t\t\t}\n\t\t\tif (pathname === CALLBACK_PATH) {\n\t\t\t\t// callback support\n\t\t\t\treturn this._handleCallback(res);\n\t\t\t}\n\t\t\tif (pathname.startsWith(WEB_EXTENSION_PATH) && pathname.charCodeAt(WEB_EXTENSION_PATH.length) === CharCode.Slash) {\n\t\t\t\t// extension resource support\n\t\t\t\treturn this._handleWebExtensionResource(req, res, pathname.substring(WEB_EXTENSION_PATH.length));\n\t\t\t}\n\n\t\t\treturn serveError(req, res, 404, 'Not found.');\n\t\t} catch (error) {\n\t\t\tthis._logService.error(error);\n\t\t\tconsole.error(error.toString());\n\n\t\t\treturn serveError(req, res, 500, 'Internal Server Error.');\n\t\t}\n\t}\n\t/**\n\t * Handle HTTP requests for /static/*\n\t * @param resourcePath The path after /static/\n\t */\n\tprivate async _handleStatic(req: http.IncomingMessage, res: http.ServerResponse, resourcePath: string): Promise<void> {\n\t\tconst headers: Record<string, string> = Object.create(null);\n\n\t\t// Strip the this._staticRoute from the path\n\t\tconst normalizedPathname = decodeURIComponent(resourcePath); // support paths that are uri-encoded (e.g. spaces => %20)\n\n\t\tconst filePath = join(APP_ROOT, normalizedPathname); // join also normalizes the path\n\t\tif (!isEqualOrParent(filePath, APP_ROOT, !isLinux)) {\n\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t}\n\n\t\treturn serveFile(filePath, this._environmentService.isBuilt ? CacheControl.NO_EXPIRY : CacheControl.ETAG, this._logService, req, res, headers);\n\t}\n\n\tprivate _getResourceURLTemplateAuthority(uri: URI): string | undefined {\n\t\tconst index = uri.authority.indexOf('.');\n\t\treturn index !== -1 ? uri.authority.substring(index + 1) : undefined;\n\t}\n\n\t/**\n\t * Handle extension resources\n\t * @param resourcePath The path after /web-extension-resource/\n\t */\n\tprivate async _handleWebExtensionResource(req: http.IncomingMessage, res: http.ServerResponse, resourcePath: string): Promise<void> {\n\t\tif (!this._webExtensionResourceUrlTemplate) {\n\t\t\treturn serveError(req, res, 500, 'No extension gallery service configured.');\n\t\t}\n\n\t\tconst normalizedPathname = decodeURIComponent(resourcePath); // support paths that are uri-encoded (e.g. spaces => %20)\n\t\tconst path = normalize(normalizedPathname);\n\t\tconst uri = URI.parse(path).with({\n\t\t\tscheme: this._webExtensionResourceUrlTemplate.scheme,\n\t\t\tauthority: path.substring(0, path.indexOf('/')),\n\t\t\tpath: path.substring(path.indexOf('/') + 1)\n\t\t});\n\n\t\tif (this._getResourceURLTemplateAuthority(this._webExtensionResourceUrlTemplate) !== this._getResourceURLTemplateAuthority(uri)) {\n\t\t\treturn serveError(req, res, 403, 'Request Forbidden');\n\t\t}\n\n\t\tconst headers: IHeaders = {};\n\t\tconst setRequestHeader = (header: string) => {\n\t\t\tconst value = req.headers[header];\n\t\t\tif (value && (isString(value) || value[0])) {\n\t\t\t\theaders[header] = isString(value) ? value : value[0];\n\t\t\t} else if (header !== header.toLowerCase()) {\n\t\t\t\tsetRequestHeader(header.toLowerCase());\n\t\t\t}\n\t\t};\n\t\tsetRequestHeader('X-Client-Name');\n\t\tsetRequestHeader('X-Client-Version');\n\t\tsetRequestHeader('X-Machine-Id');\n\t\tsetRequestHeader('X-Client-Commit');\n\n\t\tconst context = await this._requestService.request({\n\t\t\ttype: 'GET',\n\t\t\turl: uri.toString(true),\n\t\t\theaders\n\t\t}, CancellationToken.None);\n\n\t\tconst status = context.res.statusCode || 500;\n\t\tif (status !== 200) {\n\t\t\tlet text: string | null = null;\n\t\t\ttry {\n\t\t\t\ttext = await asTextOrError(context);\n\t\t\t} catch (error) {/* Ignore */ }\n\t\t\treturn serveError(req, res, status, text || `Request failed with status ${status}`);\n\t\t}\n\n\t\tconst responseHeaders: Record<string, string | string[]> = Object.create(null);\n\t\tconst setResponseHeader = (header: string) => {\n\t\t\tconst value = context.res.headers[header];\n\t\t\tif (value) {\n\t\t\t\tresponseHeaders[header] = value;\n\t\t\t} else if (header !== header.toLowerCase()) {\n\t\t\t\tsetResponseHeader(header.toLowerCase());\n\t\t\t}\n\t\t};\n\t\tsetResponseHeader('Cache-Control');\n\t\tsetResponseHeader('Content-Type');\n\t\tres.writeHead(200, responseHeaders);\n\t\tconst buffer = await streamToBuffer(context.stream);\n\t\treturn void res.end(buffer.buffer);\n\t}\n\n\t/**\n\t * Handle HTTP requests for /\n\t */\n\tprivate async _handleRoot(req: http.IncomingMessage, res: http.ServerResponse, parsedUrl: url.UrlWithParsedQuery): Promise<void> {\n\n\t\tconst getFirstHeader = (headerName: string) => {\n\t\t\tconst val = req.headers[headerName];\n\t\t\treturn Array.isArray(val) ? val[0] : val;\n\t\t};\n\n\t\t// Prefix routes with basePath for clients\n\t\tconst basePath = getFirstHeader('x-forwarded-prefix') || this._basePath;\n\n\t\tconst queryConnectionToken = parsedUrl.query[connectionTokenQueryName];\n\t\tif (typeof queryConnectionToken === 'string') {\n\t\t\t// We got a connection token as a query parameter.\n\t\t\t// We want to have a clean URL, so we strip it\n\t\t\tconst responseHeaders: Record<string, string> = Object.create(null);\n\t\t\tresponseHeaders['Set-Cookie'] = cookie.serialize(\n\t\t\t\tconnectionTokenCookieName,\n\t\t\t\tqueryConnectionToken,\n\t\t\t\t{\n\t\t\t\t\tsameSite: 'lax',\n\t\t\t\t\tmaxAge: 60 * 60 * 24 * 7 /* 1 week */\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tconst newQuery = Object.create(null);\n\t\t\tfor (const key in parsedUrl.query) {\n\t\t\t\tif (key !== connectionTokenQueryName) {\n\t\t\t\t\tnewQuery[key] = parsedUrl.query[key];\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst newLocation = url.format({ pathname: basePath, query: newQuery });\n\t\t\tresponseHeaders['Location'] = newLocation;\n\n\t\t\tres.writeHead(302, responseHeaders);\n\t\t\treturn void res.end();\n\t\t}\n\n\t\tconst replacePort = (host: string, port: string) => {\n\t\t\tconst index = host?.indexOf(':');\n\t\t\tif (index !== -1) {\n\t\t\t\thost = host?.substring(0, index);\n\t\t\t}\n\t\t\thost += `:${port}`;\n\t\t\treturn host;\n\t\t};\n\n\t\tconst useTestResolver = (!this._environmentService.isBuilt && this._environmentService.args['use-test-resolver']);\n\t\tlet remoteAuthority = (\n\t\t\tuseTestResolver\n\t\t\t\t? 'test+test'\n\t\t\t\t: (getFirstHeader('x-original-host') || getFirstHeader('x-forwarded-host') || req.headers.host)\n\t\t);\n\t\tif (!remoteAuthority) {\n\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t}\n\t\tconst forwardedPort = getFirstHeader('x-forwarded-port');\n\t\tif (forwardedPort) {\n\t\t\tremoteAuthority = replacePort(remoteAuthority, forwardedPort);\n\t\t}\n\n\t\tfunction asJSON(value: unknown): string {\n\t\t\treturn JSON.stringify(value).replace(/\"/g, '&quot;');\n\t\t}\n\n\t\tlet _wrapWebWorkerExtHostInIframe: undefined | false = undefined;\n\t\tif (this._environmentService.args['enable-smoke-test-driver']) {\n\t\t\t// integration tests run at a time when the built output is not yet published to the CDN\n\t\t\t// so we must disable the iframe wrapping because the iframe URL will give a 404\n\t\t\t_wrapWebWorkerExtHostInIframe = false;\n\t\t}\n\n\t\tif (this._logService.getLevel() === LogLevel.Trace) {\n\t\t\t['x-original-host', 'x-forwarded-host', 'x-forwarded-port', 'host'].forEach(header => {\n\t\t\t\tconst value = getFirstHeader(header);\n\t\t\t\tif (value) {\n\t\t\t\t\tthis._logService.trace(`[WebClientServer] ${header}: ${value}`);\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis._logService.trace(`[WebClientServer] Request URL: ${req.url}, basePath: ${basePath}, remoteAuthority: ${remoteAuthority}`);\n\t\t}\n\n\t\tconst staticRoute = posix.join(basePath, this._productPath, STATIC_PATH);\n\t\tconst callbackRoute = posix.join(basePath, this._productPath, CALLBACK_PATH);\n\t\tconst webExtensionRoute = posix.join(basePath, this._productPath, WEB_EXTENSION_PATH);\n\n\t\tconst resolveWorkspaceURI = (defaultLocation?: string) => defaultLocation && URI.file(resolve(defaultLocation)).with({ scheme: Schemas.vscodeRemote, authority: remoteAuthority });\n\n\t\tconst filePath = FileAccess.asFileUri(`vs/code/browser/workbench/workbench${this._environmentService.isBuilt ? '' : '-dev'}.html`).fsPath;\n\t\tconst authSessionInfo = !this._environmentService.isBuilt && this._environmentService.args['github-auth'] ? {\n\t\t\tid: generateUuid(),\n\t\t\tproviderId: 'github',\n\t\t\taccessToken: this._environmentService.args['github-auth'],\n\t\t\tscopes: [['user:email'], ['repo']]\n\t\t} : undefined;\n\n\t\tconst productConfiguration: Partial<Mutable<IProductConfiguration>> = {\n\t\t\tembedderIdentifier: 'server-distro',\n\t\t\textensionsGallery: this._webExtensionResourceUrlTemplate && this._productService.extensionsGallery ? {\n\t\t\t\t...this._productService.extensionsGallery,\n\t\t\t\tresourceUrlTemplate: this._webExtensionResourceUrlTemplate.with({\n\t\t\t\t\tscheme: 'http',\n\t\t\t\t\tauthority: remoteAuthority,\n\t\t\t\t\tpath: `${webExtensionRoute}/${this._webExtensionResourceUrlTemplate.authority}${this._webExtensionResourceUrlTemplate.path}`\n\t\t\t\t}).toString(true)\n\t\t\t} : undefined\n\t\t};\n\n\t\tconst proposedApi = this._environmentService.args['enable-proposed-api'];\n\t\tif (proposedApi?.length) {\n\t\t\tproductConfiguration.extensionsEnabledWithApiProposalVersion ??= [];\n\t\t\tproductConfiguration.extensionsEnabledWithApiProposalVersion.push(...proposedApi);\n\t\t}\n\n\t\tif (!this._environmentService.isBuilt) {\n\t\t\ttry {\n\t\t\t\tconst productOverrides = JSON.parse((await promises.readFile(join(APP_ROOT, 'product.overrides.json'))).toString());\n\t\t\t\tObject.assign(productConfiguration, productOverrides);\n\t\t\t} catch (err) {/* Ignore Error */ }\n\t\t}\n\n\t\tconst workbenchWebConfiguration = {\n\t\t\tremoteAuthority,\n\t\t\tserverBasePath: basePath,\n\t\t\t_wrapWebWorkerExtHostInIframe,\n\t\t\tdevelopmentOptions: { enableSmokeTestDriver: this._environmentService.args['enable-smoke-test-driver'] ? true : undefined, logLevel: this._logService.getLevel() },\n\t\t\tsettingsSyncOptions: !this._environmentService.isBuilt && this._environmentService.args['enable-sync'] ? { enabled: true } : undefined,\n\t\t\tenableWorkspaceTrust: !this._environmentService.args['disable-workspace-trust'],\n\t\t\tfolderUri: resolveWorkspaceURI(this._environmentService.args['default-folder']),\n\t\t\tworkspaceUri: resolveWorkspaceURI(this._environmentService.args['default-workspace']),\n\t\t\tproductConfiguration,\n\t\t\tcallbackRoute: callbackRoute\n\t\t};\n\n\t\tconst cookies = cookie.parse(req.headers.cookie || '');\n\t\tconst locale = cookies['vscode.nls.locale'] || req.headers['accept-language']?.split(',')[0]?.toLowerCase() || 'en';\n\t\tlet WORKBENCH_NLS_BASE_URL: string | undefined;\n\t\tlet WORKBENCH_NLS_URL: string;\n\t\tif (!locale.startsWith('en') && this._productService.nlsCoreBaseUrl) {\n\t\t\tWORKBENCH_NLS_BASE_URL = this._productService.nlsCoreBaseUrl;\n\t\t\tWORKBENCH_NLS_URL = `${WORKBENCH_NLS_BASE_URL}${this._productService.commit}/${this._productService.version}/${locale}/nls.messages.js`;\n\t\t} else {\n\t\t\tWORKBENCH_NLS_URL = ''; // fallback will apply\n\t\t}\n\n\t\tconst values: { [key: string]: string } = {\n\t\t\tWORKBENCH_WEB_CONFIGURATION: asJSON(workbenchWebConfiguration),\n\t\t\tWORKBENCH_AUTH_SESSION: authSessionInfo ? asJSON(authSessionInfo) : '',\n\t\t\tWORKBENCH_WEB_BASE_URL: staticRoute,\n\t\t\tWORKBENCH_NLS_URL,\n\t\t\tWORKBENCH_NLS_FALLBACK_URL: `${staticRoute}/out/nls.messages.js`\n\t\t};\n\n\t\t// DEV ---------------------------------------------------------------------------------------\n\t\t// DEV: This is for development and enables loading CSS via import-statements via import-maps.\n\t\t// DEV: The server needs to send along all CSS modules so that the client can construct the\n\t\t// DEV: import-map.\n\t\t// DEV ---------------------------------------------------------------------------------------\n\t\tif (this._cssDevService.isEnabled) {\n\t\t\tconst cssModules = await this._cssDevService.getCssModules();\n\t\t\tvalues['WORKBENCH_DEV_CSS_MODULES'] = JSON.stringify(cssModules);\n\t\t}\n\n\t\tif (useTestResolver) {\n\t\t\tconst bundledExtensions: { extensionPath: string; packageJSON: IExtensionManifest }[] = [];\n\t\t\tfor (const extensionPath of ['vscode-test-resolver', 'github-authentication']) {\n\t\t\t\tconst packageJSON = JSON.parse((await promises.readFile(FileAccess.asFileUri(`${builtinExtensionsPath}/${extensionPath}/package.json`).fsPath)).toString());\n\t\t\t\tbundledExtensions.push({ extensionPath, packageJSON });\n\t\t\t}\n\t\t\tvalues['WORKBENCH_BUILTIN_EXTENSIONS'] = asJSON(bundledExtensions);\n\t\t}\n\n\t\tlet data;\n\t\ttry {\n\t\t\tconst workbenchTemplate = (await promises.readFile(filePath)).toString();\n\t\t\tdata = workbenchTemplate.replace(/\\{\\{([^}]+)\\}\\}/g, (_, key) => values[key] ?? 'undefined');\n\t\t} catch (e) {\n\t\t\tres.writeHead(404, { 'Content-Type': 'text/plain' });\n\t\t\treturn void res.end('Not found');\n\t\t}\n\n\t\tconst webWorkerExtensionHostIframeScriptSHA = 'sha256-2Q+j4hfT09+1+imS46J2YlkCtHWQt0/BE79PXjJ0ZJ8=';\n\n\t\tconst cspDirectives = [\n\t\t\t'default-src \\'self\\';',\n\t\t\t'img-src \\'self\\' https: data: blob:;',\n\t\t\t'media-src \\'self\\';',\n\t\t\t`script-src 'self' 'unsafe-eval' ${WORKBENCH_NLS_BASE_URL ?? ''} blob: 'nonce-1nline-m4p' ${this._getScriptCspHashes(data).join(' ')} '${webWorkerExtensionHostIframeScriptSHA}' 'sha256-/r7rqQ+yrxt57sxLuQ6AMYcy/lUpvAIzHjIJt/OeLWU=' ${useTestResolver ? '' : `http://${remoteAuthority}`};`,  // the sha is the same as in src/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html\n\t\t\t'child-src \\'self\\';',\n\t\t\t`frame-src 'self' https://*.vscode-cdn.net data:;`,\n\t\t\t'worker-src \\'self\\' data: blob:;',\n\t\t\t'style-src \\'self\\' \\'unsafe-inline\\';',\n\t\t\t'connect-src \\'self\\' ws: wss: https:;',\n\t\t\t'font-src \\'self\\' blob:;',\n\t\t\t'manifest-src \\'self\\';'\n\t\t].join(' ');\n\n\t\tconst headers: http.OutgoingHttpHeaders = {\n\t\t\t'Content-Type': 'text/html',\n\t\t\t'Content-Security-Policy': cspDirectives\n\t\t};\n\t\tif (this._connectionToken.type !== ServerConnectionTokenType.None) {\n\t\t\t// At this point we know the client has a valid cookie\n\t\t\t// and we want to set it prolong it to ensure that this\n\t\t\t// client is valid for another 1 week at least\n\t\t\theaders['Set-Cookie'] = cookie.serialize(\n\t\t\t\tconnectionTokenCookieName,\n\t\t\t\tthis._connectionToken.value,\n\t\t\t\t{\n\t\t\t\t\tsameSite: 'lax',\n\t\t\t\t\tmaxAge: 60 * 60 * 24 * 7 /* 1 week */\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\n\t\tres.writeHead(200, headers);\n\t\treturn void res.end(data);\n\t}\n\n\tprivate _getScriptCspHashes(content: string): string[] {\n\t\t// Compute the CSP hashes for line scripts. Uses regex\n\t\t// which means it isn't 100% good.\n\t\tconst regex = /<script>([\\s\\S]+?)<\\/script>/img;\n\t\tconst result: string[] = [];\n\t\tlet match: RegExpExecArray | null;\n\t\twhile (match = regex.exec(content)) {\n\t\t\tconst hasher = crypto.createHash('sha256');\n\t\t\t// This only works on Windows if we strip `\\r` from `\\r\\n`.\n\t\t\tconst script = match[1].replace(/\\r\\n/g, '\\n');\n\t\t\tconst hash = hasher\n\t\t\t\t.update(Buffer.from(script))\n\t\t\t\t.digest().toString('base64');\n\n\t\t\tresult.push(`'sha256-${hash}'`);\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**\n\t * Handle HTTP requests for /callback\n\t */\n\tprivate async _handleCallback(res: http.ServerResponse): Promise<void> {\n\t\tconst filePath = FileAccess.asFileUri('vs/code/browser/workbench/callback.html').fsPath;\n\t\tconst data = (await promises.readFile(filePath)).toString();\n\t\tconst cspDirectives = [\n\t\t\t'default-src \\'self\\';',\n\t\t\t'img-src \\'self\\' https: data: blob:;',\n\t\t\t'media-src \\'none\\';',\n\t\t\t`script-src 'self' ${this._getScriptCspHashes(data).join(' ')};`,\n\t\t\t'style-src \\'self\\' \\'unsafe-inline\\';',\n\t\t\t'font-src \\'self\\' blob:;'\n\t\t].join(' ');\n\n\t\tres.writeHead(200, {\n\t\t\t'Content-Type': 'text/html',\n\t\t\t'Content-Security-Policy': cspDirectives\n\t\t});\n\t\treturn void res.end(data);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { createReadStream, promises } from 'fs';\nimport * as http from 'http';\nimport * as url from 'url';\nimport * as cookie from 'cookie';\nimport * as crypto from 'crypto';\nimport { isEqualOrParent } from '../../base/common/extpath.js';\nimport { getMediaMime } from '../../base/common/mime.js';\nimport { isLinux } from '../../base/common/platform.js';\nimport { ILogService, LogLevel } from '../../platform/log/common/log.js';\nimport { IServerEnvironmentService } from './serverEnvironmentService.js';\nimport { extname, dirname, join, normalize, posix, resolve } from '../../base/common/path.js';\nimport { FileAccess, connectionTokenCookieName, connectionTokenQueryName, Schemas, builtinExtensionsPath } from '../../base/common/network.js';\nimport { generateUuid } from '../../base/common/uuid.js';\nimport { IProductService } from '../../platform/product/common/productService.js';\nimport { ServerConnectionToken, ServerConnectionTokenType } from './serverConnectionToken.js';\nimport { asTextOrError, IRequestService } from '../../platform/request/common/request.js';\nimport { IHeaders } from '../../base/parts/request/common/request.js';\nimport { CancellationToken } from '../../base/common/cancellation.js';\nimport { URI } from '../../base/common/uri.js';\nimport { streamToBuffer } from '../../base/common/buffer.js';\nimport { IProductConfiguration } from '../../base/common/product.js';\nimport { isString, Mutable } from '../../base/common/types.js';\nimport { CharCode } from '../../base/common/charCode.js';\nimport { IExtensionManifest } from '../../platform/extensions/common/extensions.js';\nimport { ICSSDevelopmentService } from '../../platform/cssDev/node/cssDevService.js';\n\nconst textMimeType: { [ext: string]: string | undefined } = {\n\t'.html': 'text/html',\n\t'.js': 'text/javascript',\n\t'.json': 'application/json',\n\t'.css': 'text/css',\n\t'.svg': 'image/svg+xml',\n};\n\n/**\n * Return an error to the client.\n */\nexport async function serveError(req: http.IncomingMessage, res: http.ServerResponse, errorCode: number, errorMessage: string): Promise<void> {\n\tres.writeHead(errorCode, { 'Content-Type': 'text/plain' });\n\tres.end(errorMessage);\n}\n\nexport const enum CacheControl {\n\tNO_CACHING, ETAG, NO_EXPIRY\n}\n\n/**\n * Serve a file at a given path or 404 if the file is missing.\n */\nexport async function serveFile(filePath: string, cacheControl: CacheControl, logService: ILogService, req: http.IncomingMessage, res: http.ServerResponse, responseHeaders: Record<string, string>): Promise<void> {\n\ttry {\n\t\tconst stat = await promises.stat(filePath); // throws an error if file doesn't exist\n\t\tif (cacheControl === CacheControl.ETAG) {\n\n\t\t\t// Check if file modified since\n\t\t\tconst etag = `W/\"${[stat.ino, stat.size, stat.mtime.getTime()].join('-')}\"`; // weak validator (https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag)\n\t\t\tif (req.headers['if-none-match'] === etag) {\n\t\t\t\tres.writeHead(304);\n\t\t\t\treturn void res.end();\n\t\t\t}\n\n\t\t\tresponseHeaders['Etag'] = etag;\n\t\t} else if (cacheControl === CacheControl.NO_EXPIRY) {\n\t\t\tresponseHeaders['Cache-Control'] = 'public, max-age=31536000';\n\t\t} else if (cacheControl === CacheControl.NO_CACHING) {\n\t\t\tresponseHeaders['Cache-Control'] = 'no-store';\n\t\t}\n\n\t\tresponseHeaders['Content-Type'] = textMimeType[extname(filePath)] || getMediaMime(filePath) || 'text/plain';\n\n\t\tres.writeHead(200, responseHeaders);\n\n\t\t// Data\n\t\tcreateReadStream(filePath).pipe(res);\n\t} catch (error) {\n\t\tif (error.code !== 'ENOENT') {\n\t\t\tlogService.error(error);\n\t\t\tconsole.error(error.toString());\n\t\t} else {\n\t\t\tconsole.error(`File not found: ${filePath}`);\n\t\t}\n\n\t\tres.writeHead(404, { 'Content-Type': 'text/plain' });\n\t\treturn void res.end('Not found');\n\t}\n}\n\nconst APP_ROOT = dirname(FileAccess.asFileUri('').fsPath);\n\nconst STATIC_PATH = `/static`;\nconst CALLBACK_PATH = `/callback`;\nconst WEB_EXTENSION_PATH = `/web-extension-resource`;\n\nexport class WebClientServer {\n\n\tprivate readonly _webExtensionResourceUrlTemplate: URI | undefined;\n\n\tconstructor(\n\t\tprivate readonly _connectionToken: ServerConnectionToken,\n\t\tprivate readonly _basePath: string,\n\t\tprivate readonly _productPath: string,\n\t\t@IServerEnvironmentService private readonly _environmentService: IServerEnvironmentService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IRequestService private readonly _requestService: IRequestService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@ICSSDevelopmentService private readonly _cssDevService: ICSSDevelopmentService\n\t) {\n\t\tthis._webExtensionResourceUrlTemplate = this._productService.extensionsGallery?.resourceUrlTemplate ? URI.parse(this._productService.extensionsGallery.resourceUrlTemplate) : undefined;\n\t}\n\n\t/**\n\t * Handle web resources (i.e. only needed by the web client).\n\t * **NOTE**: This method is only invoked when the server has web bits.\n\t * **NOTE**: This method is only invoked after the connection token has been validated.\n\t * @param parsedUrl The URL to handle, including base and product path\n\t * @param pathname The pathname of the URL, without base and product path\n\t */\n\tasync handle(req: http.IncomingMessage, res: http.ServerResponse, parsedUrl: url.UrlWithParsedQuery, pathname: string): Promise<void> {\n\t\ttry {\n\t\t\tif (pathname.startsWith(STATIC_PATH) && pathname.charCodeAt(STATIC_PATH.length) === CharCode.Slash) {\n\t\t\t\treturn this._handleStatic(req, res, pathname.substring(STATIC_PATH.length));\n\t\t\t}\n\t\t\tif (pathname === '/') {\n\t\t\t\treturn this._handleRoot(req, res, parsedUrl);\n\t\t\t}\n\t\t\tif (pathname === CALLBACK_PATH) {\n\t\t\t\t// callback support\n\t\t\t\treturn this._handleCallback(res);\n\t\t\t}\n\t\t\tif (pathname.startsWith(WEB_EXTENSION_PATH) && pathname.charCodeAt(WEB_EXTENSION_PATH.length) === CharCode.Slash) {\n\t\t\t\t// extension resource support\n\t\t\t\treturn this._handleWebExtensionResource(req, res, pathname.substring(WEB_EXTENSION_PATH.length));\n\t\t\t}\n\n\t\t\treturn serveError(req, res, 404, 'Not found.');\n\t\t} catch (error) {\n\t\t\tthis._logService.error(error);\n\t\t\tconsole.error(error.toString());\n\n\t\t\treturn serveError(req, res, 500, 'Internal Server Error.');\n\t\t}\n\t}\n\t/**\n\t * Handle HTTP requests for /static/*\n\t * @param resourcePath The path after /static/\n\t */\n\tprivate async _handleStatic(req: http.IncomingMessage, res: http.ServerResponse, resourcePath: string): Promise<void> {\n\t\tconst headers: Record<string, string> = Object.create(null);\n\n\t\t// Strip the this._staticRoute from the path\n\t\tconst normalizedPathname = decodeURIComponent(resourcePath); // support paths that are uri-encoded (e.g. spaces => %20)\n\n\t\tconst filePath = join(APP_ROOT, normalizedPathname); // join also normalizes the path\n\t\tif (!isEqualOrParent(filePath, APP_ROOT, !isLinux)) {\n\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t}\n\n\t\treturn serveFile(filePath, this._environmentService.isBuilt ? CacheControl.NO_EXPIRY : CacheControl.ETAG, this._logService, req, res, headers);\n\t}\n\n\tprivate _getResourceURLTemplateAuthority(uri: URI): string | undefined {\n\t\tconst index = uri.authority.indexOf('.');\n\t\treturn index !== -1 ? uri.authority.substring(index + 1) : undefined;\n\t}\n\n\t/**\n\t * Handle extension resources\n\t * @param resourcePath The path after /web-extension-resource/\n\t */\n\tprivate async _handleWebExtensionResource(req: http.IncomingMessage, res: http.ServerResponse, resourcePath: string): Promise<void> {\n\t\tif (!this._webExtensionResourceUrlTemplate) {\n\t\t\treturn serveError(req, res, 500, 'No extension gallery service configured.');\n\t\t}\n\n\t\tconst normalizedPathname = decodeURIComponent(resourcePath); // support paths that are uri-encoded (e.g. spaces => %20)\n\t\tconst path = normalize(normalizedPathname);\n\t\tconst uri = URI.parse(path).with({\n\t\t\tscheme: this._webExtensionResourceUrlTemplate.scheme,\n\t\t\tauthority: path.substring(0, path.indexOf('/')),\n\t\t\tpath: path.substring(path.indexOf('/') + 1)\n\t\t});\n\n\t\tif (this._getResourceURLTemplateAuthority(this._webExtensionResourceUrlTemplate) !== this._getResourceURLTemplateAuthority(uri)) {\n\t\t\treturn serveError(req, res, 403, 'Request Forbidden');\n\t\t}\n\n\t\tconst headers: IHeaders = {};\n\t\tconst setRequestHeader = (header: string) => {\n\t\t\tconst value = req.headers[header];\n\t\t\tif (value && (isString(value) || value[0])) {\n\t\t\t\theaders[header] = isString(value) ? value : value[0];\n\t\t\t} else if (header !== header.toLowerCase()) {\n\t\t\t\tsetRequestHeader(header.toLowerCase());\n\t\t\t}\n\t\t};\n\t\tsetRequestHeader('X-Client-Name');\n\t\tsetRequestHeader('X-Client-Version');\n\t\tsetRequestHeader('X-Machine-Id');\n\t\tsetRequestHeader('X-Client-Commit');\n\n\t\tconst context = await this._requestService.request({\n\t\t\ttype: 'GET',\n\t\t\turl: uri.toString(true),\n\t\t\theaders\n\t\t}, CancellationToken.None);\n\n\t\tconst status = context.res.statusCode || 500;\n\t\tif (status !== 200) {\n\t\t\tlet text: string | null = null;\n\t\t\ttry {\n\t\t\t\ttext = await asTextOrError(context);\n\t\t\t} catch (error) {/* Ignore */ }\n\t\t\treturn serveError(req, res, status, text || `Request failed with status ${status}`);\n\t\t}\n\n\t\tconst responseHeaders: Record<string, string | string[]> = Object.create(null);\n\t\tconst setResponseHeader = (header: string) => {\n\t\t\tconst value = context.res.headers[header];\n\t\t\tif (value) {\n\t\t\t\tresponseHeaders[header] = value;\n\t\t\t} else if (header !== header.toLowerCase()) {\n\t\t\t\tsetResponseHeader(header.toLowerCase());\n\t\t\t}\n\t\t};\n\t\tsetResponseHeader('Cache-Control');\n\t\tsetResponseHeader('Content-Type');\n\t\tres.writeHead(200, responseHeaders);\n\t\tconst buffer = await streamToBuffer(context.stream);\n\t\treturn void res.end(buffer.buffer);\n\t}\n\n\t/**\n\t * Handle HTTP requests for /\n\t */\n\tprivate async _handleRoot(req: http.IncomingMessage, res: http.ServerResponse, parsedUrl: url.UrlWithParsedQuery): Promise<void> {\n\n\t\tconst getFirstHeader = (headerName: string) => {\n\t\t\tconst val = req.headers[headerName];\n\t\t\treturn Array.isArray(val) ? val[0] : val;\n\t\t};\n\n\t\t// Prefix routes with basePath for clients\n\t\tconst basePath = getFirstHeader('x-forwarded-prefix') || this._basePath;\n\n\t\tconst queryConnectionToken = parsedUrl.query[connectionTokenQueryName];\n\t\tif (typeof queryConnectionToken === 'string') {\n\t\t\t// We got a connection token as a query parameter.\n\t\t\t// We want to have a clean URL, so we strip it\n\t\t\tconst responseHeaders: Record<string, string> = Object.create(null);\n\t\t\tresponseHeaders['Set-Cookie'] = cookie.serialize(\n\t\t\t\tconnectionTokenCookieName,\n\t\t\t\tqueryConnectionToken,\n\t\t\t\t{\n\t\t\t\t\tsameSite: 'lax',\n\t\t\t\t\tmaxAge: 60 * 60 * 24 * 7 /* 1 week */\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tconst newQuery = Object.create(null);\n\t\t\tfor (const key in parsedUrl.query) {\n\t\t\t\tif (key !== connectionTokenQueryName) {\n\t\t\t\t\tnewQuery[key] = parsedUrl.query[key];\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst newLocation = url.format({ pathname: basePath, query: newQuery });\n\t\t\tresponseHeaders['Location'] = newLocation;\n\n\t\t\tres.writeHead(302, responseHeaders);\n\t\t\treturn void res.end();\n\t\t}\n\n\t\tconst replacePort = (host: string, port: string) => {\n\t\t\tconst index = host?.indexOf(':');\n\t\t\tif (index !== -1) {\n\t\t\t\thost = host?.substring(0, index);\n\t\t\t}\n\t\t\thost += `:${port}`;\n\t\t\treturn host;\n\t\t};\n\n\t\tconst useTestResolver = (!this._environmentService.isBuilt && this._environmentService.args['use-test-resolver']);\n\t\tlet remoteAuthority = (\n\t\t\tuseTestResolver\n\t\t\t\t? 'test+test'\n\t\t\t\t: (getFirstHeader('x-original-host') || getFirstHeader('x-forwarded-host') || req.headers.host)\n\t\t);\n\t\tif (!remoteAuthority) {\n\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t}\n\t\tconst forwardedPort = getFirstHeader('x-forwarded-port');\n\t\tif (forwardedPort) {\n\t\t\tremoteAuthority = replacePort(remoteAuthority, forwardedPort);\n\t\t}\n\n\t\tfunction asJSON(value: unknown): string {\n\t\t\treturn JSON.stringify(value).replace(/\"/g, '&quot;');\n\t\t}\n\n\t\tlet _wrapWebWorkerExtHostInIframe: undefined | false = undefined;\n\t\tif (this._environmentService.args['enable-smoke-test-driver']) {\n\t\t\t// integration tests run at a time when the built output is not yet published to the CDN\n\t\t\t// so we must disable the iframe wrapping because the iframe URL will give a 404\n\t\t\t_wrapWebWorkerExtHostInIframe = false;\n\t\t}\n\n\t\tif (this._logService.getLevel() === LogLevel.Trace) {\n\t\t\t['x-original-host', 'x-forwarded-host', 'x-forwarded-port', 'host'].forEach(header => {\n\t\t\t\tconst value = getFirstHeader(header);\n\t\t\t\tif (value) {\n\t\t\t\t\tthis._logService.trace(`[WebClientServer] ${header}: ${value}`);\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis._logService.trace(`[WebClientServer] Request URL: ${req.url}, basePath: ${basePath}, remoteAuthority: ${remoteAuthority}`);\n\t\t}\n\n\t\tconst staticRoute = posix.join(basePath, this._productPath, STATIC_PATH);\n\t\tconst callbackRoute = posix.join(basePath, this._productPath, CALLBACK_PATH);\n\t\tconst webExtensionRoute = posix.join(basePath, this._productPath, WEB_EXTENSION_PATH);\n\n\t\tconst resolveWorkspaceURI = (defaultLocation?: string) => defaultLocation && URI.file(resolve(defaultLocation)).with({ scheme: Schemas.vscodeRemote, authority: remoteAuthority });\n\n\t\tconst filePath = FileAccess.asFileUri(`vs/code/browser/workbench/workbench${this._environmentService.isBuilt ? '' : '-dev'}.html`).fsPath;\n\t\tconst authSessionInfo = !this._environmentService.isBuilt && this._environmentService.args['github-auth'] ? {\n\t\t\tid: generateUuid(),\n\t\t\tproviderId: 'github',\n\t\t\taccessToken: this._environmentService.args['github-auth'],\n\t\t\tscopes: [['user:email'], ['repo']]\n\t\t} : undefined;\n\n\t\tconst productConfiguration: Partial<Mutable<IProductConfiguration>> = {\n\t\t\tembedderIdentifier: 'server-distro',\n\t\t\textensionsGallery: this._webExtensionResourceUrlTemplate && this._productService.extensionsGallery ? {\n\t\t\t\t...this._productService.extensionsGallery,\n\t\t\t\tresourceUrlTemplate: this._webExtensionResourceUrlTemplate.with({\n\t\t\t\t\tscheme: 'http',\n\t\t\t\t\tauthority: remoteAuthority,\n\t\t\t\t\tpath: `${webExtensionRoute}/${this._webExtensionResourceUrlTemplate.authority}${this._webExtensionResourceUrlTemplate.path}`\n\t\t\t\t}).toString(true)\n\t\t\t} : undefined\n\t\t};\n\n\t\tconst proposedApi = this._environmentService.args['enable-proposed-api'];\n\t\tif (proposedApi?.length) {\n\t\t\tproductConfiguration.extensionsEnabledWithApiProposalVersion ??= [];\n\t\t\tproductConfiguration.extensionsEnabledWithApiProposalVersion.push(...proposedApi);\n\t\t}\n\n\t\tif (!this._environmentService.isBuilt) {\n\t\t\ttry {\n\t\t\t\tconst productOverrides = JSON.parse((await promises.readFile(join(APP_ROOT, 'product.overrides.json'))).toString());\n\t\t\t\tObject.assign(productConfiguration, productOverrides);\n\t\t\t} catch (err) {/* Ignore Error */ }\n\t\t}\n\n\t\tconst workbenchWebConfiguration = {\n\t\t\tremoteAuthority,\n\t\t\tserverBasePath: basePath,\n\t\t\t_wrapWebWorkerExtHostInIframe,\n\t\t\tdevelopmentOptions: { enableSmokeTestDriver: this._environmentService.args['enable-smoke-test-driver'] ? true : undefined, logLevel: this._logService.getLevel() },\n\t\t\tsettingsSyncOptions: !this._environmentService.isBuilt && this._environmentService.args['enable-sync'] ? { enabled: true } : undefined,\n\t\t\tenableWorkspaceTrust: !this._environmentService.args['disable-workspace-trust'],\n\t\t\tfolderUri: resolveWorkspaceURI(this._environmentService.args['default-folder']),\n\t\t\tworkspaceUri: resolveWorkspaceURI(this._environmentService.args['default-workspace']),\n\t\t\tproductConfiguration,\n\t\t\tcallbackRoute: callbackRoute\n\t\t};\n\n\t\tconst cookies = cookie.parse(req.headers.cookie || '');\n\t\tconst locale = cookies['vscode.nls.locale'] || req.headers['accept-language']?.split(',')[0]?.toLowerCase() || 'en';\n\t\tlet WORKBENCH_NLS_BASE_URL: string | undefined;\n\t\tlet WORKBENCH_NLS_URL: string;\n\t\tif (!locale.startsWith('en') && this._productService.nlsCoreBaseUrl) {\n\t\t\tWORKBENCH_NLS_BASE_URL = this._productService.nlsCoreBaseUrl;\n\t\t\tWORKBENCH_NLS_URL = `${WORKBENCH_NLS_BASE_URL}${this._productService.commit}/${this._productService.version}/${locale}/nls.messages.js`;\n\t\t} else {\n\t\t\tWORKBENCH_NLS_URL = ''; // fallback will apply\n\t\t}\n\n\t\tconst values: { [key: string]: string } = {\n\t\t\tWORKBENCH_WEB_CONFIGURATION: asJSON(workbenchWebConfiguration),\n\t\t\tWORKBENCH_AUTH_SESSION: authSessionInfo ? asJSON(authSessionInfo) : '',\n\t\t\tWORKBENCH_WEB_BASE_URL: staticRoute,\n\t\t\tWORKBENCH_NLS_URL,\n\t\t\tWORKBENCH_NLS_FALLBACK_URL: `${staticRoute}/out/nls.messages.js`\n\t\t};\n\n\t\t// DEV ---------------------------------------------------------------------------------------\n\t\t// DEV: This is for development and enables loading CSS via import-statements via import-maps.\n\t\t// DEV: The server needs to send along all CSS modules so that the client can construct the\n\t\t// DEV: import-map.\n\t\t// DEV ---------------------------------------------------------------------------------------\n\t\tif (this._cssDevService.isEnabled) {\n\t\t\tconst cssModules = await this._cssDevService.getCssModules();\n\t\t\tvalues['WORKBENCH_DEV_CSS_MODULES'] = JSON.stringify(cssModules);\n\t\t}\n\n\t\tif (useTestResolver) {\n\t\t\tconst bundledExtensions: { extensionPath: string; packageJSON: IExtensionManifest }[] = [];\n\t\t\tfor (const extensionPath of ['vscode-test-resolver', 'github-authentication']) {\n\t\t\t\tconst packageJSON = JSON.parse((await promises.readFile(FileAccess.asFileUri(`${builtinExtensionsPath}/${extensionPath}/package.json`).fsPath)).toString());\n\t\t\t\tbundledExtensions.push({ extensionPath, packageJSON });\n\t\t\t}\n\t\t\tvalues['WORKBENCH_BUILTIN_EXTENSIONS'] = asJSON(bundledExtensions);\n\t\t}\n\n\t\tlet data;\n\t\ttry {\n\t\t\tconst workbenchTemplate = (await promises.readFile(filePath)).toString();\n\t\t\tdata = workbenchTemplate.replace(/\\{\\{([^}]+)\\}\\}/g, (_, key) => values[key] ?? 'undefined');\n\t\t} catch (e) {\n\t\t\tres.writeHead(404, { 'Content-Type': 'text/plain' });\n\t\t\treturn void res.end('Not found');\n\t\t}\n\n\t\tconst webWorkerExtensionHostIframeScriptSHA = 'sha256-2Q+j4hfT09+1+imS46J2YlkCtHWQt0/BE79PXjJ0ZJ8=';\n\n\t\tconst cspDirectives = [\n\t\t\t'default-src \\'self\\';',\n\t\t\t'img-src \\'self\\' https: data: blob:;',\n\t\t\t'media-src \\'self\\';',\n\t\t\t`script-src 'self' 'unsafe-eval' ${WORKBENCH_NLS_BASE_URL ?? ''} blob: 'nonce-1nline-m4p' ${this._getScriptCspHashes(data).join(' ')} '${webWorkerExtensionHostIframeScriptSHA}' 'sha256-/r7rqQ+yrxt57sxLuQ6AMYcy/lUpvAIzHjIJt/OeLWU=' ${useTestResolver ? '' : `http://${remoteAuthority}`};`,  // the sha is the same as in src/vs/workbench/services/extensions/worker/webWorkerExtensionHostIframe.html\n\t\t\t'child-src \\'self\\';',\n\t\t\t`frame-src 'self' https://*.vscode-cdn.net data:;`,\n\t\t\t'worker-src \\'self\\' data: blob:;',\n\t\t\t'style-src \\'self\\' \\'unsafe-inline\\';',\n\t\t\t'connect-src \\'self\\' ws: wss: https:;',\n\t\t\t'font-src \\'self\\' blob:;',\n\t\t\t'manifest-src \\'self\\';'\n\t\t].join(' ');\n\n\t\tconst headers: http.OutgoingHttpHeaders = {\n\t\t\t'Content-Type': 'text/html',\n\t\t\t'Content-Security-Policy': cspDirectives\n\t\t};\n\t\tif (this._connectionToken.type !== ServerConnectionTokenType.None) {\n\t\t\t// At this point we know the client has a valid cookie\n\t\t\t// and we want to set it prolong it to ensure that this\n\t\t\t// client is valid for another 1 week at least\n\t\t\theaders['Set-Cookie'] = cookie.serialize(\n\t\t\t\tconnectionTokenCookieName,\n\t\t\t\tthis._connectionToken.value,\n\t\t\t\t{\n\t\t\t\t\tsameSite: 'lax',\n\t\t\t\t\tmaxAge: 60 * 60 * 24 * 7 /* 1 week */\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\n\t\tres.writeHead(200, headers);\n\t\treturn void res.end(data);\n\t}\n\n\tprivate _getScriptCspHashes(content: string): string[] {\n\t\t// Compute the CSP hashes for line scripts. Uses regex\n\t\t// which means it isn't 100% good.\n\t\tconst regex = /<script>([\\s\\S]+?)<\\/script>/img;\n\t\tconst result: string[] = [];\n\t\tlet match: RegExpExecArray | null;\n\t\twhile (match = regex.exec(content)) {\n\t\t\tconst hasher = crypto.createHash('sha256');\n\t\t\t// This only works on Windows if we strip `\\r` from `\\r\\n`.\n\t\t\tconst script = match[1].replace(/\\r\\n/g, '\\n');\n\t\t\tconst hash = hasher\n\t\t\t\t.update(Buffer.from(script))\n\t\t\t\t.digest().toString('base64');\n\n\t\t\tresult.push(`'sha256-${hash}'`);\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**\n\t * Handle HTTP requests for /callback\n\t */\n\tprivate async _handleCallback(res: http.ServerResponse): Promise<void> {\n\t\tconst filePath = FileAccess.asFileUri('vs/code/browser/workbench/callback.html').fsPath;\n\t\tconst data = (await promises.readFile(filePath)).toString();\n\t\tconst cspDirectives = [\n\t\t\t'default-src \\'self\\';',\n\t\t\t'img-src \\'self\\' https: data: blob:;',\n\t\t\t'media-src \\'none\\';',\n\t\t\t`script-src 'self' ${this._getScriptCspHashes(data).join(' ')};`,\n\t\t\t'style-src \\'self\\' \\'unsafe-inline\\';',\n\t\t\t'font-src \\'self\\' blob:;'\n\t\t].join(' ');\n\n\t\tres.writeHead(200, {\n\t\t\t'Content-Type': 'text/html',\n\t\t\t'Content-Security-Policy': cspDirectives\n\t\t});\n\t\treturn void res.end(data);\n\t}\n}\n"]}