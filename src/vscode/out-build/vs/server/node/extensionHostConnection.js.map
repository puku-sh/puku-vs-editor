{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/server/node/extensionHostConnection.ts","vs/server/node/extensionHostConnection.ts"],"names":[],"mappings":"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","file":"extensionHostConnection.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as cp from 'child_process';\nimport * as net from 'net';\nimport { VSBuffer } from '../../base/common/buffer.js';\nimport { Emitter, Event } from '../../base/common/event.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../base/common/lifecycle.js';\nimport { FileAccess } from '../../base/common/network.js';\nimport { delimiter, join } from '../../base/common/path.js';\nimport { IProcessEnvironment, isWindows } from '../../base/common/platform.js';\nimport { removeDangerousEnvVariables } from '../../base/common/processes.js';\nimport { createRandomIPCHandle, NodeSocket, WebSocketNodeSocket } from '../../base/parts/ipc/node/ipc.net.js';\nimport { IConfigurationService } from '../../platform/configuration/common/configuration.js';\nimport { ILogService } from '../../platform/log/common/log.js';\nimport { IRemoteExtensionHostStartParams } from '../../platform/remote/common/remoteAgentConnection.js';\nimport { getResolvedShellEnv } from '../../platform/shell/node/shellEnv.js';\nimport { IExtensionHostStatusService } from './extensionHostStatusService.js';\nimport { getNLSConfiguration } from './remoteLanguagePacks.js';\nimport { IServerEnvironmentService } from './serverEnvironmentService.js';\nimport { IPCExtHostConnection, SocketExtHostConnection, writeExtHostConnection } from '../../workbench/services/extensions/common/extensionHostEnv.js';\nimport { IExtHostReadyMessage, IExtHostReduceGraceTimeMessage, IExtHostSocketMessage } from '../../workbench/services/extensions/common/extensionHostProtocol.js';\n\nexport async function buildUserEnvironment(startParamsEnv: { [key: string]: string | null } = {}, withUserShellEnvironment: boolean, language: string, environmentService: IServerEnvironmentService, logService: ILogService, configurationService: IConfigurationService): Promise<IProcessEnvironment> {\n\tconst nlsConfig = await getNLSConfiguration(language, environmentService.userDataPath);\n\n\tlet userShellEnv: typeof process.env = {};\n\tif (withUserShellEnvironment) {\n\t\ttry {\n\t\t\tuserShellEnv = await getResolvedShellEnv(configurationService, logService, environmentService.args, process.env);\n\t\t} catch (error) {\n\t\t\tlogService.error('ExtensionHostConnection#buildUserEnvironment resolving shell environment failed', error);\n\t\t}\n\t}\n\n\tconst processEnv = process.env;\n\n\tconst env: IProcessEnvironment = {\n\t\t...processEnv,\n\t\t...userShellEnv,\n\t\t...{\n\t\t\tVSCODE_ESM_ENTRYPOINT: 'vs/workbench/api/node/extensionHostProcess',\n\t\t\tVSCODE_HANDLES_UNCAUGHT_ERRORS: 'true',\n\t\t\tVSCODE_NLS_CONFIG: JSON.stringify(nlsConfig)\n\t\t},\n\t\t...startParamsEnv\n\t};\n\n\tconst binFolder = environmentService.isBuilt ? join(environmentService.appRoot, 'bin') : join(environmentService.appRoot, 'resources', 'server', 'bin-dev');\n\tconst remoteCliBinFolder = join(binFolder, 'remote-cli'); // contains the `code` command that can talk to the remote server\n\n\tlet PATH = readCaseInsensitive(env, 'PATH');\n\tif (PATH) {\n\t\tPATH = remoteCliBinFolder + delimiter + PATH;\n\t} else {\n\t\tPATH = remoteCliBinFolder;\n\t}\n\tsetCaseInsensitive(env, 'PATH', PATH);\n\n\tif (!environmentService.args['without-browser-env-var']) {\n\t\tenv.BROWSER = join(binFolder, 'helpers', isWindows ? 'browser.cmd' : 'browser.sh'); // a command that opens a browser on the local machine\n\t}\n\n\tenv.VSCODE_RECONNECTION_GRACE_TIME = String(environmentService.reconnectionGraceTime);\n\tlogService.trace(`[reconnection-grace-time] Setting VSCODE_RECONNECTION_GRACE_TIME env var for extension host: ${environmentService.reconnectionGraceTime}ms (${Math.floor(environmentService.reconnectionGraceTime / 1000)}s)`);\n\n\tremoveNulls(env);\n\treturn env;\n}\n\nclass ConnectionData {\n\tconstructor(\n\t\tpublic readonly socket: NodeSocket | WebSocketNodeSocket,\n\t\tpublic readonly initialDataChunk: VSBuffer\n\t) { }\n\n\tpublic socketDrain(): Promise<void> {\n\t\treturn this.socket.drain();\n\t}\n\n\tpublic toIExtHostSocketMessage(): IExtHostSocketMessage {\n\n\t\tlet skipWebSocketFrames: boolean;\n\t\tlet permessageDeflate: boolean;\n\t\tlet inflateBytes: VSBuffer;\n\n\t\tif (this.socket instanceof NodeSocket) {\n\t\t\tskipWebSocketFrames = true;\n\t\t\tpermessageDeflate = false;\n\t\t\tinflateBytes = VSBuffer.alloc(0);\n\t\t} else {\n\t\t\tskipWebSocketFrames = false;\n\t\t\tpermessageDeflate = this.socket.permessageDeflate;\n\t\t\tinflateBytes = this.socket.recordedInflateBytes;\n\t\t}\n\n\t\treturn {\n\t\t\ttype: 'VSCODE_EXTHOST_IPC_SOCKET',\n\t\t\tinitialDataChunk: (<Buffer>this.initialDataChunk.buffer).toString('base64'),\n\t\t\tskipWebSocketFrames: skipWebSocketFrames,\n\t\t\tpermessageDeflate: permessageDeflate,\n\t\t\tinflateBytes: (<Buffer>inflateBytes.buffer).toString('base64'),\n\t\t};\n\t}\n}\n\nexport class ExtensionHostConnection extends Disposable {\n\n\tprivate _onClose = new Emitter<void>();\n\treadonly onClose: Event<void> = this._onClose.event;\n\n\tprivate readonly _canSendSocket: boolean;\n\tprivate _disposed: boolean;\n\tprivate _remoteAddress: string;\n\tprivate _extensionHostProcess: cp.ChildProcess | null;\n\tprivate _connectionData: ConnectionData | null;\n\n\tconstructor(\n\t\tprivate readonly _reconnectionToken: string,\n\t\tremoteAddress: string,\n\t\tsocket: NodeSocket | WebSocketNodeSocket,\n\t\tinitialDataChunk: VSBuffer,\n\t\t@IServerEnvironmentService private readonly _environmentService: IServerEnvironmentService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IExtensionHostStatusService private readonly _extensionHostStatusService: IExtensionHostStatusService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService\n\t) {\n\t\tsuper();\n\t\tthis._canSendSocket = (!isWindows || !this._environmentService.args['socket-path']);\n\t\tthis._disposed = false;\n\t\tthis._remoteAddress = remoteAddress;\n\t\tthis._extensionHostProcess = null;\n\t\tthis._connectionData = new ConnectionData(socket, initialDataChunk);\n\n\t\tthis._log(`New connection established.`);\n\t}\n\n\toverride dispose(): void {\n\t\tthis._cleanResources();\n\t\tsuper.dispose();\n\t}\n\n\tprivate get _logPrefix(): string {\n\t\treturn `[${this._remoteAddress}][${this._reconnectionToken.substr(0, 8)}][ExtensionHostConnection] `;\n\t}\n\n\tprivate _log(_str: string): void {\n\t\tthis._logService.info(`${this._logPrefix}${_str}`);\n\t}\n\n\tprivate _logError(_str: string): void {\n\t\tthis._logService.error(`${this._logPrefix}${_str}`);\n\t}\n\n\tprivate async _pipeSockets(extHostSocket: net.Socket, connectionData: ConnectionData): Promise<void> {\n\n\t\tconst disposables = new DisposableStore();\n\t\tdisposables.add(connectionData.socket);\n\t\tdisposables.add(toDisposable(() => {\n\t\t\textHostSocket.destroy();\n\t\t}));\n\n\t\tconst stopAndCleanup = () => {\n\t\t\tdisposables.dispose();\n\t\t};\n\n\t\tdisposables.add(connectionData.socket.onEnd(stopAndCleanup));\n\t\tdisposables.add(connectionData.socket.onClose(stopAndCleanup));\n\n\t\tdisposables.add(Event.fromNodeEventEmitter<void>(extHostSocket, 'end')(stopAndCleanup));\n\t\tdisposables.add(Event.fromNodeEventEmitter<void>(extHostSocket, 'close')(stopAndCleanup));\n\t\tdisposables.add(Event.fromNodeEventEmitter<void>(extHostSocket, 'error')(stopAndCleanup));\n\n\t\tdisposables.add(connectionData.socket.onData((e) => extHostSocket.write(e.buffer)));\n\t\tdisposables.add(Event.fromNodeEventEmitter<Buffer>(extHostSocket, 'data')((e) => {\n\t\t\tconnectionData.socket.write(VSBuffer.wrap(e));\n\t\t}));\n\n\t\tif (connectionData.initialDataChunk.byteLength > 0) {\n\t\t\textHostSocket.write(connectionData.initialDataChunk.buffer);\n\t\t}\n\t}\n\n\tprivate async _sendSocketToExtensionHost(extensionHostProcess: cp.ChildProcess, connectionData: ConnectionData): Promise<void> {\n\t\t// Make sure all outstanding writes have been drained before sending the socket\n\t\tawait connectionData.socketDrain();\n\t\tconst msg = connectionData.toIExtHostSocketMessage();\n\t\tlet socket: net.Socket;\n\t\tif (connectionData.socket instanceof NodeSocket) {\n\t\t\tsocket = connectionData.socket.socket;\n\t\t} else {\n\t\t\tsocket = connectionData.socket.socket.socket;\n\t\t}\n\t\textensionHostProcess.send(msg, socket);\n\t}\n\n\tpublic shortenReconnectionGraceTimeIfNecessary(): void {\n\t\tif (!this._extensionHostProcess) {\n\t\t\treturn;\n\t\t}\n\t\tconst msg: IExtHostReduceGraceTimeMessage = {\n\t\t\ttype: 'VSCODE_EXTHOST_IPC_REDUCE_GRACE_TIME'\n\t\t};\n\t\tthis._extensionHostProcess.send(msg);\n\t}\n\n\tpublic acceptReconnection(remoteAddress: string, _socket: NodeSocket | WebSocketNodeSocket, initialDataChunk: VSBuffer): void {\n\t\tthis._remoteAddress = remoteAddress;\n\t\tthis._log(`The client has reconnected.`);\n\t\tconst connectionData = new ConnectionData(_socket, initialDataChunk);\n\n\t\tif (!this._extensionHostProcess) {\n\t\t\t// The extension host didn't even start up yet\n\t\t\tthis._connectionData = connectionData;\n\t\t\treturn;\n\t\t}\n\n\t\tthis._sendSocketToExtensionHost(this._extensionHostProcess, connectionData);\n\t}\n\n\tprivate _cleanResources(): void {\n\t\tif (this._disposed) {\n\t\t\t// already called\n\t\t\treturn;\n\t\t}\n\t\tthis._disposed = true;\n\t\tif (this._connectionData) {\n\t\t\tthis._connectionData.socket.end();\n\t\t\tthis._connectionData = null;\n\t\t}\n\t\tif (this._extensionHostProcess) {\n\t\t\tthis._extensionHostProcess.kill();\n\t\t\tthis._extensionHostProcess = null;\n\t\t}\n\t\tthis._onClose.fire(undefined);\n\t}\n\n\tpublic async start(startParams: IRemoteExtensionHostStartParams): Promise<void> {\n\t\ttry {\n\t\t\tlet execArgv: string[] = process.execArgv ? process.execArgv.filter(a => !/^--inspect(-brk)?=/.test(a)) : [];\n\t\t\t// eslint-disable-next-line local/code-no-any-casts, @typescript-eslint/no-explicit-any\n\t\t\tif (startParams.port && !(<any>process).pkg) {\n\t\t\t\texecArgv = [\n\t\t\t\t\t`--inspect${startParams.break ? '-brk' : ''}=${startParams.port}`,\n\t\t\t\t\t'--experimental-network-inspection'\n\t\t\t\t];\n\t\t\t}\n\n\t\t\tconst env = await buildUserEnvironment(startParams.env, true, startParams.language, this._environmentService, this._logService, this._configurationService);\n\t\t\tremoveDangerousEnvVariables(env);\n\n\t\t\tlet extHostNamedPipeServer: net.Server | null;\n\n\t\t\tif (this._canSendSocket) {\n\t\t\t\twriteExtHostConnection(new SocketExtHostConnection(), env);\n\t\t\t\textHostNamedPipeServer = null;\n\t\t\t} else {\n\t\t\t\tconst { namedPipeServer, pipeName } = await this._listenOnPipe();\n\t\t\t\twriteExtHostConnection(new IPCExtHostConnection(pipeName), env);\n\t\t\t\textHostNamedPipeServer = namedPipeServer;\n\t\t\t}\n\n\t\t\tconst opts = {\n\t\t\t\tenv,\n\t\t\t\texecArgv,\n\t\t\t\tsilent: true\n\t\t\t};\n\n\t\t\t// Refs https://github.com/microsoft/vscode/issues/189805\n\t\t\topts.execArgv.unshift('--dns-result-order=ipv4first');\n\n\t\t\t// Run Extension Host as fork of current process\n\t\t\tconst args = ['--type=extensionHost', `--transformURIs`];\n\t\t\tconst useHostProxy = this._environmentService.args['use-host-proxy'];\n\t\t\targs.push(`--useHostProxy=${useHostProxy ? 'true' : 'false'}`);\n\t\t\tif (this._configurationService.getValue<boolean>('extensions.supportNodeGlobalNavigator')) {\n\t\t\t\targs.push('--supportGlobalNavigator');\n\t\t\t}\n\t\t\tthis._extensionHostProcess = cp.fork(FileAccess.asFileUri('bootstrap-fork').fsPath, args, opts);\n\t\t\tconst pid = this._extensionHostProcess.pid;\n\t\t\tthis._log(`<${pid}> Launched Extension Host Process.`);\n\n\t\t\t// Catch all output coming from the extension host process\n\t\t\tthis._extensionHostProcess.stdout!.setEncoding('utf8');\n\t\t\tthis._extensionHostProcess.stderr!.setEncoding('utf8');\n\t\t\tconst onStdout = Event.fromNodeEventEmitter<string>(this._extensionHostProcess.stdout!, 'data');\n\t\t\tconst onStderr = Event.fromNodeEventEmitter<string>(this._extensionHostProcess.stderr!, 'data');\n\t\t\tthis._register(onStdout((e) => this._log(`<${pid}> ${e}`)));\n\t\t\tthis._register(onStderr((e) => this._log(`<${pid}><stderr> ${e}`)));\n\n\t\t\t// Lifecycle\n\t\t\tthis._extensionHostProcess.on('error', (err) => {\n\t\t\t\tthis._logError(`<${pid}> Extension Host Process had an error`);\n\t\t\t\tthis._logService.error(err);\n\t\t\t\tthis._cleanResources();\n\t\t\t});\n\n\t\t\tthis._extensionHostProcess.on('exit', (code: number, signal: string) => {\n\t\t\t\tthis._extensionHostStatusService.setExitInfo(this._reconnectionToken, { code, signal });\n\t\t\t\tthis._log(`<${pid}> Extension Host Process exited with code: ${code}, signal: ${signal}.`);\n\t\t\t\tthis._cleanResources();\n\t\t\t});\n\n\t\t\tif (extHostNamedPipeServer) {\n\t\t\t\textHostNamedPipeServer.on('connection', (socket) => {\n\t\t\t\t\textHostNamedPipeServer.close();\n\t\t\t\t\tthis._pipeSockets(socket, this._connectionData!);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tconst messageListener = (msg: IExtHostReadyMessage) => {\n\t\t\t\t\tif (msg.type === 'VSCODE_EXTHOST_IPC_READY') {\n\t\t\t\t\t\tthis._extensionHostProcess!.removeListener('message', messageListener);\n\t\t\t\t\t\tthis._sendSocketToExtensionHost(this._extensionHostProcess!, this._connectionData!);\n\t\t\t\t\t\tthis._connectionData = null;\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tthis._extensionHostProcess.on('message', messageListener);\n\t\t\t}\n\n\t\t} catch (error) {\n\t\t\tconsole.error('ExtensionHostConnection errored');\n\t\t\tif (error) {\n\t\t\t\tconsole.error(error);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _listenOnPipe(): Promise<{ pipeName: string; namedPipeServer: net.Server }> {\n\t\treturn new Promise<{ pipeName: string; namedPipeServer: net.Server }>((resolve, reject) => {\n\t\t\tconst pipeName = createRandomIPCHandle();\n\n\t\t\tconst namedPipeServer = net.createServer();\n\t\t\tnamedPipeServer.on('error', reject);\n\t\t\tnamedPipeServer.listen(pipeName, () => {\n\t\t\t\tnamedPipeServer?.removeListener('error', reject);\n\t\t\t\tresolve({ pipeName, namedPipeServer });\n\t\t\t});\n\t\t});\n\t}\n}\n\nfunction readCaseInsensitive(env: { [key: string]: string | undefined }, key: string): string | undefined {\n\tconst pathKeys = Object.keys(env).filter(k => k.toLowerCase() === key.toLowerCase());\n\tconst pathKey = pathKeys.length > 0 ? pathKeys[0] : key;\n\treturn env[pathKey];\n}\n\nfunction setCaseInsensitive(env: { [key: string]: unknown }, key: string, value: string): void {\n\tconst pathKeys = Object.keys(env).filter(k => k.toLowerCase() === key.toLowerCase());\n\tconst pathKey = pathKeys.length > 0 ? pathKeys[0] : key;\n\tenv[pathKey] = value;\n}\n\nfunction removeNulls(env: { [key: string]: unknown | null }): void {\n\t// Don't delete while iterating the object itself\n\tfor (const key of Object.keys(env)) {\n\t\tif (env[key] === null) {\n\t\t\tdelete env[key];\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as cp from 'child_process';\nimport * as net from 'net';\nimport { VSBuffer } from '../../base/common/buffer.js';\nimport { Emitter, Event } from '../../base/common/event.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../base/common/lifecycle.js';\nimport { FileAccess } from '../../base/common/network.js';\nimport { delimiter, join } from '../../base/common/path.js';\nimport { IProcessEnvironment, isWindows } from '../../base/common/platform.js';\nimport { removeDangerousEnvVariables } from '../../base/common/processes.js';\nimport { createRandomIPCHandle, NodeSocket, WebSocketNodeSocket } from '../../base/parts/ipc/node/ipc.net.js';\nimport { IConfigurationService } from '../../platform/configuration/common/configuration.js';\nimport { ILogService } from '../../platform/log/common/log.js';\nimport { IRemoteExtensionHostStartParams } from '../../platform/remote/common/remoteAgentConnection.js';\nimport { getResolvedShellEnv } from '../../platform/shell/node/shellEnv.js';\nimport { IExtensionHostStatusService } from './extensionHostStatusService.js';\nimport { getNLSConfiguration } from './remoteLanguagePacks.js';\nimport { IServerEnvironmentService } from './serverEnvironmentService.js';\nimport { IPCExtHostConnection, SocketExtHostConnection, writeExtHostConnection } from '../../workbench/services/extensions/common/extensionHostEnv.js';\nimport { IExtHostReadyMessage, IExtHostReduceGraceTimeMessage, IExtHostSocketMessage } from '../../workbench/services/extensions/common/extensionHostProtocol.js';\n\nexport async function buildUserEnvironment(startParamsEnv: { [key: string]: string | null } = {}, withUserShellEnvironment: boolean, language: string, environmentService: IServerEnvironmentService, logService: ILogService, configurationService: IConfigurationService): Promise<IProcessEnvironment> {\n\tconst nlsConfig = await getNLSConfiguration(language, environmentService.userDataPath);\n\n\tlet userShellEnv: typeof process.env = {};\n\tif (withUserShellEnvironment) {\n\t\ttry {\n\t\t\tuserShellEnv = await getResolvedShellEnv(configurationService, logService, environmentService.args, process.env);\n\t\t} catch (error) {\n\t\t\tlogService.error('ExtensionHostConnection#buildUserEnvironment resolving shell environment failed', error);\n\t\t}\n\t}\n\n\tconst processEnv = process.env;\n\n\tconst env: IProcessEnvironment = {\n\t\t...processEnv,\n\t\t...userShellEnv,\n\t\t...{\n\t\t\tVSCODE_ESM_ENTRYPOINT: 'vs/workbench/api/node/extensionHostProcess',\n\t\t\tVSCODE_HANDLES_UNCAUGHT_ERRORS: 'true',\n\t\t\tVSCODE_NLS_CONFIG: JSON.stringify(nlsConfig)\n\t\t},\n\t\t...startParamsEnv\n\t};\n\n\tconst binFolder = environmentService.isBuilt ? join(environmentService.appRoot, 'bin') : join(environmentService.appRoot, 'resources', 'server', 'bin-dev');\n\tconst remoteCliBinFolder = join(binFolder, 'remote-cli'); // contains the `code` command that can talk to the remote server\n\n\tlet PATH = readCaseInsensitive(env, 'PATH');\n\tif (PATH) {\n\t\tPATH = remoteCliBinFolder + delimiter + PATH;\n\t} else {\n\t\tPATH = remoteCliBinFolder;\n\t}\n\tsetCaseInsensitive(env, 'PATH', PATH);\n\n\tif (!environmentService.args['without-browser-env-var']) {\n\t\tenv.BROWSER = join(binFolder, 'helpers', isWindows ? 'browser.cmd' : 'browser.sh'); // a command that opens a browser on the local machine\n\t}\n\n\tenv.VSCODE_RECONNECTION_GRACE_TIME = String(environmentService.reconnectionGraceTime);\n\tlogService.trace(`[reconnection-grace-time] Setting VSCODE_RECONNECTION_GRACE_TIME env var for extension host: ${environmentService.reconnectionGraceTime}ms (${Math.floor(environmentService.reconnectionGraceTime / 1000)}s)`);\n\n\tremoveNulls(env);\n\treturn env;\n}\n\nclass ConnectionData {\n\tconstructor(\n\t\tpublic readonly socket: NodeSocket | WebSocketNodeSocket,\n\t\tpublic readonly initialDataChunk: VSBuffer\n\t) { }\n\n\tpublic socketDrain(): Promise<void> {\n\t\treturn this.socket.drain();\n\t}\n\n\tpublic toIExtHostSocketMessage(): IExtHostSocketMessage {\n\n\t\tlet skipWebSocketFrames: boolean;\n\t\tlet permessageDeflate: boolean;\n\t\tlet inflateBytes: VSBuffer;\n\n\t\tif (this.socket instanceof NodeSocket) {\n\t\t\tskipWebSocketFrames = true;\n\t\t\tpermessageDeflate = false;\n\t\t\tinflateBytes = VSBuffer.alloc(0);\n\t\t} else {\n\t\t\tskipWebSocketFrames = false;\n\t\t\tpermessageDeflate = this.socket.permessageDeflate;\n\t\t\tinflateBytes = this.socket.recordedInflateBytes;\n\t\t}\n\n\t\treturn {\n\t\t\ttype: 'VSCODE_EXTHOST_IPC_SOCKET',\n\t\t\tinitialDataChunk: (<Buffer>this.initialDataChunk.buffer).toString('base64'),\n\t\t\tskipWebSocketFrames: skipWebSocketFrames,\n\t\t\tpermessageDeflate: permessageDeflate,\n\t\t\tinflateBytes: (<Buffer>inflateBytes.buffer).toString('base64'),\n\t\t};\n\t}\n}\n\nexport class ExtensionHostConnection extends Disposable {\n\n\tprivate _onClose = new Emitter<void>();\n\treadonly onClose: Event<void> = this._onClose.event;\n\n\tprivate readonly _canSendSocket: boolean;\n\tprivate _disposed: boolean;\n\tprivate _remoteAddress: string;\n\tprivate _extensionHostProcess: cp.ChildProcess | null;\n\tprivate _connectionData: ConnectionData | null;\n\n\tconstructor(\n\t\tprivate readonly _reconnectionToken: string,\n\t\tremoteAddress: string,\n\t\tsocket: NodeSocket | WebSocketNodeSocket,\n\t\tinitialDataChunk: VSBuffer,\n\t\t@IServerEnvironmentService private readonly _environmentService: IServerEnvironmentService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IExtensionHostStatusService private readonly _extensionHostStatusService: IExtensionHostStatusService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService\n\t) {\n\t\tsuper();\n\t\tthis._canSendSocket = (!isWindows || !this._environmentService.args['socket-path']);\n\t\tthis._disposed = false;\n\t\tthis._remoteAddress = remoteAddress;\n\t\tthis._extensionHostProcess = null;\n\t\tthis._connectionData = new ConnectionData(socket, initialDataChunk);\n\n\t\tthis._log(`New connection established.`);\n\t}\n\n\toverride dispose(): void {\n\t\tthis._cleanResources();\n\t\tsuper.dispose();\n\t}\n\n\tprivate get _logPrefix(): string {\n\t\treturn `[${this._remoteAddress}][${this._reconnectionToken.substr(0, 8)}][ExtensionHostConnection] `;\n\t}\n\n\tprivate _log(_str: string): void {\n\t\tthis._logService.info(`${this._logPrefix}${_str}`);\n\t}\n\n\tprivate _logError(_str: string): void {\n\t\tthis._logService.error(`${this._logPrefix}${_str}`);\n\t}\n\n\tprivate async _pipeSockets(extHostSocket: net.Socket, connectionData: ConnectionData): Promise<void> {\n\n\t\tconst disposables = new DisposableStore();\n\t\tdisposables.add(connectionData.socket);\n\t\tdisposables.add(toDisposable(() => {\n\t\t\textHostSocket.destroy();\n\t\t}));\n\n\t\tconst stopAndCleanup = () => {\n\t\t\tdisposables.dispose();\n\t\t};\n\n\t\tdisposables.add(connectionData.socket.onEnd(stopAndCleanup));\n\t\tdisposables.add(connectionData.socket.onClose(stopAndCleanup));\n\n\t\tdisposables.add(Event.fromNodeEventEmitter<void>(extHostSocket, 'end')(stopAndCleanup));\n\t\tdisposables.add(Event.fromNodeEventEmitter<void>(extHostSocket, 'close')(stopAndCleanup));\n\t\tdisposables.add(Event.fromNodeEventEmitter<void>(extHostSocket, 'error')(stopAndCleanup));\n\n\t\tdisposables.add(connectionData.socket.onData((e) => extHostSocket.write(e.buffer)));\n\t\tdisposables.add(Event.fromNodeEventEmitter<Buffer>(extHostSocket, 'data')((e) => {\n\t\t\tconnectionData.socket.write(VSBuffer.wrap(e));\n\t\t}));\n\n\t\tif (connectionData.initialDataChunk.byteLength > 0) {\n\t\t\textHostSocket.write(connectionData.initialDataChunk.buffer);\n\t\t}\n\t}\n\n\tprivate async _sendSocketToExtensionHost(extensionHostProcess: cp.ChildProcess, connectionData: ConnectionData): Promise<void> {\n\t\t// Make sure all outstanding writes have been drained before sending the socket\n\t\tawait connectionData.socketDrain();\n\t\tconst msg = connectionData.toIExtHostSocketMessage();\n\t\tlet socket: net.Socket;\n\t\tif (connectionData.socket instanceof NodeSocket) {\n\t\t\tsocket = connectionData.socket.socket;\n\t\t} else {\n\t\t\tsocket = connectionData.socket.socket.socket;\n\t\t}\n\t\textensionHostProcess.send(msg, socket);\n\t}\n\n\tpublic shortenReconnectionGraceTimeIfNecessary(): void {\n\t\tif (!this._extensionHostProcess) {\n\t\t\treturn;\n\t\t}\n\t\tconst msg: IExtHostReduceGraceTimeMessage = {\n\t\t\ttype: 'VSCODE_EXTHOST_IPC_REDUCE_GRACE_TIME'\n\t\t};\n\t\tthis._extensionHostProcess.send(msg);\n\t}\n\n\tpublic acceptReconnection(remoteAddress: string, _socket: NodeSocket | WebSocketNodeSocket, initialDataChunk: VSBuffer): void {\n\t\tthis._remoteAddress = remoteAddress;\n\t\tthis._log(`The client has reconnected.`);\n\t\tconst connectionData = new ConnectionData(_socket, initialDataChunk);\n\n\t\tif (!this._extensionHostProcess) {\n\t\t\t// The extension host didn't even start up yet\n\t\t\tthis._connectionData = connectionData;\n\t\t\treturn;\n\t\t}\n\n\t\tthis._sendSocketToExtensionHost(this._extensionHostProcess, connectionData);\n\t}\n\n\tprivate _cleanResources(): void {\n\t\tif (this._disposed) {\n\t\t\t// already called\n\t\t\treturn;\n\t\t}\n\t\tthis._disposed = true;\n\t\tif (this._connectionData) {\n\t\t\tthis._connectionData.socket.end();\n\t\t\tthis._connectionData = null;\n\t\t}\n\t\tif (this._extensionHostProcess) {\n\t\t\tthis._extensionHostProcess.kill();\n\t\t\tthis._extensionHostProcess = null;\n\t\t}\n\t\tthis._onClose.fire(undefined);\n\t}\n\n\tpublic async start(startParams: IRemoteExtensionHostStartParams): Promise<void> {\n\t\ttry {\n\t\t\tlet execArgv: string[] = process.execArgv ? process.execArgv.filter(a => !/^--inspect(-brk)?=/.test(a)) : [];\n\t\t\t// eslint-disable-next-line local/code-no-any-casts, @typescript-eslint/no-explicit-any\n\t\t\tif (startParams.port && !(<any>process).pkg) {\n\t\t\t\texecArgv = [\n\t\t\t\t\t`--inspect${startParams.break ? '-brk' : ''}=${startParams.port}`,\n\t\t\t\t\t'--experimental-network-inspection'\n\t\t\t\t];\n\t\t\t}\n\n\t\t\tconst env = await buildUserEnvironment(startParams.env, true, startParams.language, this._environmentService, this._logService, this._configurationService);\n\t\t\tremoveDangerousEnvVariables(env);\n\n\t\t\tlet extHostNamedPipeServer: net.Server | null;\n\n\t\t\tif (this._canSendSocket) {\n\t\t\t\twriteExtHostConnection(new SocketExtHostConnection(), env);\n\t\t\t\textHostNamedPipeServer = null;\n\t\t\t} else {\n\t\t\t\tconst { namedPipeServer, pipeName } = await this._listenOnPipe();\n\t\t\t\twriteExtHostConnection(new IPCExtHostConnection(pipeName), env);\n\t\t\t\textHostNamedPipeServer = namedPipeServer;\n\t\t\t}\n\n\t\t\tconst opts = {\n\t\t\t\tenv,\n\t\t\t\texecArgv,\n\t\t\t\tsilent: true\n\t\t\t};\n\n\t\t\t// Refs https://github.com/microsoft/vscode/issues/189805\n\t\t\topts.execArgv.unshift('--dns-result-order=ipv4first');\n\n\t\t\t// Run Extension Host as fork of current process\n\t\t\tconst args = ['--type=extensionHost', `--transformURIs`];\n\t\t\tconst useHostProxy = this._environmentService.args['use-host-proxy'];\n\t\t\targs.push(`--useHostProxy=${useHostProxy ? 'true' : 'false'}`);\n\t\t\tif (this._configurationService.getValue<boolean>('extensions.supportNodeGlobalNavigator')) {\n\t\t\t\targs.push('--supportGlobalNavigator');\n\t\t\t}\n\t\t\tthis._extensionHostProcess = cp.fork(FileAccess.asFileUri('bootstrap-fork').fsPath, args, opts);\n\t\t\tconst pid = this._extensionHostProcess.pid;\n\t\t\tthis._log(`<${pid}> Launched Extension Host Process.`);\n\n\t\t\t// Catch all output coming from the extension host process\n\t\t\tthis._extensionHostProcess.stdout!.setEncoding('utf8');\n\t\t\tthis._extensionHostProcess.stderr!.setEncoding('utf8');\n\t\t\tconst onStdout = Event.fromNodeEventEmitter<string>(this._extensionHostProcess.stdout!, 'data');\n\t\t\tconst onStderr = Event.fromNodeEventEmitter<string>(this._extensionHostProcess.stderr!, 'data');\n\t\t\tthis._register(onStdout((e) => this._log(`<${pid}> ${e}`)));\n\t\t\tthis._register(onStderr((e) => this._log(`<${pid}><stderr> ${e}`)));\n\n\t\t\t// Lifecycle\n\t\t\tthis._extensionHostProcess.on('error', (err) => {\n\t\t\t\tthis._logError(`<${pid}> Extension Host Process had an error`);\n\t\t\t\tthis._logService.error(err);\n\t\t\t\tthis._cleanResources();\n\t\t\t});\n\n\t\t\tthis._extensionHostProcess.on('exit', (code: number, signal: string) => {\n\t\t\t\tthis._extensionHostStatusService.setExitInfo(this._reconnectionToken, { code, signal });\n\t\t\t\tthis._log(`<${pid}> Extension Host Process exited with code: ${code}, signal: ${signal}.`);\n\t\t\t\tthis._cleanResources();\n\t\t\t});\n\n\t\t\tif (extHostNamedPipeServer) {\n\t\t\t\textHostNamedPipeServer.on('connection', (socket) => {\n\t\t\t\t\textHostNamedPipeServer.close();\n\t\t\t\t\tthis._pipeSockets(socket, this._connectionData!);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tconst messageListener = (msg: IExtHostReadyMessage) => {\n\t\t\t\t\tif (msg.type === 'VSCODE_EXTHOST_IPC_READY') {\n\t\t\t\t\t\tthis._extensionHostProcess!.removeListener('message', messageListener);\n\t\t\t\t\t\tthis._sendSocketToExtensionHost(this._extensionHostProcess!, this._connectionData!);\n\t\t\t\t\t\tthis._connectionData = null;\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tthis._extensionHostProcess.on('message', messageListener);\n\t\t\t}\n\n\t\t} catch (error) {\n\t\t\tconsole.error('ExtensionHostConnection errored');\n\t\t\tif (error) {\n\t\t\t\tconsole.error(error);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _listenOnPipe(): Promise<{ pipeName: string; namedPipeServer: net.Server }> {\n\t\treturn new Promise<{ pipeName: string; namedPipeServer: net.Server }>((resolve, reject) => {\n\t\t\tconst pipeName = createRandomIPCHandle();\n\n\t\t\tconst namedPipeServer = net.createServer();\n\t\t\tnamedPipeServer.on('error', reject);\n\t\t\tnamedPipeServer.listen(pipeName, () => {\n\t\t\t\tnamedPipeServer?.removeListener('error', reject);\n\t\t\t\tresolve({ pipeName, namedPipeServer });\n\t\t\t});\n\t\t});\n\t}\n}\n\nfunction readCaseInsensitive(env: { [key: string]: string | undefined }, key: string): string | undefined {\n\tconst pathKeys = Object.keys(env).filter(k => k.toLowerCase() === key.toLowerCase());\n\tconst pathKey = pathKeys.length > 0 ? pathKeys[0] : key;\n\treturn env[pathKey];\n}\n\nfunction setCaseInsensitive(env: { [key: string]: unknown }, key: string, value: string): void {\n\tconst pathKeys = Object.keys(env).filter(k => k.toLowerCase() === key.toLowerCase());\n\tconst pathKey = pathKeys.length > 0 ? pathKeys[0] : key;\n\tenv[pathKey] = value;\n}\n\nfunction removeNulls(env: { [key: string]: unknown | null }): void {\n\t// Don't delete while iterating the object itself\n\tfor (const key of Object.keys(env)) {\n\t\tif (env[key] === null) {\n\t\t\tdelete env[key];\n\t\t}\n\t}\n}\n"]}