{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/server/node/remoteExtensionHostAgentServer.ts","vs/server/node/remoteExtensionHostAgentServer.ts"],"names":[],"mappings":"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","file":"remoteExtensionHostAgentServer.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as fs from 'fs';\nimport type * as http from 'http';\nimport * as net from 'net';\nimport { createRequire } from 'node:module';\nimport { performance } from 'perf_hooks';\nimport * as url from 'url';\nimport { VSBuffer } from '../../base/common/buffer.js';\nimport { CharCode } from '../../base/common/charCode.js';\nimport { isSigPipeError, onUnexpectedError, setUnexpectedErrorHandler } from '../../base/common/errors.js';\nimport { isEqualOrParent } from '../../base/common/extpath.js';\nimport { Disposable, DisposableStore } from '../../base/common/lifecycle.js';\nimport { connectionTokenQueryName, FileAccess, getServerProductSegment, Schemas } from '../../base/common/network.js';\nimport { dirname, join } from '../../base/common/path.js';\nimport * as perf from '../../base/common/performance.js';\nimport * as platform from '../../base/common/platform.js';\nimport { createRegExp, escapeRegExpCharacters } from '../../base/common/strings.js';\nimport { URI } from '../../base/common/uri.js';\nimport { generateUuid } from '../../base/common/uuid.js';\nimport { getOSReleaseInfo } from '../../base/node/osReleaseInfo.js';\nimport { findFreePort } from '../../base/node/ports.js';\nimport { addUNCHostToAllowlist, disableUNCAccessRestrictions } from '../../base/node/unc.js';\nimport { PersistentProtocol } from '../../base/parts/ipc/common/ipc.net.js';\nimport { NodeSocket, upgradeToISocket, WebSocketNodeSocket } from '../../base/parts/ipc/node/ipc.net.js';\nimport { IConfigurationService } from '../../platform/configuration/common/configuration.js';\nimport { IInstantiationService } from '../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../platform/log/common/log.js';\nimport { IProductService } from '../../platform/product/common/productService.js';\nimport { ConnectionType, ConnectionTypeRequest, ErrorMessage, HandshakeMessage, IRemoteExtensionHostStartParams, ITunnelConnectionStartParams, SignRequest } from '../../platform/remote/common/remoteAgentConnection.js';\nimport { RemoteAgentConnectionContext } from '../../platform/remote/common/remoteAgentEnvironment.js';\nimport { ITelemetryService } from '../../platform/telemetry/common/telemetry.js';\nimport { ExtensionHostConnection } from './extensionHostConnection.js';\nimport { ManagementConnection } from './remoteExtensionManagement.js';\nimport { determineServerConnectionToken, requestHasValidConnectionToken as httpRequestHasValidConnectionToken, ServerConnectionToken, ServerConnectionTokenParseError, ServerConnectionTokenType } from './serverConnectionToken.js';\nimport { IServerEnvironmentService, ServerParsedArgs } from './serverEnvironmentService.js';\nimport { setupServerServices, SocketServer } from './serverServices.js';\nimport { CacheControl, serveError, serveFile, WebClientServer } from './webClientServer.js';\nconst require = createRequire(import.meta.url);\n\nconst SHUTDOWN_TIMEOUT = 5 * 60 * 1000;\n\ndeclare module vsda {\n\t// the signer is a native module that for historical reasons uses a lower case class name\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\texport class signer {\n\t\tsign(arg: string): string;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\texport class validator {\n\t\tcreateNewMessage(arg: string): string;\n\t\tvalidate(arg: string): 'ok' | 'error';\n\t}\n}\n\nclass RemoteExtensionHostAgentServer extends Disposable implements IServerAPI {\n\n\tprivate readonly _extHostConnections: { [reconnectionToken: string]: ExtensionHostConnection };\n\tprivate readonly _managementConnections: { [reconnectionToken: string]: ManagementConnection };\n\tprivate readonly _allReconnectionTokens: Set<string>;\n\tprivate readonly _webClientServer: WebClientServer | null;\n\tprivate readonly _webEndpointOriginChecker: WebEndpointOriginChecker;\n\tprivate readonly _reconnectionGraceTime: number;\n\n\tprivate readonly _serverBasePath: string | undefined;\n\tprivate readonly _serverProductPath: string;\n\n\tprivate shutdownTimer: Timeout | undefined;\n\n\tconstructor(\n\t\tprivate readonly _socketServer: SocketServer<RemoteAgentConnectionContext>,\n\t\tprivate readonly _connectionToken: ServerConnectionToken,\n\t\tprivate readonly _vsdaMod: typeof vsda | null,\n\t\thasWebClient: boolean,\n\t\tserverBasePath: string | undefined,\n\t\t@IServerEnvironmentService private readonly _environmentService: IServerEnvironmentService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\t\tthis._webEndpointOriginChecker = WebEndpointOriginChecker.create(this._productService);\n\n\t\tif (serverBasePath !== undefined && serverBasePath.charCodeAt(serverBasePath.length - 1) === CharCode.Slash) {\n\t\t\t// Remove trailing slash from base path\n\t\t\tserverBasePath = serverBasePath.substring(0, serverBasePath.length - 1);\n\t\t}\n\t\tthis._serverBasePath = serverBasePath; // undefined or starts with a slash\n\t\tthis._serverProductPath = `/${getServerProductSegment(_productService)}`; // starts with a slash\n\t\tthis._extHostConnections = Object.create(null);\n\t\tthis._managementConnections = Object.create(null);\n\t\tthis._allReconnectionTokens = new Set<string>();\n\t\tthis._webClientServer = (\n\t\t\thasWebClient\n\t\t\t\t? this._instantiationService.createInstance(WebClientServer, this._connectionToken, serverBasePath ?? '/', this._serverProductPath)\n\t\t\t\t: null\n\t\t);\n\t\tthis._logService.info(`Extension host agent started.`);\n\t\tthis._reconnectionGraceTime = this._environmentService.reconnectionGraceTime;\n\n\t\tthis._waitThenShutdown(true);\n\t}\n\n\tpublic async handleRequest(req: http.IncomingMessage, res: http.ServerResponse): Promise<void> {\n\t\t// Only serve GET requests\n\t\tif (req.method !== 'GET') {\n\t\t\treturn serveError(req, res, 405, `Unsupported method ${req.method}`);\n\t\t}\n\n\t\tif (!req.url) {\n\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t}\n\n\t\tconst parsedUrl = url.parse(req.url, true);\n\t\tlet pathname = parsedUrl.pathname;\n\n\t\tif (!pathname) {\n\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t}\n\n\t\t// Serve from both '/' and serverBasePath\n\t\tif (this._serverBasePath !== undefined && pathname.startsWith(this._serverBasePath)) {\n\t\t\tpathname = pathname.substring(this._serverBasePath.length) || '/';\n\t\t}\n\t\t// for now accept all paths, with or without server product path\n\t\tif (pathname.startsWith(this._serverProductPath) && pathname.charCodeAt(this._serverProductPath.length) === CharCode.Slash) {\n\t\t\tpathname = pathname.substring(this._serverProductPath.length);\n\t\t}\n\n\t\t// Version\n\t\tif (pathname === '/version') {\n\t\t\tres.writeHead(200, { 'Content-Type': 'text/plain' });\n\t\t\treturn void res.end(this._productService.commit || '');\n\t\t}\n\n\t\t// Delay shutdown\n\t\tif (pathname === '/delay-shutdown') {\n\t\t\tthis._delayShutdown();\n\t\t\tres.writeHead(200);\n\t\t\treturn void res.end('OK');\n\t\t}\n\n\t\tif (!httpRequestHasValidConnectionToken(this._connectionToken, req, parsedUrl)) {\n\t\t\t// invalid connection token\n\t\t\treturn serveError(req, res, 403, `Forbidden.`);\n\t\t}\n\n\t\tif (pathname === '/vscode-remote-resource') {\n\t\t\t// Handle HTTP requests for resources rendered in the rich client (images, fonts, etc.)\n\t\t\t// These resources could be files shipped with extensions or even workspace files.\n\t\t\tconst desiredPath = parsedUrl.query['path'];\n\t\t\tif (typeof desiredPath !== 'string') {\n\t\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t\t}\n\n\t\t\tlet filePath: string;\n\t\t\ttry {\n\t\t\t\tfilePath = URI.from({ scheme: Schemas.file, path: desiredPath }).fsPath;\n\t\t\t} catch (err) {\n\t\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t\t}\n\n\t\t\tconst responseHeaders: Record<string, string> = Object.create(null);\n\t\t\tif (this._environmentService.isBuilt) {\n\t\t\t\tif (isEqualOrParent(filePath, this._environmentService.builtinExtensionsPath, !platform.isLinux)\n\t\t\t\t\t|| isEqualOrParent(filePath, this._environmentService.extensionsPath, !platform.isLinux)\n\t\t\t\t) {\n\t\t\t\t\tresponseHeaders['Cache-Control'] = 'public, max-age=31536000';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Allow cross origin requests from the web worker extension host\n\t\t\tresponseHeaders['Vary'] = 'Origin';\n\t\t\tconst requestOrigin = req.headers['origin'];\n\t\t\tif (requestOrigin && this._webEndpointOriginChecker.matches(requestOrigin)) {\n\t\t\t\tresponseHeaders['Access-Control-Allow-Origin'] = requestOrigin;\n\t\t\t}\n\t\t\treturn serveFile(filePath, CacheControl.ETAG, this._logService, req, res, responseHeaders);\n\t\t}\n\n\t\t// workbench web UI\n\t\tif (this._webClientServer) {\n\t\t\tthis._webClientServer.handle(req, res, parsedUrl, pathname);\n\t\t\treturn;\n\t\t}\n\n\t\tres.writeHead(404, { 'Content-Type': 'text/plain' });\n\t\treturn void res.end('Not found');\n\t}\n\n\tpublic handleUpgrade(req: http.IncomingMessage, socket: net.Socket) {\n\t\tlet reconnectionToken = generateUuid();\n\t\tlet isReconnection = false;\n\t\tlet skipWebSocketFrames = false;\n\n\t\tif (req.url) {\n\t\t\tconst query = url.parse(req.url, true).query;\n\t\t\tif (typeof query.reconnectionToken === 'string') {\n\t\t\t\treconnectionToken = query.reconnectionToken;\n\t\t\t}\n\t\t\tif (query.reconnection === 'true') {\n\t\t\t\tisReconnection = true;\n\t\t\t}\n\t\t\tif (query.skipWebSocketFrames === 'true') {\n\t\t\t\tskipWebSocketFrames = true;\n\t\t\t}\n\t\t}\n\n\t\tconst upgraded = upgradeToISocket(req, socket, {\n\t\t\tdebugLabel: `server-connection-${reconnectionToken}`,\n\t\t\tskipWebSocketFrames,\n\t\t\tdisableWebSocketCompression: this._environmentService.args['disable-websocket-compression']\n\t\t});\n\n\t\tif (!upgraded) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._handleWebSocketConnection(upgraded, isReconnection, reconnectionToken);\n\t}\n\n\tpublic handleServerError(err: Error): void {\n\t\tthis._logService.error(`Error occurred in server`);\n\t\tthis._logService.error(err);\n\t}\n\n\t// Eventually cleanup\n\n\tprivate _getRemoteAddress(socket: NodeSocket | WebSocketNodeSocket): string {\n\t\tlet _socket: net.Socket;\n\t\tif (socket instanceof NodeSocket) {\n\t\t\t_socket = socket.socket;\n\t\t} else {\n\t\t\t_socket = socket.socket.socket;\n\t\t}\n\t\treturn _socket.remoteAddress || `<unknown>`;\n\t}\n\n\tprivate async _rejectWebSocketConnection(logPrefix: string, protocol: PersistentProtocol, reason: string): Promise<void> {\n\t\tconst socket = protocol.getSocket();\n\t\tthis._logService.error(`${logPrefix} ${reason}.`);\n\t\tconst errMessage: ErrorMessage = {\n\t\t\ttype: 'error',\n\t\t\treason: reason\n\t\t};\n\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify(errMessage)));\n\t\tprotocol.dispose();\n\t\tawait socket.drain();\n\t\tsocket.dispose();\n\t}\n\n\t/**\n\t * NOTE: Avoid using await in this method!\n\t * The problem is that await introduces a process.nextTick due to the implicit Promise.then\n\t * This can lead to some bytes being received and interpreted and a control message being emitted before the next listener has a chance to be registered.\n\t */\n\tprivate _handleWebSocketConnection(socket: NodeSocket | WebSocketNodeSocket, isReconnection: boolean, reconnectionToken: string): void {\n\t\tconst remoteAddress = this._getRemoteAddress(socket);\n\t\tconst logPrefix = `[${remoteAddress}][${reconnectionToken.substr(0, 8)}]`;\n\t\tconst protocol = new PersistentProtocol({ socket });\n\n\t\tconst validator = this._vsdaMod ? new this._vsdaMod.validator() : null;\n\t\tconst signer = this._vsdaMod ? new this._vsdaMod.signer() : null;\n\n\t\tconst enum State {\n\t\t\tWaitingForAuth,\n\t\t\tWaitingForConnectionType,\n\t\t\tDone,\n\t\t\tError\n\t\t}\n\t\tlet state = State.WaitingForAuth;\n\n\t\tconst rejectWebSocketConnection = (msg: string) => {\n\t\t\tstate = State.Error;\n\t\t\tlistener.dispose();\n\t\t\tthis._rejectWebSocketConnection(logPrefix, protocol, msg);\n\t\t};\n\n\t\tconst listener = protocol.onControlMessage((raw) => {\n\t\t\tif (state === State.WaitingForAuth) {\n\t\t\t\tlet msg1: HandshakeMessage;\n\t\t\t\ttry {\n\t\t\t\t\tmsg1 = <HandshakeMessage>JSON.parse(raw.toString());\n\t\t\t\t} catch (err) {\n\t\t\t\t\treturn rejectWebSocketConnection(`Malformed first message`);\n\t\t\t\t}\n\t\t\t\tif (msg1.type !== 'auth') {\n\t\t\t\t\treturn rejectWebSocketConnection(`Invalid first message`);\n\t\t\t\t}\n\n\t\t\t\tif (this._connectionToken.type === ServerConnectionTokenType.Mandatory && !this._connectionToken.validate(msg1.auth)) {\n\t\t\t\t\treturn rejectWebSocketConnection(`Unauthorized client refused: auth mismatch`);\n\t\t\t\t}\n\n\t\t\t\t// Send `sign` request\n\t\t\t\tlet signedData = generateUuid();\n\t\t\t\tif (signer) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tsignedData = signer.sign(msg1.data);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet someText = generateUuid();\n\t\t\t\tif (validator) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tsomeText = validator.createNewMessage(someText);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tconst signRequest: SignRequest = {\n\t\t\t\t\ttype: 'sign',\n\t\t\t\t\tdata: someText,\n\t\t\t\t\tsignedData: signedData\n\t\t\t\t};\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify(signRequest)));\n\n\t\t\t\tstate = State.WaitingForConnectionType;\n\n\t\t\t} else if (state === State.WaitingForConnectionType) {\n\n\t\t\t\tlet msg2: HandshakeMessage;\n\t\t\t\ttry {\n\t\t\t\t\tmsg2 = <HandshakeMessage>JSON.parse(raw.toString());\n\t\t\t\t} catch (err) {\n\t\t\t\t\treturn rejectWebSocketConnection(`Malformed second message`);\n\t\t\t\t}\n\t\t\t\tif (msg2.type !== 'connectionType') {\n\t\t\t\t\treturn rejectWebSocketConnection(`Invalid second message`);\n\t\t\t\t}\n\t\t\t\tif (typeof msg2.signedData !== 'string') {\n\t\t\t\t\treturn rejectWebSocketConnection(`Invalid second message field type`);\n\t\t\t\t}\n\n\t\t\t\tconst rendererCommit = msg2.commit;\n\t\t\t\tconst myCommit = this._productService.commit;\n\t\t\t\tif (rendererCommit && myCommit) {\n\t\t\t\t\t// Running in the built version where commits are defined\n\t\t\t\t\tif (rendererCommit !== myCommit) {\n\t\t\t\t\t\treturn rejectWebSocketConnection(`Client refused: version mismatch`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlet valid = false;\n\t\t\t\tif (!validator) {\n\t\t\t\t\tvalid = true;\n\t\t\t\t} else if (this._connectionToken.validate(msg2.signedData)) {\n\t\t\t\t\t// web client\n\t\t\t\t\tvalid = true;\n\t\t\t\t} else {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tvalid = validator.validate(msg2.signedData) === 'ok';\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!valid) {\n\t\t\t\t\tif (this._environmentService.isBuilt) {\n\t\t\t\t\t\treturn rejectWebSocketConnection(`Unauthorized client refused`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._logService.error(`${logPrefix} Unauthorized client handshake failed but we proceed because of dev mode.`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// We have received a new connection.\n\t\t\t\t// This indicates that the server owner has connectivity.\n\t\t\t\t// Therefore we will shorten the reconnection grace period for disconnected connections!\n\t\t\t\tfor (const key in this._managementConnections) {\n\t\t\t\t\tconst managementConnection = this._managementConnections[key];\n\t\t\t\t\tmanagementConnection.shortenReconnectionGraceTimeIfNecessary();\n\t\t\t\t}\n\t\t\t\tfor (const key in this._extHostConnections) {\n\t\t\t\t\tconst extHostConnection = this._extHostConnections[key];\n\t\t\t\t\textHostConnection.shortenReconnectionGraceTimeIfNecessary();\n\t\t\t\t}\n\n\t\t\t\tstate = State.Done;\n\t\t\t\tlistener.dispose();\n\t\t\t\tthis._handleConnectionType(remoteAddress, logPrefix, protocol, socket, isReconnection, reconnectionToken, msg2);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate async _handleConnectionType(remoteAddress: string, _logPrefix: string, protocol: PersistentProtocol, socket: NodeSocket | WebSocketNodeSocket, isReconnection: boolean, reconnectionToken: string, msg: ConnectionTypeRequest): Promise<void> {\n\t\tconst logPrefix = (\n\t\t\tmsg.desiredConnectionType === ConnectionType.Management\n\t\t\t\t? `${_logPrefix}[ManagementConnection]`\n\t\t\t\t: msg.desiredConnectionType === ConnectionType.ExtensionHost\n\t\t\t\t\t? `${_logPrefix}[ExtensionHostConnection]`\n\t\t\t\t\t: _logPrefix\n\t\t);\n\n\t\tif (msg.desiredConnectionType === ConnectionType.Management) {\n\t\t\t// This should become a management connection\n\n\t\t\tif (isReconnection) {\n\t\t\t\t// This is a reconnection\n\t\t\t\tif (!this._managementConnections[reconnectionToken]) {\n\t\t\t\t\tif (!this._allReconnectionTokens.has(reconnectionToken)) {\n\t\t\t\t\t\t// This is an unknown reconnection token\n\t\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown reconnection token (never seen)`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// This is a connection that was seen in the past, but is no longer valid\n\t\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown reconnection token (seen before)`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify({ type: 'ok' })));\n\t\t\t\tconst dataChunk = protocol.readEntireBuffer();\n\t\t\t\tprotocol.dispose();\n\t\t\t\tthis._managementConnections[reconnectionToken].acceptReconnection(remoteAddress, socket, dataChunk);\n\n\t\t\t} else {\n\t\t\t\t// This is a fresh connection\n\t\t\t\tif (this._managementConnections[reconnectionToken]) {\n\t\t\t\t\t// Cannot have two concurrent connections using the same reconnection token\n\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Duplicate reconnection token`);\n\t\t\t\t}\n\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify({ type: 'ok' })));\n\t\t\t\tconst con = new ManagementConnection(this._logService, reconnectionToken, remoteAddress, protocol, this._reconnectionGraceTime);\n\t\t\t\tthis._socketServer.acceptConnection(con.protocol, con.onClose);\n\t\t\t\tthis._managementConnections[reconnectionToken] = con;\n\t\t\t\tthis._allReconnectionTokens.add(reconnectionToken);\n\t\t\t\tcon.onClose(() => {\n\t\t\t\t\tdelete this._managementConnections[reconnectionToken];\n\t\t\t\t});\n\n\t\t\t}\n\n\t\t} else if (msg.desiredConnectionType === ConnectionType.ExtensionHost) {\n\n\t\t\t// This should become an extension host connection\n\t\t\tconst startParams0 = <IRemoteExtensionHostStartParams>msg.args || { language: 'en' };\n\t\t\tconst startParams = await this._updateWithFreeDebugPort(startParams0);\n\n\t\t\tif (startParams.port) {\n\t\t\t\tthis._logService.trace(`${logPrefix} - startParams debug port ${startParams.port}`);\n\t\t\t}\n\t\t\tthis._logService.trace(`${logPrefix} - startParams language: ${startParams.language}`);\n\t\t\tthis._logService.trace(`${logPrefix} - startParams env: ${JSON.stringify(startParams.env)}`);\n\n\t\t\tif (isReconnection) {\n\t\t\t\t// This is a reconnection\n\t\t\t\tif (!this._extHostConnections[reconnectionToken]) {\n\t\t\t\t\tif (!this._allReconnectionTokens.has(reconnectionToken)) {\n\t\t\t\t\t\t// This is an unknown reconnection token\n\t\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown reconnection token (never seen)`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// This is a connection that was seen in the past, but is no longer valid\n\t\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown reconnection token (seen before)`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tprotocol.sendPause();\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify(startParams.port ? { debugPort: startParams.port } : {})));\n\t\t\t\tconst dataChunk = protocol.readEntireBuffer();\n\t\t\t\tprotocol.dispose();\n\t\t\t\tthis._extHostConnections[reconnectionToken].acceptReconnection(remoteAddress, socket, dataChunk);\n\n\t\t\t} else {\n\t\t\t\t// This is a fresh connection\n\t\t\t\tif (this._extHostConnections[reconnectionToken]) {\n\t\t\t\t\t// Cannot have two concurrent connections using the same reconnection token\n\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Duplicate reconnection token`);\n\t\t\t\t}\n\n\t\t\t\tprotocol.sendPause();\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify(startParams.port ? { debugPort: startParams.port } : {})));\n\t\t\t\tconst dataChunk = protocol.readEntireBuffer();\n\t\t\t\tprotocol.dispose();\n\t\t\t\tconst con = this._instantiationService.createInstance(ExtensionHostConnection, reconnectionToken, remoteAddress, socket, dataChunk);\n\t\t\t\tthis._extHostConnections[reconnectionToken] = con;\n\t\t\t\tthis._allReconnectionTokens.add(reconnectionToken);\n\t\t\t\tcon.onClose(() => {\n\t\t\t\t\tcon.dispose();\n\t\t\t\t\tdelete this._extHostConnections[reconnectionToken];\n\t\t\t\t\tthis._onDidCloseExtHostConnection();\n\t\t\t\t});\n\t\t\t\tcon.start(startParams);\n\t\t\t}\n\n\t\t} else if (msg.desiredConnectionType === ConnectionType.Tunnel) {\n\n\t\t\tconst tunnelStartParams = <ITunnelConnectionStartParams>msg.args;\n\t\t\tthis._createTunnel(protocol, tunnelStartParams);\n\n\t\t} else {\n\n\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown initial data received`);\n\n\t\t}\n\t}\n\n\tprivate async _createTunnel(protocol: PersistentProtocol, tunnelStartParams: ITunnelConnectionStartParams): Promise<void> {\n\t\tconst remoteSocket = (<NodeSocket>protocol.getSocket()).socket;\n\t\tconst dataChunk = protocol.readEntireBuffer();\n\t\tprotocol.dispose();\n\n\t\tremoteSocket.pause();\n\t\tconst localSocket = await this._connectTunnelSocket(tunnelStartParams.host, tunnelStartParams.port);\n\n\t\tif (dataChunk.byteLength > 0) {\n\t\t\tlocalSocket.write(dataChunk.buffer);\n\t\t}\n\n\t\tlocalSocket.on('end', () => remoteSocket.end());\n\t\tlocalSocket.on('close', () => remoteSocket.end());\n\t\tlocalSocket.on('error', () => remoteSocket.destroy());\n\t\tremoteSocket.on('end', () => localSocket.end());\n\t\tremoteSocket.on('close', () => localSocket.end());\n\t\tremoteSocket.on('error', () => localSocket.destroy());\n\n\t\tlocalSocket.pipe(remoteSocket);\n\t\tremoteSocket.pipe(localSocket);\n\t}\n\n\tprivate _connectTunnelSocket(host: string, port: number): Promise<net.Socket> {\n\t\treturn new Promise<net.Socket>((c, e) => {\n\t\t\tconst socket = net.createConnection(\n\t\t\t\t{\n\t\t\t\t\thost: host,\n\t\t\t\t\tport: port,\n\t\t\t\t\tautoSelectFamily: true\n\t\t\t\t}, () => {\n\t\t\t\t\tsocket.removeListener('error', e);\n\t\t\t\t\tsocket.pause();\n\t\t\t\t\tc(socket);\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tsocket.once('error', e);\n\t\t});\n\t}\n\n\tprivate _updateWithFreeDebugPort(startParams: IRemoteExtensionHostStartParams): Thenable<IRemoteExtensionHostStartParams> {\n\t\tif (typeof startParams.port === 'number') {\n\t\t\treturn findFreePort(startParams.port, 10 /* try 10 ports */, 5000 /* try up to 5 seconds */).then(freePort => {\n\t\t\t\tstartParams.port = freePort;\n\t\t\t\treturn startParams;\n\t\t\t});\n\t\t}\n\t\t// No port clear debug configuration.\n\t\tstartParams.debugId = undefined;\n\t\tstartParams.port = undefined;\n\t\tstartParams.break = undefined;\n\t\treturn Promise.resolve(startParams);\n\t}\n\n\tprivate async _onDidCloseExtHostConnection(): Promise<void> {\n\t\tif (!this._environmentService.args['enable-remote-auto-shutdown']) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._cancelShutdown();\n\n\t\tconst hasActiveExtHosts = !!Object.keys(this._extHostConnections).length;\n\t\tif (!hasActiveExtHosts) {\n\t\t\tconsole.log('Last EH closed, waiting before shutting down');\n\t\t\tthis._logService.info('Last EH closed, waiting before shutting down');\n\t\t\tthis._waitThenShutdown();\n\t\t}\n\t}\n\n\tprivate _waitThenShutdown(initial = false): void {\n\t\tif (!this._environmentService.args['enable-remote-auto-shutdown']) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._environmentService.args['remote-auto-shutdown-without-delay'] && !initial) {\n\t\t\tthis._shutdown();\n\t\t} else {\n\t\t\tthis.shutdownTimer = setTimeout(() => {\n\t\t\t\tthis.shutdownTimer = undefined;\n\n\t\t\t\tthis._shutdown();\n\t\t\t}, SHUTDOWN_TIMEOUT);\n\t\t}\n\t}\n\n\tprivate _shutdown(): void {\n\t\tconst hasActiveExtHosts = !!Object.keys(this._extHostConnections).length;\n\t\tif (hasActiveExtHosts) {\n\t\t\tconsole.log('New EH opened, aborting shutdown');\n\t\t\tthis._logService.info('New EH opened, aborting shutdown');\n\t\t\treturn;\n\t\t} else {\n\t\t\tconsole.log('Last EH closed, shutting down');\n\t\t\tthis._logService.info('Last EH closed, shutting down');\n\t\t\tthis.dispose();\n\t\t\tprocess.exit(0);\n\t\t}\n\t}\n\n\t/**\n\t * If the server is in a shutdown timeout, cancel it and start over\n\t */\n\tprivate _delayShutdown(): void {\n\t\tif (this.shutdownTimer) {\n\t\t\tconsole.log('Got delay-shutdown request while in shutdown timeout, delaying');\n\t\t\tthis._logService.info('Got delay-shutdown request while in shutdown timeout, delaying');\n\t\t\tthis._cancelShutdown();\n\t\t\tthis._waitThenShutdown();\n\t\t}\n\t}\n\n\tprivate _cancelShutdown(): void {\n\t\tif (this.shutdownTimer) {\n\t\t\tconsole.log('Cancelling previous shutdown timeout');\n\t\t\tthis._logService.info('Cancelling previous shutdown timeout');\n\t\t\tclearTimeout(this.shutdownTimer);\n\t\t\tthis.shutdownTimer = undefined;\n\t\t}\n\t}\n}\n\nexport interface IServerAPI {\n\t/**\n\t * Do not remove!!. Called from server-main.js\n\t */\n\thandleRequest(req: http.IncomingMessage, res: http.ServerResponse): Promise<void>;\n\t/**\n\t * Do not remove!!. Called from server-main.js\n\t */\n\thandleUpgrade(req: http.IncomingMessage, socket: net.Socket): void;\n\t/**\n\t * Do not remove!!. Called from server-main.js\n\t */\n\thandleServerError(err: Error): void;\n\t/**\n\t * Do not remove!!. Called from server-main.js\n\t */\n\tdispose(): void;\n}\n\nexport async function createServer(address: string | net.AddressInfo | null, args: ServerParsedArgs, REMOTE_DATA_FOLDER: string): Promise<IServerAPI> {\n\n\tconst connectionToken = await determineServerConnectionToken(args);\n\tif (connectionToken instanceof ServerConnectionTokenParseError) {\n\t\tconsole.warn(connectionToken.message);\n\t\tprocess.exit(1);\n\t}\n\n\t// setting up error handlers, first with console.error, then, once available, using the log service\n\n\tfunction initUnexpectedErrorHandler(handler: (err: any) => void) {\n\t\tsetUnexpectedErrorHandler(err => {\n\t\t\t// See https://github.com/microsoft/vscode-remote-release/issues/6481\n\t\t\t// In some circumstances, console.error will throw an asynchronous error. This asynchronous error\n\t\t\t// will end up here, and then it will be logged again, thus creating an endless asynchronous loop.\n\t\t\t// Here we try to break the loop by ignoring EPIPE errors that include our own unexpected error handler in the stack.\n\t\t\tif (isSigPipeError(err) && err.stack && /unexpectedErrorHandler/.test(err.stack)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\thandler(err);\n\t\t});\n\t}\n\n\tconst unloggedErrors: any[] = [];\n\tinitUnexpectedErrorHandler((error: any) => {\n\t\tunloggedErrors.push(error);\n\t\tconsole.error(error);\n\t});\n\tlet didLogAboutSIGPIPE = false;\n\tprocess.on('SIGPIPE', () => {\n\t\t// See https://github.com/microsoft/vscode-remote-release/issues/6543\n\t\t// We would normally install a SIGPIPE listener in bootstrap-node.js\n\t\t// But in certain situations, the console itself can be in a broken pipe state\n\t\t// so logging SIGPIPE to the console will cause an infinite async loop\n\t\tif (!didLogAboutSIGPIPE) {\n\t\t\tdidLogAboutSIGPIPE = true;\n\t\t\tonUnexpectedError(new Error(`Unexpected SIGPIPE`));\n\t\t}\n\t});\n\n\tconst disposables = new DisposableStore();\n\tconst { socketServer, instantiationService } = await setupServerServices(connectionToken, args, REMOTE_DATA_FOLDER, disposables);\n\n\t// Set the unexpected error handler after the services have been initialized, to avoid having\n\t// the telemetry service overwrite our handler\n\tinstantiationService.invokeFunction((accessor) => {\n\t\tconst logService = accessor.get(ILogService);\n\t\tunloggedErrors.forEach(error => logService.error(error));\n\t\tunloggedErrors.length = 0;\n\n\t\tinitUnexpectedErrorHandler((error: any) => logService.error(error));\n\t});\n\n\t// On Windows, configure the UNC allow list based on settings\n\tinstantiationService.invokeFunction((accessor) => {\n\t\tconst configurationService = accessor.get(IConfigurationService);\n\n\t\tif (platform.isWindows) {\n\t\t\tif (configurationService.getValue('security.restrictUNCAccess') === false) {\n\t\t\t\tdisableUNCAccessRestrictions();\n\t\t\t} else {\n\t\t\t\taddUNCHostToAllowlist(configurationService.getValue('security.allowedUNCHosts'));\n\t\t\t}\n\t\t}\n\t});\n\n\t//\n\t// On Windows, exit early with warning message to users about potential security issue\n\t// if there is node_modules folder under home drive or Users folder.\n\t//\n\tinstantiationService.invokeFunction((accessor) => {\n\t\tconst logService = accessor.get(ILogService);\n\n\t\tif (platform.isWindows && process.env.HOMEDRIVE && process.env.HOMEPATH) {\n\t\t\tconst homeDirModulesPath = join(process.env.HOMEDRIVE, 'node_modules');\n\t\t\tconst userDir = dirname(join(process.env.HOMEDRIVE, process.env.HOMEPATH));\n\t\t\tconst userDirModulesPath = join(userDir, 'node_modules');\n\t\t\tif (fs.existsSync(homeDirModulesPath) || fs.existsSync(userDirModulesPath)) {\n\t\t\t\tconst message = `\n\n*\n* !!!! Server terminated due to presence of CVE-2020-1416 !!!!\n*\n* Please remove the following directories and re-try\n* ${homeDirModulesPath}\n* ${userDirModulesPath}\n*\n* For more information on the vulnerability https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1416\n*\n\n`;\n\t\t\t\tlogService.warn(message);\n\t\t\t\tconsole.warn(message);\n\t\t\t\tprocess.exit(0);\n\t\t\t}\n\t\t}\n\t});\n\n\tconst vsdaMod = instantiationService.invokeFunction((accessor) => {\n\t\tconst logService = accessor.get(ILogService);\n\t\tconst hasVSDA = fs.existsSync(join(FileAccess.asFileUri('').fsPath, '../node_modules/vsda'));\n\t\tif (hasVSDA) {\n\t\t\ttry {\n\t\t\t\treturn require('vsda');\n\t\t\t} catch (err) {\n\t\t\t\tlogService.error(err);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t});\n\n\tlet serverBasePath = args['server-base-path'];\n\tif (serverBasePath && !serverBasePath.startsWith('/')) {\n\t\tserverBasePath = `/${serverBasePath}`;\n\t}\n\n\tconst hasWebClient = fs.existsSync(FileAccess.asFileUri(`vs/code/browser/workbench/workbench.html`).fsPath);\n\n\tif (hasWebClient && address && typeof address !== 'string') {\n\t\t// ships the web ui!\n\t\tconst queryPart = (connectionToken.type !== ServerConnectionTokenType.None ? `?${connectionTokenQueryName}=${connectionToken.value}` : '');\n\t\tconsole.log(`Web UI available at http://localhost${address.port === 80 ? '' : `:${address.port}`}${serverBasePath ?? ''}${queryPart}`);\n\t}\n\n\tconst remoteExtensionHostAgentServer = instantiationService.createInstance(RemoteExtensionHostAgentServer, socketServer, connectionToken, vsdaMod, hasWebClient, serverBasePath);\n\n\tperf.mark('code/server/ready');\n\tconst currentTime = performance.now();\n\t// eslint-disable-next-line local/code-no-any-casts\n\tconst vscodeServerStartTime: number = (<any>global).vscodeServerStartTime;\n\t// eslint-disable-next-line local/code-no-any-casts\n\tconst vscodeServerListenTime: number = (<any>global).vscodeServerListenTime;\n\t// eslint-disable-next-line local/code-no-any-casts\n\tconst vscodeServerCodeLoadedTime: number = (<any>global).vscodeServerCodeLoadedTime;\n\n\tinstantiationService.invokeFunction(async (accessor) => {\n\t\tconst telemetryService = accessor.get(ITelemetryService);\n\n\t\ttype ServerStartClassification = {\n\t\t\towner: 'alexdima';\n\t\t\tcomment: 'The server has started up';\n\t\t\tstartTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time the server started at.' };\n\t\t\tstartedTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time the server began listening for connections.' };\n\t\t\tcodeLoadedTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time which the code loaded on the server' };\n\t\t\treadyTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time when the server was completely ready' };\n\t\t};\n\t\ttype ServerStartEvent = {\n\t\t\tstartTime: number;\n\t\t\tstartedTime: number;\n\t\t\tcodeLoadedTime: number;\n\t\t\treadyTime: number;\n\t\t};\n\t\ttelemetryService.publicLog2<ServerStartEvent, ServerStartClassification>('serverStart', {\n\t\t\tstartTime: vscodeServerStartTime,\n\t\t\tstartedTime: vscodeServerListenTime,\n\t\t\tcodeLoadedTime: vscodeServerCodeLoadedTime,\n\t\t\treadyTime: currentTime\n\t\t});\n\n\t\tif (platform.isLinux) {\n\t\t\tconst logService = accessor.get(ILogService);\n\t\t\tconst releaseInfo = await getOSReleaseInfo(logService.error.bind(logService));\n\t\t\tif (releaseInfo) {\n\t\t\t\ttype ServerPlatformInfoClassification = {\n\t\t\t\t\tplatformId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'A string identifying the operating system without any version information.' };\n\t\t\t\t\tplatformVersionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'A string identifying the operating system version excluding any name information or release code.' };\n\t\t\t\t\tplatformIdLike: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'A string identifying the operating system the current OS derivate is closely related to.' };\n\t\t\t\t\towner: 'deepak1556';\n\t\t\t\t\tcomment: 'Provides insight into the distro information on Linux.';\n\t\t\t\t};\n\t\t\t\ttype ServerPlatformInfoEvent = {\n\t\t\t\t\tplatformId: string;\n\t\t\t\t\tplatformVersionId: string | undefined;\n\t\t\t\t\tplatformIdLike: string | undefined;\n\t\t\t\t};\n\t\t\t\ttelemetryService.publicLog2<ServerPlatformInfoEvent, ServerPlatformInfoClassification>('serverPlatformInfo', {\n\t\t\t\t\tplatformId: releaseInfo.id,\n\t\t\t\t\tplatformVersionId: releaseInfo.version_id,\n\t\t\t\t\tplatformIdLike: releaseInfo.id_like\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t});\n\n\tif (args['print-startup-performance']) {\n\t\tlet output = '';\n\t\toutput += `Start-up time: ${vscodeServerListenTime - vscodeServerStartTime}\\n`;\n\t\toutput += `Code loading time: ${vscodeServerCodeLoadedTime - vscodeServerStartTime}\\n`;\n\t\toutput += `Initialized time: ${currentTime - vscodeServerStartTime}\\n`;\n\t\toutput += `\\n`;\n\t\tconsole.log(output);\n\t}\n\treturn remoteExtensionHostAgentServer;\n}\n\nclass WebEndpointOriginChecker {\n\n\tpublic static create(productService: IProductService): WebEndpointOriginChecker {\n\t\tconst webEndpointUrlTemplate = productService.webEndpointUrlTemplate;\n\t\tconst commit = productService.commit;\n\t\tconst quality = productService.quality;\n\t\tif (!webEndpointUrlTemplate || !commit || !quality) {\n\t\t\treturn new WebEndpointOriginChecker(null);\n\t\t}\n\n\t\tconst uuid = generateUuid();\n\t\tconst exampleUrl = new URL(\n\t\t\twebEndpointUrlTemplate\n\t\t\t\t.replace('{{uuid}}', uuid)\n\t\t\t\t.replace('{{commit}}', commit)\n\t\t\t\t.replace('{{quality}}', quality)\n\t\t);\n\t\tconst exampleOrigin = exampleUrl.origin;\n\t\tconst originRegExpSource = (\n\t\t\tescapeRegExpCharacters(exampleOrigin)\n\t\t\t\t.replace(uuid, '[a-zA-Z0-9\\\\-]+')\n\t\t);\n\t\ttry {\n\t\t\tconst originRegExp = createRegExp(`^${originRegExpSource}$`, true, { matchCase: false });\n\t\t\treturn new WebEndpointOriginChecker(originRegExp);\n\t\t} catch (err) {\n\t\t\treturn new WebEndpointOriginChecker(null);\n\t\t}\n\t}\n\n\tconstructor(\n\t\tprivate readonly _originRegExp: RegExp | null\n\t) { }\n\n\tpublic matches(origin: string): boolean {\n\t\tif (!this._originRegExp) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this._originRegExp.test(origin);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as fs from 'fs';\nimport type * as http from 'http';\nimport * as net from 'net';\nimport { createRequire } from 'node:module';\nimport { performance } from 'perf_hooks';\nimport * as url from 'url';\nimport { VSBuffer } from '../../base/common/buffer.js';\nimport { CharCode } from '../../base/common/charCode.js';\nimport { isSigPipeError, onUnexpectedError, setUnexpectedErrorHandler } from '../../base/common/errors.js';\nimport { isEqualOrParent } from '../../base/common/extpath.js';\nimport { Disposable, DisposableStore } from '../../base/common/lifecycle.js';\nimport { connectionTokenQueryName, FileAccess, getServerProductSegment, Schemas } from '../../base/common/network.js';\nimport { dirname, join } from '../../base/common/path.js';\nimport * as perf from '../../base/common/performance.js';\nimport * as platform from '../../base/common/platform.js';\nimport { createRegExp, escapeRegExpCharacters } from '../../base/common/strings.js';\nimport { URI } from '../../base/common/uri.js';\nimport { generateUuid } from '../../base/common/uuid.js';\nimport { getOSReleaseInfo } from '../../base/node/osReleaseInfo.js';\nimport { findFreePort } from '../../base/node/ports.js';\nimport { addUNCHostToAllowlist, disableUNCAccessRestrictions } from '../../base/node/unc.js';\nimport { PersistentProtocol } from '../../base/parts/ipc/common/ipc.net.js';\nimport { NodeSocket, upgradeToISocket, WebSocketNodeSocket } from '../../base/parts/ipc/node/ipc.net.js';\nimport { IConfigurationService } from '../../platform/configuration/common/configuration.js';\nimport { IInstantiationService } from '../../platform/instantiation/common/instantiation.js';\nimport { ILogService } from '../../platform/log/common/log.js';\nimport { IProductService } from '../../platform/product/common/productService.js';\nimport { ConnectionType, ConnectionTypeRequest, ErrorMessage, HandshakeMessage, IRemoteExtensionHostStartParams, ITunnelConnectionStartParams, SignRequest } from '../../platform/remote/common/remoteAgentConnection.js';\nimport { RemoteAgentConnectionContext } from '../../platform/remote/common/remoteAgentEnvironment.js';\nimport { ITelemetryService } from '../../platform/telemetry/common/telemetry.js';\nimport { ExtensionHostConnection } from './extensionHostConnection.js';\nimport { ManagementConnection } from './remoteExtensionManagement.js';\nimport { determineServerConnectionToken, requestHasValidConnectionToken as httpRequestHasValidConnectionToken, ServerConnectionToken, ServerConnectionTokenParseError, ServerConnectionTokenType } from './serverConnectionToken.js';\nimport { IServerEnvironmentService, ServerParsedArgs } from './serverEnvironmentService.js';\nimport { setupServerServices, SocketServer } from './serverServices.js';\nimport { CacheControl, serveError, serveFile, WebClientServer } from './webClientServer.js';\nconst require = createRequire(import.meta.url);\n\nconst SHUTDOWN_TIMEOUT = 5 * 60 * 1000;\n\ndeclare module vsda {\n\t// the signer is a native module that for historical reasons uses a lower case class name\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\texport class signer {\n\t\tsign(arg: string): string;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/naming-convention\n\texport class validator {\n\t\tcreateNewMessage(arg: string): string;\n\t\tvalidate(arg: string): 'ok' | 'error';\n\t}\n}\n\nclass RemoteExtensionHostAgentServer extends Disposable implements IServerAPI {\n\n\tprivate readonly _extHostConnections: { [reconnectionToken: string]: ExtensionHostConnection };\n\tprivate readonly _managementConnections: { [reconnectionToken: string]: ManagementConnection };\n\tprivate readonly _allReconnectionTokens: Set<string>;\n\tprivate readonly _webClientServer: WebClientServer | null;\n\tprivate readonly _webEndpointOriginChecker: WebEndpointOriginChecker;\n\tprivate readonly _reconnectionGraceTime: number;\n\n\tprivate readonly _serverBasePath: string | undefined;\n\tprivate readonly _serverProductPath: string;\n\n\tprivate shutdownTimer: Timeout | undefined;\n\n\tconstructor(\n\t\tprivate readonly _socketServer: SocketServer<RemoteAgentConnectionContext>,\n\t\tprivate readonly _connectionToken: ServerConnectionToken,\n\t\tprivate readonly _vsdaMod: typeof vsda | null,\n\t\thasWebClient: boolean,\n\t\tserverBasePath: string | undefined,\n\t\t@IServerEnvironmentService private readonly _environmentService: IServerEnvironmentService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper();\n\t\tthis._webEndpointOriginChecker = WebEndpointOriginChecker.create(this._productService);\n\n\t\tif (serverBasePath !== undefined && serverBasePath.charCodeAt(serverBasePath.length - 1) === CharCode.Slash) {\n\t\t\t// Remove trailing slash from base path\n\t\t\tserverBasePath = serverBasePath.substring(0, serverBasePath.length - 1);\n\t\t}\n\t\tthis._serverBasePath = serverBasePath; // undefined or starts with a slash\n\t\tthis._serverProductPath = `/${getServerProductSegment(_productService)}`; // starts with a slash\n\t\tthis._extHostConnections = Object.create(null);\n\t\tthis._managementConnections = Object.create(null);\n\t\tthis._allReconnectionTokens = new Set<string>();\n\t\tthis._webClientServer = (\n\t\t\thasWebClient\n\t\t\t\t? this._instantiationService.createInstance(WebClientServer, this._connectionToken, serverBasePath ?? '/', this._serverProductPath)\n\t\t\t\t: null\n\t\t);\n\t\tthis._logService.info(`Extension host agent started.`);\n\t\tthis._reconnectionGraceTime = this._environmentService.reconnectionGraceTime;\n\n\t\tthis._waitThenShutdown(true);\n\t}\n\n\tpublic async handleRequest(req: http.IncomingMessage, res: http.ServerResponse): Promise<void> {\n\t\t// Only serve GET requests\n\t\tif (req.method !== 'GET') {\n\t\t\treturn serveError(req, res, 405, `Unsupported method ${req.method}`);\n\t\t}\n\n\t\tif (!req.url) {\n\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t}\n\n\t\tconst parsedUrl = url.parse(req.url, true);\n\t\tlet pathname = parsedUrl.pathname;\n\n\t\tif (!pathname) {\n\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t}\n\n\t\t// Serve from both '/' and serverBasePath\n\t\tif (this._serverBasePath !== undefined && pathname.startsWith(this._serverBasePath)) {\n\t\t\tpathname = pathname.substring(this._serverBasePath.length) || '/';\n\t\t}\n\t\t// for now accept all paths, with or without server product path\n\t\tif (pathname.startsWith(this._serverProductPath) && pathname.charCodeAt(this._serverProductPath.length) === CharCode.Slash) {\n\t\t\tpathname = pathname.substring(this._serverProductPath.length);\n\t\t}\n\n\t\t// Version\n\t\tif (pathname === '/version') {\n\t\t\tres.writeHead(200, { 'Content-Type': 'text/plain' });\n\t\t\treturn void res.end(this._productService.commit || '');\n\t\t}\n\n\t\t// Delay shutdown\n\t\tif (pathname === '/delay-shutdown') {\n\t\t\tthis._delayShutdown();\n\t\t\tres.writeHead(200);\n\t\t\treturn void res.end('OK');\n\t\t}\n\n\t\tif (!httpRequestHasValidConnectionToken(this._connectionToken, req, parsedUrl)) {\n\t\t\t// invalid connection token\n\t\t\treturn serveError(req, res, 403, `Forbidden.`);\n\t\t}\n\n\t\tif (pathname === '/vscode-remote-resource') {\n\t\t\t// Handle HTTP requests for resources rendered in the rich client (images, fonts, etc.)\n\t\t\t// These resources could be files shipped with extensions or even workspace files.\n\t\t\tconst desiredPath = parsedUrl.query['path'];\n\t\t\tif (typeof desiredPath !== 'string') {\n\t\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t\t}\n\n\t\t\tlet filePath: string;\n\t\t\ttry {\n\t\t\t\tfilePath = URI.from({ scheme: Schemas.file, path: desiredPath }).fsPath;\n\t\t\t} catch (err) {\n\t\t\t\treturn serveError(req, res, 400, `Bad request.`);\n\t\t\t}\n\n\t\t\tconst responseHeaders: Record<string, string> = Object.create(null);\n\t\t\tif (this._environmentService.isBuilt) {\n\t\t\t\tif (isEqualOrParent(filePath, this._environmentService.builtinExtensionsPath, !platform.isLinux)\n\t\t\t\t\t|| isEqualOrParent(filePath, this._environmentService.extensionsPath, !platform.isLinux)\n\t\t\t\t) {\n\t\t\t\t\tresponseHeaders['Cache-Control'] = 'public, max-age=31536000';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Allow cross origin requests from the web worker extension host\n\t\t\tresponseHeaders['Vary'] = 'Origin';\n\t\t\tconst requestOrigin = req.headers['origin'];\n\t\t\tif (requestOrigin && this._webEndpointOriginChecker.matches(requestOrigin)) {\n\t\t\t\tresponseHeaders['Access-Control-Allow-Origin'] = requestOrigin;\n\t\t\t}\n\t\t\treturn serveFile(filePath, CacheControl.ETAG, this._logService, req, res, responseHeaders);\n\t\t}\n\n\t\t// workbench web UI\n\t\tif (this._webClientServer) {\n\t\t\tthis._webClientServer.handle(req, res, parsedUrl, pathname);\n\t\t\treturn;\n\t\t}\n\n\t\tres.writeHead(404, { 'Content-Type': 'text/plain' });\n\t\treturn void res.end('Not found');\n\t}\n\n\tpublic handleUpgrade(req: http.IncomingMessage, socket: net.Socket) {\n\t\tlet reconnectionToken = generateUuid();\n\t\tlet isReconnection = false;\n\t\tlet skipWebSocketFrames = false;\n\n\t\tif (req.url) {\n\t\t\tconst query = url.parse(req.url, true).query;\n\t\t\tif (typeof query.reconnectionToken === 'string') {\n\t\t\t\treconnectionToken = query.reconnectionToken;\n\t\t\t}\n\t\t\tif (query.reconnection === 'true') {\n\t\t\t\tisReconnection = true;\n\t\t\t}\n\t\t\tif (query.skipWebSocketFrames === 'true') {\n\t\t\t\tskipWebSocketFrames = true;\n\t\t\t}\n\t\t}\n\n\t\tconst upgraded = upgradeToISocket(req, socket, {\n\t\t\tdebugLabel: `server-connection-${reconnectionToken}`,\n\t\t\tskipWebSocketFrames,\n\t\t\tdisableWebSocketCompression: this._environmentService.args['disable-websocket-compression']\n\t\t});\n\n\t\tif (!upgraded) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._handleWebSocketConnection(upgraded, isReconnection, reconnectionToken);\n\t}\n\n\tpublic handleServerError(err: Error): void {\n\t\tthis._logService.error(`Error occurred in server`);\n\t\tthis._logService.error(err);\n\t}\n\n\t// Eventually cleanup\n\n\tprivate _getRemoteAddress(socket: NodeSocket | WebSocketNodeSocket): string {\n\t\tlet _socket: net.Socket;\n\t\tif (socket instanceof NodeSocket) {\n\t\t\t_socket = socket.socket;\n\t\t} else {\n\t\t\t_socket = socket.socket.socket;\n\t\t}\n\t\treturn _socket.remoteAddress || `<unknown>`;\n\t}\n\n\tprivate async _rejectWebSocketConnection(logPrefix: string, protocol: PersistentProtocol, reason: string): Promise<void> {\n\t\tconst socket = protocol.getSocket();\n\t\tthis._logService.error(`${logPrefix} ${reason}.`);\n\t\tconst errMessage: ErrorMessage = {\n\t\t\ttype: 'error',\n\t\t\treason: reason\n\t\t};\n\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify(errMessage)));\n\t\tprotocol.dispose();\n\t\tawait socket.drain();\n\t\tsocket.dispose();\n\t}\n\n\t/**\n\t * NOTE: Avoid using await in this method!\n\t * The problem is that await introduces a process.nextTick due to the implicit Promise.then\n\t * This can lead to some bytes being received and interpreted and a control message being emitted before the next listener has a chance to be registered.\n\t */\n\tprivate _handleWebSocketConnection(socket: NodeSocket | WebSocketNodeSocket, isReconnection: boolean, reconnectionToken: string): void {\n\t\tconst remoteAddress = this._getRemoteAddress(socket);\n\t\tconst logPrefix = `[${remoteAddress}][${reconnectionToken.substr(0, 8)}]`;\n\t\tconst protocol = new PersistentProtocol({ socket });\n\n\t\tconst validator = this._vsdaMod ? new this._vsdaMod.validator() : null;\n\t\tconst signer = this._vsdaMod ? new this._vsdaMod.signer() : null;\n\n\t\tconst enum State {\n\t\t\tWaitingForAuth,\n\t\t\tWaitingForConnectionType,\n\t\t\tDone,\n\t\t\tError\n\t\t}\n\t\tlet state = State.WaitingForAuth;\n\n\t\tconst rejectWebSocketConnection = (msg: string) => {\n\t\t\tstate = State.Error;\n\t\t\tlistener.dispose();\n\t\t\tthis._rejectWebSocketConnection(logPrefix, protocol, msg);\n\t\t};\n\n\t\tconst listener = protocol.onControlMessage((raw) => {\n\t\t\tif (state === State.WaitingForAuth) {\n\t\t\t\tlet msg1: HandshakeMessage;\n\t\t\t\ttry {\n\t\t\t\t\tmsg1 = <HandshakeMessage>JSON.parse(raw.toString());\n\t\t\t\t} catch (err) {\n\t\t\t\t\treturn rejectWebSocketConnection(`Malformed first message`);\n\t\t\t\t}\n\t\t\t\tif (msg1.type !== 'auth') {\n\t\t\t\t\treturn rejectWebSocketConnection(`Invalid first message`);\n\t\t\t\t}\n\n\t\t\t\tif (this._connectionToken.type === ServerConnectionTokenType.Mandatory && !this._connectionToken.validate(msg1.auth)) {\n\t\t\t\t\treturn rejectWebSocketConnection(`Unauthorized client refused: auth mismatch`);\n\t\t\t\t}\n\n\t\t\t\t// Send `sign` request\n\t\t\t\tlet signedData = generateUuid();\n\t\t\t\tif (signer) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tsignedData = signer.sign(msg1.data);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet someText = generateUuid();\n\t\t\t\tif (validator) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tsomeText = validator.createNewMessage(someText);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tconst signRequest: SignRequest = {\n\t\t\t\t\ttype: 'sign',\n\t\t\t\t\tdata: someText,\n\t\t\t\t\tsignedData: signedData\n\t\t\t\t};\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify(signRequest)));\n\n\t\t\t\tstate = State.WaitingForConnectionType;\n\n\t\t\t} else if (state === State.WaitingForConnectionType) {\n\n\t\t\t\tlet msg2: HandshakeMessage;\n\t\t\t\ttry {\n\t\t\t\t\tmsg2 = <HandshakeMessage>JSON.parse(raw.toString());\n\t\t\t\t} catch (err) {\n\t\t\t\t\treturn rejectWebSocketConnection(`Malformed second message`);\n\t\t\t\t}\n\t\t\t\tif (msg2.type !== 'connectionType') {\n\t\t\t\t\treturn rejectWebSocketConnection(`Invalid second message`);\n\t\t\t\t}\n\t\t\t\tif (typeof msg2.signedData !== 'string') {\n\t\t\t\t\treturn rejectWebSocketConnection(`Invalid second message field type`);\n\t\t\t\t}\n\n\t\t\t\tconst rendererCommit = msg2.commit;\n\t\t\t\tconst myCommit = this._productService.commit;\n\t\t\t\tif (rendererCommit && myCommit) {\n\t\t\t\t\t// Running in the built version where commits are defined\n\t\t\t\t\tif (rendererCommit !== myCommit) {\n\t\t\t\t\t\treturn rejectWebSocketConnection(`Client refused: version mismatch`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlet valid = false;\n\t\t\t\tif (!validator) {\n\t\t\t\t\tvalid = true;\n\t\t\t\t} else if (this._connectionToken.validate(msg2.signedData)) {\n\t\t\t\t\t// web client\n\t\t\t\t\tvalid = true;\n\t\t\t\t} else {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tvalid = validator.validate(msg2.signedData) === 'ok';\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!valid) {\n\t\t\t\t\tif (this._environmentService.isBuilt) {\n\t\t\t\t\t\treturn rejectWebSocketConnection(`Unauthorized client refused`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._logService.error(`${logPrefix} Unauthorized client handshake failed but we proceed because of dev mode.`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// We have received a new connection.\n\t\t\t\t// This indicates that the server owner has connectivity.\n\t\t\t\t// Therefore we will shorten the reconnection grace period for disconnected connections!\n\t\t\t\tfor (const key in this._managementConnections) {\n\t\t\t\t\tconst managementConnection = this._managementConnections[key];\n\t\t\t\t\tmanagementConnection.shortenReconnectionGraceTimeIfNecessary();\n\t\t\t\t}\n\t\t\t\tfor (const key in this._extHostConnections) {\n\t\t\t\t\tconst extHostConnection = this._extHostConnections[key];\n\t\t\t\t\textHostConnection.shortenReconnectionGraceTimeIfNecessary();\n\t\t\t\t}\n\n\t\t\t\tstate = State.Done;\n\t\t\t\tlistener.dispose();\n\t\t\t\tthis._handleConnectionType(remoteAddress, logPrefix, protocol, socket, isReconnection, reconnectionToken, msg2);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate async _handleConnectionType(remoteAddress: string, _logPrefix: string, protocol: PersistentProtocol, socket: NodeSocket | WebSocketNodeSocket, isReconnection: boolean, reconnectionToken: string, msg: ConnectionTypeRequest): Promise<void> {\n\t\tconst logPrefix = (\n\t\t\tmsg.desiredConnectionType === ConnectionType.Management\n\t\t\t\t? `${_logPrefix}[ManagementConnection]`\n\t\t\t\t: msg.desiredConnectionType === ConnectionType.ExtensionHost\n\t\t\t\t\t? `${_logPrefix}[ExtensionHostConnection]`\n\t\t\t\t\t: _logPrefix\n\t\t);\n\n\t\tif (msg.desiredConnectionType === ConnectionType.Management) {\n\t\t\t// This should become a management connection\n\n\t\t\tif (isReconnection) {\n\t\t\t\t// This is a reconnection\n\t\t\t\tif (!this._managementConnections[reconnectionToken]) {\n\t\t\t\t\tif (!this._allReconnectionTokens.has(reconnectionToken)) {\n\t\t\t\t\t\t// This is an unknown reconnection token\n\t\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown reconnection token (never seen)`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// This is a connection that was seen in the past, but is no longer valid\n\t\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown reconnection token (seen before)`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify({ type: 'ok' })));\n\t\t\t\tconst dataChunk = protocol.readEntireBuffer();\n\t\t\t\tprotocol.dispose();\n\t\t\t\tthis._managementConnections[reconnectionToken].acceptReconnection(remoteAddress, socket, dataChunk);\n\n\t\t\t} else {\n\t\t\t\t// This is a fresh connection\n\t\t\t\tif (this._managementConnections[reconnectionToken]) {\n\t\t\t\t\t// Cannot have two concurrent connections using the same reconnection token\n\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Duplicate reconnection token`);\n\t\t\t\t}\n\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify({ type: 'ok' })));\n\t\t\t\tconst con = new ManagementConnection(this._logService, reconnectionToken, remoteAddress, protocol, this._reconnectionGraceTime);\n\t\t\t\tthis._socketServer.acceptConnection(con.protocol, con.onClose);\n\t\t\t\tthis._managementConnections[reconnectionToken] = con;\n\t\t\t\tthis._allReconnectionTokens.add(reconnectionToken);\n\t\t\t\tcon.onClose(() => {\n\t\t\t\t\tdelete this._managementConnections[reconnectionToken];\n\t\t\t\t});\n\n\t\t\t}\n\n\t\t} else if (msg.desiredConnectionType === ConnectionType.ExtensionHost) {\n\n\t\t\t// This should become an extension host connection\n\t\t\tconst startParams0 = <IRemoteExtensionHostStartParams>msg.args || { language: 'en' };\n\t\t\tconst startParams = await this._updateWithFreeDebugPort(startParams0);\n\n\t\t\tif (startParams.port) {\n\t\t\t\tthis._logService.trace(`${logPrefix} - startParams debug port ${startParams.port}`);\n\t\t\t}\n\t\t\tthis._logService.trace(`${logPrefix} - startParams language: ${startParams.language}`);\n\t\t\tthis._logService.trace(`${logPrefix} - startParams env: ${JSON.stringify(startParams.env)}`);\n\n\t\t\tif (isReconnection) {\n\t\t\t\t// This is a reconnection\n\t\t\t\tif (!this._extHostConnections[reconnectionToken]) {\n\t\t\t\t\tif (!this._allReconnectionTokens.has(reconnectionToken)) {\n\t\t\t\t\t\t// This is an unknown reconnection token\n\t\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown reconnection token (never seen)`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// This is a connection that was seen in the past, but is no longer valid\n\t\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown reconnection token (seen before)`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tprotocol.sendPause();\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify(startParams.port ? { debugPort: startParams.port } : {})));\n\t\t\t\tconst dataChunk = protocol.readEntireBuffer();\n\t\t\t\tprotocol.dispose();\n\t\t\t\tthis._extHostConnections[reconnectionToken].acceptReconnection(remoteAddress, socket, dataChunk);\n\n\t\t\t} else {\n\t\t\t\t// This is a fresh connection\n\t\t\t\tif (this._extHostConnections[reconnectionToken]) {\n\t\t\t\t\t// Cannot have two concurrent connections using the same reconnection token\n\t\t\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Duplicate reconnection token`);\n\t\t\t\t}\n\n\t\t\t\tprotocol.sendPause();\n\t\t\t\tprotocol.sendControl(VSBuffer.fromString(JSON.stringify(startParams.port ? { debugPort: startParams.port } : {})));\n\t\t\t\tconst dataChunk = protocol.readEntireBuffer();\n\t\t\t\tprotocol.dispose();\n\t\t\t\tconst con = this._instantiationService.createInstance(ExtensionHostConnection, reconnectionToken, remoteAddress, socket, dataChunk);\n\t\t\t\tthis._extHostConnections[reconnectionToken] = con;\n\t\t\t\tthis._allReconnectionTokens.add(reconnectionToken);\n\t\t\t\tcon.onClose(() => {\n\t\t\t\t\tcon.dispose();\n\t\t\t\t\tdelete this._extHostConnections[reconnectionToken];\n\t\t\t\t\tthis._onDidCloseExtHostConnection();\n\t\t\t\t});\n\t\t\t\tcon.start(startParams);\n\t\t\t}\n\n\t\t} else if (msg.desiredConnectionType === ConnectionType.Tunnel) {\n\n\t\t\tconst tunnelStartParams = <ITunnelConnectionStartParams>msg.args;\n\t\t\tthis._createTunnel(protocol, tunnelStartParams);\n\n\t\t} else {\n\n\t\t\treturn this._rejectWebSocketConnection(logPrefix, protocol, `Unknown initial data received`);\n\n\t\t}\n\t}\n\n\tprivate async _createTunnel(protocol: PersistentProtocol, tunnelStartParams: ITunnelConnectionStartParams): Promise<void> {\n\t\tconst remoteSocket = (<NodeSocket>protocol.getSocket()).socket;\n\t\tconst dataChunk = protocol.readEntireBuffer();\n\t\tprotocol.dispose();\n\n\t\tremoteSocket.pause();\n\t\tconst localSocket = await this._connectTunnelSocket(tunnelStartParams.host, tunnelStartParams.port);\n\n\t\tif (dataChunk.byteLength > 0) {\n\t\t\tlocalSocket.write(dataChunk.buffer);\n\t\t}\n\n\t\tlocalSocket.on('end', () => remoteSocket.end());\n\t\tlocalSocket.on('close', () => remoteSocket.end());\n\t\tlocalSocket.on('error', () => remoteSocket.destroy());\n\t\tremoteSocket.on('end', () => localSocket.end());\n\t\tremoteSocket.on('close', () => localSocket.end());\n\t\tremoteSocket.on('error', () => localSocket.destroy());\n\n\t\tlocalSocket.pipe(remoteSocket);\n\t\tremoteSocket.pipe(localSocket);\n\t}\n\n\tprivate _connectTunnelSocket(host: string, port: number): Promise<net.Socket> {\n\t\treturn new Promise<net.Socket>((c, e) => {\n\t\t\tconst socket = net.createConnection(\n\t\t\t\t{\n\t\t\t\t\thost: host,\n\t\t\t\t\tport: port,\n\t\t\t\t\tautoSelectFamily: true\n\t\t\t\t}, () => {\n\t\t\t\t\tsocket.removeListener('error', e);\n\t\t\t\t\tsocket.pause();\n\t\t\t\t\tc(socket);\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tsocket.once('error', e);\n\t\t});\n\t}\n\n\tprivate _updateWithFreeDebugPort(startParams: IRemoteExtensionHostStartParams): Thenable<IRemoteExtensionHostStartParams> {\n\t\tif (typeof startParams.port === 'number') {\n\t\t\treturn findFreePort(startParams.port, 10 /* try 10 ports */, 5000 /* try up to 5 seconds */).then(freePort => {\n\t\t\t\tstartParams.port = freePort;\n\t\t\t\treturn startParams;\n\t\t\t});\n\t\t}\n\t\t// No port clear debug configuration.\n\t\tstartParams.debugId = undefined;\n\t\tstartParams.port = undefined;\n\t\tstartParams.break = undefined;\n\t\treturn Promise.resolve(startParams);\n\t}\n\n\tprivate async _onDidCloseExtHostConnection(): Promise<void> {\n\t\tif (!this._environmentService.args['enable-remote-auto-shutdown']) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._cancelShutdown();\n\n\t\tconst hasActiveExtHosts = !!Object.keys(this._extHostConnections).length;\n\t\tif (!hasActiveExtHosts) {\n\t\t\tconsole.log('Last EH closed, waiting before shutting down');\n\t\t\tthis._logService.info('Last EH closed, waiting before shutting down');\n\t\t\tthis._waitThenShutdown();\n\t\t}\n\t}\n\n\tprivate _waitThenShutdown(initial = false): void {\n\t\tif (!this._environmentService.args['enable-remote-auto-shutdown']) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._environmentService.args['remote-auto-shutdown-without-delay'] && !initial) {\n\t\t\tthis._shutdown();\n\t\t} else {\n\t\t\tthis.shutdownTimer = setTimeout(() => {\n\t\t\t\tthis.shutdownTimer = undefined;\n\n\t\t\t\tthis._shutdown();\n\t\t\t}, SHUTDOWN_TIMEOUT);\n\t\t}\n\t}\n\n\tprivate _shutdown(): void {\n\t\tconst hasActiveExtHosts = !!Object.keys(this._extHostConnections).length;\n\t\tif (hasActiveExtHosts) {\n\t\t\tconsole.log('New EH opened, aborting shutdown');\n\t\t\tthis._logService.info('New EH opened, aborting shutdown');\n\t\t\treturn;\n\t\t} else {\n\t\t\tconsole.log('Last EH closed, shutting down');\n\t\t\tthis._logService.info('Last EH closed, shutting down');\n\t\t\tthis.dispose();\n\t\t\tprocess.exit(0);\n\t\t}\n\t}\n\n\t/**\n\t * If the server is in a shutdown timeout, cancel it and start over\n\t */\n\tprivate _delayShutdown(): void {\n\t\tif (this.shutdownTimer) {\n\t\t\tconsole.log('Got delay-shutdown request while in shutdown timeout, delaying');\n\t\t\tthis._logService.info('Got delay-shutdown request while in shutdown timeout, delaying');\n\t\t\tthis._cancelShutdown();\n\t\t\tthis._waitThenShutdown();\n\t\t}\n\t}\n\n\tprivate _cancelShutdown(): void {\n\t\tif (this.shutdownTimer) {\n\t\t\tconsole.log('Cancelling previous shutdown timeout');\n\t\t\tthis._logService.info('Cancelling previous shutdown timeout');\n\t\t\tclearTimeout(this.shutdownTimer);\n\t\t\tthis.shutdownTimer = undefined;\n\t\t}\n\t}\n}\n\nexport interface IServerAPI {\n\t/**\n\t * Do not remove!!. Called from server-main.js\n\t */\n\thandleRequest(req: http.IncomingMessage, res: http.ServerResponse): Promise<void>;\n\t/**\n\t * Do not remove!!. Called from server-main.js\n\t */\n\thandleUpgrade(req: http.IncomingMessage, socket: net.Socket): void;\n\t/**\n\t * Do not remove!!. Called from server-main.js\n\t */\n\thandleServerError(err: Error): void;\n\t/**\n\t * Do not remove!!. Called from server-main.js\n\t */\n\tdispose(): void;\n}\n\nexport async function createServer(address: string | net.AddressInfo | null, args: ServerParsedArgs, REMOTE_DATA_FOLDER: string): Promise<IServerAPI> {\n\n\tconst connectionToken = await determineServerConnectionToken(args);\n\tif (connectionToken instanceof ServerConnectionTokenParseError) {\n\t\tconsole.warn(connectionToken.message);\n\t\tprocess.exit(1);\n\t}\n\n\t// setting up error handlers, first with console.error, then, once available, using the log service\n\n\tfunction initUnexpectedErrorHandler(handler: (err: any) => void) {\n\t\tsetUnexpectedErrorHandler(err => {\n\t\t\t// See https://github.com/microsoft/vscode-remote-release/issues/6481\n\t\t\t// In some circumstances, console.error will throw an asynchronous error. This asynchronous error\n\t\t\t// will end up here, and then it will be logged again, thus creating an endless asynchronous loop.\n\t\t\t// Here we try to break the loop by ignoring EPIPE errors that include our own unexpected error handler in the stack.\n\t\t\tif (isSigPipeError(err) && err.stack && /unexpectedErrorHandler/.test(err.stack)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\thandler(err);\n\t\t});\n\t}\n\n\tconst unloggedErrors: any[] = [];\n\tinitUnexpectedErrorHandler((error: any) => {\n\t\tunloggedErrors.push(error);\n\t\tconsole.error(error);\n\t});\n\tlet didLogAboutSIGPIPE = false;\n\tprocess.on('SIGPIPE', () => {\n\t\t// See https://github.com/microsoft/vscode-remote-release/issues/6543\n\t\t// We would normally install a SIGPIPE listener in bootstrap-node.js\n\t\t// But in certain situations, the console itself can be in a broken pipe state\n\t\t// so logging SIGPIPE to the console will cause an infinite async loop\n\t\tif (!didLogAboutSIGPIPE) {\n\t\t\tdidLogAboutSIGPIPE = true;\n\t\t\tonUnexpectedError(new Error(`Unexpected SIGPIPE`));\n\t\t}\n\t});\n\n\tconst disposables = new DisposableStore();\n\tconst { socketServer, instantiationService } = await setupServerServices(connectionToken, args, REMOTE_DATA_FOLDER, disposables);\n\n\t// Set the unexpected error handler after the services have been initialized, to avoid having\n\t// the telemetry service overwrite our handler\n\tinstantiationService.invokeFunction((accessor) => {\n\t\tconst logService = accessor.get(ILogService);\n\t\tunloggedErrors.forEach(error => logService.error(error));\n\t\tunloggedErrors.length = 0;\n\n\t\tinitUnexpectedErrorHandler((error: any) => logService.error(error));\n\t});\n\n\t// On Windows, configure the UNC allow list based on settings\n\tinstantiationService.invokeFunction((accessor) => {\n\t\tconst configurationService = accessor.get(IConfigurationService);\n\n\t\tif (platform.isWindows) {\n\t\t\tif (configurationService.getValue('security.restrictUNCAccess') === false) {\n\t\t\t\tdisableUNCAccessRestrictions();\n\t\t\t} else {\n\t\t\t\taddUNCHostToAllowlist(configurationService.getValue('security.allowedUNCHosts'));\n\t\t\t}\n\t\t}\n\t});\n\n\t//\n\t// On Windows, exit early with warning message to users about potential security issue\n\t// if there is node_modules folder under home drive or Users folder.\n\t//\n\tinstantiationService.invokeFunction((accessor) => {\n\t\tconst logService = accessor.get(ILogService);\n\n\t\tif (platform.isWindows && process.env.HOMEDRIVE && process.env.HOMEPATH) {\n\t\t\tconst homeDirModulesPath = join(process.env.HOMEDRIVE, 'node_modules');\n\t\t\tconst userDir = dirname(join(process.env.HOMEDRIVE, process.env.HOMEPATH));\n\t\t\tconst userDirModulesPath = join(userDir, 'node_modules');\n\t\t\tif (fs.existsSync(homeDirModulesPath) || fs.existsSync(userDirModulesPath)) {\n\t\t\t\tconst message = `\n\n*\n* !!!! Server terminated due to presence of CVE-2020-1416 !!!!\n*\n* Please remove the following directories and re-try\n* ${homeDirModulesPath}\n* ${userDirModulesPath}\n*\n* For more information on the vulnerability https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1416\n*\n\n`;\n\t\t\t\tlogService.warn(message);\n\t\t\t\tconsole.warn(message);\n\t\t\t\tprocess.exit(0);\n\t\t\t}\n\t\t}\n\t});\n\n\tconst vsdaMod = instantiationService.invokeFunction((accessor) => {\n\t\tconst logService = accessor.get(ILogService);\n\t\tconst hasVSDA = fs.existsSync(join(FileAccess.asFileUri('').fsPath, '../node_modules/vsda'));\n\t\tif (hasVSDA) {\n\t\t\ttry {\n\t\t\t\treturn require('vsda');\n\t\t\t} catch (err) {\n\t\t\t\tlogService.error(err);\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t});\n\n\tlet serverBasePath = args['server-base-path'];\n\tif (serverBasePath && !serverBasePath.startsWith('/')) {\n\t\tserverBasePath = `/${serverBasePath}`;\n\t}\n\n\tconst hasWebClient = fs.existsSync(FileAccess.asFileUri(`vs/code/browser/workbench/workbench.html`).fsPath);\n\n\tif (hasWebClient && address && typeof address !== 'string') {\n\t\t// ships the web ui!\n\t\tconst queryPart = (connectionToken.type !== ServerConnectionTokenType.None ? `?${connectionTokenQueryName}=${connectionToken.value}` : '');\n\t\tconsole.log(`Web UI available at http://localhost${address.port === 80 ? '' : `:${address.port}`}${serverBasePath ?? ''}${queryPart}`);\n\t}\n\n\tconst remoteExtensionHostAgentServer = instantiationService.createInstance(RemoteExtensionHostAgentServer, socketServer, connectionToken, vsdaMod, hasWebClient, serverBasePath);\n\n\tperf.mark('code/server/ready');\n\tconst currentTime = performance.now();\n\t// eslint-disable-next-line local/code-no-any-casts\n\tconst vscodeServerStartTime: number = (<any>global).vscodeServerStartTime;\n\t// eslint-disable-next-line local/code-no-any-casts\n\tconst vscodeServerListenTime: number = (<any>global).vscodeServerListenTime;\n\t// eslint-disable-next-line local/code-no-any-casts\n\tconst vscodeServerCodeLoadedTime: number = (<any>global).vscodeServerCodeLoadedTime;\n\n\tinstantiationService.invokeFunction(async (accessor) => {\n\t\tconst telemetryService = accessor.get(ITelemetryService);\n\n\t\ttype ServerStartClassification = {\n\t\t\towner: 'alexdima';\n\t\t\tcomment: 'The server has started up';\n\t\t\tstartTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time the server started at.' };\n\t\t\tstartedTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time the server began listening for connections.' };\n\t\t\tcodeLoadedTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time which the code loaded on the server' };\n\t\t\treadyTime: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The time when the server was completely ready' };\n\t\t};\n\t\ttype ServerStartEvent = {\n\t\t\tstartTime: number;\n\t\t\tstartedTime: number;\n\t\t\tcodeLoadedTime: number;\n\t\t\treadyTime: number;\n\t\t};\n\t\ttelemetryService.publicLog2<ServerStartEvent, ServerStartClassification>('serverStart', {\n\t\t\tstartTime: vscodeServerStartTime,\n\t\t\tstartedTime: vscodeServerListenTime,\n\t\t\tcodeLoadedTime: vscodeServerCodeLoadedTime,\n\t\t\treadyTime: currentTime\n\t\t});\n\n\t\tif (platform.isLinux) {\n\t\t\tconst logService = accessor.get(ILogService);\n\t\t\tconst releaseInfo = await getOSReleaseInfo(logService.error.bind(logService));\n\t\t\tif (releaseInfo) {\n\t\t\t\ttype ServerPlatformInfoClassification = {\n\t\t\t\t\tplatformId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'A string identifying the operating system without any version information.' };\n\t\t\t\t\tplatformVersionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'A string identifying the operating system version excluding any name information or release code.' };\n\t\t\t\t\tplatformIdLike: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'A string identifying the operating system the current OS derivate is closely related to.' };\n\t\t\t\t\towner: 'deepak1556';\n\t\t\t\t\tcomment: 'Provides insight into the distro information on Linux.';\n\t\t\t\t};\n\t\t\t\ttype ServerPlatformInfoEvent = {\n\t\t\t\t\tplatformId: string;\n\t\t\t\t\tplatformVersionId: string | undefined;\n\t\t\t\t\tplatformIdLike: string | undefined;\n\t\t\t\t};\n\t\t\t\ttelemetryService.publicLog2<ServerPlatformInfoEvent, ServerPlatformInfoClassification>('serverPlatformInfo', {\n\t\t\t\t\tplatformId: releaseInfo.id,\n\t\t\t\t\tplatformVersionId: releaseInfo.version_id,\n\t\t\t\t\tplatformIdLike: releaseInfo.id_like\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t});\n\n\tif (args['print-startup-performance']) {\n\t\tlet output = '';\n\t\toutput += `Start-up time: ${vscodeServerListenTime - vscodeServerStartTime}\\n`;\n\t\toutput += `Code loading time: ${vscodeServerCodeLoadedTime - vscodeServerStartTime}\\n`;\n\t\toutput += `Initialized time: ${currentTime - vscodeServerStartTime}\\n`;\n\t\toutput += `\\n`;\n\t\tconsole.log(output);\n\t}\n\treturn remoteExtensionHostAgentServer;\n}\n\nclass WebEndpointOriginChecker {\n\n\tpublic static create(productService: IProductService): WebEndpointOriginChecker {\n\t\tconst webEndpointUrlTemplate = productService.webEndpointUrlTemplate;\n\t\tconst commit = productService.commit;\n\t\tconst quality = productService.quality;\n\t\tif (!webEndpointUrlTemplate || !commit || !quality) {\n\t\t\treturn new WebEndpointOriginChecker(null);\n\t\t}\n\n\t\tconst uuid = generateUuid();\n\t\tconst exampleUrl = new URL(\n\t\t\twebEndpointUrlTemplate\n\t\t\t\t.replace('{{uuid}}', uuid)\n\t\t\t\t.replace('{{commit}}', commit)\n\t\t\t\t.replace('{{quality}}', quality)\n\t\t);\n\t\tconst exampleOrigin = exampleUrl.origin;\n\t\tconst originRegExpSource = (\n\t\t\tescapeRegExpCharacters(exampleOrigin)\n\t\t\t\t.replace(uuid, '[a-zA-Z0-9\\\\-]+')\n\t\t);\n\t\ttry {\n\t\t\tconst originRegExp = createRegExp(`^${originRegExpSource}$`, true, { matchCase: false });\n\t\t\treturn new WebEndpointOriginChecker(originRegExp);\n\t\t} catch (err) {\n\t\t\treturn new WebEndpointOriginChecker(null);\n\t\t}\n\t}\n\n\tconstructor(\n\t\tprivate readonly _originRegExp: RegExp | null\n\t) { }\n\n\tpublic matches(origin: string): boolean {\n\t\tif (!this._originRegExp) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this._originRegExp.test(origin);\n\t}\n}\n"]}