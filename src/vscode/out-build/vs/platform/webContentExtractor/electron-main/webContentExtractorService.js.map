{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/webContentExtractor/electron-main/webContentExtractorService.ts","vs/platform/webContentExtractor/electron-main/webContentExtractorService.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;AAEhG,OAAO,EAAE,aAAa,EAAkG,MAAM,UAAU,CAAC;AAEzI,OAAO,EAAE,GAAG,EAAE,MAAM,6BAA6B,CAAC;AAClD,OAAO,EAAU,uBAAuB,EAAE,MAAM,6BAA6B,CAAC;AAC9E,OAAO,EAAE,OAAO,EAAE,MAAM,+BAA+B,CAAC;AACxD,OAAO,EAAE,WAAW,EAAE,MAAM,6BAA6B,CAAC;AAC1D,OAAO,EAAE,WAAW,EAAE,MAAM,yBAAyB,CAAC;AACtD,OAAO,EAAE,eAAe,EAAE,YAAY,EAAE,MAAM,mCAAmC,CAAC;AAClF,OAAO,EAAE,iBAAiB,EAAE,MAAM,gCAAgC,CAAC;AACnE,OAAO,EAAE,YAAY,EAAE,MAAM,8BAA8B,CAAC;AAQrD,IAAM,gCAAgC,GAAtC,MAAM,gCAAgC;IAS5C,YAAyB,OAAqC;QAApB,YAAO,GAAP,OAAO,CAAa;QAN9D,8CAA8C;QAC9C,4DAA4D;QACpD,aAAQ,GAAG,IAAI,OAAO,CAA0B,CAAC,CAAC,CAAC;QACnD,sBAAiB,GAAG,IAAI,WAAW,EAAc,CAAC;QACzC,mBAAc,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,wBAAwB;IAEb,CAAC;IAE3D,SAAS,CAAC,KAAiB;QAClC,OAAO,IAAI,CAAC,GAAG,EAAE,GAAG,KAAK,CAAC,SAAS,GAAG,IAAI,CAAC,cAAc,CAAC;IAC3D,CAAC;IAED,OAAO,CAAC,IAAW,EAAE,OAAqC;QACzD,IAAI,IAAI,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YACvB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,oEAAoE,CAAC,CAAC;YACxF,OAAO,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QAC5B,CAAC;QACD,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,8DAA8D,IAAI,CAAC,MAAM,OAAO,CAAC,CAAC;QACpG,OAAO,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;IAChG,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,GAAQ,EAAE,OAAgD;QACzE,MAAM,MAAM,GAAG,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAC/C,IAAI,MAAM,EAAE,CAAC;YACZ,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,+DAA+D,GAAG,EAAE,CAAC,CAAC;YACxF,IAAI,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE,CAAC;gBAC5B,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,wDAAwD,GAAG,qBAAqB,CAAC,CAAC;gBACpG,IAAI,CAAC,iBAAiB,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;YACpC,CAAC;iBAAM,IAAI,CAAC,OAAO,EAAE,eAAe,IAAI,MAAM,CAAC,QAAQ,CAAC,SAAS,KAAK,GAAG,CAAC,SAAS,EAAE,CAAC;gBACrF,OAAO,EAAE,MAAM,EAAE,UAAU,EAAE,KAAK,EAAE,MAAM,CAAC,QAAQ,EAAE,CAAC;YACvD,CAAC;iBAAM,CAAC;gBACP,OAAO,EAAE,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,CAAC,MAAM,EAAE,CAAC;YAChD,CAAC;QACF,CAAC;QAED,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,8DAA8D,GAAG,KAAK,CAAC,CAAC;QAC1F,MAAM,KAAK,GAAG,IAAI,eAAe,EAAE,CAAC;QACpC,MAAM,GAAG,GAAG,IAAI,aAAa,CAAC;YAC7B,KAAK,EAAE,GAAG;YACV,MAAM,EAAE,GAAG;YACX,IAAI,EAAE,KAAK;YACX,cAAc,EAAE;gBACf,SAAS,EAAE,YAAY,EAAE,EAAE,2DAA2D;gBACtF,UAAU,EAAE,IAAI;gBAChB,SAAS,EAAE,IAAI;gBACf,OAAO,EAAE,IAAI;gBACb,KAAK,EAAE,KAAK;aACZ;SACD,CAAC,CAAC;QAEH,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,GAAG,EAAE,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;QAE7C,IAAI,CAAC;YACJ,MAAM,MAAM,GAAG,OAAO,EAAE,eAAe;gBACtC,CAAC,CAAC,MAAM,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,GAAG,CAAC;gBAChC,CAAC,CAAC,MAAM,OAAO,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,GAAG,EAAE,GAAG,EAAE,KAAK,CAAC,EAAE,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;YAE5F,IAAI,MAAM,CAAC,MAAM,KAAK,IAAI,EAAE,CAAC;gBAC5B,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,GAAG,EAAE,EAAE,MAAM,EAAE,MAAM,CAAC,MAAM,EAAE,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE,QAAQ,EAAE,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC;YAClI,CAAC;YAED,OAAO,MAAM,CAAC;QACf,CAAC;QAAC,OAAO,GAAG,EAAE,CAAC;YACd,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,oEAAoE,GAAG,KAAK,GAAG,EAAE,CAAC,CAAC;YACtG,OAAO,EAAE,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC;QAChD,CAAC;gBAAS,CAAC;YACV,KAAK,CAAC,OAAO,EAAE,CAAC;QACjB,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,SAAS,CAAC,GAAkB,EAAE,GAAQ;QACnD,MAAM,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC;QACtC,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QACvC,MAAM,MAAM,GAAwB,MAAM,GAAG,CAAC,WAAW,CAAC,QAAQ,CAAC,WAAW,CAAC,6BAA6B,CAAC,CAAC;QAC9G,MAAM,GAAG,GAAG,uBAAuB,CAAC,GAAG,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC;QACvD,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,6DAA6D,GAAG,EAAE,CAAC,CAAC;QACtF,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,yDAAyD,GAAG,EAAE,CAAC,CAAC;QACnF,OAAO,EAAE,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,GAAG,EAAE,CAAC;IACtC,CAAC;IAEO,kBAAkB,CAAC,GAAkB,EAAE,GAAQ,EAAE,KAAsB;QAC9E,OAAO,IAAI,OAAO,CAA0B,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YAC/D,MAAM,YAAY,GAAG,CAAC,CAAyF,EAAE,EAAE;gBAClH,MAAM,MAAM,GAAG,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;gBAChC,IAAI,MAAM,CAAC,SAAS,KAAK,GAAG,CAAC,SAAS,EAAE,CAAC;oBACxC,CAAC,CAAC,cAAc,EAAE,CAAC;oBACnB,OAAO,CAAC,EAAE,MAAM,EAAE,UAAU,EAAE,KAAK,EAAE,MAAM,EAAE,CAAC,CAAC;gBAChD,CAAC;YACF,CAAC,CAAC;YAEF,GAAG,CAAC,WAAW,CAAC,EAAE,CAAC,eAAe,EAAE,YAAY,CAAC,CAAC;YAClD,GAAG,CAAC,WAAW,CAAC,EAAE,CAAC,eAAe,EAAE,YAAY,CAAC,CAAC;YAElD,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,GAAG,EAAE;gBAC3B,MAAM,CAAC,IAAI,iBAAiB,EAAE,CAAC,CAAC;YACjC,CAAC,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACJ,CAAC;CACD,CAAA;AArGY,gCAAgC;IAS/B,WAAA,WAAW,CAAA;GATZ,gCAAgC,CAqG5C","file":"webContentExtractorService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { BrowserWindow, Event as ElectronEvent, WebContentsWillNavigateEventParams, WebContentsWillRedirectEventParams } from 'electron';\nimport { IWebContentExtractorOptions, IWebContentExtractorService, WebContentExtractResult } from '../common/webContentExtractor.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { AXNode, convertAXTreeToMarkdown } from './cdpAccessibilityDomain.js';\nimport { Limiter } from '../../../base/common/async.js';\nimport { ResourceMap } from '../../../base/common/map.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { DisposableStore, toDisposable } from '../../../base/common/lifecycle.js';\nimport { CancellationError } from '../../../base/common/errors.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\n\ninterface CacheEntry {\n\tresult: string;\n\ttimestamp: number;\n\tfinalURI: URI;\n}\n\nexport class NativeWebContentExtractorService implements IWebContentExtractorService {\n\t_serviceBrand: undefined;\n\n\t// Only allow 3 windows to be opened at a time\n\t// to avoid overwhelming the system with too many processes.\n\tprivate _limiter = new Limiter<WebContentExtractResult>(3);\n\tprivate _webContentsCache = new ResourceMap<CacheEntry>();\n\tprivate readonly _cacheDuration = 24 * 60 * 60 * 1000; // 1 day in milliseconds\n\n\tconstructor(@ILogService private readonly _logger: ILogService) { }\n\n\tprivate isExpired(entry: CacheEntry): boolean {\n\t\treturn Date.now() - entry.timestamp > this._cacheDuration;\n\t}\n\n\textract(uris: URI[], options?: IWebContentExtractorOptions): Promise<WebContentExtractResult[]> {\n\t\tif (uris.length === 0) {\n\t\t\tthis._logger.info('[NativeWebContentExtractorService] No URIs provided for extraction');\n\t\t\treturn Promise.resolve([]);\n\t\t}\n\t\tthis._logger.info(`[NativeWebContentExtractorService] Extracting content from ${uris.length} URIs`);\n\t\treturn Promise.all(uris.map((uri) => this._limiter.queue(() => this.doExtract(uri, options))));\n\t}\n\n\tasync doExtract(uri: URI, options: IWebContentExtractorOptions | undefined): Promise<WebContentExtractResult> {\n\t\tconst cached = this._webContentsCache.get(uri);\n\t\tif (cached) {\n\t\t\tthis._logger.info(`[NativeWebContentExtractorService] Found cached content for ${uri}`);\n\t\t\tif (this.isExpired(cached)) {\n\t\t\t\tthis._logger.info(`[NativeWebContentExtractorService] Cache expired for ${uri}, removing entry...`);\n\t\t\t\tthis._webContentsCache.delete(uri);\n\t\t\t} else if (!options?.followRedirects && cached.finalURI.authority !== uri.authority) {\n\t\t\t\treturn { status: 'redirect', toURI: cached.finalURI };\n\t\t\t} else {\n\t\t\t\treturn { status: 'ok', result: cached.result };\n\t\t\t}\n\t\t}\n\n\t\tthis._logger.info(`[NativeWebContentExtractorService] Extracting content from ${uri}...`);\n\t\tconst store = new DisposableStore();\n\t\tconst win = new BrowserWindow({\n\t\t\twidth: 800,\n\t\t\theight: 600,\n\t\t\tshow: false,\n\t\t\twebPreferences: {\n\t\t\t\tpartition: generateUuid(), // do not share any state with the default renderer session\n\t\t\t\tjavascript: true,\n\t\t\t\toffscreen: true,\n\t\t\t\tsandbox: true,\n\t\t\t\twebgl: false\n\t\t\t}\n\t\t});\n\n\t\tstore.add(toDisposable(() => win.destroy()));\n\n\t\ttry {\n\t\t\tconst result = options?.followRedirects\n\t\t\t\t? await this.extractAX(win, uri)\n\t\t\t\t: await Promise.race([this.interceptRedirects(win, uri, store), this.extractAX(win, uri)]);\n\n\t\t\tif (result.status === 'ok') {\n\t\t\t\tthis._webContentsCache.set(uri, { result: result.result, timestamp: Date.now(), finalURI: URI.parse(win.webContents.getURL()) });\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (err) {\n\t\t\tthis._logger.error(`[NativeWebContentExtractorService] Error extracting content from ${uri}: ${err}`);\n\t\t\treturn { status: 'error', error: String(err) };\n\t\t} finally {\n\t\t\tstore.dispose();\n\t\t}\n\t}\n\n\tprivate async extractAX(win: BrowserWindow, uri: URI): Promise<WebContentExtractResult> {\n\t\tawait win.loadURL(uri.toString(true));\n\t\twin.webContents.debugger.attach('1.1');\n\t\tconst result: { nodes: AXNode[] } = await win.webContents.debugger.sendCommand('Accessibility.getFullAXTree');\n\t\tconst str = convertAXTreeToMarkdown(uri, result.nodes);\n\t\tthis._logger.info(`[NativeWebContentExtractorService] Content extracted from ${uri}`);\n\t\tthis._logger.trace(`[NativeWebContentExtractorService] Extracted content: ${str}`);\n\t\treturn { status: 'ok', result: str };\n\t}\n\n\tprivate interceptRedirects(win: BrowserWindow, uri: URI, store: DisposableStore) {\n\t\treturn new Promise<WebContentExtractResult>((resolve, reject) => {\n\t\t\tconst onNavigation = (e: ElectronEvent<WebContentsWillNavigateEventParams | WebContentsWillRedirectEventParams>) => {\n\t\t\t\tconst newURI = URI.parse(e.url);\n\t\t\t\tif (newURI.authority !== uri.authority) {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tresolve({ status: 'redirect', toURI: newURI });\n\t\t\t\t}\n\t\t\t};\n\n\t\t\twin.webContents.on('will-navigate', onNavigation);\n\t\t\twin.webContents.on('will-redirect', onNavigation);\n\n\t\t\tstore.add(toDisposable(() => {\n\t\t\t\treject(new CancellationError());\n\t\t\t}));\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { BrowserWindow, Event as ElectronEvent, WebContentsWillNavigateEventParams, WebContentsWillRedirectEventParams } from 'electron';\nimport { IWebContentExtractorOptions, IWebContentExtractorService, WebContentExtractResult } from '../common/webContentExtractor.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { AXNode, convertAXTreeToMarkdown } from './cdpAccessibilityDomain.js';\nimport { Limiter } from '../../../base/common/async.js';\nimport { ResourceMap } from '../../../base/common/map.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { DisposableStore, toDisposable } from '../../../base/common/lifecycle.js';\nimport { CancellationError } from '../../../base/common/errors.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\n\ninterface CacheEntry {\n\tresult: string;\n\ttimestamp: number;\n\tfinalURI: URI;\n}\n\nexport class NativeWebContentExtractorService implements IWebContentExtractorService {\n\t_serviceBrand: undefined;\n\n\t// Only allow 3 windows to be opened at a time\n\t// to avoid overwhelming the system with too many processes.\n\tprivate _limiter = new Limiter<WebContentExtractResult>(3);\n\tprivate _webContentsCache = new ResourceMap<CacheEntry>();\n\tprivate readonly _cacheDuration = 24 * 60 * 60 * 1000; // 1 day in milliseconds\n\n\tconstructor(@ILogService private readonly _logger: ILogService) { }\n\n\tprivate isExpired(entry: CacheEntry): boolean {\n\t\treturn Date.now() - entry.timestamp > this._cacheDuration;\n\t}\n\n\textract(uris: URI[], options?: IWebContentExtractorOptions): Promise<WebContentExtractResult[]> {\n\t\tif (uris.length === 0) {\n\t\t\tthis._logger.info('[NativeWebContentExtractorService] No URIs provided for extraction');\n\t\t\treturn Promise.resolve([]);\n\t\t}\n\t\tthis._logger.info(`[NativeWebContentExtractorService] Extracting content from ${uris.length} URIs`);\n\t\treturn Promise.all(uris.map((uri) => this._limiter.queue(() => this.doExtract(uri, options))));\n\t}\n\n\tasync doExtract(uri: URI, options: IWebContentExtractorOptions | undefined): Promise<WebContentExtractResult> {\n\t\tconst cached = this._webContentsCache.get(uri);\n\t\tif (cached) {\n\t\t\tthis._logger.info(`[NativeWebContentExtractorService] Found cached content for ${uri}`);\n\t\t\tif (this.isExpired(cached)) {\n\t\t\t\tthis._logger.info(`[NativeWebContentExtractorService] Cache expired for ${uri}, removing entry...`);\n\t\t\t\tthis._webContentsCache.delete(uri);\n\t\t\t} else if (!options?.followRedirects && cached.finalURI.authority !== uri.authority) {\n\t\t\t\treturn { status: 'redirect', toURI: cached.finalURI };\n\t\t\t} else {\n\t\t\t\treturn { status: 'ok', result: cached.result };\n\t\t\t}\n\t\t}\n\n\t\tthis._logger.info(`[NativeWebContentExtractorService] Extracting content from ${uri}...`);\n\t\tconst store = new DisposableStore();\n\t\tconst win = new BrowserWindow({\n\t\t\twidth: 800,\n\t\t\theight: 600,\n\t\t\tshow: false,\n\t\t\twebPreferences: {\n\t\t\t\tpartition: generateUuid(), // do not share any state with the default renderer session\n\t\t\t\tjavascript: true,\n\t\t\t\toffscreen: true,\n\t\t\t\tsandbox: true,\n\t\t\t\twebgl: false\n\t\t\t}\n\t\t});\n\n\t\tstore.add(toDisposable(() => win.destroy()));\n\n\t\ttry {\n\t\t\tconst result = options?.followRedirects\n\t\t\t\t? await this.extractAX(win, uri)\n\t\t\t\t: await Promise.race([this.interceptRedirects(win, uri, store), this.extractAX(win, uri)]);\n\n\t\t\tif (result.status === 'ok') {\n\t\t\t\tthis._webContentsCache.set(uri, { result: result.result, timestamp: Date.now(), finalURI: URI.parse(win.webContents.getURL()) });\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (err) {\n\t\t\tthis._logger.error(`[NativeWebContentExtractorService] Error extracting content from ${uri}: ${err}`);\n\t\t\treturn { status: 'error', error: String(err) };\n\t\t} finally {\n\t\t\tstore.dispose();\n\t\t}\n\t}\n\n\tprivate async extractAX(win: BrowserWindow, uri: URI): Promise<WebContentExtractResult> {\n\t\tawait win.loadURL(uri.toString(true));\n\t\twin.webContents.debugger.attach('1.1');\n\t\tconst result: { nodes: AXNode[] } = await win.webContents.debugger.sendCommand('Accessibility.getFullAXTree');\n\t\tconst str = convertAXTreeToMarkdown(uri, result.nodes);\n\t\tthis._logger.info(`[NativeWebContentExtractorService] Content extracted from ${uri}`);\n\t\tthis._logger.trace(`[NativeWebContentExtractorService] Extracted content: ${str}`);\n\t\treturn { status: 'ok', result: str };\n\t}\n\n\tprivate interceptRedirects(win: BrowserWindow, uri: URI, store: DisposableStore) {\n\t\treturn new Promise<WebContentExtractResult>((resolve, reject) => {\n\t\t\tconst onNavigation = (e: ElectronEvent<WebContentsWillNavigateEventParams | WebContentsWillRedirectEventParams>) => {\n\t\t\t\tconst newURI = URI.parse(e.url);\n\t\t\t\tif (newURI.authority !== uri.authority) {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tresolve({ status: 'redirect', toURI: newURI });\n\t\t\t\t}\n\t\t\t};\n\n\t\t\twin.webContents.on('will-navigate', onNavigation);\n\t\t\twin.webContents.on('will-redirect', onNavigation);\n\n\t\t\tstore.add(toDisposable(() => {\n\t\t\t\treject(new CancellationError());\n\t\t\t}));\n\t\t});\n\t}\n}\n"]}