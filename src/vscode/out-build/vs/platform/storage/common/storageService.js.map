{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/storage/common/storageService.ts","vs/platform/storage/common/storageService.ts"],"names":[],"mappings":"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","file":"storageService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Promises } from '../../../base/common/async.js';\nimport { DisposableStore } from '../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { joinPath } from '../../../base/common/resources.js';\nimport { IStorage, Storage } from '../../../base/parts/storage/common/storage.js';\nimport { IEnvironmentService } from '../../environment/common/environment.js';\nimport { IRemoteService } from '../../ipc/common/services.js';\nimport { AbstractStorageService, isProfileUsingDefaultStorage, StorageScope, WillSaveStateReason } from './storage.js';\nimport { ApplicationStorageDatabaseClient, ProfileStorageDatabaseClient, WorkspaceStorageDatabaseClient } from './storageIpc.js';\nimport { isUserDataProfile, IUserDataProfile } from '../../userDataProfile/common/userDataProfile.js';\nimport { IAnyWorkspaceIdentifier } from '../../workspace/common/workspace.js';\n\nexport class RemoteStorageService extends AbstractStorageService {\n\n\tprivate readonly applicationStorageProfile: IUserDataProfile;\n\tprivate readonly applicationStorage: IStorage;\n\n\tprivate profileStorageProfile: IUserDataProfile;\n\tprivate readonly profileStorageDisposables = this._register(new DisposableStore());\n\tprivate profileStorage: IStorage;\n\n\tprivate workspaceStorageId: string | undefined;\n\tprivate readonly workspaceStorageDisposables = this._register(new DisposableStore());\n\tprivate workspaceStorage: IStorage | undefined;\n\n\tconstructor(\n\t\tinitialWorkspace: IAnyWorkspaceIdentifier | undefined,\n\t\tinitialProfiles: { defaultProfile: IUserDataProfile; currentProfile: IUserDataProfile },\n\t\tprivate readonly remoteService: IRemoteService,\n\t\tprivate readonly environmentService: IEnvironmentService\n\t) {\n\t\tsuper();\n\n\t\tthis.applicationStorageProfile = initialProfiles.defaultProfile;\n\t\tthis.applicationStorage = this.createApplicationStorage();\n\n\t\tthis.profileStorageProfile = initialProfiles.currentProfile;\n\t\tthis.profileStorage = this.createProfileStorage(this.profileStorageProfile);\n\n\t\tthis.workspaceStorageId = initialWorkspace?.id;\n\t\tthis.workspaceStorage = this.createWorkspaceStorage(initialWorkspace);\n\t}\n\n\tprivate createApplicationStorage(): IStorage {\n\t\tconst storageDataBaseClient = this._register(new ApplicationStorageDatabaseClient(this.remoteService.getChannel('storage')));\n\t\tconst applicationStorage = this._register(new Storage(storageDataBaseClient));\n\n\t\tthis._register(applicationStorage.onDidChangeStorage(e => this.emitDidChangeValue(StorageScope.APPLICATION, e)));\n\n\t\treturn applicationStorage;\n\t}\n\n\tprivate createProfileStorage(profile: IUserDataProfile): IStorage {\n\n\t\t// First clear any previously associated disposables\n\t\tthis.profileStorageDisposables.clear();\n\n\t\t// Remember profile associated to profile storage\n\t\tthis.profileStorageProfile = profile;\n\n\t\tlet profileStorage: IStorage;\n\t\tif (isProfileUsingDefaultStorage(profile)) {\n\n\t\t\t// If we are using default profile storage, the profile storage is\n\t\t\t// actually the same as application storage. As such we\n\t\t\t// avoid creating the storage library a second time on\n\t\t\t// the same DB.\n\n\t\t\tprofileStorage = this.applicationStorage;\n\t\t} else {\n\t\t\tconst storageDataBaseClient = this.profileStorageDisposables.add(new ProfileStorageDatabaseClient(this.remoteService.getChannel('storage'), profile));\n\t\t\tprofileStorage = this.profileStorageDisposables.add(new Storage(storageDataBaseClient));\n\t\t}\n\n\t\tthis.profileStorageDisposables.add(profileStorage.onDidChangeStorage(e => this.emitDidChangeValue(StorageScope.PROFILE, e)));\n\n\t\treturn profileStorage;\n\t}\n\n\tprivate createWorkspaceStorage(workspace: IAnyWorkspaceIdentifier): IStorage;\n\tprivate createWorkspaceStorage(workspace: IAnyWorkspaceIdentifier | undefined): IStorage | undefined;\n\tprivate createWorkspaceStorage(workspace: IAnyWorkspaceIdentifier | undefined): IStorage | undefined {\n\n\t\t// First clear any previously associated disposables\n\t\tthis.workspaceStorageDisposables.clear();\n\n\t\t// Remember workspace ID for logging later\n\t\tthis.workspaceStorageId = workspace?.id;\n\n\t\tlet workspaceStorage: IStorage | undefined = undefined;\n\t\tif (workspace) {\n\t\t\tconst storageDataBaseClient = this.workspaceStorageDisposables.add(new WorkspaceStorageDatabaseClient(this.remoteService.getChannel('storage'), workspace));\n\t\t\tworkspaceStorage = this.workspaceStorageDisposables.add(new Storage(storageDataBaseClient));\n\n\t\t\tthis.workspaceStorageDisposables.add(workspaceStorage.onDidChangeStorage(e => this.emitDidChangeValue(StorageScope.WORKSPACE, e)));\n\t\t}\n\n\t\treturn workspaceStorage;\n\t}\n\n\tprotected async doInitialize(): Promise<void> {\n\n\t\t// Init all storage locations\n\t\tawait Promises.settled([\n\t\t\tthis.applicationStorage.init(),\n\t\t\tthis.profileStorage.init(),\n\t\t\tthis.workspaceStorage?.init() ?? Promise.resolve()\n\t\t]);\n\t}\n\n\tprotected getStorage(scope: StorageScope): IStorage | undefined {\n\t\tswitch (scope) {\n\t\t\tcase StorageScope.APPLICATION:\n\t\t\t\treturn this.applicationStorage;\n\t\t\tcase StorageScope.PROFILE:\n\t\t\t\treturn this.profileStorage;\n\t\t\tdefault:\n\t\t\t\treturn this.workspaceStorage;\n\t\t}\n\t}\n\n\tprotected getLogDetails(scope: StorageScope): string | undefined {\n\t\tswitch (scope) {\n\t\t\tcase StorageScope.APPLICATION:\n\t\t\t\treturn this.applicationStorageProfile.globalStorageHome.with({ scheme: Schemas.file }).fsPath;\n\t\t\tcase StorageScope.PROFILE:\n\t\t\t\treturn this.profileStorageProfile?.globalStorageHome.with({ scheme: Schemas.file }).fsPath;\n\t\t\tdefault:\n\t\t\t\treturn this.workspaceStorageId ? `${joinPath(this.environmentService.workspaceStorageHome, this.workspaceStorageId, 'state.vscdb').with({ scheme: Schemas.file }).fsPath}` : undefined;\n\t\t}\n\t}\n\n\tasync close(): Promise<void> {\n\n\t\t// Stop periodic scheduler and idle runner as we now collect state normally\n\t\tthis.stopFlushWhenIdle();\n\n\t\t// Signal as event so that clients can still store data\n\t\tthis.emitWillSaveState(WillSaveStateReason.SHUTDOWN);\n\n\t\t// Do it\n\t\tawait Promises.settled([\n\t\t\tthis.applicationStorage.close(),\n\t\t\tthis.profileStorage.close(),\n\t\t\tthis.workspaceStorage?.close() ?? Promise.resolve()\n\t\t]);\n\t}\n\n\tprotected async switchToProfile(toProfile: IUserDataProfile): Promise<void> {\n\t\tif (!this.canSwitchProfile(this.profileStorageProfile, toProfile)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst oldProfileStorage = this.profileStorage;\n\t\tconst oldItems = oldProfileStorage.items;\n\n\t\t// Close old profile storage but only if this is\n\t\t// different from application storage!\n\t\tif (oldProfileStorage !== this.applicationStorage) {\n\t\t\tawait oldProfileStorage.close();\n\t\t}\n\n\t\t// Create new profile storage & init\n\t\tthis.profileStorage = this.createProfileStorage(toProfile);\n\t\tawait this.profileStorage.init();\n\n\t\t// Handle data switch and eventing\n\t\tthis.switchData(oldItems, this.profileStorage, StorageScope.PROFILE);\n\t}\n\n\tprotected async switchToWorkspace(toWorkspace: IAnyWorkspaceIdentifier, preserveData: boolean): Promise<void> {\n\t\tconst oldWorkspaceStorage = this.workspaceStorage;\n\t\tconst oldItems = oldWorkspaceStorage?.items ?? new Map();\n\n\t\t// Close old workspace storage\n\t\tawait oldWorkspaceStorage?.close();\n\n\t\t// Create new workspace storage & init\n\t\tthis.workspaceStorage = this.createWorkspaceStorage(toWorkspace);\n\t\tawait this.workspaceStorage.init();\n\n\t\t// Handle data switch and eventing\n\t\tthis.switchData(oldItems, this.workspaceStorage, StorageScope.WORKSPACE);\n\t}\n\n\thasScope(scope: IAnyWorkspaceIdentifier | IUserDataProfile): boolean {\n\t\tif (isUserDataProfile(scope)) {\n\t\t\treturn this.profileStorageProfile.id === scope.id;\n\t\t}\n\n\t\treturn this.workspaceStorageId === scope.id;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Promises } from '../../../base/common/async.js';\nimport { DisposableStore } from '../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { joinPath } from '../../../base/common/resources.js';\nimport { IStorage, Storage } from '../../../base/parts/storage/common/storage.js';\nimport { IEnvironmentService } from '../../environment/common/environment.js';\nimport { IRemoteService } from '../../ipc/common/services.js';\nimport { AbstractStorageService, isProfileUsingDefaultStorage, StorageScope, WillSaveStateReason } from './storage.js';\nimport { ApplicationStorageDatabaseClient, ProfileStorageDatabaseClient, WorkspaceStorageDatabaseClient } from './storageIpc.js';\nimport { isUserDataProfile, IUserDataProfile } from '../../userDataProfile/common/userDataProfile.js';\nimport { IAnyWorkspaceIdentifier } from '../../workspace/common/workspace.js';\n\nexport class RemoteStorageService extends AbstractStorageService {\n\n\tprivate readonly applicationStorageProfile: IUserDataProfile;\n\tprivate readonly applicationStorage: IStorage;\n\n\tprivate profileStorageProfile: IUserDataProfile;\n\tprivate readonly profileStorageDisposables = this._register(new DisposableStore());\n\tprivate profileStorage: IStorage;\n\n\tprivate workspaceStorageId: string | undefined;\n\tprivate readonly workspaceStorageDisposables = this._register(new DisposableStore());\n\tprivate workspaceStorage: IStorage | undefined;\n\n\tconstructor(\n\t\tinitialWorkspace: IAnyWorkspaceIdentifier | undefined,\n\t\tinitialProfiles: { defaultProfile: IUserDataProfile; currentProfile: IUserDataProfile },\n\t\tprivate readonly remoteService: IRemoteService,\n\t\tprivate readonly environmentService: IEnvironmentService\n\t) {\n\t\tsuper();\n\n\t\tthis.applicationStorageProfile = initialProfiles.defaultProfile;\n\t\tthis.applicationStorage = this.createApplicationStorage();\n\n\t\tthis.profileStorageProfile = initialProfiles.currentProfile;\n\t\tthis.profileStorage = this.createProfileStorage(this.profileStorageProfile);\n\n\t\tthis.workspaceStorageId = initialWorkspace?.id;\n\t\tthis.workspaceStorage = this.createWorkspaceStorage(initialWorkspace);\n\t}\n\n\tprivate createApplicationStorage(): IStorage {\n\t\tconst storageDataBaseClient = this._register(new ApplicationStorageDatabaseClient(this.remoteService.getChannel('storage')));\n\t\tconst applicationStorage = this._register(new Storage(storageDataBaseClient));\n\n\t\tthis._register(applicationStorage.onDidChangeStorage(e => this.emitDidChangeValue(StorageScope.APPLICATION, e)));\n\n\t\treturn applicationStorage;\n\t}\n\n\tprivate createProfileStorage(profile: IUserDataProfile): IStorage {\n\n\t\t// First clear any previously associated disposables\n\t\tthis.profileStorageDisposables.clear();\n\n\t\t// Remember profile associated to profile storage\n\t\tthis.profileStorageProfile = profile;\n\n\t\tlet profileStorage: IStorage;\n\t\tif (isProfileUsingDefaultStorage(profile)) {\n\n\t\t\t// If we are using default profile storage, the profile storage is\n\t\t\t// actually the same as application storage. As such we\n\t\t\t// avoid creating the storage library a second time on\n\t\t\t// the same DB.\n\n\t\t\tprofileStorage = this.applicationStorage;\n\t\t} else {\n\t\t\tconst storageDataBaseClient = this.profileStorageDisposables.add(new ProfileStorageDatabaseClient(this.remoteService.getChannel('storage'), profile));\n\t\t\tprofileStorage = this.profileStorageDisposables.add(new Storage(storageDataBaseClient));\n\t\t}\n\n\t\tthis.profileStorageDisposables.add(profileStorage.onDidChangeStorage(e => this.emitDidChangeValue(StorageScope.PROFILE, e)));\n\n\t\treturn profileStorage;\n\t}\n\n\tprivate createWorkspaceStorage(workspace: IAnyWorkspaceIdentifier): IStorage;\n\tprivate createWorkspaceStorage(workspace: IAnyWorkspaceIdentifier | undefined): IStorage | undefined;\n\tprivate createWorkspaceStorage(workspace: IAnyWorkspaceIdentifier | undefined): IStorage | undefined {\n\n\t\t// First clear any previously associated disposables\n\t\tthis.workspaceStorageDisposables.clear();\n\n\t\t// Remember workspace ID for logging later\n\t\tthis.workspaceStorageId = workspace?.id;\n\n\t\tlet workspaceStorage: IStorage | undefined = undefined;\n\t\tif (workspace) {\n\t\t\tconst storageDataBaseClient = this.workspaceStorageDisposables.add(new WorkspaceStorageDatabaseClient(this.remoteService.getChannel('storage'), workspace));\n\t\t\tworkspaceStorage = this.workspaceStorageDisposables.add(new Storage(storageDataBaseClient));\n\n\t\t\tthis.workspaceStorageDisposables.add(workspaceStorage.onDidChangeStorage(e => this.emitDidChangeValue(StorageScope.WORKSPACE, e)));\n\t\t}\n\n\t\treturn workspaceStorage;\n\t}\n\n\tprotected async doInitialize(): Promise<void> {\n\n\t\t// Init all storage locations\n\t\tawait Promises.settled([\n\t\t\tthis.applicationStorage.init(),\n\t\t\tthis.profileStorage.init(),\n\t\t\tthis.workspaceStorage?.init() ?? Promise.resolve()\n\t\t]);\n\t}\n\n\tprotected getStorage(scope: StorageScope): IStorage | undefined {\n\t\tswitch (scope) {\n\t\t\tcase StorageScope.APPLICATION:\n\t\t\t\treturn this.applicationStorage;\n\t\t\tcase StorageScope.PROFILE:\n\t\t\t\treturn this.profileStorage;\n\t\t\tdefault:\n\t\t\t\treturn this.workspaceStorage;\n\t\t}\n\t}\n\n\tprotected getLogDetails(scope: StorageScope): string | undefined {\n\t\tswitch (scope) {\n\t\t\tcase StorageScope.APPLICATION:\n\t\t\t\treturn this.applicationStorageProfile.globalStorageHome.with({ scheme: Schemas.file }).fsPath;\n\t\t\tcase StorageScope.PROFILE:\n\t\t\t\treturn this.profileStorageProfile?.globalStorageHome.with({ scheme: Schemas.file }).fsPath;\n\t\t\tdefault:\n\t\t\t\treturn this.workspaceStorageId ? `${joinPath(this.environmentService.workspaceStorageHome, this.workspaceStorageId, 'state.vscdb').with({ scheme: Schemas.file }).fsPath}` : undefined;\n\t\t}\n\t}\n\n\tasync close(): Promise<void> {\n\n\t\t// Stop periodic scheduler and idle runner as we now collect state normally\n\t\tthis.stopFlushWhenIdle();\n\n\t\t// Signal as event so that clients can still store data\n\t\tthis.emitWillSaveState(WillSaveStateReason.SHUTDOWN);\n\n\t\t// Do it\n\t\tawait Promises.settled([\n\t\t\tthis.applicationStorage.close(),\n\t\t\tthis.profileStorage.close(),\n\t\t\tthis.workspaceStorage?.close() ?? Promise.resolve()\n\t\t]);\n\t}\n\n\tprotected async switchToProfile(toProfile: IUserDataProfile): Promise<void> {\n\t\tif (!this.canSwitchProfile(this.profileStorageProfile, toProfile)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst oldProfileStorage = this.profileStorage;\n\t\tconst oldItems = oldProfileStorage.items;\n\n\t\t// Close old profile storage but only if this is\n\t\t// different from application storage!\n\t\tif (oldProfileStorage !== this.applicationStorage) {\n\t\t\tawait oldProfileStorage.close();\n\t\t}\n\n\t\t// Create new profile storage & init\n\t\tthis.profileStorage = this.createProfileStorage(toProfile);\n\t\tawait this.profileStorage.init();\n\n\t\t// Handle data switch and eventing\n\t\tthis.switchData(oldItems, this.profileStorage, StorageScope.PROFILE);\n\t}\n\n\tprotected async switchToWorkspace(toWorkspace: IAnyWorkspaceIdentifier, preserveData: boolean): Promise<void> {\n\t\tconst oldWorkspaceStorage = this.workspaceStorage;\n\t\tconst oldItems = oldWorkspaceStorage?.items ?? new Map();\n\n\t\t// Close old workspace storage\n\t\tawait oldWorkspaceStorage?.close();\n\n\t\t// Create new workspace storage & init\n\t\tthis.workspaceStorage = this.createWorkspaceStorage(toWorkspace);\n\t\tawait this.workspaceStorage.init();\n\n\t\t// Handle data switch and eventing\n\t\tthis.switchData(oldItems, this.workspaceStorage, StorageScope.WORKSPACE);\n\t}\n\n\thasScope(scope: IAnyWorkspaceIdentifier | IUserDataProfile): boolean {\n\t\tif (isUserDataProfile(scope)) {\n\t\t\treturn this.profileStorageProfile.id === scope.id;\n\t\t}\n\n\t\treturn this.workspaceStorageId === scope.id;\n\t}\n}\n"]}