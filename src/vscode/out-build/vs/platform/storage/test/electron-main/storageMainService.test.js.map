{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/storage/test/electron-main/storageMainService.test.ts","vs/platform/storage/test/electron-main/storageMainService.test.ts"],"names":[],"mappings":"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","file":"storageMainService.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { notStrictEqual, strictEqual } from 'assert';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { joinPath } from '../../../../base/common/resources.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { OPTIONS, parseArgs } from '../../../environment/node/argv.js';\nimport { NativeEnvironmentService } from '../../../environment/node/environmentService.js';\nimport { FileService } from '../../../files/common/fileService.js';\nimport { ILifecycleMainService } from '../../../lifecycle/electron-main/lifecycleMainService.js';\nimport { NullLogService } from '../../../log/common/log.js';\nimport product from '../../../product/common/product.js';\nimport { IProductService } from '../../../product/common/productService.js';\nimport { SaveStrategy, StateService } from '../../../state/node/stateService.js';\nimport { IS_NEW_KEY, StorageScope } from '../../common/storage.js';\nimport { IStorageChangeEvent, IStorageMain, IStorageMainOptions } from '../../electron-main/storageMain.js';\nimport { StorageMainService } from '../../electron-main/storageMainService.js';\nimport { currentSessionDateStorageKey, firstSessionDateStorageKey } from '../../../telemetry/common/telemetry.js';\nimport { UriIdentityService } from '../../../uriIdentity/common/uriIdentityService.js';\nimport { IUserDataProfile } from '../../../userDataProfile/common/userDataProfile.js';\nimport { UserDataProfilesMainService } from '../../../userDataProfile/electron-main/userDataProfile.js';\nimport { TestLifecycleMainService } from '../../../test/electron-main/workbenchTestServices.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\n\nsuite('StorageMainService', function () {\n\n\tconst disposables = new DisposableStore();\n\n\tconst productService: IProductService = { _serviceBrand: undefined, ...product };\n\n\tconst inMemoryProfileRoot = URI.file('/location').with({ scheme: Schemas.inMemory });\n\tconst inMemoryProfile: IUserDataProfile = {\n\t\tid: 'id',\n\t\tname: 'inMemory',\n\t\tisDefault: false,\n\t\tlocation: inMemoryProfileRoot,\n\t\tglobalStorageHome: joinPath(inMemoryProfileRoot, 'globalStorageHome'),\n\t\tsettingsResource: joinPath(inMemoryProfileRoot, 'settingsResource'),\n\t\tkeybindingsResource: joinPath(inMemoryProfileRoot, 'keybindingsResource'),\n\t\ttasksResource: joinPath(inMemoryProfileRoot, 'tasksResource'),\n\t\tmcpResource: joinPath(inMemoryProfileRoot, 'mcp.json'),\n\t\tsnippetsHome: joinPath(inMemoryProfileRoot, 'snippetsHome'),\n\t\tpromptsHome: joinPath(inMemoryProfileRoot, 'promptsHome'),\n\t\textensionsResource: joinPath(inMemoryProfileRoot, 'extensionsResource'),\n\t\tcacheHome: joinPath(inMemoryProfileRoot, 'cache'),\n\t};\n\n\tclass TestStorageMainService extends StorageMainService {\n\n\t\tprotected override getStorageOptions(): IStorageMainOptions {\n\t\t\treturn {\n\t\t\t\tuseInMemoryStorage: true\n\t\t\t};\n\t\t}\n\t}\n\n\tasync function testStorage(storage: IStorageMain, scope: StorageScope): Promise<void> {\n\t\tstrictEqual(storage.isInMemory(), true);\n\n\t\t// Telemetry: added after init unless workspace/profile scoped\n\t\tif (scope === StorageScope.APPLICATION) {\n\t\t\tstrictEqual(storage.items.size, 0);\n\t\t\tawait storage.init();\n\t\t\tstrictEqual(typeof storage.get(firstSessionDateStorageKey), 'string');\n\t\t\tstrictEqual(typeof storage.get(currentSessionDateStorageKey), 'string');\n\t\t} else {\n\t\t\tawait storage.init();\n\t\t}\n\n\t\tlet storageChangeEvent: IStorageChangeEvent | undefined = undefined;\n\t\tdisposables.add(storage.onDidChangeStorage(e => {\n\t\t\tstorageChangeEvent = e;\n\t\t}));\n\n\t\tlet storageDidClose = false;\n\t\tdisposables.add(storage.onDidCloseStorage(() => storageDidClose = true));\n\n\t\t// Basic store/get/remove\n\t\tconst size = storage.items.size;\n\n\t\tstorage.set('bar', 'foo');\n\t\tstrictEqual(storageChangeEvent!.key, 'bar');\n\t\tstorage.set('barNumber', 55);\n\t\tstorage.set('barBoolean', true);\n\n\t\tstrictEqual(storage.get('bar'), 'foo');\n\t\tstrictEqual(storage.get('barNumber'), '55');\n\t\tstrictEqual(storage.get('barBoolean'), 'true');\n\n\t\tstrictEqual(storage.items.size, size + 3);\n\n\t\tstorage.delete('bar');\n\t\tstrictEqual(storage.get('bar'), undefined);\n\n\t\tstrictEqual(storage.items.size, size + 2);\n\n\t\t// IS_NEW\n\t\tstrictEqual(storage.get(IS_NEW_KEY), 'true');\n\n\t\t// Close\n\t\tawait storage.close();\n\n\t\tstrictEqual(storageDidClose, true);\n\t}\n\n\tteardown(() => {\n\t\tdisposables.clear();\n\t});\n\n\tfunction createStorageService(lifecycleMainService: ILifecycleMainService = new TestLifecycleMainService()): TestStorageMainService {\n\t\tconst environmentService = new NativeEnvironmentService(parseArgs(process.argv, OPTIONS), productService);\n\t\tconst fileService = disposables.add(new FileService(new NullLogService()));\n\t\tconst uriIdentityService = disposables.add(new UriIdentityService(fileService));\n\t\tconst testStorageService = disposables.add(new TestStorageMainService(new NullLogService(), environmentService, disposables.add(new UserDataProfilesMainService(disposables.add(new StateService(SaveStrategy.DELAYED, environmentService, new NullLogService(), fileService)), disposables.add(uriIdentityService), environmentService, fileService, new NullLogService())), lifecycleMainService, fileService, uriIdentityService));\n\n\t\tdisposables.add(testStorageService.applicationStorage);\n\n\t\treturn testStorageService;\n\t}\n\n\ttest('basics (application)', function () {\n\t\tconst storageMainService = createStorageService();\n\n\t\treturn testStorage(storageMainService.applicationStorage, StorageScope.APPLICATION);\n\t});\n\n\ttest('basics (profile)', function () {\n\t\tconst storageMainService = createStorageService();\n\t\tconst profile = inMemoryProfile;\n\n\t\treturn testStorage(storageMainService.profileStorage(profile), StorageScope.PROFILE);\n\t});\n\n\ttest('basics (workspace)', function () {\n\t\tconst workspace = { id: generateUuid() };\n\t\tconst storageMainService = createStorageService();\n\n\t\treturn testStorage(storageMainService.workspaceStorage(workspace), StorageScope.WORKSPACE);\n\t});\n\n\ttest('storage closed onWillShutdown', async function () {\n\t\tconst lifecycleMainService = new TestLifecycleMainService();\n\t\tconst storageMainService = createStorageService(lifecycleMainService);\n\n\t\tconst profile = inMemoryProfile;\n\t\tconst workspace = { id: generateUuid() };\n\n\t\tconst workspaceStorage = storageMainService.workspaceStorage(workspace);\n\t\tlet didCloseWorkspaceStorage = false;\n\t\tdisposables.add(workspaceStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseWorkspaceStorage = true;\n\t\t}));\n\n\t\tconst profileStorage = storageMainService.profileStorage(profile);\n\t\tlet didCloseProfileStorage = false;\n\t\tdisposables.add(profileStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseProfileStorage = true;\n\t\t}));\n\n\t\tconst applicationStorage = storageMainService.applicationStorage;\n\t\tlet didCloseApplicationStorage = false;\n\t\tdisposables.add(applicationStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseApplicationStorage = true;\n\t\t}));\n\n\t\tstrictEqual(applicationStorage, storageMainService.applicationStorage); // same instance as long as not closed\n\t\tstrictEqual(profileStorage, storageMainService.profileStorage(profile)); // same instance as long as not closed\n\t\tstrictEqual(workspaceStorage, storageMainService.workspaceStorage(workspace)); // same instance as long as not closed\n\n\t\tawait applicationStorage.init();\n\t\tawait profileStorage.init();\n\t\tawait workspaceStorage.init();\n\n\t\tawait lifecycleMainService.fireOnWillShutdown();\n\n\t\tstrictEqual(didCloseApplicationStorage, true);\n\t\tstrictEqual(didCloseProfileStorage, true);\n\t\tstrictEqual(didCloseWorkspaceStorage, true);\n\n\t\tconst profileStorage2 = storageMainService.profileStorage(profile);\n\t\tnotStrictEqual(profileStorage, profileStorage2);\n\n\t\tconst workspaceStorage2 = storageMainService.workspaceStorage(workspace);\n\t\tnotStrictEqual(workspaceStorage, workspaceStorage2);\n\n\t\tawait workspaceStorage2.close();\n\t});\n\n\ttest('storage closed before init works', async function () {\n\t\tconst storageMainService = createStorageService();\n\t\tconst profile = inMemoryProfile;\n\t\tconst workspace = { id: generateUuid() };\n\n\t\tconst workspaceStorage = storageMainService.workspaceStorage(workspace);\n\t\tlet didCloseWorkspaceStorage = false;\n\t\tdisposables.add(workspaceStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseWorkspaceStorage = true;\n\t\t}));\n\n\t\tconst profileStorage = storageMainService.profileStorage(profile);\n\t\tlet didCloseProfileStorage = false;\n\t\tdisposables.add(profileStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseProfileStorage = true;\n\t\t}));\n\n\t\tconst applicationStorage = storageMainService.applicationStorage;\n\t\tlet didCloseApplicationStorage = false;\n\t\tdisposables.add(applicationStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseApplicationStorage = true;\n\t\t}));\n\n\t\tawait applicationStorage.close();\n\t\tawait profileStorage.close();\n\t\tawait workspaceStorage.close();\n\n\t\tstrictEqual(didCloseApplicationStorage, true);\n\t\tstrictEqual(didCloseProfileStorage, true);\n\t\tstrictEqual(didCloseWorkspaceStorage, true);\n\t});\n\n\ttest('storage closed before init awaits works', async function () {\n\t\tconst storageMainService = createStorageService();\n\t\tconst profile = inMemoryProfile;\n\t\tconst workspace = { id: generateUuid() };\n\n\t\tconst workspaceStorage = storageMainService.workspaceStorage(workspace);\n\t\tlet didCloseWorkspaceStorage = false;\n\t\tdisposables.add(workspaceStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseWorkspaceStorage = true;\n\t\t}));\n\n\t\tconst profileStorage = storageMainService.profileStorage(profile);\n\t\tlet didCloseProfileStorage = false;\n\t\tdisposables.add(profileStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseProfileStorage = true;\n\t\t}));\n\n\t\tconst applicationtorage = storageMainService.applicationStorage;\n\t\tlet didCloseApplicationStorage = false;\n\t\tdisposables.add(applicationtorage.onDidCloseStorage(() => {\n\t\t\tdidCloseApplicationStorage = true;\n\t\t}));\n\n\t\tapplicationtorage.init();\n\t\tprofileStorage.init();\n\t\tworkspaceStorage.init();\n\n\t\tawait applicationtorage.close();\n\t\tawait profileStorage.close();\n\t\tawait workspaceStorage.close();\n\n\t\tstrictEqual(didCloseApplicationStorage, true);\n\t\tstrictEqual(didCloseProfileStorage, true);\n\t\tstrictEqual(didCloseWorkspaceStorage, true);\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { notStrictEqual, strictEqual } from 'assert';\nimport { Schemas } from '../../../../base/common/network.js';\nimport { joinPath } from '../../../../base/common/resources.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { OPTIONS, parseArgs } from '../../../environment/node/argv.js';\nimport { NativeEnvironmentService } from '../../../environment/node/environmentService.js';\nimport { FileService } from '../../../files/common/fileService.js';\nimport { ILifecycleMainService } from '../../../lifecycle/electron-main/lifecycleMainService.js';\nimport { NullLogService } from '../../../log/common/log.js';\nimport product from '../../../product/common/product.js';\nimport { IProductService } from '../../../product/common/productService.js';\nimport { SaveStrategy, StateService } from '../../../state/node/stateService.js';\nimport { IS_NEW_KEY, StorageScope } from '../../common/storage.js';\nimport { IStorageChangeEvent, IStorageMain, IStorageMainOptions } from '../../electron-main/storageMain.js';\nimport { StorageMainService } from '../../electron-main/storageMainService.js';\nimport { currentSessionDateStorageKey, firstSessionDateStorageKey } from '../../../telemetry/common/telemetry.js';\nimport { UriIdentityService } from '../../../uriIdentity/common/uriIdentityService.js';\nimport { IUserDataProfile } from '../../../userDataProfile/common/userDataProfile.js';\nimport { UserDataProfilesMainService } from '../../../userDataProfile/electron-main/userDataProfile.js';\nimport { TestLifecycleMainService } from '../../../test/electron-main/workbenchTestServices.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\n\nsuite('StorageMainService', function () {\n\n\tconst disposables = new DisposableStore();\n\n\tconst productService: IProductService = { _serviceBrand: undefined, ...product };\n\n\tconst inMemoryProfileRoot = URI.file('/location').with({ scheme: Schemas.inMemory });\n\tconst inMemoryProfile: IUserDataProfile = {\n\t\tid: 'id',\n\t\tname: 'inMemory',\n\t\tisDefault: false,\n\t\tlocation: inMemoryProfileRoot,\n\t\tglobalStorageHome: joinPath(inMemoryProfileRoot, 'globalStorageHome'),\n\t\tsettingsResource: joinPath(inMemoryProfileRoot, 'settingsResource'),\n\t\tkeybindingsResource: joinPath(inMemoryProfileRoot, 'keybindingsResource'),\n\t\ttasksResource: joinPath(inMemoryProfileRoot, 'tasksResource'),\n\t\tmcpResource: joinPath(inMemoryProfileRoot, 'mcp.json'),\n\t\tsnippetsHome: joinPath(inMemoryProfileRoot, 'snippetsHome'),\n\t\tpromptsHome: joinPath(inMemoryProfileRoot, 'promptsHome'),\n\t\textensionsResource: joinPath(inMemoryProfileRoot, 'extensionsResource'),\n\t\tcacheHome: joinPath(inMemoryProfileRoot, 'cache'),\n\t};\n\n\tclass TestStorageMainService extends StorageMainService {\n\n\t\tprotected override getStorageOptions(): IStorageMainOptions {\n\t\t\treturn {\n\t\t\t\tuseInMemoryStorage: true\n\t\t\t};\n\t\t}\n\t}\n\n\tasync function testStorage(storage: IStorageMain, scope: StorageScope): Promise<void> {\n\t\tstrictEqual(storage.isInMemory(), true);\n\n\t\t// Telemetry: added after init unless workspace/profile scoped\n\t\tif (scope === StorageScope.APPLICATION) {\n\t\t\tstrictEqual(storage.items.size, 0);\n\t\t\tawait storage.init();\n\t\t\tstrictEqual(typeof storage.get(firstSessionDateStorageKey), 'string');\n\t\t\tstrictEqual(typeof storage.get(currentSessionDateStorageKey), 'string');\n\t\t} else {\n\t\t\tawait storage.init();\n\t\t}\n\n\t\tlet storageChangeEvent: IStorageChangeEvent | undefined = undefined;\n\t\tdisposables.add(storage.onDidChangeStorage(e => {\n\t\t\tstorageChangeEvent = e;\n\t\t}));\n\n\t\tlet storageDidClose = false;\n\t\tdisposables.add(storage.onDidCloseStorage(() => storageDidClose = true));\n\n\t\t// Basic store/get/remove\n\t\tconst size = storage.items.size;\n\n\t\tstorage.set('bar', 'foo');\n\t\tstrictEqual(storageChangeEvent!.key, 'bar');\n\t\tstorage.set('barNumber', 55);\n\t\tstorage.set('barBoolean', true);\n\n\t\tstrictEqual(storage.get('bar'), 'foo');\n\t\tstrictEqual(storage.get('barNumber'), '55');\n\t\tstrictEqual(storage.get('barBoolean'), 'true');\n\n\t\tstrictEqual(storage.items.size, size + 3);\n\n\t\tstorage.delete('bar');\n\t\tstrictEqual(storage.get('bar'), undefined);\n\n\t\tstrictEqual(storage.items.size, size + 2);\n\n\t\t// IS_NEW\n\t\tstrictEqual(storage.get(IS_NEW_KEY), 'true');\n\n\t\t// Close\n\t\tawait storage.close();\n\n\t\tstrictEqual(storageDidClose, true);\n\t}\n\n\tteardown(() => {\n\t\tdisposables.clear();\n\t});\n\n\tfunction createStorageService(lifecycleMainService: ILifecycleMainService = new TestLifecycleMainService()): TestStorageMainService {\n\t\tconst environmentService = new NativeEnvironmentService(parseArgs(process.argv, OPTIONS), productService);\n\t\tconst fileService = disposables.add(new FileService(new NullLogService()));\n\t\tconst uriIdentityService = disposables.add(new UriIdentityService(fileService));\n\t\tconst testStorageService = disposables.add(new TestStorageMainService(new NullLogService(), environmentService, disposables.add(new UserDataProfilesMainService(disposables.add(new StateService(SaveStrategy.DELAYED, environmentService, new NullLogService(), fileService)), disposables.add(uriIdentityService), environmentService, fileService, new NullLogService())), lifecycleMainService, fileService, uriIdentityService));\n\n\t\tdisposables.add(testStorageService.applicationStorage);\n\n\t\treturn testStorageService;\n\t}\n\n\ttest('basics (application)', function () {\n\t\tconst storageMainService = createStorageService();\n\n\t\treturn testStorage(storageMainService.applicationStorage, StorageScope.APPLICATION);\n\t});\n\n\ttest('basics (profile)', function () {\n\t\tconst storageMainService = createStorageService();\n\t\tconst profile = inMemoryProfile;\n\n\t\treturn testStorage(storageMainService.profileStorage(profile), StorageScope.PROFILE);\n\t});\n\n\ttest('basics (workspace)', function () {\n\t\tconst workspace = { id: generateUuid() };\n\t\tconst storageMainService = createStorageService();\n\n\t\treturn testStorage(storageMainService.workspaceStorage(workspace), StorageScope.WORKSPACE);\n\t});\n\n\ttest('storage closed onWillShutdown', async function () {\n\t\tconst lifecycleMainService = new TestLifecycleMainService();\n\t\tconst storageMainService = createStorageService(lifecycleMainService);\n\n\t\tconst profile = inMemoryProfile;\n\t\tconst workspace = { id: generateUuid() };\n\n\t\tconst workspaceStorage = storageMainService.workspaceStorage(workspace);\n\t\tlet didCloseWorkspaceStorage = false;\n\t\tdisposables.add(workspaceStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseWorkspaceStorage = true;\n\t\t}));\n\n\t\tconst profileStorage = storageMainService.profileStorage(profile);\n\t\tlet didCloseProfileStorage = false;\n\t\tdisposables.add(profileStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseProfileStorage = true;\n\t\t}));\n\n\t\tconst applicationStorage = storageMainService.applicationStorage;\n\t\tlet didCloseApplicationStorage = false;\n\t\tdisposables.add(applicationStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseApplicationStorage = true;\n\t\t}));\n\n\t\tstrictEqual(applicationStorage, storageMainService.applicationStorage); // same instance as long as not closed\n\t\tstrictEqual(profileStorage, storageMainService.profileStorage(profile)); // same instance as long as not closed\n\t\tstrictEqual(workspaceStorage, storageMainService.workspaceStorage(workspace)); // same instance as long as not closed\n\n\t\tawait applicationStorage.init();\n\t\tawait profileStorage.init();\n\t\tawait workspaceStorage.init();\n\n\t\tawait lifecycleMainService.fireOnWillShutdown();\n\n\t\tstrictEqual(didCloseApplicationStorage, true);\n\t\tstrictEqual(didCloseProfileStorage, true);\n\t\tstrictEqual(didCloseWorkspaceStorage, true);\n\n\t\tconst profileStorage2 = storageMainService.profileStorage(profile);\n\t\tnotStrictEqual(profileStorage, profileStorage2);\n\n\t\tconst workspaceStorage2 = storageMainService.workspaceStorage(workspace);\n\t\tnotStrictEqual(workspaceStorage, workspaceStorage2);\n\n\t\tawait workspaceStorage2.close();\n\t});\n\n\ttest('storage closed before init works', async function () {\n\t\tconst storageMainService = createStorageService();\n\t\tconst profile = inMemoryProfile;\n\t\tconst workspace = { id: generateUuid() };\n\n\t\tconst workspaceStorage = storageMainService.workspaceStorage(workspace);\n\t\tlet didCloseWorkspaceStorage = false;\n\t\tdisposables.add(workspaceStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseWorkspaceStorage = true;\n\t\t}));\n\n\t\tconst profileStorage = storageMainService.profileStorage(profile);\n\t\tlet didCloseProfileStorage = false;\n\t\tdisposables.add(profileStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseProfileStorage = true;\n\t\t}));\n\n\t\tconst applicationStorage = storageMainService.applicationStorage;\n\t\tlet didCloseApplicationStorage = false;\n\t\tdisposables.add(applicationStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseApplicationStorage = true;\n\t\t}));\n\n\t\tawait applicationStorage.close();\n\t\tawait profileStorage.close();\n\t\tawait workspaceStorage.close();\n\n\t\tstrictEqual(didCloseApplicationStorage, true);\n\t\tstrictEqual(didCloseProfileStorage, true);\n\t\tstrictEqual(didCloseWorkspaceStorage, true);\n\t});\n\n\ttest('storage closed before init awaits works', async function () {\n\t\tconst storageMainService = createStorageService();\n\t\tconst profile = inMemoryProfile;\n\t\tconst workspace = { id: generateUuid() };\n\n\t\tconst workspaceStorage = storageMainService.workspaceStorage(workspace);\n\t\tlet didCloseWorkspaceStorage = false;\n\t\tdisposables.add(workspaceStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseWorkspaceStorage = true;\n\t\t}));\n\n\t\tconst profileStorage = storageMainService.profileStorage(profile);\n\t\tlet didCloseProfileStorage = false;\n\t\tdisposables.add(profileStorage.onDidCloseStorage(() => {\n\t\t\tdidCloseProfileStorage = true;\n\t\t}));\n\n\t\tconst applicationtorage = storageMainService.applicationStorage;\n\t\tlet didCloseApplicationStorage = false;\n\t\tdisposables.add(applicationtorage.onDidCloseStorage(() => {\n\t\t\tdidCloseApplicationStorage = true;\n\t\t}));\n\n\t\tapplicationtorage.init();\n\t\tprofileStorage.init();\n\t\tworkspaceStorage.init();\n\n\t\tawait applicationtorage.close();\n\t\tawait profileStorage.close();\n\t\tawait workspaceStorage.close();\n\n\t\tstrictEqual(didCloseApplicationStorage, true);\n\t\tstrictEqual(didCloseProfileStorage, true);\n\t\tstrictEqual(didCloseWorkspaceStorage, true);\n\t});\n\n\tensureNoDisposablesAreLeakedInTestSuite();\n});\n"]}