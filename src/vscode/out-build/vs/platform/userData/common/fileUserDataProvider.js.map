{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/userData/common/fileUserDataProvider.ts","vs/platform/userData/common/fileUserDataProvider.ts"],"names":[],"mappings":"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","file":"fileUserDataProvider.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { IFileSystemProviderWithFileReadWriteCapability, IFileChange, IWatchOptions, IStat, IFileOverwriteOptions, FileType, IFileWriteOptions, IFileDeleteOptions, FileSystemProviderCapabilities, IFileSystemProviderWithFileReadStreamCapability, IFileReadStreamOptions, IFileSystemProviderWithFileAtomicReadCapability, hasFileFolderCopyCapability, IFileSystemProviderWithOpenReadWriteCloseCapability, IFileOpenOptions, IFileSystemProviderWithFileAtomicWriteCapability, IFileSystemProviderWithFileAtomicDeleteCapability, IFileSystemProviderWithFileFolderCopyCapability, IFileSystemProviderWithFileCloneCapability, hasFileCloneCapability, IFileAtomicReadOptions, IFileAtomicOptions } from '../../files/common/files.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { ReadableStreamEvents } from '../../../base/common/stream.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { TernarySearchTree } from '../../../base/common/ternarySearchTree.js';\nimport { IUserDataProfilesService } from '../../userDataProfile/common/userDataProfile.js';\nimport { ResourceSet } from '../../../base/common/map.js';\nimport { IUriIdentityService } from '../../uriIdentity/common/uriIdentity.js';\n\n/**\n * This is a wrapper on top of the local filesystem provider which will\n * \t- Convert the user data resources to file system scheme and vice-versa\n *  - Enforces atomic reads for user data\n */\nexport class FileUserDataProvider extends Disposable implements\n\tIFileSystemProviderWithFileReadWriteCapability,\n\tIFileSystemProviderWithOpenReadWriteCloseCapability,\n\tIFileSystemProviderWithFileReadStreamCapability,\n\tIFileSystemProviderWithFileFolderCopyCapability,\n\tIFileSystemProviderWithFileAtomicReadCapability,\n\tIFileSystemProviderWithFileAtomicWriteCapability,\n\tIFileSystemProviderWithFileAtomicDeleteCapability,\n\tIFileSystemProviderWithFileCloneCapability {\n\n\treadonly capabilities: FileSystemProviderCapabilities;\n\treadonly onDidChangeCapabilities: Event<void>;\n\n\tprivate readonly _onDidChangeFile: Emitter<readonly IFileChange[]>;\n\treadonly onDidChangeFile: Event<readonly IFileChange[]>;\n\n\tprivate readonly watchResources: TernarySearchTree<URI, URI>;\n\tprivate readonly atomicReadWriteResources: ResourceSet;\n\n\tconstructor(\n\t\tprivate readonly fileSystemScheme: string,\n\t\tprivate readonly fileSystemProvider: IFileSystemProviderWithFileReadWriteCapability & IFileSystemProviderWithOpenReadWriteCloseCapability & IFileSystemProviderWithFileReadStreamCapability & IFileSystemProviderWithFileAtomicReadCapability & IFileSystemProviderWithFileAtomicWriteCapability & IFileSystemProviderWithFileAtomicDeleteCapability,\n\t\tprivate readonly userDataScheme: string,\n\t\tprivate readonly userDataProfilesService: IUserDataProfilesService,\n\t\tprivate readonly uriIdentityService: IUriIdentityService,\n\t\tprivate readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t\tthis.capabilities = this.fileSystemProvider.capabilities;\n\t\tthis.onDidChangeCapabilities = this.fileSystemProvider.onDidChangeCapabilities;\n\t\tthis._onDidChangeFile = this._register(new Emitter());\n\t\tthis.onDidChangeFile = this._onDidChangeFile.event;\n\t\tthis.watchResources = TernarySearchTree.forUris(() => !(this.capabilities & 1024 /* FileSystemProviderCapabilities.PathCaseSensitive */));\n\t\tthis.atomicReadWriteResources = new ResourceSet((uri) => this.uriIdentityService.extUri.getComparisonKey(this.toFileSystemResource(uri)));\n\t\tthis.updateAtomicReadWritesResources();\n\t\tthis._register(userDataProfilesService.onDidChangeProfiles(() => this.updateAtomicReadWritesResources()));\n\t\tthis._register(this.fileSystemProvider.onDidChangeFile(e => this.handleFileChanges(e)));\n\t}\n\n\tprivate updateAtomicReadWritesResources(): void {\n\t\tthis.atomicReadWriteResources.clear();\n\t\tfor (const profile of this.userDataProfilesService.profiles) {\n\t\t\tthis.atomicReadWriteResources.add(profile.settingsResource);\n\t\t\tthis.atomicReadWriteResources.add(profile.keybindingsResource);\n\t\t\tthis.atomicReadWriteResources.add(profile.tasksResource);\n\t\t\tthis.atomicReadWriteResources.add(profile.extensionsResource);\n\t\t}\n\t}\n\n\topen(resource: URI, opts: IFileOpenOptions): Promise<number> {\n\t\treturn this.fileSystemProvider.open(this.toFileSystemResource(resource), opts);\n\t}\n\n\tclose(fd: number): Promise<void> {\n\t\treturn this.fileSystemProvider.close(fd);\n\t}\n\n\tread(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number> {\n\t\treturn this.fileSystemProvider.read(fd, pos, data, offset, length);\n\t}\n\n\twrite(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number> {\n\t\treturn this.fileSystemProvider.write(fd, pos, data, offset, length);\n\t}\n\n\twatch(resource: URI, opts: IWatchOptions): IDisposable {\n\t\tthis.watchResources.set(resource, resource);\n\t\tconst disposable = this.fileSystemProvider.watch(this.toFileSystemResource(resource), opts);\n\t\treturn toDisposable(() => {\n\t\t\tthis.watchResources.delete(resource);\n\t\t\tdisposable.dispose();\n\t\t});\n\t}\n\n\tstat(resource: URI): Promise<IStat> {\n\t\treturn this.fileSystemProvider.stat(this.toFileSystemResource(resource));\n\t}\n\n\tmkdir(resource: URI): Promise<void> {\n\t\treturn this.fileSystemProvider.mkdir(this.toFileSystemResource(resource));\n\t}\n\n\trename(from: URI, to: URI, opts: IFileOverwriteOptions): Promise<void> {\n\t\treturn this.fileSystemProvider.rename(this.toFileSystemResource(from), this.toFileSystemResource(to), opts);\n\t}\n\n\treadFile(resource: URI, opts?: IFileAtomicReadOptions): Promise<Uint8Array> {\n\t\treturn this.fileSystemProvider.readFile(this.toFileSystemResource(resource), opts);\n\t}\n\n\treadFileStream(resource: URI, opts: IFileReadStreamOptions, token: CancellationToken): ReadableStreamEvents<Uint8Array> {\n\t\treturn this.fileSystemProvider.readFileStream(this.toFileSystemResource(resource), opts, token);\n\t}\n\n\treaddir(resource: URI): Promise<[string, FileType][]> {\n\t\treturn this.fileSystemProvider.readdir(this.toFileSystemResource(resource));\n\t}\n\n\tenforceAtomicReadFile(resource: URI): boolean {\n\t\treturn this.atomicReadWriteResources.has(resource);\n\t}\n\n\twriteFile(resource: URI, content: Uint8Array, opts: IFileWriteOptions): Promise<void> {\n\t\treturn this.fileSystemProvider.writeFile(this.toFileSystemResource(resource), content, opts);\n\t}\n\n\tenforceAtomicWriteFile(resource: URI): IFileAtomicOptions | false {\n\t\tif (this.atomicReadWriteResources.has(resource)) {\n\t\t\treturn { postfix: '.vsctmp' };\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tdelete(resource: URI, opts: IFileDeleteOptions): Promise<void> {\n\t\treturn this.fileSystemProvider.delete(this.toFileSystemResource(resource), opts);\n\t}\n\n\tcopy(from: URI, to: URI, opts: IFileOverwriteOptions): Promise<void> {\n\t\tif (hasFileFolderCopyCapability(this.fileSystemProvider)) {\n\t\t\treturn this.fileSystemProvider.copy(this.toFileSystemResource(from), this.toFileSystemResource(to), opts);\n\t\t}\n\t\tthrow new Error('copy not supported');\n\t}\n\n\tcloneFile(from: URI, to: URI): Promise<void> {\n\t\tif (hasFileCloneCapability(this.fileSystemProvider)) {\n\t\t\treturn this.fileSystemProvider.cloneFile(this.toFileSystemResource(from), this.toFileSystemResource(to));\n\t\t}\n\t\tthrow new Error('clone not supported');\n\t}\n\n\tprivate handleFileChanges(changes: readonly IFileChange[]): void {\n\t\tconst userDataChanges: IFileChange[] = [];\n\t\tfor (const change of changes) {\n\t\t\tif (change.resource.scheme !== this.fileSystemScheme) {\n\t\t\t\tcontinue; // only interested in file schemes\n\t\t\t}\n\n\t\t\tconst userDataResource = this.toUserDataResource(change.resource);\n\t\t\tif (this.watchResources.findSubstr(userDataResource)) {\n\t\t\t\tuserDataChanges.push({\n\t\t\t\t\tresource: userDataResource,\n\t\t\t\t\ttype: change.type,\n\t\t\t\t\tcId: change.cId\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tif (userDataChanges.length) {\n\t\t\tthis.logService.debug('User data changed');\n\t\t\tthis._onDidChangeFile.fire(userDataChanges);\n\t\t}\n\t}\n\n\tprivate toFileSystemResource(userDataResource: URI): URI {\n\t\treturn userDataResource.with({ scheme: this.fileSystemScheme });\n\t}\n\n\tprivate toUserDataResource(fileSystemResource: URI): URI {\n\t\treturn fileSystemResource.with({ scheme: this.userDataScheme });\n\t}\n\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { IFileSystemProviderWithFileReadWriteCapability, IFileChange, IWatchOptions, IStat, IFileOverwriteOptions, FileType, IFileWriteOptions, IFileDeleteOptions, FileSystemProviderCapabilities, IFileSystemProviderWithFileReadStreamCapability, IFileReadStreamOptions, IFileSystemProviderWithFileAtomicReadCapability, hasFileFolderCopyCapability, IFileSystemProviderWithOpenReadWriteCloseCapability, IFileOpenOptions, IFileSystemProviderWithFileAtomicWriteCapability, IFileSystemProviderWithFileAtomicDeleteCapability, IFileSystemProviderWithFileFolderCopyCapability, IFileSystemProviderWithFileCloneCapability, hasFileCloneCapability, IFileAtomicReadOptions, IFileAtomicOptions } from '../../files/common/files.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { ReadableStreamEvents } from '../../../base/common/stream.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { TernarySearchTree } from '../../../base/common/ternarySearchTree.js';\nimport { IUserDataProfilesService } from '../../userDataProfile/common/userDataProfile.js';\nimport { ResourceSet } from '../../../base/common/map.js';\nimport { IUriIdentityService } from '../../uriIdentity/common/uriIdentity.js';\n\n/**\n * This is a wrapper on top of the local filesystem provider which will\n * \t- Convert the user data resources to file system scheme and vice-versa\n *  - Enforces atomic reads for user data\n */\nexport class FileUserDataProvider extends Disposable implements\n\tIFileSystemProviderWithFileReadWriteCapability,\n\tIFileSystemProviderWithOpenReadWriteCloseCapability,\n\tIFileSystemProviderWithFileReadStreamCapability,\n\tIFileSystemProviderWithFileFolderCopyCapability,\n\tIFileSystemProviderWithFileAtomicReadCapability,\n\tIFileSystemProviderWithFileAtomicWriteCapability,\n\tIFileSystemProviderWithFileAtomicDeleteCapability,\n\tIFileSystemProviderWithFileCloneCapability {\n\n\treadonly capabilities: FileSystemProviderCapabilities;\n\treadonly onDidChangeCapabilities: Event<void>;\n\n\tprivate readonly _onDidChangeFile: Emitter<readonly IFileChange[]>;\n\treadonly onDidChangeFile: Event<readonly IFileChange[]>;\n\n\tprivate readonly watchResources: TernarySearchTree<URI, URI>;\n\tprivate readonly atomicReadWriteResources: ResourceSet;\n\n\tconstructor(\n\t\tprivate readonly fileSystemScheme: string,\n\t\tprivate readonly fileSystemProvider: IFileSystemProviderWithFileReadWriteCapability & IFileSystemProviderWithOpenReadWriteCloseCapability & IFileSystemProviderWithFileReadStreamCapability & IFileSystemProviderWithFileAtomicReadCapability & IFileSystemProviderWithFileAtomicWriteCapability & IFileSystemProviderWithFileAtomicDeleteCapability,\n\t\tprivate readonly userDataScheme: string,\n\t\tprivate readonly userDataProfilesService: IUserDataProfilesService,\n\t\tprivate readonly uriIdentityService: IUriIdentityService,\n\t\tprivate readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t\tthis.capabilities = this.fileSystemProvider.capabilities;\n\t\tthis.onDidChangeCapabilities = this.fileSystemProvider.onDidChangeCapabilities;\n\t\tthis._onDidChangeFile = this._register(new Emitter());\n\t\tthis.onDidChangeFile = this._onDidChangeFile.event;\n\t\tthis.watchResources = TernarySearchTree.forUris(() => !(this.capabilities & 1024 /* FileSystemProviderCapabilities.PathCaseSensitive */));\n\t\tthis.atomicReadWriteResources = new ResourceSet((uri) => this.uriIdentityService.extUri.getComparisonKey(this.toFileSystemResource(uri)));\n\t\tthis.updateAtomicReadWritesResources();\n\t\tthis._register(userDataProfilesService.onDidChangeProfiles(() => this.updateAtomicReadWritesResources()));\n\t\tthis._register(this.fileSystemProvider.onDidChangeFile(e => this.handleFileChanges(e)));\n\t}\n\n\tprivate updateAtomicReadWritesResources(): void {\n\t\tthis.atomicReadWriteResources.clear();\n\t\tfor (const profile of this.userDataProfilesService.profiles) {\n\t\t\tthis.atomicReadWriteResources.add(profile.settingsResource);\n\t\t\tthis.atomicReadWriteResources.add(profile.keybindingsResource);\n\t\t\tthis.atomicReadWriteResources.add(profile.tasksResource);\n\t\t\tthis.atomicReadWriteResources.add(profile.extensionsResource);\n\t\t}\n\t}\n\n\topen(resource: URI, opts: IFileOpenOptions): Promise<number> {\n\t\treturn this.fileSystemProvider.open(this.toFileSystemResource(resource), opts);\n\t}\n\n\tclose(fd: number): Promise<void> {\n\t\treturn this.fileSystemProvider.close(fd);\n\t}\n\n\tread(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number> {\n\t\treturn this.fileSystemProvider.read(fd, pos, data, offset, length);\n\t}\n\n\twrite(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number> {\n\t\treturn this.fileSystemProvider.write(fd, pos, data, offset, length);\n\t}\n\n\twatch(resource: URI, opts: IWatchOptions): IDisposable {\n\t\tthis.watchResources.set(resource, resource);\n\t\tconst disposable = this.fileSystemProvider.watch(this.toFileSystemResource(resource), opts);\n\t\treturn toDisposable(() => {\n\t\t\tthis.watchResources.delete(resource);\n\t\t\tdisposable.dispose();\n\t\t});\n\t}\n\n\tstat(resource: URI): Promise<IStat> {\n\t\treturn this.fileSystemProvider.stat(this.toFileSystemResource(resource));\n\t}\n\n\tmkdir(resource: URI): Promise<void> {\n\t\treturn this.fileSystemProvider.mkdir(this.toFileSystemResource(resource));\n\t}\n\n\trename(from: URI, to: URI, opts: IFileOverwriteOptions): Promise<void> {\n\t\treturn this.fileSystemProvider.rename(this.toFileSystemResource(from), this.toFileSystemResource(to), opts);\n\t}\n\n\treadFile(resource: URI, opts?: IFileAtomicReadOptions): Promise<Uint8Array> {\n\t\treturn this.fileSystemProvider.readFile(this.toFileSystemResource(resource), opts);\n\t}\n\n\treadFileStream(resource: URI, opts: IFileReadStreamOptions, token: CancellationToken): ReadableStreamEvents<Uint8Array> {\n\t\treturn this.fileSystemProvider.readFileStream(this.toFileSystemResource(resource), opts, token);\n\t}\n\n\treaddir(resource: URI): Promise<[string, FileType][]> {\n\t\treturn this.fileSystemProvider.readdir(this.toFileSystemResource(resource));\n\t}\n\n\tenforceAtomicReadFile(resource: URI): boolean {\n\t\treturn this.atomicReadWriteResources.has(resource);\n\t}\n\n\twriteFile(resource: URI, content: Uint8Array, opts: IFileWriteOptions): Promise<void> {\n\t\treturn this.fileSystemProvider.writeFile(this.toFileSystemResource(resource), content, opts);\n\t}\n\n\tenforceAtomicWriteFile(resource: URI): IFileAtomicOptions | false {\n\t\tif (this.atomicReadWriteResources.has(resource)) {\n\t\t\treturn { postfix: '.vsctmp' };\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tdelete(resource: URI, opts: IFileDeleteOptions): Promise<void> {\n\t\treturn this.fileSystemProvider.delete(this.toFileSystemResource(resource), opts);\n\t}\n\n\tcopy(from: URI, to: URI, opts: IFileOverwriteOptions): Promise<void> {\n\t\tif (hasFileFolderCopyCapability(this.fileSystemProvider)) {\n\t\t\treturn this.fileSystemProvider.copy(this.toFileSystemResource(from), this.toFileSystemResource(to), opts);\n\t\t}\n\t\tthrow new Error('copy not supported');\n\t}\n\n\tcloneFile(from: URI, to: URI): Promise<void> {\n\t\tif (hasFileCloneCapability(this.fileSystemProvider)) {\n\t\t\treturn this.fileSystemProvider.cloneFile(this.toFileSystemResource(from), this.toFileSystemResource(to));\n\t\t}\n\t\tthrow new Error('clone not supported');\n\t}\n\n\tprivate handleFileChanges(changes: readonly IFileChange[]): void {\n\t\tconst userDataChanges: IFileChange[] = [];\n\t\tfor (const change of changes) {\n\t\t\tif (change.resource.scheme !== this.fileSystemScheme) {\n\t\t\t\tcontinue; // only interested in file schemes\n\t\t\t}\n\n\t\t\tconst userDataResource = this.toUserDataResource(change.resource);\n\t\t\tif (this.watchResources.findSubstr(userDataResource)) {\n\t\t\t\tuserDataChanges.push({\n\t\t\t\t\tresource: userDataResource,\n\t\t\t\t\ttype: change.type,\n\t\t\t\t\tcId: change.cId\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tif (userDataChanges.length) {\n\t\t\tthis.logService.debug('User data changed');\n\t\t\tthis._onDidChangeFile.fire(userDataChanges);\n\t\t}\n\t}\n\n\tprivate toFileSystemResource(userDataResource: URI): URI {\n\t\treturn userDataResource.with({ scheme: this.fileSystemScheme });\n\t}\n\n\tprivate toUserDataResource(fileSystemResource: URI): URI {\n\t\treturn fileSystemResource.with({ scheme: this.userDataScheme });\n\t}\n\n}\n"]}