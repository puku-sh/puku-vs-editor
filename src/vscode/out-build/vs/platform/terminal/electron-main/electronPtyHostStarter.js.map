{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/terminal/electron-main/electronPtyHostStarter.ts","vs/platform/terminal/electron-main/electronPtyHostStarter.ts"],"names":[],"mappings":"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","file":"electronPtyHostStarter.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IEnvironmentMainService } from '../../environment/electron-main/environmentMainService.js';\nimport { parsePtyHostDebugPort } from '../../environment/node/environmentService.js';\nimport { ILifecycleMainService } from '../../lifecycle/electron-main/lifecycleMainService.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { NullTelemetryService } from '../../telemetry/common/telemetryUtils.js';\nimport { IReconnectConstants, TerminalSettingId } from '../common/terminal.js';\nimport { IPtyHostConnection, IPtyHostStarter } from '../node/ptyHost.js';\nimport { UtilityProcess } from '../../utilityProcess/electron-main/utilityProcess.js';\nimport { Client as MessagePortClient } from '../../../base/parts/ipc/electron-main/ipc.mp.js';\nimport { IpcMainEvent } from 'electron';\nimport { validatedIpcMain } from '../../../base/parts/ipc/electron-main/ipcMain.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../base/common/lifecycle.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { deepClone } from '../../../base/common/objects.js';\nimport { isNumber } from '../../../base/common/types.js';\nimport { IConfigurationService } from '../../configuration/common/configuration.js';\nimport { Schemas } from '../../../base/common/network.js';\n\nexport class ElectronPtyHostStarter extends Disposable implements IPtyHostStarter {\n\n\tprivate utilityProcess: UtilityProcess | undefined = undefined;\n\n\tprivate readonly _onRequestConnection = new Emitter<void>();\n\treadonly onRequestConnection = this._onRequestConnection.event;\n\tprivate readonly _onWillShutdown = new Emitter<void>();\n\treadonly onWillShutdown = this._onWillShutdown.event;\n\n\tconstructor(\n\t\tprivate readonly _reconnectConstants: IReconnectConstants,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IEnvironmentMainService private readonly _environmentMainService: IEnvironmentMainService,\n\t\t@ILifecycleMainService private readonly _lifecycleMainService: ILifecycleMainService,\n\t\t@ILogService private readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\tthis._register(this._lifecycleMainService.onWillShutdown(() => this._onWillShutdown.fire()));\n\t\t// Listen for new windows to establish connection directly to pty host\n\t\tvalidatedIpcMain.on('vscode:createPtyHostMessageChannel', (e, nonce) => this._onWindowConnection(e, nonce));\n\t\tthis._register(toDisposable(() => {\n\t\t\tvalidatedIpcMain.removeHandler('vscode:createPtyHostMessageChannel');\n\t\t}));\n\t}\n\n\tstart(): IPtyHostConnection {\n\t\tthis.utilityProcess = new UtilityProcess(this._logService, NullTelemetryService, this._lifecycleMainService);\n\n\t\tconst inspectParams = parsePtyHostDebugPort(this._environmentMainService.args, this._environmentMainService.isBuilt);\n\t\tconst execArgv = inspectParams.port ? [\n\t\t\t'--nolazy',\n\t\t\t`--inspect${inspectParams.break ? '-brk' : ''}=${inspectParams.port}`\n\t\t] : undefined;\n\n\t\tthis.utilityProcess.start({\n\t\t\ttype: 'ptyHost',\n\t\t\tname: 'pty-host',\n\t\t\tentryPoint: 'vs/platform/terminal/node/ptyHostMain',\n\t\t\texecArgv,\n\t\t\targs: ['--logsPath', this._environmentMainService.logsHome.with({ scheme: Schemas.file }).fsPath],\n\t\t\tenv: this._createPtyHostConfiguration()\n\t\t});\n\n\t\tconst port = this.utilityProcess.connect();\n\t\tconst client = new MessagePortClient(port, 'ptyHost');\n\n\t\tconst store = new DisposableStore();\n\t\tstore.add(client);\n\t\tstore.add(toDisposable(() => {\n\t\t\tthis.utilityProcess?.kill();\n\t\t\tthis.utilityProcess?.dispose();\n\t\t\tthis.utilityProcess = undefined;\n\t\t}));\n\n\t\treturn {\n\t\t\tclient,\n\t\t\tstore,\n\t\t\tonDidProcessExit: this.utilityProcess.onExit\n\t\t};\n\t}\n\n\tprivate _createPtyHostConfiguration() {\n\t\tthis._environmentMainService.unsetSnapExportedVariables();\n\t\tconst config: { [key: string]: string } = {\n\t\t\t...deepClone(process.env),\n\t\t\tVSCODE_ESM_ENTRYPOINT: 'vs/platform/terminal/node/ptyHostMain',\n\t\t\tVSCODE_PIPE_LOGGING: 'true',\n\t\t\tVSCODE_VERBOSE_LOGGING: 'true', // transmit console logs from server to client,\n\t\t\tVSCODE_RECONNECT_GRACE_TIME: String(this._reconnectConstants.graceTime),\n\t\t\tVSCODE_RECONNECT_SHORT_GRACE_TIME: String(this._reconnectConstants.shortGraceTime),\n\t\t\tVSCODE_RECONNECT_SCROLLBACK: String(this._reconnectConstants.scrollback),\n\t\t};\n\t\tconst simulatedLatency = this._configurationService.getValue(TerminalSettingId.DeveloperPtyHostLatency);\n\t\tif (simulatedLatency && isNumber(simulatedLatency)) {\n\t\t\tconfig.VSCODE_LATENCY = String(simulatedLatency);\n\t\t}\n\t\tconst startupDelay = this._configurationService.getValue(TerminalSettingId.DeveloperPtyHostStartupDelay);\n\t\tif (startupDelay && isNumber(startupDelay)) {\n\t\t\tconfig.VSCODE_STARTUP_DELAY = String(startupDelay);\n\t\t}\n\t\tthis._environmentMainService.restoreSnapExportedVariables();\n\t\treturn config;\n\t}\n\n\tprivate _onWindowConnection(e: IpcMainEvent, nonce: string) {\n\t\tthis._onRequestConnection.fire();\n\n\t\tconst port = this.utilityProcess!.connect();\n\n\t\t// Check back if the requesting window meanwhile closed\n\t\t// Since shared process is delayed on startup there is\n\t\t// a chance that the window close before the shared process\n\t\t// was ready for a connection.\n\n\t\tif (e.sender.isDestroyed()) {\n\t\t\tport.close();\n\t\t\treturn;\n\t\t}\n\n\t\te.sender.postMessage('vscode:createPtyHostMessageChannelResult', nonce, [port]);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IEnvironmentMainService } from '../../environment/electron-main/environmentMainService.js';\nimport { parsePtyHostDebugPort } from '../../environment/node/environmentService.js';\nimport { ILifecycleMainService } from '../../lifecycle/electron-main/lifecycleMainService.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { NullTelemetryService } from '../../telemetry/common/telemetryUtils.js';\nimport { IReconnectConstants, TerminalSettingId } from '../common/terminal.js';\nimport { IPtyHostConnection, IPtyHostStarter } from '../node/ptyHost.js';\nimport { UtilityProcess } from '../../utilityProcess/electron-main/utilityProcess.js';\nimport { Client as MessagePortClient } from '../../../base/parts/ipc/electron-main/ipc.mp.js';\nimport { IpcMainEvent } from 'electron';\nimport { validatedIpcMain } from '../../../base/parts/ipc/electron-main/ipcMain.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../base/common/lifecycle.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { deepClone } from '../../../base/common/objects.js';\nimport { isNumber } from '../../../base/common/types.js';\nimport { IConfigurationService } from '../../configuration/common/configuration.js';\nimport { Schemas } from '../../../base/common/network.js';\n\nexport class ElectronPtyHostStarter extends Disposable implements IPtyHostStarter {\n\n\tprivate utilityProcess: UtilityProcess | undefined = undefined;\n\n\tprivate readonly _onRequestConnection = new Emitter<void>();\n\treadonly onRequestConnection = this._onRequestConnection.event;\n\tprivate readonly _onWillShutdown = new Emitter<void>();\n\treadonly onWillShutdown = this._onWillShutdown.event;\n\n\tconstructor(\n\t\tprivate readonly _reconnectConstants: IReconnectConstants,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@IEnvironmentMainService private readonly _environmentMainService: IEnvironmentMainService,\n\t\t@ILifecycleMainService private readonly _lifecycleMainService: ILifecycleMainService,\n\t\t@ILogService private readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\tthis._register(this._lifecycleMainService.onWillShutdown(() => this._onWillShutdown.fire()));\n\t\t// Listen for new windows to establish connection directly to pty host\n\t\tvalidatedIpcMain.on('vscode:createPtyHostMessageChannel', (e, nonce) => this._onWindowConnection(e, nonce));\n\t\tthis._register(toDisposable(() => {\n\t\t\tvalidatedIpcMain.removeHandler('vscode:createPtyHostMessageChannel');\n\t\t}));\n\t}\n\n\tstart(): IPtyHostConnection {\n\t\tthis.utilityProcess = new UtilityProcess(this._logService, NullTelemetryService, this._lifecycleMainService);\n\n\t\tconst inspectParams = parsePtyHostDebugPort(this._environmentMainService.args, this._environmentMainService.isBuilt);\n\t\tconst execArgv = inspectParams.port ? [\n\t\t\t'--nolazy',\n\t\t\t`--inspect${inspectParams.break ? '-brk' : ''}=${inspectParams.port}`\n\t\t] : undefined;\n\n\t\tthis.utilityProcess.start({\n\t\t\ttype: 'ptyHost',\n\t\t\tname: 'pty-host',\n\t\t\tentryPoint: 'vs/platform/terminal/node/ptyHostMain',\n\t\t\texecArgv,\n\t\t\targs: ['--logsPath', this._environmentMainService.logsHome.with({ scheme: Schemas.file }).fsPath],\n\t\t\tenv: this._createPtyHostConfiguration()\n\t\t});\n\n\t\tconst port = this.utilityProcess.connect();\n\t\tconst client = new MessagePortClient(port, 'ptyHost');\n\n\t\tconst store = new DisposableStore();\n\t\tstore.add(client);\n\t\tstore.add(toDisposable(() => {\n\t\t\tthis.utilityProcess?.kill();\n\t\t\tthis.utilityProcess?.dispose();\n\t\t\tthis.utilityProcess = undefined;\n\t\t}));\n\n\t\treturn {\n\t\t\tclient,\n\t\t\tstore,\n\t\t\tonDidProcessExit: this.utilityProcess.onExit\n\t\t};\n\t}\n\n\tprivate _createPtyHostConfiguration() {\n\t\tthis._environmentMainService.unsetSnapExportedVariables();\n\t\tconst config: { [key: string]: string } = {\n\t\t\t...deepClone(process.env),\n\t\t\tVSCODE_ESM_ENTRYPOINT: 'vs/platform/terminal/node/ptyHostMain',\n\t\t\tVSCODE_PIPE_LOGGING: 'true',\n\t\t\tVSCODE_VERBOSE_LOGGING: 'true', // transmit console logs from server to client,\n\t\t\tVSCODE_RECONNECT_GRACE_TIME: String(this._reconnectConstants.graceTime),\n\t\t\tVSCODE_RECONNECT_SHORT_GRACE_TIME: String(this._reconnectConstants.shortGraceTime),\n\t\t\tVSCODE_RECONNECT_SCROLLBACK: String(this._reconnectConstants.scrollback),\n\t\t};\n\t\tconst simulatedLatency = this._configurationService.getValue(TerminalSettingId.DeveloperPtyHostLatency);\n\t\tif (simulatedLatency && isNumber(simulatedLatency)) {\n\t\t\tconfig.VSCODE_LATENCY = String(simulatedLatency);\n\t\t}\n\t\tconst startupDelay = this._configurationService.getValue(TerminalSettingId.DeveloperPtyHostStartupDelay);\n\t\tif (startupDelay && isNumber(startupDelay)) {\n\t\t\tconfig.VSCODE_STARTUP_DELAY = String(startupDelay);\n\t\t}\n\t\tthis._environmentMainService.restoreSnapExportedVariables();\n\t\treturn config;\n\t}\n\n\tprivate _onWindowConnection(e: IpcMainEvent, nonce: string) {\n\t\tthis._onRequestConnection.fire();\n\n\t\tconst port = this.utilityProcess!.connect();\n\n\t\t// Check back if the requesting window meanwhile closed\n\t\t// Since shared process is delayed on startup there is\n\t\t// a chance that the window close before the shared process\n\t\t// was ready for a connection.\n\n\t\tif (e.sender.isDestroyed()) {\n\t\t\tport.close();\n\t\t\treturn;\n\t\t}\n\n\t\te.sender.postMessage('vscode:createPtyHostMessageChannelResult', nonce, [port]);\n\t}\n}\n"]}