{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/webview/common/webviewPortMapping.ts","vs/platform/webview/common/webviewPortMapping.ts"],"names":[],"mappings":"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","file":"webviewPortMapping.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IDisposable } from '../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { IAddress } from '../../remote/common/remoteAgentConnection.js';\nimport { extractLocalHostUriMetaDataForPortMapping, ITunnelService, RemoteTunnel } from '../../tunnel/common/tunnel.js';\n\nexport interface IWebviewPortMapping {\n\treadonly webviewPort: number;\n\treadonly extensionHostPort: number;\n}\n\n/**\n * Manages port mappings for a single webview.\n */\nexport class WebviewPortMappingManager implements IDisposable {\n\n\tprivate readonly _tunnels = new Map<number, RemoteTunnel>();\n\n\tconstructor(\n\t\tprivate readonly _getExtensionLocation: () => URI | undefined,\n\t\tprivate readonly _getMappings: () => readonly IWebviewPortMapping[],\n\t\tprivate readonly tunnelService: ITunnelService\n\t) { }\n\n\tpublic async getRedirect(resolveAuthority: IAddress | null | undefined, url: string): Promise<string | undefined> {\n\t\tconst uri = URI.parse(url);\n\t\tconst requestLocalHostInfo = extractLocalHostUriMetaDataForPortMapping(uri);\n\t\tif (!requestLocalHostInfo) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tfor (const mapping of this._getMappings()) {\n\t\t\tif (mapping.webviewPort === requestLocalHostInfo.port) {\n\t\t\t\tconst extensionLocation = this._getExtensionLocation();\n\t\t\t\tif (extensionLocation && extensionLocation.scheme === Schemas.vscodeRemote) {\n\t\t\t\t\tconst tunnel = resolveAuthority && await this.getOrCreateTunnel(resolveAuthority, mapping.extensionHostPort);\n\t\t\t\t\tif (tunnel) {\n\t\t\t\t\t\tif (tunnel.tunnelLocalPort === mapping.webviewPort) {\n\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn encodeURI(uri.with({\n\t\t\t\t\t\t\tauthority: `127.0.0.1:${tunnel.tunnelLocalPort}`,\n\t\t\t\t\t\t}).toString(true));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (mapping.webviewPort !== mapping.extensionHostPort) {\n\t\t\t\t\treturn encodeURI(uri.with({\n\t\t\t\t\t\tauthority: `${requestLocalHostInfo.address}:${mapping.extensionHostPort}`\n\t\t\t\t\t}).toString(true));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tasync dispose() {\n\t\tfor (const tunnel of this._tunnels.values()) {\n\t\t\tawait tunnel.dispose();\n\t\t}\n\t\tthis._tunnels.clear();\n\t}\n\n\tprivate async getOrCreateTunnel(remoteAuthority: IAddress, remotePort: number): Promise<RemoteTunnel | undefined> {\n\t\tconst existing = this._tunnels.get(remotePort);\n\t\tif (existing) {\n\t\t\treturn existing;\n\t\t}\n\t\tconst tunnelOrError = await this.tunnelService.openTunnel({ getAddress: async () => remoteAuthority }, undefined, remotePort);\n\t\tlet tunnel: RemoteTunnel | undefined;\n\t\tif (typeof tunnelOrError === 'string') {\n\t\t\ttunnel = undefined;\n\t\t}\n\t\tif (tunnel) {\n\t\t\tthis._tunnels.set(remotePort, tunnel);\n\t\t}\n\t\treturn tunnel;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IDisposable } from '../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { IAddress } from '../../remote/common/remoteAgentConnection.js';\nimport { extractLocalHostUriMetaDataForPortMapping, ITunnelService, RemoteTunnel } from '../../tunnel/common/tunnel.js';\n\nexport interface IWebviewPortMapping {\n\treadonly webviewPort: number;\n\treadonly extensionHostPort: number;\n}\n\n/**\n * Manages port mappings for a single webview.\n */\nexport class WebviewPortMappingManager implements IDisposable {\n\n\tprivate readonly _tunnels = new Map<number, RemoteTunnel>();\n\n\tconstructor(\n\t\tprivate readonly _getExtensionLocation: () => URI | undefined,\n\t\tprivate readonly _getMappings: () => readonly IWebviewPortMapping[],\n\t\tprivate readonly tunnelService: ITunnelService\n\t) { }\n\n\tpublic async getRedirect(resolveAuthority: IAddress | null | undefined, url: string): Promise<string | undefined> {\n\t\tconst uri = URI.parse(url);\n\t\tconst requestLocalHostInfo = extractLocalHostUriMetaDataForPortMapping(uri);\n\t\tif (!requestLocalHostInfo) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tfor (const mapping of this._getMappings()) {\n\t\t\tif (mapping.webviewPort === requestLocalHostInfo.port) {\n\t\t\t\tconst extensionLocation = this._getExtensionLocation();\n\t\t\t\tif (extensionLocation && extensionLocation.scheme === Schemas.vscodeRemote) {\n\t\t\t\t\tconst tunnel = resolveAuthority && await this.getOrCreateTunnel(resolveAuthority, mapping.extensionHostPort);\n\t\t\t\t\tif (tunnel) {\n\t\t\t\t\t\tif (tunnel.tunnelLocalPort === mapping.webviewPort) {\n\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn encodeURI(uri.with({\n\t\t\t\t\t\t\tauthority: `127.0.0.1:${tunnel.tunnelLocalPort}`,\n\t\t\t\t\t\t}).toString(true));\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (mapping.webviewPort !== mapping.extensionHostPort) {\n\t\t\t\t\treturn encodeURI(uri.with({\n\t\t\t\t\t\tauthority: `${requestLocalHostInfo.address}:${mapping.extensionHostPort}`\n\t\t\t\t\t}).toString(true));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tasync dispose() {\n\t\tfor (const tunnel of this._tunnels.values()) {\n\t\t\tawait tunnel.dispose();\n\t\t}\n\t\tthis._tunnels.clear();\n\t}\n\n\tprivate async getOrCreateTunnel(remoteAuthority: IAddress, remotePort: number): Promise<RemoteTunnel | undefined> {\n\t\tconst existing = this._tunnels.get(remotePort);\n\t\tif (existing) {\n\t\t\treturn existing;\n\t\t}\n\t\tconst tunnelOrError = await this.tunnelService.openTunnel({ getAddress: async () => remoteAuthority }, undefined, remotePort);\n\t\tlet tunnel: RemoteTunnel | undefined;\n\t\tif (typeof tunnelOrError === 'string') {\n\t\t\ttunnel = undefined;\n\t\t}\n\t\tif (tunnel) {\n\t\t\tthis._tunnels.set(remotePort, tunnel);\n\t\t}\n\t\treturn tunnel;\n\t}\n}\n"]}