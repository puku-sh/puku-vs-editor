{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/userDataProfile/electron-main/userDataProfileStorageIpc.ts","vs/platform/userDataProfile/electron-main/userDataProfileStorageIpc.ts"],"names":[],"mappings":"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","file":"userDataProfileStorageIpc.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable, MutableDisposable } from '../../../base/common/lifecycle.js';\nimport { IServerChannel } from '../../../base/parts/ipc/common/ipc.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IProfileStorageChanges, IProfileStorageValueChanges } from '../common/userDataProfileStorageService.js';\nimport { loadKeyTargets, StorageScope, TARGET_KEY } from '../../storage/common/storage.js';\nimport { IBaseSerializableStorageRequest } from '../../storage/common/storageIpc.js';\nimport { IStorageMain } from '../../storage/electron-main/storageMain.js';\nimport { IStorageMainService } from '../../storage/electron-main/storageMainService.js';\nimport { IUserDataProfile, IUserDataProfilesService } from '../common/userDataProfile.js';\n\nexport class ProfileStorageChangesListenerChannel extends Disposable implements IServerChannel {\n\n\tprivate readonly _onDidChange: Emitter<IProfileStorageChanges>;\n\n\tconstructor(\n\t\tprivate readonly storageMainService: IStorageMainService,\n\t\tprivate readonly userDataProfilesService: IUserDataProfilesService,\n\t\tprivate readonly logService: ILogService\n\t) {\n\t\tsuper();\n\t\tconst disposable = this._register(new MutableDisposable<IDisposable>());\n\t\tthis._onDidChange = this._register(new Emitter<IProfileStorageChanges>(\n\t\t\t{\n\t\t\t\t// Start listening to profile storage changes only when someone is listening\n\t\t\t\tonWillAddFirstListener: () => disposable.value = this.registerStorageChangeListeners(),\n\t\t\t\t// Stop listening to profile storage changes when no one is listening\n\t\t\t\tonDidRemoveLastListener: () => disposable.value = undefined\n\t\t\t}\n\t\t));\n\t}\n\n\tprivate registerStorageChangeListeners(): IDisposable {\n\t\tthis.logService.debug('ProfileStorageChangesListenerChannel#registerStorageChangeListeners');\n\t\tconst disposables = new DisposableStore();\n\t\tdisposables.add(Event.debounce(this.storageMainService.applicationStorage.onDidChangeStorage, (keys: string[] | undefined, e) => {\n\t\t\tif (keys) {\n\t\t\t\tkeys.push(e.key);\n\t\t\t} else {\n\t\t\t\tkeys = [e.key];\n\t\t\t}\n\t\t\treturn keys;\n\t\t}, 100)(keys => this.onDidChangeApplicationStorage(keys)));\n\t\tdisposables.add(Event.debounce(this.storageMainService.onDidChangeProfileStorage, (changes: Map<string, { profile: IUserDataProfile; keys: string[]; storage: IStorageMain }> | undefined, e) => {\n\t\t\tif (!changes) {\n\t\t\t\tchanges = new Map<string, { profile: IUserDataProfile; keys: string[]; storage: IStorageMain }>();\n\t\t\t}\n\t\t\tlet profileChanges = changes.get(e.profile.id);\n\t\t\tif (!profileChanges) {\n\t\t\t\tchanges.set(e.profile.id, profileChanges = { profile: e.profile, keys: [], storage: e.storage });\n\t\t\t}\n\t\t\tprofileChanges.keys.push(e.key);\n\t\t\treturn changes;\n\t\t}, 100)(keys => this.onDidChangeProfileStorage(keys)));\n\t\treturn disposables;\n\t}\n\n\tprivate onDidChangeApplicationStorage(keys: string[]): void {\n\t\tconst targetChangedProfiles: IUserDataProfile[] = keys.includes(TARGET_KEY) ? [this.userDataProfilesService.defaultProfile] : [];\n\t\tconst profileStorageValueChanges: IProfileStorageValueChanges[] = [];\n\t\tkeys = keys.filter(key => key !== TARGET_KEY);\n\t\tif (keys.length) {\n\t\t\tconst keyTargets = loadKeyTargets(this.storageMainService.applicationStorage.storage);\n\t\t\tprofileStorageValueChanges.push({ profile: this.userDataProfilesService.defaultProfile, changes: keys.map(key => ({ key, scope: StorageScope.PROFILE, target: keyTargets[key] })) });\n\t\t}\n\t\tthis.triggerEvents(targetChangedProfiles, profileStorageValueChanges);\n\t}\n\n\tprivate onDidChangeProfileStorage(changes: Map<string, { profile: IUserDataProfile; keys: string[]; storage: IStorageMain }>): void {\n\t\tconst targetChangedProfiles: IUserDataProfile[] = [];\n\t\tconst profileStorageValueChanges = new Map<string, IProfileStorageValueChanges>();\n\t\tfor (const [profileId, profileChanges] of changes.entries()) {\n\t\t\tif (profileChanges.keys.includes(TARGET_KEY)) {\n\t\t\t\ttargetChangedProfiles.push(profileChanges.profile);\n\t\t\t}\n\t\t\tconst keys = profileChanges.keys.filter(key => key !== TARGET_KEY);\n\t\t\tif (keys.length) {\n\t\t\t\tconst keyTargets = loadKeyTargets(profileChanges.storage.storage);\n\t\t\t\tprofileStorageValueChanges.set(profileId, { profile: profileChanges.profile, changes: keys.map(key => ({ key, scope: StorageScope.PROFILE, target: keyTargets[key] })) });\n\t\t\t}\n\t\t}\n\t\tthis.triggerEvents(targetChangedProfiles, [...profileStorageValueChanges.values()]);\n\t}\n\n\tprivate triggerEvents(targetChanges: IUserDataProfile[], valueChanges: IProfileStorageValueChanges[]): void {\n\t\tif (targetChanges.length || valueChanges.length) {\n\t\t\tthis._onDidChange.fire({ valueChanges, targetChanges });\n\t\t}\n\t}\n\n\tlisten(_: unknown, event: string, arg: IBaseSerializableStorageRequest): Event<any> {\n\t\tswitch (event) {\n\t\t\tcase 'onDidChange': return this._onDidChange.event;\n\t\t}\n\t\tthrow new Error(`[ProfileStorageChangesListenerChannel] Event not found: ${event}`);\n\t}\n\n\tasync call(_: unknown, command: string): Promise<any> {\n\t\tthrow new Error(`Call not found: ${command}`);\n\t}\n\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable, MutableDisposable } from '../../../base/common/lifecycle.js';\nimport { IServerChannel } from '../../../base/parts/ipc/common/ipc.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IProfileStorageChanges, IProfileStorageValueChanges } from '../common/userDataProfileStorageService.js';\nimport { loadKeyTargets, StorageScope, TARGET_KEY } from '../../storage/common/storage.js';\nimport { IBaseSerializableStorageRequest } from '../../storage/common/storageIpc.js';\nimport { IStorageMain } from '../../storage/electron-main/storageMain.js';\nimport { IStorageMainService } from '../../storage/electron-main/storageMainService.js';\nimport { IUserDataProfile, IUserDataProfilesService } from '../common/userDataProfile.js';\n\nexport class ProfileStorageChangesListenerChannel extends Disposable implements IServerChannel {\n\n\tprivate readonly _onDidChange: Emitter<IProfileStorageChanges>;\n\n\tconstructor(\n\t\tprivate readonly storageMainService: IStorageMainService,\n\t\tprivate readonly userDataProfilesService: IUserDataProfilesService,\n\t\tprivate readonly logService: ILogService\n\t) {\n\t\tsuper();\n\t\tconst disposable = this._register(new MutableDisposable<IDisposable>());\n\t\tthis._onDidChange = this._register(new Emitter<IProfileStorageChanges>(\n\t\t\t{\n\t\t\t\t// Start listening to profile storage changes only when someone is listening\n\t\t\t\tonWillAddFirstListener: () => disposable.value = this.registerStorageChangeListeners(),\n\t\t\t\t// Stop listening to profile storage changes when no one is listening\n\t\t\t\tonDidRemoveLastListener: () => disposable.value = undefined\n\t\t\t}\n\t\t));\n\t}\n\n\tprivate registerStorageChangeListeners(): IDisposable {\n\t\tthis.logService.debug('ProfileStorageChangesListenerChannel#registerStorageChangeListeners');\n\t\tconst disposables = new DisposableStore();\n\t\tdisposables.add(Event.debounce(this.storageMainService.applicationStorage.onDidChangeStorage, (keys: string[] | undefined, e) => {\n\t\t\tif (keys) {\n\t\t\t\tkeys.push(e.key);\n\t\t\t} else {\n\t\t\t\tkeys = [e.key];\n\t\t\t}\n\t\t\treturn keys;\n\t\t}, 100)(keys => this.onDidChangeApplicationStorage(keys)));\n\t\tdisposables.add(Event.debounce(this.storageMainService.onDidChangeProfileStorage, (changes: Map<string, { profile: IUserDataProfile; keys: string[]; storage: IStorageMain }> | undefined, e) => {\n\t\t\tif (!changes) {\n\t\t\t\tchanges = new Map<string, { profile: IUserDataProfile; keys: string[]; storage: IStorageMain }>();\n\t\t\t}\n\t\t\tlet profileChanges = changes.get(e.profile.id);\n\t\t\tif (!profileChanges) {\n\t\t\t\tchanges.set(e.profile.id, profileChanges = { profile: e.profile, keys: [], storage: e.storage });\n\t\t\t}\n\t\t\tprofileChanges.keys.push(e.key);\n\t\t\treturn changes;\n\t\t}, 100)(keys => this.onDidChangeProfileStorage(keys)));\n\t\treturn disposables;\n\t}\n\n\tprivate onDidChangeApplicationStorage(keys: string[]): void {\n\t\tconst targetChangedProfiles: IUserDataProfile[] = keys.includes(TARGET_KEY) ? [this.userDataProfilesService.defaultProfile] : [];\n\t\tconst profileStorageValueChanges: IProfileStorageValueChanges[] = [];\n\t\tkeys = keys.filter(key => key !== TARGET_KEY);\n\t\tif (keys.length) {\n\t\t\tconst keyTargets = loadKeyTargets(this.storageMainService.applicationStorage.storage);\n\t\t\tprofileStorageValueChanges.push({ profile: this.userDataProfilesService.defaultProfile, changes: keys.map(key => ({ key, scope: StorageScope.PROFILE, target: keyTargets[key] })) });\n\t\t}\n\t\tthis.triggerEvents(targetChangedProfiles, profileStorageValueChanges);\n\t}\n\n\tprivate onDidChangeProfileStorage(changes: Map<string, { profile: IUserDataProfile; keys: string[]; storage: IStorageMain }>): void {\n\t\tconst targetChangedProfiles: IUserDataProfile[] = [];\n\t\tconst profileStorageValueChanges = new Map<string, IProfileStorageValueChanges>();\n\t\tfor (const [profileId, profileChanges] of changes.entries()) {\n\t\t\tif (profileChanges.keys.includes(TARGET_KEY)) {\n\t\t\t\ttargetChangedProfiles.push(profileChanges.profile);\n\t\t\t}\n\t\t\tconst keys = profileChanges.keys.filter(key => key !== TARGET_KEY);\n\t\t\tif (keys.length) {\n\t\t\t\tconst keyTargets = loadKeyTargets(profileChanges.storage.storage);\n\t\t\t\tprofileStorageValueChanges.set(profileId, { profile: profileChanges.profile, changes: keys.map(key => ({ key, scope: StorageScope.PROFILE, target: keyTargets[key] })) });\n\t\t\t}\n\t\t}\n\t\tthis.triggerEvents(targetChangedProfiles, [...profileStorageValueChanges.values()]);\n\t}\n\n\tprivate triggerEvents(targetChanges: IUserDataProfile[], valueChanges: IProfileStorageValueChanges[]): void {\n\t\tif (targetChanges.length || valueChanges.length) {\n\t\t\tthis._onDidChange.fire({ valueChanges, targetChanges });\n\t\t}\n\t}\n\n\tlisten(_: unknown, event: string, arg: IBaseSerializableStorageRequest): Event<any> {\n\t\tswitch (event) {\n\t\t\tcase 'onDidChange': return this._onDidChange.event;\n\t\t}\n\t\tthrow new Error(`[ProfileStorageChangesListenerChannel] Event not found: ${event}`);\n\t}\n\n\tasync call(_: unknown, command: string): Promise<any> {\n\t\tthrow new Error(`Call not found: ${command}`);\n\t}\n\n}\n"]}