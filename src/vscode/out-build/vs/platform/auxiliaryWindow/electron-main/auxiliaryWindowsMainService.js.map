{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/auxiliaryWindow/electron-main/auxiliaryWindowsMainService.ts","vs/platform/auxiliaryWindow/electron-main/auxiliaryWindowsMainService.ts"],"names":[],"mappings":"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","file":"auxiliaryWindowsMainService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { BrowserWindow, BrowserWindowConstructorOptions, HandlerDetails, WebContents, app } from 'electron';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../base/common/lifecycle.js';\nimport { FileAccess } from '../../../base/common/network.js';\nimport { validatedIpcMain } from '../../../base/parts/ipc/electron-main/ipcMain.js';\nimport { AuxiliaryWindow, IAuxiliaryWindow } from './auxiliaryWindow.js';\nimport { IAuxiliaryWindowsMainService } from './auxiliaryWindows.js';\nimport { IInstantiationService } from '../../instantiation/common/instantiation.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IWindowState, WindowMode, defaultAuxWindowState } from '../../window/electron-main/window.js';\nimport { IDefaultBrowserWindowOptionsOverrides, WindowStateValidator, defaultBrowserWindowOptions, getLastFocused } from '../../windows/electron-main/windows.js';\n\nexport class AuxiliaryWindowsMainService extends Disposable implements IAuxiliaryWindowsMainService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _onDidMaximizeWindow = this._register(new Emitter<IAuxiliaryWindow>());\n\treadonly onDidMaximizeWindow = this._onDidMaximizeWindow.event;\n\n\tprivate readonly _onDidUnmaximizeWindow = this._register(new Emitter<IAuxiliaryWindow>());\n\treadonly onDidUnmaximizeWindow = this._onDidUnmaximizeWindow.event;\n\n\tprivate readonly _onDidChangeFullScreen = this._register(new Emitter<{ window: IAuxiliaryWindow; fullscreen: boolean }>());\n\treadonly onDidChangeFullScreen = this._onDidChangeFullScreen.event;\n\n\tprivate readonly _onDidChangeAlwaysOnTop = this._register(new Emitter<{ window: IAuxiliaryWindow; alwaysOnTop: boolean }>());\n\treadonly onDidChangeAlwaysOnTop = this._onDidChangeAlwaysOnTop.event;\n\n\tprivate readonly _onDidTriggerSystemContextMenu = this._register(new Emitter<{ window: IAuxiliaryWindow; x: number; y: number }>());\n\treadonly onDidTriggerSystemContextMenu = this._onDidTriggerSystemContextMenu.event;\n\n\tprivate readonly windows = new Map<number /* webContents ID */, AuxiliaryWindow>();\n\n\tconstructor(\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\n\t\t// We have to ensure that an auxiliary window gets to know its\n\t\t// containing `BrowserWindow` so that it can apply listeners to it\n\t\t// Unfortunately we cannot rely on static `BrowserWindow` methods\n\t\t// because we might call the methods too early before the window\n\t\t// is created.\n\n\t\tapp.on('browser-window-created', (_event, browserWindow) => {\n\n\t\t\t// This is an auxiliary window, try to claim it\n\t\t\tconst auxiliaryWindow = this.getWindowByWebContents(browserWindow.webContents);\n\t\t\tif (auxiliaryWindow) {\n\t\t\t\tthis.logService.trace('[aux window] app.on(\"browser-window-created\"): Trying to claim auxiliary window');\n\n\t\t\t\tauxiliaryWindow.tryClaimWindow();\n\t\t\t}\n\n\t\t\t// This is a main window, listen to child windows getting created to claim it\n\t\t\telse {\n\t\t\t\tconst disposables = new DisposableStore();\n\t\t\t\tdisposables.add(Event.fromNodeEventEmitter(browserWindow.webContents, 'did-create-window', (browserWindow, details) => ({ browserWindow, details }))(({ browserWindow, details }) => {\n\t\t\t\t\tconst auxiliaryWindow = this.getWindowByWebContents(browserWindow.webContents);\n\t\t\t\t\tif (auxiliaryWindow) {\n\t\t\t\t\t\tthis.logService.trace('[aux window] window.on(\"did-create-window\"): Trying to claim auxiliary window');\n\n\t\t\t\t\t\tauxiliaryWindow.tryClaimWindow(details.options);\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t\tdisposables.add(Event.fromNodeEventEmitter(browserWindow, 'closed')(() => disposables.dispose()));\n\t\t\t}\n\t\t});\n\n\t\tvalidatedIpcMain.handle('vscode:registerAuxiliaryWindow', async (event, mainWindowId: number) => {\n\t\t\tconst auxiliaryWindow = this.getWindowByWebContents(event.sender);\n\t\t\tif (auxiliaryWindow) {\n\t\t\t\tthis.logService.trace('[aux window] vscode:registerAuxiliaryWindow: Registering auxiliary window to main window');\n\n\t\t\t\tauxiliaryWindow.parentId = mainWindowId;\n\t\t\t}\n\n\t\t\treturn event.sender.id;\n\t\t});\n\t}\n\n\tcreateWindow(details: HandlerDetails): BrowserWindowConstructorOptions {\n\t\tconst { state, overrides } = this.computeWindowStateAndOverrides(details);\n\t\treturn this.instantiationService.invokeFunction(defaultBrowserWindowOptions, state, overrides, {\n\t\t\tpreload: FileAccess.asFileUri('vs/base/parts/sandbox/electron-browser/preload-aux.js').fsPath\n\t\t});\n\t}\n\n\tprivate computeWindowStateAndOverrides(details: HandlerDetails): { readonly state: IWindowState; readonly overrides: IDefaultBrowserWindowOptionsOverrides } {\n\t\tconst windowState: IWindowState = {};\n\t\tconst overrides: IDefaultBrowserWindowOptionsOverrides = {};\n\n\t\tconst features = details.features.split(','); // for example: popup=yes,left=270,top=14.5,width=1024,height=768\n\t\tfor (const feature of features) {\n\t\t\tconst [key, value] = feature.split('=');\n\t\t\tswitch (key) {\n\t\t\t\tcase 'width':\n\t\t\t\t\twindowState.width = parseInt(value, 10);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'height':\n\t\t\t\t\twindowState.height = parseInt(value, 10);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'left':\n\t\t\t\t\twindowState.x = parseInt(value, 10);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'top':\n\t\t\t\t\twindowState.y = parseInt(value, 10);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-maximized':\n\t\t\t\t\twindowState.mode = WindowMode.Maximized;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-fullscreen':\n\t\t\t\t\twindowState.mode = WindowMode.Fullscreen;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-disable-fullscreen':\n\t\t\t\t\toverrides.disableFullscreen = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-native-titlebar':\n\t\t\t\t\toverrides.forceNativeTitlebar = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-always-on-top':\n\t\t\t\t\toverrides.alwaysOnTop = true;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tconst state = WindowStateValidator.validateWindowState(this.logService, windowState) ?? defaultAuxWindowState();\n\n\t\tthis.logService.trace('[aux window] using window state', state);\n\n\t\treturn { state, overrides };\n\t}\n\n\tregisterWindow(webContents: WebContents): void {\n\t\tconst disposables = new DisposableStore();\n\n\t\tconst auxiliaryWindow = this.instantiationService.createInstance(AuxiliaryWindow, webContents);\n\n\t\tthis.windows.set(auxiliaryWindow.id, auxiliaryWindow);\n\t\tdisposables.add(toDisposable(() => this.windows.delete(auxiliaryWindow.id)));\n\n\t\tdisposables.add(auxiliaryWindow.onDidMaximize(() => this._onDidMaximizeWindow.fire(auxiliaryWindow)));\n\t\tdisposables.add(auxiliaryWindow.onDidUnmaximize(() => this._onDidUnmaximizeWindow.fire(auxiliaryWindow)));\n\t\tdisposables.add(auxiliaryWindow.onDidEnterFullScreen(() => this._onDidChangeFullScreen.fire({ window: auxiliaryWindow, fullscreen: true })));\n\t\tdisposables.add(auxiliaryWindow.onDidLeaveFullScreen(() => this._onDidChangeFullScreen.fire({ window: auxiliaryWindow, fullscreen: false })));\n\t\tdisposables.add(auxiliaryWindow.onDidChangeAlwaysOnTop(alwaysOnTop => this._onDidChangeAlwaysOnTop.fire({ window: auxiliaryWindow, alwaysOnTop })));\n\t\tdisposables.add(auxiliaryWindow.onDidTriggerSystemContextMenu(({ x, y }) => this._onDidTriggerSystemContextMenu.fire({ window: auxiliaryWindow, x, y })));\n\n\t\tEvent.once(auxiliaryWindow.onDidClose)(() => disposables.dispose());\n\t}\n\n\tgetWindowByWebContents(webContents: WebContents): AuxiliaryWindow | undefined {\n\t\tconst window = this.windows.get(webContents.id);\n\n\t\treturn window?.matches(webContents) ? window : undefined;\n\t}\n\n\tgetFocusedWindow(): IAuxiliaryWindow | undefined {\n\t\tconst window = BrowserWindow.getFocusedWindow();\n\t\tif (window) {\n\t\t\treturn this.getWindowByWebContents(window.webContents);\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tgetLastActiveWindow(): IAuxiliaryWindow | undefined {\n\t\treturn getLastFocused(Array.from(this.windows.values()));\n\t}\n\n\tgetWindows(): readonly IAuxiliaryWindow[] {\n\t\treturn Array.from(this.windows.values());\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { BrowserWindow, BrowserWindowConstructorOptions, HandlerDetails, WebContents, app } from 'electron';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore, toDisposable } from '../../../base/common/lifecycle.js';\nimport { FileAccess } from '../../../base/common/network.js';\nimport { validatedIpcMain } from '../../../base/parts/ipc/electron-main/ipcMain.js';\nimport { AuxiliaryWindow, IAuxiliaryWindow } from './auxiliaryWindow.js';\nimport { IAuxiliaryWindowsMainService } from './auxiliaryWindows.js';\nimport { IInstantiationService } from '../../instantiation/common/instantiation.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IWindowState, WindowMode, defaultAuxWindowState } from '../../window/electron-main/window.js';\nimport { IDefaultBrowserWindowOptionsOverrides, WindowStateValidator, defaultBrowserWindowOptions, getLastFocused } from '../../windows/electron-main/windows.js';\n\nexport class AuxiliaryWindowsMainService extends Disposable implements IAuxiliaryWindowsMainService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _onDidMaximizeWindow = this._register(new Emitter<IAuxiliaryWindow>());\n\treadonly onDidMaximizeWindow = this._onDidMaximizeWindow.event;\n\n\tprivate readonly _onDidUnmaximizeWindow = this._register(new Emitter<IAuxiliaryWindow>());\n\treadonly onDidUnmaximizeWindow = this._onDidUnmaximizeWindow.event;\n\n\tprivate readonly _onDidChangeFullScreen = this._register(new Emitter<{ window: IAuxiliaryWindow; fullscreen: boolean }>());\n\treadonly onDidChangeFullScreen = this._onDidChangeFullScreen.event;\n\n\tprivate readonly _onDidChangeAlwaysOnTop = this._register(new Emitter<{ window: IAuxiliaryWindow; alwaysOnTop: boolean }>());\n\treadonly onDidChangeAlwaysOnTop = this._onDidChangeAlwaysOnTop.event;\n\n\tprivate readonly _onDidTriggerSystemContextMenu = this._register(new Emitter<{ window: IAuxiliaryWindow; x: number; y: number }>());\n\treadonly onDidTriggerSystemContextMenu = this._onDidTriggerSystemContextMenu.event;\n\n\tprivate readonly windows = new Map<number /* webContents ID */, AuxiliaryWindow>();\n\n\tconstructor(\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\n\t\t// We have to ensure that an auxiliary window gets to know its\n\t\t// containing `BrowserWindow` so that it can apply listeners to it\n\t\t// Unfortunately we cannot rely on static `BrowserWindow` methods\n\t\t// because we might call the methods too early before the window\n\t\t// is created.\n\n\t\tapp.on('browser-window-created', (_event, browserWindow) => {\n\n\t\t\t// This is an auxiliary window, try to claim it\n\t\t\tconst auxiliaryWindow = this.getWindowByWebContents(browserWindow.webContents);\n\t\t\tif (auxiliaryWindow) {\n\t\t\t\tthis.logService.trace('[aux window] app.on(\"browser-window-created\"): Trying to claim auxiliary window');\n\n\t\t\t\tauxiliaryWindow.tryClaimWindow();\n\t\t\t}\n\n\t\t\t// This is a main window, listen to child windows getting created to claim it\n\t\t\telse {\n\t\t\t\tconst disposables = new DisposableStore();\n\t\t\t\tdisposables.add(Event.fromNodeEventEmitter(browserWindow.webContents, 'did-create-window', (browserWindow, details) => ({ browserWindow, details }))(({ browserWindow, details }) => {\n\t\t\t\t\tconst auxiliaryWindow = this.getWindowByWebContents(browserWindow.webContents);\n\t\t\t\t\tif (auxiliaryWindow) {\n\t\t\t\t\t\tthis.logService.trace('[aux window] window.on(\"did-create-window\"): Trying to claim auxiliary window');\n\n\t\t\t\t\t\tauxiliaryWindow.tryClaimWindow(details.options);\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t\tdisposables.add(Event.fromNodeEventEmitter(browserWindow, 'closed')(() => disposables.dispose()));\n\t\t\t}\n\t\t});\n\n\t\tvalidatedIpcMain.handle('vscode:registerAuxiliaryWindow', async (event, mainWindowId: number) => {\n\t\t\tconst auxiliaryWindow = this.getWindowByWebContents(event.sender);\n\t\t\tif (auxiliaryWindow) {\n\t\t\t\tthis.logService.trace('[aux window] vscode:registerAuxiliaryWindow: Registering auxiliary window to main window');\n\n\t\t\t\tauxiliaryWindow.parentId = mainWindowId;\n\t\t\t}\n\n\t\t\treturn event.sender.id;\n\t\t});\n\t}\n\n\tcreateWindow(details: HandlerDetails): BrowserWindowConstructorOptions {\n\t\tconst { state, overrides } = this.computeWindowStateAndOverrides(details);\n\t\treturn this.instantiationService.invokeFunction(defaultBrowserWindowOptions, state, overrides, {\n\t\t\tpreload: FileAccess.asFileUri('vs/base/parts/sandbox/electron-browser/preload-aux.js').fsPath\n\t\t});\n\t}\n\n\tprivate computeWindowStateAndOverrides(details: HandlerDetails): { readonly state: IWindowState; readonly overrides: IDefaultBrowserWindowOptionsOverrides } {\n\t\tconst windowState: IWindowState = {};\n\t\tconst overrides: IDefaultBrowserWindowOptionsOverrides = {};\n\n\t\tconst features = details.features.split(','); // for example: popup=yes,left=270,top=14.5,width=1024,height=768\n\t\tfor (const feature of features) {\n\t\t\tconst [key, value] = feature.split('=');\n\t\t\tswitch (key) {\n\t\t\t\tcase 'width':\n\t\t\t\t\twindowState.width = parseInt(value, 10);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'height':\n\t\t\t\t\twindowState.height = parseInt(value, 10);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'left':\n\t\t\t\t\twindowState.x = parseInt(value, 10);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'top':\n\t\t\t\t\twindowState.y = parseInt(value, 10);\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-maximized':\n\t\t\t\t\twindowState.mode = WindowMode.Maximized;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-fullscreen':\n\t\t\t\t\twindowState.mode = WindowMode.Fullscreen;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-disable-fullscreen':\n\t\t\t\t\toverrides.disableFullscreen = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-native-titlebar':\n\t\t\t\t\toverrides.forceNativeTitlebar = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'window-always-on-top':\n\t\t\t\t\toverrides.alwaysOnTop = true;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tconst state = WindowStateValidator.validateWindowState(this.logService, windowState) ?? defaultAuxWindowState();\n\n\t\tthis.logService.trace('[aux window] using window state', state);\n\n\t\treturn { state, overrides };\n\t}\n\n\tregisterWindow(webContents: WebContents): void {\n\t\tconst disposables = new DisposableStore();\n\n\t\tconst auxiliaryWindow = this.instantiationService.createInstance(AuxiliaryWindow, webContents);\n\n\t\tthis.windows.set(auxiliaryWindow.id, auxiliaryWindow);\n\t\tdisposables.add(toDisposable(() => this.windows.delete(auxiliaryWindow.id)));\n\n\t\tdisposables.add(auxiliaryWindow.onDidMaximize(() => this._onDidMaximizeWindow.fire(auxiliaryWindow)));\n\t\tdisposables.add(auxiliaryWindow.onDidUnmaximize(() => this._onDidUnmaximizeWindow.fire(auxiliaryWindow)));\n\t\tdisposables.add(auxiliaryWindow.onDidEnterFullScreen(() => this._onDidChangeFullScreen.fire({ window: auxiliaryWindow, fullscreen: true })));\n\t\tdisposables.add(auxiliaryWindow.onDidLeaveFullScreen(() => this._onDidChangeFullScreen.fire({ window: auxiliaryWindow, fullscreen: false })));\n\t\tdisposables.add(auxiliaryWindow.onDidChangeAlwaysOnTop(alwaysOnTop => this._onDidChangeAlwaysOnTop.fire({ window: auxiliaryWindow, alwaysOnTop })));\n\t\tdisposables.add(auxiliaryWindow.onDidTriggerSystemContextMenu(({ x, y }) => this._onDidTriggerSystemContextMenu.fire({ window: auxiliaryWindow, x, y })));\n\n\t\tEvent.once(auxiliaryWindow.onDidClose)(() => disposables.dispose());\n\t}\n\n\tgetWindowByWebContents(webContents: WebContents): AuxiliaryWindow | undefined {\n\t\tconst window = this.windows.get(webContents.id);\n\n\t\treturn window?.matches(webContents) ? window : undefined;\n\t}\n\n\tgetFocusedWindow(): IAuxiliaryWindow | undefined {\n\t\tconst window = BrowserWindow.getFocusedWindow();\n\t\tif (window) {\n\t\t\treturn this.getWindowByWebContents(window.webContents);\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tgetLastActiveWindow(): IAuxiliaryWindow | undefined {\n\t\treturn getLastFocused(Array.from(this.windows.values()));\n\t}\n\n\tgetWindows(): readonly IAuxiliaryWindow[] {\n\t\treturn Array.from(this.windows.values());\n\t}\n}\n"]}