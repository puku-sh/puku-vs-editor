{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/userDataSync/common/userDataSyncService.ts","vs/platform/userDataSync/common/userDataSyncService.ts"],"names":[],"mappings":"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","file":"userDataSyncService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { equals } from '../../../base/common/arrays.js';\nimport { CancelablePromise, createCancelablePromise, RunOnceScheduler } from '../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { toErrorMessage } from '../../../base/common/errorMessage.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { isEqual } from '../../../base/common/resources.js';\nimport { isBoolean, isUndefined } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { IConfigurationService } from '../../configuration/common/configuration.js';\nimport { IExtensionGalleryService } from '../../extensionManagement/common/extensionManagement.js';\nimport { IFileService } from '../../files/common/files.js';\nimport { IInstantiationService } from '../../instantiation/common/instantiation.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../storage/common/storage.js';\nimport { ITelemetryService } from '../../telemetry/common/telemetry.js';\nimport { IUserDataProfile, IUserDataProfilesService } from '../../userDataProfile/common/userDataProfile.js';\nimport { ExtensionsSynchroniser } from './extensionsSync.js';\nimport { GlobalStateSynchroniser } from './globalStateSync.js';\nimport { KeybindingsSynchroniser } from './keybindingsSync.js';\nimport { PromptsSynchronizer } from './promptsSync/promptsSync.js';\nimport { SettingsSynchroniser } from './settingsSync.js';\nimport { SnippetsSynchroniser } from './snippetsSync.js';\nimport { TasksSynchroniser } from './tasksSync.js';\nimport { McpSynchroniser } from './mcpSync.js';\nimport { UserDataProfilesManifestSynchroniser } from './userDataProfilesManifestSync.js';\nimport {\n\tALL_SYNC_RESOURCES, createSyncHeaders, IUserDataManualSyncTask, IUserDataSyncResourceConflicts, IUserDataSyncResourceError,\n\tIUserDataSyncResource, ISyncResourceHandle, IUserDataSyncTask, ISyncUserDataProfile, IUserDataManifest, IUserDataSyncConfiguration,\n\tIUserDataSyncEnablementService, IUserDataSynchroniser, IUserDataSyncLogService, IUserDataSyncService, IUserDataSyncStoreManagementService, IUserDataSyncStoreService,\n\tSyncResource, SyncStatus, UserDataSyncError, UserDataSyncErrorCode, UserDataSyncStoreError, USER_DATA_SYNC_CONFIGURATION_SCOPE, IUserDataSyncResourceProviderService, IUserDataSyncActivityData, IUserDataSyncLocalStoreService,\n\tIUserDataSyncLatestData,\n\tIUserData,\n\tisUserDataManifest,\n} from './userDataSync.js';\n\ntype SyncErrorClassification = {\n\towner: 'sandy081';\n\tcomment: 'Information about the error that occurred while syncing';\n\tcode: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'error code' };\n\tservice: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync service for which this error has occurred' };\n\tserverCode?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync service error code' };\n\turl?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync resource URL for which this error has occurred' };\n\tresource?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync resource for which this error has occurred' };\n\texecutionId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync execution id for which this error has occurred' };\n};\n\ntype SyncErrorEvent = {\n\tcode: string;\n\tservice: string;\n\tserverCode?: string;\n\turl?: string;\n\tresource?: string;\n\texecutionId?: string;\n};\n\nconst LAST_SYNC_TIME_KEY = 'sync.lastSyncTime';\n\nexport class UserDataSyncService extends Disposable implements IUserDataSyncService {\n\n\t_serviceBrand: undefined;\n\n\tprivate _status: SyncStatus = SyncStatus.Uninitialized;\n\tget status(): SyncStatus { return this._status; }\n\tprivate _onDidChangeStatus: Emitter<SyncStatus> = this._register(new Emitter<SyncStatus>());\n\treadonly onDidChangeStatus: Event<SyncStatus> = this._onDidChangeStatus.event;\n\n\tprivate _onDidChangeLocal = this._register(new Emitter<SyncResource>());\n\treadonly onDidChangeLocal = this._onDidChangeLocal.event;\n\n\tprivate _conflicts: IUserDataSyncResourceConflicts[] = [];\n\tget conflicts(): IUserDataSyncResourceConflicts[] { return this._conflicts; }\n\tprivate _onDidChangeConflicts = this._register(new Emitter<IUserDataSyncResourceConflicts[]>());\n\treadonly onDidChangeConflicts = this._onDidChangeConflicts.event;\n\n\tprivate _syncErrors: IUserDataSyncResourceError[] = [];\n\tprivate _onSyncErrors = this._register(new Emitter<IUserDataSyncResourceError[]>());\n\treadonly onSyncErrors = this._onSyncErrors.event;\n\n\tprivate _lastSyncTime: number | undefined = undefined;\n\tget lastSyncTime(): number | undefined { return this._lastSyncTime; }\n\tprivate _onDidChangeLastSyncTime: Emitter<number> = this._register(new Emitter<number>());\n\treadonly onDidChangeLastSyncTime: Event<number> = this._onDidChangeLastSyncTime.event;\n\n\tprivate _onDidResetLocal = this._register(new Emitter<void>());\n\treadonly onDidResetLocal = this._onDidResetLocal.event;\n\n\tprivate _onDidResetRemote = this._register(new Emitter<void>());\n\treadonly onDidResetRemote = this._onDidResetRemote.event;\n\n\tprivate activeProfileSynchronizers = new Map<string, [ProfileSynchronizer, IDisposable]>();\n\n\tconstructor(\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IUserDataSyncStoreService private readonly userDataSyncStoreService: IUserDataSyncStoreService,\n\t\t@IUserDataSyncStoreManagementService private readonly userDataSyncStoreManagementService: IUserDataSyncStoreManagementService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IUserDataSyncLogService private readonly logService: IUserDataSyncLogService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@IUserDataSyncEnablementService private readonly userDataSyncEnablementService: IUserDataSyncEnablementService,\n\t\t@IUserDataProfilesService private readonly userDataProfilesService: IUserDataProfilesService,\n\t\t@IUserDataSyncResourceProviderService private readonly userDataSyncResourceProviderService: IUserDataSyncResourceProviderService,\n\t\t@IUserDataSyncLocalStoreService private readonly userDataSyncLocalStoreService: IUserDataSyncLocalStoreService,\n\t) {\n\t\tsuper();\n\t\tthis._status = userDataSyncStoreManagementService.userDataSyncStore ? SyncStatus.Idle : SyncStatus.Uninitialized;\n\t\tthis._lastSyncTime = this.storageService.getNumber(LAST_SYNC_TIME_KEY, StorageScope.APPLICATION, undefined);\n\t\tthis._register(toDisposable(() => this.clearActiveProfileSynchronizers()));\n\n\t\tthis._register(new RunOnceScheduler(() => this.cleanUpStaleStorageData(), 5 * 1000 /* after 5s */)).schedule();\n\t}\n\n\tasync createSyncTask(manifest: IUserDataManifest | null, disableCache?: boolean): Promise<IUserDataSyncTask> {\n\t\tthis.checkEnablement();\n\n\t\tthis.logService.info('Sync started.');\n\t\tconst startTime = new Date().getTime();\n\t\tconst executionId = generateUuid();\n\t\ttry {\n\t\t\tconst syncHeaders = createSyncHeaders(executionId);\n\t\t\tif (disableCache) {\n\t\t\t\tsyncHeaders['Cache-Control'] = 'no-cache';\n\t\t\t}\n\t\t\tmanifest = await this.userDataSyncStoreService.manifest(manifest, syncHeaders);\n\t\t} catch (error) {\n\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(error);\n\t\t\treportUserDataSyncError(userDataSyncError, executionId, this.userDataSyncStoreManagementService, this.telemetryService);\n\t\t\tthrow userDataSyncError;\n\t\t}\n\n\t\tconst executed = false;\n\t\tconst that = this;\n\t\tlet cancellablePromise: CancelablePromise<void> | undefined;\n\t\treturn {\n\t\t\tmanifest,\n\t\t\tasync run(): Promise<void> {\n\t\t\t\tif (executed) {\n\t\t\t\t\tthrow new Error('Can run a task only once');\n\t\t\t\t}\n\t\t\t\tcancellablePromise = createCancelablePromise(token => that.sync(manifest, false, executionId, token));\n\t\t\t\tawait cancellablePromise.finally(() => cancellablePromise = undefined);\n\t\t\t\tthat.logService.info(`Sync done. Took ${new Date().getTime() - startTime}ms`);\n\t\t\t\tthat.updateLastSyncTime();\n\t\t\t},\n\t\t\tstop(): Promise<void> {\n\t\t\t\tcancellablePromise?.cancel();\n\t\t\t\treturn that.stop();\n\t\t\t}\n\t\t};\n\t}\n\n\tasync createManualSyncTask(): Promise<IUserDataManualSyncTask> {\n\t\tthis.checkEnablement();\n\n\t\tif (this.userDataSyncEnablementService.isEnabled()) {\n\t\t\tthrow new UserDataSyncError('Cannot start manual sync when sync is enabled', UserDataSyncErrorCode.LocalError);\n\t\t}\n\n\t\tthis.logService.info('Sync started.');\n\t\tconst startTime = new Date().getTime();\n\t\tconst executionId = generateUuid();\n\t\tconst syncHeaders = createSyncHeaders(executionId);\n\t\tlet latestUserDataOrManifest: IUserDataSyncLatestData | IUserDataManifest | null;\n\t\ttry {\n\t\t\tlatestUserDataOrManifest = await this.userDataSyncStoreService.getLatestData(syncHeaders);\n\t\t} catch (error) {\n\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(error);\n\t\t\tthis.telemetryService.publicLog2<SyncErrorEvent, SyncErrorClassification>('sync.download.latest',\n\t\t\t\t{\n\t\t\t\t\tcode: userDataSyncError.code,\n\t\t\t\t\tserverCode: userDataSyncError instanceof UserDataSyncStoreError ? String(userDataSyncError.serverCode) : undefined,\n\t\t\t\t\turl: userDataSyncError instanceof UserDataSyncStoreError ? userDataSyncError.url : undefined,\n\t\t\t\t\tresource: userDataSyncError.resource,\n\t\t\t\t\texecutionId,\n\t\t\t\t\tservice: this.userDataSyncStoreManagementService.userDataSyncStore!.url.toString()\n\t\t\t\t});\n\n\t\t\t// Fallback to manifest in stable\n\t\t\ttry {\n\t\t\t\tlatestUserDataOrManifest = await this.userDataSyncStoreService.manifest(null, syncHeaders);\n\t\t\t} catch (error) {\n\t\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(error);\n\t\t\t\treportUserDataSyncError(userDataSyncError, executionId, this.userDataSyncStoreManagementService, this.telemetryService);\n\t\t\t\tthrow userDataSyncError;\n\t\t\t}\n\t\t}\n\n\t\t/* Manual sync shall start on clean local state */\n\t\tawait this.resetLocal();\n\n\t\tconst that = this;\n\t\tconst cancellableToken = new CancellationTokenSource();\n\t\treturn {\n\t\t\tid: executionId,\n\t\t\tasync merge(): Promise<void> {\n\t\t\t\treturn that.sync(latestUserDataOrManifest, true, executionId, cancellableToken.token);\n\t\t\t},\n\t\t\tasync apply(): Promise<void> {\n\t\t\t\ttry {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait that.applyManualSync(latestUserDataOrManifest, executionId, cancellableToken.token);\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tif (UserDataSyncError.toUserDataSyncError(error).code === UserDataSyncErrorCode.MethodNotFound) {\n\t\t\t\t\t\t\tthat.logService.info('Client is making invalid requests. Cleaning up data...');\n\t\t\t\t\t\t\tawait that.cleanUpRemoteData();\n\t\t\t\t\t\t\tthat.logService.info('Applying manual sync again...');\n\t\t\t\t\t\t\tawait that.applyManualSync(latestUserDataOrManifest, executionId, cancellableToken.token);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthrow error;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthat.logService.error(error);\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t\tthat.logService.info(`Sync done. Took ${new Date().getTime() - startTime}ms`);\n\t\t\t\tthat.updateLastSyncTime();\n\t\t\t},\n\t\t\tasync stop(): Promise<void> {\n\t\t\t\tcancellableToken.cancel();\n\t\t\t\tawait that.stop();\n\t\t\t\tawait that.resetLocal();\n\t\t\t}\n\t\t};\n\t}\n\n\tprivate async sync(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, preview: boolean, executionId: string, token: CancellationToken): Promise<void> {\n\t\tthis._syncErrors = [];\n\t\ttry {\n\t\t\tif (this.status !== SyncStatus.HasConflicts) {\n\t\t\t\tthis.setStatus(SyncStatus.Syncing);\n\t\t\t}\n\n\t\t\t// Sync Default Profile First\n\t\t\tconst defaultProfileSynchronizer = this.getOrCreateActiveProfileSynchronizer(this.userDataProfilesService.defaultProfile, undefined);\n\t\t\tthis._syncErrors.push(...await this.syncProfile(defaultProfileSynchronizer, manifestOrLatestData, preview, executionId, token));\n\n\t\t\t// Sync other profiles\n\t\t\tconst userDataProfileManifestSynchronizer = defaultProfileSynchronizer.enabled.find(s => s.resource === SyncResource.Profiles);\n\t\t\tif (userDataProfileManifestSynchronizer) {\n\t\t\t\tconst syncProfiles = (await (userDataProfileManifestSynchronizer as UserDataProfilesManifestSynchroniser).getLastSyncedProfiles()) || [];\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tawait this.syncRemoteProfiles(syncProfiles, manifestOrLatestData, preview, executionId, token);\n\t\t\t}\n\t\t} finally {\n\t\t\tif (this.status !== SyncStatus.HasConflicts) {\n\t\t\t\tthis.setStatus(SyncStatus.Idle);\n\t\t\t}\n\t\t\tthis._onSyncErrors.fire(this._syncErrors);\n\t\t}\n\t}\n\n\tprivate async syncRemoteProfiles(remoteProfiles: ISyncUserDataProfile[], manifest: IUserDataManifest | IUserDataSyncLatestData | null, preview: boolean, executionId: string, token: CancellationToken): Promise<void> {\n\t\tfor (const syncProfile of remoteProfiles) {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst profile = this.userDataProfilesService.profiles.find(p => p.id === syncProfile.id);\n\t\t\tif (!profile) {\n\t\t\t\tthis.logService.error(`Profile with id:${syncProfile.id} and name: ${syncProfile.name} does not exist locally to sync.`);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tthis.logService.info('Syncing profile.', syncProfile.name);\n\t\t\tconst profileSynchronizer = this.getOrCreateActiveProfileSynchronizer(profile, syncProfile);\n\t\t\tthis._syncErrors.push(...await this.syncProfile(profileSynchronizer, manifest, preview, executionId, token));\n\t\t}\n\t\t// Dispose & Delete profile synchronizers which do not exist anymore\n\t\tfor (const [key, profileSynchronizerItem] of this.activeProfileSynchronizers.entries()) {\n\t\t\tif (this.userDataProfilesService.profiles.some(p => p.id === profileSynchronizerItem[0].profile.id)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tawait profileSynchronizerItem[0].resetLocal();\n\t\t\tprofileSynchronizerItem[1].dispose();\n\t\t\tthis.activeProfileSynchronizers.delete(key);\n\t\t}\n\t}\n\n\tprivate async applyManualSync(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, executionId: string, token: CancellationToken): Promise<void> {\n\t\ttry {\n\t\t\tthis.setStatus(SyncStatus.Syncing);\n\t\t\tconst profileSynchronizers = this.getActiveProfileSynchronizers();\n\t\t\tfor (const profileSynchronizer of profileSynchronizers) {\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tawait profileSynchronizer.apply(executionId, token);\n\t\t\t}\n\n\t\t\tconst defaultProfileSynchronizer = profileSynchronizers.find(s => s.profile.isDefault);\n\t\t\tif (!defaultProfileSynchronizer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst userDataProfileManifestSynchronizer = defaultProfileSynchronizer.enabled.find(s => s.resource === SyncResource.Profiles);\n\t\t\tif (!userDataProfileManifestSynchronizer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Sync remote profiles which are not synced locally\n\t\t\tconst remoteProfiles = (await (userDataProfileManifestSynchronizer as UserDataProfilesManifestSynchroniser).getRemoteSyncedProfiles(getRefOrUserData(manifestOrLatestData, undefined, SyncResource.Profiles) ?? null)) || [];\n\t\t\tconst remoteProfilesToSync = remoteProfiles.filter(remoteProfile => profileSynchronizers.every(s => s.profile.id !== remoteProfile.id));\n\t\t\tif (remoteProfilesToSync.length) {\n\t\t\t\tawait this.syncRemoteProfiles(remoteProfilesToSync, manifestOrLatestData, false, executionId, token);\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.setStatus(SyncStatus.Idle);\n\t\t}\n\t}\n\n\tprivate async syncProfile(profileSynchronizer: ProfileSynchronizer, manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, preview: boolean, executionId: string, token: CancellationToken): Promise<IUserDataSyncResourceError[]> {\n\t\tconst errors = await profileSynchronizer.sync(manifestOrLatestData, preview, executionId, token);\n\t\treturn errors.map(([syncResource, error]) => ({ profile: profileSynchronizer.profile, syncResource, error }));\n\t}\n\n\tprivate async stop(): Promise<void> {\n\t\tif (this.status !== SyncStatus.Idle) {\n\t\t\tawait Promise.allSettled(this.getActiveProfileSynchronizers().map(profileSynchronizer => profileSynchronizer.stop()));\n\t\t}\n\t}\n\n\tasync resolveContent(resource: URI): Promise<string | null> {\n\t\tconst content = await this.userDataSyncResourceProviderService.resolveContent(resource);\n\t\tif (content) {\n\t\t\treturn content;\n\t\t}\n\t\tfor (const profileSynchronizer of this.getActiveProfileSynchronizers()) {\n\t\t\tfor (const synchronizer of profileSynchronizer.enabled) {\n\t\t\t\tconst content = await synchronizer.resolveContent(resource);\n\t\t\t\tif (content) {\n\t\t\t\t\treturn content;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\tasync replace(syncResourceHandle: ISyncResourceHandle): Promise<void> {\n\t\tthis.checkEnablement();\n\n\t\tconst profileSyncResource = this.userDataSyncResourceProviderService.resolveUserDataSyncResource(syncResourceHandle);\n\t\tif (!profileSyncResource) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst content = await this.resolveContent(syncResourceHandle.uri);\n\t\tif (!content) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait this.performAction(profileSyncResource.profile, async synchronizer => {\n\t\t\tif (profileSyncResource.syncResource === synchronizer.resource) {\n\t\t\t\tawait synchronizer.replace(content);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t});\n\n\t\treturn;\n\t}\n\n\tasync accept(syncResource: IUserDataSyncResource, resource: URI, content: string | null | undefined, apply: boolean | { force: boolean }): Promise<void> {\n\t\tthis.checkEnablement();\n\n\t\tawait this.performAction(syncResource.profile, async synchronizer => {\n\t\t\tif (syncResource.syncResource === synchronizer.resource) {\n\t\t\t\tawait synchronizer.accept(resource, content);\n\t\t\t\tif (apply) {\n\t\t\t\t\tawait synchronizer.apply(isBoolean(apply) ? false : apply.force, createSyncHeaders(generateUuid()));\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t});\n\t}\n\n\tasync hasLocalData(): Promise<boolean> {\n\t\tconst result = await this.performAction(this.userDataProfilesService.defaultProfile, async synchronizer => {\n\t\t\t// skip global state synchronizer\n\t\t\tif (synchronizer.resource !== SyncResource.GlobalState && await synchronizer.hasLocalData()) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t});\n\t\treturn !!result;\n\t}\n\n\tasync hasPreviouslySynced(): Promise<boolean> {\n\t\tconst result = await this.performAction(this.userDataProfilesService.defaultProfile, async synchronizer => {\n\t\t\tif (await synchronizer.hasPreviouslySynced()) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t});\n\t\treturn !!result;\n\t}\n\n\tasync reset(): Promise<void> {\n\t\tthis.checkEnablement();\n\t\tawait this.resetRemote();\n\t\tawait this.resetLocal();\n\t}\n\n\tasync resetRemote(): Promise<void> {\n\t\tthis.checkEnablement();\n\t\ttry {\n\t\t\tawait this.userDataSyncStoreService.clear();\n\t\t\tthis.logService.info('Cleared data on server');\n\t\t} catch (e) {\n\t\t\tthis.logService.error(e);\n\t\t}\n\t\tthis._onDidResetRemote.fire();\n\t}\n\n\tasync resetLocal(): Promise<void> {\n\t\tthis.checkEnablement();\n\t\tthis._lastSyncTime = undefined;\n\t\tthis.storageService.remove(LAST_SYNC_TIME_KEY, StorageScope.APPLICATION);\n\t\tfor (const [synchronizer] of this.activeProfileSynchronizers.values()) {\n\t\t\ttry {\n\t\t\t\tawait synchronizer.resetLocal();\n\t\t\t} catch (e) {\n\t\t\t\tthis.logService.error(e);\n\t\t\t}\n\t\t}\n\t\tthis.clearActiveProfileSynchronizers();\n\t\tthis._onDidResetLocal.fire();\n\t\tthis.logService.info('Did reset the local sync state.');\n\t}\n\n\tprivate async cleanUpStaleStorageData(): Promise<void> {\n\t\tconst allKeys = this.storageService.keys(StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\tconst lastSyncProfileKeys: [string, string][] = [];\n\t\tfor (const key of allKeys) {\n\t\t\tif (!key.endsWith('.lastSyncUserData')) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst segments = key.split('.');\n\t\t\tif (segments.length === 3) {\n\t\t\t\tlastSyncProfileKeys.push([key, segments[0]]);\n\t\t\t}\n\t\t}\n\t\tif (!lastSyncProfileKeys.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst disposables = new DisposableStore();\n\n\t\ttry {\n\t\t\tlet defaultProfileSynchronizer = this.activeProfileSynchronizers.get(this.userDataProfilesService.defaultProfile.id)?.[0];\n\t\t\tif (!defaultProfileSynchronizer) {\n\t\t\t\tdefaultProfileSynchronizer = disposables.add(this.instantiationService.createInstance(ProfileSynchronizer, this.userDataProfilesService.defaultProfile, undefined));\n\t\t\t}\n\t\t\tconst userDataProfileManifestSynchronizer = defaultProfileSynchronizer.enabled.find(s => s.resource === SyncResource.Profiles) as UserDataProfilesManifestSynchroniser;\n\t\t\tif (!userDataProfileManifestSynchronizer) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst lastSyncedProfiles = await userDataProfileManifestSynchronizer.getLastSyncedProfiles();\n\t\t\tconst lastSyncedCollections = lastSyncedProfiles?.map(p => p.collection) ?? [];\n\t\t\tfor (const [key, collection] of lastSyncProfileKeys) {\n\t\t\t\tif (!lastSyncedCollections.includes(collection)) {\n\t\t\t\t\tthis.logService.info(`Removing last sync state for stale profile: ${collection}`);\n\t\t\t\t\tthis.storageService.remove(key, StorageScope.APPLICATION);\n\t\t\t\t}\n\t\t\t}\n\t\t} finally {\n\t\t\tdisposables.dispose();\n\t\t}\n\t}\n\n\tasync cleanUpRemoteData(): Promise<void> {\n\t\tconst remoteProfiles = await this.userDataSyncResourceProviderService.getRemoteSyncedProfiles();\n\t\tconst remoteProfileCollections = remoteProfiles.map(profile => profile.collection);\n\t\tconst allCollections = await this.userDataSyncStoreService.getAllCollections();\n\t\tconst redundantCollections = allCollections.filter(c => !remoteProfileCollections.includes(c));\n\t\tif (redundantCollections.length) {\n\t\t\tthis.logService.info(`Deleting ${redundantCollections.length} redundant collections on server`);\n\t\t\tawait Promise.allSettled(redundantCollections.map(collectionId => this.userDataSyncStoreService.deleteCollection(collectionId)));\n\t\t\tthis.logService.info(`Deleted redundant collections on server`);\n\t\t}\n\t\tconst updatedRemoteProfiles = remoteProfiles.filter(profile => allCollections.includes(profile.collection));\n\t\tif (updatedRemoteProfiles.length !== remoteProfiles.length) {\n\t\t\tconst profileManifestSynchronizer = this.instantiationService.createInstance(UserDataProfilesManifestSynchroniser, this.userDataProfilesService.defaultProfile, undefined);\n\t\t\ttry {\n\t\t\t\tthis.logService.info('Resetting the last synced state of profiles');\n\t\t\t\tawait profileManifestSynchronizer.resetLocal();\n\t\t\t\tthis.logService.info('Did reset the last synced state of profiles');\n\t\t\t\tthis.logService.info(`Updating remote profiles with invalid collections on server`);\n\t\t\t\tawait profileManifestSynchronizer.updateRemoteProfiles(updatedRemoteProfiles, null);\n\t\t\t\tthis.logService.info(`Updated remote profiles on server`);\n\t\t\t} finally {\n\t\t\t\tprofileManifestSynchronizer.dispose();\n\t\t\t}\n\t\t}\n\t}\n\n\tasync saveRemoteActivityData(location: URI): Promise<void> {\n\t\tthis.checkEnablement();\n\t\tconst data = await this.userDataSyncStoreService.getActivityData();\n\t\tawait this.fileService.writeFile(location, data);\n\t}\n\n\tasync extractActivityData(activityDataResource: URI, location: URI): Promise<void> {\n\t\tconst content = (await this.fileService.readFile(activityDataResource)).value.toString();\n\t\tconst activityData: IUserDataSyncActivityData = JSON.parse(content);\n\n\t\tif (activityData.resources) {\n\t\t\tfor (const resource in activityData.resources) {\n\t\t\t\tfor (const version of activityData.resources[resource]) {\n\t\t\t\t\tawait this.userDataSyncLocalStoreService.writeResource(resource as SyncResource, version.content, new Date(version.created * 1000), undefined, location);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (activityData.collections) {\n\t\t\tfor (const collection in activityData.collections) {\n\t\t\t\tfor (const resource in activityData.collections[collection].resources) {\n\t\t\t\t\tfor (const version of activityData.collections[collection].resources?.[resource] ?? []) {\n\t\t\t\t\t\tawait this.userDataSyncLocalStoreService.writeResource(resource as SyncResource, version.content, new Date(version.created * 1000), collection, location);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async performAction<T>(profile: IUserDataProfile, action: (synchroniser: IUserDataSynchroniser) => Promise<T | undefined>): Promise<T | null> {\n\t\tconst disposables = new DisposableStore();\n\t\ttry {\n\t\t\tconst activeProfileSyncronizer = this.activeProfileSynchronizers.get(profile.id);\n\t\t\tif (activeProfileSyncronizer) {\n\t\t\t\tconst result = await this.performActionWithProfileSynchronizer(activeProfileSyncronizer[0], action, disposables);\n\t\t\t\treturn isUndefined(result) ? null : result;\n\t\t\t}\n\n\t\t\tif (profile.isDefault) {\n\t\t\t\tconst defaultProfileSynchronizer = disposables.add(this.instantiationService.createInstance(ProfileSynchronizer, profile, undefined));\n\t\t\t\tconst result = await this.performActionWithProfileSynchronizer(defaultProfileSynchronizer, action, disposables);\n\t\t\t\treturn isUndefined(result) ? null : result;\n\t\t\t}\n\n\t\t\tconst userDataProfileManifestSynchronizer = disposables.add(this.instantiationService.createInstance(UserDataProfilesManifestSynchroniser, profile, undefined));\n\t\t\tconst manifest = await this.userDataSyncStoreService.manifest(null);\n\t\t\tconst syncProfiles = (await userDataProfileManifestSynchronizer.getRemoteSyncedProfiles(manifest?.latest?.profiles ?? null)) || [];\n\t\t\tconst syncProfile = syncProfiles.find(syncProfile => syncProfile.id === profile.id);\n\t\t\tif (syncProfile) {\n\t\t\t\tconst profileSynchronizer = disposables.add(this.instantiationService.createInstance(ProfileSynchronizer, profile, syncProfile.collection));\n\t\t\t\tconst result = await this.performActionWithProfileSynchronizer(profileSynchronizer, action, disposables);\n\t\t\t\treturn isUndefined(result) ? null : result;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t} finally {\n\t\t\tdisposables.dispose();\n\t\t}\n\t}\n\n\tprivate async performActionWithProfileSynchronizer<T>(profileSynchronizer: ProfileSynchronizer, action: (synchroniser: IUserDataSynchroniser) => Promise<T | undefined>, disposables: DisposableStore): Promise<T | undefined> {\n\t\tconst allSynchronizers = [...profileSynchronizer.enabled, ...profileSynchronizer.disabled.reduce<(IUserDataSynchroniser & IDisposable)[]>((synchronizers, syncResource) => {\n\t\t\tif (syncResource !== SyncResource.WorkspaceState) {\n\t\t\t\tsynchronizers.push(disposables.add(profileSynchronizer.createSynchronizer(syncResource)));\n\t\t\t}\n\t\t\treturn synchronizers;\n\t\t}, [])];\n\t\tfor (const synchronizer of allSynchronizers) {\n\t\t\tconst result = await action(synchronizer);\n\t\t\tif (!isUndefined(result)) {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprivate setStatus(status: SyncStatus): void {\n\t\tconst oldStatus = this._status;\n\t\tif (this._status !== status) {\n\t\t\tthis._status = status;\n\t\t\tthis._onDidChangeStatus.fire(status);\n\t\t\tif (oldStatus === SyncStatus.HasConflicts) {\n\t\t\t\tthis.updateLastSyncTime();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate updateConflicts(): void {\n\t\tconst conflicts = this.getActiveProfileSynchronizers().map(synchronizer => synchronizer.conflicts).flat();\n\t\tif (!equals(this._conflicts, conflicts, (a, b) => a.profile.id === b.profile.id && a.syncResource === b.syncResource && equals(a.conflicts, b.conflicts, (a, b) => isEqual(a.previewResource, b.previewResource)))) {\n\t\t\tthis._conflicts = conflicts;\n\t\t\tthis._onDidChangeConflicts.fire(conflicts);\n\t\t}\n\t}\n\n\tprivate updateLastSyncTime(): void {\n\t\tif (this.status === SyncStatus.Idle) {\n\t\t\tthis._lastSyncTime = new Date().getTime();\n\t\t\tthis.storageService.store(LAST_SYNC_TIME_KEY, this._lastSyncTime, StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\t\tthis._onDidChangeLastSyncTime.fire(this._lastSyncTime);\n\t\t}\n\t}\n\n\tgetOrCreateActiveProfileSynchronizer(profile: IUserDataProfile, syncProfile: ISyncUserDataProfile | undefined): ProfileSynchronizer {\n\t\tlet activeProfileSynchronizer = this.activeProfileSynchronizers.get(profile.id);\n\t\tif (activeProfileSynchronizer && activeProfileSynchronizer[0].collection !== syncProfile?.collection) {\n\t\t\tthis.logService.error('Profile synchronizer collection does not match with the remote sync profile collection');\n\t\t\tactiveProfileSynchronizer[1].dispose();\n\t\t\tactiveProfileSynchronizer = undefined;\n\t\t\tthis.activeProfileSynchronizers.delete(profile.id);\n\t\t}\n\t\tif (!activeProfileSynchronizer) {\n\t\t\tconst disposables = new DisposableStore();\n\t\t\tconst profileSynchronizer = disposables.add(this.instantiationService.createInstance(ProfileSynchronizer, profile, syncProfile?.collection));\n\t\t\tdisposables.add(profileSynchronizer.onDidChangeStatus(e => this.setStatus(e)));\n\t\t\tdisposables.add(profileSynchronizer.onDidChangeConflicts(conflicts => this.updateConflicts()));\n\t\t\tdisposables.add(profileSynchronizer.onDidChangeLocal(e => this._onDidChangeLocal.fire(e)));\n\t\t\tthis.activeProfileSynchronizers.set(profile.id, activeProfileSynchronizer = [profileSynchronizer, disposables]);\n\t\t}\n\t\treturn activeProfileSynchronizer[0];\n\t}\n\n\tprivate getActiveProfileSynchronizers(): ProfileSynchronizer[] {\n\t\tconst profileSynchronizers: ProfileSynchronizer[] = [];\n\t\tfor (const [profileSynchronizer] of this.activeProfileSynchronizers.values()) {\n\t\t\tprofileSynchronizers.push(profileSynchronizer);\n\t\t}\n\t\treturn profileSynchronizers;\n\t}\n\n\tprivate clearActiveProfileSynchronizers(): void {\n\t\tthis.activeProfileSynchronizers.forEach(([, disposable]) => disposable.dispose());\n\t\tthis.activeProfileSynchronizers.clear();\n\t}\n\n\tprivate checkEnablement(): void {\n\t\tif (!this.userDataSyncStoreManagementService.userDataSyncStore) {\n\t\t\tthrow new Error('Not enabled');\n\t\t}\n\t}\n\n}\n\n\nclass ProfileSynchronizer extends Disposable {\n\n\tprivate _enabled: [IUserDataSynchroniser, number, IDisposable][] = [];\n\tget enabled(): IUserDataSynchroniser[] { return this._enabled.sort((a, b) => a[1] - b[1]).map(([synchronizer]) => synchronizer); }\n\n\tget disabled(): SyncResource[] { return ALL_SYNC_RESOURCES.filter(syncResource => !this.userDataSyncEnablementService.isResourceEnabled(syncResource)); }\n\n\tprivate _status: SyncStatus = SyncStatus.Idle;\n\tget status(): SyncStatus { return this._status; }\n\tprivate _onDidChangeStatus: Emitter<SyncStatus> = this._register(new Emitter<SyncStatus>());\n\treadonly onDidChangeStatus: Event<SyncStatus> = this._onDidChangeStatus.event;\n\n\tprivate _onDidChangeLocal = this._register(new Emitter<SyncResource>());\n\treadonly onDidChangeLocal = this._onDidChangeLocal.event;\n\n\tprivate _conflicts: IUserDataSyncResourceConflicts[] = [];\n\tget conflicts(): IUserDataSyncResourceConflicts[] { return this._conflicts; }\n\tprivate _onDidChangeConflicts = this._register(new Emitter<IUserDataSyncResourceConflicts[]>());\n\treadonly onDidChangeConflicts = this._onDidChangeConflicts.event;\n\n\tconstructor(\n\t\treadonly profile: IUserDataProfile,\n\t\treadonly collection: string | undefined,\n\t\t@IUserDataSyncEnablementService private readonly userDataSyncEnablementService: IUserDataSyncEnablementService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IExtensionGalleryService private readonly extensionGalleryService: IExtensionGalleryService,\n\t\t@IUserDataSyncStoreManagementService private readonly userDataSyncStoreManagementService: IUserDataSyncStoreManagementService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IUserDataSyncLogService private readonly logService: IUserDataSyncLogService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t) {\n\t\tsuper();\n\t\tthis._register(userDataSyncEnablementService.onDidChangeResourceEnablement(([syncResource, enablement]) => this.onDidChangeResourceEnablement(syncResource, enablement)));\n\t\tthis._register(toDisposable(() => this._enabled.splice(0, this._enabled.length).forEach(([, , disposable]) => disposable.dispose())));\n\t\tfor (const syncResource of ALL_SYNC_RESOURCES) {\n\t\t\tif (userDataSyncEnablementService.isResourceEnabled(syncResource)) {\n\t\t\t\tthis.registerSynchronizer(syncResource);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate onDidChangeResourceEnablement(syncResource: SyncResource, enabled: boolean): void {\n\t\tif (enabled) {\n\t\t\tthis.registerSynchronizer(syncResource);\n\t\t} else {\n\t\t\tthis.deRegisterSynchronizer(syncResource);\n\t\t}\n\t}\n\n\tprotected registerSynchronizer(syncResource: SyncResource): void {\n\t\tif (this._enabled.some(([synchronizer]) => synchronizer.resource === syncResource)) {\n\t\t\treturn;\n\t\t}\n\t\tif (syncResource === SyncResource.Extensions && !this.extensionGalleryService.isEnabled()) {\n\t\t\tthis.logService.info('Skipping extensions sync because gallery is not configured');\n\t\t\treturn;\n\t\t}\n\t\tif (syncResource === SyncResource.Profiles) {\n\t\t\tif (!this.profile.isDefault) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tif (syncResource === SyncResource.WorkspaceState) {\n\t\t\treturn;\n\t\t}\n\t\tif (syncResource !== SyncResource.Profiles && this.profile.useDefaultFlags?.[syncResource]) {\n\t\t\tthis.logService.debug(`Skipping syncing ${syncResource} in ${this.profile.name} because it is already synced by default profile`);\n\t\t\treturn;\n\t\t}\n\t\tconst disposables = new DisposableStore();\n\t\tconst synchronizer = disposables.add(this.createSynchronizer(syncResource));\n\t\tdisposables.add(synchronizer.onDidChangeStatus(() => this.updateStatus()));\n\t\tdisposables.add(synchronizer.onDidChangeConflicts(() => this.updateConflicts()));\n\t\tdisposables.add(synchronizer.onDidChangeLocal(() => this._onDidChangeLocal.fire(syncResource)));\n\t\tconst order = this.getOrder(syncResource);\n\t\tthis._enabled.push([synchronizer, order, disposables]);\n\t}\n\n\tprivate deRegisterSynchronizer(syncResource: SyncResource): void {\n\t\tconst index = this._enabled.findIndex(([synchronizer]) => synchronizer.resource === syncResource);\n\t\tif (index !== -1) {\n\t\t\tconst [[synchronizer, , disposable]] = this._enabled.splice(index, 1);\n\t\t\tdisposable.dispose();\n\t\t\tthis.updateStatus();\n\t\t\tsynchronizer.stop().then(null, error => this.logService.error(error));\n\t\t}\n\t}\n\n\tcreateSynchronizer(syncResource: Exclude<SyncResource, SyncResource.WorkspaceState>): IUserDataSynchroniser & IDisposable {\n\t\tswitch (syncResource) {\n\t\t\tcase SyncResource.Settings: return this.instantiationService.createInstance(SettingsSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Keybindings: return this.instantiationService.createInstance(KeybindingsSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Snippets: return this.instantiationService.createInstance(SnippetsSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Prompts: return this.instantiationService.createInstance(PromptsSynchronizer, this.profile, this.collection);\n\t\t\tcase SyncResource.Tasks: return this.instantiationService.createInstance(TasksSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Mcp: return this.instantiationService.createInstance(McpSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.GlobalState: return this.instantiationService.createInstance(GlobalStateSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Extensions: return this.instantiationService.createInstance(ExtensionsSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Profiles: return this.instantiationService.createInstance(UserDataProfilesManifestSynchroniser, this.profile, this.collection);\n\t\t}\n\t}\n\n\tasync sync(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, preview: boolean, executionId: string, token: CancellationToken): Promise<[SyncResource, UserDataSyncError][]> {\n\n\t\t// Return if cancellation is requested\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst synchronizers = this.enabled;\n\t\tif (!synchronizers.length) {\n\t\t\treturn [];\n\t\t}\n\n\t\ttry {\n\t\t\tconst syncErrors: [SyncResource, UserDataSyncError][] = [];\n\t\t\tconst syncHeaders = createSyncHeaders(executionId);\n\t\t\tconst userDataSyncConfiguration = preview ? await this.getUserDataSyncConfiguration(manifestOrLatestData) : this.getLocalUserDataSyncConfiguration();\n\t\t\tfor (const synchroniser of synchronizers) {\n\t\t\t\t// Return if cancellation is requested\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\n\t\t\t\t// Return if resource is not enabled\n\t\t\t\tif (!this.userDataSyncEnablementService.isResourceEnabled(synchroniser.resource)) {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\tconst refOrUserData = getRefOrUserData(manifestOrLatestData, this.collection, synchroniser.resource) ?? null;\n\t\t\t\t\tawait synchroniser.sync(refOrUserData, preview, userDataSyncConfiguration, syncHeaders);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(e);\n\t\t\t\t\treportUserDataSyncError(userDataSyncError, executionId, this.userDataSyncStoreManagementService, this.telemetryService);\n\t\t\t\t\tif (canBailout(e)) {\n\t\t\t\t\t\tthrow userDataSyncError;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Log and and continue\n\t\t\t\t\tthis.logService.error(e);\n\t\t\t\t\tthis.logService.error(`${synchroniser.resource}: ${toErrorMessage(e)}`);\n\t\t\t\t\tsyncErrors.push([synchroniser.resource, userDataSyncError]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn syncErrors;\n\t\t} finally {\n\t\t\tthis.updateStatus();\n\t\t}\n\t}\n\n\tasync apply(executionId: string, token: CancellationToken): Promise<void> {\n\t\tconst syncHeaders = createSyncHeaders(executionId);\n\t\tfor (const synchroniser of this.enabled) {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tawait synchroniser.apply(false, syncHeaders);\n\t\t\t} catch (e) {\n\t\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(e);\n\t\t\t\treportUserDataSyncError(userDataSyncError, executionId, this.userDataSyncStoreManagementService, this.telemetryService);\n\t\t\t\tif (canBailout(e)) {\n\t\t\t\t\tthrow userDataSyncError;\n\t\t\t\t}\n\n\t\t\t\t// Log and and continue\n\t\t\t\tthis.logService.error(e);\n\t\t\t\tthis.logService.error(`${synchroniser.resource}: ${toErrorMessage(e)}`);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync stop(): Promise<void> {\n\t\tfor (const synchroniser of this.enabled) {\n\t\t\ttry {\n\t\t\t\tif (synchroniser.status !== SyncStatus.Idle) {\n\t\t\t\t\tawait synchroniser.stop();\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tthis.logService.error(e);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync resetLocal(): Promise<void> {\n\t\tfor (const synchroniser of this.enabled) {\n\t\t\ttry {\n\t\t\t\tawait synchroniser.resetLocal();\n\t\t\t} catch (e) {\n\t\t\t\tthis.logService.error(`${synchroniser.resource}: ${toErrorMessage(e)}`);\n\t\t\t\tthis.logService.error(e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async getUserDataSyncConfiguration(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null): Promise<IUserDataSyncConfiguration> {\n\t\tif (!this.profile.isDefault) {\n\t\t\treturn {};\n\t\t}\n\t\tconst local = this.getLocalUserDataSyncConfiguration();\n\t\tconst settingsSynchronizer = this.enabled.find(synchronizer => synchronizer instanceof SettingsSynchroniser);\n\t\tif (settingsSynchronizer) {\n\t\t\tconst remote = await settingsSynchronizer.getRemoteUserDataSyncConfiguration(getRefOrUserData(manifestOrLatestData, this.collection, SyncResource.Settings) ?? null);\n\t\t\treturn { ...local, ...remote };\n\t\t}\n\t\treturn local;\n\t}\n\n\tprivate getLocalUserDataSyncConfiguration(): IUserDataSyncConfiguration {\n\t\treturn this.configurationService.getValue(USER_DATA_SYNC_CONFIGURATION_SCOPE);\n\t}\n\n\tprivate setStatus(status: SyncStatus): void {\n\t\tif (this._status !== status) {\n\t\t\tthis._status = status;\n\t\t\tthis._onDidChangeStatus.fire(status);\n\t\t}\n\t}\n\n\tprivate updateStatus(): void {\n\t\tthis.updateConflicts();\n\t\tif (this.enabled.some(s => s.status === SyncStatus.HasConflicts)) {\n\t\t\treturn this.setStatus(SyncStatus.HasConflicts);\n\t\t}\n\t\tif (this.enabled.some(s => s.status === SyncStatus.Syncing)) {\n\t\t\treturn this.setStatus(SyncStatus.Syncing);\n\t\t}\n\t\treturn this.setStatus(SyncStatus.Idle);\n\t}\n\n\tprivate updateConflicts(): void {\n\t\tconst conflicts = this.enabled.filter(s => s.status === SyncStatus.HasConflicts)\n\t\t\t.filter(s => s.conflicts.conflicts.length > 0)\n\t\t\t.map(s => s.conflicts);\n\t\tif (!equals(this._conflicts, conflicts, (a, b) => a.syncResource === b.syncResource && equals(a.conflicts, b.conflicts, (a, b) => isEqual(a.previewResource, b.previewResource)))) {\n\t\t\tthis._conflicts = conflicts;\n\t\t\tthis._onDidChangeConflicts.fire(conflicts);\n\t\t}\n\t}\n\n\tprivate getOrder(syncResource: SyncResource): number {\n\t\tswitch (syncResource) {\n\t\t\tcase SyncResource.Settings: return 0;\n\t\t\tcase SyncResource.Keybindings: return 1;\n\t\t\tcase SyncResource.Snippets: return 2;\n\t\t\tcase SyncResource.Tasks: return 3;\n\t\t\tcase SyncResource.Mcp: return 4;\n\t\t\tcase SyncResource.GlobalState: return 5;\n\t\t\tcase SyncResource.Extensions: return 6;\n\t\t\tcase SyncResource.Prompts: return 7;\n\t\t\tcase SyncResource.Profiles: return 8;\n\t\t\tcase SyncResource.WorkspaceState: return 9;\n\t\t}\n\t}\n}\n\nfunction canBailout(e: unknown): boolean {\n\tif (e instanceof UserDataSyncError) {\n\t\tswitch (e.code) {\n\t\t\tcase UserDataSyncErrorCode.MethodNotFound:\n\t\t\tcase UserDataSyncErrorCode.TooLarge:\n\t\t\tcase UserDataSyncErrorCode.TooManyRequests:\n\t\t\tcase UserDataSyncErrorCode.TooManyRequestsAndRetryAfter:\n\t\t\tcase UserDataSyncErrorCode.LocalTooManyRequests:\n\t\t\tcase UserDataSyncErrorCode.LocalTooManyProfiles:\n\t\t\tcase UserDataSyncErrorCode.Gone:\n\t\t\tcase UserDataSyncErrorCode.UpgradeRequired:\n\t\t\tcase UserDataSyncErrorCode.IncompatibleRemoteContent:\n\t\t\tcase UserDataSyncErrorCode.IncompatibleLocalContent:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\nfunction reportUserDataSyncError(userDataSyncError: UserDataSyncError, executionId: string, userDataSyncStoreManagementService: IUserDataSyncStoreManagementService, telemetryService: ITelemetryService): void {\n\ttelemetryService.publicLog2<SyncErrorEvent, SyncErrorClassification>('sync/error',\n\t\t{\n\t\t\tcode: userDataSyncError.code,\n\t\t\tserverCode: userDataSyncError instanceof UserDataSyncStoreError ? String(userDataSyncError.serverCode) : undefined,\n\t\t\turl: userDataSyncError instanceof UserDataSyncStoreError ? userDataSyncError.url : undefined,\n\t\t\tresource: userDataSyncError.resource,\n\t\t\texecutionId,\n\t\t\tservice: userDataSyncStoreManagementService.userDataSyncStore!.url.toString()\n\t\t});\n}\n\nfunction getRefOrUserData(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, collection: string | undefined, resource: SyncResource): string | IUserData | undefined {\n\tif (isUserDataManifest(manifestOrLatestData)) {\n\t\tif (collection) {\n\t\t\treturn manifestOrLatestData?.collections?.[collection]?.latest?.[resource];\n\t\t}\n\t\treturn manifestOrLatestData?.latest?.[resource];\n\t}\n\tif (collection) {\n\t\treturn manifestOrLatestData?.collections?.[collection]?.resources?.[resource];\n\t}\n\treturn manifestOrLatestData?.resources?.[resource];\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { equals } from '../../../base/common/arrays.js';\nimport { CancelablePromise, createCancelablePromise, RunOnceScheduler } from '../../../base/common/async.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { toErrorMessage } from '../../../base/common/errorMessage.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, DisposableStore, IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { isEqual } from '../../../base/common/resources.js';\nimport { isBoolean, isUndefined } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { IConfigurationService } from '../../configuration/common/configuration.js';\nimport { IExtensionGalleryService } from '../../extensionManagement/common/extensionManagement.js';\nimport { IFileService } from '../../files/common/files.js';\nimport { IInstantiationService } from '../../instantiation/common/instantiation.js';\nimport { IStorageService, StorageScope, StorageTarget } from '../../storage/common/storage.js';\nimport { ITelemetryService } from '../../telemetry/common/telemetry.js';\nimport { IUserDataProfile, IUserDataProfilesService } from '../../userDataProfile/common/userDataProfile.js';\nimport { ExtensionsSynchroniser } from './extensionsSync.js';\nimport { GlobalStateSynchroniser } from './globalStateSync.js';\nimport { KeybindingsSynchroniser } from './keybindingsSync.js';\nimport { PromptsSynchronizer } from './promptsSync/promptsSync.js';\nimport { SettingsSynchroniser } from './settingsSync.js';\nimport { SnippetsSynchroniser } from './snippetsSync.js';\nimport { TasksSynchroniser } from './tasksSync.js';\nimport { McpSynchroniser } from './mcpSync.js';\nimport { UserDataProfilesManifestSynchroniser } from './userDataProfilesManifestSync.js';\nimport {\n\tALL_SYNC_RESOURCES, createSyncHeaders, IUserDataManualSyncTask, IUserDataSyncResourceConflicts, IUserDataSyncResourceError,\n\tIUserDataSyncResource, ISyncResourceHandle, IUserDataSyncTask, ISyncUserDataProfile, IUserDataManifest, IUserDataSyncConfiguration,\n\tIUserDataSyncEnablementService, IUserDataSynchroniser, IUserDataSyncLogService, IUserDataSyncService, IUserDataSyncStoreManagementService, IUserDataSyncStoreService,\n\tSyncResource, SyncStatus, UserDataSyncError, UserDataSyncErrorCode, UserDataSyncStoreError, USER_DATA_SYNC_CONFIGURATION_SCOPE, IUserDataSyncResourceProviderService, IUserDataSyncActivityData, IUserDataSyncLocalStoreService,\n\tIUserDataSyncLatestData,\n\tIUserData,\n\tisUserDataManifest,\n} from './userDataSync.js';\n\ntype SyncErrorClassification = {\n\towner: 'sandy081';\n\tcomment: 'Information about the error that occurred while syncing';\n\tcode: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'error code' };\n\tservice: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync service for which this error has occurred' };\n\tserverCode?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync service error code' };\n\turl?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync resource URL for which this error has occurred' };\n\tresource?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync resource for which this error has occurred' };\n\texecutionId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Settings Sync execution id for which this error has occurred' };\n};\n\ntype SyncErrorEvent = {\n\tcode: string;\n\tservice: string;\n\tserverCode?: string;\n\turl?: string;\n\tresource?: string;\n\texecutionId?: string;\n};\n\nconst LAST_SYNC_TIME_KEY = 'sync.lastSyncTime';\n\nexport class UserDataSyncService extends Disposable implements IUserDataSyncService {\n\n\t_serviceBrand: undefined;\n\n\tprivate _status: SyncStatus = SyncStatus.Uninitialized;\n\tget status(): SyncStatus { return this._status; }\n\tprivate _onDidChangeStatus: Emitter<SyncStatus> = this._register(new Emitter<SyncStatus>());\n\treadonly onDidChangeStatus: Event<SyncStatus> = this._onDidChangeStatus.event;\n\n\tprivate _onDidChangeLocal = this._register(new Emitter<SyncResource>());\n\treadonly onDidChangeLocal = this._onDidChangeLocal.event;\n\n\tprivate _conflicts: IUserDataSyncResourceConflicts[] = [];\n\tget conflicts(): IUserDataSyncResourceConflicts[] { return this._conflicts; }\n\tprivate _onDidChangeConflicts = this._register(new Emitter<IUserDataSyncResourceConflicts[]>());\n\treadonly onDidChangeConflicts = this._onDidChangeConflicts.event;\n\n\tprivate _syncErrors: IUserDataSyncResourceError[] = [];\n\tprivate _onSyncErrors = this._register(new Emitter<IUserDataSyncResourceError[]>());\n\treadonly onSyncErrors = this._onSyncErrors.event;\n\n\tprivate _lastSyncTime: number | undefined = undefined;\n\tget lastSyncTime(): number | undefined { return this._lastSyncTime; }\n\tprivate _onDidChangeLastSyncTime: Emitter<number> = this._register(new Emitter<number>());\n\treadonly onDidChangeLastSyncTime: Event<number> = this._onDidChangeLastSyncTime.event;\n\n\tprivate _onDidResetLocal = this._register(new Emitter<void>());\n\treadonly onDidResetLocal = this._onDidResetLocal.event;\n\n\tprivate _onDidResetRemote = this._register(new Emitter<void>());\n\treadonly onDidResetRemote = this._onDidResetRemote.event;\n\n\tprivate activeProfileSynchronizers = new Map<string, [ProfileSynchronizer, IDisposable]>();\n\n\tconstructor(\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IUserDataSyncStoreService private readonly userDataSyncStoreService: IUserDataSyncStoreService,\n\t\t@IUserDataSyncStoreManagementService private readonly userDataSyncStoreManagementService: IUserDataSyncStoreManagementService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IUserDataSyncLogService private readonly logService: IUserDataSyncLogService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IStorageService private readonly storageService: IStorageService,\n\t\t@IUserDataSyncEnablementService private readonly userDataSyncEnablementService: IUserDataSyncEnablementService,\n\t\t@IUserDataProfilesService private readonly userDataProfilesService: IUserDataProfilesService,\n\t\t@IUserDataSyncResourceProviderService private readonly userDataSyncResourceProviderService: IUserDataSyncResourceProviderService,\n\t\t@IUserDataSyncLocalStoreService private readonly userDataSyncLocalStoreService: IUserDataSyncLocalStoreService,\n\t) {\n\t\tsuper();\n\t\tthis._status = userDataSyncStoreManagementService.userDataSyncStore ? SyncStatus.Idle : SyncStatus.Uninitialized;\n\t\tthis._lastSyncTime = this.storageService.getNumber(LAST_SYNC_TIME_KEY, StorageScope.APPLICATION, undefined);\n\t\tthis._register(toDisposable(() => this.clearActiveProfileSynchronizers()));\n\n\t\tthis._register(new RunOnceScheduler(() => this.cleanUpStaleStorageData(), 5 * 1000 /* after 5s */)).schedule();\n\t}\n\n\tasync createSyncTask(manifest: IUserDataManifest | null, disableCache?: boolean): Promise<IUserDataSyncTask> {\n\t\tthis.checkEnablement();\n\n\t\tthis.logService.info('Sync started.');\n\t\tconst startTime = new Date().getTime();\n\t\tconst executionId = generateUuid();\n\t\ttry {\n\t\t\tconst syncHeaders = createSyncHeaders(executionId);\n\t\t\tif (disableCache) {\n\t\t\t\tsyncHeaders['Cache-Control'] = 'no-cache';\n\t\t\t}\n\t\t\tmanifest = await this.userDataSyncStoreService.manifest(manifest, syncHeaders);\n\t\t} catch (error) {\n\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(error);\n\t\t\treportUserDataSyncError(userDataSyncError, executionId, this.userDataSyncStoreManagementService, this.telemetryService);\n\t\t\tthrow userDataSyncError;\n\t\t}\n\n\t\tconst executed = false;\n\t\tconst that = this;\n\t\tlet cancellablePromise: CancelablePromise<void> | undefined;\n\t\treturn {\n\t\t\tmanifest,\n\t\t\tasync run(): Promise<void> {\n\t\t\t\tif (executed) {\n\t\t\t\t\tthrow new Error('Can run a task only once');\n\t\t\t\t}\n\t\t\t\tcancellablePromise = createCancelablePromise(token => that.sync(manifest, false, executionId, token));\n\t\t\t\tawait cancellablePromise.finally(() => cancellablePromise = undefined);\n\t\t\t\tthat.logService.info(`Sync done. Took ${new Date().getTime() - startTime}ms`);\n\t\t\t\tthat.updateLastSyncTime();\n\t\t\t},\n\t\t\tstop(): Promise<void> {\n\t\t\t\tcancellablePromise?.cancel();\n\t\t\t\treturn that.stop();\n\t\t\t}\n\t\t};\n\t}\n\n\tasync createManualSyncTask(): Promise<IUserDataManualSyncTask> {\n\t\tthis.checkEnablement();\n\n\t\tif (this.userDataSyncEnablementService.isEnabled()) {\n\t\t\tthrow new UserDataSyncError('Cannot start manual sync when sync is enabled', UserDataSyncErrorCode.LocalError);\n\t\t}\n\n\t\tthis.logService.info('Sync started.');\n\t\tconst startTime = new Date().getTime();\n\t\tconst executionId = generateUuid();\n\t\tconst syncHeaders = createSyncHeaders(executionId);\n\t\tlet latestUserDataOrManifest: IUserDataSyncLatestData | IUserDataManifest | null;\n\t\ttry {\n\t\t\tlatestUserDataOrManifest = await this.userDataSyncStoreService.getLatestData(syncHeaders);\n\t\t} catch (error) {\n\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(error);\n\t\t\tthis.telemetryService.publicLog2<SyncErrorEvent, SyncErrorClassification>('sync.download.latest',\n\t\t\t\t{\n\t\t\t\t\tcode: userDataSyncError.code,\n\t\t\t\t\tserverCode: userDataSyncError instanceof UserDataSyncStoreError ? String(userDataSyncError.serverCode) : undefined,\n\t\t\t\t\turl: userDataSyncError instanceof UserDataSyncStoreError ? userDataSyncError.url : undefined,\n\t\t\t\t\tresource: userDataSyncError.resource,\n\t\t\t\t\texecutionId,\n\t\t\t\t\tservice: this.userDataSyncStoreManagementService.userDataSyncStore!.url.toString()\n\t\t\t\t});\n\n\t\t\t// Fallback to manifest in stable\n\t\t\ttry {\n\t\t\t\tlatestUserDataOrManifest = await this.userDataSyncStoreService.manifest(null, syncHeaders);\n\t\t\t} catch (error) {\n\t\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(error);\n\t\t\t\treportUserDataSyncError(userDataSyncError, executionId, this.userDataSyncStoreManagementService, this.telemetryService);\n\t\t\t\tthrow userDataSyncError;\n\t\t\t}\n\t\t}\n\n\t\t/* Manual sync shall start on clean local state */\n\t\tawait this.resetLocal();\n\n\t\tconst that = this;\n\t\tconst cancellableToken = new CancellationTokenSource();\n\t\treturn {\n\t\t\tid: executionId,\n\t\t\tasync merge(): Promise<void> {\n\t\t\t\treturn that.sync(latestUserDataOrManifest, true, executionId, cancellableToken.token);\n\t\t\t},\n\t\t\tasync apply(): Promise<void> {\n\t\t\t\ttry {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait that.applyManualSync(latestUserDataOrManifest, executionId, cancellableToken.token);\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tif (UserDataSyncError.toUserDataSyncError(error).code === UserDataSyncErrorCode.MethodNotFound) {\n\t\t\t\t\t\t\tthat.logService.info('Client is making invalid requests. Cleaning up data...');\n\t\t\t\t\t\t\tawait that.cleanUpRemoteData();\n\t\t\t\t\t\t\tthat.logService.info('Applying manual sync again...');\n\t\t\t\t\t\t\tawait that.applyManualSync(latestUserDataOrManifest, executionId, cancellableToken.token);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthrow error;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthat.logService.error(error);\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t\tthat.logService.info(`Sync done. Took ${new Date().getTime() - startTime}ms`);\n\t\t\t\tthat.updateLastSyncTime();\n\t\t\t},\n\t\t\tasync stop(): Promise<void> {\n\t\t\t\tcancellableToken.cancel();\n\t\t\t\tawait that.stop();\n\t\t\t\tawait that.resetLocal();\n\t\t\t}\n\t\t};\n\t}\n\n\tprivate async sync(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, preview: boolean, executionId: string, token: CancellationToken): Promise<void> {\n\t\tthis._syncErrors = [];\n\t\ttry {\n\t\t\tif (this.status !== SyncStatus.HasConflicts) {\n\t\t\t\tthis.setStatus(SyncStatus.Syncing);\n\t\t\t}\n\n\t\t\t// Sync Default Profile First\n\t\t\tconst defaultProfileSynchronizer = this.getOrCreateActiveProfileSynchronizer(this.userDataProfilesService.defaultProfile, undefined);\n\t\t\tthis._syncErrors.push(...await this.syncProfile(defaultProfileSynchronizer, manifestOrLatestData, preview, executionId, token));\n\n\t\t\t// Sync other profiles\n\t\t\tconst userDataProfileManifestSynchronizer = defaultProfileSynchronizer.enabled.find(s => s.resource === SyncResource.Profiles);\n\t\t\tif (userDataProfileManifestSynchronizer) {\n\t\t\t\tconst syncProfiles = (await (userDataProfileManifestSynchronizer as UserDataProfilesManifestSynchroniser).getLastSyncedProfiles()) || [];\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tawait this.syncRemoteProfiles(syncProfiles, manifestOrLatestData, preview, executionId, token);\n\t\t\t}\n\t\t} finally {\n\t\t\tif (this.status !== SyncStatus.HasConflicts) {\n\t\t\t\tthis.setStatus(SyncStatus.Idle);\n\t\t\t}\n\t\t\tthis._onSyncErrors.fire(this._syncErrors);\n\t\t}\n\t}\n\n\tprivate async syncRemoteProfiles(remoteProfiles: ISyncUserDataProfile[], manifest: IUserDataManifest | IUserDataSyncLatestData | null, preview: boolean, executionId: string, token: CancellationToken): Promise<void> {\n\t\tfor (const syncProfile of remoteProfiles) {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst profile = this.userDataProfilesService.profiles.find(p => p.id === syncProfile.id);\n\t\t\tif (!profile) {\n\t\t\t\tthis.logService.error(`Profile with id:${syncProfile.id} and name: ${syncProfile.name} does not exist locally to sync.`);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tthis.logService.info('Syncing profile.', syncProfile.name);\n\t\t\tconst profileSynchronizer = this.getOrCreateActiveProfileSynchronizer(profile, syncProfile);\n\t\t\tthis._syncErrors.push(...await this.syncProfile(profileSynchronizer, manifest, preview, executionId, token));\n\t\t}\n\t\t// Dispose & Delete profile synchronizers which do not exist anymore\n\t\tfor (const [key, profileSynchronizerItem] of this.activeProfileSynchronizers.entries()) {\n\t\t\tif (this.userDataProfilesService.profiles.some(p => p.id === profileSynchronizerItem[0].profile.id)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tawait profileSynchronizerItem[0].resetLocal();\n\t\t\tprofileSynchronizerItem[1].dispose();\n\t\t\tthis.activeProfileSynchronizers.delete(key);\n\t\t}\n\t}\n\n\tprivate async applyManualSync(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, executionId: string, token: CancellationToken): Promise<void> {\n\t\ttry {\n\t\t\tthis.setStatus(SyncStatus.Syncing);\n\t\t\tconst profileSynchronizers = this.getActiveProfileSynchronizers();\n\t\t\tfor (const profileSynchronizer of profileSynchronizers) {\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tawait profileSynchronizer.apply(executionId, token);\n\t\t\t}\n\n\t\t\tconst defaultProfileSynchronizer = profileSynchronizers.find(s => s.profile.isDefault);\n\t\t\tif (!defaultProfileSynchronizer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst userDataProfileManifestSynchronizer = defaultProfileSynchronizer.enabled.find(s => s.resource === SyncResource.Profiles);\n\t\t\tif (!userDataProfileManifestSynchronizer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Sync remote profiles which are not synced locally\n\t\t\tconst remoteProfiles = (await (userDataProfileManifestSynchronizer as UserDataProfilesManifestSynchroniser).getRemoteSyncedProfiles(getRefOrUserData(manifestOrLatestData, undefined, SyncResource.Profiles) ?? null)) || [];\n\t\t\tconst remoteProfilesToSync = remoteProfiles.filter(remoteProfile => profileSynchronizers.every(s => s.profile.id !== remoteProfile.id));\n\t\t\tif (remoteProfilesToSync.length) {\n\t\t\t\tawait this.syncRemoteProfiles(remoteProfilesToSync, manifestOrLatestData, false, executionId, token);\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.setStatus(SyncStatus.Idle);\n\t\t}\n\t}\n\n\tprivate async syncProfile(profileSynchronizer: ProfileSynchronizer, manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, preview: boolean, executionId: string, token: CancellationToken): Promise<IUserDataSyncResourceError[]> {\n\t\tconst errors = await profileSynchronizer.sync(manifestOrLatestData, preview, executionId, token);\n\t\treturn errors.map(([syncResource, error]) => ({ profile: profileSynchronizer.profile, syncResource, error }));\n\t}\n\n\tprivate async stop(): Promise<void> {\n\t\tif (this.status !== SyncStatus.Idle) {\n\t\t\tawait Promise.allSettled(this.getActiveProfileSynchronizers().map(profileSynchronizer => profileSynchronizer.stop()));\n\t\t}\n\t}\n\n\tasync resolveContent(resource: URI): Promise<string | null> {\n\t\tconst content = await this.userDataSyncResourceProviderService.resolveContent(resource);\n\t\tif (content) {\n\t\t\treturn content;\n\t\t}\n\t\tfor (const profileSynchronizer of this.getActiveProfileSynchronizers()) {\n\t\t\tfor (const synchronizer of profileSynchronizer.enabled) {\n\t\t\t\tconst content = await synchronizer.resolveContent(resource);\n\t\t\t\tif (content) {\n\t\t\t\t\treturn content;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\tasync replace(syncResourceHandle: ISyncResourceHandle): Promise<void> {\n\t\tthis.checkEnablement();\n\n\t\tconst profileSyncResource = this.userDataSyncResourceProviderService.resolveUserDataSyncResource(syncResourceHandle);\n\t\tif (!profileSyncResource) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst content = await this.resolveContent(syncResourceHandle.uri);\n\t\tif (!content) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait this.performAction(profileSyncResource.profile, async synchronizer => {\n\t\t\tif (profileSyncResource.syncResource === synchronizer.resource) {\n\t\t\t\tawait synchronizer.replace(content);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t});\n\n\t\treturn;\n\t}\n\n\tasync accept(syncResource: IUserDataSyncResource, resource: URI, content: string | null | undefined, apply: boolean | { force: boolean }): Promise<void> {\n\t\tthis.checkEnablement();\n\n\t\tawait this.performAction(syncResource.profile, async synchronizer => {\n\t\t\tif (syncResource.syncResource === synchronizer.resource) {\n\t\t\t\tawait synchronizer.accept(resource, content);\n\t\t\t\tif (apply) {\n\t\t\t\t\tawait synchronizer.apply(isBoolean(apply) ? false : apply.force, createSyncHeaders(generateUuid()));\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t});\n\t}\n\n\tasync hasLocalData(): Promise<boolean> {\n\t\tconst result = await this.performAction(this.userDataProfilesService.defaultProfile, async synchronizer => {\n\t\t\t// skip global state synchronizer\n\t\t\tif (synchronizer.resource !== SyncResource.GlobalState && await synchronizer.hasLocalData()) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t});\n\t\treturn !!result;\n\t}\n\n\tasync hasPreviouslySynced(): Promise<boolean> {\n\t\tconst result = await this.performAction(this.userDataProfilesService.defaultProfile, async synchronizer => {\n\t\t\tif (await synchronizer.hasPreviouslySynced()) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t});\n\t\treturn !!result;\n\t}\n\n\tasync reset(): Promise<void> {\n\t\tthis.checkEnablement();\n\t\tawait this.resetRemote();\n\t\tawait this.resetLocal();\n\t}\n\n\tasync resetRemote(): Promise<void> {\n\t\tthis.checkEnablement();\n\t\ttry {\n\t\t\tawait this.userDataSyncStoreService.clear();\n\t\t\tthis.logService.info('Cleared data on server');\n\t\t} catch (e) {\n\t\t\tthis.logService.error(e);\n\t\t}\n\t\tthis._onDidResetRemote.fire();\n\t}\n\n\tasync resetLocal(): Promise<void> {\n\t\tthis.checkEnablement();\n\t\tthis._lastSyncTime = undefined;\n\t\tthis.storageService.remove(LAST_SYNC_TIME_KEY, StorageScope.APPLICATION);\n\t\tfor (const [synchronizer] of this.activeProfileSynchronizers.values()) {\n\t\t\ttry {\n\t\t\t\tawait synchronizer.resetLocal();\n\t\t\t} catch (e) {\n\t\t\t\tthis.logService.error(e);\n\t\t\t}\n\t\t}\n\t\tthis.clearActiveProfileSynchronizers();\n\t\tthis._onDidResetLocal.fire();\n\t\tthis.logService.info('Did reset the local sync state.');\n\t}\n\n\tprivate async cleanUpStaleStorageData(): Promise<void> {\n\t\tconst allKeys = this.storageService.keys(StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\tconst lastSyncProfileKeys: [string, string][] = [];\n\t\tfor (const key of allKeys) {\n\t\t\tif (!key.endsWith('.lastSyncUserData')) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tconst segments = key.split('.');\n\t\t\tif (segments.length === 3) {\n\t\t\t\tlastSyncProfileKeys.push([key, segments[0]]);\n\t\t\t}\n\t\t}\n\t\tif (!lastSyncProfileKeys.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst disposables = new DisposableStore();\n\n\t\ttry {\n\t\t\tlet defaultProfileSynchronizer = this.activeProfileSynchronizers.get(this.userDataProfilesService.defaultProfile.id)?.[0];\n\t\t\tif (!defaultProfileSynchronizer) {\n\t\t\t\tdefaultProfileSynchronizer = disposables.add(this.instantiationService.createInstance(ProfileSynchronizer, this.userDataProfilesService.defaultProfile, undefined));\n\t\t\t}\n\t\t\tconst userDataProfileManifestSynchronizer = defaultProfileSynchronizer.enabled.find(s => s.resource === SyncResource.Profiles) as UserDataProfilesManifestSynchroniser;\n\t\t\tif (!userDataProfileManifestSynchronizer) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst lastSyncedProfiles = await userDataProfileManifestSynchronizer.getLastSyncedProfiles();\n\t\t\tconst lastSyncedCollections = lastSyncedProfiles?.map(p => p.collection) ?? [];\n\t\t\tfor (const [key, collection] of lastSyncProfileKeys) {\n\t\t\t\tif (!lastSyncedCollections.includes(collection)) {\n\t\t\t\t\tthis.logService.info(`Removing last sync state for stale profile: ${collection}`);\n\t\t\t\t\tthis.storageService.remove(key, StorageScope.APPLICATION);\n\t\t\t\t}\n\t\t\t}\n\t\t} finally {\n\t\t\tdisposables.dispose();\n\t\t}\n\t}\n\n\tasync cleanUpRemoteData(): Promise<void> {\n\t\tconst remoteProfiles = await this.userDataSyncResourceProviderService.getRemoteSyncedProfiles();\n\t\tconst remoteProfileCollections = remoteProfiles.map(profile => profile.collection);\n\t\tconst allCollections = await this.userDataSyncStoreService.getAllCollections();\n\t\tconst redundantCollections = allCollections.filter(c => !remoteProfileCollections.includes(c));\n\t\tif (redundantCollections.length) {\n\t\t\tthis.logService.info(`Deleting ${redundantCollections.length} redundant collections on server`);\n\t\t\tawait Promise.allSettled(redundantCollections.map(collectionId => this.userDataSyncStoreService.deleteCollection(collectionId)));\n\t\t\tthis.logService.info(`Deleted redundant collections on server`);\n\t\t}\n\t\tconst updatedRemoteProfiles = remoteProfiles.filter(profile => allCollections.includes(profile.collection));\n\t\tif (updatedRemoteProfiles.length !== remoteProfiles.length) {\n\t\t\tconst profileManifestSynchronizer = this.instantiationService.createInstance(UserDataProfilesManifestSynchroniser, this.userDataProfilesService.defaultProfile, undefined);\n\t\t\ttry {\n\t\t\t\tthis.logService.info('Resetting the last synced state of profiles');\n\t\t\t\tawait profileManifestSynchronizer.resetLocal();\n\t\t\t\tthis.logService.info('Did reset the last synced state of profiles');\n\t\t\t\tthis.logService.info(`Updating remote profiles with invalid collections on server`);\n\t\t\t\tawait profileManifestSynchronizer.updateRemoteProfiles(updatedRemoteProfiles, null);\n\t\t\t\tthis.logService.info(`Updated remote profiles on server`);\n\t\t\t} finally {\n\t\t\t\tprofileManifestSynchronizer.dispose();\n\t\t\t}\n\t\t}\n\t}\n\n\tasync saveRemoteActivityData(location: URI): Promise<void> {\n\t\tthis.checkEnablement();\n\t\tconst data = await this.userDataSyncStoreService.getActivityData();\n\t\tawait this.fileService.writeFile(location, data);\n\t}\n\n\tasync extractActivityData(activityDataResource: URI, location: URI): Promise<void> {\n\t\tconst content = (await this.fileService.readFile(activityDataResource)).value.toString();\n\t\tconst activityData: IUserDataSyncActivityData = JSON.parse(content);\n\n\t\tif (activityData.resources) {\n\t\t\tfor (const resource in activityData.resources) {\n\t\t\t\tfor (const version of activityData.resources[resource]) {\n\t\t\t\t\tawait this.userDataSyncLocalStoreService.writeResource(resource as SyncResource, version.content, new Date(version.created * 1000), undefined, location);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (activityData.collections) {\n\t\t\tfor (const collection in activityData.collections) {\n\t\t\t\tfor (const resource in activityData.collections[collection].resources) {\n\t\t\t\t\tfor (const version of activityData.collections[collection].resources?.[resource] ?? []) {\n\t\t\t\t\t\tawait this.userDataSyncLocalStoreService.writeResource(resource as SyncResource, version.content, new Date(version.created * 1000), collection, location);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async performAction<T>(profile: IUserDataProfile, action: (synchroniser: IUserDataSynchroniser) => Promise<T | undefined>): Promise<T | null> {\n\t\tconst disposables = new DisposableStore();\n\t\ttry {\n\t\t\tconst activeProfileSyncronizer = this.activeProfileSynchronizers.get(profile.id);\n\t\t\tif (activeProfileSyncronizer) {\n\t\t\t\tconst result = await this.performActionWithProfileSynchronizer(activeProfileSyncronizer[0], action, disposables);\n\t\t\t\treturn isUndefined(result) ? null : result;\n\t\t\t}\n\n\t\t\tif (profile.isDefault) {\n\t\t\t\tconst defaultProfileSynchronizer = disposables.add(this.instantiationService.createInstance(ProfileSynchronizer, profile, undefined));\n\t\t\t\tconst result = await this.performActionWithProfileSynchronizer(defaultProfileSynchronizer, action, disposables);\n\t\t\t\treturn isUndefined(result) ? null : result;\n\t\t\t}\n\n\t\t\tconst userDataProfileManifestSynchronizer = disposables.add(this.instantiationService.createInstance(UserDataProfilesManifestSynchroniser, profile, undefined));\n\t\t\tconst manifest = await this.userDataSyncStoreService.manifest(null);\n\t\t\tconst syncProfiles = (await userDataProfileManifestSynchronizer.getRemoteSyncedProfiles(manifest?.latest?.profiles ?? null)) || [];\n\t\t\tconst syncProfile = syncProfiles.find(syncProfile => syncProfile.id === profile.id);\n\t\t\tif (syncProfile) {\n\t\t\t\tconst profileSynchronizer = disposables.add(this.instantiationService.createInstance(ProfileSynchronizer, profile, syncProfile.collection));\n\t\t\t\tconst result = await this.performActionWithProfileSynchronizer(profileSynchronizer, action, disposables);\n\t\t\t\treturn isUndefined(result) ? null : result;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t} finally {\n\t\t\tdisposables.dispose();\n\t\t}\n\t}\n\n\tprivate async performActionWithProfileSynchronizer<T>(profileSynchronizer: ProfileSynchronizer, action: (synchroniser: IUserDataSynchroniser) => Promise<T | undefined>, disposables: DisposableStore): Promise<T | undefined> {\n\t\tconst allSynchronizers = [...profileSynchronizer.enabled, ...profileSynchronizer.disabled.reduce<(IUserDataSynchroniser & IDisposable)[]>((synchronizers, syncResource) => {\n\t\t\tif (syncResource !== SyncResource.WorkspaceState) {\n\t\t\t\tsynchronizers.push(disposables.add(profileSynchronizer.createSynchronizer(syncResource)));\n\t\t\t}\n\t\t\treturn synchronizers;\n\t\t}, [])];\n\t\tfor (const synchronizer of allSynchronizers) {\n\t\t\tconst result = await action(synchronizer);\n\t\t\tif (!isUndefined(result)) {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprivate setStatus(status: SyncStatus): void {\n\t\tconst oldStatus = this._status;\n\t\tif (this._status !== status) {\n\t\t\tthis._status = status;\n\t\t\tthis._onDidChangeStatus.fire(status);\n\t\t\tif (oldStatus === SyncStatus.HasConflicts) {\n\t\t\t\tthis.updateLastSyncTime();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate updateConflicts(): void {\n\t\tconst conflicts = this.getActiveProfileSynchronizers().map(synchronizer => synchronizer.conflicts).flat();\n\t\tif (!equals(this._conflicts, conflicts, (a, b) => a.profile.id === b.profile.id && a.syncResource === b.syncResource && equals(a.conflicts, b.conflicts, (a, b) => isEqual(a.previewResource, b.previewResource)))) {\n\t\t\tthis._conflicts = conflicts;\n\t\t\tthis._onDidChangeConflicts.fire(conflicts);\n\t\t}\n\t}\n\n\tprivate updateLastSyncTime(): void {\n\t\tif (this.status === SyncStatus.Idle) {\n\t\t\tthis._lastSyncTime = new Date().getTime();\n\t\t\tthis.storageService.store(LAST_SYNC_TIME_KEY, this._lastSyncTime, StorageScope.APPLICATION, StorageTarget.MACHINE);\n\t\t\tthis._onDidChangeLastSyncTime.fire(this._lastSyncTime);\n\t\t}\n\t}\n\n\tgetOrCreateActiveProfileSynchronizer(profile: IUserDataProfile, syncProfile: ISyncUserDataProfile | undefined): ProfileSynchronizer {\n\t\tlet activeProfileSynchronizer = this.activeProfileSynchronizers.get(profile.id);\n\t\tif (activeProfileSynchronizer && activeProfileSynchronizer[0].collection !== syncProfile?.collection) {\n\t\t\tthis.logService.error('Profile synchronizer collection does not match with the remote sync profile collection');\n\t\t\tactiveProfileSynchronizer[1].dispose();\n\t\t\tactiveProfileSynchronizer = undefined;\n\t\t\tthis.activeProfileSynchronizers.delete(profile.id);\n\t\t}\n\t\tif (!activeProfileSynchronizer) {\n\t\t\tconst disposables = new DisposableStore();\n\t\t\tconst profileSynchronizer = disposables.add(this.instantiationService.createInstance(ProfileSynchronizer, profile, syncProfile?.collection));\n\t\t\tdisposables.add(profileSynchronizer.onDidChangeStatus(e => this.setStatus(e)));\n\t\t\tdisposables.add(profileSynchronizer.onDidChangeConflicts(conflicts => this.updateConflicts()));\n\t\t\tdisposables.add(profileSynchronizer.onDidChangeLocal(e => this._onDidChangeLocal.fire(e)));\n\t\t\tthis.activeProfileSynchronizers.set(profile.id, activeProfileSynchronizer = [profileSynchronizer, disposables]);\n\t\t}\n\t\treturn activeProfileSynchronizer[0];\n\t}\n\n\tprivate getActiveProfileSynchronizers(): ProfileSynchronizer[] {\n\t\tconst profileSynchronizers: ProfileSynchronizer[] = [];\n\t\tfor (const [profileSynchronizer] of this.activeProfileSynchronizers.values()) {\n\t\t\tprofileSynchronizers.push(profileSynchronizer);\n\t\t}\n\t\treturn profileSynchronizers;\n\t}\n\n\tprivate clearActiveProfileSynchronizers(): void {\n\t\tthis.activeProfileSynchronizers.forEach(([, disposable]) => disposable.dispose());\n\t\tthis.activeProfileSynchronizers.clear();\n\t}\n\n\tprivate checkEnablement(): void {\n\t\tif (!this.userDataSyncStoreManagementService.userDataSyncStore) {\n\t\t\tthrow new Error('Not enabled');\n\t\t}\n\t}\n\n}\n\n\nclass ProfileSynchronizer extends Disposable {\n\n\tprivate _enabled: [IUserDataSynchroniser, number, IDisposable][] = [];\n\tget enabled(): IUserDataSynchroniser[] { return this._enabled.sort((a, b) => a[1] - b[1]).map(([synchronizer]) => synchronizer); }\n\n\tget disabled(): SyncResource[] { return ALL_SYNC_RESOURCES.filter(syncResource => !this.userDataSyncEnablementService.isResourceEnabled(syncResource)); }\n\n\tprivate _status: SyncStatus = SyncStatus.Idle;\n\tget status(): SyncStatus { return this._status; }\n\tprivate _onDidChangeStatus: Emitter<SyncStatus> = this._register(new Emitter<SyncStatus>());\n\treadonly onDidChangeStatus: Event<SyncStatus> = this._onDidChangeStatus.event;\n\n\tprivate _onDidChangeLocal = this._register(new Emitter<SyncResource>());\n\treadonly onDidChangeLocal = this._onDidChangeLocal.event;\n\n\tprivate _conflicts: IUserDataSyncResourceConflicts[] = [];\n\tget conflicts(): IUserDataSyncResourceConflicts[] { return this._conflicts; }\n\tprivate _onDidChangeConflicts = this._register(new Emitter<IUserDataSyncResourceConflicts[]>());\n\treadonly onDidChangeConflicts = this._onDidChangeConflicts.event;\n\n\tconstructor(\n\t\treadonly profile: IUserDataProfile,\n\t\treadonly collection: string | undefined,\n\t\t@IUserDataSyncEnablementService private readonly userDataSyncEnablementService: IUserDataSyncEnablementService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IExtensionGalleryService private readonly extensionGalleryService: IExtensionGalleryService,\n\t\t@IUserDataSyncStoreManagementService private readonly userDataSyncStoreManagementService: IUserDataSyncStoreManagementService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IUserDataSyncLogService private readonly logService: IUserDataSyncLogService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t) {\n\t\tsuper();\n\t\tthis._register(userDataSyncEnablementService.onDidChangeResourceEnablement(([syncResource, enablement]) => this.onDidChangeResourceEnablement(syncResource, enablement)));\n\t\tthis._register(toDisposable(() => this._enabled.splice(0, this._enabled.length).forEach(([, , disposable]) => disposable.dispose())));\n\t\tfor (const syncResource of ALL_SYNC_RESOURCES) {\n\t\t\tif (userDataSyncEnablementService.isResourceEnabled(syncResource)) {\n\t\t\t\tthis.registerSynchronizer(syncResource);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate onDidChangeResourceEnablement(syncResource: SyncResource, enabled: boolean): void {\n\t\tif (enabled) {\n\t\t\tthis.registerSynchronizer(syncResource);\n\t\t} else {\n\t\t\tthis.deRegisterSynchronizer(syncResource);\n\t\t}\n\t}\n\n\tprotected registerSynchronizer(syncResource: SyncResource): void {\n\t\tif (this._enabled.some(([synchronizer]) => synchronizer.resource === syncResource)) {\n\t\t\treturn;\n\t\t}\n\t\tif (syncResource === SyncResource.Extensions && !this.extensionGalleryService.isEnabled()) {\n\t\t\tthis.logService.info('Skipping extensions sync because gallery is not configured');\n\t\t\treturn;\n\t\t}\n\t\tif (syncResource === SyncResource.Profiles) {\n\t\t\tif (!this.profile.isDefault) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tif (syncResource === SyncResource.WorkspaceState) {\n\t\t\treturn;\n\t\t}\n\t\tif (syncResource !== SyncResource.Profiles && this.profile.useDefaultFlags?.[syncResource]) {\n\t\t\tthis.logService.debug(`Skipping syncing ${syncResource} in ${this.profile.name} because it is already synced by default profile`);\n\t\t\treturn;\n\t\t}\n\t\tconst disposables = new DisposableStore();\n\t\tconst synchronizer = disposables.add(this.createSynchronizer(syncResource));\n\t\tdisposables.add(synchronizer.onDidChangeStatus(() => this.updateStatus()));\n\t\tdisposables.add(synchronizer.onDidChangeConflicts(() => this.updateConflicts()));\n\t\tdisposables.add(synchronizer.onDidChangeLocal(() => this._onDidChangeLocal.fire(syncResource)));\n\t\tconst order = this.getOrder(syncResource);\n\t\tthis._enabled.push([synchronizer, order, disposables]);\n\t}\n\n\tprivate deRegisterSynchronizer(syncResource: SyncResource): void {\n\t\tconst index = this._enabled.findIndex(([synchronizer]) => synchronizer.resource === syncResource);\n\t\tif (index !== -1) {\n\t\t\tconst [[synchronizer, , disposable]] = this._enabled.splice(index, 1);\n\t\t\tdisposable.dispose();\n\t\t\tthis.updateStatus();\n\t\t\tsynchronizer.stop().then(null, error => this.logService.error(error));\n\t\t}\n\t}\n\n\tcreateSynchronizer(syncResource: Exclude<SyncResource, SyncResource.WorkspaceState>): IUserDataSynchroniser & IDisposable {\n\t\tswitch (syncResource) {\n\t\t\tcase SyncResource.Settings: return this.instantiationService.createInstance(SettingsSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Keybindings: return this.instantiationService.createInstance(KeybindingsSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Snippets: return this.instantiationService.createInstance(SnippetsSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Prompts: return this.instantiationService.createInstance(PromptsSynchronizer, this.profile, this.collection);\n\t\t\tcase SyncResource.Tasks: return this.instantiationService.createInstance(TasksSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Mcp: return this.instantiationService.createInstance(McpSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.GlobalState: return this.instantiationService.createInstance(GlobalStateSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Extensions: return this.instantiationService.createInstance(ExtensionsSynchroniser, this.profile, this.collection);\n\t\t\tcase SyncResource.Profiles: return this.instantiationService.createInstance(UserDataProfilesManifestSynchroniser, this.profile, this.collection);\n\t\t}\n\t}\n\n\tasync sync(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, preview: boolean, executionId: string, token: CancellationToken): Promise<[SyncResource, UserDataSyncError][]> {\n\n\t\t// Return if cancellation is requested\n\t\tif (token.isCancellationRequested) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst synchronizers = this.enabled;\n\t\tif (!synchronizers.length) {\n\t\t\treturn [];\n\t\t}\n\n\t\ttry {\n\t\t\tconst syncErrors: [SyncResource, UserDataSyncError][] = [];\n\t\t\tconst syncHeaders = createSyncHeaders(executionId);\n\t\t\tconst userDataSyncConfiguration = preview ? await this.getUserDataSyncConfiguration(manifestOrLatestData) : this.getLocalUserDataSyncConfiguration();\n\t\t\tfor (const synchroniser of synchronizers) {\n\t\t\t\t// Return if cancellation is requested\n\t\t\t\tif (token.isCancellationRequested) {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\n\t\t\t\t// Return if resource is not enabled\n\t\t\t\tif (!this.userDataSyncEnablementService.isResourceEnabled(synchroniser.resource)) {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\n\t\t\t\ttry {\n\t\t\t\t\tconst refOrUserData = getRefOrUserData(manifestOrLatestData, this.collection, synchroniser.resource) ?? null;\n\t\t\t\t\tawait synchroniser.sync(refOrUserData, preview, userDataSyncConfiguration, syncHeaders);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(e);\n\t\t\t\t\treportUserDataSyncError(userDataSyncError, executionId, this.userDataSyncStoreManagementService, this.telemetryService);\n\t\t\t\t\tif (canBailout(e)) {\n\t\t\t\t\t\tthrow userDataSyncError;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Log and and continue\n\t\t\t\t\tthis.logService.error(e);\n\t\t\t\t\tthis.logService.error(`${synchroniser.resource}: ${toErrorMessage(e)}`);\n\t\t\t\t\tsyncErrors.push([synchroniser.resource, userDataSyncError]);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn syncErrors;\n\t\t} finally {\n\t\t\tthis.updateStatus();\n\t\t}\n\t}\n\n\tasync apply(executionId: string, token: CancellationToken): Promise<void> {\n\t\tconst syncHeaders = createSyncHeaders(executionId);\n\t\tfor (const synchroniser of this.enabled) {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tawait synchroniser.apply(false, syncHeaders);\n\t\t\t} catch (e) {\n\t\t\t\tconst userDataSyncError = UserDataSyncError.toUserDataSyncError(e);\n\t\t\t\treportUserDataSyncError(userDataSyncError, executionId, this.userDataSyncStoreManagementService, this.telemetryService);\n\t\t\t\tif (canBailout(e)) {\n\t\t\t\t\tthrow userDataSyncError;\n\t\t\t\t}\n\n\t\t\t\t// Log and and continue\n\t\t\t\tthis.logService.error(e);\n\t\t\t\tthis.logService.error(`${synchroniser.resource}: ${toErrorMessage(e)}`);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync stop(): Promise<void> {\n\t\tfor (const synchroniser of this.enabled) {\n\t\t\ttry {\n\t\t\t\tif (synchroniser.status !== SyncStatus.Idle) {\n\t\t\t\t\tawait synchroniser.stop();\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tthis.logService.error(e);\n\t\t\t}\n\t\t}\n\t}\n\n\tasync resetLocal(): Promise<void> {\n\t\tfor (const synchroniser of this.enabled) {\n\t\t\ttry {\n\t\t\t\tawait synchroniser.resetLocal();\n\t\t\t} catch (e) {\n\t\t\t\tthis.logService.error(`${synchroniser.resource}: ${toErrorMessage(e)}`);\n\t\t\t\tthis.logService.error(e);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async getUserDataSyncConfiguration(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null): Promise<IUserDataSyncConfiguration> {\n\t\tif (!this.profile.isDefault) {\n\t\t\treturn {};\n\t\t}\n\t\tconst local = this.getLocalUserDataSyncConfiguration();\n\t\tconst settingsSynchronizer = this.enabled.find(synchronizer => synchronizer instanceof SettingsSynchroniser);\n\t\tif (settingsSynchronizer) {\n\t\t\tconst remote = await settingsSynchronizer.getRemoteUserDataSyncConfiguration(getRefOrUserData(manifestOrLatestData, this.collection, SyncResource.Settings) ?? null);\n\t\t\treturn { ...local, ...remote };\n\t\t}\n\t\treturn local;\n\t}\n\n\tprivate getLocalUserDataSyncConfiguration(): IUserDataSyncConfiguration {\n\t\treturn this.configurationService.getValue(USER_DATA_SYNC_CONFIGURATION_SCOPE);\n\t}\n\n\tprivate setStatus(status: SyncStatus): void {\n\t\tif (this._status !== status) {\n\t\t\tthis._status = status;\n\t\t\tthis._onDidChangeStatus.fire(status);\n\t\t}\n\t}\n\n\tprivate updateStatus(): void {\n\t\tthis.updateConflicts();\n\t\tif (this.enabled.some(s => s.status === SyncStatus.HasConflicts)) {\n\t\t\treturn this.setStatus(SyncStatus.HasConflicts);\n\t\t}\n\t\tif (this.enabled.some(s => s.status === SyncStatus.Syncing)) {\n\t\t\treturn this.setStatus(SyncStatus.Syncing);\n\t\t}\n\t\treturn this.setStatus(SyncStatus.Idle);\n\t}\n\n\tprivate updateConflicts(): void {\n\t\tconst conflicts = this.enabled.filter(s => s.status === SyncStatus.HasConflicts)\n\t\t\t.filter(s => s.conflicts.conflicts.length > 0)\n\t\t\t.map(s => s.conflicts);\n\t\tif (!equals(this._conflicts, conflicts, (a, b) => a.syncResource === b.syncResource && equals(a.conflicts, b.conflicts, (a, b) => isEqual(a.previewResource, b.previewResource)))) {\n\t\t\tthis._conflicts = conflicts;\n\t\t\tthis._onDidChangeConflicts.fire(conflicts);\n\t\t}\n\t}\n\n\tprivate getOrder(syncResource: SyncResource): number {\n\t\tswitch (syncResource) {\n\t\t\tcase SyncResource.Settings: return 0;\n\t\t\tcase SyncResource.Keybindings: return 1;\n\t\t\tcase SyncResource.Snippets: return 2;\n\t\t\tcase SyncResource.Tasks: return 3;\n\t\t\tcase SyncResource.Mcp: return 4;\n\t\t\tcase SyncResource.GlobalState: return 5;\n\t\t\tcase SyncResource.Extensions: return 6;\n\t\t\tcase SyncResource.Prompts: return 7;\n\t\t\tcase SyncResource.Profiles: return 8;\n\t\t\tcase SyncResource.WorkspaceState: return 9;\n\t\t}\n\t}\n}\n\nfunction canBailout(e: unknown): boolean {\n\tif (e instanceof UserDataSyncError) {\n\t\tswitch (e.code) {\n\t\t\tcase UserDataSyncErrorCode.MethodNotFound:\n\t\t\tcase UserDataSyncErrorCode.TooLarge:\n\t\t\tcase UserDataSyncErrorCode.TooManyRequests:\n\t\t\tcase UserDataSyncErrorCode.TooManyRequestsAndRetryAfter:\n\t\t\tcase UserDataSyncErrorCode.LocalTooManyRequests:\n\t\t\tcase UserDataSyncErrorCode.LocalTooManyProfiles:\n\t\t\tcase UserDataSyncErrorCode.Gone:\n\t\t\tcase UserDataSyncErrorCode.UpgradeRequired:\n\t\t\tcase UserDataSyncErrorCode.IncompatibleRemoteContent:\n\t\t\tcase UserDataSyncErrorCode.IncompatibleLocalContent:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\nfunction reportUserDataSyncError(userDataSyncError: UserDataSyncError, executionId: string, userDataSyncStoreManagementService: IUserDataSyncStoreManagementService, telemetryService: ITelemetryService): void {\n\ttelemetryService.publicLog2<SyncErrorEvent, SyncErrorClassification>('sync/error',\n\t\t{\n\t\t\tcode: userDataSyncError.code,\n\t\t\tserverCode: userDataSyncError instanceof UserDataSyncStoreError ? String(userDataSyncError.serverCode) : undefined,\n\t\t\turl: userDataSyncError instanceof UserDataSyncStoreError ? userDataSyncError.url : undefined,\n\t\t\tresource: userDataSyncError.resource,\n\t\t\texecutionId,\n\t\t\tservice: userDataSyncStoreManagementService.userDataSyncStore!.url.toString()\n\t\t});\n}\n\nfunction getRefOrUserData(manifestOrLatestData: IUserDataManifest | IUserDataSyncLatestData | null, collection: string | undefined, resource: SyncResource): string | IUserData | undefined {\n\tif (isUserDataManifest(manifestOrLatestData)) {\n\t\tif (collection) {\n\t\t\treturn manifestOrLatestData?.collections?.[collection]?.latest?.[resource];\n\t\t}\n\t\treturn manifestOrLatestData?.latest?.[resource];\n\t}\n\tif (collection) {\n\t\treturn manifestOrLatestData?.collections?.[collection]?.resources?.[resource];\n\t}\n\treturn manifestOrLatestData?.resources?.[resource];\n}\n"]}