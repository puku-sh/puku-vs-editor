{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/extensionManagement/test/node/extensionDownloader.test.ts","vs/platform/extensionManagement/test/node/extensionDownloader.test.ts"],"names":[],"mappings":"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","file":"extensionDownloader.test.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { platform } from '../../../../base/common/platform.js';\nimport { arch } from '../../../../base/common/process.js';\nimport { joinPath } from '../../../../base/common/resources.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { mock } from '../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { INativeEnvironmentService } from '../../../environment/common/environment.js';\nimport { ExtensionSignatureVerificationCode, getTargetPlatform, IExtensionGalleryService, IGalleryExtension, IGalleryExtensionAssets, InstallOperation } from '../../common/extensionManagement.js';\nimport { getGalleryExtensionId } from '../../common/extensionManagementUtil.js';\nimport { ExtensionsDownloader } from '../../node/extensionDownloader.js';\nimport { IExtensionSignatureVerificationResult, IExtensionSignatureVerificationService } from '../../node/extensionSignatureVerificationService.js';\nimport { IFileService } from '../../../files/common/files.js';\nimport { FileService } from '../../../files/common/fileService.js';\nimport { InMemoryFileSystemProvider } from '../../../files/common/inMemoryFilesystemProvider.js';\nimport { TestInstantiationService } from '../../../instantiation/test/common/instantiationServiceMock.js';\nimport { ILogService, NullLogService } from '../../../log/common/log.js';\nimport { IUriIdentityService } from '../../../uriIdentity/common/uriIdentity.js';\nimport { UriIdentityService } from '../../../uriIdentity/common/uriIdentityService.js';\nimport { IStringDictionary } from '../../../../base/common/collections.js';\n\nconst ROOT = URI.file('tests').with({ scheme: 'vscode-tests' });\n\nclass TestExtensionSignatureVerificationService extends mock<IExtensionSignatureVerificationService>() {\n\n\tconstructor(\n\t\tprivate readonly verificationResult: string | boolean) {\n\t\tsuper();\n\t}\n\n\toverride async verify(): Promise<IExtensionSignatureVerificationResult | undefined> {\n\t\tif (this.verificationResult === true) {\n\t\t\treturn {\n\t\t\t\tcode: ExtensionSignatureVerificationCode.Success\n\t\t\t};\n\t\t}\n\t\tif (this.verificationResult === false) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn {\n\t\t\tcode: this.verificationResult as ExtensionSignatureVerificationCode,\n\t\t};\n\t}\n}\n\nclass TestExtensionDownloader extends ExtensionsDownloader {\n\tprotected override async validate(): Promise<void> { }\n}\n\nsuite('ExtensionDownloader Tests', () => {\n\n\tconst disposables = ensureNoDisposablesAreLeakedInTestSuite();\n\tlet instantiationService: TestInstantiationService;\n\n\tsetup(() => {\n\t\tinstantiationService = disposables.add(new TestInstantiationService());\n\n\t\tconst logService = new NullLogService();\n\t\tconst fileService = disposables.add(new FileService(logService));\n\t\tconst fileSystemProvider = disposables.add(new InMemoryFileSystemProvider());\n\t\tdisposables.add(fileService.registerProvider(ROOT.scheme, fileSystemProvider));\n\n\t\tinstantiationService.stub(ILogService, logService);\n\t\tinstantiationService.stub(IFileService, fileService);\n\t\tinstantiationService.stub(ILogService, logService);\n\t\tinstantiationService.stub(IUriIdentityService, disposables.add(new UriIdentityService(fileService)));\n\t\tinstantiationService.stub(INativeEnvironmentService, { extensionsDownloadLocation: joinPath(ROOT, 'CachedExtensionVSIXs') });\n\t\tinstantiationService.stub(IExtensionGalleryService, {\n\t\t\tasync download(extension, location, operation) {\n\t\t\t\tawait fileService.writeFile(location, VSBuffer.fromString('extension vsix'));\n\t\t\t},\n\t\t\tasync downloadSignatureArchive(extension, location) {\n\t\t\t\tawait fileService.writeFile(location, VSBuffer.fromString('extension signature'));\n\t\t\t},\n\t\t});\n\t});\n\n\ttest('download completes successfully if verification is disabled by options', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: 'error' });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, false);\n\n\t\tassert.strictEqual(actual.verificationStatus, undefined);\n\t});\n\n\ttest('download completes successfully if verification is disabled because the module is not loaded', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: false });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, undefined);\n\t});\n\n\ttest('download completes successfully if verification fails to execute', async () => {\n\t\tconst errorCode = 'ENOENT';\n\t\tconst testObject = aTestObject({ verificationResult: errorCode });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, errorCode);\n\t});\n\n\ttest('download completes successfully if verification fails ', async () => {\n\t\tconst errorCode = 'IntegrityCheckFailed';\n\t\tconst testObject = aTestObject({ verificationResult: errorCode });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, errorCode);\n\t});\n\n\ttest('download completes successfully if verification succeeds', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: true });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, ExtensionSignatureVerificationCode.Success);\n\t});\n\n\ttest('download completes successfully for unsigned extension', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: true });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: false }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, ExtensionSignatureVerificationCode.NotSigned);\n\t});\n\n\ttest('download completes successfully for an unsigned extension even when signature verification throws error', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: 'error' });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: false }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, ExtensionSignatureVerificationCode.NotSigned);\n\t});\n\n\tfunction aTestObject(options: { verificationResult: boolean | string }): ExtensionsDownloader {\n\t\tinstantiationService.stub(IExtensionSignatureVerificationService, new TestExtensionSignatureVerificationService(options.verificationResult));\n\t\treturn disposables.add(instantiationService.createInstance(TestExtensionDownloader));\n\t}\n\n\tfunction aGalleryExtension(name: string, properties: Partial<IGalleryExtension> = {}, galleryExtensionProperties: IStringDictionary<unknown> = {}, assets: Partial<IGalleryExtensionAssets> = {}): IGalleryExtension {\n\t\tconst targetPlatform = getTargetPlatform(platform, arch);\n\t\tconst galleryExtension = <IGalleryExtension>Object.create({ name, publisher: 'pub', version: '1.0.0', allTargetPlatforms: [targetPlatform], properties: {}, assets: {}, ...properties });\n\t\tgalleryExtension.properties = { ...galleryExtension.properties, dependencies: [], targetPlatform, ...galleryExtensionProperties };\n\t\tgalleryExtension.assets = { ...galleryExtension.assets, ...assets };\n\t\tgalleryExtension.identifier = { id: getGalleryExtensionId(galleryExtension.publisher, galleryExtension.name), uuid: generateUuid() };\n\t\treturn <IGalleryExtension>galleryExtension;\n\t}\n});\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport assert from 'assert';\nimport { VSBuffer } from '../../../../base/common/buffer.js';\nimport { platform } from '../../../../base/common/platform.js';\nimport { arch } from '../../../../base/common/process.js';\nimport { joinPath } from '../../../../base/common/resources.js';\nimport { URI } from '../../../../base/common/uri.js';\nimport { generateUuid } from '../../../../base/common/uuid.js';\nimport { mock } from '../../../../base/test/common/mock.js';\nimport { ensureNoDisposablesAreLeakedInTestSuite } from '../../../../base/test/common/utils.js';\nimport { INativeEnvironmentService } from '../../../environment/common/environment.js';\nimport { ExtensionSignatureVerificationCode, getTargetPlatform, IExtensionGalleryService, IGalleryExtension, IGalleryExtensionAssets, InstallOperation } from '../../common/extensionManagement.js';\nimport { getGalleryExtensionId } from '../../common/extensionManagementUtil.js';\nimport { ExtensionsDownloader } from '../../node/extensionDownloader.js';\nimport { IExtensionSignatureVerificationResult, IExtensionSignatureVerificationService } from '../../node/extensionSignatureVerificationService.js';\nimport { IFileService } from '../../../files/common/files.js';\nimport { FileService } from '../../../files/common/fileService.js';\nimport { InMemoryFileSystemProvider } from '../../../files/common/inMemoryFilesystemProvider.js';\nimport { TestInstantiationService } from '../../../instantiation/test/common/instantiationServiceMock.js';\nimport { ILogService, NullLogService } from '../../../log/common/log.js';\nimport { IUriIdentityService } from '../../../uriIdentity/common/uriIdentity.js';\nimport { UriIdentityService } from '../../../uriIdentity/common/uriIdentityService.js';\nimport { IStringDictionary } from '../../../../base/common/collections.js';\n\nconst ROOT = URI.file('tests').with({ scheme: 'vscode-tests' });\n\nclass TestExtensionSignatureVerificationService extends mock<IExtensionSignatureVerificationService>() {\n\n\tconstructor(\n\t\tprivate readonly verificationResult: string | boolean) {\n\t\tsuper();\n\t}\n\n\toverride async verify(): Promise<IExtensionSignatureVerificationResult | undefined> {\n\t\tif (this.verificationResult === true) {\n\t\t\treturn {\n\t\t\t\tcode: ExtensionSignatureVerificationCode.Success\n\t\t\t};\n\t\t}\n\t\tif (this.verificationResult === false) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn {\n\t\t\tcode: this.verificationResult as ExtensionSignatureVerificationCode,\n\t\t};\n\t}\n}\n\nclass TestExtensionDownloader extends ExtensionsDownloader {\n\tprotected override async validate(): Promise<void> { }\n}\n\nsuite('ExtensionDownloader Tests', () => {\n\n\tconst disposables = ensureNoDisposablesAreLeakedInTestSuite();\n\tlet instantiationService: TestInstantiationService;\n\n\tsetup(() => {\n\t\tinstantiationService = disposables.add(new TestInstantiationService());\n\n\t\tconst logService = new NullLogService();\n\t\tconst fileService = disposables.add(new FileService(logService));\n\t\tconst fileSystemProvider = disposables.add(new InMemoryFileSystemProvider());\n\t\tdisposables.add(fileService.registerProvider(ROOT.scheme, fileSystemProvider));\n\n\t\tinstantiationService.stub(ILogService, logService);\n\t\tinstantiationService.stub(IFileService, fileService);\n\t\tinstantiationService.stub(ILogService, logService);\n\t\tinstantiationService.stub(IUriIdentityService, disposables.add(new UriIdentityService(fileService)));\n\t\tinstantiationService.stub(INativeEnvironmentService, { extensionsDownloadLocation: joinPath(ROOT, 'CachedExtensionVSIXs') });\n\t\tinstantiationService.stub(IExtensionGalleryService, {\n\t\t\tasync download(extension, location, operation) {\n\t\t\t\tawait fileService.writeFile(location, VSBuffer.fromString('extension vsix'));\n\t\t\t},\n\t\t\tasync downloadSignatureArchive(extension, location) {\n\t\t\t\tawait fileService.writeFile(location, VSBuffer.fromString('extension signature'));\n\t\t\t},\n\t\t});\n\t});\n\n\ttest('download completes successfully if verification is disabled by options', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: 'error' });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, false);\n\n\t\tassert.strictEqual(actual.verificationStatus, undefined);\n\t});\n\n\ttest('download completes successfully if verification is disabled because the module is not loaded', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: false });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, undefined);\n\t});\n\n\ttest('download completes successfully if verification fails to execute', async () => {\n\t\tconst errorCode = 'ENOENT';\n\t\tconst testObject = aTestObject({ verificationResult: errorCode });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, errorCode);\n\t});\n\n\ttest('download completes successfully if verification fails ', async () => {\n\t\tconst errorCode = 'IntegrityCheckFailed';\n\t\tconst testObject = aTestObject({ verificationResult: errorCode });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, errorCode);\n\t});\n\n\ttest('download completes successfully if verification succeeds', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: true });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: true }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, ExtensionSignatureVerificationCode.Success);\n\t});\n\n\ttest('download completes successfully for unsigned extension', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: true });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: false }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, ExtensionSignatureVerificationCode.NotSigned);\n\t});\n\n\ttest('download completes successfully for an unsigned extension even when signature verification throws error', async () => {\n\t\tconst testObject = aTestObject({ verificationResult: 'error' });\n\n\t\tconst actual = await testObject.download(aGalleryExtension('a', { isSigned: false }), InstallOperation.Install, true);\n\n\t\tassert.strictEqual(actual.verificationStatus, ExtensionSignatureVerificationCode.NotSigned);\n\t});\n\n\tfunction aTestObject(options: { verificationResult: boolean | string }): ExtensionsDownloader {\n\t\tinstantiationService.stub(IExtensionSignatureVerificationService, new TestExtensionSignatureVerificationService(options.verificationResult));\n\t\treturn disposables.add(instantiationService.createInstance(TestExtensionDownloader));\n\t}\n\n\tfunction aGalleryExtension(name: string, properties: Partial<IGalleryExtension> = {}, galleryExtensionProperties: IStringDictionary<unknown> = {}, assets: Partial<IGalleryExtensionAssets> = {}): IGalleryExtension {\n\t\tconst targetPlatform = getTargetPlatform(platform, arch);\n\t\tconst galleryExtension = <IGalleryExtension>Object.create({ name, publisher: 'pub', version: '1.0.0', allTargetPlatforms: [targetPlatform], properties: {}, assets: {}, ...properties });\n\t\tgalleryExtension.properties = { ...galleryExtension.properties, dependencies: [], targetPlatform, ...galleryExtensionProperties };\n\t\tgalleryExtension.assets = { ...galleryExtension.assets, ...assets };\n\t\tgalleryExtension.identifier = { id: getGalleryExtensionId(galleryExtension.publisher, galleryExtension.name), uuid: generateUuid() };\n\t\treturn <IGalleryExtension>galleryExtension;\n\t}\n});\n"]}