{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/extensionManagement/common/extensionGalleryService.ts","vs/platform/extensionManagement/common/extensionGalleryService.ts"],"names":[],"mappings":"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","file":"extensionGalleryService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { distinct } from '../../../base/common/arrays.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport * as semver from '../../../base/common/semver/semver.js';\nimport { IStringDictionary } from '../../../base/common/collections.js';\nimport { CancellationError, getErrorMessage, isCancellationError } from '../../../base/common/errors.js';\nimport { IPager } from '../../../base/common/paging.js';\nimport { isWeb, platform } from '../../../base/common/platform.js';\nimport { arch } from '../../../base/common/process.js';\nimport { isBoolean, isNumber, isString } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { IHeaders, IRequestContext, IRequestOptions, isOfflineError } from '../../../base/parts/request/common/request.js';\nimport { IConfigurationService } from '../../configuration/common/configuration.js';\nimport { IEnvironmentService } from '../../environment/common/environment.js';\nimport { getTargetPlatform, IExtensionGalleryService, IExtensionIdentifier, IExtensionInfo, IGalleryExtension, IGalleryExtensionAsset, IGalleryExtensionAssets, IGalleryExtensionVersion, InstallOperation, IQueryOptions, IExtensionsControlManifest, isNotWebExtensionInWebTargetPlatform, isTargetPlatformCompatible, ITranslation, SortOrder, StatisticType, toTargetPlatform, WEB_EXTENSION_TAG, IExtensionQueryOptions, IDeprecationInfo, ISearchPrefferedResults, ExtensionGalleryError, ExtensionGalleryErrorCode, IProductVersion, IAllowedExtensionsService, EXTENSION_IDENTIFIER_REGEX, SortBy, FilterType, MaliciousExtensionInfo, ExtensionRequestsTimeoutConfigKey } from './extensionManagement.js';\nimport { adoptToGalleryExtensionId, areSameExtensions, getGalleryExtensionId, getGalleryExtensionTelemetryData } from './extensionManagementUtil.js';\nimport { IExtensionManifest, TargetPlatform } from '../../extensions/common/extensions.js';\nimport { areApiProposalsCompatible, isEngineValid } from '../../extensions/common/extensionValidator.js';\nimport { IFileService } from '../../files/common/files.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IProductService } from '../../product/common/productService.js';\nimport { asJson, asTextOrError, IRequestService, isClientError, isServerError, isSuccess } from '../../request/common/request.js';\nimport { resolveMarketplaceHeaders } from '../../externalServices/common/marketplace.js';\nimport { IStorageService } from '../../storage/common/storage.js';\nimport { ITelemetryService } from '../../telemetry/common/telemetry.js';\nimport { StopWatch } from '../../../base/common/stopwatch.js';\nimport { format2 } from '../../../base/common/strings.js';\nimport { ExtensionGalleryResourceType, Flag, getExtensionGalleryManifestResourceUri, IExtensionGalleryManifest, IExtensionGalleryManifestService, ExtensionGalleryManifestStatus } from './extensionGalleryManifest.js';\nimport { TelemetryTrustedValue } from '../../telemetry/common/telemetryUtils.js';\n\nconst CURRENT_TARGET_PLATFORM = isWeb ? TargetPlatform.WEB : getTargetPlatform(platform, arch);\nconst SEARCH_ACTIVITY_HEADER_NAME = 'X-Market-Search-Activity-Id';\nconst ACTIVITY_HEADER_NAME = 'Activityid';\nconst SERVER_HEADER_NAME = 'Server';\nconst END_END_ID_HEADER_NAME = 'X-Vss-E2eid';\n\ninterface IRawGalleryExtensionFile {\n\treadonly assetType: string;\n\treadonly source: string;\n}\n\ninterface IRawGalleryExtensionProperty {\n\treadonly key: string;\n\treadonly value: string;\n}\n\nexport interface IRawGalleryExtensionVersion {\n\treadonly version: string;\n\treadonly lastUpdated: string;\n\treadonly assetUri: string;\n\treadonly fallbackAssetUri: string;\n\treadonly files: IRawGalleryExtensionFile[];\n\treadonly properties?: IRawGalleryExtensionProperty[];\n\treadonly targetPlatform?: string;\n}\n\ninterface IRawGalleryExtensionStatistics {\n\treadonly statisticName: string;\n\treadonly value: number;\n}\n\ninterface IRawGalleryExtensionPublisher {\n\treadonly displayName: string;\n\treadonly publisherId: string;\n\treadonly publisherName: string;\n\treadonly domain?: string | null;\n\treadonly isDomainVerified?: boolean;\n\treadonly linkType?: string;\n}\n\ninterface IRawGalleryExtension {\n\treadonly extensionId: string;\n\treadonly extensionName: string;\n\treadonly displayName: string;\n\treadonly shortDescription?: string;\n\treadonly publisher: IRawGalleryExtensionPublisher;\n\treadonly versions: IRawGalleryExtensionVersion[];\n\treadonly statistics: IRawGalleryExtensionStatistics[];\n\treadonly tags: string[] | undefined;\n\treadonly releaseDate: string;\n\treadonly publishedDate: string;\n\treadonly lastUpdated: string;\n\treadonly categories: string[] | undefined;\n\treadonly flags: string;\n\treadonly linkType?: string;\n\treadonly ratingLinkType?: string;\n}\n\ninterface IRawGalleryExtensionsResult {\n\treadonly galleryExtensions: IRawGalleryExtension[];\n\treadonly total: number;\n\treadonly context?: IStringDictionary<string>;\n}\n\ninterface IRawGalleryQueryResult {\n\treadonly results: {\n\t\treadonly extensions: IRawGalleryExtension[];\n\t\treadonly resultMetadata: {\n\t\t\treadonly metadataType: string;\n\t\t\treadonly metadataItems: {\n\t\t\t\treadonly name: string;\n\t\t\t\treadonly count: number;\n\t\t\t}[];\n\t\t}[];\n\t}[];\n}\n\nconst AssetType = {\n\tIcon: 'Microsoft.VisualStudio.Services.Icons.Default',\n\tDetails: 'Microsoft.VisualStudio.Services.Content.Details',\n\tChangelog: 'Microsoft.VisualStudio.Services.Content.Changelog',\n\tManifest: 'Microsoft.VisualStudio.Code.Manifest',\n\tVSIX: 'Microsoft.VisualStudio.Services.VSIXPackage',\n\tLicense: 'Microsoft.VisualStudio.Services.Content.License',\n\tRepository: 'Microsoft.VisualStudio.Services.Links.Source',\n\tSignature: 'Microsoft.VisualStudio.Services.VsixSignature'\n};\n\nconst PropertyType = {\n\tDependency: 'Microsoft.VisualStudio.Code.ExtensionDependencies',\n\tExtensionPack: 'Microsoft.VisualStudio.Code.ExtensionPack',\n\tEngine: 'Microsoft.VisualStudio.Code.Engine',\n\tPreRelease: 'Microsoft.VisualStudio.Code.PreRelease',\n\tEnabledApiProposals: 'Microsoft.VisualStudio.Code.EnabledApiProposals',\n\tLocalizedLanguages: 'Microsoft.VisualStudio.Code.LocalizedLanguages',\n\tWebExtension: 'Microsoft.VisualStudio.Code.WebExtension',\n\tSponsorLink: 'Microsoft.VisualStudio.Code.SponsorLink',\n\tSupportLink: 'Microsoft.VisualStudio.Services.Links.Support',\n\tExecutesCode: 'Microsoft.VisualStudio.Code.ExecutesCode',\n\tPrivate: 'PrivateMarketplace',\n};\n\ninterface ICriterium {\n\treadonly filterType: FilterType;\n\treadonly value?: string;\n}\n\nconst DefaultPageSize = 10;\n\ninterface IQueryState {\n\treadonly pageNumber: number;\n\treadonly pageSize: number;\n\treadonly sortBy: SortBy;\n\treadonly sortOrder: SortOrder;\n\treadonly flags: Flag[];\n\treadonly criteria: ICriterium[];\n\treadonly assetTypes: string[];\n\treadonly source?: string;\n}\n\nconst DefaultQueryState: IQueryState = {\n\tpageNumber: 1,\n\tpageSize: DefaultPageSize,\n\tsortBy: SortBy.NoneOrRelevance,\n\tsortOrder: SortOrder.Default,\n\tflags: [],\n\tcriteria: [],\n\tassetTypes: []\n};\n\ntype GalleryServiceQueryClassification = {\n\towner: 'sandy081';\n\tcomment: 'Information about Marketplace query and its response';\n\treadonly filterTypes: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Filter types used in the query.' };\n\treadonly flags: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Flags passed in the query.' };\n\treadonly sortBy: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'sorted by option passed in the query' };\n\treadonly sortOrder: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'sort order option passed in the query' };\n\treadonly pageNumber: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'requested page number in the query' };\n\treadonly duration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; 'isMeasurement': true; comment: 'amount of time taken by the query request' };\n\treadonly success: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'whether the query request is success or not' };\n\treadonly requestBodySize: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'size of the request body' };\n\treadonly responseBodySize?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'size of the response body' };\n\treadonly statusCode?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'status code of the response' };\n\treadonly errorCode?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'error code of the response' };\n\treadonly count?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'total number of extensions matching the query' };\n\treadonly source?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'source that requested this query, eg., recommendations, viewlet' };\n\treadonly searchTextLength?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'length of the search text in the query' };\n\treadonly server?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'server that handled the query' };\n\treadonly endToEndId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'end to end operation id' };\n\treadonly activityId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'activity id' };\n};\n\ntype QueryTelemetryData = {\n\treadonly filterTypes: string[];\n\treadonly flags: string[];\n\treadonly sortBy: string;\n\treadonly sortOrder: string;\n\treadonly pageNumber: string;\n\treadonly source?: string;\n\treadonly searchTextLength?: number;\n};\n\ntype GalleryServiceQueryEvent = QueryTelemetryData & {\n\treadonly duration: number;\n\treadonly success: boolean;\n\treadonly requestBodySize: string;\n\treadonly responseBodySize?: string;\n\treadonly statusCode?: string;\n\treadonly errorCode?: string;\n\treadonly count?: string;\n\treadonly server?: TelemetryTrustedValue<string>;\n\treadonly endToEndId?: TelemetryTrustedValue<string>;\n\treadonly activityId?: TelemetryTrustedValue<string>;\n};\n\ntype GalleryServiceAdditionalQueryClassification = {\n\towner: 'sandy081';\n\tcomment: 'Response information about the additional query to the Marketplace for fetching all versions to get release version';\n\treadonly duration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; 'isMeasurement': true; comment: 'Amount of time taken by the additional query' };\n\treadonly count: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Total number of extensions returned by this additional query' };\n};\n\ntype GalleryServiceAdditionalQueryEvent = {\n\treadonly duration: number;\n\treadonly count: number;\n};\n\ntype ExtensionsCriteria = {\n\treadonly productVersion: IProductVersion;\n\treadonly targetPlatform: TargetPlatform;\n\treadonly compatible: boolean;\n\treadonly includePreRelease: boolean | (IExtensionIdentifier & { includePreRelease: boolean })[];\n\treadonly versions?: (IExtensionIdentifier & { version: string })[];\n\treadonly isQueryForReleaseVersionFromPreReleaseVersion?: boolean;\n};\n\nconst enum VersionKind {\n\tRelease,\n\tPrerelease,\n\tLatest\n}\n\ntype ExtensionVersionCriteria = {\n\treadonly productVersion: IProductVersion;\n\treadonly targetPlatform: TargetPlatform;\n\treadonly compatible: boolean;\n\treadonly version: VersionKind | string;\n};\n\nclass Query {\n\n\tconstructor(private state = DefaultQueryState) { }\n\n\tget pageNumber(): number { return this.state.pageNumber; }\n\tget pageSize(): number { return this.state.pageSize; }\n\tget sortBy(): SortBy { return this.state.sortBy; }\n\tget sortOrder(): number { return this.state.sortOrder; }\n\tget flags(): Flag[] { return this.state.flags; }\n\tget criteria(): ICriterium[] { return this.state.criteria; }\n\tget assetTypes(): string[] { return this.state.assetTypes; }\n\tget source(): string | undefined { return this.state.source; }\n\tget searchText(): string {\n\t\tconst criterium = this.state.criteria.filter(criterium => criterium.filterType === FilterType.SearchText)[0];\n\t\treturn criterium && criterium.value ? criterium.value : '';\n\t}\n\n\n\twithPage(pageNumber: number, pageSize: number = this.state.pageSize): Query {\n\t\treturn new Query({ ...this.state, pageNumber, pageSize });\n\t}\n\n\twithFilter(filterType: FilterType, ...values: string[]): Query {\n\t\tconst criteria = [\n\t\t\t...this.state.criteria,\n\t\t\t...values.length ? values.map(value => ({ filterType, value })) : [{ filterType }]\n\t\t];\n\n\t\treturn new Query({ ...this.state, criteria });\n\t}\n\n\twithSortBy(sortBy: SortBy): Query {\n\t\treturn new Query({ ...this.state, sortBy });\n\t}\n\n\twithSortOrder(sortOrder: SortOrder): Query {\n\t\treturn new Query({ ...this.state, sortOrder });\n\t}\n\n\twithFlags(...flags: Flag[]): Query {\n\t\treturn new Query({ ...this.state, flags: distinct(flags) });\n\t}\n\n\twithAssetTypes(...assetTypes: string[]): Query {\n\t\treturn new Query({ ...this.state, assetTypes });\n\t}\n\n\twithSource(source: string): Query {\n\t\treturn new Query({ ...this.state, source });\n\t}\n}\n\nfunction getStatistic(statistics: IRawGalleryExtensionStatistics[], name: string): number {\n\tconst result = (statistics || []).filter(s => s.statisticName === name)[0];\n\treturn result ? result.value : 0;\n}\n\nfunction getCoreTranslationAssets(version: IRawGalleryExtensionVersion): [string, IGalleryExtensionAsset][] {\n\tconst coreTranslationAssetPrefix = 'Microsoft.VisualStudio.Code.Translation.';\n\tconst result = version.files.filter(f => f.assetType.indexOf(coreTranslationAssetPrefix) === 0);\n\treturn result.reduce<[string, IGalleryExtensionAsset][]>((result, file) => {\n\t\tconst asset = getVersionAsset(version, file.assetType);\n\t\tif (asset) {\n\t\t\tresult.push([file.assetType.substring(coreTranslationAssetPrefix.length), asset]);\n\t\t}\n\t\treturn result;\n\t}, []);\n}\n\nfunction getRepositoryAsset(version: IRawGalleryExtensionVersion): IGalleryExtensionAsset | null {\n\tif (version.properties) {\n\t\tconst results = version.properties.filter(p => p.key === AssetType.Repository);\n\t\tconst gitRegExp = new RegExp('((git|ssh|http(s)?)|(git@[\\\\w.]+))(:(//)?)([\\\\w.@:/\\\\-~]+)(.git)(/)?');\n\n\t\tconst uri = results.filter(r => gitRegExp.test(r.value))[0];\n\t\treturn uri ? { uri: uri.value, fallbackUri: uri.value } : null;\n\t}\n\treturn getVersionAsset(version, AssetType.Repository);\n}\n\nfunction getDownloadAsset(version: IRawGalleryExtensionVersion): IGalleryExtensionAsset {\n\treturn {\n\t\t// always use fallbackAssetUri for download asset to hit the Marketplace API so that downloads are counted\n\t\turi: `${version.fallbackAssetUri}/${AssetType.VSIX}?redirect=true${version.targetPlatform ? `&targetPlatform=${version.targetPlatform}` : ''}`,\n\t\tfallbackUri: `${version.fallbackAssetUri}/${AssetType.VSIX}${version.targetPlatform ? `?targetPlatform=${version.targetPlatform}` : ''}`\n\t};\n}\n\nfunction getVersionAsset(version: IRawGalleryExtensionVersion, type: string): IGalleryExtensionAsset | null {\n\tconst result = version.files.filter(f => f.assetType === type)[0];\n\treturn result ? {\n\t\turi: `${version.assetUri}/${type}${version.targetPlatform ? `?targetPlatform=${version.targetPlatform}` : ''}`,\n\t\tfallbackUri: `${version.fallbackAssetUri}/${type}${version.targetPlatform ? `?targetPlatform=${version.targetPlatform}` : ''}`\n\t} : null;\n}\n\nfunction getExtensions(version: IRawGalleryExtensionVersion, property: string): string[] {\n\tconst values = version.properties ? version.properties.filter(p => p.key === property) : [];\n\tconst value = values.length > 0 && values[0].value;\n\treturn value ? value.split(',').map(v => adoptToGalleryExtensionId(v)) : [];\n}\n\nfunction getEngine(version: IRawGalleryExtensionVersion): string {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.Engine) : [];\n\treturn (values.length > 0 && values[0].value) || '';\n}\n\nfunction isPreReleaseVersion(version: IRawGalleryExtensionVersion): boolean {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.PreRelease) : [];\n\treturn values.length > 0 && values[0].value === 'true';\n}\n\nfunction hasPreReleaseForExtension(id: string, productService: IProductService): boolean | undefined {\n\treturn productService.extensionProperties?.[id.toLowerCase()]?.hasPrereleaseVersion;\n}\n\nfunction getExcludeVersionRangeForExtension(id: string, productService: IProductService): string | undefined {\n\treturn productService.extensionProperties?.[id.toLowerCase()]?.excludeVersionRange;\n}\n\nfunction isPrivateExtension(version: IRawGalleryExtensionVersion): boolean {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.Private) : [];\n\treturn values.length > 0 && values[0].value === 'true';\n}\n\nfunction executesCode(version: IRawGalleryExtensionVersion): boolean | undefined {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.ExecutesCode) : [];\n\treturn values.length > 0 ? values[0].value === 'true' : undefined;\n}\n\nfunction getEnabledApiProposals(version: IRawGalleryExtensionVersion): string[] {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.EnabledApiProposals) : [];\n\tconst value = (values.length > 0 && values[0].value) || '';\n\treturn value ? value.split(',') : [];\n}\n\nfunction getLocalizedLanguages(version: IRawGalleryExtensionVersion): string[] {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.LocalizedLanguages) : [];\n\tconst value = (values.length > 0 && values[0].value) || '';\n\treturn value ? value.split(',') : [];\n}\n\nfunction getSponsorLink(version: IRawGalleryExtensionVersion): string | undefined {\n\treturn version.properties?.find(p => p.key === PropertyType.SponsorLink)?.value;\n}\n\nfunction getSupportLink(version: IRawGalleryExtensionVersion): string | undefined {\n\treturn version.properties?.find(p => p.key === PropertyType.SupportLink)?.value;\n}\n\nfunction getIsPreview(flags: string): boolean {\n\treturn flags.indexOf('preview') !== -1;\n}\n\nfunction getTargetPlatformForExtensionVersion(version: IRawGalleryExtensionVersion): TargetPlatform {\n\treturn version.targetPlatform ? toTargetPlatform(version.targetPlatform) : TargetPlatform.UNDEFINED;\n}\n\nfunction getAllTargetPlatforms(rawGalleryExtension: IRawGalleryExtension): TargetPlatform[] {\n\tconst allTargetPlatforms = distinct(rawGalleryExtension.versions.map(getTargetPlatformForExtensionVersion));\n\n\t// Is a web extension only if it has WEB_EXTENSION_TAG\n\tconst isWebExtension = !!rawGalleryExtension.tags?.includes(WEB_EXTENSION_TAG);\n\n\t// Include Web Target Platform only if it is a web extension\n\tconst webTargetPlatformIndex = allTargetPlatforms.indexOf(TargetPlatform.WEB);\n\tif (isWebExtension) {\n\t\tif (webTargetPlatformIndex === -1) {\n\t\t\t// Web extension but does not has web target platform -> add it\n\t\t\tallTargetPlatforms.push(TargetPlatform.WEB);\n\t\t}\n\t} else {\n\t\tif (webTargetPlatformIndex !== -1) {\n\t\t\t// Not a web extension but has web target platform -> remove it\n\t\t\tallTargetPlatforms.splice(webTargetPlatformIndex, 1);\n\t\t}\n\t}\n\n\treturn allTargetPlatforms;\n}\n\nexport function sortExtensionVersions(versions: IRawGalleryExtensionVersion[], preferredTargetPlatform: TargetPlatform): IRawGalleryExtensionVersion[] {\n\t/* It is expected that versions from Marketplace are sorted by version. So we are just sorting by preferred targetPlatform */\n\tfor (let index = 0; index < versions.length; index++) {\n\t\tconst version = versions[index];\n\t\tif (version.version === versions[index - 1]?.version) {\n\t\t\tlet insertionIndex = index;\n\t\t\tconst versionTargetPlatform = getTargetPlatformForExtensionVersion(version);\n\t\t\t/* put it at the beginning */\n\t\t\tif (versionTargetPlatform === preferredTargetPlatform) {\n\t\t\t\twhile (insertionIndex > 0 && versions[insertionIndex - 1].version === version.version) { insertionIndex--; }\n\t\t\t}\n\t\t\tif (insertionIndex !== index) {\n\t\t\t\tversions.splice(index, 1);\n\t\t\t\tversions.splice(insertionIndex, 0, version);\n\t\t\t}\n\t\t}\n\t}\n\treturn versions;\n}\n\nexport function filterLatestExtensionVersionsForTargetPlatform(versions: IRawGalleryExtensionVersion[], targetPlatform: TargetPlatform, allTargetPlatforms: TargetPlatform[]): IRawGalleryExtensionVersion[] {\n\tconst latestVersions: IRawGalleryExtensionVersion[] = [];\n\n\tlet preReleaseVersionFoundForTargetPlatform: boolean = false;\n\tlet releaseVersionFoundForTargetPlatform: boolean = false;\n\tfor (const version of versions) {\n\t\tconst versionTargetPlatform = getTargetPlatformForExtensionVersion(version);\n\t\tconst isCompatibleWithTargetPlatform = isTargetPlatformCompatible(versionTargetPlatform, allTargetPlatforms, targetPlatform);\n\n\t\t// Always include versions that are NOT compatible with the target platform\n\t\tif (!isCompatibleWithTargetPlatform) {\n\t\t\tlatestVersions.push(version);\n\t\t\tcontinue;\n\t\t}\n\n\t\t// For compatible versions, only include the first (latest) of each type\n\t\tif (isPreReleaseVersion(version)) {\n\t\t\tif (!preReleaseVersionFoundForTargetPlatform) {\n\t\t\t\tpreReleaseVersionFoundForTargetPlatform = true;\n\t\t\t\tlatestVersions.push(version);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!releaseVersionFoundForTargetPlatform) {\n\t\t\t\treleaseVersionFoundForTargetPlatform = true;\n\t\t\t\tlatestVersions.push(version);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn latestVersions;\n}\n\nfunction setTelemetry(extension: IGalleryExtension, index: number, querySource?: string): void {\n\t/* __GDPR__FRAGMENT__\n\t\"GalleryExtensionTelemetryData2\" : {\n\t\t\"index\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\", \"isMeasurement\": true },\n\t\t\"querySource\": { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\" },\n\t\t\"queryActivityId\": { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\" }\n\t}\n\t*/\n\textension.telemetryData = { index, querySource, queryActivityId: extension.queryContext?.[SEARCH_ACTIVITY_HEADER_NAME] };\n}\n\nfunction toExtension(galleryExtension: IRawGalleryExtension, version: IRawGalleryExtensionVersion, allTargetPlatforms: TargetPlatform[], extensionGalleryManifest: IExtensionGalleryManifest, productService: IProductService, queryContext?: IStringDictionary<unknown>): IGalleryExtension {\n\tconst latestVersion = galleryExtension.versions[0];\n\tconst assets: IGalleryExtensionAssets = {\n\t\tmanifest: getVersionAsset(version, AssetType.Manifest),\n\t\treadme: getVersionAsset(version, AssetType.Details),\n\t\tchangelog: getVersionAsset(version, AssetType.Changelog),\n\t\tlicense: getVersionAsset(version, AssetType.License),\n\t\trepository: getRepositoryAsset(version),\n\t\tdownload: getDownloadAsset(version),\n\t\ticon: getVersionAsset(version, AssetType.Icon),\n\t\tsignature: getVersionAsset(version, AssetType.Signature),\n\t\tcoreTranslations: getCoreTranslationAssets(version)\n\t};\n\n\tconst detailsViewUri = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, galleryExtension.linkType ?? ExtensionGalleryResourceType.ExtensionDetailsViewUri);\n\tconst publisherViewUri = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, galleryExtension.publisher.linkType ?? ExtensionGalleryResourceType.PublisherViewUri);\n\tconst ratingViewUri = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, galleryExtension.ratingLinkType ?? ExtensionGalleryResourceType.ExtensionRatingViewUri);\n\tconst id = getGalleryExtensionId(galleryExtension.publisher.publisherName, galleryExtension.extensionName);\n\n\treturn {\n\t\ttype: 'gallery',\n\t\tidentifier: {\n\t\t\tid,\n\t\t\tuuid: galleryExtension.extensionId\n\t\t},\n\t\tname: galleryExtension.extensionName,\n\t\tversion: version.version,\n\t\tdisplayName: galleryExtension.displayName,\n\t\tpublisherId: galleryExtension.publisher.publisherId,\n\t\tpublisher: galleryExtension.publisher.publisherName,\n\t\tpublisherDisplayName: galleryExtension.publisher.displayName,\n\t\tpublisherDomain: galleryExtension.publisher.domain ? { link: galleryExtension.publisher.domain, verified: !!galleryExtension.publisher.isDomainVerified } : undefined,\n\t\tpublisherSponsorLink: getSponsorLink(latestVersion),\n\t\tdescription: galleryExtension.shortDescription ?? '',\n\t\tinstallCount: getStatistic(galleryExtension.statistics, 'install'),\n\t\trating: getStatistic(galleryExtension.statistics, 'averagerating'),\n\t\tratingCount: getStatistic(galleryExtension.statistics, 'ratingcount'),\n\t\tcategories: galleryExtension.categories || [],\n\t\ttags: galleryExtension.tags || [],\n\t\treleaseDate: Date.parse(galleryExtension.releaseDate),\n\t\tlastUpdated: Date.parse(galleryExtension.lastUpdated),\n\t\tallTargetPlatforms,\n\t\tassets,\n\t\tproperties: {\n\t\t\tdependencies: getExtensions(version, PropertyType.Dependency),\n\t\t\textensionPack: getExtensions(version, PropertyType.ExtensionPack),\n\t\t\tengine: getEngine(version),\n\t\t\tenabledApiProposals: getEnabledApiProposals(version),\n\t\t\tlocalizedLanguages: getLocalizedLanguages(version),\n\t\t\ttargetPlatform: getTargetPlatformForExtensionVersion(version),\n\t\t\tisPreReleaseVersion: isPreReleaseVersion(version),\n\t\t\texecutesCode: executesCode(version)\n\t\t},\n\t\thasPreReleaseVersion: hasPreReleaseForExtension(id, productService) ?? isPreReleaseVersion(latestVersion),\n\t\thasReleaseVersion: true,\n\t\tprivate: isPrivateExtension(latestVersion),\n\t\tpreview: getIsPreview(galleryExtension.flags),\n\t\tisSigned: !!assets.signature,\n\t\tqueryContext,\n\t\tsupportLink: getSupportLink(latestVersion),\n\t\tdetailsLink: detailsViewUri ? format2(detailsViewUri, { publisher: galleryExtension.publisher.publisherName, name: galleryExtension.extensionName }) : undefined,\n\t\tpublisherLink: publisherViewUri ? format2(publisherViewUri, { publisher: galleryExtension.publisher.publisherName }) : undefined,\n\t\tratingLink: ratingViewUri ? format2(ratingViewUri, { publisher: galleryExtension.publisher.publisherName, name: galleryExtension.extensionName }) : undefined,\n\t};\n}\n\ninterface IRawExtensionsControlManifest {\n\tmalicious: string[];\n\tlearnMoreLinks?: IStringDictionary<string>;\n\tmigrateToPreRelease?: IStringDictionary<{\n\t\tid: string;\n\t\tdisplayName: string;\n\t\tmigrateStorage?: boolean;\n\t\tengine?: string;\n\t}>;\n\tdeprecated?: IStringDictionary<boolean | {\n\t\tdisallowInstall?: boolean;\n\t\textension?: {\n\t\t\tid: string;\n\t\t\tdisplayName: string;\n\t\t};\n\t\tsettings?: string[];\n\t\tadditionalInfo?: string;\n\t}>;\n\tsearch?: ISearchPrefferedResults[];\n\tautoUpdate?: IStringDictionary<string>;\n}\n\nexport abstract class AbstractExtensionGalleryService implements IExtensionGalleryService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly extensionsControlUrl: string | undefined;\n\tprivate readonly unpkgResourceApi: string | undefined;\n\n\tprivate readonly commonHeadersPromise: Promise<IHeaders>;\n\tprivate readonly extensionsEnabledWithApiProposalVersion: string[];\n\n\tconstructor(\n\t\tstorageService: IStorageService | undefined,\n\t\t@IRequestService private readonly requestService: IRequestService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IEnvironmentService private readonly environmentService: IEnvironmentService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IProductService private readonly productService: IProductService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IAllowedExtensionsService private readonly allowedExtensionsService: IAllowedExtensionsService,\n\t\t@IExtensionGalleryManifestService private readonly extensionGalleryManifestService: IExtensionGalleryManifestService,\n\t) {\n\t\tthis.extensionsControlUrl = productService.extensionsGallery?.controlUrl;\n\t\tthis.unpkgResourceApi = productService.extensionsGallery?.extensionUrlTemplate;\n\t\tthis.extensionsEnabledWithApiProposalVersion = productService.extensionsEnabledWithApiProposalVersion?.map(id => id.toLowerCase()) ?? [];\n\t\tthis.commonHeadersPromise = resolveMarketplaceHeaders(\n\t\t\tproductService.version,\n\t\t\tproductService,\n\t\t\tthis.environmentService,\n\t\t\tthis.configurationService,\n\t\t\tthis.fileService,\n\t\t\tstorageService,\n\t\t\tthis.telemetryService);\n\t}\n\n\tisEnabled(): boolean {\n\t\treturn this.extensionGalleryManifestService.extensionGalleryManifestStatus === ExtensionGalleryManifestStatus.Available;\n\t}\n\n\tgetExtensions(extensionInfos: ReadonlyArray<IExtensionInfo>, token: CancellationToken): Promise<IGalleryExtension[]>;\n\tgetExtensions(extensionInfos: ReadonlyArray<IExtensionInfo>, options: IExtensionQueryOptions, token: CancellationToken): Promise<IGalleryExtension[]>;\n\tasync getExtensions(extensionInfos: ReadonlyArray<IExtensionInfo>, arg1: CancellationToken | IExtensionQueryOptions, arg2?: CancellationToken): Promise<IGalleryExtension[]> {\n\t\tconst extensionGalleryManifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\t\tif (!extensionGalleryManifest) {\n\t\t\tthrow new Error('No extension gallery service configured.');\n\t\t}\n\n\t\tconst options = CancellationToken.isCancellationToken(arg1) ? {} : arg1 as IExtensionQueryOptions;\n\t\tconst token = CancellationToken.isCancellationToken(arg1) ? arg1 : arg2 as CancellationToken;\n\n\t\tconst resourceApi = this.getResourceApi(extensionGalleryManifest);\n\t\tconst result = resourceApi\n\t\t\t? await this.getExtensionsUsingResourceApi(extensionInfos, options, resourceApi, extensionGalleryManifest, token)\n\t\t\t: await this.getExtensionsUsingQueryApi(extensionInfos, options, extensionGalleryManifest, token);\n\n\t\tconst uuids = result.map(r => r.identifier.uuid);\n\t\tconst extensionInfosByName: IExtensionInfo[] = [];\n\t\tfor (const e of extensionInfos) {\n\t\t\tif (e.uuid && !uuids.includes(e.uuid)) {\n\t\t\t\textensionInfosByName.push({ ...e, uuid: undefined });\n\t\t\t}\n\t\t}\n\n\t\tif (extensionInfosByName.length) {\n\t\t\t// report telemetry data for additional query\n\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t{ count: number },\n\t\t\t\t{\n\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\tcomment: 'Report the query to the Marketplace for fetching extensions by name';\n\t\t\t\t\treadonly count: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Number of extensions to fetch' };\n\t\t\t\t}>('galleryService:additionalQueryByName', {\n\t\t\t\t\tcount: extensionInfosByName.length\n\t\t\t\t});\n\n\t\t\tconst extensions = await this.getExtensionsUsingQueryApi(extensionInfosByName, options, extensionGalleryManifest, token);\n\t\t\tresult.push(...extensions);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprivate getResourceApi(extensionGalleryManifest: IExtensionGalleryManifest): { uri: string; fallback?: string } | undefined {\n\t\tconst latestVersionResource = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, ExtensionGalleryResourceType.ExtensionLatestVersionUri);\n\t\tif (latestVersionResource) {\n\t\t\treturn {\n\t\t\t\turi: latestVersionResource,\n\t\t\t\tfallback: this.unpkgResourceApi\n\t\t\t};\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprivate async getExtensionsUsingQueryApi(extensionInfos: ReadonlyArray<IExtensionInfo>, options: IExtensionQueryOptions, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<IGalleryExtension[]> {\n\t\tconst names: string[] = [],\n\t\t\tids: string[] = [],\n\t\t\tincludePreRelease: (IExtensionIdentifier & { includePreRelease: boolean })[] = [],\n\t\t\tversions: (IExtensionIdentifier & { version: string })[] = [];\n\t\tlet isQueryForReleaseVersionFromPreReleaseVersion = true;\n\n\t\tfor (const extensionInfo of extensionInfos) {\n\t\t\tif (extensionInfo.uuid) {\n\t\t\t\tids.push(extensionInfo.uuid);\n\t\t\t} else {\n\t\t\t\tnames.push(extensionInfo.id);\n\t\t\t}\n\t\t\tif (extensionInfo.version) {\n\t\t\t\tversions.push({ id: extensionInfo.id, uuid: extensionInfo.uuid, version: extensionInfo.version });\n\t\t\t} else {\n\t\t\t\tincludePreRelease.push({ id: extensionInfo.id, uuid: extensionInfo.uuid, includePreRelease: !!extensionInfo.preRelease });\n\t\t\t}\n\t\t\tisQueryForReleaseVersionFromPreReleaseVersion = isQueryForReleaseVersionFromPreReleaseVersion && (!!extensionInfo.hasPreRelease && !extensionInfo.preRelease);\n\t\t}\n\n\t\tif (!ids.length && !names.length) {\n\t\t\treturn [];\n\t\t}\n\n\t\tlet query = new Query().withPage(1, extensionInfos.length);\n\t\tif (ids.length) {\n\t\t\tquery = query.withFilter(FilterType.ExtensionId, ...ids);\n\t\t}\n\t\tif (names.length) {\n\t\t\tquery = query.withFilter(FilterType.ExtensionName, ...names);\n\t\t}\n\t\tif (options.queryAllVersions) {\n\t\t\tquery = query.withFlags(...query.flags, Flag.IncludeVersions);\n\t\t}\n\t\tif (options.source) {\n\t\t\tquery = query.withSource(options.source);\n\t\t}\n\n\t\tconst { extensions } = await this.queryGalleryExtensions(\n\t\t\tquery,\n\t\t\t{\n\t\t\t\ttargetPlatform: options.targetPlatform ?? CURRENT_TARGET_PLATFORM,\n\t\t\t\tincludePreRelease,\n\t\t\t\tversions,\n\t\t\t\tcompatible: !!options.compatible,\n\t\t\t\tproductVersion: options.productVersion ?? { version: this.productService.version, date: this.productService.date },\n\t\t\t\tisQueryForReleaseVersionFromPreReleaseVersion\n\t\t\t},\n\t\t\textensionGalleryManifest,\n\t\t\ttoken);\n\n\t\tif (options.source) {\n\t\t\textensions.forEach((e, index) => setTelemetry(e, index, options.source));\n\t\t}\n\n\t\treturn extensions;\n\t}\n\n\tprivate async getExtensionsUsingResourceApi(extensionInfos: ReadonlyArray<IExtensionInfo>, options: IExtensionQueryOptions, resourceApi: { uri: string; fallback?: string }, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<IGalleryExtension[]> {\n\n\t\tconst result: IGalleryExtension[] = [];\n\t\tconst toQuery: IExtensionInfo[] = [];\n\t\tconst toFetchLatest: IExtensionInfo[] = [];\n\n\t\tfor (const extensionInfo of extensionInfos) {\n\t\t\tif (!EXTENSION_IDENTIFIER_REGEX.test(extensionInfo.id)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (extensionInfo.version) {\n\t\t\t\ttoQuery.push(extensionInfo);\n\t\t\t} else {\n\t\t\t\ttoFetchLatest.push(extensionInfo);\n\t\t\t}\n\t\t}\n\n\t\tawait Promise.all(toFetchLatest.map(async extensionInfo => {\n\t\t\tlet galleryExtension: IGalleryExtension | string;\n\t\t\ttry {\n\t\t\t\tgalleryExtension = await this.getLatestGalleryExtension(extensionInfo, options, resourceApi, extensionGalleryManifest, token);\n\t\t\t\tif (isString(galleryExtension)) {\n\t\t\t\t\t// fallback to query\n\t\t\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\textension: string;\n\t\t\t\t\t\t\tpreRelease: boolean;\n\t\t\t\t\t\t\tcompatible: boolean;\n\t\t\t\t\t\t\terrorCode: string;\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\t\t\tcomment: 'Report the fallback to the Marketplace query for fetching extensions';\n\t\t\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Extension id' };\n\t\t\t\t\t\t\tpreRelease: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Get pre-release version' };\n\t\t\t\t\t\t\tcompatible: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Get compatible version' };\n\t\t\t\t\t\t\terrorCode: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Error code or reason' };\n\t\t\t\t\t\t}>('galleryService:fallbacktoquery', {\n\t\t\t\t\t\t\textension: extensionInfo.id,\n\t\t\t\t\t\t\tpreRelease: !!extensionInfo.preRelease,\n\t\t\t\t\t\t\tcompatible: !!options.compatible,\n\t\t\t\t\t\t\terrorCode: galleryExtension\n\t\t\t\t\t\t});\n\t\t\t\t\ttoQuery.push(extensionInfo);\n\t\t\t\t} else {\n\t\t\t\t\tresult.push(galleryExtension);\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tif (error instanceof ExtensionGalleryError) {\n\t\t\t\t\tswitch (error.code) {\n\t\t\t\t\t\tcase ExtensionGalleryErrorCode.Offline:\n\t\t\t\t\t\tcase ExtensionGalleryErrorCode.Cancelled:\n\t\t\t\t\t\tcase ExtensionGalleryErrorCode.Timeout:\n\t\t\t\t\t\t\tthrow error;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// fallback to query\n\t\t\t\tthis.logService.error(`Error while getting the latest version for the extension ${extensionInfo.id}.`, getErrorMessage(error));\n\t\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t\t{\n\t\t\t\t\t\textension: string;\n\t\t\t\t\t\tpreRelease: boolean;\n\t\t\t\t\t\tcompatible: boolean;\n\t\t\t\t\t\terrorCode: string;\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\t\tcomment: 'Report the fallback to the Marketplace query for fetching extensions';\n\t\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Extension id' };\n\t\t\t\t\t\tpreRelease: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Get pre-release version' };\n\t\t\t\t\t\tcompatible: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Get compatible version' };\n\t\t\t\t\t\terrorCode: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Error code' };\n\t\t\t\t\t}>('galleryService:fallbacktoquery', {\n\t\t\t\t\t\textension: extensionInfo.id,\n\t\t\t\t\t\tpreRelease: !!extensionInfo.preRelease,\n\t\t\t\t\t\tcompatible: !!options.compatible,\n\t\t\t\t\t\terrorCode: error instanceof ExtensionGalleryError ? error.code : 'Unknown'\n\t\t\t\t\t});\n\t\t\t\ttoQuery.push(extensionInfo);\n\t\t\t}\n\n\t\t}));\n\n\t\tif (toQuery.length) {\n\t\t\tconst extensions = await this.getExtensionsUsingQueryApi(toQuery, options, extensionGalleryManifest, token);\n\t\t\tresult.push(...extensions);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprivate async getLatestGalleryExtension(extensionInfo: IExtensionInfo, options: IExtensionQueryOptions, resourceApi: { uri: string; fallback?: string }, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<IGalleryExtension | string> {\n\t\tconst rawGalleryExtension = await this.getLatestRawGalleryExtensionWithFallback(extensionInfo, resourceApi, token);\n\n\t\tif (!rawGalleryExtension) {\n\t\t\treturn 'NOT_FOUND';\n\t\t}\n\n\t\tconst targetPlatform = options.targetPlatform ?? CURRENT_TARGET_PLATFORM;\n\t\tconst allTargetPlatforms = getAllTargetPlatforms(rawGalleryExtension);\n\t\tconst rawGalleryExtensionVersion = await this.getValidRawGalleryExtensionVersion(\n\t\t\trawGalleryExtension,\n\t\t\tfilterLatestExtensionVersionsForTargetPlatform(rawGalleryExtension.versions, targetPlatform, allTargetPlatforms),\n\t\t\t{\n\t\t\t\ttargetPlatform,\n\t\t\t\tcompatible: !!options.compatible,\n\t\t\t\tproductVersion: options.productVersion ?? {\n\t\t\t\t\tversion: this.productService.version,\n\t\t\t\t\tdate: this.productService.date\n\t\t\t\t},\n\t\t\t\tversion: extensionInfo.preRelease ? VersionKind.Latest : VersionKind.Release\n\t\t\t}, allTargetPlatforms);\n\n\t\tif (rawGalleryExtensionVersion) {\n\t\t\treturn toExtension(rawGalleryExtension, rawGalleryExtensionVersion, allTargetPlatforms, extensionGalleryManifest, this.productService);\n\t\t}\n\n\t\treturn 'NOT_COMPATIBLE';\n\t}\n\n\tasync getCompatibleExtension(extension: IGalleryExtension, includePreRelease: boolean, targetPlatform: TargetPlatform, productVersion: IProductVersion = { version: this.productService.version, date: this.productService.date }): Promise<IGalleryExtension | null> {\n\t\tif (isNotWebExtensionInWebTargetPlatform(extension.allTargetPlatforms, targetPlatform)) {\n\t\t\treturn null;\n\t\t}\n\t\tif (await this.isExtensionCompatible(extension, includePreRelease, targetPlatform)) {\n\t\t\treturn extension;\n\t\t}\n\t\tif (this.allowedExtensionsService.isAllowed({ id: extension.identifier.id, publisherDisplayName: extension.publisherDisplayName }) !== true) {\n\t\t\treturn null;\n\t\t}\n\t\tconst result = await this.getExtensions([{\n\t\t\t...extension.identifier,\n\t\t\tpreRelease: includePreRelease,\n\t\t\thasPreRelease: extension.hasPreReleaseVersion,\n\t\t}], {\n\t\t\tcompatible: true,\n\t\t\tproductVersion,\n\t\t\tqueryAllVersions: true,\n\t\t\ttargetPlatform,\n\t\t}, CancellationToken.None);\n\n\t\treturn result[0] ?? null;\n\t}\n\n\tasync isExtensionCompatible(extension: IGalleryExtension, includePreRelease: boolean, targetPlatform: TargetPlatform, productVersion: IProductVersion = { version: this.productService.version, date: this.productService.date }): Promise<boolean> {\n\t\treturn this.isValidVersion(\n\t\t\t{\n\t\t\t\tid: extension.identifier.id,\n\t\t\t\tversion: extension.version,\n\t\t\t\tisPreReleaseVersion: extension.properties.isPreReleaseVersion,\n\t\t\t\ttargetPlatform: extension.properties.targetPlatform,\n\t\t\t\tmanifestAsset: extension.assets.manifest,\n\t\t\t\tengine: extension.properties.engine,\n\t\t\t\tenabledApiProposals: extension.properties.enabledApiProposals\n\t\t\t},\n\t\t\t{\n\t\t\t\ttargetPlatform,\n\t\t\t\tcompatible: true,\n\t\t\t\tproductVersion,\n\t\t\t\tversion: includePreRelease ? VersionKind.Latest : VersionKind.Release\n\t\t\t},\n\t\t\textension.publisherDisplayName,\n\t\t\textension.allTargetPlatforms\n\t\t);\n\t}\n\n\tprivate async isValidVersion(\n\t\textension: { id: string; version: string; isPreReleaseVersion: boolean; targetPlatform: TargetPlatform; manifestAsset: IGalleryExtensionAsset | null; engine: string | undefined; enabledApiProposals: string[] | undefined },\n\t\t{ targetPlatform, compatible, productVersion, version }: Omit<ExtensionVersionCriteria, 'targetPlatform'> & { targetPlatform: TargetPlatform | undefined },\n\t\tpublisherDisplayName: string,\n\t\tallTargetPlatforms: TargetPlatform[]\n\t): Promise<boolean> {\n\n\t\tconst hasPreRelease = hasPreReleaseForExtension(extension.id, this.productService);\n\t\tconst excludeVersionRange = getExcludeVersionRangeForExtension(extension.id, this.productService);\n\n\t\tif (extension.isPreReleaseVersion && hasPreRelease === false /* Skip if hasPreRelease is not defined for this extension */) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (excludeVersionRange && semver.satisfies(extension.version, excludeVersionRange)) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Specific version\n\t\tif (isString(version)) {\n\t\t\tif (extension.version !== version) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t// Prerelease or release version kind\n\t\telse if (version === VersionKind.Release || version === VersionKind.Prerelease) {\n\t\t\tif (extension.isPreReleaseVersion !== (version === VersionKind.Prerelease)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tif (targetPlatform && !isTargetPlatformCompatible(extension.targetPlatform, allTargetPlatforms, targetPlatform)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (compatible) {\n\t\t\tif (this.allowedExtensionsService.isAllowed({ id: extension.id, publisherDisplayName, version: extension.version, prerelease: extension.isPreReleaseVersion, targetPlatform: extension.targetPlatform }) !== true) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (!this.areApiProposalsCompatible(extension.id, extension.enabledApiProposals)) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (!(await this.isEngineValid(extension.id, extension.version, extension.engine, extension.manifestAsset, productVersion))) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprivate areApiProposalsCompatible(extensionId: string, enabledApiProposals: string[] | undefined): boolean {\n\t\tif (!enabledApiProposals) {\n\t\t\treturn true;\n\t\t}\n\t\tif (!this.extensionsEnabledWithApiProposalVersion.includes(extensionId.toLowerCase())) {\n\t\t\treturn true;\n\t\t}\n\t\treturn areApiProposalsCompatible(enabledApiProposals);\n\t}\n\n\tprivate async isEngineValid(extensionId: string, version: string, engine: string | undefined, manifestAsset: IGalleryExtensionAsset | null, productVersion: IProductVersion): Promise<boolean> {\n\t\tif (!engine) {\n\t\t\tif (!manifestAsset) {\n\t\t\t\tthis.logService.error(`Missing engine and manifest asset for the extension ${extensionId} with version ${version}`);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\ttry {\n\t\t\t\ttype GalleryServiceEngineFallbackClassification = {\n\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\tcomment: 'Fallback request when engine is not found in properties of an extension version';\n\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'extension name' };\n\t\t\t\t\textensionVersion: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'version' };\n\t\t\t\t};\n\t\t\t\ttype GalleryServiceEngineFallbackEvent = {\n\t\t\t\t\textension: string;\n\t\t\t\t\textensionVersion: string;\n\t\t\t\t};\n\t\t\t\tthis.telemetryService.publicLog2<GalleryServiceEngineFallbackEvent, GalleryServiceEngineFallbackClassification>('galleryService:engineFallback', { extension: extensionId, extensionVersion: version });\n\n\t\t\t\tconst headers = { 'Accept-Encoding': 'gzip' };\n\t\t\t\tconst context = await this.getAsset(extensionId, manifestAsset, AssetType.Manifest, version, { headers });\n\t\t\t\tconst manifest = await asJson<IExtensionManifest>(context);\n\t\t\t\tif (!manifest) {\n\t\t\t\t\tthis.logService.error(`Manifest was not found for the extension ${extensionId} with version ${version}`);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tengine = manifest.engines.vscode;\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(`Error while getting the engine for the version ${version}.`, getErrorMessage(error));\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn isEngineValid(engine, productVersion.version, productVersion.date);\n\t}\n\n\tasync query(options: IQueryOptions, token: CancellationToken): Promise<IPager<IGalleryExtension>> {\n\t\tconst extensionGalleryManifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\n\t\tif (!extensionGalleryManifest) {\n\t\t\tthrow new Error('No extension gallery service configured.');\n\t\t}\n\n\t\tlet text = options.text || '';\n\t\tconst pageSize = options.pageSize ?? 50;\n\n\t\tlet query = new Query()\n\t\t\t.withPage(1, pageSize);\n\n\t\tif (text) {\n\t\t\t// Use category filter instead of \"category:themes\"\n\t\t\ttext = text.replace(/\\bcategory:(\"([^\"]*)\"|([^\"]\\S*))(\\s+|\\b|$)/g, (_, quotedCategory, category) => {\n\t\t\t\tquery = query.withFilter(FilterType.Category, category || quotedCategory);\n\t\t\t\treturn '';\n\t\t\t});\n\n\t\t\t// Use tag filter instead of \"tag:debuggers\"\n\t\t\ttext = text.replace(/\\btag:(\"([^\"]*)\"|([^\"]\\S*))(\\s+|\\b|$)/g, (_, quotedTag, tag) => {\n\t\t\t\tquery = query.withFilter(FilterType.Tag, tag || quotedTag);\n\t\t\t\treturn '';\n\t\t\t});\n\n\t\t\t// Use featured filter\n\t\t\ttext = text.replace(/\\bfeatured(\\s+|\\b|$)/g, () => {\n\t\t\t\tquery = query.withFilter(FilterType.Featured);\n\t\t\t\treturn '';\n\t\t\t});\n\n\t\t\ttext = text.trim();\n\n\t\t\tif (text) {\n\t\t\t\ttext = text.length < 200 ? text : text.substring(0, 200);\n\t\t\t\tquery = query.withFilter(FilterType.SearchText, text);\n\t\t\t}\n\n\t\t\tif (extensionGalleryManifest.capabilities.extensionQuery.sorting?.some(c => c.name === SortBy.NoneOrRelevance)) {\n\t\t\t\tquery = query.withSortBy(SortBy.NoneOrRelevance);\n\t\t\t}\n\t\t} else {\n\t\t\tif (extensionGalleryManifest.capabilities.extensionQuery.sorting?.some(c => c.name === SortBy.InstallCount)) {\n\t\t\t\tquery = query.withSortBy(SortBy.InstallCount);\n\t\t\t}\n\t\t}\n\n\t\tif (options.sortBy && extensionGalleryManifest.capabilities.extensionQuery.sorting?.some(c => c.name === options.sortBy)) {\n\t\t\tquery = query.withSortBy(options.sortBy);\n\t\t}\n\n\t\tif (typeof options.sortOrder === 'number') {\n\t\t\tquery = query.withSortOrder(options.sortOrder);\n\t\t}\n\n\t\tif (options.source) {\n\t\t\tquery = query.withSource(options.source);\n\t\t}\n\n\t\tconst runQuery = async (query: Query, token: CancellationToken) => {\n\t\t\tconst { extensions, total } = await this.queryGalleryExtensions(query, { targetPlatform: CURRENT_TARGET_PLATFORM, compatible: false, includePreRelease: !!options.includePreRelease, productVersion: options.productVersion ?? { version: this.productService.version, date: this.productService.date } }, extensionGalleryManifest, token);\n\t\t\textensions.forEach((e, index) => setTelemetry(e, ((query.pageNumber - 1) * query.pageSize) + index, options.source));\n\t\t\treturn { extensions, total };\n\t\t};\n\t\tconst { extensions, total } = await runQuery(query, token);\n\t\tconst getPage = async (pageIndex: number, ct: CancellationToken) => {\n\t\t\tif (ct.isCancellationRequested) {\n\t\t\t\tthrow new CancellationError();\n\t\t\t}\n\t\t\tconst { extensions } = await runQuery(query.withPage(pageIndex + 1), ct);\n\t\t\treturn extensions;\n\t\t};\n\n\t\treturn { firstPage: extensions, total, pageSize: query.pageSize, getPage };\n\t}\n\n\tprivate async queryGalleryExtensions(query: Query, criteria: ExtensionsCriteria, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<{ extensions: IGalleryExtension[]; total: number }> {\n\t\tconst flags = query.flags;\n\n\t\t/**\n\t\t * If both version flags (IncludeLatestVersionOnly and IncludeVersions) are included, then only include latest versions (IncludeLatestVersionOnly) flag.\n\t\t */\n\t\tif (query.flags.includes(Flag.IncludeLatestVersionOnly) && query.flags.includes(Flag.IncludeVersions)) {\n\t\t\tquery = query.withFlags(...query.flags.filter(flag => flag !== Flag.IncludeVersions));\n\t\t}\n\n\t\t/**\n\t\t * If version flags (IncludeLatestVersionOnly and IncludeVersions) are not included, default is to query for latest versions (IncludeLatestVersionOnly).\n\t\t */\n\t\tif (!query.flags.includes(Flag.IncludeLatestVersionOnly) && !query.flags.includes(Flag.IncludeVersions)) {\n\t\t\tquery = query.withFlags(...query.flags, Flag.IncludeLatestVersionOnly);\n\t\t}\n\n\t\t/**\n\t\t * If versions criteria exist or every requested extension is for release version and has a pre-release version, then remove latest flags and add all versions flag.\n\t\t */\n\t\tif (criteria.versions?.length || criteria.isQueryForReleaseVersionFromPreReleaseVersion) {\n\t\t\tquery = query.withFlags(...query.flags.filter(flag => flag !== Flag.IncludeLatestVersionOnly), Flag.IncludeVersions);\n\t\t}\n\n\t\t/**\n\t\t * Add necessary extension flags\n\t\t */\n\t\tquery = query.withFlags(...query.flags, Flag.IncludeAssetUri, Flag.IncludeCategoryAndTags, Flag.IncludeFiles, Flag.IncludeStatistics, Flag.IncludeVersionProperties);\n\t\tconst { galleryExtensions: rawGalleryExtensions, total, context } = await this.queryRawGalleryExtensions(query, extensionGalleryManifest, token);\n\n\t\tconst hasAllVersions: boolean = !query.flags.includes(Flag.IncludeLatestVersionOnly);\n\t\tif (hasAllVersions) {\n\t\t\tconst extensions: IGalleryExtension[] = [];\n\t\t\tfor (const rawGalleryExtension of rawGalleryExtensions) {\n\t\t\t\tconst allTargetPlatforms = getAllTargetPlatforms(rawGalleryExtension);\n\t\t\t\tconst extensionIdentifier = { id: getGalleryExtensionId(rawGalleryExtension.publisher.publisherName, rawGalleryExtension.extensionName), uuid: rawGalleryExtension.extensionId };\n\t\t\t\tconst includePreRelease = isBoolean(criteria.includePreRelease) ? criteria.includePreRelease : !!criteria.includePreRelease.find(extensionIdentifierWithPreRelease => areSameExtensions(extensionIdentifierWithPreRelease, extensionIdentifier))?.includePreRelease;\n\t\t\t\tconst rawGalleryExtensionVersion = await this.getValidRawGalleryExtensionVersion(\n\t\t\t\t\trawGalleryExtension,\n\t\t\t\t\trawGalleryExtension.versions,\n\t\t\t\t\t{\n\t\t\t\t\t\tcompatible: criteria.compatible,\n\t\t\t\t\t\ttargetPlatform: criteria.targetPlatform,\n\t\t\t\t\t\tproductVersion: criteria.productVersion,\n\t\t\t\t\t\tversion: criteria.versions?.find(extensionIdentifierWithVersion => areSameExtensions(extensionIdentifierWithVersion, extensionIdentifier))?.version\n\t\t\t\t\t\t\t?? (includePreRelease ? VersionKind.Latest : VersionKind.Release)\n\t\t\t\t\t},\n\t\t\t\t\tallTargetPlatforms\n\t\t\t\t);\n\t\t\t\tif (rawGalleryExtensionVersion) {\n\t\t\t\t\textensions.push(toExtension(rawGalleryExtension, rawGalleryExtensionVersion, allTargetPlatforms, extensionGalleryManifest, this.productService, context));\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn { extensions, total };\n\t\t}\n\n\t\tconst result: [number, IGalleryExtension][] = [];\n\t\tconst needAllVersions = new Map<string, number>();\n\t\tfor (let index = 0; index < rawGalleryExtensions.length; index++) {\n\t\t\tconst rawGalleryExtension = rawGalleryExtensions[index];\n\t\t\tconst extensionIdentifier = { id: getGalleryExtensionId(rawGalleryExtension.publisher.publisherName, rawGalleryExtension.extensionName), uuid: rawGalleryExtension.extensionId };\n\t\t\tconst includePreRelease = isBoolean(criteria.includePreRelease) ? criteria.includePreRelease : !!criteria.includePreRelease.find(extensionIdentifierWithPreRelease => areSameExtensions(extensionIdentifierWithPreRelease, extensionIdentifier))?.includePreRelease;\n\t\t\tconst allTargetPlatforms = getAllTargetPlatforms(rawGalleryExtension);\n\t\t\tif (criteria.compatible) {\n\t\t\t\t// Skip looking for all versions if requested for a web-compatible extension and it is not a web extension.\n\t\t\t\tif (isNotWebExtensionInWebTargetPlatform(allTargetPlatforms, criteria.targetPlatform)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t// Skip looking for all versions if the extension is not allowed.\n\t\t\t\tif (this.allowedExtensionsService.isAllowed({ id: extensionIdentifier.id, publisherDisplayName: rawGalleryExtension.publisher.displayName }) !== true) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst rawGalleryExtensionVersion = await this.getValidRawGalleryExtensionVersion(\n\t\t\t\trawGalleryExtension,\n\t\t\t\trawGalleryExtension.versions,\n\t\t\t\t{\n\t\t\t\t\tcompatible: criteria.compatible,\n\t\t\t\t\ttargetPlatform: criteria.targetPlatform,\n\t\t\t\t\tproductVersion: criteria.productVersion,\n\t\t\t\t\tversion: criteria.versions?.find(extensionIdentifierWithVersion => areSameExtensions(extensionIdentifierWithVersion, extensionIdentifier))?.version\n\t\t\t\t\t\t?? (includePreRelease ? VersionKind.Latest : VersionKind.Release)\n\t\t\t\t},\n\t\t\t\tallTargetPlatforms\n\t\t\t);\n\t\t\tconst extension = rawGalleryExtensionVersion ? toExtension(rawGalleryExtension, rawGalleryExtensionVersion, allTargetPlatforms, extensionGalleryManifest, this.productService, context) : null;\n\t\t\tif (!extension\n\t\t\t\t/** Need all versions if the extension is a pre-release version but\n\t\t\t\t * \t\t- the query is to look for a release version or\n\t\t\t\t * \t\t- the extension has no release version\n\t\t\t\t * Get all versions to get or check the release version\n\t\t\t\t*/\n\t\t\t\t|| (extension.properties.isPreReleaseVersion && (!includePreRelease || !extension.hasReleaseVersion))\n\t\t\t\t/**\n\t\t\t\t * Need all versions if the extension is a release version with a different target platform than requested and also has a pre-release version\n\t\t\t\t * Because, this is a platform specific extension and can have a newer release version supporting this platform.\n\t\t\t\t * See https://github.com/microsoft/vscode/issues/139628\n\t\t\t\t*/\n\t\t\t\t|| (!extension.properties.isPreReleaseVersion && extension.properties.targetPlatform !== criteria.targetPlatform && extension.hasPreReleaseVersion)\n\t\t\t) {\n\t\t\t\tneedAllVersions.set(rawGalleryExtension.extensionId, index);\n\t\t\t} else {\n\t\t\t\tresult.push([index, extension]);\n\t\t\t}\n\t\t}\n\n\t\tif (needAllVersions.size) {\n\t\t\tconst stopWatch = new StopWatch();\n\t\t\tconst query = new Query()\n\t\t\t\t.withFlags(...flags.filter(flag => flag !== Flag.IncludeLatestVersionOnly), Flag.IncludeVersions)\n\t\t\t\t.withPage(1, needAllVersions.size)\n\t\t\t\t.withFilter(FilterType.ExtensionId, ...needAllVersions.keys());\n\t\t\tconst { extensions } = await this.queryGalleryExtensions(query, criteria, extensionGalleryManifest, token);\n\t\t\tthis.telemetryService.publicLog2<GalleryServiceAdditionalQueryEvent, GalleryServiceAdditionalQueryClassification>('galleryService:additionalQuery', {\n\t\t\t\tduration: stopWatch.elapsed(),\n\t\t\t\tcount: needAllVersions.size\n\t\t\t});\n\t\t\tfor (const extension of extensions) {\n\t\t\t\tconst index = needAllVersions.get(extension.identifier.uuid)!;\n\t\t\t\tresult.push([index, extension]);\n\t\t\t}\n\t\t}\n\n\t\treturn { extensions: result.sort((a, b) => a[0] - b[0]).map(([, extension]) => extension), total };\n\t}\n\n\tprivate async getValidRawGalleryExtensionVersion(rawGalleryExtension: IRawGalleryExtension, versions: IRawGalleryExtensionVersion[], criteria: ExtensionVersionCriteria, allTargetPlatforms: TargetPlatform[]): Promise<IRawGalleryExtensionVersion | null> {\n\t\tconst extensionIdentifier = { id: getGalleryExtensionId(rawGalleryExtension.publisher.publisherName, rawGalleryExtension.extensionName), uuid: rawGalleryExtension.extensionId };\n\t\tconst rawGalleryExtensionVersions = sortExtensionVersions(versions, criteria.targetPlatform);\n\n\t\tif (criteria.compatible && isNotWebExtensionInWebTargetPlatform(allTargetPlatforms, criteria.targetPlatform)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst version = isString(criteria.version) ? criteria.version : undefined;\n\n\t\tfor (let index = 0; index < rawGalleryExtensionVersions.length; index++) {\n\t\t\tconst rawGalleryExtensionVersion = rawGalleryExtensionVersions[index];\n\t\t\tif (await this.isValidVersion(\n\t\t\t\t{\n\t\t\t\t\tid: extensionIdentifier.id,\n\t\t\t\t\tversion: rawGalleryExtensionVersion.version,\n\t\t\t\t\tisPreReleaseVersion: isPreReleaseVersion(rawGalleryExtensionVersion),\n\t\t\t\t\ttargetPlatform: getTargetPlatformForExtensionVersion(rawGalleryExtensionVersion),\n\t\t\t\t\tengine: getEngine(rawGalleryExtensionVersion),\n\t\t\t\t\tmanifestAsset: getVersionAsset(rawGalleryExtensionVersion, AssetType.Manifest),\n\t\t\t\t\tenabledApiProposals: getEnabledApiProposals(rawGalleryExtensionVersion)\n\t\t\t\t},\n\t\t\t\tcriteria,\n\t\t\t\trawGalleryExtension.publisher.displayName,\n\t\t\t\tallTargetPlatforms)\n\t\t\t) {\n\t\t\t\treturn rawGalleryExtensionVersion;\n\t\t\t}\n\t\t\tif (version && rawGalleryExtensionVersion.version === version) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\n\t\tif (version || criteria.compatible) {\n\t\t\treturn null;\n\t\t}\n\n\t\t/**\n\t\t * Fallback: Return the latest version\n\t\t * This can happen when the extension does not have a release version or does not have a version compatible with the given target platform.\n\t\t */\n\t\treturn rawGalleryExtension.versions[0];\n\t}\n\n\tprivate async queryRawGalleryExtensions(query: Query, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<IRawGalleryExtensionsResult> {\n\t\tconst extensionsQueryApi = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, ExtensionGalleryResourceType.ExtensionQueryService);\n\n\t\tif (!extensionsQueryApi) {\n\t\t\tthrow new Error('No extension gallery query service configured.');\n\t\t}\n\n\t\tquery = query\n\t\t\t/* Always exclude non validated extensions */\n\t\t\t.withFlags(...query.flags, Flag.ExcludeNonValidated)\n\t\t\t.withFilter(FilterType.Target, 'Microsoft.VisualStudio.Code');\n\n\t\tconst unpublishedFlag = extensionGalleryManifest.capabilities.extensionQuery.flags?.find(f => f.name === Flag.Unpublished);\n\t\t/* Always exclude unpublished extensions */\n\t\tif (unpublishedFlag) {\n\t\t\tquery = query.withFilter(FilterType.ExcludeWithFlags, String(unpublishedFlag.value));\n\t\t}\n\n\t\tconst data = JSON.stringify({\n\t\t\tfilters: [\n\t\t\t\t{\n\t\t\t\t\tcriteria: query.criteria.reduce<{ filterType: number; value?: string }[]>((criteria, c) => {\n\t\t\t\t\t\tconst criterium = extensionGalleryManifest.capabilities.extensionQuery.filtering?.find(f => f.name === c.filterType);\n\t\t\t\t\t\tif (criterium) {\n\t\t\t\t\t\t\tcriteria.push({\n\t\t\t\t\t\t\t\tfilterType: criterium.value,\n\t\t\t\t\t\t\t\tvalue: c.value,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn criteria;\n\t\t\t\t\t}, []),\n\t\t\t\t\tpageNumber: query.pageNumber,\n\t\t\t\t\tpageSize: query.pageSize,\n\t\t\t\t\tsortBy: extensionGalleryManifest.capabilities.extensionQuery.sorting?.find(s => s.name === query.sortBy)?.value,\n\t\t\t\t\tsortOrder: query.sortOrder,\n\t\t\t\t}\n\t\t\t],\n\t\t\tassetTypes: query.assetTypes,\n\t\t\tflags: query.flags.reduce<number>((flags, flag) => {\n\t\t\t\tconst flagValue = extensionGalleryManifest.capabilities.extensionQuery.flags?.find(f => f.name === flag);\n\t\t\t\tif (flagValue) {\n\t\t\t\t\tflags |= flagValue.value;\n\t\t\t\t}\n\t\t\t\treturn flags;\n\t\t\t}, 0)\n\t\t});\n\n\t\tconst commonHeaders = await this.commonHeadersPromise;\n\t\tconst headers = {\n\t\t\t...commonHeaders,\n\t\t\t'Content-Type': 'application/json',\n\t\t\t'Accept': 'application/json;api-version=3.0-preview.1',\n\t\t\t'Accept-Encoding': 'gzip',\n\t\t\t'Content-Length': String(data.length),\n\t\t};\n\n\t\tconst stopWatch = new StopWatch();\n\t\tlet context: IRequestContext | undefined, errorCode: ExtensionGalleryErrorCode | undefined, total: number = 0;\n\n\t\ttry {\n\t\t\tcontext = await this.requestService.request({\n\t\t\t\ttype: 'POST',\n\t\t\t\turl: extensionsQueryApi,\n\t\t\t\tdata,\n\t\t\t\theaders\n\t\t\t}, token);\n\n\t\t\tif (context.res.statusCode && context.res.statusCode >= 400 && context.res.statusCode < 500) {\n\t\t\t\treturn { galleryExtensions: [], total };\n\t\t\t}\n\n\t\t\tconst result = await asJson<IRawGalleryQueryResult>(context);\n\t\t\tif (result) {\n\t\t\t\tconst r = result.results[0];\n\t\t\t\tconst galleryExtensions = r.extensions;\n\t\t\t\tconst resultCount = r.resultMetadata && r.resultMetadata.filter(m => m.metadataType === 'ResultCount')[0];\n\t\t\t\ttotal = resultCount && resultCount.metadataItems.filter(i => i.name === 'TotalCount')[0].count || 0;\n\n\t\t\t\treturn {\n\t\t\t\t\tgalleryExtensions,\n\t\t\t\t\ttotal,\n\t\t\t\t\tcontext: context.res.headers['activityid'] ? {\n\t\t\t\t\t\t[SEARCH_ACTIVITY_HEADER_NAME]: context.res.headers['activityid']\n\t\t\t\t\t} : {}\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn { galleryExtensions: [], total };\n\n\t\t} catch (e) {\n\t\t\tif (isCancellationError(e)) {\n\t\t\t\terrorCode = ExtensionGalleryErrorCode.Cancelled;\n\t\t\t\tthrow e;\n\t\t\t} else {\n\t\t\t\tconst errorMessage = getErrorMessage(e);\n\t\t\t\terrorCode = isOfflineError(e)\n\t\t\t\t\t? ExtensionGalleryErrorCode.Offline\n\t\t\t\t\t: errorMessage.startsWith('XHR timeout')\n\t\t\t\t\t\t? ExtensionGalleryErrorCode.Timeout\n\t\t\t\t\t\t: ExtensionGalleryErrorCode.Failed;\n\t\t\t\tthrow new ExtensionGalleryError(errorMessage, errorCode);\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.telemetryService.publicLog2<GalleryServiceQueryEvent, GalleryServiceQueryClassification>('galleryService:query', {\n\t\t\t\tfilterTypes: query.criteria.map(criterium => criterium.filterType),\n\t\t\t\tflags: query.flags,\n\t\t\t\tsortBy: query.sortBy,\n\t\t\t\tsortOrder: String(query.sortOrder),\n\t\t\t\tpageNumber: String(query.pageNumber),\n\t\t\t\tsource: query.source,\n\t\t\t\tsearchTextLength: query.searchText.length,\n\t\t\t\trequestBodySize: String(data.length),\n\t\t\t\tduration: stopWatch.elapsed(),\n\t\t\t\tsuccess: !!context && isSuccess(context),\n\t\t\t\tresponseBodySize: context?.res.headers['Content-Length'],\n\t\t\t\tstatusCode: context ? String(context.res.statusCode) : undefined,\n\t\t\t\terrorCode,\n\t\t\t\tcount: String(total),\n\t\t\t\tserver: this.getHeaderValue(context?.res.headers, SERVER_HEADER_NAME),\n\t\t\t\tactivityId: this.getHeaderValue(context?.res.headers, ACTIVITY_HEADER_NAME),\n\t\t\t\tendToEndId: this.getHeaderValue(context?.res.headers, END_END_ID_HEADER_NAME),\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate getHeaderValue(headers: IHeaders | undefined, name: string): TelemetryTrustedValue<string> | undefined {\n\t\tconst headerValue = headers?.[name.toLowerCase()];\n\t\tconst value = Array.isArray(headerValue) ? headerValue[0] : headerValue;\n\t\treturn value ? new TelemetryTrustedValue(value) : undefined;\n\t}\n\n\tprivate async getLatestRawGalleryExtensionWithFallback(extensionInfo: IExtensionInfo, resourceApi: { uri: string; fallback?: string }, token: CancellationToken): Promise<IRawGalleryExtension | null> {\n\t\tconst [publisher, name] = extensionInfo.id.split('.');\n\t\tlet errorCode: string | undefined;\n\t\ttry {\n\t\t\tconst uri = URI.parse(format2(resourceApi.uri, { publisher, name }));\n\t\t\treturn await this.getLatestRawGalleryExtension(extensionInfo.id, uri, token);\n\t\t} catch (error) {\n\t\t\tif (error instanceof ExtensionGalleryError) {\n\t\t\t\terrorCode = error.code;\n\t\t\t\tswitch (error.code) {\n\t\t\t\t\tcase ExtensionGalleryErrorCode.Offline:\n\t\t\t\t\tcase ExtensionGalleryErrorCode.Cancelled:\n\t\t\t\t\tcase ExtensionGalleryErrorCode.Timeout:\n\t\t\t\t\tcase ExtensionGalleryErrorCode.ClientError:\n\t\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorCode = 'Unknown';\n\t\t\t}\n\t\t\tif (!resourceApi.fallback) {\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t{\n\t\t\t\t\textension: string;\n\t\t\t\t\terrorCode?: string;\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\tcomment: 'Report fetching latest version of an extension';\n\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The identifier of the extension' };\n\t\t\t\t\terrorCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The error code in case of error' };\n\t\t\t\t}\n\t\t\t>('galleryService:getmarketplacelatest', {\n\t\t\t\textension: extensionInfo.id,\n\t\t\t\terrorCode,\n\t\t\t});\n\t\t}\n\n\t\tthis.logService.error(`Error while getting the latest version for the extension ${extensionInfo.id} from ${resourceApi.uri}. Trying the fallback ${resourceApi.fallback}`, errorCode);\n\t\ttry {\n\t\t\tconst uri = URI.parse(format2(resourceApi.fallback, { publisher, name }));\n\t\t\treturn await this.getLatestRawGalleryExtension(extensionInfo.id, uri, token);\n\t\t} catch (error) {\n\t\t\terrorCode = error instanceof ExtensionGalleryError ? error.code : 'Unknown';\n\t\t\tthrow error;\n\t\t} finally {\n\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t{\n\t\t\t\t\textension: string;\n\t\t\t\t\terrorCode?: string;\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\tcomment: 'Report the fallback to the unpkg service for getting latest extension';\n\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Extension id' };\n\t\t\t\t\terrorCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The error code in case of error' };\n\t\t\t\t}>('galleryService:fallbacktounpkg', {\n\t\t\t\t\textension: extensionInfo.id,\n\t\t\t\t\terrorCode,\n\t\t\t\t});\n\t\t}\n\t}\n\n\tprivate async getLatestRawGalleryExtension(extension: string, uri: URI, token: CancellationToken): Promise<IRawGalleryExtension | null> {\n\t\tlet context;\n\t\tlet errorCode: string | undefined;\n\t\tconst stopWatch = new StopWatch();\n\n\t\ttry {\n\t\t\tconst commonHeaders = await this.commonHeadersPromise;\n\t\t\tconst headers = {\n\t\t\t\t...commonHeaders,\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t'Accept': 'application/json;api-version=7.2-preview',\n\t\t\t\t'Accept-Encoding': 'gzip',\n\t\t\t};\n\n\t\t\tcontext = await this.requestService.request({\n\t\t\t\ttype: 'GET',\n\t\t\t\turl: uri.toString(true),\n\t\t\t\theaders,\n\t\t\t\ttimeout: this.getRequestTimeout()\n\t\t\t}, token);\n\n\t\t\tif (context.res.statusCode === 404) {\n\t\t\t\terrorCode = 'NotFound';\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif (context.res.statusCode && context.res.statusCode !== 200) {\n\t\t\t\tthrow new Error('Unexpected HTTP response: ' + context.res.statusCode);\n\t\t\t}\n\n\t\t\tconst result = await asJson<IRawGalleryExtension>(context);\n\t\t\tif (!result) {\n\t\t\t\terrorCode = 'NoData';\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tcatch (error) {\n\t\t\tlet galleryErrorCode: ExtensionGalleryErrorCode;\n\t\t\tif (isCancellationError(error)) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.Cancelled;\n\t\t\t} else if (isOfflineError(error)) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.Offline;\n\t\t\t} else if (getErrorMessage(error).startsWith('XHR timeout')) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.Timeout;\n\t\t\t} else if (context && isClientError(context)) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.ClientError;\n\t\t\t} else if (context && isServerError(context)) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.ServerError;\n\t\t\t} else {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.Failed;\n\t\t\t}\n\t\t\terrorCode = galleryErrorCode;\n\t\t\tthrow new ExtensionGalleryError(error, galleryErrorCode);\n\t\t}\n\n\t\tfinally {\n\t\t\ttype GalleryServiceGetLatestEventClassification = {\n\t\t\t\towner: 'sandy081';\n\t\t\t\tcomment: 'Report the query to the Marketplace for fetching latest version of an extension';\n\t\t\t\thost: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The host of the end point' };\n\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The identifier of the extension' };\n\t\t\t\tduration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; isMeasurement: true; comment: 'Duration in ms for the query' };\n\t\t\t\terrorCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The error code in case of error' };\n\t\t\t\tstatusCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The status code in case of error' };\n\t\t\t\tserver?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The server of the end point' };\n\t\t\t\tactivityId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The activity ID of the request' };\n\t\t\t\tendToEndId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The end-to-end ID of the request' };\n\t\t\t};\n\t\t\ttype GalleryServiceGetLatestEvent = {\n\t\t\t\textension: string;\n\t\t\t\thost: string;\n\t\t\t\tduration: number;\n\t\t\t\terrorCode?: string;\n\t\t\t\tstatusCode?: string;\n\t\t\t\tserver?: TelemetryTrustedValue<string>;\n\t\t\t\tactivityId?: TelemetryTrustedValue<string>;\n\t\t\t\tendToEndId?: TelemetryTrustedValue<string>;\n\t\t\t};\n\t\t\tthis.telemetryService.publicLog2<GalleryServiceGetLatestEvent, GalleryServiceGetLatestEventClassification>('galleryService:getLatest', {\n\t\t\t\textension,\n\t\t\t\thost: uri.authority,\n\t\t\t\tduration: stopWatch.elapsed(),\n\t\t\t\terrorCode,\n\t\t\t\tstatusCode: context?.res.statusCode && context?.res.statusCode !== 200 ? `${context.res.statusCode}` : undefined,\n\t\t\t\tserver: this.getHeaderValue(context?.res.headers, SERVER_HEADER_NAME),\n\t\t\t\tactivityId: this.getHeaderValue(context?.res.headers, ACTIVITY_HEADER_NAME),\n\t\t\t\tendToEndId: this.getHeaderValue(context?.res.headers, END_END_ID_HEADER_NAME),\n\t\t\t});\n\t\t}\n\t}\n\n\tasync reportStatistic(publisher: string, name: string, version: string, type: StatisticType): Promise<void> {\n\t\tconst manifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\t\tif (!manifest) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tlet url: string;\n\n\t\tif (isWeb) {\n\t\t\tconst resource = getExtensionGalleryManifestResourceUri(manifest, ExtensionGalleryResourceType.WebExtensionStatisticsUri);\n\t\t\tif (!resource) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\turl = format2(resource, { publisher, name, version, statTypeValue: type === StatisticType.Install ? '1' : '3' });\n\t\t} else {\n\t\t\tconst resource = getExtensionGalleryManifestResourceUri(manifest, ExtensionGalleryResourceType.ExtensionStatisticsUri);\n\t\t\tif (!resource) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\turl = format2(resource, { publisher, name, version, statTypeName: type });\n\t\t}\n\n\t\tconst Accept = isWeb ? 'api-version=6.1-preview.1' : '*/*;api-version=4.0-preview.1';\n\t\tconst commonHeaders = await this.commonHeadersPromise;\n\t\tconst headers = { ...commonHeaders, Accept };\n\t\ttry {\n\t\t\tawait this.requestService.request({\n\t\t\t\ttype: 'POST',\n\t\t\t\turl,\n\t\t\t\theaders\n\t\t\t}, CancellationToken.None);\n\t\t} catch (error) { /* Ignore */ }\n\t}\n\n\tasync download(extension: IGalleryExtension, location: URI, operation: InstallOperation): Promise<void> {\n\t\tthis.logService.trace('ExtensionGalleryService#download', extension.identifier.id);\n\t\tconst data = getGalleryExtensionTelemetryData(extension);\n\t\tconst startTime = new Date().getTime();\n\n\t\tconst operationParam = operation === InstallOperation.Install ? 'install' : operation === InstallOperation.Update ? 'update' : '';\n\t\tconst downloadAsset = operationParam ? {\n\t\t\turi: `${extension.assets.download.uri}${URI.parse(extension.assets.download.uri).query ? '&' : '?'}${operationParam}=true`,\n\t\t\tfallbackUri: `${extension.assets.download.fallbackUri}${URI.parse(extension.assets.download.fallbackUri).query ? '&' : '?'}${operationParam}=true`\n\t\t} : extension.assets.download;\n\n\t\tconst activityId = extension.queryContext?.[SEARCH_ACTIVITY_HEADER_NAME];\n\t\tconst headers: IHeaders | undefined = activityId && typeof activityId === 'string' ? { [SEARCH_ACTIVITY_HEADER_NAME]: activityId } : undefined;\n\t\tconst context = await this.getAsset(extension.identifier.id, downloadAsset, AssetType.VSIX, extension.version, headers ? { headers } : undefined);\n\n\t\ttry {\n\t\t\tawait this.fileService.writeFile(location, context.stream);\n\t\t} catch (error) {\n\t\t\ttry {\n\t\t\t\tawait this.fileService.del(location);\n\t\t\t} catch (e) {\n\t\t\t\t/* ignore */\n\t\t\t\tthis.logService.warn(`Error while deleting the file ${location.toString()}`, getErrorMessage(e));\n\t\t\t}\n\t\t\tthrow new ExtensionGalleryError(getErrorMessage(error), ExtensionGalleryErrorCode.DownloadFailedWriting);\n\t\t}\n\n\t\t/* __GDPR__\n\t\t\t\"galleryService:downloadVSIX\" : {\n\t\t\t\t\"owner\": \"sandy081\",\n\t\t\t\t\"duration\": { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true },\n\t\t\t\t\"${include}\": [\n\t\t\t\t\t\"${GalleryExtensionTelemetryData}\"\n\t\t\t\t]\n\t\t\t}\n\t\t*/\n\t\tthis.telemetryService.publicLog('galleryService:downloadVSIX', { ...data, duration: new Date().getTime() - startTime });\n\t}\n\n\tasync downloadSignatureArchive(extension: IGalleryExtension, location: URI): Promise<void> {\n\t\tif (!extension.assets.signature) {\n\t\t\tthrow new Error('No signature asset found');\n\t\t}\n\n\t\tthis.logService.trace('ExtensionGalleryService#downloadSignatureArchive', extension.identifier.id);\n\n\t\tconst context = await this.getAsset(extension.identifier.id, extension.assets.signature, AssetType.Signature, extension.version);\n\t\ttry {\n\t\t\tawait this.fileService.writeFile(location, context.stream);\n\t\t} catch (error) {\n\t\t\ttry {\n\t\t\t\tawait this.fileService.del(location);\n\t\t\t} catch (e) {\n\t\t\t\t/* ignore */\n\t\t\t\tthis.logService.warn(`Error while deleting the file ${location.toString()}`, getErrorMessage(e));\n\t\t\t}\n\t\t\tthrow new ExtensionGalleryError(getErrorMessage(error), ExtensionGalleryErrorCode.DownloadFailedWriting);\n\t\t}\n\n\t}\n\n\tasync getReadme(extension: IGalleryExtension, token: CancellationToken): Promise<string> {\n\t\tif (extension.assets.readme) {\n\t\t\tconst context = await this.getAsset(extension.identifier.id, extension.assets.readme, AssetType.Details, extension.version, {}, token);\n\t\t\tconst content = await asTextOrError(context);\n\t\t\treturn content || '';\n\t\t}\n\t\treturn '';\n\t}\n\n\tasync getManifest(extension: IGalleryExtension, token: CancellationToken): Promise<IExtensionManifest | null> {\n\t\tif (extension.assets.manifest) {\n\t\t\tconst context = await this.getAsset(extension.identifier.id, extension.assets.manifest, AssetType.Manifest, extension.version, {}, token);\n\t\t\tconst text = await asTextOrError(context);\n\t\t\treturn text ? JSON.parse(text) : null;\n\t\t}\n\t\treturn null;\n\t}\n\n\tasync getCoreTranslation(extension: IGalleryExtension, languageId: string): Promise<ITranslation | null> {\n\t\tconst asset = extension.assets.coreTranslations.filter(t => t[0] === languageId.toUpperCase())[0];\n\t\tif (asset) {\n\t\t\tconst context = await this.getAsset(extension.identifier.id, asset[1], asset[0], extension.version);\n\t\t\tconst text = await asTextOrError(context);\n\t\t\treturn text ? JSON.parse(text) : null;\n\t\t}\n\t\treturn null;\n\t}\n\n\tasync getChangelog(extension: IGalleryExtension, token: CancellationToken): Promise<string> {\n\t\tif (extension.assets.changelog) {\n\t\t\tconst context = await this.getAsset(extension.identifier.id, extension.assets.changelog, AssetType.Changelog, extension.version, {}, token);\n\t\t\tconst content = await asTextOrError(context);\n\t\t\treturn content || '';\n\t\t}\n\t\treturn '';\n\t}\n\n\tasync getAllVersions(extensionIdentifier: IExtensionIdentifier): Promise<IGalleryExtensionVersion[]> {\n\t\treturn this.getVersions(extensionIdentifier);\n\t}\n\n\tasync getAllCompatibleVersions(extensionIdentifier: IExtensionIdentifier, includePreRelease: boolean, targetPlatform: TargetPlatform): Promise<IGalleryExtensionVersion[]> {\n\t\treturn this.getVersions(extensionIdentifier, { version: includePreRelease ? VersionKind.Latest : VersionKind.Release, targetPlatform });\n\t}\n\n\tprivate async getVersions(extensionIdentifier: IExtensionIdentifier, onlyCompatible?: { version: VersionKind; targetPlatform: TargetPlatform }): Promise<IGalleryExtensionVersion[]> {\n\t\tconst extensionGalleryManifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\t\tif (!extensionGalleryManifest) {\n\t\t\tthrow new Error('No extension gallery service configured.');\n\t\t}\n\n\t\tlet query = new Query()\n\t\t\t.withFlags(Flag.IncludeVersions, Flag.IncludeCategoryAndTags, Flag.IncludeFiles, Flag.IncludeVersionProperties)\n\t\t\t.withPage(1, 1);\n\n\t\tif (extensionIdentifier.uuid) {\n\t\t\tquery = query.withFilter(FilterType.ExtensionId, extensionIdentifier.uuid);\n\t\t} else {\n\t\t\tquery = query.withFilter(FilterType.ExtensionName, extensionIdentifier.id);\n\t\t}\n\n\t\tconst { galleryExtensions } = await this.queryRawGalleryExtensions(query, extensionGalleryManifest, CancellationToken.None);\n\t\tif (!galleryExtensions.length) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst allTargetPlatforms = getAllTargetPlatforms(galleryExtensions[0]);\n\t\tif (onlyCompatible && isNotWebExtensionInWebTargetPlatform(allTargetPlatforms, onlyCompatible.targetPlatform)) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst versions: IRawGalleryExtensionVersion[] = [];\n\t\tconst productVersion = { version: this.productService.version, date: this.productService.date };\n\t\tawait Promise.all(galleryExtensions[0].versions.map(async (version) => {\n\t\t\ttry {\n\t\t\t\tif (\n\t\t\t\t\t(await this.isValidVersion(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: extensionIdentifier.id,\n\t\t\t\t\t\t\tversion: version.version,\n\t\t\t\t\t\t\tisPreReleaseVersion: isPreReleaseVersion(version),\n\t\t\t\t\t\t\ttargetPlatform: getTargetPlatformForExtensionVersion(version),\n\t\t\t\t\t\t\tengine: getEngine(version),\n\t\t\t\t\t\t\tmanifestAsset: getVersionAsset(version, AssetType.Manifest),\n\t\t\t\t\t\t\tenabledApiProposals: getEnabledApiProposals(version)\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcompatible: !!onlyCompatible,\n\t\t\t\t\t\t\tproductVersion,\n\t\t\t\t\t\t\ttargetPlatform: onlyCompatible?.targetPlatform,\n\t\t\t\t\t\t\tversion: onlyCompatible?.version ?? version.version\n\t\t\t\t\t\t},\n\t\t\t\t\t\tgalleryExtensions[0].publisher.displayName,\n\t\t\t\t\t\tallTargetPlatforms))\n\t\t\t\t) {\n\t\t\t\t\tversions.push(version);\n\t\t\t\t}\n\t\t\t} catch (error) { /* Ignore error and skip version */ }\n\t\t}));\n\n\t\tconst result: IGalleryExtensionVersion[] = [];\n\t\tconst seen = new Map<string, number>();\n\t\tfor (const version of sortExtensionVersions(versions, onlyCompatible?.targetPlatform ?? CURRENT_TARGET_PLATFORM)) {\n\t\t\tconst index = seen.get(version.version);\n\t\t\tconst existing = index !== undefined ? result[index] : undefined;\n\t\t\tconst targetPlatform = getTargetPlatformForExtensionVersion(version);\n\t\t\tif (!existing) {\n\t\t\t\tseen.set(version.version, result.length);\n\t\t\t\tresult.push({ version: version.version, date: version.lastUpdated, isPreReleaseVersion: isPreReleaseVersion(version), targetPlatforms: [targetPlatform] });\n\t\t\t} else {\n\t\t\t\texisting.targetPlatforms.push(targetPlatform);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprivate async getAsset(extension: string, asset: IGalleryExtensionAsset, assetType: string, extensionVersion: string, options: IRequestOptions = {}, token: CancellationToken = CancellationToken.None): Promise<IRequestContext> {\n\t\tconst commonHeaders = await this.commonHeadersPromise;\n\t\tconst baseOptions = { type: 'GET' };\n\t\tconst headers = { ...commonHeaders, ...(options.headers || {}) };\n\t\toptions = { ...options, ...baseOptions, headers };\n\n\t\tconst url = asset.uri;\n\t\tconst fallbackUrl = asset.fallbackUri;\n\t\tconst firstOptions = { ...options, url, timeout: this.getRequestTimeout() };\n\n\t\tlet context;\n\t\ttry {\n\t\t\tcontext = await this.requestService.request(firstOptions, token);\n\t\t\tif (context.res.statusCode === 200) {\n\t\t\t\treturn context;\n\t\t\t}\n\t\t\tconst message = await asTextOrError(context);\n\t\t\tthrow new Error(`Expected 200, got back ${context.res.statusCode} instead.\\n\\n${message}`);\n\t\t} catch (err) {\n\t\t\tif (isCancellationError(err)) {\n\t\t\t\tthrow err;\n\t\t\t}\n\n\t\t\tconst message = getErrorMessage(err);\n\t\t\ttype GalleryServiceCDNFallbackClassification = {\n\t\t\t\towner: 'sandy081';\n\t\t\t\tcomment: 'Fallback request information when the primary asset request to CDN fails';\n\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'extension name' };\n\t\t\t\tassetType: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'asset that failed' };\n\t\t\t\tmessage: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'error message' };\n\t\t\t\textensionVersion: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'version' };\n\t\t\t\treadonly server?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'server that handled the query' };\n\t\t\t\treadonly endToEndId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'end to end operation id' };\n\t\t\t\treadonly activityId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'activity id' };\n\t\t\t};\n\t\t\ttype GalleryServiceCDNFallbackEvent = {\n\t\t\t\textension: string;\n\t\t\t\tassetType: string;\n\t\t\t\tmessage: string;\n\t\t\t\textensionVersion: string;\n\t\t\t\tserver?: TelemetryTrustedValue<string>;\n\t\t\t\tendToEndId?: TelemetryTrustedValue<string>;\n\t\t\t\tactivityId?: TelemetryTrustedValue<string>;\n\t\t\t};\n\t\t\tthis.telemetryService.publicLog2<GalleryServiceCDNFallbackEvent, GalleryServiceCDNFallbackClassification>('galleryService:cdnFallback', {\n\t\t\t\textension,\n\t\t\t\tassetType,\n\t\t\t\tmessage,\n\t\t\t\textensionVersion,\n\t\t\t\tserver: this.getHeaderValue(context?.res.headers, SERVER_HEADER_NAME),\n\t\t\t\tactivityId: this.getHeaderValue(context?.res.headers, ACTIVITY_HEADER_NAME),\n\t\t\t\tendToEndId: this.getHeaderValue(context?.res.headers, END_END_ID_HEADER_NAME),\n\t\t\t});\n\n\t\t\tconst fallbackOptions = { ...options, url: fallbackUrl, timeout: this.getRequestTimeout() };\n\t\t\treturn this.requestService.request(fallbackOptions, token);\n\t\t}\n\t}\n\n\tasync getExtensionsControlManifest(): Promise<IExtensionsControlManifest> {\n\t\tconst manifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\t\tif (!manifest) {\n\t\t\tthrow new Error('No extension gallery service configured.');\n\t\t}\n\n\n\t\tif (!this.extensionsControlUrl) {\n\t\t\treturn { malicious: [], deprecated: {}, search: [], autoUpdate: {} };\n\t\t}\n\n\t\tconst context = await this.requestService.request({\n\t\t\ttype: 'GET',\n\t\t\turl: this.extensionsControlUrl,\n\t\t\ttimeout: this.getRequestTimeout()\n\t\t}, CancellationToken.None);\n\n\t\tif (context.res.statusCode !== 200) {\n\t\t\tthrow new Error('Could not get extensions report.');\n\t\t}\n\n\t\tconst result = await asJson<IRawExtensionsControlManifest>(context);\n\t\tconst malicious: Array<MaliciousExtensionInfo> = [];\n\t\tconst deprecated: IStringDictionary<IDeprecationInfo> = {};\n\t\tconst search: ISearchPrefferedResults[] = [];\n\t\tconst autoUpdate: IStringDictionary<string> = result?.autoUpdate ?? {};\n\t\tif (result) {\n\t\t\tfor (const id of result.malicious) {\n\t\t\t\tif (!isString(id)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst publisherOrExtension = EXTENSION_IDENTIFIER_REGEX.test(id) ? { id } : id;\n\t\t\t\tmalicious.push({ extensionOrPublisher: publisherOrExtension, learnMoreLink: result.learnMoreLinks?.[id] });\n\t\t\t}\n\t\t\tif (result.migrateToPreRelease) {\n\t\t\t\tfor (const [unsupportedPreReleaseExtensionId, preReleaseExtensionInfo] of Object.entries(result.migrateToPreRelease)) {\n\t\t\t\t\tif (!preReleaseExtensionInfo.engine || isEngineValid(preReleaseExtensionInfo.engine, this.productService.version, this.productService.date)) {\n\t\t\t\t\t\tdeprecated[unsupportedPreReleaseExtensionId.toLowerCase()] = {\n\t\t\t\t\t\t\tdisallowInstall: true,\n\t\t\t\t\t\t\textension: {\n\t\t\t\t\t\t\t\tid: preReleaseExtensionInfo.id,\n\t\t\t\t\t\t\t\tdisplayName: preReleaseExtensionInfo.displayName,\n\t\t\t\t\t\t\t\tautoMigrate: { storage: !!preReleaseExtensionInfo.migrateStorage },\n\t\t\t\t\t\t\t\tpreRelease: true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (result.deprecated) {\n\t\t\t\tfor (const [deprecatedExtensionId, deprecationInfo] of Object.entries(result.deprecated)) {\n\t\t\t\t\tif (deprecationInfo) {\n\t\t\t\t\t\tdeprecated[deprecatedExtensionId.toLowerCase()] = isBoolean(deprecationInfo) ? {} : deprecationInfo;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (result.search) {\n\t\t\t\tfor (const s of result.search) {\n\t\t\t\t\tsearch.push(s);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn { malicious, deprecated, search, autoUpdate };\n\t}\n\n\tprivate getRequestTimeout(): number {\n\t\tconst configuredTimeout = this.configurationService.getValue<number>(ExtensionRequestsTimeoutConfigKey);\n\t\treturn isNumber(configuredTimeout) && configuredTimeout >= 0 ? configuredTimeout : 60_000;\n\t}\n\n}\n\nexport class ExtensionGalleryService extends AbstractExtensionGalleryService {\n\n\tconstructor(\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IRequestService requestService: IRequestService,\n\t\t@ILogService logService: ILogService,\n\t\t@IEnvironmentService environmentService: IEnvironmentService,\n\t\t@ITelemetryService telemetryService: ITelemetryService,\n\t\t@IFileService fileService: IFileService,\n\t\t@IProductService productService: IProductService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@IAllowedExtensionsService allowedExtensionsService: IAllowedExtensionsService,\n\t\t@IExtensionGalleryManifestService extensionGalleryManifestService: IExtensionGalleryManifestService,\n\t) {\n\t\tsuper(storageService, requestService, logService, environmentService, telemetryService, fileService, productService, configurationService, allowedExtensionsService, extensionGalleryManifestService);\n\t}\n}\n\nexport class ExtensionGalleryServiceWithNoStorageService extends AbstractExtensionGalleryService {\n\n\tconstructor(\n\t\t@IRequestService requestService: IRequestService,\n\t\t@ILogService logService: ILogService,\n\t\t@IEnvironmentService environmentService: IEnvironmentService,\n\t\t@ITelemetryService telemetryService: ITelemetryService,\n\t\t@IFileService fileService: IFileService,\n\t\t@IProductService productService: IProductService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@IAllowedExtensionsService allowedExtensionsService: IAllowedExtensionsService,\n\t\t@IExtensionGalleryManifestService extensionGalleryManifestService: IExtensionGalleryManifestService,\n\t) {\n\t\tsuper(undefined, requestService, logService, environmentService, telemetryService, fileService, productService, configurationService, allowedExtensionsService, extensionGalleryManifestService);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { distinct } from '../../../base/common/arrays.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport * as semver from '../../../base/common/semver/semver.js';\nimport { IStringDictionary } from '../../../base/common/collections.js';\nimport { CancellationError, getErrorMessage, isCancellationError } from '../../../base/common/errors.js';\nimport { IPager } from '../../../base/common/paging.js';\nimport { isWeb, platform } from '../../../base/common/platform.js';\nimport { arch } from '../../../base/common/process.js';\nimport { isBoolean, isNumber, isString } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { IHeaders, IRequestContext, IRequestOptions, isOfflineError } from '../../../base/parts/request/common/request.js';\nimport { IConfigurationService } from '../../configuration/common/configuration.js';\nimport { IEnvironmentService } from '../../environment/common/environment.js';\nimport { getTargetPlatform, IExtensionGalleryService, IExtensionIdentifier, IExtensionInfo, IGalleryExtension, IGalleryExtensionAsset, IGalleryExtensionAssets, IGalleryExtensionVersion, InstallOperation, IQueryOptions, IExtensionsControlManifest, isNotWebExtensionInWebTargetPlatform, isTargetPlatformCompatible, ITranslation, SortOrder, StatisticType, toTargetPlatform, WEB_EXTENSION_TAG, IExtensionQueryOptions, IDeprecationInfo, ISearchPrefferedResults, ExtensionGalleryError, ExtensionGalleryErrorCode, IProductVersion, IAllowedExtensionsService, EXTENSION_IDENTIFIER_REGEX, SortBy, FilterType, MaliciousExtensionInfo, ExtensionRequestsTimeoutConfigKey } from './extensionManagement.js';\nimport { adoptToGalleryExtensionId, areSameExtensions, getGalleryExtensionId, getGalleryExtensionTelemetryData } from './extensionManagementUtil.js';\nimport { IExtensionManifest, TargetPlatform } from '../../extensions/common/extensions.js';\nimport { areApiProposalsCompatible, isEngineValid } from '../../extensions/common/extensionValidator.js';\nimport { IFileService } from '../../files/common/files.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IProductService } from '../../product/common/productService.js';\nimport { asJson, asTextOrError, IRequestService, isClientError, isServerError, isSuccess } from '../../request/common/request.js';\nimport { resolveMarketplaceHeaders } from '../../externalServices/common/marketplace.js';\nimport { IStorageService } from '../../storage/common/storage.js';\nimport { ITelemetryService } from '../../telemetry/common/telemetry.js';\nimport { StopWatch } from '../../../base/common/stopwatch.js';\nimport { format2 } from '../../../base/common/strings.js';\nimport { ExtensionGalleryResourceType, Flag, getExtensionGalleryManifestResourceUri, IExtensionGalleryManifest, IExtensionGalleryManifestService, ExtensionGalleryManifestStatus } from './extensionGalleryManifest.js';\nimport { TelemetryTrustedValue } from '../../telemetry/common/telemetryUtils.js';\n\nconst CURRENT_TARGET_PLATFORM = isWeb ? TargetPlatform.WEB : getTargetPlatform(platform, arch);\nconst SEARCH_ACTIVITY_HEADER_NAME = 'X-Market-Search-Activity-Id';\nconst ACTIVITY_HEADER_NAME = 'Activityid';\nconst SERVER_HEADER_NAME = 'Server';\nconst END_END_ID_HEADER_NAME = 'X-Vss-E2eid';\n\ninterface IRawGalleryExtensionFile {\n\treadonly assetType: string;\n\treadonly source: string;\n}\n\ninterface IRawGalleryExtensionProperty {\n\treadonly key: string;\n\treadonly value: string;\n}\n\nexport interface IRawGalleryExtensionVersion {\n\treadonly version: string;\n\treadonly lastUpdated: string;\n\treadonly assetUri: string;\n\treadonly fallbackAssetUri: string;\n\treadonly files: IRawGalleryExtensionFile[];\n\treadonly properties?: IRawGalleryExtensionProperty[];\n\treadonly targetPlatform?: string;\n}\n\ninterface IRawGalleryExtensionStatistics {\n\treadonly statisticName: string;\n\treadonly value: number;\n}\n\ninterface IRawGalleryExtensionPublisher {\n\treadonly displayName: string;\n\treadonly publisherId: string;\n\treadonly publisherName: string;\n\treadonly domain?: string | null;\n\treadonly isDomainVerified?: boolean;\n\treadonly linkType?: string;\n}\n\ninterface IRawGalleryExtension {\n\treadonly extensionId: string;\n\treadonly extensionName: string;\n\treadonly displayName: string;\n\treadonly shortDescription?: string;\n\treadonly publisher: IRawGalleryExtensionPublisher;\n\treadonly versions: IRawGalleryExtensionVersion[];\n\treadonly statistics: IRawGalleryExtensionStatistics[];\n\treadonly tags: string[] | undefined;\n\treadonly releaseDate: string;\n\treadonly publishedDate: string;\n\treadonly lastUpdated: string;\n\treadonly categories: string[] | undefined;\n\treadonly flags: string;\n\treadonly linkType?: string;\n\treadonly ratingLinkType?: string;\n}\n\ninterface IRawGalleryExtensionsResult {\n\treadonly galleryExtensions: IRawGalleryExtension[];\n\treadonly total: number;\n\treadonly context?: IStringDictionary<string>;\n}\n\ninterface IRawGalleryQueryResult {\n\treadonly results: {\n\t\treadonly extensions: IRawGalleryExtension[];\n\t\treadonly resultMetadata: {\n\t\t\treadonly metadataType: string;\n\t\t\treadonly metadataItems: {\n\t\t\t\treadonly name: string;\n\t\t\t\treadonly count: number;\n\t\t\t}[];\n\t\t}[];\n\t}[];\n}\n\nconst AssetType = {\n\tIcon: 'Microsoft.VisualStudio.Services.Icons.Default',\n\tDetails: 'Microsoft.VisualStudio.Services.Content.Details',\n\tChangelog: 'Microsoft.VisualStudio.Services.Content.Changelog',\n\tManifest: 'Microsoft.VisualStudio.Code.Manifest',\n\tVSIX: 'Microsoft.VisualStudio.Services.VSIXPackage',\n\tLicense: 'Microsoft.VisualStudio.Services.Content.License',\n\tRepository: 'Microsoft.VisualStudio.Services.Links.Source',\n\tSignature: 'Microsoft.VisualStudio.Services.VsixSignature'\n};\n\nconst PropertyType = {\n\tDependency: 'Microsoft.VisualStudio.Code.ExtensionDependencies',\n\tExtensionPack: 'Microsoft.VisualStudio.Code.ExtensionPack',\n\tEngine: 'Microsoft.VisualStudio.Code.Engine',\n\tPreRelease: 'Microsoft.VisualStudio.Code.PreRelease',\n\tEnabledApiProposals: 'Microsoft.VisualStudio.Code.EnabledApiProposals',\n\tLocalizedLanguages: 'Microsoft.VisualStudio.Code.LocalizedLanguages',\n\tWebExtension: 'Microsoft.VisualStudio.Code.WebExtension',\n\tSponsorLink: 'Microsoft.VisualStudio.Code.SponsorLink',\n\tSupportLink: 'Microsoft.VisualStudio.Services.Links.Support',\n\tExecutesCode: 'Microsoft.VisualStudio.Code.ExecutesCode',\n\tPrivate: 'PrivateMarketplace',\n};\n\ninterface ICriterium {\n\treadonly filterType: FilterType;\n\treadonly value?: string;\n}\n\nconst DefaultPageSize = 10;\n\ninterface IQueryState {\n\treadonly pageNumber: number;\n\treadonly pageSize: number;\n\treadonly sortBy: SortBy;\n\treadonly sortOrder: SortOrder;\n\treadonly flags: Flag[];\n\treadonly criteria: ICriterium[];\n\treadonly assetTypes: string[];\n\treadonly source?: string;\n}\n\nconst DefaultQueryState: IQueryState = {\n\tpageNumber: 1,\n\tpageSize: DefaultPageSize,\n\tsortBy: SortBy.NoneOrRelevance,\n\tsortOrder: SortOrder.Default,\n\tflags: [],\n\tcriteria: [],\n\tassetTypes: []\n};\n\ntype GalleryServiceQueryClassification = {\n\towner: 'sandy081';\n\tcomment: 'Information about Marketplace query and its response';\n\treadonly filterTypes: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Filter types used in the query.' };\n\treadonly flags: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Flags passed in the query.' };\n\treadonly sortBy: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'sorted by option passed in the query' };\n\treadonly sortOrder: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'sort order option passed in the query' };\n\treadonly pageNumber: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'requested page number in the query' };\n\treadonly duration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; 'isMeasurement': true; comment: 'amount of time taken by the query request' };\n\treadonly success: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'whether the query request is success or not' };\n\treadonly requestBodySize: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'size of the request body' };\n\treadonly responseBodySize?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'size of the response body' };\n\treadonly statusCode?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'status code of the response' };\n\treadonly errorCode?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'error code of the response' };\n\treadonly count?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'total number of extensions matching the query' };\n\treadonly source?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'source that requested this query, eg., recommendations, viewlet' };\n\treadonly searchTextLength?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'length of the search text in the query' };\n\treadonly server?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'server that handled the query' };\n\treadonly endToEndId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'end to end operation id' };\n\treadonly activityId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'activity id' };\n};\n\ntype QueryTelemetryData = {\n\treadonly filterTypes: string[];\n\treadonly flags: string[];\n\treadonly sortBy: string;\n\treadonly sortOrder: string;\n\treadonly pageNumber: string;\n\treadonly source?: string;\n\treadonly searchTextLength?: number;\n};\n\ntype GalleryServiceQueryEvent = QueryTelemetryData & {\n\treadonly duration: number;\n\treadonly success: boolean;\n\treadonly requestBodySize: string;\n\treadonly responseBodySize?: string;\n\treadonly statusCode?: string;\n\treadonly errorCode?: string;\n\treadonly count?: string;\n\treadonly server?: TelemetryTrustedValue<string>;\n\treadonly endToEndId?: TelemetryTrustedValue<string>;\n\treadonly activityId?: TelemetryTrustedValue<string>;\n};\n\ntype GalleryServiceAdditionalQueryClassification = {\n\towner: 'sandy081';\n\tcomment: 'Response information about the additional query to the Marketplace for fetching all versions to get release version';\n\treadonly duration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; 'isMeasurement': true; comment: 'Amount of time taken by the additional query' };\n\treadonly count: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Total number of extensions returned by this additional query' };\n};\n\ntype GalleryServiceAdditionalQueryEvent = {\n\treadonly duration: number;\n\treadonly count: number;\n};\n\ntype ExtensionsCriteria = {\n\treadonly productVersion: IProductVersion;\n\treadonly targetPlatform: TargetPlatform;\n\treadonly compatible: boolean;\n\treadonly includePreRelease: boolean | (IExtensionIdentifier & { includePreRelease: boolean })[];\n\treadonly versions?: (IExtensionIdentifier & { version: string })[];\n\treadonly isQueryForReleaseVersionFromPreReleaseVersion?: boolean;\n};\n\nconst enum VersionKind {\n\tRelease,\n\tPrerelease,\n\tLatest\n}\n\ntype ExtensionVersionCriteria = {\n\treadonly productVersion: IProductVersion;\n\treadonly targetPlatform: TargetPlatform;\n\treadonly compatible: boolean;\n\treadonly version: VersionKind | string;\n};\n\nclass Query {\n\n\tconstructor(private state = DefaultQueryState) { }\n\n\tget pageNumber(): number { return this.state.pageNumber; }\n\tget pageSize(): number { return this.state.pageSize; }\n\tget sortBy(): SortBy { return this.state.sortBy; }\n\tget sortOrder(): number { return this.state.sortOrder; }\n\tget flags(): Flag[] { return this.state.flags; }\n\tget criteria(): ICriterium[] { return this.state.criteria; }\n\tget assetTypes(): string[] { return this.state.assetTypes; }\n\tget source(): string | undefined { return this.state.source; }\n\tget searchText(): string {\n\t\tconst criterium = this.state.criteria.filter(criterium => criterium.filterType === FilterType.SearchText)[0];\n\t\treturn criterium && criterium.value ? criterium.value : '';\n\t}\n\n\n\twithPage(pageNumber: number, pageSize: number = this.state.pageSize): Query {\n\t\treturn new Query({ ...this.state, pageNumber, pageSize });\n\t}\n\n\twithFilter(filterType: FilterType, ...values: string[]): Query {\n\t\tconst criteria = [\n\t\t\t...this.state.criteria,\n\t\t\t...values.length ? values.map(value => ({ filterType, value })) : [{ filterType }]\n\t\t];\n\n\t\treturn new Query({ ...this.state, criteria });\n\t}\n\n\twithSortBy(sortBy: SortBy): Query {\n\t\treturn new Query({ ...this.state, sortBy });\n\t}\n\n\twithSortOrder(sortOrder: SortOrder): Query {\n\t\treturn new Query({ ...this.state, sortOrder });\n\t}\n\n\twithFlags(...flags: Flag[]): Query {\n\t\treturn new Query({ ...this.state, flags: distinct(flags) });\n\t}\n\n\twithAssetTypes(...assetTypes: string[]): Query {\n\t\treturn new Query({ ...this.state, assetTypes });\n\t}\n\n\twithSource(source: string): Query {\n\t\treturn new Query({ ...this.state, source });\n\t}\n}\n\nfunction getStatistic(statistics: IRawGalleryExtensionStatistics[], name: string): number {\n\tconst result = (statistics || []).filter(s => s.statisticName === name)[0];\n\treturn result ? result.value : 0;\n}\n\nfunction getCoreTranslationAssets(version: IRawGalleryExtensionVersion): [string, IGalleryExtensionAsset][] {\n\tconst coreTranslationAssetPrefix = 'Microsoft.VisualStudio.Code.Translation.';\n\tconst result = version.files.filter(f => f.assetType.indexOf(coreTranslationAssetPrefix) === 0);\n\treturn result.reduce<[string, IGalleryExtensionAsset][]>((result, file) => {\n\t\tconst asset = getVersionAsset(version, file.assetType);\n\t\tif (asset) {\n\t\t\tresult.push([file.assetType.substring(coreTranslationAssetPrefix.length), asset]);\n\t\t}\n\t\treturn result;\n\t}, []);\n}\n\nfunction getRepositoryAsset(version: IRawGalleryExtensionVersion): IGalleryExtensionAsset | null {\n\tif (version.properties) {\n\t\tconst results = version.properties.filter(p => p.key === AssetType.Repository);\n\t\tconst gitRegExp = new RegExp('((git|ssh|http(s)?)|(git@[\\\\w.]+))(:(//)?)([\\\\w.@:/\\\\-~]+)(.git)(/)?');\n\n\t\tconst uri = results.filter(r => gitRegExp.test(r.value))[0];\n\t\treturn uri ? { uri: uri.value, fallbackUri: uri.value } : null;\n\t}\n\treturn getVersionAsset(version, AssetType.Repository);\n}\n\nfunction getDownloadAsset(version: IRawGalleryExtensionVersion): IGalleryExtensionAsset {\n\treturn {\n\t\t// always use fallbackAssetUri for download asset to hit the Marketplace API so that downloads are counted\n\t\turi: `${version.fallbackAssetUri}/${AssetType.VSIX}?redirect=true${version.targetPlatform ? `&targetPlatform=${version.targetPlatform}` : ''}`,\n\t\tfallbackUri: `${version.fallbackAssetUri}/${AssetType.VSIX}${version.targetPlatform ? `?targetPlatform=${version.targetPlatform}` : ''}`\n\t};\n}\n\nfunction getVersionAsset(version: IRawGalleryExtensionVersion, type: string): IGalleryExtensionAsset | null {\n\tconst result = version.files.filter(f => f.assetType === type)[0];\n\treturn result ? {\n\t\turi: `${version.assetUri}/${type}${version.targetPlatform ? `?targetPlatform=${version.targetPlatform}` : ''}`,\n\t\tfallbackUri: `${version.fallbackAssetUri}/${type}${version.targetPlatform ? `?targetPlatform=${version.targetPlatform}` : ''}`\n\t} : null;\n}\n\nfunction getExtensions(version: IRawGalleryExtensionVersion, property: string): string[] {\n\tconst values = version.properties ? version.properties.filter(p => p.key === property) : [];\n\tconst value = values.length > 0 && values[0].value;\n\treturn value ? value.split(',').map(v => adoptToGalleryExtensionId(v)) : [];\n}\n\nfunction getEngine(version: IRawGalleryExtensionVersion): string {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.Engine) : [];\n\treturn (values.length > 0 && values[0].value) || '';\n}\n\nfunction isPreReleaseVersion(version: IRawGalleryExtensionVersion): boolean {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.PreRelease) : [];\n\treturn values.length > 0 && values[0].value === 'true';\n}\n\nfunction hasPreReleaseForExtension(id: string, productService: IProductService): boolean | undefined {\n\treturn productService.extensionProperties?.[id.toLowerCase()]?.hasPrereleaseVersion;\n}\n\nfunction getExcludeVersionRangeForExtension(id: string, productService: IProductService): string | undefined {\n\treturn productService.extensionProperties?.[id.toLowerCase()]?.excludeVersionRange;\n}\n\nfunction isPrivateExtension(version: IRawGalleryExtensionVersion): boolean {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.Private) : [];\n\treturn values.length > 0 && values[0].value === 'true';\n}\n\nfunction executesCode(version: IRawGalleryExtensionVersion): boolean | undefined {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.ExecutesCode) : [];\n\treturn values.length > 0 ? values[0].value === 'true' : undefined;\n}\n\nfunction getEnabledApiProposals(version: IRawGalleryExtensionVersion): string[] {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.EnabledApiProposals) : [];\n\tconst value = (values.length > 0 && values[0].value) || '';\n\treturn value ? value.split(',') : [];\n}\n\nfunction getLocalizedLanguages(version: IRawGalleryExtensionVersion): string[] {\n\tconst values = version.properties ? version.properties.filter(p => p.key === PropertyType.LocalizedLanguages) : [];\n\tconst value = (values.length > 0 && values[0].value) || '';\n\treturn value ? value.split(',') : [];\n}\n\nfunction getSponsorLink(version: IRawGalleryExtensionVersion): string | undefined {\n\treturn version.properties?.find(p => p.key === PropertyType.SponsorLink)?.value;\n}\n\nfunction getSupportLink(version: IRawGalleryExtensionVersion): string | undefined {\n\treturn version.properties?.find(p => p.key === PropertyType.SupportLink)?.value;\n}\n\nfunction getIsPreview(flags: string): boolean {\n\treturn flags.indexOf('preview') !== -1;\n}\n\nfunction getTargetPlatformForExtensionVersion(version: IRawGalleryExtensionVersion): TargetPlatform {\n\treturn version.targetPlatform ? toTargetPlatform(version.targetPlatform) : TargetPlatform.UNDEFINED;\n}\n\nfunction getAllTargetPlatforms(rawGalleryExtension: IRawGalleryExtension): TargetPlatform[] {\n\tconst allTargetPlatforms = distinct(rawGalleryExtension.versions.map(getTargetPlatformForExtensionVersion));\n\n\t// Is a web extension only if it has WEB_EXTENSION_TAG\n\tconst isWebExtension = !!rawGalleryExtension.tags?.includes(WEB_EXTENSION_TAG);\n\n\t// Include Web Target Platform only if it is a web extension\n\tconst webTargetPlatformIndex = allTargetPlatforms.indexOf(TargetPlatform.WEB);\n\tif (isWebExtension) {\n\t\tif (webTargetPlatformIndex === -1) {\n\t\t\t// Web extension but does not has web target platform -> add it\n\t\t\tallTargetPlatforms.push(TargetPlatform.WEB);\n\t\t}\n\t} else {\n\t\tif (webTargetPlatformIndex !== -1) {\n\t\t\t// Not a web extension but has web target platform -> remove it\n\t\t\tallTargetPlatforms.splice(webTargetPlatformIndex, 1);\n\t\t}\n\t}\n\n\treturn allTargetPlatforms;\n}\n\nexport function sortExtensionVersions(versions: IRawGalleryExtensionVersion[], preferredTargetPlatform: TargetPlatform): IRawGalleryExtensionVersion[] {\n\t/* It is expected that versions from Marketplace are sorted by version. So we are just sorting by preferred targetPlatform */\n\tfor (let index = 0; index < versions.length; index++) {\n\t\tconst version = versions[index];\n\t\tif (version.version === versions[index - 1]?.version) {\n\t\t\tlet insertionIndex = index;\n\t\t\tconst versionTargetPlatform = getTargetPlatformForExtensionVersion(version);\n\t\t\t/* put it at the beginning */\n\t\t\tif (versionTargetPlatform === preferredTargetPlatform) {\n\t\t\t\twhile (insertionIndex > 0 && versions[insertionIndex - 1].version === version.version) { insertionIndex--; }\n\t\t\t}\n\t\t\tif (insertionIndex !== index) {\n\t\t\t\tversions.splice(index, 1);\n\t\t\t\tversions.splice(insertionIndex, 0, version);\n\t\t\t}\n\t\t}\n\t}\n\treturn versions;\n}\n\nexport function filterLatestExtensionVersionsForTargetPlatform(versions: IRawGalleryExtensionVersion[], targetPlatform: TargetPlatform, allTargetPlatforms: TargetPlatform[]): IRawGalleryExtensionVersion[] {\n\tconst latestVersions: IRawGalleryExtensionVersion[] = [];\n\n\tlet preReleaseVersionFoundForTargetPlatform: boolean = false;\n\tlet releaseVersionFoundForTargetPlatform: boolean = false;\n\tfor (const version of versions) {\n\t\tconst versionTargetPlatform = getTargetPlatformForExtensionVersion(version);\n\t\tconst isCompatibleWithTargetPlatform = isTargetPlatformCompatible(versionTargetPlatform, allTargetPlatforms, targetPlatform);\n\n\t\t// Always include versions that are NOT compatible with the target platform\n\t\tif (!isCompatibleWithTargetPlatform) {\n\t\t\tlatestVersions.push(version);\n\t\t\tcontinue;\n\t\t}\n\n\t\t// For compatible versions, only include the first (latest) of each type\n\t\tif (isPreReleaseVersion(version)) {\n\t\t\tif (!preReleaseVersionFoundForTargetPlatform) {\n\t\t\t\tpreReleaseVersionFoundForTargetPlatform = true;\n\t\t\t\tlatestVersions.push(version);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!releaseVersionFoundForTargetPlatform) {\n\t\t\t\treleaseVersionFoundForTargetPlatform = true;\n\t\t\t\tlatestVersions.push(version);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn latestVersions;\n}\n\nfunction setTelemetry(extension: IGalleryExtension, index: number, querySource?: string): void {\n\t/* __GDPR__FRAGMENT__\n\t\"GalleryExtensionTelemetryData2\" : {\n\t\t\"index\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\", \"isMeasurement\": true },\n\t\t\"querySource\": { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\" },\n\t\t\"queryActivityId\": { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\" }\n\t}\n\t*/\n\textension.telemetryData = { index, querySource, queryActivityId: extension.queryContext?.[SEARCH_ACTIVITY_HEADER_NAME] };\n}\n\nfunction toExtension(galleryExtension: IRawGalleryExtension, version: IRawGalleryExtensionVersion, allTargetPlatforms: TargetPlatform[], extensionGalleryManifest: IExtensionGalleryManifest, productService: IProductService, queryContext?: IStringDictionary<unknown>): IGalleryExtension {\n\tconst latestVersion = galleryExtension.versions[0];\n\tconst assets: IGalleryExtensionAssets = {\n\t\tmanifest: getVersionAsset(version, AssetType.Manifest),\n\t\treadme: getVersionAsset(version, AssetType.Details),\n\t\tchangelog: getVersionAsset(version, AssetType.Changelog),\n\t\tlicense: getVersionAsset(version, AssetType.License),\n\t\trepository: getRepositoryAsset(version),\n\t\tdownload: getDownloadAsset(version),\n\t\ticon: getVersionAsset(version, AssetType.Icon),\n\t\tsignature: getVersionAsset(version, AssetType.Signature),\n\t\tcoreTranslations: getCoreTranslationAssets(version)\n\t};\n\n\tconst detailsViewUri = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, galleryExtension.linkType ?? ExtensionGalleryResourceType.ExtensionDetailsViewUri);\n\tconst publisherViewUri = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, galleryExtension.publisher.linkType ?? ExtensionGalleryResourceType.PublisherViewUri);\n\tconst ratingViewUri = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, galleryExtension.ratingLinkType ?? ExtensionGalleryResourceType.ExtensionRatingViewUri);\n\tconst id = getGalleryExtensionId(galleryExtension.publisher.publisherName, galleryExtension.extensionName);\n\n\treturn {\n\t\ttype: 'gallery',\n\t\tidentifier: {\n\t\t\tid,\n\t\t\tuuid: galleryExtension.extensionId\n\t\t},\n\t\tname: galleryExtension.extensionName,\n\t\tversion: version.version,\n\t\tdisplayName: galleryExtension.displayName,\n\t\tpublisherId: galleryExtension.publisher.publisherId,\n\t\tpublisher: galleryExtension.publisher.publisherName,\n\t\tpublisherDisplayName: galleryExtension.publisher.displayName,\n\t\tpublisherDomain: galleryExtension.publisher.domain ? { link: galleryExtension.publisher.domain, verified: !!galleryExtension.publisher.isDomainVerified } : undefined,\n\t\tpublisherSponsorLink: getSponsorLink(latestVersion),\n\t\tdescription: galleryExtension.shortDescription ?? '',\n\t\tinstallCount: getStatistic(galleryExtension.statistics, 'install'),\n\t\trating: getStatistic(galleryExtension.statistics, 'averagerating'),\n\t\tratingCount: getStatistic(galleryExtension.statistics, 'ratingcount'),\n\t\tcategories: galleryExtension.categories || [],\n\t\ttags: galleryExtension.tags || [],\n\t\treleaseDate: Date.parse(galleryExtension.releaseDate),\n\t\tlastUpdated: Date.parse(galleryExtension.lastUpdated),\n\t\tallTargetPlatforms,\n\t\tassets,\n\t\tproperties: {\n\t\t\tdependencies: getExtensions(version, PropertyType.Dependency),\n\t\t\textensionPack: getExtensions(version, PropertyType.ExtensionPack),\n\t\t\tengine: getEngine(version),\n\t\t\tenabledApiProposals: getEnabledApiProposals(version),\n\t\t\tlocalizedLanguages: getLocalizedLanguages(version),\n\t\t\ttargetPlatform: getTargetPlatformForExtensionVersion(version),\n\t\t\tisPreReleaseVersion: isPreReleaseVersion(version),\n\t\t\texecutesCode: executesCode(version)\n\t\t},\n\t\thasPreReleaseVersion: hasPreReleaseForExtension(id, productService) ?? isPreReleaseVersion(latestVersion),\n\t\thasReleaseVersion: true,\n\t\tprivate: isPrivateExtension(latestVersion),\n\t\tpreview: getIsPreview(galleryExtension.flags),\n\t\tisSigned: !!assets.signature,\n\t\tqueryContext,\n\t\tsupportLink: getSupportLink(latestVersion),\n\t\tdetailsLink: detailsViewUri ? format2(detailsViewUri, { publisher: galleryExtension.publisher.publisherName, name: galleryExtension.extensionName }) : undefined,\n\t\tpublisherLink: publisherViewUri ? format2(publisherViewUri, { publisher: galleryExtension.publisher.publisherName }) : undefined,\n\t\tratingLink: ratingViewUri ? format2(ratingViewUri, { publisher: galleryExtension.publisher.publisherName, name: galleryExtension.extensionName }) : undefined,\n\t};\n}\n\ninterface IRawExtensionsControlManifest {\n\tmalicious: string[];\n\tlearnMoreLinks?: IStringDictionary<string>;\n\tmigrateToPreRelease?: IStringDictionary<{\n\t\tid: string;\n\t\tdisplayName: string;\n\t\tmigrateStorage?: boolean;\n\t\tengine?: string;\n\t}>;\n\tdeprecated?: IStringDictionary<boolean | {\n\t\tdisallowInstall?: boolean;\n\t\textension?: {\n\t\t\tid: string;\n\t\t\tdisplayName: string;\n\t\t};\n\t\tsettings?: string[];\n\t\tadditionalInfo?: string;\n\t}>;\n\tsearch?: ISearchPrefferedResults[];\n\tautoUpdate?: IStringDictionary<string>;\n}\n\nexport abstract class AbstractExtensionGalleryService implements IExtensionGalleryService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly extensionsControlUrl: string | undefined;\n\tprivate readonly unpkgResourceApi: string | undefined;\n\n\tprivate readonly commonHeadersPromise: Promise<IHeaders>;\n\tprivate readonly extensionsEnabledWithApiProposalVersion: string[];\n\n\tconstructor(\n\t\tstorageService: IStorageService | undefined,\n\t\t@IRequestService private readonly requestService: IRequestService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IEnvironmentService private readonly environmentService: IEnvironmentService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IProductService private readonly productService: IProductService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IAllowedExtensionsService private readonly allowedExtensionsService: IAllowedExtensionsService,\n\t\t@IExtensionGalleryManifestService private readonly extensionGalleryManifestService: IExtensionGalleryManifestService,\n\t) {\n\t\tthis.extensionsControlUrl = productService.extensionsGallery?.controlUrl;\n\t\tthis.unpkgResourceApi = productService.extensionsGallery?.extensionUrlTemplate;\n\t\tthis.extensionsEnabledWithApiProposalVersion = productService.extensionsEnabledWithApiProposalVersion?.map(id => id.toLowerCase()) ?? [];\n\t\tthis.commonHeadersPromise = resolveMarketplaceHeaders(\n\t\t\tproductService.version,\n\t\t\tproductService,\n\t\t\tthis.environmentService,\n\t\t\tthis.configurationService,\n\t\t\tthis.fileService,\n\t\t\tstorageService,\n\t\t\tthis.telemetryService);\n\t}\n\n\tisEnabled(): boolean {\n\t\treturn this.extensionGalleryManifestService.extensionGalleryManifestStatus === ExtensionGalleryManifestStatus.Available;\n\t}\n\n\tgetExtensions(extensionInfos: ReadonlyArray<IExtensionInfo>, token: CancellationToken): Promise<IGalleryExtension[]>;\n\tgetExtensions(extensionInfos: ReadonlyArray<IExtensionInfo>, options: IExtensionQueryOptions, token: CancellationToken): Promise<IGalleryExtension[]>;\n\tasync getExtensions(extensionInfos: ReadonlyArray<IExtensionInfo>, arg1: CancellationToken | IExtensionQueryOptions, arg2?: CancellationToken): Promise<IGalleryExtension[]> {\n\t\tconst extensionGalleryManifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\t\tif (!extensionGalleryManifest) {\n\t\t\tthrow new Error('No extension gallery service configured.');\n\t\t}\n\n\t\tconst options = CancellationToken.isCancellationToken(arg1) ? {} : arg1 as IExtensionQueryOptions;\n\t\tconst token = CancellationToken.isCancellationToken(arg1) ? arg1 : arg2 as CancellationToken;\n\n\t\tconst resourceApi = this.getResourceApi(extensionGalleryManifest);\n\t\tconst result = resourceApi\n\t\t\t? await this.getExtensionsUsingResourceApi(extensionInfos, options, resourceApi, extensionGalleryManifest, token)\n\t\t\t: await this.getExtensionsUsingQueryApi(extensionInfos, options, extensionGalleryManifest, token);\n\n\t\tconst uuids = result.map(r => r.identifier.uuid);\n\t\tconst extensionInfosByName: IExtensionInfo[] = [];\n\t\tfor (const e of extensionInfos) {\n\t\t\tif (e.uuid && !uuids.includes(e.uuid)) {\n\t\t\t\textensionInfosByName.push({ ...e, uuid: undefined });\n\t\t\t}\n\t\t}\n\n\t\tif (extensionInfosByName.length) {\n\t\t\t// report telemetry data for additional query\n\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t{ count: number },\n\t\t\t\t{\n\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\tcomment: 'Report the query to the Marketplace for fetching extensions by name';\n\t\t\t\t\treadonly count: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Number of extensions to fetch' };\n\t\t\t\t}>('galleryService:additionalQueryByName', {\n\t\t\t\t\tcount: extensionInfosByName.length\n\t\t\t\t});\n\n\t\t\tconst extensions = await this.getExtensionsUsingQueryApi(extensionInfosByName, options, extensionGalleryManifest, token);\n\t\t\tresult.push(...extensions);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprivate getResourceApi(extensionGalleryManifest: IExtensionGalleryManifest): { uri: string; fallback?: string } | undefined {\n\t\tconst latestVersionResource = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, ExtensionGalleryResourceType.ExtensionLatestVersionUri);\n\t\tif (latestVersionResource) {\n\t\t\treturn {\n\t\t\t\turi: latestVersionResource,\n\t\t\t\tfallback: this.unpkgResourceApi\n\t\t\t};\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprivate async getExtensionsUsingQueryApi(extensionInfos: ReadonlyArray<IExtensionInfo>, options: IExtensionQueryOptions, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<IGalleryExtension[]> {\n\t\tconst names: string[] = [],\n\t\t\tids: string[] = [],\n\t\t\tincludePreRelease: (IExtensionIdentifier & { includePreRelease: boolean })[] = [],\n\t\t\tversions: (IExtensionIdentifier & { version: string })[] = [];\n\t\tlet isQueryForReleaseVersionFromPreReleaseVersion = true;\n\n\t\tfor (const extensionInfo of extensionInfos) {\n\t\t\tif (extensionInfo.uuid) {\n\t\t\t\tids.push(extensionInfo.uuid);\n\t\t\t} else {\n\t\t\t\tnames.push(extensionInfo.id);\n\t\t\t}\n\t\t\tif (extensionInfo.version) {\n\t\t\t\tversions.push({ id: extensionInfo.id, uuid: extensionInfo.uuid, version: extensionInfo.version });\n\t\t\t} else {\n\t\t\t\tincludePreRelease.push({ id: extensionInfo.id, uuid: extensionInfo.uuid, includePreRelease: !!extensionInfo.preRelease });\n\t\t\t}\n\t\t\tisQueryForReleaseVersionFromPreReleaseVersion = isQueryForReleaseVersionFromPreReleaseVersion && (!!extensionInfo.hasPreRelease && !extensionInfo.preRelease);\n\t\t}\n\n\t\tif (!ids.length && !names.length) {\n\t\t\treturn [];\n\t\t}\n\n\t\tlet query = new Query().withPage(1, extensionInfos.length);\n\t\tif (ids.length) {\n\t\t\tquery = query.withFilter(FilterType.ExtensionId, ...ids);\n\t\t}\n\t\tif (names.length) {\n\t\t\tquery = query.withFilter(FilterType.ExtensionName, ...names);\n\t\t}\n\t\tif (options.queryAllVersions) {\n\t\t\tquery = query.withFlags(...query.flags, Flag.IncludeVersions);\n\t\t}\n\t\tif (options.source) {\n\t\t\tquery = query.withSource(options.source);\n\t\t}\n\n\t\tconst { extensions } = await this.queryGalleryExtensions(\n\t\t\tquery,\n\t\t\t{\n\t\t\t\ttargetPlatform: options.targetPlatform ?? CURRENT_TARGET_PLATFORM,\n\t\t\t\tincludePreRelease,\n\t\t\t\tversions,\n\t\t\t\tcompatible: !!options.compatible,\n\t\t\t\tproductVersion: options.productVersion ?? { version: this.productService.version, date: this.productService.date },\n\t\t\t\tisQueryForReleaseVersionFromPreReleaseVersion\n\t\t\t},\n\t\t\textensionGalleryManifest,\n\t\t\ttoken);\n\n\t\tif (options.source) {\n\t\t\textensions.forEach((e, index) => setTelemetry(e, index, options.source));\n\t\t}\n\n\t\treturn extensions;\n\t}\n\n\tprivate async getExtensionsUsingResourceApi(extensionInfos: ReadonlyArray<IExtensionInfo>, options: IExtensionQueryOptions, resourceApi: { uri: string; fallback?: string }, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<IGalleryExtension[]> {\n\n\t\tconst result: IGalleryExtension[] = [];\n\t\tconst toQuery: IExtensionInfo[] = [];\n\t\tconst toFetchLatest: IExtensionInfo[] = [];\n\n\t\tfor (const extensionInfo of extensionInfos) {\n\t\t\tif (!EXTENSION_IDENTIFIER_REGEX.test(extensionInfo.id)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (extensionInfo.version) {\n\t\t\t\ttoQuery.push(extensionInfo);\n\t\t\t} else {\n\t\t\t\ttoFetchLatest.push(extensionInfo);\n\t\t\t}\n\t\t}\n\n\t\tawait Promise.all(toFetchLatest.map(async extensionInfo => {\n\t\t\tlet galleryExtension: IGalleryExtension | string;\n\t\t\ttry {\n\t\t\t\tgalleryExtension = await this.getLatestGalleryExtension(extensionInfo, options, resourceApi, extensionGalleryManifest, token);\n\t\t\t\tif (isString(galleryExtension)) {\n\t\t\t\t\t// fallback to query\n\t\t\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\textension: string;\n\t\t\t\t\t\t\tpreRelease: boolean;\n\t\t\t\t\t\t\tcompatible: boolean;\n\t\t\t\t\t\t\terrorCode: string;\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\t\t\tcomment: 'Report the fallback to the Marketplace query for fetching extensions';\n\t\t\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Extension id' };\n\t\t\t\t\t\t\tpreRelease: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Get pre-release version' };\n\t\t\t\t\t\t\tcompatible: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Get compatible version' };\n\t\t\t\t\t\t\terrorCode: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Error code or reason' };\n\t\t\t\t\t\t}>('galleryService:fallbacktoquery', {\n\t\t\t\t\t\t\textension: extensionInfo.id,\n\t\t\t\t\t\t\tpreRelease: !!extensionInfo.preRelease,\n\t\t\t\t\t\t\tcompatible: !!options.compatible,\n\t\t\t\t\t\t\terrorCode: galleryExtension\n\t\t\t\t\t\t});\n\t\t\t\t\ttoQuery.push(extensionInfo);\n\t\t\t\t} else {\n\t\t\t\t\tresult.push(galleryExtension);\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tif (error instanceof ExtensionGalleryError) {\n\t\t\t\t\tswitch (error.code) {\n\t\t\t\t\t\tcase ExtensionGalleryErrorCode.Offline:\n\t\t\t\t\t\tcase ExtensionGalleryErrorCode.Cancelled:\n\t\t\t\t\t\tcase ExtensionGalleryErrorCode.Timeout:\n\t\t\t\t\t\t\tthrow error;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// fallback to query\n\t\t\t\tthis.logService.error(`Error while getting the latest version for the extension ${extensionInfo.id}.`, getErrorMessage(error));\n\t\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t\t{\n\t\t\t\t\t\textension: string;\n\t\t\t\t\t\tpreRelease: boolean;\n\t\t\t\t\t\tcompatible: boolean;\n\t\t\t\t\t\terrorCode: string;\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\t\tcomment: 'Report the fallback to the Marketplace query for fetching extensions';\n\t\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Extension id' };\n\t\t\t\t\t\tpreRelease: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Get pre-release version' };\n\t\t\t\t\t\tcompatible: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Get compatible version' };\n\t\t\t\t\t\terrorCode: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Error code' };\n\t\t\t\t\t}>('galleryService:fallbacktoquery', {\n\t\t\t\t\t\textension: extensionInfo.id,\n\t\t\t\t\t\tpreRelease: !!extensionInfo.preRelease,\n\t\t\t\t\t\tcompatible: !!options.compatible,\n\t\t\t\t\t\terrorCode: error instanceof ExtensionGalleryError ? error.code : 'Unknown'\n\t\t\t\t\t});\n\t\t\t\ttoQuery.push(extensionInfo);\n\t\t\t}\n\n\t\t}));\n\n\t\tif (toQuery.length) {\n\t\t\tconst extensions = await this.getExtensionsUsingQueryApi(toQuery, options, extensionGalleryManifest, token);\n\t\t\tresult.push(...extensions);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprivate async getLatestGalleryExtension(extensionInfo: IExtensionInfo, options: IExtensionQueryOptions, resourceApi: { uri: string; fallback?: string }, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<IGalleryExtension | string> {\n\t\tconst rawGalleryExtension = await this.getLatestRawGalleryExtensionWithFallback(extensionInfo, resourceApi, token);\n\n\t\tif (!rawGalleryExtension) {\n\t\t\treturn 'NOT_FOUND';\n\t\t}\n\n\t\tconst targetPlatform = options.targetPlatform ?? CURRENT_TARGET_PLATFORM;\n\t\tconst allTargetPlatforms = getAllTargetPlatforms(rawGalleryExtension);\n\t\tconst rawGalleryExtensionVersion = await this.getValidRawGalleryExtensionVersion(\n\t\t\trawGalleryExtension,\n\t\t\tfilterLatestExtensionVersionsForTargetPlatform(rawGalleryExtension.versions, targetPlatform, allTargetPlatforms),\n\t\t\t{\n\t\t\t\ttargetPlatform,\n\t\t\t\tcompatible: !!options.compatible,\n\t\t\t\tproductVersion: options.productVersion ?? {\n\t\t\t\t\tversion: this.productService.version,\n\t\t\t\t\tdate: this.productService.date\n\t\t\t\t},\n\t\t\t\tversion: extensionInfo.preRelease ? VersionKind.Latest : VersionKind.Release\n\t\t\t}, allTargetPlatforms);\n\n\t\tif (rawGalleryExtensionVersion) {\n\t\t\treturn toExtension(rawGalleryExtension, rawGalleryExtensionVersion, allTargetPlatforms, extensionGalleryManifest, this.productService);\n\t\t}\n\n\t\treturn 'NOT_COMPATIBLE';\n\t}\n\n\tasync getCompatibleExtension(extension: IGalleryExtension, includePreRelease: boolean, targetPlatform: TargetPlatform, productVersion: IProductVersion = { version: this.productService.version, date: this.productService.date }): Promise<IGalleryExtension | null> {\n\t\tif (isNotWebExtensionInWebTargetPlatform(extension.allTargetPlatforms, targetPlatform)) {\n\t\t\treturn null;\n\t\t}\n\t\tif (await this.isExtensionCompatible(extension, includePreRelease, targetPlatform)) {\n\t\t\treturn extension;\n\t\t}\n\t\tif (this.allowedExtensionsService.isAllowed({ id: extension.identifier.id, publisherDisplayName: extension.publisherDisplayName }) !== true) {\n\t\t\treturn null;\n\t\t}\n\t\tconst result = await this.getExtensions([{\n\t\t\t...extension.identifier,\n\t\t\tpreRelease: includePreRelease,\n\t\t\thasPreRelease: extension.hasPreReleaseVersion,\n\t\t}], {\n\t\t\tcompatible: true,\n\t\t\tproductVersion,\n\t\t\tqueryAllVersions: true,\n\t\t\ttargetPlatform,\n\t\t}, CancellationToken.None);\n\n\t\treturn result[0] ?? null;\n\t}\n\n\tasync isExtensionCompatible(extension: IGalleryExtension, includePreRelease: boolean, targetPlatform: TargetPlatform, productVersion: IProductVersion = { version: this.productService.version, date: this.productService.date }): Promise<boolean> {\n\t\treturn this.isValidVersion(\n\t\t\t{\n\t\t\t\tid: extension.identifier.id,\n\t\t\t\tversion: extension.version,\n\t\t\t\tisPreReleaseVersion: extension.properties.isPreReleaseVersion,\n\t\t\t\ttargetPlatform: extension.properties.targetPlatform,\n\t\t\t\tmanifestAsset: extension.assets.manifest,\n\t\t\t\tengine: extension.properties.engine,\n\t\t\t\tenabledApiProposals: extension.properties.enabledApiProposals\n\t\t\t},\n\t\t\t{\n\t\t\t\ttargetPlatform,\n\t\t\t\tcompatible: true,\n\t\t\t\tproductVersion,\n\t\t\t\tversion: includePreRelease ? VersionKind.Latest : VersionKind.Release\n\t\t\t},\n\t\t\textension.publisherDisplayName,\n\t\t\textension.allTargetPlatforms\n\t\t);\n\t}\n\n\tprivate async isValidVersion(\n\t\textension: { id: string; version: string; isPreReleaseVersion: boolean; targetPlatform: TargetPlatform; manifestAsset: IGalleryExtensionAsset | null; engine: string | undefined; enabledApiProposals: string[] | undefined },\n\t\t{ targetPlatform, compatible, productVersion, version }: Omit<ExtensionVersionCriteria, 'targetPlatform'> & { targetPlatform: TargetPlatform | undefined },\n\t\tpublisherDisplayName: string,\n\t\tallTargetPlatforms: TargetPlatform[]\n\t): Promise<boolean> {\n\n\t\tconst hasPreRelease = hasPreReleaseForExtension(extension.id, this.productService);\n\t\tconst excludeVersionRange = getExcludeVersionRangeForExtension(extension.id, this.productService);\n\n\t\tif (extension.isPreReleaseVersion && hasPreRelease === false /* Skip if hasPreRelease is not defined for this extension */) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (excludeVersionRange && semver.satisfies(extension.version, excludeVersionRange)) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Specific version\n\t\tif (isString(version)) {\n\t\t\tif (extension.version !== version) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\t// Prerelease or release version kind\n\t\telse if (version === VersionKind.Release || version === VersionKind.Prerelease) {\n\t\t\tif (extension.isPreReleaseVersion !== (version === VersionKind.Prerelease)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tif (targetPlatform && !isTargetPlatformCompatible(extension.targetPlatform, allTargetPlatforms, targetPlatform)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (compatible) {\n\t\t\tif (this.allowedExtensionsService.isAllowed({ id: extension.id, publisherDisplayName, version: extension.version, prerelease: extension.isPreReleaseVersion, targetPlatform: extension.targetPlatform }) !== true) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (!this.areApiProposalsCompatible(extension.id, extension.enabledApiProposals)) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (!(await this.isEngineValid(extension.id, extension.version, extension.engine, extension.manifestAsset, productVersion))) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprivate areApiProposalsCompatible(extensionId: string, enabledApiProposals: string[] | undefined): boolean {\n\t\tif (!enabledApiProposals) {\n\t\t\treturn true;\n\t\t}\n\t\tif (!this.extensionsEnabledWithApiProposalVersion.includes(extensionId.toLowerCase())) {\n\t\t\treturn true;\n\t\t}\n\t\treturn areApiProposalsCompatible(enabledApiProposals);\n\t}\n\n\tprivate async isEngineValid(extensionId: string, version: string, engine: string | undefined, manifestAsset: IGalleryExtensionAsset | null, productVersion: IProductVersion): Promise<boolean> {\n\t\tif (!engine) {\n\t\t\tif (!manifestAsset) {\n\t\t\t\tthis.logService.error(`Missing engine and manifest asset for the extension ${extensionId} with version ${version}`);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\ttry {\n\t\t\t\ttype GalleryServiceEngineFallbackClassification = {\n\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\tcomment: 'Fallback request when engine is not found in properties of an extension version';\n\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'extension name' };\n\t\t\t\t\textensionVersion: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'version' };\n\t\t\t\t};\n\t\t\t\ttype GalleryServiceEngineFallbackEvent = {\n\t\t\t\t\textension: string;\n\t\t\t\t\textensionVersion: string;\n\t\t\t\t};\n\t\t\t\tthis.telemetryService.publicLog2<GalleryServiceEngineFallbackEvent, GalleryServiceEngineFallbackClassification>('galleryService:engineFallback', { extension: extensionId, extensionVersion: version });\n\n\t\t\t\tconst headers = { 'Accept-Encoding': 'gzip' };\n\t\t\t\tconst context = await this.getAsset(extensionId, manifestAsset, AssetType.Manifest, version, { headers });\n\t\t\t\tconst manifest = await asJson<IExtensionManifest>(context);\n\t\t\t\tif (!manifest) {\n\t\t\t\t\tthis.logService.error(`Manifest was not found for the extension ${extensionId} with version ${version}`);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tengine = manifest.engines.vscode;\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(`Error while getting the engine for the version ${version}.`, getErrorMessage(error));\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn isEngineValid(engine, productVersion.version, productVersion.date);\n\t}\n\n\tasync query(options: IQueryOptions, token: CancellationToken): Promise<IPager<IGalleryExtension>> {\n\t\tconst extensionGalleryManifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\n\t\tif (!extensionGalleryManifest) {\n\t\t\tthrow new Error('No extension gallery service configured.');\n\t\t}\n\n\t\tlet text = options.text || '';\n\t\tconst pageSize = options.pageSize ?? 50;\n\n\t\tlet query = new Query()\n\t\t\t.withPage(1, pageSize);\n\n\t\tif (text) {\n\t\t\t// Use category filter instead of \"category:themes\"\n\t\t\ttext = text.replace(/\\bcategory:(\"([^\"]*)\"|([^\"]\\S*))(\\s+|\\b|$)/g, (_, quotedCategory, category) => {\n\t\t\t\tquery = query.withFilter(FilterType.Category, category || quotedCategory);\n\t\t\t\treturn '';\n\t\t\t});\n\n\t\t\t// Use tag filter instead of \"tag:debuggers\"\n\t\t\ttext = text.replace(/\\btag:(\"([^\"]*)\"|([^\"]\\S*))(\\s+|\\b|$)/g, (_, quotedTag, tag) => {\n\t\t\t\tquery = query.withFilter(FilterType.Tag, tag || quotedTag);\n\t\t\t\treturn '';\n\t\t\t});\n\n\t\t\t// Use featured filter\n\t\t\ttext = text.replace(/\\bfeatured(\\s+|\\b|$)/g, () => {\n\t\t\t\tquery = query.withFilter(FilterType.Featured);\n\t\t\t\treturn '';\n\t\t\t});\n\n\t\t\ttext = text.trim();\n\n\t\t\tif (text) {\n\t\t\t\ttext = text.length < 200 ? text : text.substring(0, 200);\n\t\t\t\tquery = query.withFilter(FilterType.SearchText, text);\n\t\t\t}\n\n\t\t\tif (extensionGalleryManifest.capabilities.extensionQuery.sorting?.some(c => c.name === SortBy.NoneOrRelevance)) {\n\t\t\t\tquery = query.withSortBy(SortBy.NoneOrRelevance);\n\t\t\t}\n\t\t} else {\n\t\t\tif (extensionGalleryManifest.capabilities.extensionQuery.sorting?.some(c => c.name === SortBy.InstallCount)) {\n\t\t\t\tquery = query.withSortBy(SortBy.InstallCount);\n\t\t\t}\n\t\t}\n\n\t\tif (options.sortBy && extensionGalleryManifest.capabilities.extensionQuery.sorting?.some(c => c.name === options.sortBy)) {\n\t\t\tquery = query.withSortBy(options.sortBy);\n\t\t}\n\n\t\tif (typeof options.sortOrder === 'number') {\n\t\t\tquery = query.withSortOrder(options.sortOrder);\n\t\t}\n\n\t\tif (options.source) {\n\t\t\tquery = query.withSource(options.source);\n\t\t}\n\n\t\tconst runQuery = async (query: Query, token: CancellationToken) => {\n\t\t\tconst { extensions, total } = await this.queryGalleryExtensions(query, { targetPlatform: CURRENT_TARGET_PLATFORM, compatible: false, includePreRelease: !!options.includePreRelease, productVersion: options.productVersion ?? { version: this.productService.version, date: this.productService.date } }, extensionGalleryManifest, token);\n\t\t\textensions.forEach((e, index) => setTelemetry(e, ((query.pageNumber - 1) * query.pageSize) + index, options.source));\n\t\t\treturn { extensions, total };\n\t\t};\n\t\tconst { extensions, total } = await runQuery(query, token);\n\t\tconst getPage = async (pageIndex: number, ct: CancellationToken) => {\n\t\t\tif (ct.isCancellationRequested) {\n\t\t\t\tthrow new CancellationError();\n\t\t\t}\n\t\t\tconst { extensions } = await runQuery(query.withPage(pageIndex + 1), ct);\n\t\t\treturn extensions;\n\t\t};\n\n\t\treturn { firstPage: extensions, total, pageSize: query.pageSize, getPage };\n\t}\n\n\tprivate async queryGalleryExtensions(query: Query, criteria: ExtensionsCriteria, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<{ extensions: IGalleryExtension[]; total: number }> {\n\t\tconst flags = query.flags;\n\n\t\t/**\n\t\t * If both version flags (IncludeLatestVersionOnly and IncludeVersions) are included, then only include latest versions (IncludeLatestVersionOnly) flag.\n\t\t */\n\t\tif (query.flags.includes(Flag.IncludeLatestVersionOnly) && query.flags.includes(Flag.IncludeVersions)) {\n\t\t\tquery = query.withFlags(...query.flags.filter(flag => flag !== Flag.IncludeVersions));\n\t\t}\n\n\t\t/**\n\t\t * If version flags (IncludeLatestVersionOnly and IncludeVersions) are not included, default is to query for latest versions (IncludeLatestVersionOnly).\n\t\t */\n\t\tif (!query.flags.includes(Flag.IncludeLatestVersionOnly) && !query.flags.includes(Flag.IncludeVersions)) {\n\t\t\tquery = query.withFlags(...query.flags, Flag.IncludeLatestVersionOnly);\n\t\t}\n\n\t\t/**\n\t\t * If versions criteria exist or every requested extension is for release version and has a pre-release version, then remove latest flags and add all versions flag.\n\t\t */\n\t\tif (criteria.versions?.length || criteria.isQueryForReleaseVersionFromPreReleaseVersion) {\n\t\t\tquery = query.withFlags(...query.flags.filter(flag => flag !== Flag.IncludeLatestVersionOnly), Flag.IncludeVersions);\n\t\t}\n\n\t\t/**\n\t\t * Add necessary extension flags\n\t\t */\n\t\tquery = query.withFlags(...query.flags, Flag.IncludeAssetUri, Flag.IncludeCategoryAndTags, Flag.IncludeFiles, Flag.IncludeStatistics, Flag.IncludeVersionProperties);\n\t\tconst { galleryExtensions: rawGalleryExtensions, total, context } = await this.queryRawGalleryExtensions(query, extensionGalleryManifest, token);\n\n\t\tconst hasAllVersions: boolean = !query.flags.includes(Flag.IncludeLatestVersionOnly);\n\t\tif (hasAllVersions) {\n\t\t\tconst extensions: IGalleryExtension[] = [];\n\t\t\tfor (const rawGalleryExtension of rawGalleryExtensions) {\n\t\t\t\tconst allTargetPlatforms = getAllTargetPlatforms(rawGalleryExtension);\n\t\t\t\tconst extensionIdentifier = { id: getGalleryExtensionId(rawGalleryExtension.publisher.publisherName, rawGalleryExtension.extensionName), uuid: rawGalleryExtension.extensionId };\n\t\t\t\tconst includePreRelease = isBoolean(criteria.includePreRelease) ? criteria.includePreRelease : !!criteria.includePreRelease.find(extensionIdentifierWithPreRelease => areSameExtensions(extensionIdentifierWithPreRelease, extensionIdentifier))?.includePreRelease;\n\t\t\t\tconst rawGalleryExtensionVersion = await this.getValidRawGalleryExtensionVersion(\n\t\t\t\t\trawGalleryExtension,\n\t\t\t\t\trawGalleryExtension.versions,\n\t\t\t\t\t{\n\t\t\t\t\t\tcompatible: criteria.compatible,\n\t\t\t\t\t\ttargetPlatform: criteria.targetPlatform,\n\t\t\t\t\t\tproductVersion: criteria.productVersion,\n\t\t\t\t\t\tversion: criteria.versions?.find(extensionIdentifierWithVersion => areSameExtensions(extensionIdentifierWithVersion, extensionIdentifier))?.version\n\t\t\t\t\t\t\t?? (includePreRelease ? VersionKind.Latest : VersionKind.Release)\n\t\t\t\t\t},\n\t\t\t\t\tallTargetPlatforms\n\t\t\t\t);\n\t\t\t\tif (rawGalleryExtensionVersion) {\n\t\t\t\t\textensions.push(toExtension(rawGalleryExtension, rawGalleryExtensionVersion, allTargetPlatforms, extensionGalleryManifest, this.productService, context));\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn { extensions, total };\n\t\t}\n\n\t\tconst result: [number, IGalleryExtension][] = [];\n\t\tconst needAllVersions = new Map<string, number>();\n\t\tfor (let index = 0; index < rawGalleryExtensions.length; index++) {\n\t\t\tconst rawGalleryExtension = rawGalleryExtensions[index];\n\t\t\tconst extensionIdentifier = { id: getGalleryExtensionId(rawGalleryExtension.publisher.publisherName, rawGalleryExtension.extensionName), uuid: rawGalleryExtension.extensionId };\n\t\t\tconst includePreRelease = isBoolean(criteria.includePreRelease) ? criteria.includePreRelease : !!criteria.includePreRelease.find(extensionIdentifierWithPreRelease => areSameExtensions(extensionIdentifierWithPreRelease, extensionIdentifier))?.includePreRelease;\n\t\t\tconst allTargetPlatforms = getAllTargetPlatforms(rawGalleryExtension);\n\t\t\tif (criteria.compatible) {\n\t\t\t\t// Skip looking for all versions if requested for a web-compatible extension and it is not a web extension.\n\t\t\t\tif (isNotWebExtensionInWebTargetPlatform(allTargetPlatforms, criteria.targetPlatform)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\t// Skip looking for all versions if the extension is not allowed.\n\t\t\t\tif (this.allowedExtensionsService.isAllowed({ id: extensionIdentifier.id, publisherDisplayName: rawGalleryExtension.publisher.displayName }) !== true) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst rawGalleryExtensionVersion = await this.getValidRawGalleryExtensionVersion(\n\t\t\t\trawGalleryExtension,\n\t\t\t\trawGalleryExtension.versions,\n\t\t\t\t{\n\t\t\t\t\tcompatible: criteria.compatible,\n\t\t\t\t\ttargetPlatform: criteria.targetPlatform,\n\t\t\t\t\tproductVersion: criteria.productVersion,\n\t\t\t\t\tversion: criteria.versions?.find(extensionIdentifierWithVersion => areSameExtensions(extensionIdentifierWithVersion, extensionIdentifier))?.version\n\t\t\t\t\t\t?? (includePreRelease ? VersionKind.Latest : VersionKind.Release)\n\t\t\t\t},\n\t\t\t\tallTargetPlatforms\n\t\t\t);\n\t\t\tconst extension = rawGalleryExtensionVersion ? toExtension(rawGalleryExtension, rawGalleryExtensionVersion, allTargetPlatforms, extensionGalleryManifest, this.productService, context) : null;\n\t\t\tif (!extension\n\t\t\t\t/** Need all versions if the extension is a pre-release version but\n\t\t\t\t * \t\t- the query is to look for a release version or\n\t\t\t\t * \t\t- the extension has no release version\n\t\t\t\t * Get all versions to get or check the release version\n\t\t\t\t*/\n\t\t\t\t|| (extension.properties.isPreReleaseVersion && (!includePreRelease || !extension.hasReleaseVersion))\n\t\t\t\t/**\n\t\t\t\t * Need all versions if the extension is a release version with a different target platform than requested and also has a pre-release version\n\t\t\t\t * Because, this is a platform specific extension and can have a newer release version supporting this platform.\n\t\t\t\t * See https://github.com/microsoft/vscode/issues/139628\n\t\t\t\t*/\n\t\t\t\t|| (!extension.properties.isPreReleaseVersion && extension.properties.targetPlatform !== criteria.targetPlatform && extension.hasPreReleaseVersion)\n\t\t\t) {\n\t\t\t\tneedAllVersions.set(rawGalleryExtension.extensionId, index);\n\t\t\t} else {\n\t\t\t\tresult.push([index, extension]);\n\t\t\t}\n\t\t}\n\n\t\tif (needAllVersions.size) {\n\t\t\tconst stopWatch = new StopWatch();\n\t\t\tconst query = new Query()\n\t\t\t\t.withFlags(...flags.filter(flag => flag !== Flag.IncludeLatestVersionOnly), Flag.IncludeVersions)\n\t\t\t\t.withPage(1, needAllVersions.size)\n\t\t\t\t.withFilter(FilterType.ExtensionId, ...needAllVersions.keys());\n\t\t\tconst { extensions } = await this.queryGalleryExtensions(query, criteria, extensionGalleryManifest, token);\n\t\t\tthis.telemetryService.publicLog2<GalleryServiceAdditionalQueryEvent, GalleryServiceAdditionalQueryClassification>('galleryService:additionalQuery', {\n\t\t\t\tduration: stopWatch.elapsed(),\n\t\t\t\tcount: needAllVersions.size\n\t\t\t});\n\t\t\tfor (const extension of extensions) {\n\t\t\t\tconst index = needAllVersions.get(extension.identifier.uuid)!;\n\t\t\t\tresult.push([index, extension]);\n\t\t\t}\n\t\t}\n\n\t\treturn { extensions: result.sort((a, b) => a[0] - b[0]).map(([, extension]) => extension), total };\n\t}\n\n\tprivate async getValidRawGalleryExtensionVersion(rawGalleryExtension: IRawGalleryExtension, versions: IRawGalleryExtensionVersion[], criteria: ExtensionVersionCriteria, allTargetPlatforms: TargetPlatform[]): Promise<IRawGalleryExtensionVersion | null> {\n\t\tconst extensionIdentifier = { id: getGalleryExtensionId(rawGalleryExtension.publisher.publisherName, rawGalleryExtension.extensionName), uuid: rawGalleryExtension.extensionId };\n\t\tconst rawGalleryExtensionVersions = sortExtensionVersions(versions, criteria.targetPlatform);\n\n\t\tif (criteria.compatible && isNotWebExtensionInWebTargetPlatform(allTargetPlatforms, criteria.targetPlatform)) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst version = isString(criteria.version) ? criteria.version : undefined;\n\n\t\tfor (let index = 0; index < rawGalleryExtensionVersions.length; index++) {\n\t\t\tconst rawGalleryExtensionVersion = rawGalleryExtensionVersions[index];\n\t\t\tif (await this.isValidVersion(\n\t\t\t\t{\n\t\t\t\t\tid: extensionIdentifier.id,\n\t\t\t\t\tversion: rawGalleryExtensionVersion.version,\n\t\t\t\t\tisPreReleaseVersion: isPreReleaseVersion(rawGalleryExtensionVersion),\n\t\t\t\t\ttargetPlatform: getTargetPlatformForExtensionVersion(rawGalleryExtensionVersion),\n\t\t\t\t\tengine: getEngine(rawGalleryExtensionVersion),\n\t\t\t\t\tmanifestAsset: getVersionAsset(rawGalleryExtensionVersion, AssetType.Manifest),\n\t\t\t\t\tenabledApiProposals: getEnabledApiProposals(rawGalleryExtensionVersion)\n\t\t\t\t},\n\t\t\t\tcriteria,\n\t\t\t\trawGalleryExtension.publisher.displayName,\n\t\t\t\tallTargetPlatforms)\n\t\t\t) {\n\t\t\t\treturn rawGalleryExtensionVersion;\n\t\t\t}\n\t\t\tif (version && rawGalleryExtensionVersion.version === version) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\n\t\tif (version || criteria.compatible) {\n\t\t\treturn null;\n\t\t}\n\n\t\t/**\n\t\t * Fallback: Return the latest version\n\t\t * This can happen when the extension does not have a release version or does not have a version compatible with the given target platform.\n\t\t */\n\t\treturn rawGalleryExtension.versions[0];\n\t}\n\n\tprivate async queryRawGalleryExtensions(query: Query, extensionGalleryManifest: IExtensionGalleryManifest, token: CancellationToken): Promise<IRawGalleryExtensionsResult> {\n\t\tconst extensionsQueryApi = getExtensionGalleryManifestResourceUri(extensionGalleryManifest, ExtensionGalleryResourceType.ExtensionQueryService);\n\n\t\tif (!extensionsQueryApi) {\n\t\t\tthrow new Error('No extension gallery query service configured.');\n\t\t}\n\n\t\tquery = query\n\t\t\t/* Always exclude non validated extensions */\n\t\t\t.withFlags(...query.flags, Flag.ExcludeNonValidated)\n\t\t\t.withFilter(FilterType.Target, 'Microsoft.VisualStudio.Code');\n\n\t\tconst unpublishedFlag = extensionGalleryManifest.capabilities.extensionQuery.flags?.find(f => f.name === Flag.Unpublished);\n\t\t/* Always exclude unpublished extensions */\n\t\tif (unpublishedFlag) {\n\t\t\tquery = query.withFilter(FilterType.ExcludeWithFlags, String(unpublishedFlag.value));\n\t\t}\n\n\t\tconst data = JSON.stringify({\n\t\t\tfilters: [\n\t\t\t\t{\n\t\t\t\t\tcriteria: query.criteria.reduce<{ filterType: number; value?: string }[]>((criteria, c) => {\n\t\t\t\t\t\tconst criterium = extensionGalleryManifest.capabilities.extensionQuery.filtering?.find(f => f.name === c.filterType);\n\t\t\t\t\t\tif (criterium) {\n\t\t\t\t\t\t\tcriteria.push({\n\t\t\t\t\t\t\t\tfilterType: criterium.value,\n\t\t\t\t\t\t\t\tvalue: c.value,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn criteria;\n\t\t\t\t\t}, []),\n\t\t\t\t\tpageNumber: query.pageNumber,\n\t\t\t\t\tpageSize: query.pageSize,\n\t\t\t\t\tsortBy: extensionGalleryManifest.capabilities.extensionQuery.sorting?.find(s => s.name === query.sortBy)?.value,\n\t\t\t\t\tsortOrder: query.sortOrder,\n\t\t\t\t}\n\t\t\t],\n\t\t\tassetTypes: query.assetTypes,\n\t\t\tflags: query.flags.reduce<number>((flags, flag) => {\n\t\t\t\tconst flagValue = extensionGalleryManifest.capabilities.extensionQuery.flags?.find(f => f.name === flag);\n\t\t\t\tif (flagValue) {\n\t\t\t\t\tflags |= flagValue.value;\n\t\t\t\t}\n\t\t\t\treturn flags;\n\t\t\t}, 0)\n\t\t});\n\n\t\tconst commonHeaders = await this.commonHeadersPromise;\n\t\tconst headers = {\n\t\t\t...commonHeaders,\n\t\t\t'Content-Type': 'application/json',\n\t\t\t'Accept': 'application/json;api-version=3.0-preview.1',\n\t\t\t'Accept-Encoding': 'gzip',\n\t\t\t'Content-Length': String(data.length),\n\t\t};\n\n\t\tconst stopWatch = new StopWatch();\n\t\tlet context: IRequestContext | undefined, errorCode: ExtensionGalleryErrorCode | undefined, total: number = 0;\n\n\t\ttry {\n\t\t\tcontext = await this.requestService.request({\n\t\t\t\ttype: 'POST',\n\t\t\t\turl: extensionsQueryApi,\n\t\t\t\tdata,\n\t\t\t\theaders\n\t\t\t}, token);\n\n\t\t\tif (context.res.statusCode && context.res.statusCode >= 400 && context.res.statusCode < 500) {\n\t\t\t\treturn { galleryExtensions: [], total };\n\t\t\t}\n\n\t\t\tconst result = await asJson<IRawGalleryQueryResult>(context);\n\t\t\tif (result) {\n\t\t\t\tconst r = result.results[0];\n\t\t\t\tconst galleryExtensions = r.extensions;\n\t\t\t\tconst resultCount = r.resultMetadata && r.resultMetadata.filter(m => m.metadataType === 'ResultCount')[0];\n\t\t\t\ttotal = resultCount && resultCount.metadataItems.filter(i => i.name === 'TotalCount')[0].count || 0;\n\n\t\t\t\treturn {\n\t\t\t\t\tgalleryExtensions,\n\t\t\t\t\ttotal,\n\t\t\t\t\tcontext: context.res.headers['activityid'] ? {\n\t\t\t\t\t\t[SEARCH_ACTIVITY_HEADER_NAME]: context.res.headers['activityid']\n\t\t\t\t\t} : {}\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn { galleryExtensions: [], total };\n\n\t\t} catch (e) {\n\t\t\tif (isCancellationError(e)) {\n\t\t\t\terrorCode = ExtensionGalleryErrorCode.Cancelled;\n\t\t\t\tthrow e;\n\t\t\t} else {\n\t\t\t\tconst errorMessage = getErrorMessage(e);\n\t\t\t\terrorCode = isOfflineError(e)\n\t\t\t\t\t? ExtensionGalleryErrorCode.Offline\n\t\t\t\t\t: errorMessage.startsWith('XHR timeout')\n\t\t\t\t\t\t? ExtensionGalleryErrorCode.Timeout\n\t\t\t\t\t\t: ExtensionGalleryErrorCode.Failed;\n\t\t\t\tthrow new ExtensionGalleryError(errorMessage, errorCode);\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.telemetryService.publicLog2<GalleryServiceQueryEvent, GalleryServiceQueryClassification>('galleryService:query', {\n\t\t\t\tfilterTypes: query.criteria.map(criterium => criterium.filterType),\n\t\t\t\tflags: query.flags,\n\t\t\t\tsortBy: query.sortBy,\n\t\t\t\tsortOrder: String(query.sortOrder),\n\t\t\t\tpageNumber: String(query.pageNumber),\n\t\t\t\tsource: query.source,\n\t\t\t\tsearchTextLength: query.searchText.length,\n\t\t\t\trequestBodySize: String(data.length),\n\t\t\t\tduration: stopWatch.elapsed(),\n\t\t\t\tsuccess: !!context && isSuccess(context),\n\t\t\t\tresponseBodySize: context?.res.headers['Content-Length'],\n\t\t\t\tstatusCode: context ? String(context.res.statusCode) : undefined,\n\t\t\t\terrorCode,\n\t\t\t\tcount: String(total),\n\t\t\t\tserver: this.getHeaderValue(context?.res.headers, SERVER_HEADER_NAME),\n\t\t\t\tactivityId: this.getHeaderValue(context?.res.headers, ACTIVITY_HEADER_NAME),\n\t\t\t\tendToEndId: this.getHeaderValue(context?.res.headers, END_END_ID_HEADER_NAME),\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate getHeaderValue(headers: IHeaders | undefined, name: string): TelemetryTrustedValue<string> | undefined {\n\t\tconst headerValue = headers?.[name.toLowerCase()];\n\t\tconst value = Array.isArray(headerValue) ? headerValue[0] : headerValue;\n\t\treturn value ? new TelemetryTrustedValue(value) : undefined;\n\t}\n\n\tprivate async getLatestRawGalleryExtensionWithFallback(extensionInfo: IExtensionInfo, resourceApi: { uri: string; fallback?: string }, token: CancellationToken): Promise<IRawGalleryExtension | null> {\n\t\tconst [publisher, name] = extensionInfo.id.split('.');\n\t\tlet errorCode: string | undefined;\n\t\ttry {\n\t\t\tconst uri = URI.parse(format2(resourceApi.uri, { publisher, name }));\n\t\t\treturn await this.getLatestRawGalleryExtension(extensionInfo.id, uri, token);\n\t\t} catch (error) {\n\t\t\tif (error instanceof ExtensionGalleryError) {\n\t\t\t\terrorCode = error.code;\n\t\t\t\tswitch (error.code) {\n\t\t\t\t\tcase ExtensionGalleryErrorCode.Offline:\n\t\t\t\t\tcase ExtensionGalleryErrorCode.Cancelled:\n\t\t\t\t\tcase ExtensionGalleryErrorCode.Timeout:\n\t\t\t\t\tcase ExtensionGalleryErrorCode.ClientError:\n\t\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\terrorCode = 'Unknown';\n\t\t\t}\n\t\t\tif (!resourceApi.fallback) {\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t{\n\t\t\t\t\textension: string;\n\t\t\t\t\terrorCode?: string;\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\tcomment: 'Report fetching latest version of an extension';\n\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The identifier of the extension' };\n\t\t\t\t\terrorCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The error code in case of error' };\n\t\t\t\t}\n\t\t\t>('galleryService:getmarketplacelatest', {\n\t\t\t\textension: extensionInfo.id,\n\t\t\t\terrorCode,\n\t\t\t});\n\t\t}\n\n\t\tthis.logService.error(`Error while getting the latest version for the extension ${extensionInfo.id} from ${resourceApi.uri}. Trying the fallback ${resourceApi.fallback}`, errorCode);\n\t\ttry {\n\t\t\tconst uri = URI.parse(format2(resourceApi.fallback, { publisher, name }));\n\t\t\treturn await this.getLatestRawGalleryExtension(extensionInfo.id, uri, token);\n\t\t} catch (error) {\n\t\t\terrorCode = error instanceof ExtensionGalleryError ? error.code : 'Unknown';\n\t\t\tthrow error;\n\t\t} finally {\n\t\t\tthis.telemetryService.publicLog2<\n\t\t\t\t{\n\t\t\t\t\textension: string;\n\t\t\t\t\terrorCode?: string;\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\towner: 'sandy081';\n\t\t\t\t\tcomment: 'Report the fallback to the unpkg service for getting latest extension';\n\t\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Extension id' };\n\t\t\t\t\terrorCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The error code in case of error' };\n\t\t\t\t}>('galleryService:fallbacktounpkg', {\n\t\t\t\t\textension: extensionInfo.id,\n\t\t\t\t\terrorCode,\n\t\t\t\t});\n\t\t}\n\t}\n\n\tprivate async getLatestRawGalleryExtension(extension: string, uri: URI, token: CancellationToken): Promise<IRawGalleryExtension | null> {\n\t\tlet context;\n\t\tlet errorCode: string | undefined;\n\t\tconst stopWatch = new StopWatch();\n\n\t\ttry {\n\t\t\tconst commonHeaders = await this.commonHeadersPromise;\n\t\t\tconst headers = {\n\t\t\t\t...commonHeaders,\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\t'Accept': 'application/json;api-version=7.2-preview',\n\t\t\t\t'Accept-Encoding': 'gzip',\n\t\t\t};\n\n\t\t\tcontext = await this.requestService.request({\n\t\t\t\ttype: 'GET',\n\t\t\t\turl: uri.toString(true),\n\t\t\t\theaders,\n\t\t\t\ttimeout: this.getRequestTimeout()\n\t\t\t}, token);\n\n\t\t\tif (context.res.statusCode === 404) {\n\t\t\t\terrorCode = 'NotFound';\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tif (context.res.statusCode && context.res.statusCode !== 200) {\n\t\t\t\tthrow new Error('Unexpected HTTP response: ' + context.res.statusCode);\n\t\t\t}\n\n\t\t\tconst result = await asJson<IRawGalleryExtension>(context);\n\t\t\tif (!result) {\n\t\t\t\terrorCode = 'NoData';\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tcatch (error) {\n\t\t\tlet galleryErrorCode: ExtensionGalleryErrorCode;\n\t\t\tif (isCancellationError(error)) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.Cancelled;\n\t\t\t} else if (isOfflineError(error)) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.Offline;\n\t\t\t} else if (getErrorMessage(error).startsWith('XHR timeout')) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.Timeout;\n\t\t\t} else if (context && isClientError(context)) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.ClientError;\n\t\t\t} else if (context && isServerError(context)) {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.ServerError;\n\t\t\t} else {\n\t\t\t\tgalleryErrorCode = ExtensionGalleryErrorCode.Failed;\n\t\t\t}\n\t\t\terrorCode = galleryErrorCode;\n\t\t\tthrow new ExtensionGalleryError(error, galleryErrorCode);\n\t\t}\n\n\t\tfinally {\n\t\t\ttype GalleryServiceGetLatestEventClassification = {\n\t\t\t\towner: 'sandy081';\n\t\t\t\tcomment: 'Report the query to the Marketplace for fetching latest version of an extension';\n\t\t\t\thost: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The host of the end point' };\n\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The identifier of the extension' };\n\t\t\t\tduration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; isMeasurement: true; comment: 'Duration in ms for the query' };\n\t\t\t\terrorCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The error code in case of error' };\n\t\t\t\tstatusCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; comment: 'The status code in case of error' };\n\t\t\t\tserver?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The server of the end point' };\n\t\t\t\tactivityId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The activity ID of the request' };\n\t\t\t\tendToEndId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'The end-to-end ID of the request' };\n\t\t\t};\n\t\t\ttype GalleryServiceGetLatestEvent = {\n\t\t\t\textension: string;\n\t\t\t\thost: string;\n\t\t\t\tduration: number;\n\t\t\t\terrorCode?: string;\n\t\t\t\tstatusCode?: string;\n\t\t\t\tserver?: TelemetryTrustedValue<string>;\n\t\t\t\tactivityId?: TelemetryTrustedValue<string>;\n\t\t\t\tendToEndId?: TelemetryTrustedValue<string>;\n\t\t\t};\n\t\t\tthis.telemetryService.publicLog2<GalleryServiceGetLatestEvent, GalleryServiceGetLatestEventClassification>('galleryService:getLatest', {\n\t\t\t\textension,\n\t\t\t\thost: uri.authority,\n\t\t\t\tduration: stopWatch.elapsed(),\n\t\t\t\terrorCode,\n\t\t\t\tstatusCode: context?.res.statusCode && context?.res.statusCode !== 200 ? `${context.res.statusCode}` : undefined,\n\t\t\t\tserver: this.getHeaderValue(context?.res.headers, SERVER_HEADER_NAME),\n\t\t\t\tactivityId: this.getHeaderValue(context?.res.headers, ACTIVITY_HEADER_NAME),\n\t\t\t\tendToEndId: this.getHeaderValue(context?.res.headers, END_END_ID_HEADER_NAME),\n\t\t\t});\n\t\t}\n\t}\n\n\tasync reportStatistic(publisher: string, name: string, version: string, type: StatisticType): Promise<void> {\n\t\tconst manifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\t\tif (!manifest) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tlet url: string;\n\n\t\tif (isWeb) {\n\t\t\tconst resource = getExtensionGalleryManifestResourceUri(manifest, ExtensionGalleryResourceType.WebExtensionStatisticsUri);\n\t\t\tif (!resource) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\turl = format2(resource, { publisher, name, version, statTypeValue: type === StatisticType.Install ? '1' : '3' });\n\t\t} else {\n\t\t\tconst resource = getExtensionGalleryManifestResourceUri(manifest, ExtensionGalleryResourceType.ExtensionStatisticsUri);\n\t\t\tif (!resource) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\turl = format2(resource, { publisher, name, version, statTypeName: type });\n\t\t}\n\n\t\tconst Accept = isWeb ? 'api-version=6.1-preview.1' : '*/*;api-version=4.0-preview.1';\n\t\tconst commonHeaders = await this.commonHeadersPromise;\n\t\tconst headers = { ...commonHeaders, Accept };\n\t\ttry {\n\t\t\tawait this.requestService.request({\n\t\t\t\ttype: 'POST',\n\t\t\t\turl,\n\t\t\t\theaders\n\t\t\t}, CancellationToken.None);\n\t\t} catch (error) { /* Ignore */ }\n\t}\n\n\tasync download(extension: IGalleryExtension, location: URI, operation: InstallOperation): Promise<void> {\n\t\tthis.logService.trace('ExtensionGalleryService#download', extension.identifier.id);\n\t\tconst data = getGalleryExtensionTelemetryData(extension);\n\t\tconst startTime = new Date().getTime();\n\n\t\tconst operationParam = operation === InstallOperation.Install ? 'install' : operation === InstallOperation.Update ? 'update' : '';\n\t\tconst downloadAsset = operationParam ? {\n\t\t\turi: `${extension.assets.download.uri}${URI.parse(extension.assets.download.uri).query ? '&' : '?'}${operationParam}=true`,\n\t\t\tfallbackUri: `${extension.assets.download.fallbackUri}${URI.parse(extension.assets.download.fallbackUri).query ? '&' : '?'}${operationParam}=true`\n\t\t} : extension.assets.download;\n\n\t\tconst activityId = extension.queryContext?.[SEARCH_ACTIVITY_HEADER_NAME];\n\t\tconst headers: IHeaders | undefined = activityId && typeof activityId === 'string' ? { [SEARCH_ACTIVITY_HEADER_NAME]: activityId } : undefined;\n\t\tconst context = await this.getAsset(extension.identifier.id, downloadAsset, AssetType.VSIX, extension.version, headers ? { headers } : undefined);\n\n\t\ttry {\n\t\t\tawait this.fileService.writeFile(location, context.stream);\n\t\t} catch (error) {\n\t\t\ttry {\n\t\t\t\tawait this.fileService.del(location);\n\t\t\t} catch (e) {\n\t\t\t\t/* ignore */\n\t\t\t\tthis.logService.warn(`Error while deleting the file ${location.toString()}`, getErrorMessage(e));\n\t\t\t}\n\t\t\tthrow new ExtensionGalleryError(getErrorMessage(error), ExtensionGalleryErrorCode.DownloadFailedWriting);\n\t\t}\n\n\t\t/* __GDPR__\n\t\t\t\"galleryService:downloadVSIX\" : {\n\t\t\t\t\"owner\": \"sandy081\",\n\t\t\t\t\"duration\": { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true },\n\t\t\t\t\"${include}\": [\n\t\t\t\t\t\"${GalleryExtensionTelemetryData}\"\n\t\t\t\t]\n\t\t\t}\n\t\t*/\n\t\tthis.telemetryService.publicLog('galleryService:downloadVSIX', { ...data, duration: new Date().getTime() - startTime });\n\t}\n\n\tasync downloadSignatureArchive(extension: IGalleryExtension, location: URI): Promise<void> {\n\t\tif (!extension.assets.signature) {\n\t\t\tthrow new Error('No signature asset found');\n\t\t}\n\n\t\tthis.logService.trace('ExtensionGalleryService#downloadSignatureArchive', extension.identifier.id);\n\n\t\tconst context = await this.getAsset(extension.identifier.id, extension.assets.signature, AssetType.Signature, extension.version);\n\t\ttry {\n\t\t\tawait this.fileService.writeFile(location, context.stream);\n\t\t} catch (error) {\n\t\t\ttry {\n\t\t\t\tawait this.fileService.del(location);\n\t\t\t} catch (e) {\n\t\t\t\t/* ignore */\n\t\t\t\tthis.logService.warn(`Error while deleting the file ${location.toString()}`, getErrorMessage(e));\n\t\t\t}\n\t\t\tthrow new ExtensionGalleryError(getErrorMessage(error), ExtensionGalleryErrorCode.DownloadFailedWriting);\n\t\t}\n\n\t}\n\n\tasync getReadme(extension: IGalleryExtension, token: CancellationToken): Promise<string> {\n\t\tif (extension.assets.readme) {\n\t\t\tconst context = await this.getAsset(extension.identifier.id, extension.assets.readme, AssetType.Details, extension.version, {}, token);\n\t\t\tconst content = await asTextOrError(context);\n\t\t\treturn content || '';\n\t\t}\n\t\treturn '';\n\t}\n\n\tasync getManifest(extension: IGalleryExtension, token: CancellationToken): Promise<IExtensionManifest | null> {\n\t\tif (extension.assets.manifest) {\n\t\t\tconst context = await this.getAsset(extension.identifier.id, extension.assets.manifest, AssetType.Manifest, extension.version, {}, token);\n\t\t\tconst text = await asTextOrError(context);\n\t\t\treturn text ? JSON.parse(text) : null;\n\t\t}\n\t\treturn null;\n\t}\n\n\tasync getCoreTranslation(extension: IGalleryExtension, languageId: string): Promise<ITranslation | null> {\n\t\tconst asset = extension.assets.coreTranslations.filter(t => t[0] === languageId.toUpperCase())[0];\n\t\tif (asset) {\n\t\t\tconst context = await this.getAsset(extension.identifier.id, asset[1], asset[0], extension.version);\n\t\t\tconst text = await asTextOrError(context);\n\t\t\treturn text ? JSON.parse(text) : null;\n\t\t}\n\t\treturn null;\n\t}\n\n\tasync getChangelog(extension: IGalleryExtension, token: CancellationToken): Promise<string> {\n\t\tif (extension.assets.changelog) {\n\t\t\tconst context = await this.getAsset(extension.identifier.id, extension.assets.changelog, AssetType.Changelog, extension.version, {}, token);\n\t\t\tconst content = await asTextOrError(context);\n\t\t\treturn content || '';\n\t\t}\n\t\treturn '';\n\t}\n\n\tasync getAllVersions(extensionIdentifier: IExtensionIdentifier): Promise<IGalleryExtensionVersion[]> {\n\t\treturn this.getVersions(extensionIdentifier);\n\t}\n\n\tasync getAllCompatibleVersions(extensionIdentifier: IExtensionIdentifier, includePreRelease: boolean, targetPlatform: TargetPlatform): Promise<IGalleryExtensionVersion[]> {\n\t\treturn this.getVersions(extensionIdentifier, { version: includePreRelease ? VersionKind.Latest : VersionKind.Release, targetPlatform });\n\t}\n\n\tprivate async getVersions(extensionIdentifier: IExtensionIdentifier, onlyCompatible?: { version: VersionKind; targetPlatform: TargetPlatform }): Promise<IGalleryExtensionVersion[]> {\n\t\tconst extensionGalleryManifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\t\tif (!extensionGalleryManifest) {\n\t\t\tthrow new Error('No extension gallery service configured.');\n\t\t}\n\n\t\tlet query = new Query()\n\t\t\t.withFlags(Flag.IncludeVersions, Flag.IncludeCategoryAndTags, Flag.IncludeFiles, Flag.IncludeVersionProperties)\n\t\t\t.withPage(1, 1);\n\n\t\tif (extensionIdentifier.uuid) {\n\t\t\tquery = query.withFilter(FilterType.ExtensionId, extensionIdentifier.uuid);\n\t\t} else {\n\t\t\tquery = query.withFilter(FilterType.ExtensionName, extensionIdentifier.id);\n\t\t}\n\n\t\tconst { galleryExtensions } = await this.queryRawGalleryExtensions(query, extensionGalleryManifest, CancellationToken.None);\n\t\tif (!galleryExtensions.length) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst allTargetPlatforms = getAllTargetPlatforms(galleryExtensions[0]);\n\t\tif (onlyCompatible && isNotWebExtensionInWebTargetPlatform(allTargetPlatforms, onlyCompatible.targetPlatform)) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst versions: IRawGalleryExtensionVersion[] = [];\n\t\tconst productVersion = { version: this.productService.version, date: this.productService.date };\n\t\tawait Promise.all(galleryExtensions[0].versions.map(async (version) => {\n\t\t\ttry {\n\t\t\t\tif (\n\t\t\t\t\t(await this.isValidVersion(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: extensionIdentifier.id,\n\t\t\t\t\t\t\tversion: version.version,\n\t\t\t\t\t\t\tisPreReleaseVersion: isPreReleaseVersion(version),\n\t\t\t\t\t\t\ttargetPlatform: getTargetPlatformForExtensionVersion(version),\n\t\t\t\t\t\t\tengine: getEngine(version),\n\t\t\t\t\t\t\tmanifestAsset: getVersionAsset(version, AssetType.Manifest),\n\t\t\t\t\t\t\tenabledApiProposals: getEnabledApiProposals(version)\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcompatible: !!onlyCompatible,\n\t\t\t\t\t\t\tproductVersion,\n\t\t\t\t\t\t\ttargetPlatform: onlyCompatible?.targetPlatform,\n\t\t\t\t\t\t\tversion: onlyCompatible?.version ?? version.version\n\t\t\t\t\t\t},\n\t\t\t\t\t\tgalleryExtensions[0].publisher.displayName,\n\t\t\t\t\t\tallTargetPlatforms))\n\t\t\t\t) {\n\t\t\t\t\tversions.push(version);\n\t\t\t\t}\n\t\t\t} catch (error) { /* Ignore error and skip version */ }\n\t\t}));\n\n\t\tconst result: IGalleryExtensionVersion[] = [];\n\t\tconst seen = new Map<string, number>();\n\t\tfor (const version of sortExtensionVersions(versions, onlyCompatible?.targetPlatform ?? CURRENT_TARGET_PLATFORM)) {\n\t\t\tconst index = seen.get(version.version);\n\t\t\tconst existing = index !== undefined ? result[index] : undefined;\n\t\t\tconst targetPlatform = getTargetPlatformForExtensionVersion(version);\n\t\t\tif (!existing) {\n\t\t\t\tseen.set(version.version, result.length);\n\t\t\t\tresult.push({ version: version.version, date: version.lastUpdated, isPreReleaseVersion: isPreReleaseVersion(version), targetPlatforms: [targetPlatform] });\n\t\t\t} else {\n\t\t\t\texisting.targetPlatforms.push(targetPlatform);\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprivate async getAsset(extension: string, asset: IGalleryExtensionAsset, assetType: string, extensionVersion: string, options: IRequestOptions = {}, token: CancellationToken = CancellationToken.None): Promise<IRequestContext> {\n\t\tconst commonHeaders = await this.commonHeadersPromise;\n\t\tconst baseOptions = { type: 'GET' };\n\t\tconst headers = { ...commonHeaders, ...(options.headers || {}) };\n\t\toptions = { ...options, ...baseOptions, headers };\n\n\t\tconst url = asset.uri;\n\t\tconst fallbackUrl = asset.fallbackUri;\n\t\tconst firstOptions = { ...options, url, timeout: this.getRequestTimeout() };\n\n\t\tlet context;\n\t\ttry {\n\t\t\tcontext = await this.requestService.request(firstOptions, token);\n\t\t\tif (context.res.statusCode === 200) {\n\t\t\t\treturn context;\n\t\t\t}\n\t\t\tconst message = await asTextOrError(context);\n\t\t\tthrow new Error(`Expected 200, got back ${context.res.statusCode} instead.\\n\\n${message}`);\n\t\t} catch (err) {\n\t\t\tif (isCancellationError(err)) {\n\t\t\t\tthrow err;\n\t\t\t}\n\n\t\t\tconst message = getErrorMessage(err);\n\t\t\ttype GalleryServiceCDNFallbackClassification = {\n\t\t\t\towner: 'sandy081';\n\t\t\t\tcomment: 'Fallback request information when the primary asset request to CDN fails';\n\t\t\t\textension: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'extension name' };\n\t\t\t\tassetType: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'asset that failed' };\n\t\t\t\tmessage: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'error message' };\n\t\t\t\textensionVersion: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'version' };\n\t\t\t\treadonly server?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'server that handled the query' };\n\t\t\t\treadonly endToEndId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'end to end operation id' };\n\t\t\t\treadonly activityId?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'activity id' };\n\t\t\t};\n\t\t\ttype GalleryServiceCDNFallbackEvent = {\n\t\t\t\textension: string;\n\t\t\t\tassetType: string;\n\t\t\t\tmessage: string;\n\t\t\t\textensionVersion: string;\n\t\t\t\tserver?: TelemetryTrustedValue<string>;\n\t\t\t\tendToEndId?: TelemetryTrustedValue<string>;\n\t\t\t\tactivityId?: TelemetryTrustedValue<string>;\n\t\t\t};\n\t\t\tthis.telemetryService.publicLog2<GalleryServiceCDNFallbackEvent, GalleryServiceCDNFallbackClassification>('galleryService:cdnFallback', {\n\t\t\t\textension,\n\t\t\t\tassetType,\n\t\t\t\tmessage,\n\t\t\t\textensionVersion,\n\t\t\t\tserver: this.getHeaderValue(context?.res.headers, SERVER_HEADER_NAME),\n\t\t\t\tactivityId: this.getHeaderValue(context?.res.headers, ACTIVITY_HEADER_NAME),\n\t\t\t\tendToEndId: this.getHeaderValue(context?.res.headers, END_END_ID_HEADER_NAME),\n\t\t\t});\n\n\t\t\tconst fallbackOptions = { ...options, url: fallbackUrl, timeout: this.getRequestTimeout() };\n\t\t\treturn this.requestService.request(fallbackOptions, token);\n\t\t}\n\t}\n\n\tasync getExtensionsControlManifest(): Promise<IExtensionsControlManifest> {\n\t\tconst manifest = await this.extensionGalleryManifestService.getExtensionGalleryManifest();\n\t\tif (!manifest) {\n\t\t\tthrow new Error('No extension gallery service configured.');\n\t\t}\n\n\n\t\tif (!this.extensionsControlUrl) {\n\t\t\treturn { malicious: [], deprecated: {}, search: [], autoUpdate: {} };\n\t\t}\n\n\t\tconst context = await this.requestService.request({\n\t\t\ttype: 'GET',\n\t\t\turl: this.extensionsControlUrl,\n\t\t\ttimeout: this.getRequestTimeout()\n\t\t}, CancellationToken.None);\n\n\t\tif (context.res.statusCode !== 200) {\n\t\t\tthrow new Error('Could not get extensions report.');\n\t\t}\n\n\t\tconst result = await asJson<IRawExtensionsControlManifest>(context);\n\t\tconst malicious: Array<MaliciousExtensionInfo> = [];\n\t\tconst deprecated: IStringDictionary<IDeprecationInfo> = {};\n\t\tconst search: ISearchPrefferedResults[] = [];\n\t\tconst autoUpdate: IStringDictionary<string> = result?.autoUpdate ?? {};\n\t\tif (result) {\n\t\t\tfor (const id of result.malicious) {\n\t\t\t\tif (!isString(id)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst publisherOrExtension = EXTENSION_IDENTIFIER_REGEX.test(id) ? { id } : id;\n\t\t\t\tmalicious.push({ extensionOrPublisher: publisherOrExtension, learnMoreLink: result.learnMoreLinks?.[id] });\n\t\t\t}\n\t\t\tif (result.migrateToPreRelease) {\n\t\t\t\tfor (const [unsupportedPreReleaseExtensionId, preReleaseExtensionInfo] of Object.entries(result.migrateToPreRelease)) {\n\t\t\t\t\tif (!preReleaseExtensionInfo.engine || isEngineValid(preReleaseExtensionInfo.engine, this.productService.version, this.productService.date)) {\n\t\t\t\t\t\tdeprecated[unsupportedPreReleaseExtensionId.toLowerCase()] = {\n\t\t\t\t\t\t\tdisallowInstall: true,\n\t\t\t\t\t\t\textension: {\n\t\t\t\t\t\t\t\tid: preReleaseExtensionInfo.id,\n\t\t\t\t\t\t\t\tdisplayName: preReleaseExtensionInfo.displayName,\n\t\t\t\t\t\t\t\tautoMigrate: { storage: !!preReleaseExtensionInfo.migrateStorage },\n\t\t\t\t\t\t\t\tpreRelease: true\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (result.deprecated) {\n\t\t\t\tfor (const [deprecatedExtensionId, deprecationInfo] of Object.entries(result.deprecated)) {\n\t\t\t\t\tif (deprecationInfo) {\n\t\t\t\t\t\tdeprecated[deprecatedExtensionId.toLowerCase()] = isBoolean(deprecationInfo) ? {} : deprecationInfo;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (result.search) {\n\t\t\t\tfor (const s of result.search) {\n\t\t\t\t\tsearch.push(s);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn { malicious, deprecated, search, autoUpdate };\n\t}\n\n\tprivate getRequestTimeout(): number {\n\t\tconst configuredTimeout = this.configurationService.getValue<number>(ExtensionRequestsTimeoutConfigKey);\n\t\treturn isNumber(configuredTimeout) && configuredTimeout >= 0 ? configuredTimeout : 60_000;\n\t}\n\n}\n\nexport class ExtensionGalleryService extends AbstractExtensionGalleryService {\n\n\tconstructor(\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IRequestService requestService: IRequestService,\n\t\t@ILogService logService: ILogService,\n\t\t@IEnvironmentService environmentService: IEnvironmentService,\n\t\t@ITelemetryService telemetryService: ITelemetryService,\n\t\t@IFileService fileService: IFileService,\n\t\t@IProductService productService: IProductService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@IAllowedExtensionsService allowedExtensionsService: IAllowedExtensionsService,\n\t\t@IExtensionGalleryManifestService extensionGalleryManifestService: IExtensionGalleryManifestService,\n\t) {\n\t\tsuper(storageService, requestService, logService, environmentService, telemetryService, fileService, productService, configurationService, allowedExtensionsService, extensionGalleryManifestService);\n\t}\n}\n\nexport class ExtensionGalleryServiceWithNoStorageService extends AbstractExtensionGalleryService {\n\n\tconstructor(\n\t\t@IRequestService requestService: IRequestService,\n\t\t@ILogService logService: ILogService,\n\t\t@IEnvironmentService environmentService: IEnvironmentService,\n\t\t@ITelemetryService telemetryService: ITelemetryService,\n\t\t@IFileService fileService: IFileService,\n\t\t@IProductService productService: IProductService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@IAllowedExtensionsService allowedExtensionsService: IAllowedExtensionsService,\n\t\t@IExtensionGalleryManifestService extensionGalleryManifestService: IExtensionGalleryManifestService,\n\t) {\n\t\tsuper(undefined, requestService, logService, environmentService, telemetryService, fileService, productService, configurationService, allowedExtensionsService, extensionGalleryManifestService);\n\t}\n}\n"]}