{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/extensionManagement/node/extensionSignatureVerificationService.ts","vs/platform/extensionManagement/node/extensionSignatureVerificationService.ts"],"names":[],"mappings":"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","file":"extensionSignatureVerificationService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { getErrorMessage } from '../../../base/common/errors.js';\nimport { isDefined } from '../../../base/common/types.js';\nimport { TargetPlatform } from '../../extensions/common/extensions.js';\nimport { createDecorator } from '../../instantiation/common/instantiation.js';\nimport { ILogService, LogLevel } from '../../log/common/log.js';\nimport { ITelemetryService } from '../../telemetry/common/telemetry.js';\nimport { ExtensionSignatureVerificationCode } from '../common/extensionManagement.js';\n\nexport const IExtensionSignatureVerificationService = createDecorator<IExtensionSignatureVerificationService>('IExtensionSignatureVerificationService');\n\nexport interface IExtensionSignatureVerificationResult {\n\treadonly code: ExtensionSignatureVerificationCode;\n}\n\n/**\n * A service for verifying signed extensions.\n */\nexport interface IExtensionSignatureVerificationService {\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * Verifies an extension file (.vsix) against a signature archive file.\n\t * @param extensionId The extension identifier.\n\t * @param version The extension version.\n\t * @param vsixFilePath The extension file path.\n\t * @param signatureArchiveFilePath The signature archive file path.\n\t * @returns returns the verification result or undefined if the verification was not executed.\n\t */\n\tverify(extensionId: string, version: string, vsixFilePath: string, signatureArchiveFilePath: string, clientTargetPlatform?: TargetPlatform): Promise<IExtensionSignatureVerificationResult | undefined>;\n}\n\ndeclare module vsceSign {\n\texport function verify(vsixFilePath: string, signatureArchiveFilePath: string, verbose: boolean): Promise<ExtensionSignatureVerificationResult>;\n}\n\n/**\n * Extension signature verification result\n */\nexport interface ExtensionSignatureVerificationResult {\n\treadonly code: ExtensionSignatureVerificationCode;\n\treadonly didExecute: boolean;\n\treadonly internalCode?: number;\n\treadonly output?: string;\n}\n\nexport class ExtensionSignatureVerificationService implements IExtensionSignatureVerificationService {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate moduleLoadingPromise: Promise<typeof vsceSign> | undefined;\n\n\tconstructor(\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t) { }\n\n\tprivate vsceSign(): Promise<typeof vsceSign> {\n\t\tif (!this.moduleLoadingPromise) {\n\t\t\tthis.moduleLoadingPromise = this.resolveVsceSign();\n\t\t}\n\n\t\treturn this.moduleLoadingPromise;\n\t}\n\n\tprivate async resolveVsceSign(): Promise<typeof vsceSign> {\n\t\tconst mod = '@vscode/vsce-sign';\n\t\treturn import(mod);\n\t}\n\n\tpublic async verify(extensionId: string, version: string, vsixFilePath: string, signatureArchiveFilePath: string, clientTargetPlatform?: TargetPlatform): Promise<IExtensionSignatureVerificationResult | undefined> {\n\t\tlet module: typeof vsceSign;\n\n\t\ttry {\n\t\t\tmodule = await this.vsceSign();\n\t\t} catch (error) {\n\t\t\tthis.logService.error('Could not load vsce-sign module', getErrorMessage(error));\n\t\t\tthis.logService.info(`Extension signature verification is not done: ${extensionId}`);\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst startTime = new Date().getTime();\n\t\tlet result: ExtensionSignatureVerificationResult;\n\n\t\ttry {\n\t\t\tthis.logService.trace(`Verifying extension signature for ${extensionId}...`);\n\t\t\tresult = await module.verify(vsixFilePath, signatureArchiveFilePath, this.logService.getLevel() === LogLevel.Trace);\n\t\t} catch (e) {\n\t\t\tresult = {\n\t\t\t\tcode: ExtensionSignatureVerificationCode.UnknownError,\n\t\t\t\tdidExecute: false,\n\t\t\t\toutput: getErrorMessage(e)\n\t\t\t};\n\t\t}\n\n\t\tconst duration = new Date().getTime() - startTime;\n\n\t\tthis.logService.info(`Extension signature verification result for ${extensionId}: ${result.code}. ${isDefined(result.internalCode) ? `Internal Code: ${result.internalCode}. ` : ''}Executed: ${result.didExecute}. Duration: ${duration}ms.`);\n\t\tthis.logService.trace(`Extension signature verification output for ${extensionId}:\\n${result.output}`);\n\n\t\ttype ExtensionSignatureVerificationClassification = {\n\t\t\towner: 'sandy081';\n\t\t\tcomment: 'Extension signature verification event';\n\t\t\textensionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'extension identifier' };\n\t\t\textensionVersion: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'extension version' };\n\t\t\tcode: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'result code of the verification' };\n\t\t\tinternalCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; 'isMeasurement': true; comment: 'internal code of the verification' };\n\t\t\tduration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; 'isMeasurement': true; comment: 'amount of time taken to verify the signature' };\n\t\t\tdidExecute: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'whether the verification was executed' };\n\t\t\tclientTargetPlatform?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'target platform of the client' };\n\t\t};\n\t\ttype ExtensionSignatureVerificationEvent = {\n\t\t\textensionId: string;\n\t\t\textensionVersion: string;\n\t\t\tcode: string;\n\t\t\tinternalCode?: number;\n\t\t\tduration: number;\n\t\t\tdidExecute: boolean;\n\t\t\tclientTargetPlatform?: string;\n\t\t};\n\t\tthis.telemetryService.publicLog2<ExtensionSignatureVerificationEvent, ExtensionSignatureVerificationClassification>('extensionsignature:verification', {\n\t\t\textensionId,\n\t\t\textensionVersion: version,\n\t\t\tcode: result.code,\n\t\t\tinternalCode: result.internalCode,\n\t\t\tduration,\n\t\t\tdidExecute: result.didExecute,\n\t\t\tclientTargetPlatform,\n\t\t});\n\n\t\treturn { code: result.code };\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { getErrorMessage } from '../../../base/common/errors.js';\nimport { isDefined } from '../../../base/common/types.js';\nimport { TargetPlatform } from '../../extensions/common/extensions.js';\nimport { createDecorator } from '../../instantiation/common/instantiation.js';\nimport { ILogService, LogLevel } from '../../log/common/log.js';\nimport { ITelemetryService } from '../../telemetry/common/telemetry.js';\nimport { ExtensionSignatureVerificationCode } from '../common/extensionManagement.js';\n\nexport const IExtensionSignatureVerificationService = createDecorator<IExtensionSignatureVerificationService>('IExtensionSignatureVerificationService');\n\nexport interface IExtensionSignatureVerificationResult {\n\treadonly code: ExtensionSignatureVerificationCode;\n}\n\n/**\n * A service for verifying signed extensions.\n */\nexport interface IExtensionSignatureVerificationService {\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * Verifies an extension file (.vsix) against a signature archive file.\n\t * @param extensionId The extension identifier.\n\t * @param version The extension version.\n\t * @param vsixFilePath The extension file path.\n\t * @param signatureArchiveFilePath The signature archive file path.\n\t * @returns returns the verification result or undefined if the verification was not executed.\n\t */\n\tverify(extensionId: string, version: string, vsixFilePath: string, signatureArchiveFilePath: string, clientTargetPlatform?: TargetPlatform): Promise<IExtensionSignatureVerificationResult | undefined>;\n}\n\ndeclare module vsceSign {\n\texport function verify(vsixFilePath: string, signatureArchiveFilePath: string, verbose: boolean): Promise<ExtensionSignatureVerificationResult>;\n}\n\n/**\n * Extension signature verification result\n */\nexport interface ExtensionSignatureVerificationResult {\n\treadonly code: ExtensionSignatureVerificationCode;\n\treadonly didExecute: boolean;\n\treadonly internalCode?: number;\n\treadonly output?: string;\n}\n\nexport class ExtensionSignatureVerificationService implements IExtensionSignatureVerificationService {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate moduleLoadingPromise: Promise<typeof vsceSign> | undefined;\n\n\tconstructor(\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t) { }\n\n\tprivate vsceSign(): Promise<typeof vsceSign> {\n\t\tif (!this.moduleLoadingPromise) {\n\t\t\tthis.moduleLoadingPromise = this.resolveVsceSign();\n\t\t}\n\n\t\treturn this.moduleLoadingPromise;\n\t}\n\n\tprivate async resolveVsceSign(): Promise<typeof vsceSign> {\n\t\tconst mod = '@vscode/vsce-sign';\n\t\treturn import(mod);\n\t}\n\n\tpublic async verify(extensionId: string, version: string, vsixFilePath: string, signatureArchiveFilePath: string, clientTargetPlatform?: TargetPlatform): Promise<IExtensionSignatureVerificationResult | undefined> {\n\t\tlet module: typeof vsceSign;\n\n\t\ttry {\n\t\t\tmodule = await this.vsceSign();\n\t\t} catch (error) {\n\t\t\tthis.logService.error('Could not load vsce-sign module', getErrorMessage(error));\n\t\t\tthis.logService.info(`Extension signature verification is not done: ${extensionId}`);\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst startTime = new Date().getTime();\n\t\tlet result: ExtensionSignatureVerificationResult;\n\n\t\ttry {\n\t\t\tthis.logService.trace(`Verifying extension signature for ${extensionId}...`);\n\t\t\tresult = await module.verify(vsixFilePath, signatureArchiveFilePath, this.logService.getLevel() === LogLevel.Trace);\n\t\t} catch (e) {\n\t\t\tresult = {\n\t\t\t\tcode: ExtensionSignatureVerificationCode.UnknownError,\n\t\t\t\tdidExecute: false,\n\t\t\t\toutput: getErrorMessage(e)\n\t\t\t};\n\t\t}\n\n\t\tconst duration = new Date().getTime() - startTime;\n\n\t\tthis.logService.info(`Extension signature verification result for ${extensionId}: ${result.code}. ${isDefined(result.internalCode) ? `Internal Code: ${result.internalCode}. ` : ''}Executed: ${result.didExecute}. Duration: ${duration}ms.`);\n\t\tthis.logService.trace(`Extension signature verification output for ${extensionId}:\\n${result.output}`);\n\n\t\ttype ExtensionSignatureVerificationClassification = {\n\t\t\towner: 'sandy081';\n\t\t\tcomment: 'Extension signature verification event';\n\t\t\textensionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'extension identifier' };\n\t\t\textensionVersion: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'extension version' };\n\t\t\tcode: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'result code of the verification' };\n\t\t\tinternalCode?: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; 'isMeasurement': true; comment: 'internal code of the verification' };\n\t\t\tduration: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; 'isMeasurement': true; comment: 'amount of time taken to verify the signature' };\n\t\t\tdidExecute: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'whether the verification was executed' };\n\t\t\tclientTargetPlatform?: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'target platform of the client' };\n\t\t};\n\t\ttype ExtensionSignatureVerificationEvent = {\n\t\t\textensionId: string;\n\t\t\textensionVersion: string;\n\t\t\tcode: string;\n\t\t\tinternalCode?: number;\n\t\t\tduration: number;\n\t\t\tdidExecute: boolean;\n\t\t\tclientTargetPlatform?: string;\n\t\t};\n\t\tthis.telemetryService.publicLog2<ExtensionSignatureVerificationEvent, ExtensionSignatureVerificationClassification>('extensionsignature:verification', {\n\t\t\textensionId,\n\t\t\textensionVersion: version,\n\t\t\tcode: result.code,\n\t\t\tinternalCode: result.internalCode,\n\t\t\tduration,\n\t\t\tdidExecute: result.didExecute,\n\t\t\tclientTargetPlatform,\n\t\t});\n\n\t\treturn { code: result.code };\n\t}\n}\n"]}