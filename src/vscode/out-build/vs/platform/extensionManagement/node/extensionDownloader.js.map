{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/extensionManagement/node/extensionDownloader.ts","vs/platform/extensionManagement/node/extensionDownloader.ts"],"names":[],"mappings":"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","file":"extensionDownloader.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Promises } from '../../../base/common/async.js';\nimport { getErrorMessage } from '../../../base/common/errors.js';\nimport { Disposable } from '../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { joinPath } from '../../../base/common/resources.js';\nimport * as semver from '../../../base/common/semver/semver.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { Promises as FSPromises } from '../../../base/node/pfs.js';\nimport { buffer, CorruptZipMessage } from '../../../base/node/zip.js';\nimport { INativeEnvironmentService } from '../../environment/common/environment.js';\nimport { toExtensionManagementError } from '../common/abstractExtensionManagementService.js';\nimport { ExtensionManagementError, ExtensionManagementErrorCode, ExtensionSignatureVerificationCode, IExtensionGalleryService, IGalleryExtension, InstallOperation } from '../common/extensionManagement.js';\nimport { ExtensionKey, groupByExtension } from '../common/extensionManagementUtil.js';\nimport { fromExtractError } from './extensionManagementUtil.js';\nimport { IExtensionSignatureVerificationService } from './extensionSignatureVerificationService.js';\nimport { TargetPlatform } from '../../extensions/common/extensions.js';\nimport { FileOperationResult, IFileService, IFileStatWithMetadata, toFileOperationResult } from '../../files/common/files.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { ITelemetryService } from '../../telemetry/common/telemetry.js';\nimport { IUriIdentityService } from '../../uriIdentity/common/uriIdentity.js';\n\ntype RetryDownloadClassification = {\n\towner: 'sandy081';\n\tcomment: 'Event reporting the retry of downloading';\n\textensionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Extension Id' };\n\tattempts: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; isMeasurement: true; comment: 'Number of Attempts' };\n};\ntype RetryDownloadEvent = {\n\textensionId: string;\n\tattempts: number;\n};\n\nexport class ExtensionsDownloader extends Disposable {\n\n\tprivate static readonly SignatureArchiveExtension = '.sigzip';\n\n\treadonly extensionsDownloadDir: URI;\n\tprivate readonly extensionsTrashDir: URI;\n\tprivate readonly cache: number;\n\tprivate readonly cleanUpPromise: Promise<void>;\n\n\tconstructor(\n\t\t@INativeEnvironmentService environmentService: INativeEnvironmentService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IExtensionGalleryService private readonly extensionGalleryService: IExtensionGalleryService,\n\t\t@IExtensionSignatureVerificationService private readonly extensionSignatureVerificationService: IExtensionSignatureVerificationService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IUriIdentityService private readonly uriIdentityService: IUriIdentityService,\n\t\t@ILogService private readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t\tthis.extensionsDownloadDir = environmentService.extensionsDownloadLocation;\n\t\tthis.extensionsTrashDir = uriIdentityService.extUri.joinPath(environmentService.extensionsDownloadLocation, `.trash`);\n\t\tthis.cache = 20; // Cache 20 downloaded VSIX files\n\t\tthis.cleanUpPromise = this.cleanUp();\n\t}\n\n\tasync download(extension: IGalleryExtension, operation: InstallOperation, verifySignature: boolean, clientTargetPlatform?: TargetPlatform): Promise<{ readonly location: URI; readonly verificationStatus: ExtensionSignatureVerificationCode | undefined }> {\n\t\tawait this.cleanUpPromise;\n\n\t\tconst location = await this.downloadVSIX(extension, operation);\n\n\t\tif (!verifySignature) {\n\t\t\treturn { location, verificationStatus: undefined };\n\t\t}\n\n\t\tif (!extension.isSigned) {\n\t\t\treturn { location, verificationStatus: ExtensionSignatureVerificationCode.NotSigned };\n\t\t}\n\n\t\tlet signatureArchiveLocation;\n\t\ttry {\n\t\t\tsignatureArchiveLocation = await this.downloadSignatureArchive(extension);\n\t\t\tconst verificationStatus = (await this.extensionSignatureVerificationService.verify(extension.identifier.id, extension.version, location.fsPath, signatureArchiveLocation.fsPath, clientTargetPlatform))?.code;\n\t\t\tif (verificationStatus === ExtensionSignatureVerificationCode.PackageIsInvalidZip || verificationStatus === ExtensionSignatureVerificationCode.SignatureArchiveIsInvalidZip) {\n\t\t\t\ttry {\n\t\t\t\t\t// Delete the downloaded vsix if VSIX or signature archive is invalid\n\t\t\t\t\tawait this.delete(location);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.logService.error(error);\n\t\t\t\t}\n\t\t\t\tthrow new ExtensionManagementError(CorruptZipMessage, ExtensionManagementErrorCode.CorruptZip);\n\t\t\t}\n\t\t\treturn { location, verificationStatus };\n\t\t} catch (error) {\n\t\t\ttry {\n\t\t\t\t// Delete the downloaded VSIX if signature archive download fails\n\t\t\t\tawait this.delete(location);\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t}\n\t\t\tthrow error;\n\t\t} finally {\n\t\t\tif (signatureArchiveLocation) {\n\t\t\t\ttry {\n\t\t\t\t\t// Delete signature archive always\n\t\t\t\t\tawait this.delete(signatureArchiveLocation);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.logService.error(error);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async downloadVSIX(extension: IGalleryExtension, operation: InstallOperation): Promise<URI> {\n\t\ttry {\n\t\t\tconst location = joinPath(this.extensionsDownloadDir, this.getName(extension));\n\t\t\tconst attempts = await this.doDownload(extension, 'vsix', async () => {\n\t\t\t\tawait this.downloadFile(extension, location, location => this.extensionGalleryService.download(extension, location, operation));\n\t\t\t\ttry {\n\t\t\t\t\tawait this.validate(location.fsPath, 'extension/package.json');\n\t\t\t\t} catch (error) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.fileService.del(location);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tthis.logService.warn(`Error while deleting: ${location.path}`, getErrorMessage(e));\n\t\t\t\t\t}\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t}, 2);\n\n\t\t\tif (attempts > 1) {\n\t\t\t\tthis.telemetryService.publicLog2<RetryDownloadEvent, RetryDownloadClassification>('extensiongallery:downloadvsix:retry', {\n\t\t\t\t\textensionId: extension.identifier.id,\n\t\t\t\t\tattempts\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn location;\n\t\t} catch (e) {\n\t\t\tthrow toExtensionManagementError(e, ExtensionManagementErrorCode.Download);\n\t\t}\n\t}\n\n\tprivate async downloadSignatureArchive(extension: IGalleryExtension): Promise<URI> {\n\t\ttry {\n\t\t\tconst location = joinPath(this.extensionsDownloadDir, `${this.getName(extension)}${ExtensionsDownloader.SignatureArchiveExtension}`);\n\t\t\tconst attempts = await this.doDownload(extension, 'sigzip', async () => {\n\t\t\t\tawait this.extensionGalleryService.downloadSignatureArchive(extension, location);\n\t\t\t\ttry {\n\t\t\t\t\tawait this.validate(location.fsPath, '.signature.p7s');\n\t\t\t\t} catch (error) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.fileService.del(location);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tthis.logService.warn(`Error while deleting: ${location.path}`, getErrorMessage(e));\n\t\t\t\t\t}\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t}, 2);\n\n\t\t\tif (attempts > 1) {\n\t\t\t\tthis.telemetryService.publicLog2<RetryDownloadEvent, RetryDownloadClassification>('extensiongallery:downloadsigzip:retry', {\n\t\t\t\t\textensionId: extension.identifier.id,\n\t\t\t\t\tattempts\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn location;\n\t\t} catch (e) {\n\t\t\tthrow toExtensionManagementError(e, ExtensionManagementErrorCode.DownloadSignature);\n\t\t}\n\t}\n\n\tprivate async downloadFile(extension: IGalleryExtension, location: URI, downloadFn: (location: URI) => Promise<void>): Promise<void> {\n\t\t// Do not download if exists\n\t\tif (await this.fileService.exists(location)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Download directly if locaiton is not file scheme\n\t\tif (location.scheme !== Schemas.file) {\n\t\t\tawait downloadFn(location);\n\t\t\treturn;\n\t\t}\n\n\t\t// Download to temporary location first only if file does not exist\n\t\tconst tempLocation = joinPath(this.extensionsDownloadDir, `.${generateUuid()}`);\n\t\ttry {\n\t\t\tawait downloadFn(tempLocation);\n\t\t} catch (error) {\n\t\t\ttry {\n\t\t\t\tawait this.fileService.del(tempLocation);\n\t\t\t} catch (e) { /* ignore */ }\n\t\t\tthrow error;\n\t\t}\n\n\t\ttry {\n\t\t\t// Rename temp location to original\n\t\t\tawait FSPromises.rename(tempLocation.fsPath, location.fsPath, 2 * 60 * 1000 /* Retry for 2 minutes */);\n\t\t} catch (error) {\n\t\t\ttry { await this.fileService.del(tempLocation); } catch (e) { /* ignore */ }\n\t\t\tlet exists = false;\n\t\t\ttry { exists = await this.fileService.exists(location); } catch (e) { /* ignore */ }\n\t\t\tif (exists) {\n\t\t\t\tthis.logService.info(`Rename failed because the file was downloaded by another source. So ignoring renaming.`, extension.identifier.id, location.path);\n\t\t\t} else {\n\t\t\t\tthis.logService.info(`Rename failed because of ${getErrorMessage(error)}. Deleted the file from downloaded location`, tempLocation.path);\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async doDownload(extension: IGalleryExtension, name: string, downloadFn: () => Promise<void>, retries: number): Promise<number> {\n\t\tlet attempts = 1;\n\t\twhile (true) {\n\t\t\ttry {\n\t\t\t\tawait downloadFn();\n\t\t\t\treturn attempts;\n\t\t\t} catch (e) {\n\t\t\t\tif (attempts++ > retries) {\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t\tthis.logService.warn(`Failed downloading ${name}. ${getErrorMessage(e)}. Retry again...`, extension.identifier.id);\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected async validate(zipPath: string, filePath: string): Promise<void> {\n\t\ttry {\n\t\t\tawait buffer(zipPath, filePath);\n\t\t} catch (e) {\n\t\t\tthrow fromExtractError(e);\n\t\t}\n\t}\n\n\tasync delete(location: URI): Promise<void> {\n\t\tawait this.cleanUpPromise;\n\t\tconst trashRelativePath = this.uriIdentityService.extUri.relativePath(this.extensionsDownloadDir, location);\n\t\tif (trashRelativePath) {\n\t\t\tawait this.fileService.move(location, this.uriIdentityService.extUri.joinPath(this.extensionsTrashDir, trashRelativePath), true);\n\t\t} else {\n\t\t\tawait this.fileService.del(location);\n\t\t}\n\t}\n\n\tprivate async cleanUp(): Promise<void> {\n\t\ttry {\n\t\t\tif (!(await this.fileService.exists(this.extensionsDownloadDir))) {\n\t\t\t\tthis.logService.trace('Extension VSIX downloads cache dir does not exist');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tawait this.fileService.del(this.extensionsTrashDir, { recursive: true });\n\t\t\t} catch (error) {\n\t\t\t\tif (toFileOperationResult(error) !== FileOperationResult.FILE_NOT_FOUND) {\n\t\t\t\t\tthis.logService.error(error);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst folderStat = await this.fileService.resolve(this.extensionsDownloadDir, { resolveMetadata: true });\n\t\t\tif (folderStat.children) {\n\t\t\t\tconst toDelete: URI[] = [];\n\t\t\t\tconst vsixs: [ExtensionKey, IFileStatWithMetadata][] = [];\n\t\t\t\tconst signatureArchives: URI[] = [];\n\n\t\t\t\tfor (const stat of folderStat.children) {\n\t\t\t\t\tif (stat.name.endsWith(ExtensionsDownloader.SignatureArchiveExtension)) {\n\t\t\t\t\t\tsignatureArchives.push(stat.resource);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst extension = ExtensionKey.parse(stat.name);\n\t\t\t\t\t\tif (extension) {\n\t\t\t\t\t\t\tvsixs.push([extension, stat]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst byExtension = groupByExtension(vsixs, ([extension]) => extension);\n\t\t\t\tconst distinct: IFileStatWithMetadata[] = [];\n\t\t\t\tfor (const p of byExtension) {\n\t\t\t\t\tp.sort((a, b) => semver.rcompare(a[0].version, b[0].version));\n\t\t\t\t\ttoDelete.push(...p.slice(1).map(e => e[1].resource)); // Delete outdated extensions\n\t\t\t\t\tdistinct.push(p[0][1]);\n\t\t\t\t}\n\t\t\t\tdistinct.sort((a, b) => a.mtime - b.mtime); // sort by modified time\n\t\t\t\ttoDelete.push(...distinct.slice(0, Math.max(0, distinct.length - this.cache)).map(s => s.resource)); // Retain minimum cacheSize and delete the rest\n\t\t\t\ttoDelete.push(...signatureArchives); // Delete all signature archives\n\n\t\t\t\tawait Promises.settled(toDelete.map(resource => {\n\t\t\t\t\tthis.logService.trace('Deleting from cache', resource.path);\n\t\t\t\t\treturn this.fileService.del(resource);\n\t\t\t\t}));\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tthis.logService.error(e);\n\t\t}\n\t}\n\n\tprivate getName(extension: IGalleryExtension): string {\n\t\treturn ExtensionKey.create(extension).toString().toLowerCase();\n\t}\n\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Promises } from '../../../base/common/async.js';\nimport { getErrorMessage } from '../../../base/common/errors.js';\nimport { Disposable } from '../../../base/common/lifecycle.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { joinPath } from '../../../base/common/resources.js';\nimport * as semver from '../../../base/common/semver/semver.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { Promises as FSPromises } from '../../../base/node/pfs.js';\nimport { buffer, CorruptZipMessage } from '../../../base/node/zip.js';\nimport { INativeEnvironmentService } from '../../environment/common/environment.js';\nimport { toExtensionManagementError } from '../common/abstractExtensionManagementService.js';\nimport { ExtensionManagementError, ExtensionManagementErrorCode, ExtensionSignatureVerificationCode, IExtensionGalleryService, IGalleryExtension, InstallOperation } from '../common/extensionManagement.js';\nimport { ExtensionKey, groupByExtension } from '../common/extensionManagementUtil.js';\nimport { fromExtractError } from './extensionManagementUtil.js';\nimport { IExtensionSignatureVerificationService } from './extensionSignatureVerificationService.js';\nimport { TargetPlatform } from '../../extensions/common/extensions.js';\nimport { FileOperationResult, IFileService, IFileStatWithMetadata, toFileOperationResult } from '../../files/common/files.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { ITelemetryService } from '../../telemetry/common/telemetry.js';\nimport { IUriIdentityService } from '../../uriIdentity/common/uriIdentity.js';\n\ntype RetryDownloadClassification = {\n\towner: 'sandy081';\n\tcomment: 'Event reporting the retry of downloading';\n\textensionId: { classification: 'SystemMetaData'; purpose: 'FeatureInsight'; comment: 'Extension Id' };\n\tattempts: { classification: 'SystemMetaData'; purpose: 'PerformanceAndHealth'; isMeasurement: true; comment: 'Number of Attempts' };\n};\ntype RetryDownloadEvent = {\n\textensionId: string;\n\tattempts: number;\n};\n\nexport class ExtensionsDownloader extends Disposable {\n\n\tprivate static readonly SignatureArchiveExtension = '.sigzip';\n\n\treadonly extensionsDownloadDir: URI;\n\tprivate readonly extensionsTrashDir: URI;\n\tprivate readonly cache: number;\n\tprivate readonly cleanUpPromise: Promise<void>;\n\n\tconstructor(\n\t\t@INativeEnvironmentService environmentService: INativeEnvironmentService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@IExtensionGalleryService private readonly extensionGalleryService: IExtensionGalleryService,\n\t\t@IExtensionSignatureVerificationService private readonly extensionSignatureVerificationService: IExtensionSignatureVerificationService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IUriIdentityService private readonly uriIdentityService: IUriIdentityService,\n\t\t@ILogService private readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t\tthis.extensionsDownloadDir = environmentService.extensionsDownloadLocation;\n\t\tthis.extensionsTrashDir = uriIdentityService.extUri.joinPath(environmentService.extensionsDownloadLocation, `.trash`);\n\t\tthis.cache = 20; // Cache 20 downloaded VSIX files\n\t\tthis.cleanUpPromise = this.cleanUp();\n\t}\n\n\tasync download(extension: IGalleryExtension, operation: InstallOperation, verifySignature: boolean, clientTargetPlatform?: TargetPlatform): Promise<{ readonly location: URI; readonly verificationStatus: ExtensionSignatureVerificationCode | undefined }> {\n\t\tawait this.cleanUpPromise;\n\n\t\tconst location = await this.downloadVSIX(extension, operation);\n\n\t\tif (!verifySignature) {\n\t\t\treturn { location, verificationStatus: undefined };\n\t\t}\n\n\t\tif (!extension.isSigned) {\n\t\t\treturn { location, verificationStatus: ExtensionSignatureVerificationCode.NotSigned };\n\t\t}\n\n\t\tlet signatureArchiveLocation;\n\t\ttry {\n\t\t\tsignatureArchiveLocation = await this.downloadSignatureArchive(extension);\n\t\t\tconst verificationStatus = (await this.extensionSignatureVerificationService.verify(extension.identifier.id, extension.version, location.fsPath, signatureArchiveLocation.fsPath, clientTargetPlatform))?.code;\n\t\t\tif (verificationStatus === ExtensionSignatureVerificationCode.PackageIsInvalidZip || verificationStatus === ExtensionSignatureVerificationCode.SignatureArchiveIsInvalidZip) {\n\t\t\t\ttry {\n\t\t\t\t\t// Delete the downloaded vsix if VSIX or signature archive is invalid\n\t\t\t\t\tawait this.delete(location);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.logService.error(error);\n\t\t\t\t}\n\t\t\t\tthrow new ExtensionManagementError(CorruptZipMessage, ExtensionManagementErrorCode.CorruptZip);\n\t\t\t}\n\t\t\treturn { location, verificationStatus };\n\t\t} catch (error) {\n\t\t\ttry {\n\t\t\t\t// Delete the downloaded VSIX if signature archive download fails\n\t\t\t\tawait this.delete(location);\n\t\t\t} catch (error) {\n\t\t\t\tthis.logService.error(error);\n\t\t\t}\n\t\t\tthrow error;\n\t\t} finally {\n\t\t\tif (signatureArchiveLocation) {\n\t\t\t\ttry {\n\t\t\t\t\t// Delete signature archive always\n\t\t\t\t\tawait this.delete(signatureArchiveLocation);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.logService.error(error);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async downloadVSIX(extension: IGalleryExtension, operation: InstallOperation): Promise<URI> {\n\t\ttry {\n\t\t\tconst location = joinPath(this.extensionsDownloadDir, this.getName(extension));\n\t\t\tconst attempts = await this.doDownload(extension, 'vsix', async () => {\n\t\t\t\tawait this.downloadFile(extension, location, location => this.extensionGalleryService.download(extension, location, operation));\n\t\t\t\ttry {\n\t\t\t\t\tawait this.validate(location.fsPath, 'extension/package.json');\n\t\t\t\t} catch (error) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.fileService.del(location);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tthis.logService.warn(`Error while deleting: ${location.path}`, getErrorMessage(e));\n\t\t\t\t\t}\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t}, 2);\n\n\t\t\tif (attempts > 1) {\n\t\t\t\tthis.telemetryService.publicLog2<RetryDownloadEvent, RetryDownloadClassification>('extensiongallery:downloadvsix:retry', {\n\t\t\t\t\textensionId: extension.identifier.id,\n\t\t\t\t\tattempts\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn location;\n\t\t} catch (e) {\n\t\t\tthrow toExtensionManagementError(e, ExtensionManagementErrorCode.Download);\n\t\t}\n\t}\n\n\tprivate async downloadSignatureArchive(extension: IGalleryExtension): Promise<URI> {\n\t\ttry {\n\t\t\tconst location = joinPath(this.extensionsDownloadDir, `${this.getName(extension)}${ExtensionsDownloader.SignatureArchiveExtension}`);\n\t\t\tconst attempts = await this.doDownload(extension, 'sigzip', async () => {\n\t\t\t\tawait this.extensionGalleryService.downloadSignatureArchive(extension, location);\n\t\t\t\ttry {\n\t\t\t\t\tawait this.validate(location.fsPath, '.signature.p7s');\n\t\t\t\t} catch (error) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait this.fileService.del(location);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tthis.logService.warn(`Error while deleting: ${location.path}`, getErrorMessage(e));\n\t\t\t\t\t}\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t}, 2);\n\n\t\t\tif (attempts > 1) {\n\t\t\t\tthis.telemetryService.publicLog2<RetryDownloadEvent, RetryDownloadClassification>('extensiongallery:downloadsigzip:retry', {\n\t\t\t\t\textensionId: extension.identifier.id,\n\t\t\t\t\tattempts\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn location;\n\t\t} catch (e) {\n\t\t\tthrow toExtensionManagementError(e, ExtensionManagementErrorCode.DownloadSignature);\n\t\t}\n\t}\n\n\tprivate async downloadFile(extension: IGalleryExtension, location: URI, downloadFn: (location: URI) => Promise<void>): Promise<void> {\n\t\t// Do not download if exists\n\t\tif (await this.fileService.exists(location)) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Download directly if locaiton is not file scheme\n\t\tif (location.scheme !== Schemas.file) {\n\t\t\tawait downloadFn(location);\n\t\t\treturn;\n\t\t}\n\n\t\t// Download to temporary location first only if file does not exist\n\t\tconst tempLocation = joinPath(this.extensionsDownloadDir, `.${generateUuid()}`);\n\t\ttry {\n\t\t\tawait downloadFn(tempLocation);\n\t\t} catch (error) {\n\t\t\ttry {\n\t\t\t\tawait this.fileService.del(tempLocation);\n\t\t\t} catch (e) { /* ignore */ }\n\t\t\tthrow error;\n\t\t}\n\n\t\ttry {\n\t\t\t// Rename temp location to original\n\t\t\tawait FSPromises.rename(tempLocation.fsPath, location.fsPath, 2 * 60 * 1000 /* Retry for 2 minutes */);\n\t\t} catch (error) {\n\t\t\ttry { await this.fileService.del(tempLocation); } catch (e) { /* ignore */ }\n\t\t\tlet exists = false;\n\t\t\ttry { exists = await this.fileService.exists(location); } catch (e) { /* ignore */ }\n\t\t\tif (exists) {\n\t\t\t\tthis.logService.info(`Rename failed because the file was downloaded by another source. So ignoring renaming.`, extension.identifier.id, location.path);\n\t\t\t} else {\n\t\t\t\tthis.logService.info(`Rename failed because of ${getErrorMessage(error)}. Deleted the file from downloaded location`, tempLocation.path);\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async doDownload(extension: IGalleryExtension, name: string, downloadFn: () => Promise<void>, retries: number): Promise<number> {\n\t\tlet attempts = 1;\n\t\twhile (true) {\n\t\t\ttry {\n\t\t\t\tawait downloadFn();\n\t\t\t\treturn attempts;\n\t\t\t} catch (e) {\n\t\t\t\tif (attempts++ > retries) {\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t\tthis.logService.warn(`Failed downloading ${name}. ${getErrorMessage(e)}. Retry again...`, extension.identifier.id);\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected async validate(zipPath: string, filePath: string): Promise<void> {\n\t\ttry {\n\t\t\tawait buffer(zipPath, filePath);\n\t\t} catch (e) {\n\t\t\tthrow fromExtractError(e);\n\t\t}\n\t}\n\n\tasync delete(location: URI): Promise<void> {\n\t\tawait this.cleanUpPromise;\n\t\tconst trashRelativePath = this.uriIdentityService.extUri.relativePath(this.extensionsDownloadDir, location);\n\t\tif (trashRelativePath) {\n\t\t\tawait this.fileService.move(location, this.uriIdentityService.extUri.joinPath(this.extensionsTrashDir, trashRelativePath), true);\n\t\t} else {\n\t\t\tawait this.fileService.del(location);\n\t\t}\n\t}\n\n\tprivate async cleanUp(): Promise<void> {\n\t\ttry {\n\t\t\tif (!(await this.fileService.exists(this.extensionsDownloadDir))) {\n\t\t\t\tthis.logService.trace('Extension VSIX downloads cache dir does not exist');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tawait this.fileService.del(this.extensionsTrashDir, { recursive: true });\n\t\t\t} catch (error) {\n\t\t\t\tif (toFileOperationResult(error) !== FileOperationResult.FILE_NOT_FOUND) {\n\t\t\t\t\tthis.logService.error(error);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst folderStat = await this.fileService.resolve(this.extensionsDownloadDir, { resolveMetadata: true });\n\t\t\tif (folderStat.children) {\n\t\t\t\tconst toDelete: URI[] = [];\n\t\t\t\tconst vsixs: [ExtensionKey, IFileStatWithMetadata][] = [];\n\t\t\t\tconst signatureArchives: URI[] = [];\n\n\t\t\t\tfor (const stat of folderStat.children) {\n\t\t\t\t\tif (stat.name.endsWith(ExtensionsDownloader.SignatureArchiveExtension)) {\n\t\t\t\t\t\tsignatureArchives.push(stat.resource);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst extension = ExtensionKey.parse(stat.name);\n\t\t\t\t\t\tif (extension) {\n\t\t\t\t\t\t\tvsixs.push([extension, stat]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst byExtension = groupByExtension(vsixs, ([extension]) => extension);\n\t\t\t\tconst distinct: IFileStatWithMetadata[] = [];\n\t\t\t\tfor (const p of byExtension) {\n\t\t\t\t\tp.sort((a, b) => semver.rcompare(a[0].version, b[0].version));\n\t\t\t\t\ttoDelete.push(...p.slice(1).map(e => e[1].resource)); // Delete outdated extensions\n\t\t\t\t\tdistinct.push(p[0][1]);\n\t\t\t\t}\n\t\t\t\tdistinct.sort((a, b) => a.mtime - b.mtime); // sort by modified time\n\t\t\t\ttoDelete.push(...distinct.slice(0, Math.max(0, distinct.length - this.cache)).map(s => s.resource)); // Retain minimum cacheSize and delete the rest\n\t\t\t\ttoDelete.push(...signatureArchives); // Delete all signature archives\n\n\t\t\t\tawait Promises.settled(toDelete.map(resource => {\n\t\t\t\t\tthis.logService.trace('Deleting from cache', resource.path);\n\t\t\t\t\treturn this.fileService.del(resource);\n\t\t\t\t}));\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tthis.logService.error(e);\n\t\t}\n\t}\n\n\tprivate getName(extension: IGalleryExtension): string {\n\t\treturn ExtensionKey.create(extension).toString().toLowerCase();\n\t}\n\n}\n"]}