{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/extensionManagement/node/extensionsWatcher.ts","vs/platform/extensionManagement/node/extensionsWatcher.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;AAEhG,OAAO,EAAE,eAAe,EAAE,MAAM,gCAAgC,CAAC;AACjE,OAAO,EAAE,OAAO,EAAE,MAAM,+BAA+B,CAAC;AACxD,OAAO,EAAE,kBAAkB,EAAE,UAAU,EAAE,aAAa,EAAE,MAAM,mCAAmC,CAAC;AAClG,OAAO,EAAE,WAAW,EAAE,MAAM,6BAA6B,CAAC;AAE1D,OAAO,EAAE,eAAe,EAAE,MAAM,sCAAsC,CAAC;AAIvE,OAAO,EAAE,mBAAmB,EAAoC,MAAM,uCAAuC,CAAC;AAW9G,MAAM,OAAO,iBAAkB,SAAQ,UAAU;IAQhD,YACkB,0BAAmE,EACnE,wBAAmD,EACnD,uBAAiD,EACjD,+BAAiE,EACjE,kBAAuC,EACvC,WAAyB,EACzB,UAAuB;QAExC,KAAK,EAAE,CAAC;QARS,+BAA0B,GAA1B,0BAA0B,CAAyC;QACnE,6BAAwB,GAAxB,wBAAwB,CAA2B;QACnD,4BAAuB,GAAvB,uBAAuB,CAA0B;QACjD,oCAA+B,GAA/B,+BAA+B,CAAkC;QACjE,uBAAkB,GAAlB,kBAAkB,CAAqB;QACvC,gBAAW,GAAX,WAAW,CAAc;QACzB,eAAU,GAAV,UAAU,CAAa;QAbxB,0CAAqC,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,OAAO,EAAmC,CAAC,CAAC;QAC/G,yCAAoC,GAAG,IAAI,CAAC,qCAAqC,CAAC,KAAK,CAAC;QAEhF,kBAAa,GAAG,IAAI,GAAwB,CAAC;QAC7C,sCAAiC,GAAG,IAAI,CAAC,SAAS,CAAC,IAAI,aAAa,EAAU,CAAC,CAAC;QAYhG,IAAI,CAAC,UAAU,EAAE,CAAC,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,EAAE,CAAC,UAAU,CAAC,KAAK,CAAC,6CAA6C,EAAE,eAAe,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;IAChI,CAAC;IAEO,KAAK,CAAC,UAAU;QACvB,MAAM,IAAI,CAAC,wBAAwB,CAAC,kCAAkC,EAAE,CAAC;QACzE,MAAM,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,uBAAuB,CAAC,QAAQ,CAAC,CAAC;QACtE,IAAI,CAAC,iBAAiB,EAAE,CAAC;QACzB,MAAM,IAAI,CAAC,6BAA6B,EAAE,CAAC;IAC5C,CAAC;IAEO,iBAAiB;QACxB,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,uBAAuB,CAAC,mBAAmB,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;QACzG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,+BAA+B,CAAC,eAAe,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QACnG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,+BAA+B,CAAC,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QACzG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,+BAA+B,CAAC,kBAAkB,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,kBAAkB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QACzG,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,+BAA+B,CAAC,qBAAqB,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAC/G,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,gBAAgB,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;IAClF,CAAC;IAEO,KAAK,CAAC,mBAAmB,CAAC,KAAkC;QACnE,IAAI,CAAC;YACJ,IAAI,KAAK,CAAC,MAAM,EAAE,CAAC;gBAClB,MAAM,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE;oBACrC,IAAI,CAAC,iCAAiC,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,EAAE,kBAAkB,CACxE,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC;oBAC1F,mHAAmH;oBACnH,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAClD,CAAC,CAAC;oBACH,OAAO,IAAI,CAAC,6BAA6B,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC;gBACvE,CAAC,CAAC,CAAC,CAAC;YACL,CAAC;QACF,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YAChB,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;YAC7B,MAAM,KAAK,CAAC;QACb,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,eAAe,CAAC,CAAyB;QACtD,KAAK,MAAM,SAAS,IAAI,CAAC,CAAC,UAAU,EAAE,CAAC;YACtC,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,UAAU,EAAE,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,eAAe,CAAC,CAAC;QACnG,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,kBAAkB,CAAC,CAA+B;QAC/D,KAAK,MAAM,SAAS,IAAI,CAAC,CAAC,UAAU,EAAE,CAAC;YACtC,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,UAAU,EAAE,SAAS,CAAC,OAAO,CAAC,CAAC;YACjE,IAAI,CAAC,CAAC,KAAK,EAAE,CAAC;gBACb,IAAI,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC,eAAe,CAAC,CAAC;YACrD,CAAC;iBAAM,CAAC;gBACP,IAAI,CAAC,mBAAmB,CAAC,GAAG,EAAE,CAAC,CAAC,eAAe,CAAC,CAAC;YAClD,CAAC;QACF,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,kBAAkB,CAAC,CAAyB;QACzD,KAAK,MAAM,SAAS,IAAI,CAAC,CAAC,UAAU,EAAE,CAAC;YACtC,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,UAAU,EAAE,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,eAAe,CAAC,CAAC;QACtG,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,qBAAqB,CAAC,CAAkC;QACrE,MAAM,kBAAkB,GAAiB,EAAE,CAAC;QAC5C,MAAM,QAAQ,GAAoB,EAAE,CAAC;QACrC,KAAK,MAAM,SAAS,IAAI,CAAC,CAAC,UAAU,EAAE,CAAC;YACtC,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,UAAU,EAAE,SAAS,CAAC,OAAO,CAAC,CAAC;YACjE,IAAI,CAAC,CAAC,KAAK,EAAE,CAAC;gBACb,IAAI,CAAC,mBAAmB,CAAC,GAAG,EAAE,CAAC,CAAC,eAAe,CAAC,CAAC;YAClD,CAAC;iBAAM,CAAC;gBACP,IAAI,CAAC,sBAAsB,CAAC,GAAG,EAAE,CAAC,CAAC,eAAe,CAAC,CAAC;gBACpD,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC;oBAClC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,wCAAwC,EAAE,SAAS,CAAC,UAAU,CAAC,EAAE,EAAE,SAAS,CAAC,OAAO,CAAC,CAAC;oBAC5G,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,0BAA0B,CAAC,gCAAgC,CAAC,SAAS,CAAC,QAAQ,CAAC;yBAChG,IAAI,CAAC,MAAM,CAAC,EAAE;wBACd,IAAI,MAAM,EAAE,CAAC;4BACZ,kBAAkB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;wBACjC,CAAC;6BAAM,CAAC;4BACP,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,qCAAqC,EAAE,SAAS,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC,CAAC;wBAC5F,CAAC;oBACF,CAAC,EAAE,KAAK,CAAC,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;gBAC7C,CAAC;YACF,CAAC;QACF,CAAC;QACD,IAAI,CAAC;YACJ,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC5B,IAAI,kBAAkB,CAAC,MAAM,EAAE,CAAC;gBAC/B,MAAM,IAAI,CAAC,6BAA6B,CAAC,kBAAkB,CAAC,CAAC;YAC9D,CAAC;QACF,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YAChB,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAC9B,CAAC;IACF,CAAC;IAEO,gBAAgB,CAAC,CAAmB;QAC3C,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,uBAAuB,CAAC,QAAQ,EAAE,CAAC;YAC7D,IAAI,CAAC,CAAC,QAAQ,CAAC,OAAO,CAAC,kBAAkB,+DAA+C,EAAE,CAAC;gBAC1F,IAAI,CAAC,4BAA4B,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC;YAC/D,CAAC;QACF,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,4BAA4B,CAAC,eAAoB;QAC9D,MAAM,KAAK,GAA2B,EAAE,EAAE,OAAO,GAA2B,EAAE,CAAC;QAC/E,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,+BAA+B,CAAC,qBAAqB,CAAC,eAAe,CAAC,CAAC;QACrG,MAAM,aAAa,GAAG,IAAI,GAAG,EAAU,CAAC;QACxC,MAAM,MAAM,GAAG,IAAI,GAAG,EAAU,CAAC;QACjC,KAAK,MAAM,CAAC,GAAG,EAAE,QAAQ,CAAC,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;YAClD,IAAI,QAAQ,CAAC,GAAG,CAAC,eAAe,CAAC,EAAE,CAAC;gBACnC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YACjB,CAAC;QACF,CAAC;QACD,KAAK,MAAM,SAAS,IAAI,UAAU,EAAE,CAAC;YACpC,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,UAAU,EAAE,SAAS,CAAC,OAAO,CAAC,CAAC;YACjE,aAAa,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YACvB,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC;gBACtB,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;gBACjC,IAAI,CAAC,mBAAmB,CAAC,GAAG,EAAE,eAAe,CAAC,CAAC;YAChD,CAAC;QACF,CAAC;QACD,KAAK,MAAM,GAAG,IAAI,MAAM,EAAE,CAAC;YAC1B,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC;gBAC7B,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;gBACpC,IAAI,SAAS,EAAE,CAAC;oBACf,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC;oBACnC,IAAI,CAAC,sBAAsB,CAAC,GAAG,EAAE,eAAe,CAAC,CAAC;gBACnD,CAAC;YACF,CAAC;QACF,CAAC;QACD,IAAI,KAAK,CAAC,MAAM,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;YACpC,IAAI,CAAC,qCAAqC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,UAAU,EAAE,KAAK,EAAE,eAAe,EAAE,CAAC,CAAC,CAAC,SAAS,EAAE,OAAO,EAAE,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,UAAU,EAAE,OAAO,EAAE,eAAe,EAAE,CAAC,CAAC,CAAC,SAAS,EAAE,CAAC,CAAC;QAC/M,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,6BAA6B,CAAC,yBAA8B;QACzE,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,+BAA+B,CAAC,qBAAqB,CAAC,yBAAyB,CAAC,CAAC;QAC/G,KAAK,MAAM,SAAS,IAAI,UAAU,EAAE,CAAC;YACpC,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,UAAU,EAAE,SAAS,CAAC,OAAO,CAAC,EAAE,yBAAyB,CAAC,CAAC;QAC3G,CAAC;IACF,CAAC;IAEO,KAAK,CAAC,6BAA6B,CAAC,QAAuB;QAClE,IAAI,CAAC,QAAQ,EAAE,CAAC;YACf,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,0BAA0B,CAAC,8BAA8B,EAAE,CAAC;YACzF,QAAQ,GAAG,SAAS,CAAC,MAAM,CAAC,kBAAkB,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,kBAAkB,CAAC,UAAU,EAAE,kBAAkB,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;QAC7J,CAAC;QACD,IAAI,QAAQ,CAAC,MAAM,EAAE,CAAC;YACrB,MAAM,IAAI,CAAC,0BAA0B,CAAC,gBAAgB,CAAC,GAAG,QAAQ,CAAC,CAAC;QACrE,CAAC;IACF,CAAC;IAEO,mBAAmB,CAAC,GAAW,EAAE,yBAA8B;QACtE,IAAI,QAAQ,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAC3C,IAAI,CAAC,QAAQ,EAAE,CAAC;YACf,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,EAAE,QAAQ,GAAG,IAAI,WAAW,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;QACxH,CAAC;QACD,QAAQ,CAAC,GAAG,CAAC,yBAAyB,CAAC,CAAC;IACzC,CAAC;IAEO,sBAAsB,CAAC,GAAW,EAAE,eAAoB;QAC/D,MAAM,QAAQ,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAC7C,IAAI,QAAQ,EAAE,CAAC;YACd,QAAQ,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC;QAClC,CAAC;QACD,IAAI,CAAC,QAAQ,EAAE,IAAI,EAAE,CAAC;YACrB,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAChC,CAAC;IACF,CAAC;IAEO,MAAM,CAAC,UAAgC,EAAE,OAAe;QAC/D,OAAO,GAAG,mBAAmB,CAAC,KAAK,CAAC,UAAU,CAAC,EAAE,CAAC,IAAI,OAAO,EAAE,CAAC;IACjE,CAAC;IAEO,OAAO,CAAC,GAAW;QAC1B,MAAM,CAAC,EAAE,EAAE,OAAO,CAAC,GAAG,eAAe,CAAC,GAAG,CAAC,CAAC;QAC3C,OAAO,OAAO,CAAC,CAAC,CAAC,EAAE,UAAU,EAAE,EAAE,EAAE,EAAE,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC;IAC9D,CAAC;CAED","file":"extensionsWatcher.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { getErrorMessage } from '../../../base/common/errors.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { combinedDisposable, Disposable, DisposableMap } from '../../../base/common/lifecycle.js';\nimport { ResourceSet } from '../../../base/common/map.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { getIdAndVersion } from '../common/extensionManagementUtil.js';\nimport { DidAddProfileExtensionsEvent, DidRemoveProfileExtensionsEvent, IExtensionsProfileScannerService, ProfileExtensionsEvent } from '../common/extensionsProfileScannerService.js';\nimport { IExtensionsScannerService } from '../common/extensionsScannerService.js';\nimport { INativeServerExtensionManagementService } from './extensionManagementService.js';\nimport { ExtensionIdentifier, IExtension, IExtensionIdentifier } from '../../extensions/common/extensions.js';\nimport { FileChangesEvent, FileChangeType, IFileService } from '../../files/common/files.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IUriIdentityService } from '../../uriIdentity/common/uriIdentity.js';\nimport { IUserDataProfile, IUserDataProfilesService } from '../../userDataProfile/common/userDataProfile.js';\n\nexport interface DidChangeProfileExtensionsEvent {\n\treadonly added?: { readonly extensions: readonly IExtensionIdentifier[]; readonly profileLocation: URI };\n\treadonly removed?: { readonly extensions: readonly IExtensionIdentifier[]; readonly profileLocation: URI };\n}\n\nexport class ExtensionsWatcher extends Disposable {\n\n\tprivate readonly _onDidChangeExtensionsByAnotherSource = this._register(new Emitter<DidChangeProfileExtensionsEvent>());\n\treadonly onDidChangeExtensionsByAnotherSource = this._onDidChangeExtensionsByAnotherSource.event;\n\n\tprivate readonly allExtensions = new Map<string, ResourceSet>;\n\tprivate readonly extensionsProfileWatchDisposables = this._register(new DisposableMap<string>());\n\n\tconstructor(\n\t\tprivate readonly extensionManagementService: INativeServerExtensionManagementService,\n\t\tprivate readonly extensionsScannerService: IExtensionsScannerService,\n\t\tprivate readonly userDataProfilesService: IUserDataProfilesService,\n\t\tprivate readonly extensionsProfileScannerService: IExtensionsProfileScannerService,\n\t\tprivate readonly uriIdentityService: IUriIdentityService,\n\t\tprivate readonly fileService: IFileService,\n\t\tprivate readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t\tthis.initialize().then(null, error => logService.error('Error while initializing Extensions Watcher', getErrorMessage(error)));\n\t}\n\n\tprivate async initialize(): Promise<void> {\n\t\tawait this.extensionsScannerService.initializeDefaultProfileExtensions();\n\t\tawait this.onDidChangeProfiles(this.userDataProfilesService.profiles);\n\t\tthis.registerListeners();\n\t\tawait this.deleteExtensionsNotInProfiles();\n\t}\n\n\tprivate registerListeners(): void {\n\t\tthis._register(this.userDataProfilesService.onDidChangeProfiles(e => this.onDidChangeProfiles(e.added)));\n\t\tthis._register(this.extensionsProfileScannerService.onAddExtensions(e => this.onAddExtensions(e)));\n\t\tthis._register(this.extensionsProfileScannerService.onDidAddExtensions(e => this.onDidAddExtensions(e)));\n\t\tthis._register(this.extensionsProfileScannerService.onRemoveExtensions(e => this.onRemoveExtensions(e)));\n\t\tthis._register(this.extensionsProfileScannerService.onDidRemoveExtensions(e => this.onDidRemoveExtensions(e)));\n\t\tthis._register(this.fileService.onDidFilesChange(e => this.onDidFilesChange(e)));\n\t}\n\n\tprivate async onDidChangeProfiles(added: readonly IUserDataProfile[]): Promise<void> {\n\t\ttry {\n\t\t\tif (added.length) {\n\t\t\t\tawait Promise.all(added.map(profile => {\n\t\t\t\t\tthis.extensionsProfileWatchDisposables.set(profile.id, combinedDisposable(\n\t\t\t\t\t\tthis.fileService.watch(this.uriIdentityService.extUri.dirname(profile.extensionsResource)),\n\t\t\t\t\t\t// Also listen to the resource incase the resource is a symlink - https://github.com/microsoft/vscode/issues/118134\n\t\t\t\t\t\tthis.fileService.watch(profile.extensionsResource)\n\t\t\t\t\t));\n\t\t\t\t\treturn this.populateExtensionsFromProfile(profile.extensionsResource);\n\t\t\t\t}));\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error(error);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate async onAddExtensions(e: ProfileExtensionsEvent): Promise<void> {\n\t\tfor (const extension of e.extensions) {\n\t\t\tthis.addExtensionWithKey(this.getKey(extension.identifier, extension.version), e.profileLocation);\n\t\t}\n\t}\n\n\tprivate async onDidAddExtensions(e: DidAddProfileExtensionsEvent): Promise<void> {\n\t\tfor (const extension of e.extensions) {\n\t\t\tconst key = this.getKey(extension.identifier, extension.version);\n\t\t\tif (e.error) {\n\t\t\t\tthis.removeExtensionWithKey(key, e.profileLocation);\n\t\t\t} else {\n\t\t\t\tthis.addExtensionWithKey(key, e.profileLocation);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async onRemoveExtensions(e: ProfileExtensionsEvent): Promise<void> {\n\t\tfor (const extension of e.extensions) {\n\t\t\tthis.removeExtensionWithKey(this.getKey(extension.identifier, extension.version), e.profileLocation);\n\t\t}\n\t}\n\n\tprivate async onDidRemoveExtensions(e: DidRemoveProfileExtensionsEvent): Promise<void> {\n\t\tconst extensionsToDelete: IExtension[] = [];\n\t\tconst promises: Promise<void>[] = [];\n\t\tfor (const extension of e.extensions) {\n\t\t\tconst key = this.getKey(extension.identifier, extension.version);\n\t\t\tif (e.error) {\n\t\t\t\tthis.addExtensionWithKey(key, e.profileLocation);\n\t\t\t} else {\n\t\t\t\tthis.removeExtensionWithKey(key, e.profileLocation);\n\t\t\t\tif (!this.allExtensions.has(key)) {\n\t\t\t\t\tthis.logService.debug('Extension is removed from all profiles', extension.identifier.id, extension.version);\n\t\t\t\t\tpromises.push(this.extensionManagementService.scanInstalledExtensionAtLocation(extension.location)\n\t\t\t\t\t\t.then(result => {\n\t\t\t\t\t\t\tif (result) {\n\t\t\t\t\t\t\t\textensionsToDelete.push(result);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.logService.info('Extension not found at the location', extension.location.toString());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, error => this.logService.error(error)));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\ttry {\n\t\t\tawait Promise.all(promises);\n\t\t\tif (extensionsToDelete.length) {\n\t\t\t\tawait this.deleteExtensionsNotInProfiles(extensionsToDelete);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error(error);\n\t\t}\n\t}\n\n\tprivate onDidFilesChange(e: FileChangesEvent): void {\n\t\tfor (const profile of this.userDataProfilesService.profiles) {\n\t\t\tif (e.contains(profile.extensionsResource, FileChangeType.UPDATED, FileChangeType.ADDED)) {\n\t\t\t\tthis.onDidExtensionsProfileChange(profile.extensionsResource);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async onDidExtensionsProfileChange(profileLocation: URI): Promise<void> {\n\t\tconst added: IExtensionIdentifier[] = [], removed: IExtensionIdentifier[] = [];\n\t\tconst extensions = await this.extensionsProfileScannerService.scanProfileExtensions(profileLocation);\n\t\tconst extensionKeys = new Set<string>();\n\t\tconst cached = new Set<string>();\n\t\tfor (const [key, profiles] of this.allExtensions) {\n\t\t\tif (profiles.has(profileLocation)) {\n\t\t\t\tcached.add(key);\n\t\t\t}\n\t\t}\n\t\tfor (const extension of extensions) {\n\t\t\tconst key = this.getKey(extension.identifier, extension.version);\n\t\t\textensionKeys.add(key);\n\t\t\tif (!cached.has(key)) {\n\t\t\t\tadded.push(extension.identifier);\n\t\t\t\tthis.addExtensionWithKey(key, profileLocation);\n\t\t\t}\n\t\t}\n\t\tfor (const key of cached) {\n\t\t\tif (!extensionKeys.has(key)) {\n\t\t\t\tconst extension = this.fromKey(key);\n\t\t\t\tif (extension) {\n\t\t\t\t\tremoved.push(extension.identifier);\n\t\t\t\t\tthis.removeExtensionWithKey(key, profileLocation);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (added.length || removed.length) {\n\t\t\tthis._onDidChangeExtensionsByAnotherSource.fire({ added: added.length ? { extensions: added, profileLocation } : undefined, removed: removed.length ? { extensions: removed, profileLocation } : undefined });\n\t\t}\n\t}\n\n\tprivate async populateExtensionsFromProfile(extensionsProfileLocation: URI): Promise<void> {\n\t\tconst extensions = await this.extensionsProfileScannerService.scanProfileExtensions(extensionsProfileLocation);\n\t\tfor (const extension of extensions) {\n\t\t\tthis.addExtensionWithKey(this.getKey(extension.identifier, extension.version), extensionsProfileLocation);\n\t\t}\n\t}\n\n\tprivate async deleteExtensionsNotInProfiles(toDelete?: IExtension[]): Promise<void> {\n\t\tif (!toDelete) {\n\t\t\tconst installed = await this.extensionManagementService.scanAllUserInstalledExtensions();\n\t\t\ttoDelete = installed.filter(installedExtension => !this.allExtensions.has(this.getKey(installedExtension.identifier, installedExtension.manifest.version)));\n\t\t}\n\t\tif (toDelete.length) {\n\t\t\tawait this.extensionManagementService.deleteExtensions(...toDelete);\n\t\t}\n\t}\n\n\tprivate addExtensionWithKey(key: string, extensionsProfileLocation: URI): void {\n\t\tlet profiles = this.allExtensions.get(key);\n\t\tif (!profiles) {\n\t\t\tthis.allExtensions.set(key, profiles = new ResourceSet((uri) => this.uriIdentityService.extUri.getComparisonKey(uri)));\n\t\t}\n\t\tprofiles.add(extensionsProfileLocation);\n\t}\n\n\tprivate removeExtensionWithKey(key: string, profileLocation: URI): void {\n\t\tconst profiles = this.allExtensions.get(key);\n\t\tif (profiles) {\n\t\t\tprofiles.delete(profileLocation);\n\t\t}\n\t\tif (!profiles?.size) {\n\t\t\tthis.allExtensions.delete(key);\n\t\t}\n\t}\n\n\tprivate getKey(identifier: IExtensionIdentifier, version: string): string {\n\t\treturn `${ExtensionIdentifier.toKey(identifier.id)}@${version}`;\n\t}\n\n\tprivate fromKey(key: string): { identifier: IExtensionIdentifier; version: string } | undefined {\n\t\tconst [id, version] = getIdAndVersion(key);\n\t\treturn version ? { identifier: { id }, version } : undefined;\n\t}\n\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { getErrorMessage } from '../../../base/common/errors.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { combinedDisposable, Disposable, DisposableMap } from '../../../base/common/lifecycle.js';\nimport { ResourceSet } from '../../../base/common/map.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { getIdAndVersion } from '../common/extensionManagementUtil.js';\nimport { DidAddProfileExtensionsEvent, DidRemoveProfileExtensionsEvent, IExtensionsProfileScannerService, ProfileExtensionsEvent } from '../common/extensionsProfileScannerService.js';\nimport { IExtensionsScannerService } from '../common/extensionsScannerService.js';\nimport { INativeServerExtensionManagementService } from './extensionManagementService.js';\nimport { ExtensionIdentifier, IExtension, IExtensionIdentifier } from '../../extensions/common/extensions.js';\nimport { FileChangesEvent, FileChangeType, IFileService } from '../../files/common/files.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IUriIdentityService } from '../../uriIdentity/common/uriIdentity.js';\nimport { IUserDataProfile, IUserDataProfilesService } from '../../userDataProfile/common/userDataProfile.js';\n\nexport interface DidChangeProfileExtensionsEvent {\n\treadonly added?: { readonly extensions: readonly IExtensionIdentifier[]; readonly profileLocation: URI };\n\treadonly removed?: { readonly extensions: readonly IExtensionIdentifier[]; readonly profileLocation: URI };\n}\n\nexport class ExtensionsWatcher extends Disposable {\n\n\tprivate readonly _onDidChangeExtensionsByAnotherSource = this._register(new Emitter<DidChangeProfileExtensionsEvent>());\n\treadonly onDidChangeExtensionsByAnotherSource = this._onDidChangeExtensionsByAnotherSource.event;\n\n\tprivate readonly allExtensions = new Map<string, ResourceSet>;\n\tprivate readonly extensionsProfileWatchDisposables = this._register(new DisposableMap<string>());\n\n\tconstructor(\n\t\tprivate readonly extensionManagementService: INativeServerExtensionManagementService,\n\t\tprivate readonly extensionsScannerService: IExtensionsScannerService,\n\t\tprivate readonly userDataProfilesService: IUserDataProfilesService,\n\t\tprivate readonly extensionsProfileScannerService: IExtensionsProfileScannerService,\n\t\tprivate readonly uriIdentityService: IUriIdentityService,\n\t\tprivate readonly fileService: IFileService,\n\t\tprivate readonly logService: ILogService,\n\t) {\n\t\tsuper();\n\t\tthis.initialize().then(null, error => logService.error('Error while initializing Extensions Watcher', getErrorMessage(error)));\n\t}\n\n\tprivate async initialize(): Promise<void> {\n\t\tawait this.extensionsScannerService.initializeDefaultProfileExtensions();\n\t\tawait this.onDidChangeProfiles(this.userDataProfilesService.profiles);\n\t\tthis.registerListeners();\n\t\tawait this.deleteExtensionsNotInProfiles();\n\t}\n\n\tprivate registerListeners(): void {\n\t\tthis._register(this.userDataProfilesService.onDidChangeProfiles(e => this.onDidChangeProfiles(e.added)));\n\t\tthis._register(this.extensionsProfileScannerService.onAddExtensions(e => this.onAddExtensions(e)));\n\t\tthis._register(this.extensionsProfileScannerService.onDidAddExtensions(e => this.onDidAddExtensions(e)));\n\t\tthis._register(this.extensionsProfileScannerService.onRemoveExtensions(e => this.onRemoveExtensions(e)));\n\t\tthis._register(this.extensionsProfileScannerService.onDidRemoveExtensions(e => this.onDidRemoveExtensions(e)));\n\t\tthis._register(this.fileService.onDidFilesChange(e => this.onDidFilesChange(e)));\n\t}\n\n\tprivate async onDidChangeProfiles(added: readonly IUserDataProfile[]): Promise<void> {\n\t\ttry {\n\t\t\tif (added.length) {\n\t\t\t\tawait Promise.all(added.map(profile => {\n\t\t\t\t\tthis.extensionsProfileWatchDisposables.set(profile.id, combinedDisposable(\n\t\t\t\t\t\tthis.fileService.watch(this.uriIdentityService.extUri.dirname(profile.extensionsResource)),\n\t\t\t\t\t\t// Also listen to the resource incase the resource is a symlink - https://github.com/microsoft/vscode/issues/118134\n\t\t\t\t\t\tthis.fileService.watch(profile.extensionsResource)\n\t\t\t\t\t));\n\t\t\t\t\treturn this.populateExtensionsFromProfile(profile.extensionsResource);\n\t\t\t\t}));\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error(error);\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate async onAddExtensions(e: ProfileExtensionsEvent): Promise<void> {\n\t\tfor (const extension of e.extensions) {\n\t\t\tthis.addExtensionWithKey(this.getKey(extension.identifier, extension.version), e.profileLocation);\n\t\t}\n\t}\n\n\tprivate async onDidAddExtensions(e: DidAddProfileExtensionsEvent): Promise<void> {\n\t\tfor (const extension of e.extensions) {\n\t\t\tconst key = this.getKey(extension.identifier, extension.version);\n\t\t\tif (e.error) {\n\t\t\t\tthis.removeExtensionWithKey(key, e.profileLocation);\n\t\t\t} else {\n\t\t\t\tthis.addExtensionWithKey(key, e.profileLocation);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async onRemoveExtensions(e: ProfileExtensionsEvent): Promise<void> {\n\t\tfor (const extension of e.extensions) {\n\t\t\tthis.removeExtensionWithKey(this.getKey(extension.identifier, extension.version), e.profileLocation);\n\t\t}\n\t}\n\n\tprivate async onDidRemoveExtensions(e: DidRemoveProfileExtensionsEvent): Promise<void> {\n\t\tconst extensionsToDelete: IExtension[] = [];\n\t\tconst promises: Promise<void>[] = [];\n\t\tfor (const extension of e.extensions) {\n\t\t\tconst key = this.getKey(extension.identifier, extension.version);\n\t\t\tif (e.error) {\n\t\t\t\tthis.addExtensionWithKey(key, e.profileLocation);\n\t\t\t} else {\n\t\t\t\tthis.removeExtensionWithKey(key, e.profileLocation);\n\t\t\t\tif (!this.allExtensions.has(key)) {\n\t\t\t\t\tthis.logService.debug('Extension is removed from all profiles', extension.identifier.id, extension.version);\n\t\t\t\t\tpromises.push(this.extensionManagementService.scanInstalledExtensionAtLocation(extension.location)\n\t\t\t\t\t\t.then(result => {\n\t\t\t\t\t\t\tif (result) {\n\t\t\t\t\t\t\t\textensionsToDelete.push(result);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.logService.info('Extension not found at the location', extension.location.toString());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, error => this.logService.error(error)));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\ttry {\n\t\t\tawait Promise.all(promises);\n\t\t\tif (extensionsToDelete.length) {\n\t\t\t\tawait this.deleteExtensionsNotInProfiles(extensionsToDelete);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.logService.error(error);\n\t\t}\n\t}\n\n\tprivate onDidFilesChange(e: FileChangesEvent): void {\n\t\tfor (const profile of this.userDataProfilesService.profiles) {\n\t\t\tif (e.contains(profile.extensionsResource, FileChangeType.UPDATED, FileChangeType.ADDED)) {\n\t\t\t\tthis.onDidExtensionsProfileChange(profile.extensionsResource);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async onDidExtensionsProfileChange(profileLocation: URI): Promise<void> {\n\t\tconst added: IExtensionIdentifier[] = [], removed: IExtensionIdentifier[] = [];\n\t\tconst extensions = await this.extensionsProfileScannerService.scanProfileExtensions(profileLocation);\n\t\tconst extensionKeys = new Set<string>();\n\t\tconst cached = new Set<string>();\n\t\tfor (const [key, profiles] of this.allExtensions) {\n\t\t\tif (profiles.has(profileLocation)) {\n\t\t\t\tcached.add(key);\n\t\t\t}\n\t\t}\n\t\tfor (const extension of extensions) {\n\t\t\tconst key = this.getKey(extension.identifier, extension.version);\n\t\t\textensionKeys.add(key);\n\t\t\tif (!cached.has(key)) {\n\t\t\t\tadded.push(extension.identifier);\n\t\t\t\tthis.addExtensionWithKey(key, profileLocation);\n\t\t\t}\n\t\t}\n\t\tfor (const key of cached) {\n\t\t\tif (!extensionKeys.has(key)) {\n\t\t\t\tconst extension = this.fromKey(key);\n\t\t\t\tif (extension) {\n\t\t\t\t\tremoved.push(extension.identifier);\n\t\t\t\t\tthis.removeExtensionWithKey(key, profileLocation);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (added.length || removed.length) {\n\t\t\tthis._onDidChangeExtensionsByAnotherSource.fire({ added: added.length ? { extensions: added, profileLocation } : undefined, removed: removed.length ? { extensions: removed, profileLocation } : undefined });\n\t\t}\n\t}\n\n\tprivate async populateExtensionsFromProfile(extensionsProfileLocation: URI): Promise<void> {\n\t\tconst extensions = await this.extensionsProfileScannerService.scanProfileExtensions(extensionsProfileLocation);\n\t\tfor (const extension of extensions) {\n\t\t\tthis.addExtensionWithKey(this.getKey(extension.identifier, extension.version), extensionsProfileLocation);\n\t\t}\n\t}\n\n\tprivate async deleteExtensionsNotInProfiles(toDelete?: IExtension[]): Promise<void> {\n\t\tif (!toDelete) {\n\t\t\tconst installed = await this.extensionManagementService.scanAllUserInstalledExtensions();\n\t\t\ttoDelete = installed.filter(installedExtension => !this.allExtensions.has(this.getKey(installedExtension.identifier, installedExtension.manifest.version)));\n\t\t}\n\t\tif (toDelete.length) {\n\t\t\tawait this.extensionManagementService.deleteExtensions(...toDelete);\n\t\t}\n\t}\n\n\tprivate addExtensionWithKey(key: string, extensionsProfileLocation: URI): void {\n\t\tlet profiles = this.allExtensions.get(key);\n\t\tif (!profiles) {\n\t\t\tthis.allExtensions.set(key, profiles = new ResourceSet((uri) => this.uriIdentityService.extUri.getComparisonKey(uri)));\n\t\t}\n\t\tprofiles.add(extensionsProfileLocation);\n\t}\n\n\tprivate removeExtensionWithKey(key: string, profileLocation: URI): void {\n\t\tconst profiles = this.allExtensions.get(key);\n\t\tif (profiles) {\n\t\t\tprofiles.delete(profileLocation);\n\t\t}\n\t\tif (!profiles?.size) {\n\t\t\tthis.allExtensions.delete(key);\n\t\t}\n\t}\n\n\tprivate getKey(identifier: IExtensionIdentifier, version: string): string {\n\t\treturn `${ExtensionIdentifier.toKey(identifier.id)}@${version}`;\n\t}\n\n\tprivate fromKey(key: string): { identifier: IExtensionIdentifier; version: string } | undefined {\n\t\tconst [id, version] = getIdAndVersion(key);\n\t\treturn version ? { identifier: { id }, version } : undefined;\n\t}\n\n}\n"]}