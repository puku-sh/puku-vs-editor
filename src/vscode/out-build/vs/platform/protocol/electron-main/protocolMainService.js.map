{"version":3,"sources":["file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src/vs/platform/protocol/electron-main/protocolMainService.ts","vs/platform/protocol/electron-main/protocolMainService.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;AAEhG,OAAO,EAAE,OAAO,EAAE,MAAM,UAAU,CAAC;AACnC,OAAO,EAAE,UAAU,EAAe,YAAY,EAAE,MAAM,mCAAmC,CAAC;AAC1F,OAAO,EAAE,GAAG,EAAE,UAAU,EAAE,OAAO,EAAE,mBAAmB,EAAE,qBAAqB,EAAE,MAAM,iCAAiC,CAAC;AACvH,OAAO,EAAE,QAAQ,EAAE,OAAO,EAAE,SAAS,EAAE,MAAM,8BAA8B,CAAC;AAC5E,OAAO,EAAE,OAAO,EAAE,MAAM,kCAAkC,CAAC;AAC3D,OAAO,EAAE,iBAAiB,EAAE,MAAM,2CAA2C,CAAC;AAC9E,OAAO,EAAE,GAAG,EAAE,MAAM,6BAA6B,CAAC;AAClD,OAAO,EAAE,YAAY,EAAE,MAAM,8BAA8B,CAAC;AAC5D,OAAO,EAAE,gBAAgB,EAAE,MAAM,kDAAkD,CAAC;AACpF,OAAO,EAAE,yBAAyB,EAAE,MAAM,yCAAyC,CAAC;AACpF,OAAO,EAAE,WAAW,EAAE,MAAM,yBAAyB,CAAC;AAEtD,OAAO,EAAE,wBAAwB,EAAE,MAAM,iDAAiD,CAAC;AAIpF,IAAM,mBAAmB,GAAzB,MAAM,mBAAoB,SAAQ,UAAU;IAOlD,YAC4B,kBAA8D,EAC/D,uBAAiD,EAC9D,UAAwC;QAErD,KAAK,EAAE,CAAC;QAJoC,uBAAkB,GAAlB,kBAAkB,CAA2B;QAE3D,eAAU,GAAV,UAAU,CAAa;QANrC,eAAU,GAAG,iBAAiB,CAAC,QAAQ,CAAU,CAAC,OAAO,CAAC,CAAC;QAC3D,oBAAe,GAAG,IAAI,GAAG,CAAC,CAAC,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,oDAAoD;QASnL,uDAAuD;QACvD,qDAAqD;QACrD,mDAAmD;QACnD,+GAA+G;QAC/G,IAAI,CAAC,gBAAgB,CAAC,kBAAkB,CAAC,OAAO,CAAC,CAAC;QAClD,IAAI,CAAC,gBAAgB,CAAC,kBAAkB,CAAC,cAAc,CAAC,CAAC;QACzD,IAAI,CAAC,gBAAgB,CAAC,uBAAuB,CAAC,cAAc,CAAC,iBAAiB,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC;QACtH,IAAI,CAAC,gBAAgB,CAAC,kBAAkB,CAAC,oBAAoB,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC;QAErG,mBAAmB;QACnB,IAAI,CAAC,eAAe,EAAE,CAAC;IACxB,CAAC;IAEO,eAAe;QACtB,MAAM,EAAE,cAAc,EAAE,GAAG,OAAO,CAAC;QAEnC,kCAAkC;QAClC,cAAc,CAAC,QAAQ,CAAC,oBAAoB,CAAC,OAAO,CAAC,kBAAkB,EAAE,CAAC,OAAO,EAAE,QAAQ,EAAE,EAAE,CAAC,IAAI,CAAC,qBAAqB,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC,CAAC;QAE/I,2BAA2B;QAC3B,cAAc,CAAC,QAAQ,CAAC,qBAAqB,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC,OAAO,EAAE,QAAQ,EAAE,EAAE,CAAC,IAAI,CAAC,iBAAiB,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC,CAAC;QAE9H,UAAU;QACV,IAAI,CAAC,SAAS,CAAC,YAAY,CAAC,GAAG,EAAE;YAChC,cAAc,CAAC,QAAQ,CAAC,kBAAkB,CAAC,OAAO,CAAC,kBAAkB,CAAC,CAAC;YACvE,cAAc,CAAC,QAAQ,CAAC,mBAAmB,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QAC3D,CAAC,CAAC,CAAC,CAAC;IACL,CAAC;IAED,gBAAgB,CAAC,IAAY;QAE5B,mDAAmD;QACnD,uCAAuC;QACvC,MAAM,cAAc,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC;QAEvC,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,cAAc,CAAC,EAAE,CAAC;YAC1C,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;YAE1C,OAAO,YAAY,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,cAAc,CAAC,CAAC,CAAC;QACnE,CAAC;QAED,OAAO,UAAU,CAAC,IAAI,CAAC;IACxB,CAAC;IAED,iBAAiB;IAET,iBAAiB,CAAC,OAAiC,EAAE,QAA0B;QACtF,MAAM,GAAG,GAAG,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAEnC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,4BAA4B,GAAG,CAAC,MAAM,SAAS,OAAO,CAAC,IAAI,6BAA6B,OAAO,CAAC,GAAG,GAAG,CAAC,CAAC;QAE9H,OAAO,QAAQ,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC,aAAa,EAAE,CAAC,CAAC;IAC9C,CAAC;IAED,YAAY;IAEZ,wBAAwB;IAEhB,qBAAqB,CAAC,OAAiC,EAAE,QAA0B;QAC1F,MAAM,IAAI,GAAG,IAAI,CAAC,2BAA2B,CAAC,OAAO,CAAC,CAAC;QACvD,MAAM,YAAY,GAAG,QAAQ,CAAC,IAAI,CAAC,CAAC;QAEpC,IAAI,OAA2C,CAAC;QAChD,IAAI,IAAI,CAAC,kBAAkB,CAAC,mBAAmB,EAAE,CAAC;YACjD,IAAI,YAAY,KAAK,gBAAgB,IAAI,YAAY,KAAK,oBAAoB,EAAE,CAAC;gBAChF,OAAO,GAAG,GAAG,CAAC,WAAW,CAAC;YAC3B,CAAC;iBAAM,CAAC;gBACP,OAAO,GAAG,GAAG,CAAC,mBAAmB,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;YAChD,CAAC;QACF,CAAC;QAED,wEAAwE;QACxE,iFAAiF;QACjF,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,OAAO,EAAE,CAAC;YACtC,OAAO,GAAG;gBACT,GAAG,OAAO;gBACV,GAAG,mBAAmB;aACtB,CAAC;QACH,CAAC;QAED,kDAAkD;QAClD,mIAAmI;QACnI,uEAAuE;QACvE,IAAI,YAAY,KAAK,gBAAgB,IAAI,YAAY,KAAK,oBAAoB,EAAE,CAAC;YAChF,OAAO,GAAG;gBACT,GAAG,OAAO;gBACV,GAAG,qBAAqB;aACxB,CAAC;QACH,CAAC;QAED,4BAA4B;QAC5B,IAAI,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC;YACtC,OAAO,QAAQ,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;QACpC,CAAC;QAED,gCAAgC;QAChC,IAAI,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,WAAW,EAAE,CAAC,EAAE,CAAC;YAC3D,OAAO,QAAQ,CAAC,EAAE,IAAI,EAAE,OAAO,EAAE,CAAC,CAAC;QACpC,CAAC;QAED,qCAAqC;QACrC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,GAAG,OAAO,CAAC,kBAAkB,8BAA8B,IAAI,SAAS,OAAO,CAAC,kBAAkB,6BAA6B,OAAO,CAAC,GAAG,GAAG,CAAC,CAAC;QAErK,OAAO,QAAQ,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC,aAAa,EAAE,CAAC,CAAC;IAC9C,CAAC;IAEO,2BAA2B,CAAC,OAAiC;QAEpE,wDAAwD;QACxD,wBAAwB;QACxB,MAAM,UAAU,GAAG,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAE1C,wDAAwD;QACxD,2CAA2C;QAC3C,MAAM,mBAAmB,GAAG,UAAU,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC;QAEhE,uDAAuD;QACvD,yDAAyD;QACzD,OAAO,SAAS,CAAC,mBAAmB,CAAC,MAAM,CAAC,CAAC;IAC9C,CAAC;IAED,YAAY;IAEZ,yBAAyB;IAEzB,kBAAkB;QACjB,IAAI,GAAG,GAAkB,SAAS,CAAC;QAEnC,oBAAoB;QACpB,MAAM,QAAQ,GAAG,GAAG,CAAC,IAAI,CAAC;YACzB,MAAM,EAAE,QAAQ,EAAE,wDAAwD;YAC1E,IAAI,EAAE,YAAY,EAAE;SACpB,CAAC,CAAC;QAEH,sBAAsB;QACtB,MAAM,OAAO,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;QACpC,MAAM,OAAO,GAAG,KAAK,IAA4B,EAAE,CAAC,GAAG,CAAC;QACxD,gBAAgB,CAAC,MAAM,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;QAE1C,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,0CAA0C,OAAO,GAAG,CAAC,CAAC;QAE5E,OAAO;YACN,QAAQ;YACR,MAAM,EAAE,UAAU,CAAC,EAAE,CAAC,GAAG,GAAG,UAAU;YACtC,OAAO,EAAE,GAAG,EAAE;gBACb,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,mCAAmC,OAAO,GAAG,CAAC,CAAC;gBAErE,gBAAgB,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;YACzC,CAAC;SACD,CAAC;IACH,CAAC;CAGD,CAAA;AAvKY,mBAAmB;IAQ7B,WAAA,yBAAyB,CAAA;IACzB,WAAA,wBAAwB,CAAA;IACxB,WAAA,WAAW,CAAA;GAVD,mBAAmB,CAuK/B","file":"protocolMainService.js","sourceRoot":"file:///Users/sahamed/Desktop/puku-vs-editor/puku-editor/github/vscode/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { session } from 'electron';\nimport { Disposable, IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { COI, FileAccess, Schemas, CacheControlheaders, DocumentPolicyheaders } from '../../../base/common/network.js';\nimport { basename, extname, normalize } from '../../../base/common/path.js';\nimport { isLinux } from '../../../base/common/platform.js';\nimport { TernarySearchTree } from '../../../base/common/ternarySearchTree.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { validatedIpcMain } from '../../../base/parts/ipc/electron-main/ipcMain.js';\nimport { INativeEnvironmentService } from '../../environment/common/environment.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IIPCObjectUrl, IProtocolMainService } from './protocol.js';\nimport { IUserDataProfilesService } from '../../userDataProfile/common/userDataProfile.js';\n\ntype ProtocolCallback = { (result: string | Electron.FilePathWithHeaders | { error: number }): void };\n\nexport class ProtocolMainService extends Disposable implements IProtocolMainService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly validRoots = TernarySearchTree.forPaths<boolean>(!isLinux);\n\tprivate readonly validExtensions = new Set(['.svg', '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp', '.mp4', '.otf', '.ttf']); // https://github.com/microsoft/vscode/issues/119384\n\n\tconstructor(\n\t\t@INativeEnvironmentService private readonly environmentService: INativeEnvironmentService,\n\t\t@IUserDataProfilesService userDataProfilesService: IUserDataProfilesService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\t// Define an initial set of roots we allow loading from\n\t\t// - appRoot\t: all files installed as part of the app\n\t\t// - extensions : all files shipped from extensions\n\t\t// - storage    : all files in global and workspace storage (https://github.com/microsoft/vscode/issues/116735)\n\t\tthis.addValidFileRoot(environmentService.appRoot);\n\t\tthis.addValidFileRoot(environmentService.extensionsPath);\n\t\tthis.addValidFileRoot(userDataProfilesService.defaultProfile.globalStorageHome.with({ scheme: Schemas.file }).fsPath);\n\t\tthis.addValidFileRoot(environmentService.workspaceStorageHome.with({ scheme: Schemas.file }).fsPath);\n\n\t\t// Handle protocols\n\t\tthis.handleProtocols();\n\t}\n\n\tprivate handleProtocols(): void {\n\t\tconst { defaultSession } = session;\n\n\t\t// Register vscode-file:// handler\n\t\tdefaultSession.protocol.registerFileProtocol(Schemas.vscodeFileResource, (request, callback) => this.handleResourceRequest(request, callback));\n\n\t\t// Block any file:// access\n\t\tdefaultSession.protocol.interceptFileProtocol(Schemas.file, (request, callback) => this.handleFileRequest(request, callback));\n\n\t\t// Cleanup\n\t\tthis._register(toDisposable(() => {\n\t\t\tdefaultSession.protocol.unregisterProtocol(Schemas.vscodeFileResource);\n\t\t\tdefaultSession.protocol.uninterceptProtocol(Schemas.file);\n\t\t}));\n\t}\n\n\taddValidFileRoot(root: string): IDisposable {\n\n\t\t// Pass to `normalize` because we later also do the\n\t\t// same for all paths to check against.\n\t\tconst normalizedRoot = normalize(root);\n\n\t\tif (!this.validRoots.get(normalizedRoot)) {\n\t\t\tthis.validRoots.set(normalizedRoot, true);\n\n\t\t\treturn toDisposable(() => this.validRoots.delete(normalizedRoot));\n\t\t}\n\n\t\treturn Disposable.None;\n\t}\n\n\t//#region file://\n\n\tprivate handleFileRequest(request: Electron.ProtocolRequest, callback: ProtocolCallback) {\n\t\tconst uri = URI.parse(request.url);\n\n\t\tthis.logService.error(`Refused to load resource ${uri.fsPath} from ${Schemas.file}: protocol (original URL: ${request.url})`);\n\n\t\treturn callback({ error: -3 /* ABORTED */ });\n\t}\n\n\t//#endregion\n\n\t//#region vscode-file://\n\n\tprivate handleResourceRequest(request: Electron.ProtocolRequest, callback: ProtocolCallback): void {\n\t\tconst path = this.requestToNormalizedFilePath(request);\n\t\tconst pathBasename = basename(path);\n\n\t\tlet headers: Record<string, string> | undefined;\n\t\tif (this.environmentService.crossOriginIsolated) {\n\t\t\tif (pathBasename === 'workbench.html' || pathBasename === 'workbench-dev.html') {\n\t\t\t\theaders = COI.CoopAndCoep;\n\t\t\t} else {\n\t\t\t\theaders = COI.getHeadersFromQuery(request.url);\n\t\t\t}\n\t\t}\n\n\t\t// In OSS, evict resources from the memory cache in the renderer process\n\t\t// Refs https://github.com/microsoft/vscode/issues/148541#issuecomment-2670891511\n\t\tif (!this.environmentService.isBuilt) {\n\t\t\theaders = {\n\t\t\t\t...headers,\n\t\t\t\t...CacheControlheaders\n\t\t\t};\n\t\t}\n\n\t\t// Document-policy header is needed for collecting\n\t\t// JavaScript callstacks via https://www.electronjs.org/docs/latest/api/web-frame-main#framecollectjavascriptcallstack-experimental\n\t\t// until https://github.com/electron/electron/issues/45356 is resolved.\n\t\tif (pathBasename === 'workbench.html' || pathBasename === 'workbench-dev.html') {\n\t\t\theaders = {\n\t\t\t\t...headers,\n\t\t\t\t...DocumentPolicyheaders\n\t\t\t};\n\t\t}\n\n\t\t// first check by validRoots\n\t\tif (this.validRoots.findSubstr(path)) {\n\t\t\treturn callback({ path, headers });\n\t\t}\n\n\t\t// then check by validExtensions\n\t\tif (this.validExtensions.has(extname(path).toLowerCase())) {\n\t\t\treturn callback({ path, headers });\n\t\t}\n\n\t\t// finally block to load the resource\n\t\tthis.logService.error(`${Schemas.vscodeFileResource}: Refused to load resource ${path} from ${Schemas.vscodeFileResource}: protocol (original URL: ${request.url})`);\n\n\t\treturn callback({ error: -3 /* ABORTED */ });\n\t}\n\n\tprivate requestToNormalizedFilePath(request: Electron.ProtocolRequest): string {\n\n\t\t// 1.) Use `URI.parse()` util from us to convert the raw\n\t\t//     URL into our URI.\n\t\tconst requestUri = URI.parse(request.url);\n\n\t\t// 2.) Use `FileAccess.asFileUri` to convert back from a\n\t\t//     `vscode-file:` URI to a `file:` URI.\n\t\tconst unnormalizedFileUri = FileAccess.uriToFileUri(requestUri);\n\n\t\t// 3.) Strip anything from the URI that could result in\n\t\t//     relative paths (such as \"..\") by using `normalize`\n\t\treturn normalize(unnormalizedFileUri.fsPath);\n\t}\n\n\t//#endregion\n\n\t//#region IPC Object URLs\n\n\tcreateIPCObjectUrl<T>(): IIPCObjectUrl<T> {\n\t\tlet obj: T | undefined = undefined;\n\n\t\t// Create unique URI\n\t\tconst resource = URI.from({\n\t\t\tscheme: 'vscode', // used for all our IPC communication (vscode:<channel>)\n\t\t\tpath: generateUuid()\n\t\t});\n\n\t\t// Install IPC handler\n\t\tconst channel = resource.toString();\n\t\tconst handler = async (): Promise<T | undefined> => obj;\n\t\tvalidatedIpcMain.handle(channel, handler);\n\n\t\tthis.logService.trace(`IPC Object URL: Registered new channel ${channel}.`);\n\n\t\treturn {\n\t\t\tresource,\n\t\t\tupdate: updatedObj => obj = updatedObj,\n\t\t\tdispose: () => {\n\t\t\t\tthis.logService.trace(`IPC Object URL: Removed channel ${channel}.`);\n\n\t\t\t\tvalidatedIpcMain.removeHandler(channel);\n\t\t\t}\n\t\t};\n\t}\n\n\t//#endregion\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { session } from 'electron';\nimport { Disposable, IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { COI, FileAccess, Schemas, CacheControlheaders, DocumentPolicyheaders } from '../../../base/common/network.js';\nimport { basename, extname, normalize } from '../../../base/common/path.js';\nimport { isLinux } from '../../../base/common/platform.js';\nimport { TernarySearchTree } from '../../../base/common/ternarySearchTree.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { validatedIpcMain } from '../../../base/parts/ipc/electron-main/ipcMain.js';\nimport { INativeEnvironmentService } from '../../environment/common/environment.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IIPCObjectUrl, IProtocolMainService } from './protocol.js';\nimport { IUserDataProfilesService } from '../../userDataProfile/common/userDataProfile.js';\n\ntype ProtocolCallback = { (result: string | Electron.FilePathWithHeaders | { error: number }): void };\n\nexport class ProtocolMainService extends Disposable implements IProtocolMainService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly validRoots = TernarySearchTree.forPaths<boolean>(!isLinux);\n\tprivate readonly validExtensions = new Set(['.svg', '.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp', '.mp4', '.otf', '.ttf']); // https://github.com/microsoft/vscode/issues/119384\n\n\tconstructor(\n\t\t@INativeEnvironmentService private readonly environmentService: INativeEnvironmentService,\n\t\t@IUserDataProfilesService userDataProfilesService: IUserDataProfilesService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\t// Define an initial set of roots we allow loading from\n\t\t// - appRoot\t: all files installed as part of the app\n\t\t// - extensions : all files shipped from extensions\n\t\t// - storage    : all files in global and workspace storage (https://github.com/microsoft/vscode/issues/116735)\n\t\tthis.addValidFileRoot(environmentService.appRoot);\n\t\tthis.addValidFileRoot(environmentService.extensionsPath);\n\t\tthis.addValidFileRoot(userDataProfilesService.defaultProfile.globalStorageHome.with({ scheme: Schemas.file }).fsPath);\n\t\tthis.addValidFileRoot(environmentService.workspaceStorageHome.with({ scheme: Schemas.file }).fsPath);\n\n\t\t// Handle protocols\n\t\tthis.handleProtocols();\n\t}\n\n\tprivate handleProtocols(): void {\n\t\tconst { defaultSession } = session;\n\n\t\t// Register vscode-file:// handler\n\t\tdefaultSession.protocol.registerFileProtocol(Schemas.vscodeFileResource, (request, callback) => this.handleResourceRequest(request, callback));\n\n\t\t// Block any file:// access\n\t\tdefaultSession.protocol.interceptFileProtocol(Schemas.file, (request, callback) => this.handleFileRequest(request, callback));\n\n\t\t// Cleanup\n\t\tthis._register(toDisposable(() => {\n\t\t\tdefaultSession.protocol.unregisterProtocol(Schemas.vscodeFileResource);\n\t\t\tdefaultSession.protocol.uninterceptProtocol(Schemas.file);\n\t\t}));\n\t}\n\n\taddValidFileRoot(root: string): IDisposable {\n\n\t\t// Pass to `normalize` because we later also do the\n\t\t// same for all paths to check against.\n\t\tconst normalizedRoot = normalize(root);\n\n\t\tif (!this.validRoots.get(normalizedRoot)) {\n\t\t\tthis.validRoots.set(normalizedRoot, true);\n\n\t\t\treturn toDisposable(() => this.validRoots.delete(normalizedRoot));\n\t\t}\n\n\t\treturn Disposable.None;\n\t}\n\n\t//#region file://\n\n\tprivate handleFileRequest(request: Electron.ProtocolRequest, callback: ProtocolCallback) {\n\t\tconst uri = URI.parse(request.url);\n\n\t\tthis.logService.error(`Refused to load resource ${uri.fsPath} from ${Schemas.file}: protocol (original URL: ${request.url})`);\n\n\t\treturn callback({ error: -3 /* ABORTED */ });\n\t}\n\n\t//#endregion\n\n\t//#region vscode-file://\n\n\tprivate handleResourceRequest(request: Electron.ProtocolRequest, callback: ProtocolCallback): void {\n\t\tconst path = this.requestToNormalizedFilePath(request);\n\t\tconst pathBasename = basename(path);\n\n\t\tlet headers: Record<string, string> | undefined;\n\t\tif (this.environmentService.crossOriginIsolated) {\n\t\t\tif (pathBasename === 'workbench.html' || pathBasename === 'workbench-dev.html') {\n\t\t\t\theaders = COI.CoopAndCoep;\n\t\t\t} else {\n\t\t\t\theaders = COI.getHeadersFromQuery(request.url);\n\t\t\t}\n\t\t}\n\n\t\t// In OSS, evict resources from the memory cache in the renderer process\n\t\t// Refs https://github.com/microsoft/vscode/issues/148541#issuecomment-2670891511\n\t\tif (!this.environmentService.isBuilt) {\n\t\t\theaders = {\n\t\t\t\t...headers,\n\t\t\t\t...CacheControlheaders\n\t\t\t};\n\t\t}\n\n\t\t// Document-policy header is needed for collecting\n\t\t// JavaScript callstacks via https://www.electronjs.org/docs/latest/api/web-frame-main#framecollectjavascriptcallstack-experimental\n\t\t// until https://github.com/electron/electron/issues/45356 is resolved.\n\t\tif (pathBasename === 'workbench.html' || pathBasename === 'workbench-dev.html') {\n\t\t\theaders = {\n\t\t\t\t...headers,\n\t\t\t\t...DocumentPolicyheaders\n\t\t\t};\n\t\t}\n\n\t\t// first check by validRoots\n\t\tif (this.validRoots.findSubstr(path)) {\n\t\t\treturn callback({ path, headers });\n\t\t}\n\n\t\t// then check by validExtensions\n\t\tif (this.validExtensions.has(extname(path).toLowerCase())) {\n\t\t\treturn callback({ path, headers });\n\t\t}\n\n\t\t// finally block to load the resource\n\t\tthis.logService.error(`${Schemas.vscodeFileResource}: Refused to load resource ${path} from ${Schemas.vscodeFileResource}: protocol (original URL: ${request.url})`);\n\n\t\treturn callback({ error: -3 /* ABORTED */ });\n\t}\n\n\tprivate requestToNormalizedFilePath(request: Electron.ProtocolRequest): string {\n\n\t\t// 1.) Use `URI.parse()` util from us to convert the raw\n\t\t//     URL into our URI.\n\t\tconst requestUri = URI.parse(request.url);\n\n\t\t// 2.) Use `FileAccess.asFileUri` to convert back from a\n\t\t//     `vscode-file:` URI to a `file:` URI.\n\t\tconst unnormalizedFileUri = FileAccess.uriToFileUri(requestUri);\n\n\t\t// 3.) Strip anything from the URI that could result in\n\t\t//     relative paths (such as \"..\") by using `normalize`\n\t\treturn normalize(unnormalizedFileUri.fsPath);\n\t}\n\n\t//#endregion\n\n\t//#region IPC Object URLs\n\n\tcreateIPCObjectUrl<T>(): IIPCObjectUrl<T> {\n\t\tlet obj: T | undefined = undefined;\n\n\t\t// Create unique URI\n\t\tconst resource = URI.from({\n\t\t\tscheme: 'vscode', // used for all our IPC communication (vscode:<channel>)\n\t\t\tpath: generateUuid()\n\t\t});\n\n\t\t// Install IPC handler\n\t\tconst channel = resource.toString();\n\t\tconst handler = async (): Promise<T | undefined> => obj;\n\t\tvalidatedIpcMain.handle(channel, handler);\n\n\t\tthis.logService.trace(`IPC Object URL: Registered new channel ${channel}.`);\n\n\t\treturn {\n\t\t\tresource,\n\t\t\tupdate: updatedObj => obj = updatedObj,\n\t\t\tdispose: () => {\n\t\t\t\tthis.logService.trace(`IPC Object URL: Removed channel ${channel}.`);\n\n\t\t\t\tvalidatedIpcMain.removeHandler(channel);\n\t\t\t}\n\t\t};\n\t}\n\n\t//#endregion\n}\n"]}